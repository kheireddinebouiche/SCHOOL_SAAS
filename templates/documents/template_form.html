<!-- templates/documents/template_form.html -->

{% extends 'documents/base.html' %}

{% block title %}Éditer le Template - Étape 2{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>✏️ Éditer le Template - Étape 2</h1>
</div>

<div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Étape 2:</strong> Éditez le contenu du template.
</div>

<div class="card">
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="alert alert-danger mt-2">{{ form.title.errors }}</div>
                        {% endif %}
                        {% if form.title.help_text %}
                        <small class="form-text text-muted">{{ form.title.help_text }}</small>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.slug.id_for_label }}" class="form-label">{{ form.slug.label }}</label>
                        {{ form.slug }}
                        {% if form.slug.errors %}
                        <div class="alert alert-danger mt-2">{{ form.slug.errors }}</div>
                        {% endif %}
                        {% if form.slug.help_text %}
                        <small class="form-text text-muted">{{ form.slug.help_text }}</small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.template_type.id_for_label }}" class="form-label">{{ form.template_type.label }}</label>
                        {{ form.template_type }}
                        {% if form.template_type.errors %}
                        <div class="alert alert-danger mt-2">{{ form.template_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="alert alert-danger mt-2">{{ form.category.errors }}</div>
                        {% endif %}
                        {% if form.category.help_text %}
                        <small class="form-text text-muted">{{ form.category.help_text }}</small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.is_active.id_for_label }}" class="form-check-label">
                            {{ form.is_active }}
                            {{ form.is_active.label }}
                        </label>
                        {% if form.is_active.errors %}
                        <div class="alert alert-danger mt-2">{{ form.is_active.errors }}</div>
                        {% endif %}
                    </div>
                </div>

            </div>


            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.help_text %}
                <small class="form-text text-muted d-block">{{ form.description.help_text }}</small>
                {% endif %}
                {% if form.description.errors %}
                <div class="alert alert-danger mt-2">{{ form.description.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
                {{ form.content }}
                <small class="form-text text-muted d-block mt-2">
                    Utilisez les variables Django: <code>{{ recipient_name }}</code>, <code>{{ recipient_email }}</code>, <code>{{ document_date }}</code>, etc.
                </small>
                {% if form.content.errors %}
                <div class="alert alert-danger mt-2">{{ form.content.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.custom_css.id_for_label }}" class="form-label">{{ form.custom_css.label }}</label>
                {{ form.custom_css }}
                <small class="form-text text-muted d-block">CSS personnalisé pour l'impression (optionnel)</small>
                {% if form.custom_css.errors %}
                <div class="alert alert-danger mt-2">{{ form.custom_css.errors }}</div>
                {% endif %}
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    {% if form.instance.pk %}Enregistrer les modifications{% else %}Créer le template{% endif %}
                </button>
                <a href="{% url 'pdf_editor:template-list' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
    // Initialiser TinyMCE pour le champ content
    tinymce.init({
        selector: 'textarea.tinymce-editor',
        height: 500,
        width: '100%',
        plugins: 'print preview paste importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists wordcount imagetools textpattern noneditable help charmap quickbars emoticons',
        toolbar: 'undo redo | formatselect | bold italic underline strikethrough | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media | print preview | fullscreen | charmap emoticons',
        toolbar_mode: 'floating',
        relative_urls: false,
        convert_urls: false,
        paste_data_images: true,
        // Configuration spécifique pour les templates de documents
        setup: function(editor) {
            editor.on('init', function() {
                // Ajouter des variables de template prédéfinies
                const templateVariables = [
                    { title: 'Nom du destinataire', value: '{{ recipient_name }}' },
                    { title: 'Email du destinataire', value: '{{ recipient_email }}' },
                    { title: 'Date du document', value: '{{ document_date }}' },
                    { title: 'Nom de l\'entreprise', value: '{{ company_name }}' },
                    { title: 'Utilisateur courant', value: '{{ current_user }}' }
                ];

                // Ajouter un menu pour insérer les variables
                editor.ui.registry.addMenuButton('templatevars', {
                    text: 'Variables',
                    fetch: function(callback) {
                        const items = templateVariables.map(function(variable) {
                            return {
                                type: 'menuitem',
                                text: variable.title,
                                onAction: function() {
                                    editor.insertContent(variable.value);
                                }
                            };
                        });
                        callback(items);
                    }
                });

                // Ajouter le bouton au menu
                editor.ui.registry.addButton('templatevars', {
                    text: 'Variables',
                    tooltip: 'Insérer une variable de template',
                    onAction: function() {
                        // Ouvrir le menu
                        editor.execCommand('mceTemplateVarsMenu');
                    }
                });

                // Ajouter le bouton au toolbar
                editor.ui.registry.addNestedMenuItem('templatevars', {
                    text: 'Variables de template',
                    getSubmenuItems: function() {
                        return templateVariables.map(function(variable) {
                            return {
                                type: 'menuitem',
                                text: variable.title,
                                onAction: function() {
                                    editor.insertContent(variable.value);
                                }
                            };
                        });
                    }
                });
            });
        },
        // Ajouter le bouton Variables à la barre d'outils
        toolbar: 'undo redo | formatselect | bold italic underline strikethrough | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media | templatevars | print preview | fullscreen | charmap emoticons',
    });

    // Ajouter une fonctionnalité pour générer automatiquement le slug à partir du titre
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    const slugField = document.getElementById('{{ form.slug.id_for_label }}');

    // Fonction pour convertir le titre en slug
    function generateSlug(title) {
        return title.toLowerCase()
            .replace(/[^\w\s-]/g, '') // Supprimer les caractères spéciaux
            .replace(/[\s_-]+/g, '-') // Remplacer les espaces et underscores par des tirets
            .replace(/^-+|-+$/g, ''); // Supprimer les tirets en début et fin
    }

    // Générer le slug automatiquement si le champ slug est vide ou si c'est un nouveau template
    titleField.addEventListener('input', function() {
        // Ne générer le slug que si le champ slug est vide ou si c'est un nouveau template (pas d'ID)
        if (!slugField.value || !slugField.dataset.originalValue) {
            slugField.value = generateSlug(this.value);
        }
    });

    // Stocker la valeur originale du slug pour savoir si l'utilisateur l'a modifié
    slugField.dataset.originalValue = slugField.value;

    // Désactiver la génération automatique si l'utilisateur modifie manuellement le slug
    slugField.addEventListener('input', function() {
        // Si l'utilisateur a modifié le slug, empêcher la génération automatique
        if (this.value !== generateSlug(titleField.value)) {
            // Marquer que l'utilisateur a modifié le slug manuellement
            this.dataset.userModified = 'true';
        } else {
            // Si l'utilisateur revient à la valeur générée automatiquement, réinitialiser
            this.dataset.userModified = 'false';
        }
    });
</script>
{% endblock %}
