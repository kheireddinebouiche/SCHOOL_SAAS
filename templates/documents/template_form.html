{% extends 'documents/base.html' %}

{% block title %}
    {% if form.instance.pk %}Éditer : {{ form.instance.title }}{% else %}Nouveau Template{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">
                    {% if form.instance.pk %}
                    <i class="fas fa-edit text-primary me-2"></i>Édition du Template
                    {% else %}
                    <i class="fas fa-plus-circle text-primary me-2"></i>Créer un Template
                    {% endif %}
                </h1>
                <p class="text-muted mb-0">Configuration et contenu du document</p>
            </div>
            {% if form.instance.pk %}
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#cssModal">
                    <i class="fab fa-css3-alt me-1"></i> CSS Personnalisé
                </button>
                <a href="{% url 'pdf_editor:template-detail' form.instance.slug %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-eye me-1"></i> Voir détails
                </a>
            </div>
            {% else %}
            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#cssModal">
                <i class="fab fa-css3-alt me-1"></i> CSS Personnalisé
            </button>
            {% endif %}
        </div>

        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="alert alert-danger shadow-sm border-0 mb-4">
                <i class="fas fa-exclamation-circle me-2"></i>
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Configuration Générale -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-sliders-h me-2 text-primary"></i>Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-medium">{{ form.title.label }}</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.template_type.id_for_label }}" class="form-label fw-medium">{{ form.template_type.label }}</label>
                            {{ form.template_type }}
                            {% if form.template_type.errors %}
                                <div class="invalid-feedback d-block">{{ form.template_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-8">
                            <label for="{{ form.slug.id_for_label }}" class="form-label fw-medium">{{ form.slug.label }}</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0 text-muted">/templates/</span>
                                {{ form.slug }}
                            </div>
                            <div class="form-text small">Identifiant unique pour l'URL. Généré automatiquement.</div>
                            {% if form.slug.errors %}
                                <div class="invalid-feedback d-block">{{ form.slug.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check form-switch mb-2">
                                {{ form.is_active }}
                                <label class="form-check-label fw-medium" for="{{ form.is_active.id_for_label }}">
                                    {{ form.is_active.label }}
                                </label>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-medium">{{ form.description.label }}</label>
                            {{ form.description }}
                            <div class="form-text">Une brève description pour identifier ce template.</div>
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Éditeur de Contenu -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-file-alt me-2 text-primary"></i>Contenu du Document</h5>
                    <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-10">HTML / TinyMCE</span>
                </div>
                <div class="card-body p-0">
                    {{ form.content }}
                    {% if form.content.errors %}
                        <div class="p-3 invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <div class="small text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Utilisez le menu <strong>Variables</strong> dans l'éditeur pour insérer des champs dynamiques comme <code>Nom</code>, <code>Date</code>, etc.
                    </div>
                </div>
            </div>

            <!-- Modal CSS (Replacing Accordion) -->
            <div class="modal fade" id="cssModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fab fa-css3-alt me-2 text-primary"></i>Personnalisation CSS</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info border-0 shadow-sm mb-3">
                                <i class="fas fa-info-circle me-2"></i> Ces règles CSS seront appliquées uniquement lors de la génération du PDF.
                            </div>
                            <label for="{{ form.custom_css.id_for_label }}" class="form-label fw-bold">Code CSS</label>
                            {{ form.custom_css }}
                            <style>
                                #{{ form.custom_css.id_for_label }} {
                                    height: 500px !important;
                                    font-family: 'Consolas', 'Monaco', monospace;
                                    font-size: 14px;
                                }
                            </style>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-3 justify-content-end mb-5">
                <a href="{% url 'pdf_editor:template-list' %}" class="btn btn-light border shadow-sm px-4">Annuler</a>
                <button type="submit" class="btn btn-primary shadow-sm px-4 icon-link">
                    <i class="fas fa-save"></i>
                    {% if form.instance.pk %}Enregistrer les modifications{% else %}Créer le template{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Initialiser TinyMCE (Configuration optimisée)
    tinymce.init({
        selector: 'textarea.tinymce-editor',
        height: 800,
        menubar: 'file edit view insert format tools table help',
        plugins: 'print preview paste importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists wordcount imagetools textpattern noneditable help charmap quickbars emoticons',
        toolbar: 'undo redo | bold italic underline fromatselect | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | bullist numlist | link image | templatevars | code preview fullscreen',
        contextmenu: "link image imagetools table",
        skin: 'oxide',
        content_css: 'default',
        branding: false,
        relative_urls: false,
        convert_urls: false,
        setup: function(editor) {
            editor.on('init', function() {
                const templateVariables = [
                    { title: 'Nom du Destinataire', value: '{{ recipient_name }}' },
                    { title: 'Email du Destinataire', value: '{{ recipient_email }}' },
                    { title: 'Date du Document', value: '{{ document_date }}' },
                    { title: 'Nom de l\'Entreprise', value: '{{ company_name }}' },
                    { title: 'Utilisateur Courant', value: '{{ current_user }}' }
                ];

                editor.ui.registry.addMenuButton('templatevars', {
                    text: 'Insérer Variable',
                    icon: 'template',
                    fetch: function(callback) {
                        const items = templateVariables.map(function(variable) {
                            return {
                                type: 'menuitem',
                                text: variable.title,
                                onAction: function() {
                                    editor.insertContent('<span style="background-color: #f0f9ff; border: 1px dashed #0284c7; padding: 0 4px; border-radius: 4px;">' + variable.value + '</span>&nbsp;');
                                }
                            };
                        });
                        callback(items);
                    }
                });
            });
        }
    });

    // Slug generation logic
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    const slugField = document.getElementById('{{ form.slug.id_for_label }}');

    function generateSlug(title) {
        return title.toLowerCase()
            .replace(/[^\w\s-]/g, '')
            .replace(/[\s_-]+/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    if (titleField && slugField) {
        titleField.addEventListener('input', function() {
            if (!slugField.value || !slugField.dataset.originalValue || slugField.dataset.userModified !== 'true') {
                slugField.value = generateSlug(this.value);
            }
        });

        slugField.dataset.originalValue = slugField.value;
        slugField.addEventListener('input', function() {
            if (this.value !== generateSlug(titleField.value)) {
                this.dataset.userModified = 'true';
            } else {
                this.dataset.userModified = 'false';
            }
        });
    }
</script>

<style>
    /* TinyMCE customization to match topic */
    .tox-tinymce {
        border: none !important;
        border-top: 1px solid var(--border-color) !important;
    }
    .accordion-button:not(.collapsed) {
        background-color: #f8fafc;
        color: var(--primary-color);
        box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
    }
</style>
{% endblock %}
