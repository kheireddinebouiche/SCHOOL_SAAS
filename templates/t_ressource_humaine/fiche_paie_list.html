{% extends 'tenant_folder/base.html' %}
{% load humanize %}
{% block title %}Historique des Fiches de Paie{% endblock %}
{% block content %}
<style>
    /* Fix dropdown clipping in responsive tables */
    .table-responsive {
        overflow: visible !important;
    }
    .dropdown-menu {
        z-index: 1060 !important;
    }
</style>
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Historique des Fiches de Paie</h4>
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="{% url 't_ressource_humaine:contrat_list' %}">Contrats</a></li>
                                <li class="breadcrumb-item active">Historique Paie</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entity Selector -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm border-0 border-start border-primary border-3">
                        <div class="card-body py-3">
                            <form action="{% url 't_ressource_humaine:select_entreprise_paie' %}" method="POST" class="row align-items-center g-3">
                                {% csrf_token %}
                                <div class="col-auto">
                                    <label class="form-label mb-0 fw-bold text-primary">
                                        <i class="ri-building-line me-1"></i> Entité Active :
                                    </label>
                                </div>
                                <div class="col-md-4">
                                    <select name="entreprise_id" class="form-select form-select-sm border-light-subtle shadow-none" onchange="this.form.submit()">
                                        <option value="">-- Sélectionner une entreprise --</option>
                                        <option value="none" {% if active_entreprise_id == 'none' %}selected{% endif %}>Non-affectés (Archives/Divers)</option>
                                        {% for ent in entreprises %}
                                            <option value="{{ ent.id }}" {% if active_entreprise_id|slugify == ent.id|slugify %}selected{% endif %}>
                                                {{ ent.designation }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    {% if not active_entreprise_id %}
                                        <span class="badge bg-danger-subtle text-danger animate__animated animate__pulse animate__infinite">
                                            <i class="ri-error-warning-line me-1"></i> Veuillez sélectionner une entité pour voir l'historique
                                        </span>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            {% if filter_contrat %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm bg-primary-subtle">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center">
                                <div class="avatar-md flex-shrink-0 me-3">
                                    <div class="avatar-title bg-primary text-white rounded-circle fs-20">
                                        <i class="ri-user-star-line"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="mb-1 fw-bold text-primary">Historique pour : {{ filter_contrat.formateur }}</h5>
                                    <p class="mb-0 text-muted">
                                        <span class="badge bg-white text-primary me-2">{{ filter_contrat.get_type_contrat_display }}</span>
                                        Depuis le {{ filter_contrat.date_debut|date:"d M, Y" }}
                                    </p>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="{% url 't_ressource_humaine:contrat_list' %}" class="btn btn-primary btn-sm">
                                        <i class="ri-arrow-left-line align-bottom me-1"></i> Retour aux contrats
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Filter Bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <form method="GET" id="paie-filter-form" class="row g-3 align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label text-muted fw-medium">Sélectionner un Enseignant</label>
                                    <select name="formateur" class="form-select border-light-subtle">
                                        <option value="">Tous les enseignants</option>
                                        {% for f in formateurs %}
                                            <option value="{{ f.id }}" {% if selected_formateur == f.id %}selected{% endif %}>
                                                {{ f.nom }} {{ f.prenom }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-muted fw-medium">Année</label>
                                    <select name="annee" class="form-select border-light-subtle">
                                        <option value="">Toutes les années</option>
                                        {% for year in years %}
                                            <option value="{{ year }}" {% if selected_annee == year %}selected{% endif %}>{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="ri-filter-3-line align-bottom me-1"></i> Filtrer
                                        </button>
                                        <a href="{% url 't_ressource_humaine:fiche_paie_list' %}" class="btn btn-soft-secondary w-100" id="reset-filters">
                                            <i class="ri-refresh-line align-bottom me-1"></i> Réinitialiser
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header border-bottom-dashed d-flex align-items-center justify-content-between">
                            <h5 class="card-title mb-0">Tous les enregistrements</h5>
                            <div id="filter-loader" class="spinner-border spinner-border-sm text-primary d-none" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive table-card" id="paie-table-container">
                                {% include 't_ressource_humaine/_fiche_paie_table.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- Generic Modal -->
    <div class="modal fade" id="genericModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Content loaded via AJAX -->
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // ... (Existing Dropdown Fix) ...

            // Generic Modal Handler
            $(document).on('click', '.open-modal-url', function(e) {
                e.preventDefault();
                var url = $(this).attr('href');
                var title = $(this).data('modal-title') || 'Action';
                
                $('#genericModal .modal-title').text(title);
                $('#genericModal .modal-body').html('<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>');
                var modal = new bootstrap.Modal(document.getElementById('genericModal'));
                modal.show();

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(response) {
                        $('#genericModal .modal-body').html(response);
                    },
                    error: function() {
                        $('#genericModal .modal-body').html('<div class="alert alert-danger">Une erreur est survenue.</div>');
                    }
                });
            });

            // Handle Forms in Modal (AJAX Submit)
            $(document).on('submit', '.ajax-form', function(e) {
                e.preventDefault();
                var form = $(this);
                var container = form.closest('.modal-body');
                
                // Show loading
                var btn = form.find('button[type="submit"]');
                var originalBtnCtx = btn.html();
                btn.prop('disabled', true).html('<i class="ri-loader-4-line ri-spin align-bottom me-1"></i> Traitement...');

                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: form.serialize(),
                    success: function(response) {
                        if (response.status === 'success') {
                            alertify.success(response.message);
                            $('#genericModal').modal('hide');
                            if (response.reload_table) {
                                // Trigger filter form submit to reload table
                                $('#paie-filter-form').submit();
                            }
                        } else if (response.status === 'invalid') {
                            // Re-render form with errors
                            container.html(response.html);
                        } else {
                            alertify.error(response.message || 'Erreur inconnue');
                            btn.prop('disabled', false).html(originalBtnCtx);
                        }
                    },
                    error: function() {
                        alertify.error('Erreur lors de la soumission du formulaire.');
                        btn.prop('disabled', false).html(originalBtnCtx);
                    }
                });
            });

            // ... (Existing Filter Logic) ...

        $(document).on('show.bs.dropdown', function(e) {
            var dropdownMenu = $(e.target).find('.dropdown-menu');
            if (dropdownMenu.length) {
                dropdownMenu.css({
                    'z-index': '1060',
                    'position': 'absolute'
                });
            }
        });

        // AJAX Filtering
        function updateTable(url) {
            $('#filter-loader').removeClass('d-none');
            $('#paie-table-container').css('opacity', '0.5');

            $.ajax({
                url: url,
                type: 'GET',
                success: function(data) {
                    $('#paie-table-container').html(data);
                    $('#paie-table-container').css('opacity', '1');
                    $('#filter-loader').addClass('d-none');
                    
                    // Update URL without reload
                    window.history.pushState({}, '', url);
                },
                error: function() {
                    alertify.error('Une erreur est survenue lors du filtrage.');
                    $('#paie-table-container').css('opacity', '1');
                    $('#filter-loader').addClass('d-none');
                }
            });
        }

        $('#paie-filter-form').on('submit', function(e) {
            e.preventDefault();
            var url = $(this).attr('action') || window.location.pathname;
            url += '?' + $(this).serialize();
            updateTable(url);
        });

        $('#reset-filters').on('click', function(e) {
            e.preventDefault();
            var url = $(this).attr('href');
            $('#paie-filter-form')[0].reset();
            updateTable(url);
        });
    });
</script>
{% endblock %}
