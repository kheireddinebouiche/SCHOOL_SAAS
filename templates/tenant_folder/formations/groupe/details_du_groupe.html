{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Groupes - Détails du groupe {% endblock title %}

{% block content %}
<style>
    .form-control, .form-select {
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b7ddd;
        box-shadow: 0 0 0 0.2rem rgba(59, 125, 221, 0.25);
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
    }
    
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #e9ecef;
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }
    
    .btn-primary {
        background-color: #3b7ddd;
        border-color: #3b7ddd;
    }
    
    .btn-primary:hover {
        background-color: #326bc9;
        border-color: #326bc9;
    }
    
    .status-item {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-item.current {
        font-weight: bold;
        color: #3b7ddd;
    }
    
    .dropdown-menu {
        z-index: 1050 !important;
    }
    
    .dropdown-menu {
        z-index: 1050 !important;
    }
    
    .dropdown {
        position: static;
    }
    
    /* Reduce spacing between elements in the Informations générales section */
    .informations-generales .mb-3 {
        margin-bottom: 0.5rem !important; /* Reduce from default 1rem to 0.5rem */
    }
    
    .informations-generales .row {
        margin-bottom: 0.5rem; /* Reduce space between rows */
    }
    
    .informations-generales .form-label {
        margin-bottom: 0.25rem; /* Reduce label bottom margin */
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="ri-group-line text-info"></i>
                            </div>
                            <h4 class="mb-0 text-info">Détails du groupe</h4>
                        </div>
                        <div class="page-title-right">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Scolarité</a></li>
                                    <li class="breadcrumb-item active">Détails du groupe</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-white p-3">
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-2 me-3">
                                            <i class="ri-group-line text-info fs-4"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title fw-semibold text-info mb-0">Détails du groupe : {{groupe.nom}}</h5>
                                            <p class="text-muted mb-0 small">Informations générales sur le groupe</p>
                                        </div>
                                    </div>
                                    
                                    <div class="dropdown">
                                        <button class="btn btn-soft-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="ri-printer-line me-1"></i> Impression
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" ><i class="ri-file-text-line me-2"></i> PV D'examen</a></li>
                                            <li><button type="button" class="dropdown-item"  id="PrintAttendenceSheet"><i class="ri-file-chart-line me-2"></i> Fiche suivie des cours</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#certificatScolariteModal"><i class="ri-file-paper-2-line me-2"></i> Certificat de scolarité</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#contratsModal"><i class="ri-file-3-line me-2"></i> Contrats</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#attestationInscriptionModal"><i class="ri-file-text-line me-2"></i> Attestation d'inscription</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#certificatAdmissionModal"><i class="ri-file-2-line me-2"></i> Certificat d'admission</button></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- Status Sequence -->
                                <div class="d-flex justify-content-center">
                                    <div class="d-flex align-items-center">
                                        <span class="status-item {% if groupe.etat == 'brouillon' %}current{% endif %}">Brouillon</span>
                                        <span class="mx-2 text-muted">-</span>
                                        <span class="status-item {% if groupe.etat == 'enc' or groupe.etat == 'inscription' %}current{% endif %}">En cours d'inscription</span>
                                        <span class="mx-2 text-muted">-</span>
                                        <span class="status-item {% if groupe.etat == 'cloture' %}current{% endif %}">Clôturé</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                           
                            
                            <div class="row mb-4">
                                <div class="col-lg-12 informations-generales">
                                    <h5 class="card-title mb-3 text-primary fw-semibold"><i class="ri-information-line me-1"></i> Informations générales</h5>
                                    
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Nom du groupe</label>
                                                <div class="form-control bg-light border-0" style="min-height: auto;">{{groupe.nom}}</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Année scolaire</label>
                                                <div class="form-control bg-light border-0" style="min-height: auto;">{{groupe.annee_scolaire}}</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Promotion</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="form-control bg-light border-0 flex-grow-1 me-2" style="min-height: auto;">{{groupe.promotion.code}} - {{groupe.promotion.get_session_display}} {{groupe.promotion.begin_year}}/{{groupe.promotion.end_year}}</div>
                                                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#promotionDetailsModal" title="Afficher les informations de la promotion" >
                                                        <i class="ri-information-line"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Spécialité</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="form-control bg-light border-0 flex-grow-1 me-2" style="min-height: auto;">{{groupe.specialite}}</div>
                                                    <button type="button" class="btn btn-primary btn-sm" data-bs-target='#specialiteModel'  title="Afficher les informations de la spécialité" data-bs-toggle="modal">
                                                        <i class="ri-information-line"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Statut</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="form-control bg-light border-0 flex-grow-1" style="min-height: auto;">
                                                        {% if groupe.etat == "brouillon" %}   
                                                            <span class="badge bg-secondary bg-opacity-10 text-secondary">{{groupe.get_etat_display}}</span>
                                                        {% elif groupe.etat == "enc" %}
                                                            <span class="badge bg-warning bg-opacity-10 text-warning">{{groupe.get_etat_display}}</span>
                                                        {% elif groupe.etat == "valider" %}
                                                            <span class="badge bg-success bg-opacity-10 text-success">{{groupe.get_etat_display}}</span>
                                                        {% elif groupe.etat == "archive" %}
                                                            <span class="badge bg-dark bg-opacity-10 text-dark">{{groupe.get_etat_display}}</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary bg-opacity-10 text-secondary">{{groupe.get_etat_display}}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Code partenaire</label>
                                                <div class="d-flex align-items-center">
                                                    <div id="partnerCodeDisplay" class="form-control bg-light border-0 flex-grow-1 me-2" style="min-height: auto;">{{groupe.code_partenaire}}</div>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editPartnerCodeModal" title="Modifier le code partenaire">
                                                        <i class="ri-pencil-line"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Date de début</label>
                                                <div class="form-control bg-light border-0" id='date_start' style="min-height: auto;">{{groupe.start_date}}</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Date de fin</label>
                                                <div class="form-control bg-light border-0" id='date_end' style="min-height: auto;">{{groupe.end_date}}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Nombre d'inscrits minimum</label>
                                                <div class="form-control bg-light border-0" style="min-height: auto;">{{groupe.min_student}}</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Nombre d'inscrits maximum</label>
                                                <div class="form-control bg-light border-0" style="min-height: auto;">{{groupe.max_student}}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end gap-2 mt-4">
                                        {% if groupe.etat == "brouillon" %}
                                            <a href="{% url 't_groupe:UpdateGroupe' groupe.id %}" class="btn btn-primary px-4 py-2" id="_updateGroupeBtn" title="Modifier les informations du groupe">
                                                <i class="ri-pencil-line me-1"></i> Modifier
                                            </a>
                                            <button type="button" class="btn btn-success px-4 py-2" data-bs-toggle="modal" data-bs-target="#confirmStartRegistrationModal" title="Valider le cours pour permettre le début des inscriptions">
                                                <i class="ri-check-line me-1"></i> Lancer les inscriptions
                                            </button>
                                        {% endif %}
                                        {% if groupe.etat == "valider" %}
                                            <a href="{% url 't_groupe:makeGroupeBrouillon' groupe.id %}" class="btn btn-warning px-4 py-2" id="_updateGroupeBtn" title="Revenir en brouillon">
                                                <i class="ri-edit-line me-1"></i> Brouillon
                                            </a>
                                        {% endif %}
                                        {% if groupe.etat == "inscription" %}
                                            <button type="button" class="btn btn-danger px-4 py-2" data-bs-toggle="modal" data-bs-target="#confirmCloseGroupModal" title="La clôture du groupe lance le debut des cours, toute modification est désactivée">
                                                <i class="ri-lock-line me-1"></i> Clôturer
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <h5 class="card-title mb-3 text-primary fw-semibold"><i class="ri-user-line me-1"></i> Liste des inscrits</h5>

                            <!-- Filter section -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" id="filterNom" class="form-control" placeholder="Filtrer par nom...">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="filterPrenom" class="form-control" placeholder="Filtrer par prénom...">
                                </div>
                                <div class="col-md-4">
                                    <select id="filterStatus" class="form-select">
                                        <option value="">Tous les statuts</option>
                                        <option value="Prospect">Prospect</option>
                                        <option value="Étudiant">Étudiant</option>
                                        <option value="Ancien">Ancien</option>
                                    </select>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" id="studentsTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Nom & Prénom</th>
                                            <th class="border-0">Adresse Email</th>
                                            <th class="border-0">N° Téléphone</th>
                                            <th class="border-0">Date d'inscription</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0">Type Formation</th>
                                            <th class="border-0 text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if students.count != 0 %}
                                            {% for i in students %}
                                                <tr> 
                                                    <td><strong>{{i.student.nom}} {{i.student.prenom}}</strong></td>
                                                    <td>{{i.student.email}}</td>
                                                    <td>{{i.student.telephone}}</td>
                                                    <td>{{i.date_inscription}}</td>
                                                    <td><span class="badge bg-info">{{i.student.get_statut_display}}</span></td>
                                                    <th class="border-0">{{i.student.is_double}}</th>
                                                    <td class="text-end">
                                                        <div class="dropdown d-inline-block" >
                                                            <button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="ri-more-fill align-middle"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end">
                                                                <li><a href="{% url 't_groupe:StudentDetails' pk=i.student.id %}" class="dropdown-item">
                                                                    <i class="ri-eye-fill align-bottom me-2 text-muted"></i> Profile étudiant
                                                                </a></li>
                                                            </ul>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr><td colspan="5" class="text-muted text-center">
                                                <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                                    <div class="avatar-sm mb-4">
                                                        <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                                            <i class="ri-user-unfollow-line"></i>
                                                        </div>
                                                    </div>
                                                    <h5 class="mb-2">Aucun étudiant trouvé</h5>
                                                    <p class="text-muted mb-0">Il n'y a aucun étudiant enregistré pour le moment</p>
                                                </div>
                                            </td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>
<!-- end main content-->

<div id="specialiteModel" class="modal fade" tabindex="-1" aria-labelledby="specialiteModelLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-information-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="specialiteModelLabel">
                            Détails de la spécialité
                        </h5>
                        <p class="text-muted small mb-0">Informations sur la spécialité sélectionnée</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <input type="hidden" id="_id_module" disabled />
                    <div class="col-lg-12 mb-3">
                        <label for="u_label" class="form-label">Label :</label>
                        <input disabled type="text" class="form-control" id="u_label" value="{{specialite.code}}-{{specialite.label}}" />
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label for="u_code_module" class="form-label">Niveau :</label>
                        <input disabled type="text" class="form-control" id="u_code_module" value="{{specialite.condition_access}}"/>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label for="u_coef" class="form-label">Vérsion du programme :</label>
                        <input disabled type="text" class="form-control" id="u_coef" value="{{specialite.version}} " />
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button class="btn btn-primary px-4" id="ConfirmUpdateBtn">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for confirming start of registrations -->
<div class="modal fade" id="confirmStartRegistrationModal" tabindex="-1" aria-labelledby="confirmStartRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmStartRegistrationModalLabel">
                            Confirmer le démarrage des inscriptions
                        </h5>
                        <p class="text-muted small mb-0">Validation du groupe pour début des inscriptions</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-alert-line text-warning fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Attention !</h6>
                            <p class="mb-0">Vous êtes sur le point de valider ce groupe et d'autoriser le début des inscriptions.</p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-lock-line text-info fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Une fois le début des inscriptions autorisé, il ne sera plus possible de modifier les informations du groupe.</p>
                        </div>
                    </div>
                </div>
                
                <p>En validant ce groupe, vous confirmez que toutes les informations sont correctes et que le groupe est prêt à recevoir des inscriptions.</p>
                
                <div class="d-flex align-items-center p-3 bg-light rounded-3">
                    <i class="ri-information-line text-primary fs-5 me-3"></i>
                    <div>
                        <h6 class="mb-1">Détails du groupe</h6>
                        <p class="mb-0 small text-muted">Nom : <strong>{{groupe.nom}}</strong> | Spécialité : <strong>{{groupe.specialite}}</strong></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button id="btnConfirmeBeginInscription" type="button" class="btn btn-success px-4" >Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for showing promotion details -->
<div class="modal fade" id="promotionDetailsModal" tabindex="-1" aria-labelledby="promotionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-2-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="promotionDetailsModalLabel">
                            Détails de la promotion
                        </h5>
                        <p class="text-muted small mb-0">Informations sur la promotion sélectionnée</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Code :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.code}}</div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Session :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.get_session_display}}</div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Date de debut :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.date_debut}}</div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Date de fin :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.date_fin}}</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for confirming group closure -->
<div class="modal fade" id="confirmCloseGroupModal" tabindex="-1" aria-labelledby="confirmCloseGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-lock-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="confirmCloseGroupModalLabel">
                            Confirmer la clôture du groupe
                        </h5>
                        <p class="text-muted small mb-0">Fermeture du groupe pour de nouvelles inscriptions</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-alert-line text-warning fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Attention !</h6>
                            <p class="mb-0">Vous êtes sur le point de clôturer ce groupe.</p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-user-unfollow-line text-info fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Une fois le groupe clôturé, il ne sera plus possible d'inscrire de nouveaux étudiants à ce groupe.</p>
                        </div>
                    </div>
                </div>
                
                <p>En clôturant ce groupe, vous confirmez que le nombre d'inscrits est final et que le groupe est prêt à commencer officiellement.</p>
                
                <div class="d-flex align-items-center p-3 bg-light rounded-3">
                    <i class="ri-information-line text-primary fs-5 me-3"></i>
                    <div>
                        <h6 class="mb-1">Détails du groupe</h6>
                        <p class="mb-0 small text-muted">Nom : <strong>{{groupe.nom}}</strong> | Spécialité : <strong>{{groupe.specialite}}</strong> | Étudiants inscrits : <strong>{{students.count}}</strong></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button id="btnConfirmeCloseGroup" type="submit" class="btn btn-danger px-4">Confirmer</button>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
    $(document).ready(function(){


        // Handle button events
        $(document).on('click','#btnConfirmeBeginInscription', function(){
            window.location = "{% url 't_groupe:validateGroupe' pk=groupe.id %}";
        });
        
        $(document).on('click','#btnConfirmeCloseGroup', function(){
            window.location = "{% url 't_groupe:closeGroupe' pk=groupe.id %}";
        });


        

        // Function to generate attendance sheet PDF
        function generateAttendanceSheet() {
            const { jsPDF } = window.jspdf;
            
            const doc = new jsPDF('l', 'mm', 'a4');
            
          
            doc.setFontSize(14);
            doc.text("FICHE DE SUIVI DES COURS", 148.5, 10, null, null, 'center');
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text("Détails du groupe", 20, 18);
            doc.setFont(undefined, 'normal');
            doc.text("Spécialité: {{groupe.specialite}}", 20, 24);
            doc.text("Groupe: {{groupe.nom}}", 20, 30);
            doc.text("Année scolaire: {{groupe.annee_scolaire}}", 20, 36);
            
            doc.setFont(undefined, 'bold');
            doc.text("Informations pédagogiques", 150, 18);
            doc.setFont(undefined, 'normal');
            doc.text("Nom de l'enseignant: ___________________", 150, 24);
            doc.text("Nom du module: _______________________", 150, 30);
            doc.text("Date: _________________", 150, 36);
            
            const headers = ["N°", "Étudiants"];
            
            for (let i = 1; i <= 15; i++) {
                headers.push("____/__/__");
            }
            
            const tableData = [];
            
            {% for student_line in students %}
            tableData.push([
                "{{forloop.counter}}",
                "{{student_line.student.nom}} {{student_line.student.prenom}}",
                "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""
            ]);
            {% endfor %}
            
            // Create the attendance table with better styling (without date column headers for now)
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 42, // Move table just below the tighter header sections
                margin: { top: 42, left: 5, right: 5 }, // Adjust margin to match startY
                styles: {
                    fontSize: 7,
                    cellPadding: 2,
                    lineColor: [0, 0, 0], // Black lines for better visibility
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [59, 125, 221], // blue color
                    textColor: [255, 255, 255],
                    fontSize: 6, // Reduced font size for better fit
                    fontStyle: 'bold',
                    lineColor: [0, 0, 0],
                    lineWidth: 0.2,
                    halign: 'center',
                    valign: 'middle'
                },
                bodyStyles: {
                    textColor: [0, 0, 0],
                    lineColor: [0, 0, 0],
                    lineWidth: 0.1
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                columnStyles: {
                    0: { cellWidth: 10, halign: 'center' }, // Number column
                    1: { 
                        cellWidth: 35, // Student names column
                        fontStyle: 'bold' // Make student names bold
                    }, // Student names column
                    // Date columns
                }
            });

            const finalY = doc.lastAutoTable.finalY || 75;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text("Signature de l'enseignant: _________________________", 180, finalY + 15);
            
            // Add institution info at the bottom
            doc.text("Institution: {{tenant.name|default:'Nom de l\'institution'}}", 15, finalY + 15);
            
            // Save the PDF
            doc.save("fiche_suivi_cours_{{groupe.nom}}.pdf");
        }

        $(document).on('click','#PrintAttendenceSheet', function(){
            
            generateAttendanceSheet();
        }); 
        
        
        // Function to generate exam report (will be implemented later)
        function generateExamReport() {
            alert("La génération du PV d'examen sera implémentée prochainement.");
        }
        
        // Handle partner code update
        $(document).on('click', '#savePartnerCodeBtn', function() {
            var newCode = $('#partnerCodeInput').val().trim();
            var $errorDiv = $('#partnerCodeError');
            
            // Clear previous errors
            $errorDiv.hide();
            
            // Basic validation
            if (!newCode) {
                $errorDiv.text('Le code partenaire ne peut pas être vide.').show();
                return;
            }
            
            // Disable the button while processing
            var originalBtnText = $('#savePartnerCodeBtn').html();
            $('#savePartnerCodeBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
            
            // Send AJAX request to update the partner code
            $.ajax({
                url: '{% url "t_groupe:ApiUpdateGroupeCode" %}',  // API endpoint for updating partner code
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'code_partenaire': newCode,
                    'groupeId' : '{{groupe.id}}',
                },
                success: function(response) {
                    if(response.status == "success") {
                        // Update the displayed value
                        $('#partnerCodeDisplay').text(newCode);
                        
                        // Update the input field in the modal too
                        $('#partnerCodeInput').val(newCode);
                        
                        // Show success message
                        alertify.success(response.message);
                        
                        // Close the modal
                        $('#editPartnerCodeModal').modal('hide');
                    } else {
                        $errorDiv.text(response.message || 'Une erreur est survenue lors de la mise à jour.').show();
                    }
                },
                error: function(xhr, status, error) {
                    var errorMessage = 'Une erreur est survenue lors de la mise à jour.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    $errorDiv.text(errorMessage).show();
                },
                complete: function() {
                    // Re-enable the button
                    $('#savePartnerCodeBtn').prop('disabled', false).html(originalBtnText);
                }
            });
        });
    });

    
</script>

<!-- Modal for certificat de scolarité -->
<div class="modal fade" id="certificatScolariteModal" tabindex="-1" aria-labelledby="certificatScolariteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-paper-2-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="certificatScolariteModalLabel">
                            Sélection des étudiants pour le certificat de scolarité
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer le certificat</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer le certificat de scolarité.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="studentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllStudents">
                        <label class="form-check-label" for="selectAllStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="selectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} {{student_line.student.lieu_naissance}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedStudents" id="student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success px-4" id="generateCertificatBtn">Générer les certificats</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing partner code -->
<div class="modal fade" id="editPartnerCodeModal" tabindex="-1" aria-labelledby="editPartnerCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-pencil-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="editPartnerCodeModalLabel">
                            Modifier le code partenaire
                        </h5>
                        <p class="text-muted small mb-0">Mettre à jour le code partenaire du groupe</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Le code partenaire doit être fourni par le partenaire concerné. Veuillez vous assurer d'avoir reçu ce code avant de le renseigner.</p>
                        </div>
                    </div>
                </div>
                
                <form id="editPartnerCodeForm">
                    <div class="mb-3">
                        <label for="partnerCodeInput" class="form-label">Code partenaire</label>
                        <input type="text" class="form-control" id="partnerCodeInput" name="code_partenaire" value="{{groupe.code_partenaire}}" placeholder="Entrez le code partenaire">
                        <div id="partnerCodeError" class="text-danger mt-1" style="display: none;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary px-4" id="savePartnerCodeBtn">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for contrats -->
<div class="modal fade" id="contratsModal" tabindex="-1" aria-labelledby="contratsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-xl border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-3-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="contratsModalLabel">
                            Sélection des contrats à imprimer
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez le modèle de contrat et les étudiants pour lesquels vous souhaitez imprimer les contrats</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Alert for automatic contract loading -->
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Contrat automatique</h6>
                            <p class="mb-0">Le modèle de contrat sera automatiquement sélectionné en fonction de la formation du groupe.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden field to store the contract model ID -->
                <input type="hidden" id="contratModelId">
                
                <!-- Display for the automatically selected contract -->
                <div class="mb-3">
                    <label class="form-label fw-medium">Modèle de contrat sélectionné</label>
                    <div class="form-control bg-light border-0" id="selectedContractDisplay">
                        Chargement en cours...
                    </div>
                    <div id="contratModelError" class="text-danger mt-1" style="display: none;"></div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="contratStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox and counter -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllContratStudents">
                        <label class="form-check-label" for="selectAllContratStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="contratSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Type cursus</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="contratsStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td>{{student_line.student.is_double}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedContratStudents" id="contrat_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary px-4" id="generateContratsBtn">Générer les contrats</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="attestationInscriptionModal" tabindex="-1" aria-labelledby="attestationInscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-text-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="attestationInscriptionModalLabel">
                            Sélection des étudiants pour l'attestation d'inscription
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer l'attestation d'inscription</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer l'attestation d'inscription.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="attestationStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllAttestationStudents">
                        <label class="form-check-label" for="selectAllAttestationStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="attestationSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="attestationStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedAttestationStudents" id="attestation_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success px-4" id="generateAttestationBtn">Générer les attestations</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for admission certificate -->
<div class="modal fade" id="certificatAdmissionModal" tabindex="-1" aria-labelledby="certificatAdmissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-2-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="certificatAdmissionModalLabel">
                            Sélection des étudiants pour le certificat d'admission
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer le certificat d'admission</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer le certificat d'admission.</p>
                        </div>
                    </div>
                </div>

                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="admissionStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>

                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllAdmissionStudents">
                        <label class="form-check-label" for="selectAllAdmissionStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="admissionSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>

                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="admissionStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedAdmissionStudents" id="admission_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-info px-4" id="generateAdmissionBtn">Générer les certificats</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script for certificat selection functionality -->
<script>
    $(document).ready(function(){
        
        var logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
        var logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";
        var logo_partenaire = "{{logo_partenaire}}";
        var branche = "{{branche}}";

        var formationId = "{{groupe.specialite.formation.id}}";
        var anneescolaire = "{{groupe.annee_scolaire}}";
        var adresse = "{{entreprise_details.adresse}}";
        var designation = "{{entreprise_details.designation}}";
        var ville = "{{entreprise_details.ville}}";
        var logo_partenaire = "{{logo_partenaire}}";


        var specialite = "{{groupe.specialite.label}}";
        var formation = "{{groupe.specialite.formation.nom}}";

        var frais_inscription = "{{frais_inscription}}";
        var montant_formation = "120000";
        var annee_academique ="2025/2026";
        var document_inscription = JSON.parse('{{dossier_inscription|escapejs}}');

        var representant = "{{entreprise_details.representant}}";

        var logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
        var logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";

        var echeancier_line = JSON.parse('{{echeancier_line|escapejs}}');
        var qualification = "{{qualification}}";

        var date_debut = "{{date_debut}}";
        var date_fin   = "{{date_fin}}";
        var branche = "{{branche}}";

        

        var specialite = "{{groupe.specialite.label}}";
        var formation = "{{groupe.specialite.formation.nom}}";
        var ville = "{{groupe.specialite.formation.entite_legal.ville}}";
        var frais_inscription = "{{frais_inscription}}";

        var logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
        var logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";

        var echeancier_line = JSON.parse('{{echeancier_line|escapejs}}');
        var qualification = "{{qualification}}";

        var date_debut = "{{date_debut}}";
        var date_fin   = "{{date_fin}}";
        var branche = "{{branche}}";

        // Update selected count
        function updateSelectedCount() {
            var selectedCount = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#attestationSelectedCount').text(selectedCount);
        }

        // Update admission selected count
        function updateAdmissionSelectedCount() {
            var selectedCount = $('input[name="selectedAdmissionStudents"]:checked').length;
            $('#admissionSelectedCount').text(selectedCount);
        }

        // Select all functionality for attestation modal
        $('#selectAllAttestationStudents').change(function() {
            $('input[name="selectedAttestationStudents"]').prop('checked', this.checked);
            updateSelectedCount();
        });

        // Select all functionality for admission modal
        $('#selectAllAdmissionStudents').change(function() {
            $('input[name="selectedAdmissionStudents"]').prop('checked', this.checked);
            updateAdmissionSelectedCount();
        });

        // Individual checkbox change for attestation modal
        $(document).on('change', 'input[name="selectedAttestationStudents"]', function() {
            updateSelectedCount();
            // Update "select all" checkbox state
            var totalCheckboxes = $('input[name="selectedAttestationStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#selectAllAttestationStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Individual checkbox change for admission modal
        $(document).on('change', 'input[name="selectedAdmissionStudents"]', function() {
            updateAdmissionSelectedCount();
            // Update "select all" checkbox state
            var totalCheckboxes = $('input[name="selectedAdmissionStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedAdmissionStudents"]:checked').length;
            $('#selectAllAdmissionStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Search functionality for attestation modal
        $('#attestationStudentSearch').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('#attestationStudentsTableBody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

        // Search functionality for admission modal
        $('#admissionStudentSearch').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('#admissionStudentsTableBody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

        function updateSelectedCount() {
            var selectedCount = $('input[name="selectedStudents"]:checked').length;
            $('#selectedCount').text(selectedCount);
        }

        // Handle select all checkbox
        $('#selectAllStudents').on('change', function() {
            $('input[name="selectedStudents"]').prop('checked', this.checked);
            updateSelectedCount();
        });

        // Handle individual checkbox changes
        $(document).on('change', 'input[name="selectedStudents"]', function() {
            updateSelectedCount();
            
            // Update select all checkbox state
            var totalCheckboxes = $('input[name="selectedStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedStudents"]:checked').length;
            $('#selectAllStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Handle student search
        $('#studentSearch').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('#studentsTableBody tr').each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Handle certificat generation
        $(document).on('click', '#generateCertificatBtn',function() {
            var selectedStudents = [];
            $('input[name="selectedStudents"]:checked').each(function() {
                selectedStudents.push($(this).val());
            });

            if (selectedStudents.length === 0) {
                alert('Veuillez sélectionner au moins un étudiant.');
                return;
            }

            // Generate certificates for selected students
            generateCertificates(selectedStudents);
        });

        // Function to generate certificates in PDF
        function generateCertificates(studentIds) {
            const { jsPDF } = window.jspdf;
            
            // Create a new PDF document - it starts with one page by default
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Remove the default first page since we'll add pages as needed
            doc.deletePage(1);
            
            // Define logo variables for this function (consistent with attestation section)
            const logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
            const logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";
            
            // Ensure the paths are absolute URLs with proper media path
            let headerLogoUrl = logo_header;
            let footerLogoUrl = logo_footer;
            
            if(headerLogoUrl && headerLogoUrl.trim() !== '' && !headerLogoUrl.startsWith('http')) {
                // Check if the path already has /media/ in it, if not add it
                if (!headerLogoUrl.startsWith('/media/')) {
                    headerLogoUrl = '/media/' + headerLogoUrl;
                }
                headerLogoUrl = window.location.origin + headerLogoUrl;
            }
            
            if(footerLogoUrl && footerLogoUrl.trim() !== '' && !footerLogoUrl.startsWith('http')) {
                // Check if the path already has /media/ in it, if not add it
                if (!footerLogoUrl.startsWith('/media/')) {
                    footerLogoUrl = '/media/' + footerLogoUrl;
                }
                footerLogoUrl = window.location.origin + footerLogoUrl;
            }
            
            // Iterate through each selected student and add their certificate using the formatted URLs
            {% for student_line in students %}
            if (studentIds.includes('{{student_line.student.id}}')) {
                // Pass the formatted logo URLs to the addCertificatePage function
                addCertificatePage(doc, '{{student_line.student.nom|escapejs}}', '{{student_line.student.prenom|escapejs}}', '{{student_line.student.date_naissance|date:"d/m/Y"|escapejs}}', '{{student_line.student.lieu_naissance|escapejs}}', '{{groupe.nom|escapejs}}', '{{groupe.specialite|escapejs}}', '{{groupe.annee_scolaire|escapejs}}', '{{tenant.name|default:"Nom de l\'institution"|escapejs}}', headerLogoUrl, footerLogoUrl);
            }
            {% endfor %}
            
            // Save the PDF if there are pages
            if (doc.getNumberOfPages() > 0) {
                doc.save("certificats_scolarite_{{groupe.nom}}.pdf");
            } else {
                alert("Aucun certificat à générer.");
            }
        }

        // Function to add a certificate page for a student
        function addCertificatePage(doc, studentNom, studentPrenom, studentDateNaissance, studentLieuNaissance, groupeNom, specialite, anneeScolaire, institutionName, headerLogoUrl, footerLogoUrl) {
            // Add a new page for each certificate
            doc.addPage();

            // Set font size
            doc.setFontSize(12);

            // Define margins
            var leftMargin = 20;
            var rightMargin = 190; // Standard A4 page width is 210mm, so right margin at 20mm from right edge
            var pageWidth = doc.internal.pageSize.width;
            var textAreaWidth = rightMargin - leftMargin;

            // Add header logo if available (on the left side, 25% of page width)
            if(headerLogoUrl && headerLogoUrl.trim() !== '') {
                try {
                    // Calculate the position for the header logo (top left corner, 25% of page width)
                    const logoWidth = pageWidth * 0.25; // 25% of page width
                    const logoX = leftMargin; // Position from left margin
                    const logoY = 10; // Position from top (moved up from 15 to 10)

                    // Determine image format based on file extension
                    let format = 'JPEG'; // Default format
                    if (headerLogoUrl.toLowerCase().endsWith('.png')) {
                        format = 'PNG';
                    } else if (headerLogoUrl.toLowerCase().endsWith('.jpg') || headerLogoUrl.toLowerCase().endsWith('.jpeg')) {
                        format = 'JPEG';
                    } else if (headerLogoUrl.toLowerCase().endsWith('.gif')) {
                        format = 'GIF';
                    }

                    // Add the header logo to the document with 25% page width, auto height for aspect ratio
                    doc.addImage(headerLogoUrl, format, logoX, logoY, logoWidth, 0); // width=25% of page, height=auto

                    // Adjust starting position for text content if header logo is present
                    // This is handled in the text positioning below
                } catch (e) {
                    console.log("Error adding header logo to certificate:", e.message);

                    // Fallback: try adding with fixed dimensions if percentage approach fails
                    try {
                        const logoWidth = pageWidth * 0.25; // 25% of page width
                        const logoHeight = 25; // Fixed height for logo
                        const logoX = leftMargin; // Position from left margin
                        const logoY = 10; // Position from top (moved up from 15 to 10)

                        doc.addImage(headerLogoUrl, logoX, logoY, logoWidth, logoHeight);
                    } catch (fallbackError) {
                        console.log("Fallback also failed for header logo in certificate:", fallbackError.message);
                    }
                }
            }

            // Add title "Certificat de scolarité" at top right with calligraphic style
            doc.setFontSize(22); // Increased size
            doc.setFont('helvetica', 'bolditalic'); // Using bold italic to simulate calligraphic style
            var certificatText = "Certificat de scolarité";
            var certificatWidth = doc.getTextWidth(certificatText);
            var titleX = (pageWidth - certificatWidth) / 2; // Center the title instead of right aligning
            doc.text(certificatText, titleX, 55); // Combined text in calligraphic style (moved down from 35 to 55 to match attestation spacing)

            // Add ID at top, with extra space below the title
            doc.setFontSize(12); // Reset to normal size
            doc.setFont('helvetica', 'normal'); // Reset font to normal
            doc.text("ID : ", leftMargin, 80); // Increased Y position to add more space below title and logo

            // Add main certification text - using splitTextToSize to ensure it stays within margins
            var certificationText = "Je soussigné, Directeur général de l'Ecole de Formation Professionnelle " + institutionName + ", certifie que l'apprenant (e) :";
            var wrappedCertificationText = doc.splitTextToSize(certificationText, textAreaWidth);
            doc.text(wrappedCertificationText, leftMargin, 91); // 11pt spacing after "ID : "

            // Student name (bold)
            doc.setFontSize(14);
            var studentName = studentNom.toUpperCase() + " " + studentPrenom.toUpperCase();
            // Ensure student name doesn't exceed margins
            var wrappedStudentName = doc.splitTextToSize(studentName, textAreaWidth);
            doc.text(wrappedStudentName, leftMargin, 102); // 11pt spacing after certification text
            doc.setFontSize(12);

            // Birth information
            var birthInfo = "Né (e) le " + studentDateNaissance + " à " + studentLieuNaissance;
            var wrappedBirthInfo = doc.splitTextToSize(birthInfo, textAreaWidth);
            doc.text(wrappedBirthInfo, leftMargin, 113); // 11pt spacing after student name

            // Add formation information
            var formationInfo = "Suit la formation résidentielle de {{groupe.specialite.formation}}";
            var wrappedFormationInfo = doc.splitTextToSize(formationInfo, textAreaWidth);
            doc.text(wrappedFormationInfo, leftMargin, 124); // 11pt spacing after birth info

            var brancheInfo = "Branche : {{groupe.specialite.branche}}";
            var wrappedBrancheInfo = doc.splitTextToSize(brancheInfo, textAreaWidth);
            doc.text(wrappedBrancheInfo, leftMargin, 135); // 11pt spacing after formation info

            var specialiteInfo = "Spécialité : " + specialite;
            var wrappedSpecialiteInfo = doc.splitTextToSize(specialiteInfo, textAreaWidth);
            doc.text(wrappedSpecialiteInfo, leftMargin, 146); // 11pt spacing after branche

            var qualificationInfo = "Niveau de qualification : {{groupe.specialite.formation.qualification}}";
            var wrappedQualificationInfo = doc.splitTextToSize(qualificationInfo, textAreaWidth);
            doc.text(wrappedQualificationInfo, leftMargin, 157); // 11pt spacing after specialite

            // Training dates
            var startDateInfo = "Début de formation : {{groupe.start_date|date:'d/m/Y'}}";
            var wrappedStartDateInfo = doc.splitTextToSize(startDateInfo, textAreaWidth);
            doc.text(wrappedStartDateInfo, leftMargin, 168); // 11pt spacing after niveau

            var endDateInfo = "Fin de formation : {{groupe.end_date|date:'d/m/Y'}}";
            var wrappedEndDateInfo = doc.splitTextToSize(endDateInfo, textAreaWidth);
            doc.text(wrappedEndDateInfo, leftMargin, 179); // 11pt spacing after début formation

            // Academic year
            var anneeText = "Année professionnelle : " + anneeScolaire;
            var wrappedAnneeText = doc.splitTextToSize(anneeText, textAreaWidth);
            doc.text(wrappedAnneeText, leftMargin, 190); // 11pt spacing after fin formation

            // Add spacing before signature
            var yPos = 220; // 30pt spacing before signature to accommodate 11pt spacing

            // Signature section at the bottom - align to right but ensure it doesn't go beyond margins
            // Use the current date when the PDF is generated (printing date)
            var today = new Date();
            var day = String(today.getDate()).padStart(2, '0');
            var month = String(today.getMonth() + 1).padStart(2, '0'); // add 1 because month is 0-indexed
            var year = today.getFullYear();
            var currentDateFormatted = day + '/' + month + '/' + year;
            var text = "Fait à " + "{{groupe.specialite.formation.entite_legal.ville}}" + " , le " + currentDateFormatted; // Updated to match the format in profile_etudiant
            // Align to right within the text area
            var textWidth = doc.getTextWidth(text);
            var alignedRightX = rightMargin - textWidth;
            doc.text(text, alignedRightX, 225); // Adjusted for 11pt spacing from 195 to 225

            // Align "Le Directeur Général" to the right as well
            var directorText = "Le Directeur Général";
            var directorTextWidth = doc.getTextWidth(directorText);
            var directorX = rightMargin - directorTextWidth;
            doc.text(directorText, directorX, 236); // Adjusted for 11pt spacing from 203 to 236 (11 units after date)

            // Add footer logo if available
            if(footerLogoUrl && footerLogoUrl.trim() !== '') {
                try {
                    // Calculate the position for the footer logo (bottom centered)
                    const logoWidth = pageWidth - (2 * leftMargin); // Use full page width minus margins
                    const logoX = leftMargin; // Position at left margin
                    const logoY = 270; // Position slightly lower to accommodate larger image (moved down from 265 to 270)

                    // Determine image format based on file extension
                    let format = 'JPEG'; // Default format
                    if (footerLogoUrl.toLowerCase().endsWith('.png')) {
                        format = 'PNG';
                    } else if (footerLogoUrl.toLowerCase().endsWith('.jpg') || footerLogoUrl.toLowerCase().endsWith('.jpeg')) {
                        format = 'JPEG';
                    } else if (footerLogoUrl.toLowerCase().endsWith('.gif')) {
                        format = 'GIF';
                    }

                    // Add the footer logo to the document, using almost full page width
                    // Use calculated width and let height adjust automatically to maintain aspect ratio
                    doc.addImage(footerLogoUrl, format, logoX, logoY, logoWidth, 0); // width=calculated, height=0 means auto height

                    // The actual height will be calculated automatically to maintain aspect ratio
                    // For signature positioning, we'll use a more conservative approach
                    // Since logo might be tall, we'll add more space below
                    var currentY = logoY + 35; // Position considering potentially taller logo (reduced from 40 to 35)
                } catch (e) {
                    console.log("Error adding footer logo to certificate:", e.message);

                    // Fallback: try adding with fixed dimensions if original size approach fails
                    try {
                        const logoWidth = pageWidth - (2 * leftMargin); // Use full page width minus margins
                        const logoHeight = 35; // Fixed height for logo
                        const logoX = leftMargin; // Position at left margin
                        const logoY = 270; // Near bottom of page (moved down from 265 to 270)

                        doc.addImage(footerLogoUrl, logoX, logoY, logoWidth, logoHeight);

                        // Adjust the signature position if footer logo is present
                        var currentY = logoY + logoHeight + 15; // Position signature below the footer logo (increased from 10 to 15)
                    } catch (fallbackError) {
                        console.log("Fallback also failed for footer logo in certificate:", fallbackError.message);
                    }
                }
            } else {
                // If no footer logo, set a default position
                var currentY = 250; // Default position when no footer logo
            }

            // Footer note - on a single line, just above the logo
            doc.setFontSize(9);
            var footerText = "Ce certificat n'est délivré qu'en un seul exemplaire. Il appartient à l'apprenant (e) d'en faire des photocopies conformes.";
            doc.text(footerText, leftMargin, currentY - 15); // Positioned just above the logo
        }
   
        // Load the contract model for the group's formation automatically
        function loadContractModel() {
            // Clear any previous error
            $('#contratModelError').hide();
            
            // Load models via AJAX that match the group's formation and school year
            $.ajax({
                url: '{% url "t_etudiants:ApiGetModeleContratByFormation" %}',
                type: 'GET',
                data: { 
                    'formation_id': '{{groupe.specialite.formation.id}}',
                    'annee_scolaire': '{{groupe.annee_scolaire}}'  // Pass the group's school year for additional filtering
                },
                dataType: 'JSON',
                success: function(response) {
                    if (response.status === 'success' && response.data && response.data.length > 0) {
                        var matchingModels = response.data;
                        
                        // Use the first matching model (or the first active one if available)
                        var selectedModel = matchingModels[0];
                        
                        // If there are multiple models, try to select an active one
                        var activeModels = matchingModels.filter(function(model) {
                            return model.statut === 'act';  // Assuming 'act' means active
                        });
                        
                        if (activeModels.length > 0) {
                            selectedModel = activeModels[0];
                        }
                        
                        // Update the display and hidden field
                        $('#selectedContractDisplay').text(selectedModel.nom + ' (' + (selectedModel.annee_scolaire || 'N/A') + ')');
                        $('#contratModelId').val(selectedModel.id);
                        $('#contratModelError').hide();
                    } else {
                        $('#selectedContractDisplay').html('<span class="text-danger">Aucun modèle de contrat disponible pour cette formation et année scolaire</span>');
                        $('#contratModelId').val('');
                        $('#contratModelError').text('Aucun modèle de contrat disponible pour cette formation et année scolaire.').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading contract models:', error);
                    $('#selectedContractDisplay').html('<span class="text-danger">Erreur de chargement des modèles de contrat</span>');
                    $('#contratModelId').val('');
                    $('#contratModelError').text('Erreur lors du chargement des modèles de contrat.').show();
                }
            });
        }
        
        // Load contract model when modal is shown
        $('#contratsModal').on('shown.bs.modal', function() {
            loadContractModel();
            updateContratSelectedCount();
        });
        
        // Update selected count for contracts
        function updateContratSelectedCount() {
            var selectedCount = $('input[name="selectedContratStudents"]:checked').length;
            $('#contratSelectedCount').text(selectedCount);
        }

        // Handle select all checkbox for contracts
        $('#selectAllContratStudents').on('change', function() {
            $('input[name="selectedContratStudents"]').prop('checked', this.checked);
            updateContratSelectedCount();
        });

        // Handle individual checkbox changes for contracts
        $(document).on('change', 'input[name="selectedContratStudents"]', function() {
            updateContratSelectedCount();
            
            // Update select all checkbox state
            var totalCheckboxes = $('input[name="selectedContratStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedContratStudents"]:checked').length;
            $('#selectAllContratStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Handle student search for contracts
        $('#contratStudentSearch').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('#contratsStudentsTableBody tr').each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Handle contract generation
        $('#generateContratsBtn').on('click', function() {
            var selectedStudents = [];
            $('input[name="selectedContratStudents"]:checked').each(function() {
                selectedStudents.push($(this).val());
            });

            var selectedModel = $('#contratModelId').val();
            
            if (!selectedModel) {
                alert('Aucun modèle de contrat disponible pour cette formation.');
                return;
            }
            
            if (selectedStudents.length === 0) {
                alert('Veuillez sélectionner au moins un étudiant.');
                return;
            }

            // Generate contracts for selected students and model
            generateContracts(selectedModel, selectedStudents);
        });

        // Function to generate contracts in PDF
        function generateContracts(modelId, studentIds) {
            // First, let's get the clauses for the selected model
            $.ajax({
                url: '{% url "t_etudiants:ApiLoadArticlesContrat" %}',
                data: { modele_id: modelId },
                type: 'GET',
                success: function(clauses) {
                    if (clauses.length === 0) {
                        alert('Aucune clause trouvée pour ce modèle de contrat.');
                        return;
                    }
                    
                    // Get student details for each selected student
                    getStudentDetails(studentIds, function(studentsDetails) {
                        // Generate PDF for each student's contract
                        generateContractPDFs(studentsDetails, clauses);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading contract clauses:', error);
                    alert('Erreur lors du chargement des clauses du contrat.');
                }
            });
        }
        
        // Function to get student details
        function getStudentDetails(studentIds, callback) {
            // Since we don't have a specific API to get student details, 
            // we'll extract them from the current page's student table
            var studentsDetails = [];
            
            studentIds.forEach(function(studentId) {
                // Find the student in the displayed table
                var studentRow = $('input[name="selectedContratStudents"][value="' + studentId + '"]').closest('tr');
                
                if (studentRow.length > 0) {
                    // Extract student information from the row
                    var studentName = studentRow.find('td:eq(0)').text().trim();
                    var studentEmail = studentRow.find('td:eq(1)').text().trim();
                    var birthInfo = studentRow.find('td:eq(2)').text().trim();
                    
                    // Extract birth date and place based on format: "date à lieu"
                    var birthDate = '';
                    var birthPlace = '';
                    
                    if (birthInfo) {
                        // The format is: "date à lieu" (e.g., "01/01/1990 à Alger")
                        var atIndex = birthInfo.indexOf(' à ');
                        if (atIndex !== -1) {
                            birthDate = birthInfo.substring(0, atIndex).trim();
                            birthPlace = birthInfo.substring(atIndex + 3).trim(); // +3 to skip " à "
                        } else {
                            // Fallback: try to find date pattern
                            var dateRegex = /(\d{2}\/\d{2}\/\d{4}|\d{4}-\d{2}-\d{2})/;
                            var match = birthInfo.match(dateRegex);
                            
                            if (match) {
                                birthDate = match[0];
                                var afterDateIndex = birthInfo.indexOf(birthDate) + birthDate.length;
                                birthPlace = birthInfo.substring(afterDateIndex).replace(/^[\sà]+/, '').trim(); // Remove leading spaces and 'à'
                            } else {
                                // If no 'à' and no date pattern, treat as birth place only
                                birthPlace = birthInfo;
                            }
                        }
                    }
                    
                    // Split name into first and last name (assuming format is "Lastname Firstname")
                    var names = studentName.trim().split(' ');
                    var lastName = names[0] || '';
                    var firstName = names.slice(1).join(' ') || '';
                    
                    // Extract address from the address column (4th column, index 3)
                    var studentAddress = studentRow.find('td:eq(3)').text().trim();

                    // Extract is_double from the "Type Formation" column (5th column, index 5)
                    var isDoubleText = studentRow.find('td:eq(5)').text().trim();
                    // Check if the is_double field is true (considering various representations)
                    // If isDoubleText is empty or undefined, default to false (will add echeancier table)
                    var isDouble = (isDoubleText && (
                                   isDoubleText.toLowerCase() === 'true' ||
                                   isDoubleText.toLowerCase() === '1' ||
                                   isDoubleText.toLowerCase() === 'yes' ||
                                   isDoubleText.toLowerCase() === 'oui' ||
                                   isDoubleText === 'True'));

                    studentsDetails.push({
                        id: studentId,
                        fullName: studentName,
                        lastName: lastName,
                        firstName: firstName,
                        email: studentEmail,
                        birthDate: birthDate,
                        birthPlace: birthPlace,
                        address: studentAddress,
                        isDouble: isDouble
                    });
                }
            });
            
            callback(studentsDetails);
        }
        
        function getEcheancierStudentSpecial(id_student, callback){
            $.ajax({
                url : "{% url 't_etudiants:ApiGetStudentFinancialsData' %}",
                dataType : "JSON",
                type: "GET",
                data : {
                    'id_student' : id_student,
                },
                success: function(data){
                    callback(data);
                },
                error: function(xhr, status, error) {
                    console.log("Error getting student financials data:", error);
                    callback(null); // Return null on error
                }
            })
        }

        // Function to generate contract PDFs
        async function generateContractPDFs(students, clauses) {
            const { jsPDF } = window.jspdf;

            // Create a new PDF document - it starts with one page by default
            const doc = new jsPDF('p', 'mm', 'a4');

            // Remove the default first page since we'll add pages as needed
            doc.deletePage(1);

            // Process each student's contract with their specific echeancier data
            const promises = students.map(function(student) {
                return new Promise(function(resolve) {
                    // Get the student-specific echeancier data
                    getEcheancierStudentSpecial(student.id, function(specificEcheancierData) {
                        // If specific echeancier data is available, use it; otherwise use standard data
                        let echeancierDataToUse = specificEcheancierData && specificEcheancierData.length > 0 ? specificEcheancierData : echeancier_line;

                        // Add the contract page with the appropriate echeancier data
                        addContractPage(doc, student, clauses, echeancierDataToUse);

                        resolve(); // Resolve the promise when the contract page is added
                    });
                });
            });

            // Wait for all promises to resolve
            await Promise.all(promises);

            // Save the PDF after all students have been processed
            if (doc.getNumberOfPages() > 0) {
                doc.save("contrats_{{groupe.nom}}.pdf");

                // Close the modal
                $('#contratsModal').modal('hide');
            } else {
                alert("Aucun contrat à générer.");
            }
        }
        
        // Function to add a contract page for a student
        function addContractPage(doc, student, clauses, echeancierDataToUse) {
            // Add a new page for each contract
            doc.addPage();

            // Set margins and font
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;

            // Set font to Times New Roman at 10pt for the entire document
            doc.setFont('times', 'normal');
            doc.setFontSize(10);

            // Add centered title
            doc.setFontSize(12);
            doc.setFont('times', 'bold');
            doc.text("CONTRAT DE FORMATION", pageWidth / 2, 30, { align: 'center' });
            doc.setFont('times', 'normal');
            doc.setFontSize(10);

            // Add "Entre les soussignés" section
            let currentY = 40;
            doc.setFont('times', 'bold');
            doc.text("Entre les soussignés :", margin, currentY);
            doc.setFont('times', 'normal');
            currentY += 8;

            // Institution details
            doc.text("L'établissement privé de formation professionnelle "+designation, margin, currentY);
            currentY += 5;
            
            doc.text('Sis '+adresse, margin, currentY);
            currentY += 5;
            doc.text("Représenté par "+representant+" en sa qualité de Directeur,", margin, currentY);
            currentY += 8;

            // Separator
            doc.text("Et", margin, currentY);
            currentY += 8;

            // Student details
            // Format: "Le stagiaire (Nom et prénom)"
            doc.text("Le stagiaire " + student.fullName.trim(), margin, currentY);
            currentY += 5;

            // Format: "Né(e) le :     A :"
            var birthText = "Né(e) le : " + student.birthDate + "    A : " + student.birthPlace;
            doc.text(birthText, margin, currentY);
            currentY += 5;

            // Format: "Demeurant à (adresse complète du stagiaire) :"
            doc.text("Demeurant à : " + student.address, margin, currentY);
            currentY += 8;

            // Add clauses
            doc.setFont('times', 'bold');
            doc.text("Clauses du contrat :", margin, currentY);
            doc.setFont('times', 'normal');
            currentY += 6;

            // Add each clause to the document
            clauses.forEach(function(clause, index) {
                // Add clause title if available
                if (clause.titre && clause.titre.trim() !== '') {
                    doc.setFont('times', 'bold');
                    doc.text(clause.titre, margin, currentY);
                    currentY += 5;
                    doc.setFont('times', 'normal');
                }

                // Add clause content
                if (clause.article && clause.article.trim() !== '') {
                    // Process tags in the clause content and replace them with student-specific information
                    var processedContent = processContractTags(clause.article, student);

                    // Split text to fit within page margins
                    var wrappedText = doc.splitTextToSize(processedContent, pageWidth - 2 * margin);

                    // Add the wrapped text with 1.5pt interline spacing
                    for (var i = 0; i < wrappedText.length; i++) {
                        // Check if we need a new page before adding each line
                        if (currentY + 5.5 > 270) { // 270 is close to bottom margin
                            doc.addPage();
                            doc.setFont('times', 'normal');
                            doc.setFontSize(10);
                            currentY = 30;
                        }
                        doc.text(wrappedText[i], margin, currentY);
                        currentY += 5.5; // 4 (original spacing) + 1.5 (additional interline spacing) = 5.5
                    }

                    // Add some space after each clause
                    currentY += 3;

                    // Check if we need a new page after adding content (with 1.5pt interline spacing)
                    if (currentY > 270) {
                        doc.addPage();
                        doc.setFont('times', 'normal');
                        doc.setFontSize(10);
                        currentY = 30;
                    }
                }
            });

            // Add location and date - aligned to the right
            currentY += 10; // Add some space after the clauses
            var currentDate = new Date();
            var formattedDate = currentDate.getDate().toString().padStart(2, '0') + '/' +
                               (currentDate.getMonth() + 1).toString().padStart(2, '0') + '/' +
                               currentDate.getFullYear();
            
            var locationText = "Fait à " + ville + ", le " + formattedDate;
            var textWidth = doc.getTextWidth(locationText);
            var rightMargin = pageWidth - margin;
            doc.text(locationText, rightMargin - textWidth, currentY);

            // Add signature section at the end
            currentY += 10; // Add some space before the signature section

            // Check if we need a new page for signatures
            if (currentY + 80 > 270) { // 80 is estimated height for signature section
                doc.addPage();
                doc.setFont('times', 'normal');
                doc.setFontSize(12);
                currentY = 30;
            }

            // Add signature section
            doc.setFont('times', 'normal');
            doc.text("Le stagiaire", margin, currentY);
            // Align director's signature to the right
            doc.text("Le Directeur de l'établissement", pageWidth - margin - 70, currentY);
            currentY += 6;

            // "Lu et approuvé" in italics at 10pt
            doc.setFont('times', 'italic');
            doc.setFontSize(10);
            doc.text("Signature précédée de la mention « Lu et approuvé »", margin, currentY);
            doc.text("Signature précédée de la mention « Lu et approuvé »", pageWidth - margin - 70, currentY);

            // Reset font back to normal 12pt
            doc.setFont('times', 'normal');
            doc.setFontSize(12);
            currentY += 12;

            // CNI/PC section (only for student)
            doc.text("CNI / PC N°____________________________", margin, currentY);
            currentY += 6;
            doc.text("Délivré le : _____________________________", margin, currentY);
            currentY += 6;
            doc.text("Par : __________________________________", margin, currentY);
            currentY += 8;
            doc.text("Signature", margin, currentY);
            currentY += 15;

            // Skip some space for formatting
            currentY += 15;

            // Tuteur section (for minor students) - centered
            doc.setFont('times', 'normal');
            doc.setFontSize(12);
            var tutorText1 = "Le Tuteur (en cas de stagiaire mineur)";
            var tutorText1Width = doc.getTextWidth(tutorText1);
            var centerX1 = Math.max(margin, (pageWidth - tutorText1Width) / 2);  // Ensure it doesn't go beyond margins
            doc.text(tutorText1, centerX1, currentY);

            currentY += 10;

            // "Lu et approuvé" in italics at 10pt for tutor
            doc.setFont('times', 'italic');
            doc.setFontSize(10);
            var tutorText2 = "Signature précédée de la mention « Lu et approuvé »";
            var tutorText2Width = doc.getTextWidth(tutorText2);
            var centerX2 = Math.max(margin, (pageWidth - tutorText2Width) / 2);  // Ensure it doesn't go beyond margins
            doc.text(tutorText2, centerX2, currentY);

            // Reset font back to normal 12pt
            doc.setFont('times', 'normal');
            doc.setFontSize(12);

            // Add echeancier table page for all students using the specific data
            addEcheancierTablePage(doc, pageWidth, margin, echeancierDataToUse, montant_formation, frais_inscription, annee_academique, document_inscription);
        }
        
        // Function to add echeancier table page
        function addEcheancierTablePage(doc, pageWidth, margin, echeancierData, montantFormation, fraisInscription, anneeAcademique, document_inscription) {
            // Add a new page for the echeancier table
            doc.addPage();

            // Set font for the main header
            doc.setFont('times', 'bold');
            doc.setFontSize(14);

            // Add ANNEXE 1 title above the main title
            var annexTitle = "ANNEXE 1";
            var annexTitleWidth = doc.getTextWidth(annexTitle);
            var annexTitleX = (pageWidth - annexTitleWidth) / 2;
            doc.text(annexTitle, annexTitleX, 25);

            // Add title for the echeancier page below ANNEXE 1
            var title = "Échéancier de paiement";
            var titleWidth = doc.getTextWidth(title);
            var titleX = (pageWidth - titleWidth) / 2;
            doc.text(title, titleX, 35);

            // Add academic year below the main title
            doc.setFontSize(12);
            var academicYearText = "Année académique : " + (anneeAcademique || "{{ annee_academique }}");
            var academicYearWidth = doc.getTextWidth(academicYearText);
            var academicYearX = (pageWidth - academicYearWidth) / 2;
            doc.text(academicYearText, academicYearX, 45);

            // Add "Formation" title above the table, positioned on the left
            doc.setFont('times', 'bold');
            doc.setFontSize(10);
            doc.text("Formation : "+formation, margin, 55);

            // Reset font for table content
            doc.setFont('times', 'normal');
            doc.setFontSize(10);

            // Define table headers - two columns: labels and values
            var headers = ["Désignation", "Montant"];
            var colWidths = [(pageWidth - 2 * margin) * 0.6,  // Labels column
                             (pageWidth - 2 * margin) * 0.4]; // Values column
            var startX = margin;
            var startY = 60; // Adjusted to account for the new titles above the table
            var rowHeight = 10;
            var currentY = startY;

            // Calculate total table width
            var tableWidth = pageWidth - 2 * margin;

            // Draw table header
            doc.setFont('times', 'bold');
            // Draw header background
            doc.setFillColor(240, 240, 240); // Light gray
            doc.rect(startX, currentY, tableWidth, rowHeight, 'F');

            // Draw header text
            var xPos = startX;
            for (var i = 0; i < headers.length; i++) {
                doc.text(headers[i], xPos + 2, currentY + 7);
                xPos += colWidths[i];
            }

            // Reset font for data rows
            doc.setFont('times', 'normal');

            // Add formation cost row
            currentY += rowHeight;
            var yPos = currentY;
            doc.setFillColor(255, 255, 255); // White background
            doc.rect(startX, yPos, tableWidth, rowHeight, 'F');

            // Draw formation cost data
            var labelX = startX + 2;
            var valueX = startX + colWidths[0] + 2;

            doc.text("Coût de la formation en TTC", labelX, yPos + 7);
            doc.text(montantFormation, valueX, yPos + 7);

            // Add inscription fees row
            currentY += rowHeight;
            yPos = currentY;
            doc.setFillColor(250, 250, 250); // Light gray background
            doc.rect(startX, yPos, tableWidth, rowHeight, 'F');

            // Draw inscription fees data
            labelX = startX + 2;
            valueX = startX + colWidths[0] + 2;

            doc.text("Frais d'inscription (non remboursables)", labelX, yPos + 7);
            doc.text(fraisInscription, valueX, yPos + 7);

            // Add total row
            currentY += rowHeight;
            yPos = currentY;
            doc.setFillColor(245, 245, 245); // Slightly darker gray for total
            doc.rect(startX, yPos, tableWidth, rowHeight, 'F');

            // Calculate total
            var total = (parseFloat(montantFormation) || 0) + (parseFloat(fraisInscription) || 0);

            // Draw total data
            labelX = startX + 2;
            valueX = startX + colWidths[0] + 2;

            doc.setFont('times', 'bold');
            doc.text("TOTAL", labelX, yPos + 7);
            doc.text(total.toFixed(2), valueX, yPos + 7);
            doc.setFont('times', 'normal');

            // Add a blank row for spacing
            currentY += rowHeight;
            yPos = currentY;
            doc.setFillColor(255, 255, 255); // White background
            doc.rect(startX, yPos, tableWidth, rowHeight, 'F');

            // Draw label for payment schedule
            labelX = startX + 2;
            doc.text("Échéancier des paiements", labelX, yPos + 7);

            // Draw table rows from echeancierData
            if (echeancierData && echeancierData.length > 0) {
                for (var i = 0; i < echeancierData.length; i++) {
                    currentY += rowHeight;
                    yPos = currentY;

                    // Draw row background (alternating)
                    if (i % 2 === 0) {  // Color even-indexed rows (0, 2, 4...) for proper alternating after the headers
                        doc.setFillColor(250, 250, 250); // Very light gray
                        doc.rect(startX, yPos, tableWidth, rowHeight, 'F');
                    } else {
                        doc.setFillColor(255, 255, 255); // White background
                        doc.rect(startX, yPos, tableWidth, rowHeight, 'F');
                    }

                    // Draw row data
                    var echeance = echeancierData[i]; // Define echeance inside the loop
                    var labelX = startX + 2;
                    var valueX = startX + colWidths[0] + 2;
                    var montant = echeance.montant_tranche || "0";
                    var date = echeance.date_echeancier ? " - " + echeance.date_echeancier : "";

                    // Draw cell content
                    doc.text("Tranche " + (i + 1) + date, labelX, yPos + 7);
                    doc.text(montant, valueX, yPos + 7);

                    // Check if we need a new page
                    if (currentY > 260) { // Adjusted for more space for content
                        doc.addPage();
                        currentY = 30; // Reset Y position on new page
                        startX = margin;
                        tableWidth = pageWidth - 2 * margin; // Reset table width

                        // Redraw header on new page if needed
                        doc.setFont('times', 'bold');
                        doc.setFillColor(240, 240, 240); // Light gray
                        doc.rect(startX, currentY, tableWidth, rowHeight, 'F');

                        // Draw header text
                        var headerXPos = startX;
                        for (var j = 0; j < headers.length; j++) {
                            doc.text(headers[j], headerXPos + 2, currentY + 7);
                            headerXPos += colWidths[j];
                        }

                        doc.setFont('times', 'normal');
                        currentY += rowHeight;
                    }
                }
            } else {
                // If no echeancier data, add a message
                currentY += rowHeight;
                yPos = currentY;
                doc.text("Aucune donnée d'échéancier disponible", startX, yPos + 7);
            }

            // Now draw all borders for the complete table
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3); // Slightly thicker border for outer box

            // Draw vertical lines for columns that extend to the actual final position
            doc.setLineWidth(0.1); // Thinner for inner lines
            var xPosition = startX;
            for (var i = 0; i <= headers.length; i++) {
                doc.line(xPosition, startY, xPosition, currentY);
                if (i < headers.length) {
                    xPosition += colWidths[i];
                }
            }

            // Draw outer border of the table to ensure it encompasses all content
            doc.setLineWidth(0.3); // Slightly thicker border for outer box
            doc.rect(startX, startY, tableWidth, currentY - startY);

            // Draw horizontal lines for rows - using the actual positions where content was drawn
            doc.setLineWidth(0.1); // Thinner for inner lines
            // Draw horizontal line at the top of the table
            doc.line(startX, startY, startX + tableWidth, startY);

            // Draw horizontal lines after each row that was actually drawn
            var actualY = startY + rowHeight; // After header
            doc.line(startX, actualY, startX + tableWidth, actualY);

            actualY += rowHeight; // After formation cost
            doc.line(startX, actualY, startX + tableWidth, actualY);

            actualY += rowHeight; // After fees
            doc.line(startX, actualY, startX + tableWidth, actualY);

            actualY += rowHeight; // After total
            doc.line(startX, actualY, startX + tableWidth, actualY);

            actualY += rowHeight; // After "Échéancier" header
            doc.line(startX, actualY, startX + tableWidth, actualY);

            // Draw horizontal lines after each echeancier data row
            if (echeancierData && echeancierData.length > 0) {
                for (var i = 0; i < echeancierData.length; i++) {
                    actualY += rowHeight; // After each echeancier row
                    doc.line(startX, actualY, startX + tableWidth, actualY);
                }
            } else {
                // If no echeancier data, we still need a line after the "no data" message
                actualY += rowHeight;
                doc.line(startX, actualY, startX + tableWidth, actualY);
            }

            // Add section for registration documents below the table
            currentY += 20; // Add some space below the table

            // Add title for the documents section
            doc.setFont('times', 'bold');
            doc.text("Documents d'inscription requis :", startX, currentY);
            currentY += 8;

            // Draw list of registration documents with right indentation
            if (document_inscription && document_inscription.length > 0) {
                doc.setFont('times', 'normal');

                // Add indentation for the document list
                var documentIndent = startX + 10; // 10mm indentation to the right

                for (var i = 0; i < document_inscription.length; i++) {
                    var docItem = document_inscription[i];
                    var docLabel = (docItem.label || "Document inconnu").toString();

                    // Add bullet point and document label with indentation
                    doc.text("• " + docLabel, documentIndent, currentY);
                    currentY += 6; // Space between items

                    // Check if we need a new page
                    if (currentY > 270) {
                        doc.addPage();
                        currentY = 30; // Reset Y position on new page
                        startX = margin;
                        documentIndent = startX + 10; // Reset indentation

                        // Add title for documents section on new page
                        doc.setFont('times', 'bold');
                        doc.text("Documents d'inscription requis :", startX, currentY);
                        currentY += 8;
                        doc.setFont('times', 'normal');
                    }
                }
            } else {
                doc.setFont('times', 'normal');
                // Apply same indentation to the "no documents" message
                var documentIndent = startX + 10; // 10mm indentation to the right
                doc.text("Aucun document d'inscription requis spécifié.", documentIndent, currentY);
                currentY += 6;
            }

            // Reset colors and font
            doc.setFillColor(0, 0, 0);
            doc.setDrawColor(0, 0, 0);
            doc.setFont('times', 'normal');
        }

        // Function to process tags in contract content and replace with student data
        function processContractTags(content, student) {
            // Replace tags with actual student information
            if (!content) return content;
            
            return content
                .replace(/\[nom_etudiant\]/g, student.lastName || '')
                .replace(/\[prenom_etudiant\]/g, student.firstName || '')
                .replace(/\[duree_formation\]/g, '{{groupe.specialite.formation.duree|default:"N/A"}}')
                .replace(/\[formations\]/g, '{{groupe.specialite.formation.nom}}')
                .replace(/\[qualification\]/g, '{{groupe.specialite.formation.qualification|default:"N/A"}}')
                .replace(/\[frais_inscription\]/g, '{{groupe.specialite.formation.frais_inscription|default:"N/A"}}')
                .replace(/\[prix_formation\]/g, '{{groupe.specialite.formation.prix|default:"N/A"}}')
                .replace(/\[specialite\]/g, '{{groupe.specialite.label|default:"N/A"}}')
                .replace(/\[date_naissance_etudiant\]/g, student.birthDate || '')
                .replace(/\[lieu_naissance_etudiant\]/g, student.birthPlace || '')
                .replace(/\[adresse_etudiant\]/g, "______________"); // Address not available in this context
        }
        
             // Generate admission certificates function
        $('#generateAdmissionBtn').click(function() {
            var selectedStudents = [];
            $('input[name="selectedAdmissionStudents"]:checked').each(function() {
                var studentId = $(this).val();
                var studentRow = $(this).closest('tr');
                var studentData = {
                    id: studentId,
                    nom: studentRow.find('td:eq(0)').text().split(' ').slice(1).join(' ').trim(), // Everything after first name
                    prenom: studentRow.find('td:eq(0)').text().split(' ')[0], // First part is prenom
                    email: studentRow.find('td:eq(1)').text(),
                    date_naissance: studentRow.find('td:eq(2)').text().split(' à ')[0],
                    lieu_naissance: studentRow.find('td:eq(2)').text().split(' à ')[1],
                    adresse: studentRow.find('td:eq(3)').text(),
                    matricule_interne: studentId // Using ID as matricule for now
                };
                selectedStudents.push(studentData);
            });

            if (selectedStudents.length === 0) {
                alert('Veuillez sélectionner au moins un étudiant.');
                return;
            }

            // Prepare data for all students
            var allStudentsData = [];
            selectedStudents.forEach(function(student) {
                var studentData = {
                    id: student.id,
                    nom: student.nom,
                    prenom: student.prenom,
                    email: student.email,
                    date_naissance: student.date_naissance,
                    lieu_naissance: student.lieu_naissance,
                    adresse: student.adresse,
                    matricule_interne: student.matricule_interne
                };
                allStudentsData.push(studentData);
            });

            // Call the generateAdmissionCertificate function with all students data
            generateAdmissionCertificate(
                allStudentsData,
                "{{groupe.specialite.formation.nom}}",
                "{{groupe.specialite.label}}",
                "{{groupe.start_date}}",
                "{{groupe.end_date}}",
                "{{groupe.nom}}",
                "{{groupe.annee_scolaire}}",
                "{{today_date|date:'d/m/Y'|default:''}}"
            );

            // Close the modal after generation
            $('#certificatAdmissionModal').modal('hide');
        });
        
        // Function to generate admission certificate PDF
        function generateAdmissionCertificate(students, programme, specialite, dateDebut, dateFin, groupe, anneeAcademique, dateCertificat) {
            const { jsPDF } = window.jspdf;

            // Create a new PDF document
            const doc = new jsPDF('p', 'mm', 'a4');

            // Set margins and font
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;

            // Set font to Times New Roman at 12pt for the entire document
            doc.setFont('times', 'normal');
            doc.setFontSize(12);

            // If students is not an array, make it an array
            if (!Array.isArray(students)) {
                students = [students];
            }

            // Generate a page for each student
            students.forEach(function(student, index) {
                // Add a new page for each student except the first one
                if (index > 0) {
                    doc.addPage();
                }

                // Add header logo on the left (25% of page width)
                if(logo_header && logo_header.trim() !== '') {
                    try {
                        const logoWidth = pageWidth * 0.25; // 25% of page width
                        const logoX = margin; // Position from left margin
                        const logoY = 10; // Position from top

                        // Determine image format based on file extension
                        let format = 'JPEG';
                        if (logo_header.toLowerCase().endsWith('.png')) {
                            format = 'PNG';
                        } else if (logo_header.toLowerCase().endsWith('.jpg') || logo_header.toLowerCase().endsWith('.jpeg')) {
                            format = 'JPEG';
                        } else if (logo_header.toLowerCase().endsWith('.gif')) {
                            format = 'GIF';
                        }

                        doc.addImage(logo_header, format, logoX, logoY, logoWidth, 0);
                    } catch (e) {
                        console.log("Error adding header logo:", e.message);
                    }
                }

                // Add partner logo on the right (25% of page width)
                if(logo_partenaire && logo_partenaire.trim() !== '') {
                    try {
                        const logoWidth = pageWidth * 0.25; // 25% of page width
                        const logoX = pageWidth - margin - logoWidth; // Position from right margin
                        const logoY = 10; // Position from top

                        // Determine image format based on file extension
                        let format = 'JPEG';
                        if (logo_partenaire.toLowerCase().endsWith('.png')) {
                            format = 'PNG';
                        } else if (logo_partenaire.toLowerCase().endsWith('.jpg') || logo_partenaire.toLowerCase().endsWith('.jpeg')) {
                            format = 'JPEG';
                        } else if (logo_partenaire.toLowerCase().endsWith('.gif')) {
                            format = 'GIF';
                        }

                        doc.addImage(logo_partenaire, format, logoX, logoY, logoWidth, 0);
                    } catch (e) {
                        console.log("Error adding partner logo:", e.message);
                    }
                }

                // Add centered title
                let currentY = 50; // Start position after logos
                doc.setFontSize(16);
                doc.setFont('times', 'bold');
                doc.text("CERTIFICAT D’ADMISSION", pageWidth / 2, currentY, { align: 'center' });
                currentY += 10;

                // Add programme line
                doc.setFontSize(14);
                doc.setFont('times', 'normal');
                doc.text("Programme Bachelor", pageWidth / 2, currentY, { align: 'center' });
                currentY += 20;

                // Add "Nous soussignés" line - wrap if necessary
                var nousSoussignesText = "Nous soussignés, Higher International Management Institute - HIMI Business School certifions que :";
                var wrappedNousSoussignesText = doc.splitTextToSize(nousSoussignesText, pageWidth - 2 * margin);
                for (var i = 0; i < wrappedNousSoussignesText.length; i++) {
                    doc.text(wrappedNousSoussignesText[i], margin, currentY);
                    currentY += 6;
                }
                currentY += 9; // Additional space after the wrapped text

                // Add student name - centered but within margins
                doc.setFont('times', 'bold');
                var studentNameText = student.nom + " " + student.prenom;
                var studentNameWidth = doc.getTextWidth(studentNameText);
                var studentNameX = (pageWidth - studentNameWidth) / 2;
                doc.text(studentNameText, studentNameX, currentY);
                currentY += 10;

                // Add birth date and place - centered but within margins
                doc.setFont('times', 'normal');
                var birthText = "Né(e) le " + (student.date_naissance || "____/____/____") + " à " + (student.lieu_naissance || "_______");
                var birthTextWidth = doc.getTextWidth(birthText);
                var birthTextX = (pageWidth - birthTextWidth) / 2;
                doc.text(birthText, birthTextX, currentY);
                currentY += 15;

                // Add inscription details
                var inscriptionText = "Est inscrit(e) au programme de Bachelor développé en partenariat avec l'école Pôle Paris Alternance.";
                var wrappedInscriptionText = doc.splitTextToSize(inscriptionText, pageWidth - 2 * margin);
                for (var i = 0; i < wrappedInscriptionText.length; i++) {
                    doc.text(wrappedInscriptionText[i], margin, currentY);
                    currentY += 6;
                }

                // Add speciality
                currentY += 5;
                doc.text("Spécialité : " + (specialite || "___________"), margin, currentY);
                currentY += 8;

                // Add period dates
                doc.text("Pour la période du : " + (dateDebut || "____/____/____") + " au : " + (dateFin || "____/____/____"), margin, currentY);
                currentY += 8;

                // Add group
                doc.text("Groupe : " + (groupe || "_______"), margin, currentY);
                currentY += 8;

                // Add academic year
                doc.text("Année académique : " + (anneeAcademique || "_______"), margin, currentY);
                currentY += 25;

                // Add location and date - aligned to the right but within margins
                var locationText = "Alger, le " + (dateCertificat || "____/____/____");
                var textWidth = doc.getTextWidth(locationText);
                var rightMargin = pageWidth - margin;
                doc.text(locationText, rightMargin - textWidth, currentY);

                currentY += 15; // Reduced space before signature - just below the date

                // Add signature line centered, just below the date
                doc.text("Le Directeur général", pageWidth / 2, currentY, { align: 'center' });

                // Add footer logo if available
                if(logo_footer && logo_footer.trim() !== '') {
                    try {
                        // Calculate the position for the footer logo (bottom centered)
                        const logoWidth = pageWidth - (2 * margin); // Use full page width minus margins
                        const logoX = margin; // Position at left margin
                        const logoY = pageHeight - 30; // Position near bottom of page

                        // Determine image format based on file extension
                        let format = 'JPEG';
                        if (logo_footer.toLowerCase().endsWith('.png')) {
                            format = 'PNG';
                        } else if (logo_footer.toLowerCase().endsWith('.jpg') || logo_footer.toLowerCase().endsWith('.jpeg')) {
                            format = 'JPEG';
                        } else if (logo_footer.toLowerCase().endsWith('.gif')) {
                            format = 'GIF';
                        }

                        // Add the footer logo to the document
                        doc.addImage(logo_footer, format, logoX, logoY, logoWidth, 0);
                    } catch (e) {
                        console.log("Error adding footer logo:", e.message);
                    }
                }

                // Add page number
                doc.setFontSize(10);
                doc.text("Page " + (index + 1) + " / " + students.length, pageWidth - margin - 20, pageHeight - 10);
            });

            // Save the PDF with all certificates
            doc.save("certificats_admission_" + groupe + ".pdf");
        }
          
        // Ensure the paths are absolute URLs with proper media path
        if(logo_header && logo_header.trim() !== '' && !logo_header.startsWith('http')) {
            // Check if the path already has /media/ in it, if not add it
            if (!logo_header.startsWith('/media/')) {
                logo_header = '/media/' + logo_header;
            }
            logo_header = window.location.origin + logo_header;
        }
        
        if(logo_footer && logo_footer.trim() !== '' && !logo_footer.startsWith('http')) {
            // Check if the path already has /media/ in it, if not add it
            if (!logo_footer.startsWith('/media/')) {
                logo_footer = '/media/' + logo_footer;
            }
            logo_footer = window.location.origin + logo_footer;
        }
       
        // Update selected count
        function updateAttestationSelectedCount() {
            var selectedCount = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#attestationSelectedCount').text(selectedCount);
        }

        // Handle select all checkbox
        $('#selectAllAttestationStudents').on('change', function() {
            $('input[name="selectedAttestationStudents"]').prop('checked', this.checked);
            updateAttestationSelectedCount();
        });

        // Handle individual checkbox changes
        $(document).on('change', 'input[name="selectedAttestationStudents"]', function() {
            updateAttestationSelectedCount();
            
            // Update select all checkbox state
            var totalCheckboxes = $('input[name="selectedAttestationStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#selectAllAttestationStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Handle student search
        $('#attestationStudentSearch').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('#attestationStudentsTableBody tr').each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Handle attestation generation
        $('#generateAttestationBtn').on('click', function() {
            var selectedStudents = [];
            $('input[name="selectedAttestationStudents"]:checked').each(function() {
                selectedStudents.push($(this).val());
            });

            if (selectedStudents.length === 0) {
                alert('Veuillez sélectionner au moins un étudiant.');
                return;
            }

            // Generate attestations for selected students
            generateAttestations(selectedStudents);
        });

        var ville = "{{groupe.specialite.formation.entite_legal.ville}}";
        
        // Function to generate attestations in PDF
        function generateAttestations(studentIds) {
            const { jsPDF } = window.jspdf;
            
            // Create a new PDF document - it starts with one page by default
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Remove the default first page since we'll add pages as needed
            doc.deletePage(1);
            
            // Iterate through each selected student and add their attestation
            {% for student_line in students %}
            if (studentIds.includes('{{student_line.student.id}}')) {
                addAttestationPage(doc, '{{student_line.student.nom|escapejs}}', '{{student_line.student.prenom|escapejs}}', '{{student_line.student.date_naissance|date:"d/m/Y"|escapejs}}', '{{student_line.student.lieu_naissance|escapejs}}', '{{groupe.specialite.formation.nom|escapejs}}', specialite, '{{groupe.annee_scolaire|escapejs}}', '{{tenant.name|default:"INSIM"|escapejs}}', ville);
            }
            {% endfor %}
            
            // Save the PDF if there are pages
            if (doc.getNumberOfPages() > 0) {
                doc.save("attestations_inscription_{{groupe.nom}}.pdf");
            } else {
                alert("Aucune attestation à générer.");
            }
        }

        // Function to add an attestation page for a student
        function addAttestationPage(doc, studentNom, studentPrenom, studentDateNaissance, studentLieuNaissance, formation, specialite, anneeScolaire, institutionName, ville) {
            // Add a new page for each attestation
            doc.addPage();
            
            // Set margins and font
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            const textWidth = pageWidth - 2 * margin; // Available text width
            
            doc.setFontSize(12);
            
            // Add header logo if available (on the left side, 25% of page width)
            if(logo_header && logo_header.trim() !== '') {
                try {
                    // Calculate the position for the header logo (top left corner, 25% of page width)
                    const logoWidth = pageWidth * 0.25; // 25% of page width
                    const logoX = margin; // Position from left margin
                    const logoY = 15; // Position from top
                    
                    // Determine image format based on file extension
                    let format = 'JPEG'; // Default format
                    if (logo_header.toLowerCase().endsWith('.png')) {
                        format = 'PNG';
                    } else if (logo_header.toLowerCase().endsWith('.jpg') || logo_header.toLowerCase().endsWith('.jpeg')) {
                        format = 'JPEG';
                    } else if (logo_header.toLowerCase().endsWith('.gif')) {
                        format = 'GIF';
                    }
                    
                    // Add the header logo to the document with 25% page width, auto height for aspect ratio
                    doc.addImage(logo_header, format, logoX, logoY, logoWidth, 0); // width=25% of page, height=auto
                    
                    // Adjust starting position for text content if header logo is present
                    // Make sure text doesn't overlap with the logo
                    // This is handled in the text positioning below
                } catch (e) {
                    console.log("Error adding header logo:", e.message);
                    
                    // Fallback: try adding with fixed dimensions if percentage approach fails
                    try {
                        const logoWidth = pageWidth * 0.25; // 25% of page width
                        const logoHeight = 25; // Fixed height for logo
                        const logoX = margin; // Position from left margin
                        const logoY = 15; // Position from top
                        
                        doc.addImage(logo_header, logoX, logoY, logoWidth, logoHeight);
                    } catch (fallbackError) {
                        console.log("Fallback also failed for header logo:", fallbackError.message);
                    }
                }
            }
            
            // Add centered title - moved down and with more space
            doc.setFontSize(16);
            doc.setFont('times', 'bold');
            doc.text("ATTESTATION D’INSCRIPTION", pageWidth / 2, 60, { align: 'center' }); // Moved from 40 to 60
            doc.setFont('times', 'normal');
            doc.setFontSize(12);
            
            // Add attestation content aligned to the left
            let currentY = 80; // Increased from 60 to 80 to add more space after title
            doc.setFont('times', 'normal');
            
            // Add some space if header logo was present
            if(logo_header && logo_header.trim() !== '') {
                currentY = 85; // Adjust starting position if logo was added, with more space
            }
            
            // Main text - ensure it doesn't exceed margins
            var headerText = "Nous soussignés, " + institutionName + " attestons que l'apprenant(e) :";
            var wrappedHeader = doc.splitTextToSize(headerText, textWidth);
            doc.text(wrappedHeader, margin, currentY);
            
            // Update currentY based on the number of lines
            currentY += wrappedHeader.length * 6;
            currentY += 5; // Additional space
            
            // Student name in bold - ensure it doesn't exceed margins
            var completeStudentName = studentNom.toUpperCase() + " " + studentPrenom.toUpperCase();
            var wrappedStudentName = doc.splitTextToSize(completeStudentName, textWidth);
            doc.setFont('times', 'bold');
            doc.text(wrappedStudentName, margin, currentY);
            doc.setFont('times', 'normal');
            currentY += wrappedStudentName.length * 6; // Adjust for potential multi-line
            
            // Birth information - ensure it doesn't exceed margins
            var birthInfo = "Né(e) le " + studentDateNaissance + " à " + studentLieuNaissance;
            var wrappedBirthInfo = doc.splitTextToSize(birthInfo, textWidth);
            doc.text(wrappedBirthInfo, margin, currentY);
            currentY += wrappedBirthInfo.length * 6; // Adjust for potential multi-line
            
            // Following program information - ensure it doesn't exceed margins
            var programInfo = "Est inscrit(e) au sein de notre école pour suivre un programme de formation en vue de l'obtention du diplôme de " + formation;
            var wrappedProgramInfo = doc.splitTextToSize(programInfo, textWidth);
            doc.text(wrappedProgramInfo, margin, currentY);
            currentY += wrappedProgramInfo.length * 6; // Adjust for potential multi-line
            
            // Speciality - using the JavaScript variable that was defined - ensure it doesn't exceed margins
            var specialiteText = "Spécialité : " + specialite;
            var wrappedSpecialite = doc.splitTextToSize(specialiteText, textWidth);
            doc.text(wrappedSpecialite, margin, currentY);
            currentY += wrappedSpecialite.length * 6; // Adjust for potential multi-line
            
            // Academic year - ensure it doesn't exceed margins
            var yearInfo = "Pour l’année académique : " + anneeScolaire;
            var wrappedYearInfo = doc.splitTextToSize(yearInfo, textWidth);
            doc.text(wrappedYearInfo, margin, currentY);
            currentY += wrappedYearInfo.length * 6; // Adjust for potential multi-line
            currentY += 12; // Additional spacing
            
            // Main statement - ensure it doesn't exceed margins
            var statementText = "La présente attestation est délivrée à l’intéressé(e), sur sa demande, pour servir et valoir ce que de droit.";
            var wrappedStatement = doc.splitTextToSize(statementText, textWidth);
            doc.text(wrappedStatement, margin, currentY);
            
            // Update currentY based on the number of lines
            currentY += wrappedStatement.length * 6;
            currentY += 15; // Additional space
            
            // Add footer logo if available
            if(logo_footer && logo_footer.trim() !== '') {
                try {
                    // Calculate the position for the footer logo (bottom centered)
                    const margin = 20; // Using same margin as defined at beginning of function
                    const logoWidth = pageWidth - (2 * margin); // Use full page width minus margins
                    const logoX = margin; // Position at left margin
                    const logoY = 265; // Position slightly higher to accommodate larger image
                    
                    // Determine image format based on file extension
                    let format = 'JPEG'; // Default format
                    if (logo_footer.toLowerCase().endsWith('.png')) {
                        format = 'PNG';
                    } else if (logo_footer.toLowerCase().endsWith('.jpg') || logo_footer.toLowerCase().endsWith('.jpeg')) {
                        format = 'JPEG';
                    } else if (logo_footer.toLowerCase().endsWith('.gif')) {
                        format = 'GIF';
                    }
                    
                    // Add the footer logo to the document, using almost full page width
                    // Use calculated width and let height adjust automatically to maintain aspect ratio
                    doc.addImage(logo_footer, format, logoX, logoY, logoWidth, 0); // width=calculated, height=0 means auto height
                    
                    // The actual height will be calculated automatically to maintain aspect ratio
                    // For signature positioning, we'll use a more conservative approach
                    // Since logo might be tall, we'll add more space below
                    currentY = logoY + 40; // Position considering potentially taller logo
                } catch (e) {
                    console.log("Error adding footer logo:", e.message);
                    
                    // Fallback: try adding with fixed dimensions if original size approach fails
                    try {
                        const margin = 20;
                        const logoWidth = pageWidth - (2 * margin); // Use full page width minus margins
                        const logoHeight = 35; // Fixed height for logo 
                        const logoX = margin; // Position at left margin
                        const logoY = 265; // Near bottom of page
                        
                        doc.addImage(logo_footer, logoX, logoY, logoWidth, logoHeight);
                        
                        // Adjust the signature position if footer logo is present
                        currentY = logoY + logoHeight + 10; // Position signature below the footer logo
                    } catch (fallbackError) {
                        console.log("Fallback also failed for footer logo:", fallbackError.message);
                    }
                }
            }
            
            // Date and location (right aligned) - ensure it's properly positioned
            var currentDate = new Date();
            var formattedDate = currentDate.getDate().toString().padStart(2, '0') + '/' + 
                               (currentDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                               currentDate.getFullYear();
            var locationDateText = ville + ", le " + formattedDate;
            var textLineWidth = doc.getTextWidth(locationDateText);
            var rightMargin = pageWidth - margin;
            doc.text(locationDateText, rightMargin - textLineWidth, currentY);
            
            // Director signature (centered at the bottom)
            currentY += 20;
            doc.text("Le Directeur", pageWidth / 2, currentY, { align: 'center' });
        }
        
        // Function to filter students table
        function filterStudentsTable() {
            var filterNom = $('#filterNom').val().toLowerCase();
            var filterPrenom = $('#filterPrenom').val().toLowerCase();
            var filterStatus = $('#filterStatus').val().toLowerCase();

            $('#studentsTable tbody tr').each(function() {
                var row = $(this);
                var fullName = row.find('td:eq(0)').text().toLowerCase(); // Nom & Prénom column
                var status = row.find('td:eq(4)').text().toLowerCase(); // Status column

                // Check if the full name contains the nom filter
                var nomMatch = filterNom === '' || fullName.includes(filterNom);
                // Check if the full name contains the prenom filter
                var prenomMatch = filterPrenom === '' || fullName.includes(filterPrenom);
                // Check if status matches
                var statusMatch = filterStatus === '' || status.includes(filterStatus);

                if (nomMatch && prenomMatch && statusMatch) {
                    row.show();
                } else {
                    row.hide();
                }
            });
        }

        // Event listeners for filter inputs
        $('#filterNom').on('keyup', filterStudentsTable);
        $('#filterPrenom').on('keyup', filterStudentsTable);
        $('#filterStatus').on('change', filterStudentsTable);
    
    
    });



</script>

{% endblock content %}
           



    