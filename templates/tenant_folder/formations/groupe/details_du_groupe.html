{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Groupes - Détails du groupe {% endblock title %}

{% block content %}

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #3b7ddd 0%, #2f5c9e 100%);
        --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        --hover-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    /* Hero Section */
    .hero-header {
        background: var(--primary-gradient);
        color: white;
        border-radius: 1rem;
        padding: 2.5rem 2rem;
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
        box-shadow: var(--hover-shadow);
    }
    
    .hero-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: url('{% static "img/photos/pattern.png" %}') center/cover;
        opacity: 0.1;
    }

    .hero-content {
        position: relative;
        z-index: 1;
    }

    /* Stats Cards */
    .stat-card {
        border: none;
        border-radius: 1rem;
        box-shadow: var(--card-shadow);
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        background: white;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    /* Modern Tabs */
    .nav-tabs-custom {
        border-bottom: 2px solid #e9ecef;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        position: relative;
    }
    
    .nav-tabs-custom .nav-link.active {
        color: #3b7ddd;
        background: transparent;
    }
    
    .nav-tabs-custom .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #3b7ddd;
    }

    /* Enhanced Table */
    .table-modern thead th {
        border-top: none;
        border-bottom: 2px solid #e9ecef;
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        color: #939ba2;
        padding: 1rem;
    }
    
    .table-modern tbody td {
        padding: 1rem;
        vertical-align: middle;
    }

    .avatar-initials {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    /* Document Actions */
    .doc-action-card {
        border: 1px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.2s;
        text-align: center;
        height: 100%;
        cursor: pointer;
    }
    
    .doc-action-card:hover {
        border-color: #3b7ddd;
        background-color: #f8f9fa;
        transform: translateY(-2px);
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">

            <!-- Hero Section -->
            <div class="hero-header d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4">
                <div class="hero-content">
                    <nav aria-label="breadcrumb" class="mb-2">
                        <ol class="breadcrumb m-0 bg-transparent p-0">
                            <li class="breadcrumb-item text-white-50"><a href="javascript: void(0);" class="text-white-50">Scolarité</a></li>
                            <li class="breadcrumb-item active text-white" aria-current="page">Détails du groupe</li>
                        </ol>
                    </nav>
                    <h2 class="text-white fw-bold mb-2">{{groupe.nom}}</h2>
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="badge bg-white bg-opacity-25 text-white border border-white border-opacity-25">
                            <i class="ri-calendar-line me-1"></i> {{groupe.annee_scolaire}}
                        </span>
                        <span class="badge bg-white bg-opacity-25 text-white border border-white border-opacity-25">
                            <i class="ri-book-mark-line me-1"></i> {{groupe.specialite}}
                        </span>
                        {% if groupe.etat == "brouillon" %}   
                            <span class="badge bg-secondary text-white"><i class="ri-pencil-line me-1"></i> {{groupe.get_etat_display}}</span>
                        {% elif groupe.etat == "enc" %}
                            <span class="badge bg-info text-white"><i class="ri-loader-4-line me-1"></i> {{groupe.get_etat_display}}</span>
                        {% elif groupe.etat == "valider" %}
                            <span class="badge bg-success text-white"><i class="ri-check-double-line me-1"></i> {{groupe.get_etat_display}}</span>
                        {% elif groupe.etat == "archive" %}
                            <span class="badge bg-dark text-white"><i class="ri-archive-line me-1"></i> {{groupe.get_etat_display}}</span>
                        {% else %}
                            <span class="badge bg-secondary text-white">{{groupe.get_etat_display}}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="ri-printer-line me-1"></i> Impression Rapide
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkPrintModal"><i class="ri-pages-line me-2"></i> Impression par lot</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#certificatScolariteModal"><i class="ri-file-paper-2-line me-2"></i> Certificat de scolarité</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#attestationInscriptionModal"><i class="ri-file-text-line me-2"></i> Attestation d'inscription</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-6 col-xl-3">
                    <div class="stat-card p-3 d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                            <i class="ri-group-line"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small text-uppercase fw-semibold">Étudiants Inscrits</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{students.count}} <span class="text-muted fs-6 fw-normal">/ {{groupe.max_student}}</span></h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="stat-card p-3 d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                            <i class="ri-calendar-check-line"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small text-uppercase fw-semibold">Date de Début</h6>
                            <h5 class="mb-0 fw-bold text-dark">{{groupe.start_date}}</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="stat-card p-3 d-flex align-items-center">
                        <div class="stat-icon bg-danger bg-opacity-10 text-danger me-3">
                            <i class="ri-flag-line"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small text-uppercase fw-semibold">Date de Fin</h6>
                            <h5 class="mb-0 fw-bold text-dark">{{groupe.end_date}}</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="stat-card p-3 d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                            <i class="ri-building-line"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small text-uppercase fw-semibold">Session</h6>
                            <h5 class="mb-0 fw-bold text-dark">{{groupe.promotion.get_session_display}}</h5>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="card shadow border-0 rounded-3 mb-4">
                <div class="card-header bg-white border-bottom px-4 pt-4 pb-0">
                    <ul class="nav nav-tabs nav-tabs-custom card-header-tabs" id="groupTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-selected="true">
                                <i class="ri-dashboard-line me-1"></i> Tableau de bord
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab" aria-selected="false">
                                <i class="ri-user-line me-1"></i> Étudiants ({{students.count}})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab" aria-selected="false">
                                <i class="ri-file-copy-2-line me-1"></i> Documents & Impression
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-selected="false">
                                <i class="ri-settings-3-line me-1"></i> Administration
                            </button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body p-4">
                    <div class="tab-content" id="groupTabsContent">
                        
                        <!-- Tab: Tableau de bord -->
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                            
                            <!-- Double Diplomation Alert -->
                            {% if double_students %}
                                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 d-flex align-items-center justify-content-between mb-4" role="alert">
                                    <div class="d-flex align-items-center">
                                        <i class="ri-error-warning-line text-info fs-4 me-3"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1 text-info">Information Double Diplomation</h6>
                                            <p class="mb-0 text-muted small">Ce groupe contient {{double_students|length}} étudiants en double diplomation.</p>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#doubleDiplomationModal">
                                        <i class="ri-eye-line me-1"></i> Voir la liste
                                    </button>
                                </div>
                            {% endif %}
                            
                            <h5 class="fw-bold mb-4">Informations Générales</h5>
                            <div class="row g-4 informations-generales">
                                <div class="col-lg-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <label class="form-label text-muted small text-uppercase fw-semibold mb-1">Nom du groupe</label>
                                        <div class="fw-bold text-dark fs-6">{{groupe.nom}}</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <label class="form-label text-muted small text-uppercase fw-semibold mb-1">Spécialité</label>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="fw-bold text-dark fs-6">{{groupe.specialite}}</div>
                                            <button class="btn btn-sm btn-soft-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#specialiteModel">
                                                <i class="ri-information-line"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <label class="form-label text-muted small text-uppercase fw-semibold mb-1">Promotion</label>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="fw-bold text-dark fs-6">{{groupe.promotion.code}}</div>
                                            <button class="btn btn-sm btn-soft-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#promotionDetailsModal">
                                                <i class="ri-information-line"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <label class="form-label text-muted small text-uppercase fw-semibold mb-1">Code Partenaire</label>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div id="partnerCodeDisplay" class="fw-bold text-dark fs-6">{{groupe.code_partenaire}}</div>
                                            <button class="btn btn-sm btn-soft-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#editPartnerCodeModal">
                                                <i class="ri-pencil-line"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <label class="form-label text-muted small text-uppercase fw-semibold mb-1">Min. Inscrits</label>
                                        <div class="fw-bold text-dark fs-6">{{groupe.min_student}}</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <label class="form-label text-muted small text-uppercase fw-semibold mb-1">Max. Inscrits</label>
                                        <div class="fw-bold text-dark fs-6">{{groupe.max_student}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Étudiants -->
                        <div class="tab-pane fade" id="students" role="tabpanel" aria-labelledby="students-tab">
                            <!-- Filters -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="ri-search-line"></i></span>
                                        <input type="text" id="filterNom" class="form-control border-start-0 ps-0 text-muted" placeholder="Rechercher par nom...">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="ri-search-line"></i></span>
                                        <input type="text" id="filterPrenom" class="form-control border-start-0 ps-0 text-muted" placeholder="Rechercher par prénom...">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <select id="filterStatus" class="form-select">
                                        <option value="">Tous les statuts</option>
                                        <option value="Prospect">Prospect</option>
                                        <option value="Étudiant">Étudiant</option>
                                        <option value="Ancien">Ancien</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="table-responsive">
                                <table class="table table-modern align-middle mb-0" id="studentsTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Étudiant</th>
                                            <th class="border-0">Email</th>
                                            <th class="border-0">Téléphone</th>
                                            <th class="border-0">Date d'inscription</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0">Formation</th>
                                            <th class="border-0 text-end rounded-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if students.count != 0 %}
                                            {% for i in students %}
                                                <tr> 
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            {% if i.student.photo %}
                                                                <img src="{{ i.student.photo.url }}" alt="" class="avatar-initials me-3">
                                                            {% else %}
                                                                <div class="avatar-initials bg-soft-primary text-primary me-3">
                                                                    {{ i.student.nom|first }}{{ i.student.prenom|first }}
                                                                </div>
                                                            {% endif %}
                                                            <div>
                                                                <h6 class="mb-0 fw-bold">{{i.student.nom}} {{i.student.prenom}}</h6>
                                                                <small class="text-muted">{{i.student.matricule_interne|default:"-"}}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{i.student.email}}</td>
                                                    <td>{{i.student.telephone}}</td>
                                                    <td>{{i.date_inscription|date:"d M Y"}}</td>
                                                    <td>
                                                        <span class="badge bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill">{{i.student.get_statut_display}}</span>
                                                    </td>
                                                    <td>
                                                        {% if i.student.is_double %}
                                                            <span class="badge bg-warning bg-opacity-10 text-warning px-2 py-1"><i class="ri-share-forward-fill me-1"></i> Double</span>
                                                        {% else %}
                                                            <span class="text-muted small">Standard</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        <a href="{% url 't_groupe:StudentDetails' pk=i.student.id %}" class="btn btn-sm btn-soft-secondary" title="Voir le profil">
                                                            <i class="ri-eye-line"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr><td colspan="7" class="text-center py-5">
                                                <div class="empty-state">
                                                    <div class="avatar-lg bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                                                        <i class="ri-user-add-line fs-1 text-muted"></i>
                                                    </div>
                                                    <h5 class="text-muted">Aucun étudiant trouvé</h5>
                                                    <p class="text-muted small mb-0">Ce groupe n'a pas encore d'étudiants inscrits.</p>
                                                </div>
                                            </td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab: Documents -->
                        <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                            <h5 class="fw-bold mb-4">Centre de documentation</h5>
                            <div class="row g-4">
                                <div class="col-md-6 col-lg-3">
                                    <div class="doc-action-card" data-bs-toggle="modal" data-bs-target="#certificatScolariteModal">
                                        <div class="avatar-md bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                                            <i class="ri-file-paper-2-line fs-3"></i>
                                        </div>
                                        <h6 class="fw-semibold mb-2">Certificat de Scolarité</h6>
                                        <p class="text-muted small mb-0">Générer les certificats pour un ou plusieurs étudiants.</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="doc-action-card" data-bs-toggle="modal" data-bs-target="#attestationInscriptionModal">
                                        <div class="avatar-md bg-info bg-opacity-10 text-info rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                                            <i class="ri-file-text-line fs-3"></i>
                                        </div>
                                        <h6 class="fw-semibold mb-2">Attestation d'inscription</h6>
                                        <p class="text-muted small mb-0">Preuve d'inscription officielle.</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="doc-action-card" data-bs-toggle="modal" data-bs-target="#certificatAdmissionModal">
                                        <div class="avatar-md bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                                            <i class="ri-file-2-line fs-3"></i>
                                        </div>
                                        <h6 class="fw-semibold mb-2">Certificat d'admission</h6>
                                        <p class="text-muted small mb-0">Document d'admission initiale.</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="doc-action-card" data-bs-toggle="modal" data-bs-target="#contratsModal">
                                        <div class="avatar-md bg-warning bg-opacity-10 text-warning rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                                            <i class="ri-file-3-line fs-3"></i>
                                        </div>
                                        <h6 class="fw-semibold mb-2">Contrats Étudiants</h6>
                                        <p class="text-muted small mb-0">Génération des contrats de formation.</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="doc-action-card" data-bs-toggle="modal" data-bs-target="#bulkPrintModal">
                                        <div class="avatar-md bg-dark bg-opacity-10 text-dark rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                                            <i class="ri-printer-line fs-3"></i>
                                        </div>
                                        <h6 class="fw-semibold mb-2">Impression par lot</h6>
                                        <p class="text-muted small mb-0">Impression groupée avec le PDF Editor.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Administration -->
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <h5 class="fw-bold mb-4">Actions Administratives</h5>
                            <div class="alert alert-light border shadow-sm p-4">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        {% if groupe.etat == "brouillon" %}
                                            <h6 class="fw-bold text-primary">État actuel : Brouillon</h6>
                                            <p class="text-muted small mb-0">Le groupe est en cours de création. Vous pouvez le modifier ou lancer les inscriptions.</p>
                                        {% elif groupe.etat == "inscription" %}
                                            <h6 class="fw-bold text-success">État actuel : Inscriptions Ouvertes</h6>
                                            <p class="text-muted small mb-0">Le groupe accepte actuellement de nouvelles inscriptions.</p>
                                        {% else %}
                                            <h6 class="fw-bold text-dark">État actuel : {{groupe.get_etat_display}}</h6>
                                            <p class="text-muted small mb-0">Gérez le cycle de vie du groupe ici.</p>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex gap-2">
                                        {% if groupe.etat == "brouillon" %}
                                            <a href="{% url 't_groupe:UpdateGroupe' groupe.id %}" class="btn btn-outline-primary" id="_updateGroupeBtn">
                                                <i class="ri-pencil-line me-1"></i> Modifier
                                            </a>
                                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmStartRegistrationModal">
                                                <i class="ri-check-line me-1"></i> Lancer les inscriptions
                                            </button>
                                        {% endif %}
                                        
                                        {% if groupe.etat == "valider" %}
                                            <a href="{% url 't_groupe:makeGroupeBrouillon' groupe.id %}" class="btn btn-warning" id="_updateGroupeBtn">
                                                <i class="ri-edit-line me-1"></i> Revenir en Brouillon
                                            </a>
                                        {% endif %}
                                        
                                        {% if groupe.etat == "inscription" %}
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmCloseGroupModal">
                                                <i class="ri-lock-line me-1"></i> Clôturer les inscriptions
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>
<!-- end main content-->


<div id="specialiteModel" class="modal fade" tabindex="-1" aria-labelledby="specialiteModelLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-information-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="specialiteModelLabel">
                            Détails de la spécialité
                        </h5>
                        <p class="text-muted small mb-0">Informations sur la spécialité sélectionnée</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <input type="hidden" id="_id_module" disabled />
                    <div class="col-lg-12 mb-3">
                        <label for="u_label" class="form-label">Label :</label>
                        <input disabled type="text" class="form-control" id="u_label" value="{{specialite.code}}-{{specialite.label}}" />
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label for="u_code_module" class="form-label">Niveau :</label>
                        <input disabled type="text" class="form-control" id="u_code_module" value="{{specialite.condition_access}}"/>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label for="u_coef" class="form-label">Version du programme :</label>
                        <input disabled type="text" class="form-control" id="u_coef" value="{{specialite.version}} " />
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button class="btn btn-primary px-4" id="ConfirmUpdateBtn">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal for Double Diplomation Students -->
<div class="modal fade" id="doubleDiplomationModal" tabindex="-1" aria-labelledby="doubleDiplomationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-group-2-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="doubleDiplomationModalLabel">
                            Étudiants en Double Diplomation
                        </h5>
                        <p class="text-muted small mb-0">Liste des étudiants inscrits en double diplomation dans ce groupe</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 rounded-start">Nom & Prénom</th>
                                <th class="border-0">Email</th>
                                <th class="border-0">Téléphone</th>
                                <th class="border-0 text-end rounded-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ds in double_students %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if ds.student.photo %}
                                                <img src="{{ ds.student.photo.url }}" alt="" class="avatar-sm rounded-circle me-2">
                                            {% else %}
                                                <div class="avatar-sm bg-light rounded-circle me-2 d-flex align-items-center justify-content-center text-primary fw-bold">
                                                    {{ ds.student.nom|first }}{{ ds.student.prenom|first }}
                                                </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ ds.student.nom }} {{ ds.student.prenom }}</h6>
                                                <small class="text-muted">{{ ds.student.matricule_interne|default:"" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ ds.student.email }}</td>
                                    <td>{{ ds.student.telephone }}</td>
                                    <td class="text-end">
                                        <a href="{% url 't_groupe:StudentDetails' pk=ds.student.id %}" class="btn btn-sm btn-soft-primary" target="_blank">
                                            <i class="ri-eye-line"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        Aucun étudiant trouvé
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for confirming start of registrations -->
<div class="modal fade" id="confirmStartRegistrationModal" tabindex="-1" aria-labelledby="confirmStartRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmStartRegistrationModalLabel">
                            Confirmer le démarrage des inscriptions
                        </h5>
                        <p class="text-muted small mb-0">Validation du groupe pour début des inscriptions</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-alert-line text-warning fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Attention !</h6>
                            <p class="mb-0">Vous êtes sur le point de valider ce groupe et d'autoriser le début des inscriptions.</p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-lock-line text-info fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Une fois le début des inscriptions autorisé, il ne sera plus possible de modifier les informations du groupe.</p>
                        </div>
                    </div>
                </div>
                
                <p>En validant ce groupe, vous confirmez que toutes les informations sont correctes et que le groupe est prêt à recevoir des inscriptions.</p>
                
                <div class="d-flex align-items-center p-3 bg-light rounded-3">
                    <i class="ri-information-line text-primary fs-5 me-3"></i>
                    <div>
                        <h6 class="mb-1">Détails du groupe</h6>
                        <p class="mb-0 small text-muted">Nom : <strong>{{groupe.nom}}</strong> | Spécialité : <strong>{{groupe.specialite}}</strong></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button id="btnConfirmeBeginInscription" type="button" class="btn btn-success px-4" >Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for showing promotion details -->
<div class="modal fade" id="promotionDetailsModal" tabindex="-1" aria-labelledby="promotionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-2-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="promotionDetailsModalLabel">
                            Détails de la promotion
                        </h5>
                        <p class="text-muted small mb-0">Informations sur la promotion sélectionnée</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Code :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.code}}</div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Session :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.get_session_display}}</div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Date de début :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.date_debut}}</div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <label class="form-label fw-semibold">Date de fin :</label>
                        <div class="form-control bg-light border-0">{{groupe.promotion.date_fin}}</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for confirming group closure -->
<div class="modal fade" id="confirmCloseGroupModal" tabindex="-1" aria-labelledby="confirmCloseGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-lock-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="confirmCloseGroupModalLabel">
                            Confirmer la clôture du groupe
                        </h5>
                        <p class="text-muted small mb-0">Fermeture du groupe pour de nouvelles inscriptions</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-alert-line text-warning fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Attention !</h6>
                            <p class="mb-0">Vous êtes sur le point de clôturer ce groupe.</p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-user-unfollow-line text-info fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Une fois le groupe clôturé, il ne sera plus possible d'inscrire de nouveaux étudiants à ce groupe.</p>
                        </div>
                    </div>
                </div>
                
                <p>En clôturant ce groupe, vous confirmez que le nombre d'inscrits est final et que le groupe est prêt à commencer officiellement.</p>
                
                <div class="d-flex align-items-center p-3 bg-light rounded-3">
                    <i class="ri-information-line text-primary fs-5 me-3"></i>
                    <div>
                        <h6 class="mb-1">Détails du groupe</h6>
                        <p class="mb-0 small text-muted">Nom : <strong>{{groupe.nom}}</strong> | Spécialité : <strong>{{groupe.specialite}}</strong> | Étudiants inscrits : <strong>{{students.count}}</strong></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button id="btnConfirmeCloseGroup" type="submit" class="btn btn-danger px-4">Confirmer</button>
                    
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function(){


        // Handle button events
        $(document).on('click','#btnConfirmeBeginInscription', function(){
            window.location = "{% url 't_groupe:validateGroupe' pk=groupe.id %}";
        });
        
        $(document).on('click','#btnConfirmeCloseGroup', function(){
            window.location = "{% url 't_groupe:closeGroupe' pk=groupe.id %}";
        });

        
        // Handle partner code update
        $(document).on('click', '#savePartnerCodeBtn', function() {
            var newCode = $('#partnerCodeInput').val().trim();
            var $errorDiv = $('#partnerCodeError');
            
            // Clear previous errors
            $errorDiv.hide();
            
            // Basic validation
            if (!newCode) {
                $errorDiv.text('Le code partenaire ne peut pas être vide.').show();
                return;
            }
            
            // Disable the button while processing
            var originalBtnText = $('#savePartnerCodeBtn').html();
            $('#savePartnerCodeBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
            
            // Send AJAX request to update the partner code
            $.ajax({
                url: '{% url "t_groupe:ApiUpdateGroupeCode" %}',  // API endpoint for updating partner code
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'code_partenaire': newCode,
                    'groupeId' : '{{groupe.id}}',
                },
                success: function(response) {
                    if(response.status == "success") {
                        // Update the displayed value
                        $('#partnerCodeDisplay').text(newCode);
                        
                        // Update the input field in the modal too
                        $('#partnerCodeInput').val(newCode);
                        
                        // Show success message
                        alertify.success(response.message);
                        
                        // Close the modal
                        $('#editPartnerCodeModal').modal('hide');
                    } else {
                        $errorDiv.text(response.message || 'Une erreur est survenue lors de la mise à jour.').show();
                    }
                },
                error: function(xhr, status, error) {
                    var errorMessage = 'Une erreur est survenue lors de la mise à jour.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    $errorDiv.text(errorMessage).show();
                },
                complete: function() {
                    // Re-enable the button
                    $('#savePartnerCodeBtn').prop('disabled', false).html(originalBtnText);
                }
            });
        });
    });

    
</script>

<!-- Modal for certificat de scolarité -->
<div class="modal fade" id="certificatScolariteModal" tabindex="-1" aria-labelledby="certificatScolariteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-paper-2-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="certificatScolariteModalLabel">
                            Sélection des étudiants pour le certificat de scolarité
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer le certificat</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer le certificat de scolarité.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="studentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllStudents">
                        <label class="form-check-label" for="selectAllStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="selectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} {{student_line.student.lieu_naissance}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedStudents" id="student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success px-4" id="generateCertificatBtn">Générer les certificats</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing partner code -->
<div class="modal fade" id="editPartnerCodeModal" tabindex="-1" aria-labelledby="editPartnerCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-pencil-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="editPartnerCodeModalLabel">
                            Modifier le code partenaire
                        </h5>
                        <p class="text-muted small mb-0">Mettre à jour le code partenaire du groupe</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Le code partenaire doit être fourni par le partenaire concerné. Veuillez vous assurer d'avoir reçu ce code avant de le renseigner.</p>
                        </div>
                    </div>
                </div>
                
                <form id="editPartnerCodeForm">
                    <div class="mb-3">
                        <label for="partnerCodeInput" class="form-label">Code partenaire</label>
                        <input type="text" class="form-control" id="partnerCodeInput" name="code_partenaire" value="{{groupe.code_partenaire}}" placeholder="Entrez le code partenaire">
                        <div id="partnerCodeError" class="text-danger mt-1" style="display: none;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary px-4" id="savePartnerCodeBtn">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for contrats -->
<div class="modal fade" id="contratsModal" tabindex="-1" aria-labelledby="contratsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-xl border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-3-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="contratsModalLabel">
                            Sélection des contrats à imprimer
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez le modèle de contrat et les étudiants pour lesquels vous souhaitez imprimer les contrats</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Alert for automatic contract loading -->
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Contrat automatique</h6>
                            <p class="mb-0">Le modèle de contrat sera automatiquement sélectionné en fonction de la formation du groupe.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden field to store the contract model ID -->
                <input type="hidden" id="contratModelId">
                
                <!-- Display for the automatically selected contract -->
                <div class="mb-3">
                    <label class="form-label fw-medium">Modèle de contrat sélectionné</label>
                    <div class="form-control bg-light border-0" id="selectedContractDisplay">
                        Chargement en cours...
                    </div>
                    <div id="contratModelError" class="text-danger mt-1" style="display: none;"></div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="contratStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox and counter -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllContratStudents">
                        <label class="form-check-label" for="selectAllContratStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="contratSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Type cursus</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="contratsStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td>{{student_line.student.is_double}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedContratStudents" id="contrat_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary px-4" id="generateContratsBtn">Générer les contrats</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for school certificate -->
<div class="modal fade" id="certificatScolariteModal" tabindex="-1" aria-labelledby="certificatScolariteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-paper-2-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="certificatScolariteModalLabel">
                            Sélection des étudiants pour le certificat de scolarité
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer le certificat de scolarité</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer le certificat de scolarité.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="scolariteStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllScolariteStudents">
                        <label class="form-check-label" for="selectAllScolariteStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="scolariteSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="scolariteStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedScolariteStudents" id="scolarite_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success px-4" id="generateCertificatScolariteBtn">Générer les certificats</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="attestationInscriptionModal" tabindex="-1" aria-labelledby="attestationInscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-text-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="attestationInscriptionModalLabel">
                            Sélection des étudiants pour l'attestation d'inscription
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer l'attestation d'inscription</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer l'attestation d'inscription.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="attestationStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>
                
                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllAttestationStudents">
                        <label class="form-check-label" for="selectAllAttestationStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="attestationSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>
                
                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="attestationStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedAttestationStudents" id="attestation_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success px-4" id="generateAttestationBtn">Générer les attestations</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for admission certificate -->
<div class="modal fade" id="certificatAdmissionModal" tabindex="-1" aria-labelledby="certificatAdmissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-2-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="certificatAdmissionModalLabel">
                            Sélection des étudiants pour le certificat d'admission
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez imprimer le certificat d'admission</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="ri-information-line text-info fs-5 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Information importante</h6>
                            <p class="mb-0">Sélectionnez les étudiants pour lesquels vous souhaitez générer le certificat d'admission.</p>
                        </div>
                    </div>
                </div>

                <!-- Search bar for filtering students -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ri-search-line"></i></span>
                        <input type="text" class="form-control" id="admissionStudentSearch" placeholder="Rechercher un étudiant...">
                    </div>
                </div>

                <!-- Select all checkbox -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllAdmissionStudents">
                        <label class="form-check-label" for="selectAllAdmissionStudents">Tout sélectionner</label>
                    </div>
                    <span class="text-muted"><span id="admissionSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                </div>

                <!-- Students list with checkboxes -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white top-0 shadow-sm">
                            <tr>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Date / lieu de naissance</th>
                                <th>Adresse</th>
                                <th>Sélectionner</th>
                            </tr>
                        </thead>
                        <tbody id="admissionStudentsTableBody">
                            {% for student_line in students %}
                            <tr>
                                <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                <td>{{student_line.student.email}}</td>
                                <td>{{student_line.student.date_naissance}} à {{student_line.student.lieu_naissance}}</td>
                                <td>{{student_line.student.adresse}} - {{student_line.student.wilaya}} {{student_line.student.pays}}</td>
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedAdmissionStudents" id="admission_student_{{student_line.student.id}}">
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Aucun étudiant inscrit dans ce groupe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-info px-4" id="generateAdmissionBtn">Générer les certificats</button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- PDF Preview Modal -->
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom-0 bg-light">
                <h5 class="modal-title">Aperçu du document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 bg-secondary bg-opacity-10">
                <div id="pdfPreviewContainer" class="p-0 d-flex justify-content-center align-items-center" style="min-height: 400px; height: 100%;">
                    <!-- Content injected here -->
                </div>
            </div>
            <div class="modal-footer border-top-0 bg-white">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
                <a href="#" id="downloadPdfBtn" class="btn btn-primary disabled">
                    <i class="ri-download-line me-1"></i> Télécharger le PDF
                </a>
            </div>
        </div>
    </div>
</div>
<!-- Modal for Bulk Print (PDF Editor) -->
<div class="modal fade" id="bulkPrintModal" tabindex="-1" aria-labelledby="bulkPrintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-printer-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="bulkPrintModalLabel">
                            Impression groupée (PDF Editor)
                        </h5>
                        <p class="text-muted small mb-0">Sélectionnez les étudiants et le modèle à imprimer</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="bulkPrintForm" method="POST" action="{% url 't_groupe:generate_group_students_pdf' %}">
                    {% csrf_token %}
                    <input type="hidden" name="student_ids" id="bulkPrintStudentIds">
                    <input type="hidden" name="group_id" value="{{groupe.id}}">
                    
                    <div class="mb-4">
                        <label for="templateSelect" class="form-label fw-semibold">Modèle de document</label>
                        <select class="form-select" id="templateSelect" name="template_slug" required>
                            <option value="" selected disabled>Choisir un modèle...</option>
                            {% for t in active_templates %}
                                <option value="{{ t.slug }}">{{ t.title }} ({{ t.get_template_type_display }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 mb-3" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="ri-information-line text-info fs-5 me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Sélection des étudiants</h6>
                                <p class="mb-0">Cochez les étudiants pour lesquels générer le document.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search bar -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="ri-search-line"></i></span>
                            <input type="text" class="form-control" id="bulkPrintStudentSearch" placeholder="Rechercher un étudiant...">
                        </div>
                    </div>
                    
                    <!-- Select all checkbox -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllBulkPrintStudents">
                            <label class="form-check-label" for="selectAllBulkPrintStudents">Tout sélectionner</label>
                        </div>
                        <span class="text-muted"><span id="bulkPrintSelectedCount">0</span> sur {{students.count}} étudiants sélectionnés</span>
                    </div>
                    
                    <!-- Students list -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="sticky-top bg-white top-0 shadow-sm">
                                <tr>
                                    <th>Nom & Prénom</th>
                                    <th>Email</th>
                                    <th>Sélectionner</th>
                                </tr>
                            </thead>
                            <tbody id="bulkPrintStudentsTableBody">
                                {% for student_line in students %}
                                <tr>
                                    <td>{{student_line.student.nom}} {{student_line.student.prenom}}</td>
                                    <td>{{student_line.student.email}}</td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" value="{{student_line.student.id}}" name="selectedBulkPrintStudents" id="bulk_print_student_{{student_line.student.id}}">
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">Aucun étudiant inscrit</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary px-4" id="generateBulkPrintBtn">Générer PDF</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Bulk Print Logic within this scope
        const selectAllCheckbox = document.getElementById('selectAllBulkPrintStudents');
        const studentCheckboxes = document.getElementsByName('selectedBulkPrintStudents');
        const selectedCountSpan = document.getElementById('bulkPrintSelectedCount');
        const searchInput = document.getElementById('bulkPrintStudentSearch');
        const generateBtn = document.getElementById('generateBulkPrintBtn');
        const form = document.getElementById('bulkPrintForm');
        const hiddenInputIds = document.getElementById('bulkPrintStudentIds');
        const templateSelect = document.getElementById('templateSelect');

        function updateCount() {
            const count = Array.from(studentCheckboxes).filter(cb => cb.checked).length;
            selectedCountSpan.textContent = count;
        }

        if(selectAllCheckbox){
            selectAllCheckbox.addEventListener('change', function() {
                Array.from(studentCheckboxes).forEach(cb => {
                    // Only check visible rows if filtering is active (optional refinement, here we check all)
                    cb.checked = this.checked;
                });
                updateCount();
            });
        }

        if(searchInput){
            searchInput.addEventListener('keyup', function() {
                const value = this.value.toLowerCase();
                const rows = document.querySelectorAll('#bulkPrintStudentsTableBody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(value) ? '' : 'none';
                });
            });
        }

        if(studentCheckboxes){
            studentCheckboxes.forEach(cb => {
                 cb.addEventListener('change', function() {
                     updateCount();
                     if (!this.checked && selectAllCheckbox.checked) {
                         selectAllCheckbox.checked = false;
                     }
                 });
            });
        }

        if(generateBtn){
            generateBtn.addEventListener('click', function() {
                const selectedIds = Array.from(studentCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => parseInt(cb.value));

                if (selectedIds.length === 0) {
                    alert("Veuillez sélectionner au moins un étudiant.");
                    return;
                }
                
                if (!templateSelect.value) {
                    alert("Veuillez sélectionner un modèle de document.");
                    return;
                }

                // Close the selection modal
                const bulkModal = bootstrap.Modal.getInstance(document.getElementById('bulkPrintModal'));
                bulkModal.hide();

                // Open the preview modal
                const pdfPreviewModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
                pdfPreviewModal.show();

                // Show loading state
                $('#pdfPreviewContainer').html(`
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Génération de l'aperçu PDF...</p>
                    </div>
                `);
                $('#downloadPdfBtn').addClass('disabled').attr('href', '#');

                // Prepare data
                const formData = new FormData();
                formData.append('student_ids', JSON.stringify(selectedIds));
                formData.append('template_slug', templateSelect.value);
                formData.append('group_id', '{{groupe.id}}');
                formData.append('modal', 'true'); // Flag for JSON response
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                // Send AJAX request
                $.ajax({
                    url: "{% url 't_groupe:generate_group_students_pdf' %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        // Use iframe to isolate styles
                        const iframe = document.createElement('iframe');
                        iframe.style.width = '100%';
                        iframe.style.height = '85vh';
                        iframe.style.border = 'none';
                        iframe.style.background = 'white';

                        $('#pdfPreviewContainer').empty().append(iframe);

                        // Write content to iframe
                        const doc = iframe.contentWindow.document;
                        doc.open();
                        doc.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <style>
                                    body { margin: 0; padding: 20px; background: #525659; display: flex; justify-content: center; }
                                    .page-container {
                                        background: white;
                                        box-shadow: 0 0 10px rgba(0,0,0,0.5);
                                        padding: 0; /* Let print CSS handle padding */
                                        width: 210mm; /* A4 width */
                                        min-height: 297mm; /* A4 height */
                                        box-sizing: border-box; 
                                        margin-bottom: 20px;
                                    }
                                    ${response.custom_css || ''}
                                </style>
                            </head>
                            <body>
                                <div class="page-container">
                                    ${response.preview_html}
                                </div>
                            </body>
                            </html>
                        `);
                        doc.close();

                        // Enable download button
                        if (response.download_url) {
                            $('#downloadPdfBtn').removeClass('disabled').attr('href', response.download_url);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Erreur:", error);
                        $('#pdfPreviewContainer').html(`
                            <div class="text-center text-danger">
                                <i class="ri-error-warning-line fs-1"></i>
                                <p class="mt-2">Erreur lors de la génération de l'aperçu.</p>
                                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="location.reload()">Réessayer</button>
                            </div>
                        `);
                    }
                });
            });
        }
    });
</script>


<script>
    $(document).ready(function(){
        
        var logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
        var logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";
        var logo_partenaire = "{{logo_partenaire}}";
        var branche = "{{branche}}";

        var formationId = "{{groupe.specialite.formation.id}}";
        var anneescolaire = "{{groupe.annee_scolaire}}";
        var adresse = "{{entreprise_details.adresse}}";
        var designation = "{{entreprise_details.designation}}";
        var ville = "{{entreprise_details.ville}}";
        var logo_partenaire = "{{logo_partenaire}}";


        var specialite = "{{groupe.specialite.label}}";
        var formation = "{{groupe.specialite.formation.nom}}";

        var frais_inscription = "{{frais_inscription}}";
        var montant_formation = "120000";
        var annee_academique ="2025/2026";
        var document_inscription = JSON.parse('{{dossier_inscription|default:"[]"|escapejs}}');

        var representant = "{{entreprise_details.representant}}";

        var logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
        var logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";

        var echeancier_line = JSON.parse('{{echeancier_line|default:"[]"|escapejs}}');
        var qualification = "{{qualification}}";

        var date_debut = "{{date_debut}}";
        var date_fin   = "{{date_fin}}";
        var branche = "{{branche}}";

        

        var specialite = "{{groupe.specialite.label}}";
        var formation = "{{groupe.specialite.formation.nom}}";
        var ville = "{{groupe.specialite.formation.entite_legal.ville}}";
        var frais_inscription = "{{frais_inscription}}";

        var logo_header = "{{groupe.specialite.formation.entite_legal.entete_logo}}";
        var logo_footer = "{{groupe.specialite.formation.entite_legal.pied_page_logo}}";

        // Duplicate echeancier declaration removed
        var qualification = "{{qualification}}";

        var date_debut = "{{date_debut}}";
        var date_fin   = "{{date_fin}}";
        var branche = "{{branche}}";

        // Update selected count
        function updateSelectedCount() {
            var selectedCount = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#attestationSelectedCount').text(selectedCount);
        }

        // Update admission selected count
        function updateAdmissionSelectedCount() {
            var selectedCount = $('input[name="selectedAdmissionStudents"]:checked').length;
            $('#admissionSelectedCount').text(selectedCount);
        }

        // Select all functionality for attestation modal
        $('#selectAllAttestationStudents').change(function() {
            $('input[name="selectedAttestationStudents"]').prop('checked', this.checked);
            updateSelectedCount();
        });

        // Select all functionality for admission modal
        $('#selectAllAdmissionStudents').change(function() {
            $('input[name="selectedAdmissionStudents"]').prop('checked', this.checked);
            updateAdmissionSelectedCount();
        });

        // Individual checkbox change for attestation modal
        $(document).on('change', 'input[name="selectedAttestationStudents"]', function() {
            updateSelectedCount();
            // Update "select all" checkbox state
            var totalCheckboxes = $('input[name="selectedAttestationStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#selectAllAttestationStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Individual checkbox change for admission modal
        $(document).on('change', 'input[name="selectedAdmissionStudents"]', function() {
            updateAdmissionSelectedCount();
            // Update "select all" checkbox state
            var totalCheckboxes = $('input[name="selectedAdmissionStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedAdmissionStudents"]:checked').length;
            $('#selectAllAdmissionStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Search functionality for attestation modal
        $('#attestationStudentSearch').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('#attestationStudentsTableBody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

        // Search functionality for admission modal
        $('#admissionStudentSearch').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('#admissionStudentsTableBody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

        function updateSelectedCount() {
            var selectedCount = $('input[name="selectedStudents"]:checked').length;
            $('#selectedCount').text(selectedCount);
        }

        // Handle select all checkbox
        $('#selectAllStudents').on('change', function() {
            $('input[name="selectedStudents"]').prop('checked', this.checked);
            updateSelectedCount();
        });

        // Handle individual checkbox changes
        $(document).on('change', 'input[name="selectedStudents"]', function() {
            updateSelectedCount();
            
            // Update select all checkbox state
            var totalCheckboxes = $('input[name="selectedStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedStudents"]:checked').length;
            $('#selectAllStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Handle student search
        $('#studentSearch').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('#studentsTableBody tr').each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Handle certificat generation
   
        // Load the contract model for the group's formation automatically
        function loadContractModel() {
            // Clear any previous error
            $('#contratModelError').hide();
            
            // Load models via AJAX that match the group's formation and school year
            $.ajax({
                url: '{% url "t_etudiants:ApiGetModeleContratByFormation" %}',
                type: 'GET',
                data: { 
                    'formation_id': '{{groupe.specialite.formation.id}}',
                    'annee_scolaire': '{{groupe.annee_scolaire}}'  // Pass the group's school year for additional filtering
                },
                dataType: 'JSON',
                success: function(response) {
                    if (response.status === 'success' && response.data && response.data.length > 0) {
                        var matchingModels = response.data;
                        
                        // Use the first matching model (or the first active one if available)
                        var selectedModel = matchingModels[0];
                        
                        // If there are multiple models, try to select an active one
                        var activeModels = matchingModels.filter(function(model) {
                            return model.statut === 'act';  // Assuming 'act' means active
                        });
                        
                        if (activeModels.length > 0) {
                            selectedModel = activeModels[0];
                        }
                        
                        // Update the display and hidden field
                        $('#selectedContractDisplay').text(selectedModel.nom + ' (' + (selectedModel.annee_scolaire || 'N/A') + ')');
                        $('#contratModelId').val(selectedModel.id);
                        $('#contratModelError').hide();
                    } else {
                        $('#selectedContractDisplay').html('<span class="text-danger">Aucun modèle de contrat disponible pour cette formation et année scolaire</span>');
                        $('#contratModelId').val('');
                        $('#contratModelError').text('Aucun modèle de contrat disponible pour cette formation et année scolaire.').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading contract models:', error);
                    $('#selectedContractDisplay').html('<span class="text-danger">Erreur de chargement des modèles de contrat</span>');
                    $('#contratModelId').val('');
                    $('#contratModelError').text('Erreur lors du chargement des modèles de contrat.').show();
                }
            });
        }
        
        // Load contract model when modal is shown
        $('#contratsModal').on('shown.bs.modal', function() {
            loadContractModel();
            updateContratSelectedCount();
        });
        
        // Update selected count for contracts
        function updateContratSelectedCount() {
            var selectedCount = $('input[name="selectedContratStudents"]:checked').length;
            $('#contratSelectedCount').text(selectedCount);
        }

        // Handle select all checkbox for contracts
        $('#selectAllContratStudents').on('change', function() {
            $('input[name="selectedContratStudents"]').prop('checked', this.checked);
            updateContratSelectedCount();
        });

        // Handle individual checkbox changes for contracts
        $(document).on('change', 'input[name="selectedContratStudents"]', function() {
            updateContratSelectedCount();
            
            // Update select all checkbox state
            var totalCheckboxes = $('input[name="selectedContratStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedContratStudents"]:checked').length;
            $('#selectAllContratStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Handle student search for contracts
        $('#contratStudentSearch').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('#contratsStudentsTableBody tr').each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        
       
        // Update selected count
        function updateAttestationSelectedCount() {
            var selectedCount = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#attestationSelectedCount').text(selectedCount);
        }

        // Handle select all checkbox
        $('#selectAllAttestationStudents').on('change', function() {
            $('input[name="selectedAttestationStudents"]').prop('checked', this.checked);
            updateAttestationSelectedCount();
        });

        // Handle individual checkbox changes
        $(document).on('change', 'input[name="selectedAttestationStudents"]', function() {
            updateAttestationSelectedCount();
            
            // Update select all checkbox state
            var totalCheckboxes = $('input[name="selectedAttestationStudents"]').length;
            var checkedCheckboxes = $('input[name="selectedAttestationStudents"]:checked').length;
            $('#selectAllAttestationStudents').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Handle student search
        $('#attestationStudentSearch').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('#attestationStudentsTableBody tr').each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        
        // Function to filter students table
        function filterStudentsTable() {
            var filterNom = $('#filterNom').val().toLowerCase();
            var filterPrenom = $('#filterPrenom').val().toLowerCase();
            var filterStatus = $('#filterStatus').val().toLowerCase();

            $('#studentsTable tbody tr').each(function() {
                var row = $(this);
                var fullName = row.find('td:eq(0)').text().toLowerCase(); // Nom & Prénom column
                var status = row.find('td:eq(4)').text().toLowerCase(); // Status column

                // Check if the full name contains the nom filter
                var nomMatch = filterNom === '' || fullName.includes(filterNom);
                // Check if the full name contains the prenom filter
                var prenomMatch = filterPrenom === '' || fullName.includes(filterPrenom);
                // Check if status matches
                var statusMatch = filterStatus === '' || status.includes(filterStatus);

                if (nomMatch && prenomMatch && statusMatch) {
                    row.show();
                } else {
                    row.hide();
                }
            });
        }

        // Event listeners for filter inputs
        $('#filterNom').on('keyup', filterStudentsTable);
        $('#filterPrenom').on('keyup', filterStudentsTable);
        $('#filterStatus').on('change', filterStudentsTable);
    
    

    });



</script>

{% endblock content %}
           



    