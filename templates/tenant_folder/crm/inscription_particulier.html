{% extends 'tenant_folder/base.html' %}
{% block title %}CRM - Nouveau visiteur{% endblock title %}
{% block content %}

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-user-plus text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Nouveau visiteur</h4>
            </div>
            <div class="page-title-right">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);" class="text-muted">
                      <i class="fas fa-home me-1"></i>CRM
                    </a>
                  </li>
                  <li class="breadcrumb-item active text-info">Nouveau visiteur</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-gradient-info text-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                  <i class="fas fa-user-circle me-2"></i>Nouveau prospect
                </h4>
                <span class="badge bg-white text-info px-3 py-2">Particulier</span>
              </div>
            </div>
            <div class="card-body p-3">
              <form method="POST" class="needs-validation" onsubmit="this.querySelector('button[type=submit]').disabled = true;">
                {% csrf_token %}
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-bullhorn text-info me-2"></i>
                    <h5 class="text-info mb-0">Prémiere visite ?</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-12">
                      <label class="form-label">Situation de contact</label>
                      <div class="d-flex flex-wrap">
                        {{ form.contact_situation }}
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <label class="form-label" for="id_lead_source">{{form.lead_source.label}}</label>
                      {{ form.lead_source }}
                    </div>
                  </div>
                </div>

                <!-- Informations personnelles -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-user text-info me-2"></i>
                    <h5 class="text-info mb-0">Informations personnelles</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-6">
                      <label class="form-label" for="id_last_name">{{form.nom.label}}</label>
                      <input type="text" required name="nom" class="form-control" />
                    </div>
                    <div class="col-lg-6">
                      <label class="form-label" for="id_first_name">{{form.prenom.label}}</label>
                      <input type="text" required name="prenom" class="form-control" />
                    </div>
                  </div>
                </div>

                <!-- Coordonnées -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-address-card text-info me-2"></i>
                    <h5 class="text-info mb-0">Coordonnées</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-4">
                      <label class="form-label" for="id_email">Email</label>
                      {{ form.email }}
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label" for="{{ form.telephone.id_for_label }}">Téléphone</label>
                      <div class="d-flex">
                        <div class="me-2" style="max-width: 110px;">
                          {{ form.indic }}
                        </div>
                        <div style="flex: 1;">
                          {{ form.telephone }}
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label" for="id_canal">Comment avez-vous connu l'INSIM ?</label>
                      {{ form.canal }}
                    </div>
                  </div>
                </div>

                <!-- Possede d'autres voeux -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    
                    <h5 class="text-info mb-0">Sélection du type du cursus :</h5>
                  </div>
                  
                    {{form.select_type}}
                  
                  <p class="text-muted small mb-0">
                    Veuillez sélectionner un type de cursus que l'etudiant va suivre
                  </p>
                </div>

                <!-- Voeux de formation -->
                <div id="sectionSelectionDoubleDiplomation" class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-graduation-cap text-info me-2"></i>
                    <h5 class="text-info mb-0">Voeux de formation (double diplomation)</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-6">
                    <label class="form-label" for="id_promo_selection_double">Promo</label>
                      <select class="form-select" id="id_promo_selection_double" name="promo_selection_double">
                        
                      </select>
                    </div>  
                    <div class="col-lg-6">
                      <label class="form-label" for="id_select_double">Formation (Double diplômation)</label>
                      <select class="form-select" id="id_select_double" name="id_select_double">
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Voeux de formation -->
                <div id="sectionVoeuxFormation" class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-graduation-cap text-info me-2"></i>
                    <h5 class="text-info mb-0">Voeux de formation</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-4">
                    <label class="form-label" for="id_promo_selection">Promo</label>
                      <select class="form-select" id="id_promo_selection" name="promo_selection">
                        
                      </select>
                    </div>  
                    <div class="col-lg-4">
                      <label class="form-label" for="id_voeux_formation">Formation</label>
                      <select class="form-select" id="id_voeux_formation" name="voeux_formation">
                      </select>
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label" for="id_voeux_specialite">Spécialité</label>
                      <select class="form-select" id="id_voeux_specialite" name="voeux_specialite">
                        <option value="">Sélectionner une spécialité</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Possede d'autres voeux -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-plus-circle text-info me-2"></i>
                    <h5 class="text-info mb-0">Options supplémentaires</h5>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="possede_autres_voeux" name="possede_autres_voeux">
                    <label class="form-check-label" for="possede_autres_voeux">
                      Possède d'autres voeux ?
                    </label>
                  </div>
                  <p class="text-muted small mb-0">
                    Cochez cette case si le prospect souhaite s'inscrire à plusieurs formations ou spécialités.
                  </p>
                </div>

                <!-- Observation -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-comment text-info me-2"></i>
                    <h5 class="text-info mb-0">Observation</h5>
                  </div>
                  {{ form.observation }}
                </div>


                <!-- Submit button -->
                <div class="text-end mt-3">
                  <button type="submit" class="btn btn-info px-4 py-2 text-white">
                    <i class="fas fa-save me-2"></i>Enregistrer
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!--end col-->
      </div>
      <!--end row-->
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->

  <script>
    $(document).ready(function () {

      $('#sectionVoeuxFormation').hide();
      $('#sectionSelectionDoubleDiplomation').hide();
      
      function loadPromo(){
        $.ajax({
          url : "{% url 't_formations:ApiListePromos' %}",
          dataType: "JSON",
          type  : "GET",
          success : function(data){
            var option = "<option value='0'>Veuillez selectionner une promo</option>";
            $.each(data, function(index, item){
              option += "<option value="+item.code+">#"+item.code+ " - "+item.session_label+'-'+item.begin_year+'/'+item.end_year+"</option>";
            });
            $('#id_promo_selection').html(option);
            $('#id_promo_selection_double').html(option);
          }
        });
      }

      loadPromo();

      function loadformation(){
        $.ajax({
          url : "{% url 't_crm:ApiLoadFormation' %}",
          type : 'GET',
          dataType : 'JSON',
          success : function(data){
              var options = "<option value='0'>---------</option>";
              console.log(data);
              $.each(data.formation, function(index, item){
                options += "<option value="+item.id+">"+item.code+" - "+item.nom+"</option>";
              });
              $('#id_voeux_formation').html(options);

          },
          error : function(xhr, status, error){
            console.log("Une erreur est survenue lors du chargement des formations.");
          }
        });
      }

      loadformation();

      function loadSpecialite(id_formation_value){
        $.ajax({
          url : "{% url 't_crm:ApiLoadSpecialiteProspect' %}",
          dataType : 'JSON',
          type : 'GET',
          data : {
            'id_formation' : id_formation_value
          },
          success : function(data){
            var options = "<option value=''>---------</option>";
            $.each(data.specialite, function(index, item){
              options += "<option value='"+item.id+"'>"+item.code+' - '+item.label+"</option>";
            });
            $('#id_voeux_specialite').html(options);
          },
          error : function(xhr, status, error){
            console.log("Une erreur est survenue lors du chargement des specialites.");
          }
        });
      }

      function loadDoubleInscription(){
        $.ajax({
          url : "{% url 't_formations:ApiLoadSelestDoubleDiplomation' %}",
          dataType : "JSON",
          type : "GET",
          success : function(data){
            var option = "<option value='0'>Veuillez sélectionner une double diplômation</option>";
            $.each(data, function(index, p){
              option += "<option value="+p.id+">"+p.label+"</label>";
            });

            $("#id_select_double").html(option);
          }
        });
      }

      $(document).on('change', '#id_voeux_formation', function(){
        var value = $(this).val();

        loadSpecialite(value);
      });

      $(document).on('change','#selectTypeCursusID', function(){
        var value = $(this).val();

        if (value === "0"){

          $('#sectionVoeuxFormation').show();
          $('#sectionSelectionDoubleDiplomation').hide();
          

        }else{

          $('#sectionVoeuxFormation').hide();
          loadDoubleInscription();
          $('#sectionSelectionDoubleDiplomation').show();


        }

      })
     
    });
  </script>



<script>
  (function() {
      // formate la valeur : 0612345678 -> 06-12-34-56-78
      function formatTelephone(val) {
          const digits = val.replace(/\D/g, '').substring(0, 10);
          return digits.replace(/(\d{2})(?=\d)/g, '$1-');
      }

      // écoute les input sur tout le document (fonctionne aussi pour éléments dynamiques)
      document.addEventListener('input', function(e) {
          const el = e.target;
          if (!el.classList || !el.classList.contains('telephoneID')) return;

          // nombre de chiffres avant le curseur (pour restaurer la position)
          const selStart = el.selectionStart || 0;
          const digitsBefore = el.value.slice(0, selStart).replace(/\D/g, '').length;

          // formater et appliquer
          const formatted = formatTelephone(el.value);
          el.value = formatted;

          // calculer nouvelle position du curseur en fonction des chiffres avant
          let pos = 0, d = 0;
          while (pos < formatted.length && d < digitsBefore) {
              if (/\d/.test(formatted[pos])) d++;
              pos++;
          }
          el.setSelectionRange(pos, pos);
      });

      // avant envoi du formulaire, supprimer les tirets (si submission classique ou via JS qui déclenche submit)
      document.addEventListener('submit', function(e) {
          const form = e.target;
          if (!(form instanceof HTMLFormElement)) return;
          form.querySelectorAll('.telephoneID').forEach(function(input) {
              input.value = input.value.replace(/\D/g, ''); // garde que les chiffres
          });
      });
  })();
</script>


</div>
{% endblock content %}