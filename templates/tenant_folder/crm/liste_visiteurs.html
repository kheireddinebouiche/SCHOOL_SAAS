{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} CRM - Liste des visiteurs {% endblock title %}

{% block content %}
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0">Liste des visiteurs</h4>

                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="javascript: void(0);">CRM</a></li>
                                        <li class="breadcrumb-item active">Liste des visiteurs</li>
                                    </ol>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- end page title -->
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Liste des visiteurs</h5>
                                </div>
                                <div class="card-body">
                                    <table id="example" class="table table-bordered dt-responsive nowrap table-striped align-middle" style="width:100%">
                                        <thead>
                                            <tr>
                                                
                                                <th>C.I.N</th>
                                                <th>Nom & Prénom</th>
                                                <th>Téléphone</th>
                                                <th>Email</th>
                                                <th>Type client</th>
                                                <th>Etat</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listeItem">

                                            
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

        </div>

<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <lord-icon src="https://cdn.lordicon.com/hwjcdycb.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:120px;height:120px">
                </lord-icon>
                <div class="mt-4">
                    <h4 class="mb-3">Vous étes sur le point de supprimer le visiteur</h4>
                    <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                    <div class="hstack gap-2 justify-content-center">
                        
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>

    $(document).ready(function(){

        function loadItems(){
            $.ajax({
                url : "{% url 't_crm:ApiListeVisiteurs' %}",
                dataType : "JSON",
                type : "GET",
                success: function(data){
                    var row = "";
                    if (data.length > 0){
                        $.each(data, function(index, p){
                            row += '<tr>';
                            row += '<td><strong>'+p.cin+'</strong></td>';
                            row += '<td>'+p.nom+' '+p.prenom+'</td>'; 
                            row += '<td>'+p.telephone+'</td>';
                            row += '<td>'+p.email+'</td>';
                            row += '<td>'+p.type_visiteur_label+'</td>';
                            row += '<td>';
                            if (p.etat == "en_attente"){
                                row += '<span class="badge bg-warning">'+p.etat_label+'</span>';
                            }else if (p.etat == "inscrit"){
                                row += '<span class="badge bg-success">'+p.etat_label+'</span>';
                            }else if (p.etat == "visiteur"){
                                row += '<span class="badge bg-danger">'+p.etat_label+'</span>';
                            }
                            row += '</td>';
                            row += '<td>';
                            row += '<div class="dropdown d-inline-block">';
                            row += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                            row += '<i class="ri-more-fill align-middle"></i>';
                            row += '</button>';
                            row += '<ul class="dropdown-menu dropdown-menu-end">';
                            row += '<li><a href="/crm/details-visiteur/' + p.id + '/" class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i> Consulter</a></li>';
                            row += '<li><a href="/crm/mise-a-jours/' + p.id + '/" class="dropdown-item edit-item-btn"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</a></li>';
                            row += '<li>';
                            row += '<button id="deleteConfirmation" data-id="'+p.id+'" class="dropdown-item remove-item-btn">';
                            row += '<i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer';
                            row += '</button>';
                            row += '</li>';
                            row += '</ul>';
                            row += '</div>';
                            row += '</td>';
                            row += '</tr>';
                        });
                    }else{
                        row += '<tr>';
                        row += '<td colspan="7" class="text-center">Aucun visiteur trouvé</td>';
                        row += '</tr>';
                    }
                    $('#listeItem').html(row);
                }
            });
        }

        loadItems();

        $(document).on('click', '#deleteConfirmation' ,function(){
            var id= $(this).data('id');
            var row = '<button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>'+
                   '<button type="button" id="confirmDeleteBtn" data-id='+id+' class="btn btn-danger">Confirmer</a>';

            $('.hstack').html(row);
            $('.deleteModal').modal('show');

        });

        $(document).on('click', '#confirmDeleteBtn', function(){
            var id = $(this).data('id');
            $.ajax({
                url: "{% url 't_crm:supprimer_visiteur' %}",
                type: 'POST',
                data: {
                    'id': id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data){
                    if(data.success){
                        alertify.success(data.message);
                        $('.deleteModal').modal('hide');
                        loadItems();
                    }else{
                        alertify.error(data.message);
                        $('.deleteModal').modal('hide');
                    }
                }
            });
        });
       
    });

    

</script>

{% endblock content %}
           



    