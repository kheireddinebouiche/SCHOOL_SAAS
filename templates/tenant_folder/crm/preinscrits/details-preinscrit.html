{% extends "tenant_folder/base.html" %}
{% load static %}
{% block title %}Détails du pré-inscrit {% endblock title %}
{% block content %}

<style>
    .completion-check-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    
    .completion-check-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-color: #dee2e6;
    }
    
    .completion-check-card.completed {
        background-color: rgba(25, 135, 84, 0.1);
        border-color: rgba(25, 135, 84, 0.3);
    }
    
    .completion-check-card.incomplete {
        background-color: rgba(220, 53, 69, 0.1);
        border-color: rgba(220, 53, 69, 0.3);
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">                                                    

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-user-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Détails du pré-inscrit</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">CRM</a>
                                    </li>
                                    <li class="breadcrumb-item active">Détails du pré-inscrit</li>
                                </ol>
                            </nav>
                            <div class="btn-group">
                                <button type="button" class="btn btn-success px-4 py-2" data-bs-toggle="modal" id="validatePreinscritBtn">
                                    <i class="ri-check-line me-2"></i>Valider la pré-inscription
                                </button>
                              
                                <a href="/crm/liste-des-preinscrits/" class="btn btn-light px-4 py-2">
                                    <i class="ri-arrow-left-line me-2"></i>Retour à la liste
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Notification informations supplémentaires -->
            <div  hidden id="incompleted_infos" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-warning d-flex align-items-center rounded-4 shadow-sm" role="alert">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="ri-alert-line text-warning fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">Informations supplémentaires requises</h5>
                            <p class="mb-0">Veuillez compléter les informations supplémentaires pour ce pré-inscrit afin de faciliter le processus de validation.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-warning px-4 py-2" id="completeAdditionalInfoBtn">
                                <i class="ri-edit-line me-2"></i>Compléter les informations
                            </button>
                            <button type="button" class="btn btn-info px-4 py-2" data-bs-toggle="modal" data-bs-target="#profileDetailsModal">
                                <i class="ri-eye-line me-2"></i>Voir le profil
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification dossier incomplet -->
            <div hidden id="non_completed_docs" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-danger d-flex align-items-center rounded-4 shadow-sm" role="alert">
                        <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="ri-error-warning-line text-danger fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">Dossier incomplet</h5>
                            <p class="mb-0">Certaines informations obligatoires sont manquantes. Veuillez compléter le dossier pour continuer.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-danger px-4 py-2" data-bs-toggle="modal" data-bs-target="#missingDocumentsModal">
                                <i class="ri-file-list-line me-2"></i>Voir les documents manquants
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification dossier complet -->
            <div hidden id="completed_docs" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-success d-flex align-items-center rounded-4 shadow-sm" role="alert">
                        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="ri-checkbox-circle-line text-success fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">Dossier complet</h5>
                            <p class="mb-0">Toutes les informations requises ont été fournies. Ce dossier est prêt pour la validation.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-success px-3 py-2">
                                <i class="ri-check-line me-1"></i>Complet
                            </span>
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#profileDetailsModal">
                                <i class="ri-eye-line me-1"></i>Voir le profil
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification dérogation acceptée -->
            <div hidden id="derogation_acceptee" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-success d-flex align-items-center rounded-4 shadow-sm" role="alert">
                        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="ri-checkbox-circle-line text-success fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">Dérogation acceptée</h5>
                            <p class="mb-0">La demande de dérogation a été acceptée. Ce dossier peut être validé.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-success px-3 py-2">
                                <i class="ri-check-line me-1"></i>Acceptée
                            </span>
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#detailsDerogationModal">
                                <i class="ri-eye-line me-1"></i>Voir les détails
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification dérogation refusée -->
            <div hidden id="derogation_refusee" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-danger d-flex align-items-center rounded-4 shadow-sm" role="alert">
                        <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="ri-close-circle-line text-danger fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">Dérogation refusée</h5>
                            <p class="mb-0">La demande de dérogation a été refusée. Veuillez consulter les détails pour plus d'informations.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-danger px-3 py-2">
                                <i class="ri-close-line me-1"></i>Refusée
                            </span>
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#detailsDerogationModal">
                                <i class="ri-eye-line me-1"></i>Voir les détails
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification dérogation en attente -->
            <div hidden id="derogation_attente" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-warning d-flex align-items-center rounded-4 shadow-sm" role="alert">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="ri-time-line text-warning fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">Dérogation en attente</h5>
                            <p class="mb-0">Une demande de dérogation est en cours de traitement. Veuillez patienter jusqu'à la décision finale.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-warning px-3 py-2">
                                <i class="ri-time-line me-1"></i>En attente
                            </span>
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#detailsDerogationModal">
                                <i class="ri-eye-line me-1"></i>Voir les détails
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Première rangée : Informations personnelles et Fiche de Voeux -->
            <div class="row mb-4">
                <!-- Informations personnelles -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-user-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-primary mb-1">Informations personnelles</h5>
                                    <p class="text-muted small mb-0">Détails du contact</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-user-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Nom et Prénom</small>
                                    <span class="fw-semibold" id="nom_prenom">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-flag-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Statut</small>
                                    <span class="fw-semibold" id="statut_preinscrit">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-mail-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Email</small>
                                    <span class="fw-semibold" id="email">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-phone-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Téléphone</small>
                                    <span class="fw-semibold" id="phone">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-calendar-line text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Crée le</small>
                                    <span class="fw-semibold" id="created_at">-</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mt-3">
                                <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#profileDetailsModal">
                                    <i class="ri-eye-line me-1"></i>Voir le profil
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#additionalInfoModal">
                                    <i class="ri-edit-line me-1"></i>Modifier le profil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Fiche de Voeux -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-graduation-cap-line text-info fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-info mb-1">Fiche de Voeux</h5>
                                        <p class="text-muted small mb-0">Orientation académique du pré-inscrit</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4 d-flex align-items-center justify-content-center">
                            <div class="row w-100" id="preinscritVoeuxDetails">
                               
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents du pré-inscrit -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-folder-line text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-warning mb-1">Documents du pré-inscrit</h5>
                                        <p class="text-muted small mb-0">Liste des documents fournis par le pré-inscrit</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-warning px-4 py-2" id="addDocumentBtn">
                                    <i class="ri-add-line me-2"></i>Ajouter un document
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Nom du document</th>
                                            <th class="border-0">Type</th>
                                            <th class="border-0">Date d'ajout</th>
                                            <th class="border-0 rounded-end text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listeDesDocuments">
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rappels & Notes -->
            <div class="row">
                <!-- Rappels & Rendez-vous -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-calendar-check-line text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-success mb-1">Rappels & Rendez-vous</h5>
                                        <p class="text-muted small mb-0">Gestion des tâches et rendez-vous</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-success px-4 py-2" id="addReminderBtn">
                                    <i class="ri-add-line me-2"></i>Nouveau rappel
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Type</th>
                                            <th class="border-0">Date & Heure</th>
                                            <th class="border-0">Objet</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0 rounded-end text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listeDesRendezVous">
                                        <!-- Liste des rendez vous -->
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Notes -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <!-- Header -->
                        <div class="card-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-sticky-note-line text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-warning mb-1">Notes</h5>
                                        <p class="text-muted small mb-0">Commentaires et observations</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-warning px-4 py-2" id="addNoteModalBtn">
                                    <i class="ri-add-line me-2"></i>Nouvelle note
                                </button>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="card-body p-4">
                           
                            <!-- Liste des notes -->
                            <div class="vstack gap-4" id="ListeDesNotes">
                                <button type="button" class="border-start border-4 border-dashed border-warning ps-4 py-4 bg-white rounded-end text-start w-100" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3">
                                            <div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle fs-5">
                                                <i class="ri-add-line"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="fw-medium text-warning mb-0">Ajouter une note</h6>
                                            <small class="text-muted">Cliquez pour ajouter une nouvelle note</small>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin Section Notes-->
             


                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal Informations supplémentaires -->
<div class="modal fade" id="additionalInfoModal" tabindex="-1" aria-labelledby="additionalInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <!-- En-tête avec style moderne -->
            <div class="modal-header bg-white border-bottom-0 pt-4 pb-2">
                <div class="d-flex align-items-center">
                    <div class="avatar-sm me-3">
                        <div class="avatar-title bg-primary rounded-circle">
                            <i class="ri-file-info-line text-white fs-5"></i>
                        </div>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-dark" id="additionalInfoModalLabel">
                            Informations supplémentaires
                        </h5>
                        <p class="text-muted small mb-0">Compléter le profil du pré-inscrit</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Corps de la modale avec onglets -->
            <div class="modal-body p-0">
                <!-- Navigation par onglets -->
                <ul class="nav nav-tabs nav-tabs-custom nav-justified bg-light mx-3 rounded-top" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active fw-medium" data-bs-toggle="tab" href="#identite" role="tab">
                            <i class="ri-user-line me-2"></i>Identité
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" data-bs-toggle="tab" href="#parents" role="tab">
                            <i class="ri-group-line me-2"></i>Parents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" data-bs-toggle="tab" href="#medical" role="tab">
                            <i class="ri-heart-line me-2"></i>Médical
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" data-bs-toggle="tab" href="#adresse" role="tab">
                            <i class="ri-map-pin-line me-2"></i>Adresse
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" data-bs-toggle="tab" href="#academique" role="tab">
                            <i class="ri-graduation-cap-line me-2"></i>Académique
                        </a>
                    </li>
                </ul>
                
                <!-- Contenu des onglets -->
                <div class="tab-content p-4">
                    <!-- Onglet Identité -->
                    <div class="tab-pane active" id="identite" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-primary fw-semibold mb-3">Informations d'identité</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Nom en arabe</label>
                                    <input type="text" id="nom_arabe" class="form-control form-control-lg border rounded-3 py-3" placeholder="الاسم" dir="rtl">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Prénom en arabe</label>
                                    <input type="text" id="prenom_arabe" class="form-control form-control-lg border rounded-3 py-3" placeholder="الشهرة" dir="rtl">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Date de naissance</label>
                                    <input type="date" id="date_naissance" class="form-control form-control-lg border rounded-3 py-3">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Lieu de naissance</label>
                                    <input type="text" id="lieu_naissance" class="form-control form-control-lg border rounded-3 py-3">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">N° identification national (NIN)</label>
                                    <input type="text" id="nin" class="form-control form-control-lg border rounded-3 py-3" placeholder="Numéro d'identification national">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Parents -->
                    <div class="tab-pane" id="parents" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-success fw-semibold mb-3">Informations des parents</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Prénom père</label>
                                    <input type="text" id="prenom_pere" class="form-control form-control-lg border rounded-3 py-3" placeholder="Prénom père">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Téléphone père</label>
                                    <input type="text" id="tel_pere" class="form-control form-control-lg border rounded-3 py-3" placeholder="Téléphone père">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Nom mère</label>
                                    <input type="text" id="nom_mere" class="form-control form-control-lg border rounded-3 py-3" placeholder="Nom mère">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Prénom mère</label>
                                    <input type="text" id="prenom_mere" class="form-control form-control-lg border rounded-3 py-3" placeholder="Prénom mère">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Téléphone mère</label>
                                    <input type="text" id="tel_mere" class="form-control form-control-lg border rounded-3 py-3" placeholder="Téléphone mère">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Médical -->
                    <div class="tab-pane" id="medical" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-warning fw-semibold mb-3">Informations médicales</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Handicap</label>
                                    <select id="has_handicap" class="form-select form-select-lg border rounded-3 py-3">
                                        <option value="">Sélectionnez une option</option>
                                        <option value="True">Oui</option>
                                        <option value="False">Non</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Type handicap</label>
                                    <input type="text" id="type_handicap" class="form-control form-control-lg border rounded-3 py-3" placeholder="Type handicap">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Groupe sanguin</label>
                                    <select id="groupe_sanguin" class="form-select form-select-lg border rounded-3 py-3">
                                        <option value="">Sélectionnez un groupe sanguin</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Adresse -->
                    <div class="tab-pane" id="adresse" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-info fw-semibold mb-3">Informations de contact</h6>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Adresse</label>
                                    <input type="text" id="adresse_prospect" class="form-control form-control-lg border rounded-3 py-3" placeholder="Adresse complète" >
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Pays</label>
                                    <input type="text" id="pays" class="form-control form-control-lg border rounded-3 py-3" placeholder="Pays de residance" >
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Wilaya</label>
                                    <input type="text" id="wilaya" class="form-control form-control-lg border rounded-3 py-3" placeholder="Wilaya" >
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Code Zip</label>
                                    <input type="text" id="code_zip" class="form-control form-control-lg border rounded-3 py-3" placeholder="Code Zip" >
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Académique -->
                    <div class="tab-pane" id="academique" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-primary fw-semibold mb-3">Informations académiques</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Niveau scolaire</label>
                                    <select id="niveau_scolaire" class="form-select form-select-lg border rounded-3 py-3">
                                        <option value="">Sélectionnez un niveau scolaire</option>
                                        <option value="1_am">1 am</option>
                                        <option value="2_am">2 am</option>
                                        <option value="3_am">3 am</option>
                                        <option value="4_am">4 am</option>
                                        <option value="1_as">1 AS</option>
                                        <option value="2_as">2 AS</option>
                                        <option value="terminal">Terminal</option>
                                        <option value="bac1">BAC +1</option>
                                        <option value="bac2">BAC +2</option>
                                        <option value="licence">Licence</option>
                                        <option value="m">Master</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Diplôme</label>
                                    <input type="text" id="diplome" class="form-control form-control-lg border rounded-3 py-3" placeholder="Diplôme obtenu">
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Établissement d'obtention du diplôme</label>
                                    <input type="text" id="etablissement_diplome" class="form-control form-control-lg border rounded-3 py-3" placeholder="Établissement">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pied de page -->
            <div class="modal-footer bg-light-subtle border-top-0 px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2 rounded-3" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-secondary px-4 py-2 rounded-3" id="prevTabBtn">
                    <i class="ri-arrow-left-line me-2"></i>Précédent
                </button>
                <button type="button" class="btn btn-primary px-4 py-2 rounded-3" id="nextTabBtn">
                    <i class="ri-arrow-right-line me-2"></i>Suivant
                </button>
                <button type="button" class="btn btn-success px-4 py-2 rounded-3" id="saveAdditionalInfoBtn">
                    <i class="ri-checkbox-circle-line me-2"></i>Valider les informations
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Informations supplémentaires -->
<div class="modal fade" id="confirmAdditionalInfoModal" tabindex="-1" aria-labelledby="confirmAdditionalInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-gradient-primary text-white rounded-top-4 rounded-bottom-0 p-4">
                <div class="d-flex align-items-center">
                    <div class="avatar-lg bg-white bg-opacity-25 rounded-circle me-3">
                        <div class="avatar-title fs-3">
                            <i class="ri-questionnaire-line"></i>
                        </div>
                    </div>
                    <div>
                        <h4 class="modal-title fw-bold mb-1">Confirmer les informations</h4>
                        <p class="mb-0 text-white text-opacity-75">Veuillez vérifier les informations saisies</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="alert alert-warning d-flex align-items-center rounded-3 mb-4">
                    <div class="flex-shrink-0 me-2">
                        <i class="ri-alert-line fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-0">Veuillez vérifier attentivement les informations saisies avant de confirmer.</p>
                    </div>
                </div>
                
                <div class="row g-3" id="confirmationDetails">
                    <!-- Les détails seront insérés ici par JavaScript -->
                </div>
            </div>
            
            <div class="modal-footer bg-light-subtle border-0 rounded-bottom-4 p-4">
                <div class="hstack gap-3 w-100">
                    <button type="button" class="btn btn-light px-4 py-2 rounded-3 flex-grow-1" data-bs-dismiss="modal">
                        <i class="ri-close-line me-2"></i>Modifier
                    </button>
                    <button type="button" class="btn btn-primary px-4 py-2 rounded-3 flex-grow-1" id="confirmSaveAdditionalInfoBtn">
                        <i class="ri-checkbox-circle-line me-2"></i>Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails du Profil -->
<div class="modal fade" id="profileDetailsModal" tabindex="-1" aria-labelledby="profileDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-gradient-info text-white rounded-top-4 rounded-bottom-0 p-3">
                <div class="d-flex align-items-center">
                    <div class="avatar-md bg-white bg-opacity-25 rounded-circle me-2">
                        <div class="avatar-title fs-4">
                            <i class="ri-user-line"></i>
                        </div>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold mb-0">Détails du Profil</h5>
                        <p class="mb-0 text-white text-opacity-75 small">Informations complètes du pré-inscrit</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-3">
                <div class="row g-3" id="profileDetailsContent">
                    <!-- Informations d'identité -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary bg-opacity-10 border-0 py-2">
                                <h6 class="card-title text-primary mb-0">
                                    <i class="ri-user-line me-2"></i>Informations d'identité
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Nom en arabe:</div>
                                            <div id="profile_nom_arabe" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Prénom en arabe:</div>
                                            <div id="profile_prenom_arabe" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Date de naissance:</div>
                                            <div id="profile_date_naissance">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Lieux naissance</div>
                                            <div id="profile_lieu_naissance">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">N° identification national (NIN):</div>
                                            <div id="profile_nin" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations des parents -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-success bg-opacity-10 border-0 py-2">
                                <h6 class="card-title text-success mb-0">
                                    <i class="ri-group-line me-2"></i>Informations des parents
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Prénom père:</div>
                                            <div id="profile_prenom_pere" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Téléphone père:</div>
                                            <div id="profile_tel_pere">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Nom mère:</div>
                                            <div id="profile_nom_mere" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Prénom mère:</div>
                                            <div id="profile_prenom_mere" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Téléphone mère:</div>
                                            <div id="profile_tel_mere">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations médicales -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-warning bg-opacity-10 border-0 py-2">
                                <h6 class="card-title text-warning mb-0">
                                    <i class="ri-heart-line me-2"></i>Informations médicales
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Handicap:</div>
                                            <div id="profile_has_handicap">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Type handicap:</div>
                                            <div id="profile_type_handicap" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Groupe sanguin:</div>
                                            <div id="profile_groupe_sanguin">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations de contact -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-info bg-opacity-10 border-0 py-2">
                                <h6 class="card-title text-info mb-0">
                                    <i class="ri-map-pin-line me-2"></i>Informations de contact
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Adresse:</div>
                                            <div id="profile_adresse" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Pays:</div>
                                            <div id="profile_pays" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Wilaya:</div>
                                            <div id="profile_wilaya" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Code ZIP:</div>
                                            <div id="profile_code_zip" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations académiques -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary bg-opacity-10 border-0 py-2">
                                <h6 class="card-title text-primary mb-0">
                                    <i class="ri-graduation-cap-line me-2"></i>Informations académiques
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Niveau scolaire:</div>
                                            <div id="profile_niveau_scolaire" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Diplôme:</div>
                                            <div id="profile_diplome" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex">
                                            <div class="text-muted fw-medium me-2">Établissement d'obtention du diplôme:</div>
                                            <div id="profile_etablissement_diplome" class="text-truncate">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer bg-light-subtle border-0 rounded-bottom-4 p-3">
                <button type="button" class="btn btn-light px-3 py-2 rounded-3" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Rappel -->
<div class="modal fade" id="addReminderModal" tabindex="-1" aria-labelledby="addReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="addReminderModalLabel">
                            Nouveau rappel
                        </h5>
                        <p class="text-muted small mb-0">Créer un nouveau rappel ou rendez-vous</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Type de rappel</label>
                        <select id="reminderType" class="form-select border-0 bg-light py-2">
                            <option value="appel">Appel</option>
                            <option value="rendez_vous">Rendez-vous</option>
                            <option value="email">Email</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Objet</label>
                        <input id="reminderSubject" type="text" class="form-control border-0 bg-light py-2" placeholder="Entrez l'objet du rappel">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Date</label>
                        <input id="reminderDate" type="date" class="form-control border-0 bg-light py-2">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Heure</label>
                        <input id="reminderTime" type="time" class="form-control border-0 bg-light py-2">
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Description</label>
                        <textarea id="reminderDescription" class="form-control border-0 bg-light" rows="3" placeholder="Entrez une description..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="saveReminderBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de validation du pré-inscrit -->
<div class="modal fade" id="validatePreinscritModal" tabindex="-1" aria-labelledby="validatePreinscritModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-double-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="validatePreinscritModalLabel">
                            Validation de la pré-inscription
                        </h5>
                        <p class="text-muted small mb-0">Confirmation de la validation de la pré-inscription</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                            <i class="ri-user-follow-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de vouloir valider cette pré-inscription ?</h5>
                    <p class="text-muted mb-0">
                        La validation de la pré-inscription permettra de convertir le pré-inscrit en étudiant et de commencer le processus d'inscription.
                    </p>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Commentaire de validation (optionnel)</label>
                        <textarea class="form-control border-0 bg-light" rows="3" placeholder="Ajoutez un commentaire..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" id="confirmeValidationBtn" class="btn btn-success px-4 py-2">
                    <i class="ri-check-line me-2"></i>Valider la pré-inscription
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de modification du pré-inscrit -->
<div class="modal fade" id="editPreinscritModal" tabindex="-1" aria-labelledby="editPreinscritModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-edit-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="editPreinscritModalLabel">
                            Modifier les informations
                        </h5>
                        <p class="text-muted small mb-0">Modification des informations du pré-inscrit</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                            <i class="ri-user-settings-line"></i>
                        </div>
                    </div>
                    <h4 class="text-primary mb-3">Modification du pré-inscrit</h4>
                    <p class="text-muted mb-4">
                        Veuillez remplir les informations ci-dessous pour mettre à jour les détails du pré-inscrit.
                    </p>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-medium">Nom</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-user-line text-muted"></i>
                                </span>
                                <input type="text" id="edit_nom" class="form-control border-0 bg-light py-2" placeholder="Nom">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-medium">Prénom</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-user-line text-muted"></i>
                                </span>
                                <input type="text" id="edit_prenom" class="form-control border-0 bg-light py-2" placeholder="Prénom">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-medium">Email</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-mail-line text-muted"></i>
                                </span>
                                <input type="email" id="edit_email" class="form-control border-0 bg-light py-2" placeholder="Email">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-medium">Téléphone</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-phone-line text-muted"></i>
                                </span>
                                <input type="tel" id="edit_telephone" class="form-control border-0 bg-light py-2" placeholder="Téléphone">
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label fw-medium">Statut</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-flag-line text-muted"></i>
                                </span>
                                <select id="edit_statut" class="form-select border-0 bg-light py-2">
                                    <option value="en_attente">En attente</option>
                                    <option value="valide">Validé</option>
                                    <option value="refuse">Refusé</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label fw-medium">Note</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-sticky-note-line text-muted"></i>
                                </span>
                                <textarea id="edit_note" class="form-control border-0 bg-light" rows="3" placeholder="Ajoutez une note..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-center w-100">
                    <button type="button" class="btn btn-light px-4 py-2 w-100" data-bs-dismiss="modal">
                        <i class="ri-close-line me-2"></i>Annuler
                    </button>
                    <button type="button" id="validateUpdatePreinscritDetailsBtn" class="btn btn-primary px-4 py-2 w-100">
                        <i class="ri-save-line me-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouvelle Note -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-sticky-note-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="addNoteModalLabel">
                            Nouvelle note
                        </h5>
                        <p class="text-muted small mb-0">Ajouter une nouvelle note ou observation</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <textarea id="content_note" class="form-control border-0 bg-light" rows="4" placeholder="Saisissez votre note ici..."></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Étiquettes</label>
                        <select id="note_tags" class="form-select border-0 bg-light py-2">
                            <option value="important">Important</option>
                            <option value="a_revoir">A revoir</option>
                            <option value="a_contacte">A contacter</option>
                            <option value="a_relancer">A relancer</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="saveNoteBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal Modification d'une note -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-edit-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="editNoteModalLabel">
                            Modifier la note
                        </h5>
                        <p class="text-muted small mb-0">Modification d'une note existante</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Contenu de la note</label>
                        <textarea id="edit_content_note" class="form-control border-0 bg-light" rows="4"></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Étiquettes</label>
                        <select id="edit_note_tags" class="form-select border-0 bg-light py-2">
                            <option value="important">Important</option>
                            <option value="a_revoir">A revoir</option>
                            <option value="a_contacte">A contacter</option>
                            <option value="a_relancer">A relancer</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="updateNoteBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Suppression d'une note -->
<div class="modal fade" id="deleteNoteModal" tabindex="-1" aria-labelledby="deleteNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-delete-bin-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteNoteModalLabel">
                            Supprimer la note
                        </h5>
                        <p class="text-muted small mb-0">Suppression d'une note</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                            <i class="ri-error-warning-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer cette note ?</h5>
                    <p class="text-muted">
                        La suppression de cette note est définitive et ne pourra pas être annulée.
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" id='ConfirmDeleteNoteBtn' class="btn btn-danger px-4 py-2">
                    <i class="ri-delete-bin-line me-2"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modification d'un rappel -->
<div class="modal fade" id="editReminderModal" tabindex="-1" aria-labelledby="editReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-check-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="editReminderModalLabel">
                            Modifier le rappel
                        </h5>
                        <p class="text-muted small mb-0">Modification des informations du rappel</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Type de rappel</label>
                        <select id="editTypeReminder" class="form-select border-0 bg-light py-2">
                            <option value="appel">Appel</option>
                            <option value="rendez_vous">Rendez-vous</option>
                            <option value="email">Email</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Objet</label>
                        <input type="text" id="editObjectReminder" class="form-control border-0 bg-light py-2" placeholder="Entrez l'objet du rappel">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Date</label>
                        <input id="editDateReminder" type="date" class="form-control border-0 bg-light py-2">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Heure</label>
                        <input id="editTimeReminer" type="time" class="form-control border-0 bg-light py-2">
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Description</label>
                        <textarea id="editDescriptionRemider" class="form-control border-0 bg-light" rows="3" placeholder="Entrez une description..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" id="editReminderBtnSave" class="btn btn-primary px-4 py-2">
                    <i class="ri-save-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails d'un rappel -->
<div class="modal fade" id="detailsReminderModal" tabindex="-1" aria-labelledby="detailsReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-check-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="detailsReminderModalLabel">
                            Détails du rappel
                        </h5>
                        <p class="text-muted small mb-0">Informations détaillées sur le rappel</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-phone-line text-primary"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Type</small>
                                <span class="fw-semibold" id="reminder-type">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-time-line text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Date & Heure</small>
                                <span class="fw-semibold" id="reminder-date-time">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-file-text-line text-success"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Objet</small>
                                <span class="fw-semibold" id="reminder-object">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-list-check-2 text-warning"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Statut</small>
                                <span class="badge bg-warning-subtle text-warning px-2 py-1" id="reminder-status">
                                    <i class="ri-time-line me-1" ></i>En attente
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex">
                            <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-file-list-line text-secondary"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Description</small>
                                <span class="fw-semibold" id="reminder-description">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Suppression d'un rappel -->
<div class="modal fade" id="deleteReminderModal" tabindex="-1" aria-labelledby="deleteReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-delete-bin-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteReminderModalLabel">
                            Supprimer le rappel
                        </h5>
                        <p class="text-muted small mb-0">Suppression du rappel/rendez-vous</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                            <i class="ri-error-warning-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer ce rappel ?</h5>
                    <p class="text-muted">
                        La suppression de ce rappel est définitive et ne pourra pas être annulée.
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" id="ConfirmDeleteReminderBtn" class="btn btn-danger px-4 py-2">
                    <i class="ri-delete-bin-line me-2"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Validation Rappel -->
<div class="modal fade" id="validateReminderModal" tabindex="-1" aria-labelledby="validateReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="validateReminderModalLabel">
                            Valider le rappel
                        </h5>
                        <p class="text-muted small mb-0">Confirmer l'exécution du rappel</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Statut</label>
                        <select id="validate_statut_reminder" class="form-select border-0 bg-light py-2">
                            <option value="">Selectionnez une option</option>
                            <option value="annule">Annuler</option>
                            <option value="termine">Terminer</option>
                            <option value="abouti">Abouti</option>
                            <option value="nabouti">Non abouti</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Observations</label>
                        <textarea id="observation_rappel" class="form-control border-0 bg-light" rows="4" placeholder="Entrez vos observations..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmValidateReminderBtn">
                    <i class="ri-check-line me-2"></i>Valider
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modification Fiche de Voeux -->
<div class="modal fade" id="editVoeuxModal" tabindex="-1" aria-labelledby="editVoeuxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-graduation-cap-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="editVoeuxModalLabel">
                            Modifier la fiche de voeux
                        </h5>
                        <p class="text-muted small mb-0">Mise à jour des préférences académiques du pré-inscrit</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Spécialité</label>
                        <select id="specialite_voeux" class="form-select border-0 bg-light py-2">
                            <option value="">Sélectionnez une spécialité</option>
                            <!-- Options à charger dynamiquement -->
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Niveau d'étude</label>
                        <select id="niveau_etude_voeux" class="form-select border-0 bg-light py-2">
                            <option value="">Sélectionnez un niveau</option>
                            <option value="bac">Baccalauréat</option>
                            <option value="licence">Licence</option>
                            <option value="master">Master</option>
                            <option value="doctorat">Doctorat</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Établissement souhaité</label>
                        <input type="text" id="etablissement_voeux" class="form-control border-0 bg-light py-2" placeholder="Entrez l'établissement souhaité">
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Commentaires</label>
                        <textarea id="commentaires_voeux" class="form-control border-0 bg-light" rows="4" placeholder="Entrez vos commentaires..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-info px-4 py-2" id="saveVoeuxBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajout de document -->
<div class="modal fade" id="addDocumentModal" tabindex="-1" aria-labelledby="addDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-folder-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="addDocumentModalLabel">
                            Ajouter un document
                        </h5>
                        <p class="text-muted small mb-0">Ajouter un nouveau document pour le pré-inscrit</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info d-flex align-items-center rounded-3 mb-4">
                    <div class="flex-shrink-0 me-2">
                        <i class="ri-information-line fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-0">
                            <strong>Restrictions :</strong> Les fichiers ne doivent pas dépasser 400 Ko et seuls les fichiers PDF et JPEG sont autorisés.
                        </p>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Nom du document</label>
                        <input type="text" id="documentName" class="form-control border-0 bg-light py-2" placeholder="Entrez le nom du document">
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Type de document</label>
                        <select id="documentType" class="form-select border-0 bg-light py-2">
                           
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Fichier</label>
                        <input type="file" id="documentFile" class="form-control border-0 bg-light py-2">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="saveDocumentBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Suppression Document -->
<div class="modal fade" id="deleteDocumentModal" tabindex="-1" aria-labelledby="deleteDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-delete-bin-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteDocumentModalLabel">
                            Supprimer le document
                        </h5>
                        <p class="text-muted small mb-0">Confirmation de suppression</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                            <i class="ri-error-warning-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer ce document ?</h5>
                    <p class="text-muted">
                        Cette action est irréversible. Le document sera définitivement supprimé.
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteDocumentBtn">
                    <i class="ri-delete-bin-line me-2"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview Document -->
<div class="modal fade" id="previewDocumentModal" tabindex="-1" aria-labelledby="previewDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="previewDocumentModalLabel">Aperçu du document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" style="max-height:80vh; overflow-y:auto;">
        <div id="previewContent" class="text-center">
          <!-- Le contenu du document sera injecté ici -->
        </div>

        <!-- Canvas pour pdf.js -->
        <div id="pdfPreviewContainer" style="display:none;">
            <canvas id="pdfCanvas" style="width:100%; border:1px solid #ccc;"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Validation Impossible -->
<div class="modal fade" id="validationBlockedModal" tabindex="-1" aria-labelledby="validationBlockedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-2 me-2">
                        <i class="ri-alert-line text-warning fs-5"></i>
                    </div>
                    <div>
                        <h6 class="modal-title fw-bold text-warning mb-0" id="validationBlockedModalLabel">
                            Validation impossible
                        </h6>
                        <p class="text-muted small mb-0 fs-7">Conditions non remplies</p>
                    </div>
                </div>
                <button type="button" class="btn-close fs-6" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="text-center mb-3">
                    <div class="avatar-md mx-auto mb-3">
                        <div class="avatar-title bg-warning bg-opacity-10 text-warning display-6 rounded-circle">
                            <i class="ri-indeterminate-circle-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-2 fw-bold">Validation bloquée</h5>
                    <p class="text-muted mb-0 small">
                        Certaines conditions ne sont pas remplies.
                    </p>
                </div>
                
                <div class="alert alert-warning d-flex align-items-center rounded-3 mb-3 p-2">
                    <div class="flex-shrink-0 me-2">
                        <i class="ri-information-line fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading fw-bold mb-0 fs-6">Conditions requises</h6>
                        <p class="mb-0 small">
                            Vous devez remplir toutes les conditions ci-dessous :
                        </p>
                    </div>
                </div>
                
                <div class="row g-2">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-2">
                                        <div class="avatar-xs">
                                            <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle">
                                                <i class="ri-user-line fs-6"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold small">Profil complet</h6>
                                        <p class="text-muted mb-0 small">Informations personnelles requises</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i class="ri-close-circle-line text-danger fs-5" id="profileStatusIcon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-2">
                                        <div class="avatar-xs">
                                            <div class="avatar-title bg-success bg-opacity-10 text-success rounded-circle">
                                                <i class="ri-folder-line fs-6"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold small">Documents complets</h6>
                                        <p class="text-muted mb-0 small">Documents requis manquants</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i class="ri-close-circle-line text-danger fs-5" id="documentsStatusIcon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info d-flex align-items-center rounded-3 mt-3 p-2">
                    <div class="flex-shrink-0 me-2">
                        <i class="ri-lightbulb-line fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading fw-bold mb-0 fs-6">Conseil</h6>
                        <p class="mb-0 small">
                            Corrigez les problèmes ou demandez une validation par un responsable.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light-subtle px-3 py-2">
                <button type="button" class="btn btn-light btn-sm px-3 py-1" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
                <button type="button" class="btn btn-info btn-icon rounded-circle me-2" id="requestValidationBtn" data-bs-toggle="modal" data-bs-target="#requestManagerValidationModal" data-bs-dismiss="modal" title="Demander une validation par un responsable" style="width: 36px; height: 36px; padding: 0;">
                    <i class="ri-shield-user-line fs-6"></i>
                </button>
                <button type="button" class="btn btn-warning btn-sm px-3 py-1" id="fixIssuesBtn">
                    <i class="ri-edit-line me-1"></i>Corriger
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Demande de validation par un responsable -->
<div class="modal fade" id="requestManagerValidationModal" tabindex="-1" aria-labelledby="requestManagerValidationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-shield-user-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="requestManagerValidationModalLabel">
                            Demande de validation
                        </h5>
                        <p class="text-muted small mb-0">Demander une validation par un responsable</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-info bg-opacity-10 text-info display-5 rounded-circle">
                            <i class="ri-shield-user-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Soumettre une demande de validation</h5>
                    <p class="text-muted mb-0">
                        Vous pouvez soumettre une demande de validation pour ce pré-inscrit malgré les documents incomplets. Un responsable examinera votre demande.
                    </p>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Motif de la demande</label>
                        <input id="validationRequestMotif" class="form-control border-0 bg-light" placeholder="Quel motif de dérogation..." />
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-medium">Description</label>
                        <textarea id="validationRequestReason" class="form-control border-0 bg-light" rows="4" placeholder="Expliquez pourquoi vous demandez une validation malgré les documents incomplets..." > </textarea>   
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-info px-4 py-2" id="submitValidationRequestBtn">
                    <i class="ri-send-plane-line me-2"></i>Envoyer la demande
                </button>
            </div>
        </div>  
    </div>
</div>

<!-- Modal Documents Manquants -->
<div class="modal fade" id="missingDocumentsModal" tabindex="-1" aria-labelledby="missingDocumentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-list-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-danger mb-1" id="missingDocumentsModalLabel">
                            <i class="ri-alert-line me-2"></i>Documents manquants
                        </h5>
                        <p class="text-muted small mb-0">Liste des documents obligatoires non fournis</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning d-flex align-items-center rounded-3 mb-4 border-start border-4 border-warning">
                    <div class="flex-shrink-0 me-3">
                        <i class="ri-information-line fs-4 text-warning"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading fw-bold mb-1">Documents requis</h6>
                        <p class="mb-0">
                            Veuillez fournir tous les documents ci-dessous pour compléter le dossier du pré-inscrit.
                        </p>
                    </div>
                </div>
                
                <div class="table-responsive rounded-3 border">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 rounded-start">Document requis</th>
                                <th class="border-0 rounded-end text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="missingDocumentsList" class="border-0">
                            <!-- Les documents manquants seront chargés ici dynamiquement -->
                            <tr>
                                <td colspan="2" class="text-center text-muted py-5">
                                    <div class="spinner-border spinner-border-sm me-2 text-warning" role="status"></div>
                                    <span class="fw-medium">Chargement des documents manquants...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light-subtle px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2 rounded-3" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
                <button type="button" class="btn btn-warning px-4 py-2 rounded-3" id="refreshMissingDocsBtn">
                    <i class="ri-refresh-line me-2"></i>Actualiser
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de la dérogation -->
<div class="modal fade" id="detailsDerogationModal" tabindex="-1" aria-labelledby="detailsDerogationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-info-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="detailsDerogationModalLabel">
                            Détails de la dérogation
                        </h5>
                        <p class="text-muted small mb-0">Informations sur la demande de dérogation</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-file-info-line text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Statut de la dérogation</small>
                                <span class="fw-semibold" id="derogation-status">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-calendar-line text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Date de la demande</small>
                                <span class="fw-semibold" id="derogation-date-demande">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-calendar-line text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Date de traitement</small>
                                <span class="fw-semibold" id="derogation-date-traitement">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex mb-4">
                            <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-file-text-line text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Motif de la demande</small>
                                <span class="fw-semibold" id="derogation-motif-demande">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex">
                            <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="ri-file-text-line text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Commentaire du traitement</small>
                                <span class="fw-semibold" id="derogation-commentaire-traitement">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
    $(document).ready(function(){
        // Activer les tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
        
        let id  = "{{ pk }}";
        var hasHandicap=null;

        // Fonction pour charger les notes
        function loadNotes(){
            $.ajax({
                url :"{% url 't_crm:ApiLoadNotePr' %}",
                dataType: "JSON",
                type : 'GET',
                data:{'id_prospect' : id},
                success: function(data){
                    var html = "";

                    if (data.length > 0){
                        $.each(data, function(index, item){
                            html +='<div class="border-start border-4 border-warning ps-4 py-2 bg-white rounded-end">';
                            html +='<div class="d-flex justify-content-between align-items-start mb-2">';
                            html +='<div class="d-flex align-items-center">';
                            html +='<div class="avatar-sm me-3"><div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle fs-5">JM</div></div>';
                            html +='<div><h6 class="mb-0 fw-semibold">'+item.created_by__username+'</h6><small class="text-muted">'+item.created_at+'</small></div>';
                            html +='</div>';
                            html +='<div class="dropdown">';
                            html +='<button class="btn btn-icon btn-sm btn-ghost-secondary" data-bs-toggle="dropdown"><i class="ri-more-2-fill"></i></button>';
                            html +='<ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">';
                            html +='<li><button class="dropdown-item d-flex align-items-center" type="button" data-bs-toggle="modal" data-bs-target="#editNoteModal"><i class="ri-edit-line me-2"></i>Modifier</button></li>';
                            html +='<li><button class="dropdown-item d-flex align-items-center" type="button" data-bs-toggle="modal" data-id="'+item.id+'" id="deleteNoteBtn"><i class="ri-delete-bin-line me-2"></i>Supprimer</button></li>';
                            html +='</ul>';
                            html +='</div>';
                            html +='</div>';
                            html +='<p class="mb-3">'+item.note+'</p>';
                            html +='<div class="d-flex gap-2">';
                            html +='<span class="badge bg-warning-subtle text-warning">'+item.tage+'</span>';
                            html +='</div>';
                            html +='</div>';
                        });
                    }else{
                            html +='<button type="button" class="border-start border-4 border-dashed border-warning ps-4 py-4 bg-white rounded-end text-start w-100" data-bs-toggle="modal" data-bs-target="#addNoteModal">';
                            html +='<div class="d-flex align-items-center">';
                            html +='<div class="avatar-sm me-3">';
                            html +='<div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle fs-5">';
                            html +='<i class="ri-add-line"></i>';
                            html +='</div>';
                            html +='</div>';
                            html +='<div>';
                            html +='<h6 class="fw-medium text-warning mb-0">Ajouter une note</h6>';
                            html +='<small class="text-muted">Cliquez pour ajouter une nouvelle note</small>';
                            html +='</div>';
                            html +='</div>';
                            html +='</button>';
                    }

                    $('#ListeDesNotes').html(html);
                }
            });
        }

        // Fonction pour charger la fiche de voeux
        function loadFicheVoeux(){
            $.ajax({
                url : "{% url 't_crm:ApiLoadFicheVoeuxProspect' %}",
                dataType : 'JSON',
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(data){
                    var html="";
                    if (data.fiche_voeux.length > 0){
                        $.each(data.fiche_voeux, function(index, item){
                            html += '<div class="col-12 col-md-4 text-center mb-4 mb-md-0">';
                                    html += '<div class="avatar-lg mx-auto mb-4">';
                                        html += '<div class="avatar-title bg-info bg-opacity-10 text-info display-5 rounded-circle">';
                                            html += '<i class="ri-school-line"></i>';
                                        html += '</div>';
                                    html += '</div>';
                                    html += '<h6 class="fw-semibold mb-2">Spécialité</h6>';
                                    html += '<p class="text-muted mb-0">'+item.specialite_label+'</p>';
                                     html += '<h6 class="fw-semibold mb-2 mt-3">Promotion/Session</h6>';
                                    html += '<p class="text-muted mb-0">'+item.promo+'</p>';
                                html += '</div>';
                                html += '<div class="col-12 col-md-8 d-flex align-items-center">';
                                    html += '<div class="vstack gap-4 w-100">';
                                        html += '<div class="d-flex align-items-center justify-content-center">';
                                            html += '<div class="d-flex align-items-center bg-light rounded-3 p-3 w-100">';
                                                html += '<div class="flex-shrink-0">';
                                                    html += '<div class="avatar-sm">';
                                                        html += '<div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle">';
                                                            html += '<i class="ri-calendar-line fs-5"></i>';
                                                        html += '</div>';
                                                    html += '</div>';
                                                html += '</div>';
                                                html += '<div class="flex-grow-1 ms-3 text-center">';
                                                    html += '<h6 class="mb-1">Date de création</h6>';
                                                    html += '<small class="text-muted">'+item.created_at+'</small>';
                                                html += '</div>';
                                            html += '</div>';
                                        html += '</div>';

                                        html += '<div class="d-flex align-items-center justify-content-center">';
                                            html += '<div class="d-flex align-items-center bg-light rounded-3 p-3 w-100">';
                                                html += '<div class="flex-shrink-0">';
                                                    html += '<div class="avatar-sm">';
                                                        html += '<div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle"><i class="ri-time-line fs-5"></i></div>';
                                                    html += '</div>';
                                                html += '</div>';
                                                html += '<div class="flex-grow-1 ms-3 text-center"><h6 class="mb-1">Dernière mise à jour</h6><small class="text-muted">'+item.updated_at+'</small></div>';
                                            html += '</div>';
                                        html += '</div>';
                                        
                                    html += '</div>';
                                html += '</div>';

                                $('#editVoeuxBtn').data('id',item.id);
                        });
                    }else{
                        html += '<div class="col-12 text-center py-5">';
                        html += '<div class="avatar-lg mx-auto mb-4">';
                        html += '<div class="avatar-title bg-light text-muted display-5 rounded-circle">';
                        html += '<i class="ri-file-search-line"></i>';
                        html += '</div>';
                        html += '</div>';
                        html += '<h5 class="mb-3">Aucune fiche de vœux disponible</h5>';
                        html += '<p class="text-muted mb-4">Ce prospect n\'a pas encore de fiche de vœux enregistrée.</p>';
                        html += '<button type="button" class="btn btn-soft-primary px-4 py-2" data-bs-toggle="modal" data-bs-target="#voeuxModal">';
                        html += '<i class="ri-add-line me-2"></i>Créer une fiche de vœux';
                        html += '</button>';
                        html += '</div>';
                    }

                    $('#preinscritVoeuxDetails').html(html);

                }
            });
        }

        // Fonction pour charger les informations personnelles
        function loadPersonalInfos(){
            
            $.ajax({
                url : "{% url 't_crm:ApiLoadPreinscrisPerosnalInfos' %}",
                dataType : 'JSON',
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(data){
                    $('#nom_prenom').text(data.nom + ' ' + data.prenom);
                    $('#email').text(data.email);
                    $('#phone').text(data.telephone);
                    $('#created_at').text(data.created_at);
                    $('#statut_preinscrit').text(data.statut);
                    
                    
                    

                    $('#profile_nom_arabe').text(data.nom_arabe);
                    $('#profile_prenom_arabe').text(data.prenom_arabe);
                    $('#profile_date_naissance').text(data.date_naissance);
                    $('#profile_lieu_naissance').text(data.lieu_naissance);
                    $('#profile_pays').text(data.pays);
                    $('#profile_wilaya').text(data.wilaya);
                    $('#profile_code_zip').text(data.code_zip);
                    $('#profile_nin').text(data.nin);
                    $('#profile_prenom_pere').text(data.prenom_pere);
                    $('#profile_tel_pere').text(data.tel_mere);
                    $('#profile_nom_mere').text(data.nom_mere);
                    $('#profile_prenom_mere').text(data.prenom_mere);
                    $('#profile_tel_mere').text(data.tel_mere);
                    $('#profile_has_handicap').text(data.has_endicap);
                    $('#profile_type_handicap').text(data.type_handicap);
                    $('#profile_groupe_sanguin').text(data.groupe_sanguin);
                    $('#profile_adresse').text(data.adresse);
                    $('#profile_niveau_scolaire').text(data.niveau_scolaire);
                    $('#profile_diplome').text(data.diplome);
                    $('#profile_etablissement_diplome').text(data.etablissement);

                    
                    $('#nom_arabe').val(data.nom_arabe);
                    $('#prenom_arabe').val(data.prenom_arabe);
                    $('#date_naissance').val(data.date_naissance);
                    $('#nin').val(data.nin);
                    $('#prenom_pere').val(data.prenom_pere);
                    $('#tel_pere').val(data.tel_pere);
                    $('#nom_mere').val(data.nom_mere);
                    $('#prenom_mere').val(data.prenom_mere);
                    $('#tel_mere').val(data.tel_mere);
                    $('#type_handicap').val(data.type_handicap);
                    $('#groupe_sanguin').val(data.groupe_sanguin);
                    $('#adresse_prospect').val(data.adresse);
                    $('#niveau_scolaire').val(data.niveau_scolaire_pure);
                    $('#diplome').val(data.diplome);
                    $('#etablissement_diplome').val(data.etablissement);
                    $('#pays').val(data.pays);
                    $('#wilaya').val(data.wilaya);
                    $('#code_zip').val(data.code_zip);
                    $('#lieu_naissance').val(data.lieu_naissance);
                }
            });
        }

        // Fonction pour charger les rappels/rendez-vous
        function loadRappelRendezVous(){
            $.ajax({
                url : "{% url 't_crm:ApiLoadPreinscritRendezVous' %}",
                dataType: "JSON",
                type : "GET",
                data : {"id_prospect" : id},
                success : function(data){
                    var row = "";
                    if (data.length > 0){
                        $.each(data, function(index, item){
                            var statutBreak = "";
                            switch(item.statut){
                                case "nabouti":
                                    statutBreak = '<span class="badge bg-primary-subtle text-primary px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "abouti":
                                    statutBreak = '<span class="badge bg-success-subtle text-success px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "termine":
                                    statutBreak = '<span class="badge bg-danger-subtle text-danger px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "nabouti":
                                    statutBreak = '<span class="badge bg-dark-subtle text-dark px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "en_attent":
                                    statutBreak = '<span class="badge bg-warning-subtle text-warning px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "annule":
                                    statutBreak = '<span class="badge bg-danger-subtle text-danger px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                            }
                            row += '<tr>';
                                row += '<td>';
                                    row += '<div class="d-flex align-items-center">';
                                        row += '<div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-2">';
                                            row += (item.type =="appel") ? '<i class="ri-phone-line text-primary"></i>' : '<i class="ri-calendar-line text-primary"></i>';
                                        row += '</div>';
                                        row += '<span>' + item.type_label + '</span>';
                                    row += '</div>';
                                row += '</td>';
                                row += '<td>';
                                    row += '<div class="text-body">';
                                        row += '<i class="ri-time-line text-muted me-2"></i>' + item.created_at + '';
                                    row += '</div>';
                                row += '</td>';
                                row += '<td>';
                                    row += '<div class="text-wrap" style="max-width: 200px;">';
                                        row += '' + item.object + '';
                                    row += '</div>';
                                row += '</td>';
                                row += '<td>';
                                    row += ''+statutBreak+'';
                                row += '</td>';
                                row += '<td class="text-end">';
                                    row += '<div class="d-flex justify-content-end gap-2">';
                                        row += '<button class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" id="editReminderBtn" data-id=' + item.id + '  title="Modifier">';
                                            row += '<i class="ri-edit-line"></i>';
                                        row += '</button>';
                                        row += '<button class="btn btn-soft-info btn-sm" data-bs-toggle="modal" id="detailsReminderBtn" data-id=' + item.id + '  title="Détails">';
                                            row += '<i class="ri-eye-line"></i>';
                                        row += '</button>';
                                        row += '<button class="btn btn-soft-success btn-sm" data-bs-toggle="modal" id="validateReminderBtn" data-id=' + item.id + '  title="Valider">';
                                            row += '<i class="ri-check-line"></i>';
                                        row += '</button>';
                                        row += '<button class="btn btn-soft-danger btn-sm" data-bs-toggle="modal" id="deleteReminderBtn" data-id=' + item.id + '  title="Supprimer">';
                                            row += '<i class="ri-delete-bin-line"></i>';
                                        row += '</button>';
                                    row += '</div>';
                                row += '</td>';
                            row += '</tr>';
                        });
                    }else{
                        row +="<tr>";
                            row += "<td colspan='5' class='text-center text-muted'>Aucun rappel ou rendez-vous trouvé</td>";
                        row += "</tr>";
                    }

                    $('#listeDesRendezVous').html(row);
                }
            });
        }
        
        // Fonction pour charger les documents
        function loadDocuments(){
            $.ajax({
                url : "{% url 't_crm:LoadPresinscritDocs' %}",
                dataType : "JSON",
                type: 'GET',
                data : {
                    'id_preinscrit' : id,
                },
                success : function(data){
                    var row = "";
                    if(data.length > 0){
                        $.each(data, function(index, item){
                            row += "<tr>";
                                row +="<td>"+item.label+"</td>";
                                row +="<td>"+item.id_document__label+"</td>";
                                row +="<td>"+item.created_at+"</td>";
                                row +="<td class='text-end'>";
                                    row +="<div class='d-flex justify-content-end gap-2'>";
                                        row +="<button data-url='"+item.file+"' class='btn btn-soft-info btn-sm view-doc' title='Voir'>";
                                            row +="<i class='ri-eye-line'></i>";
                                        row +="</button>";
                                        row +="<button class='btn btn-soft-success btn-sm download-doc' data-url='"+item.file+"' title='Télécharger'>";
                                            row +="<i class='ri-download-line'></i>";
                                        row +="</button>";
                                        row +="<button class='btn btn-soft-danger btn-sm delete-doc' data-id='"+item.id+"' title='Supprimer'>";
                                            row +="<i class='ri-delete-bin-line'></i>";
                                        row +="</button>";
                                    row +="</div>";
                                row +="</td>";

                            row += "</tr>";
                        });
                    }else{
                        var row = "<tr><td colspan='4' class='text-muted text-center'>Aucun document n'a été enregistrer</td></tr>";
                    }
                    $('#listeDesDocuments').html(row);
                }
            });
        }

        function CheckCompletedInfos(){
            $.ajax({
                url : "{% url 't_crm:ApiCheckHasCompletedProfile' %}",
                dataType : "JSON",
                type : "GET",
                data : {'id_preinscrit' : id},
                success : function(response){
                    if(response.profile_completed.profile_completed  == "false"){
                        document.getElementById('incompleted_infos').hidden = false;
                    }else{
                        document.getElementById('incompleted_infos').hidden = true;
                    }
                }
            });
        }

        CheckCompletedInfos();

        function CheckCompletedDocs(){
            $.ajax({
                url :"{% url 't_crm:ApiCheckCompletedDoc' %}",
                dataType: "JSON",
                type: "GET",
                data : {'id_preinscrit' : id},

                success: function(response){
                    if(response.has_completed_doc === true){
                        document.getElementById('non_completed_docs').hidden = true;
                        document.getElementById('completed_docs').hidden = false;
                    } else {
                        document.getElementById('non_completed_docs').hidden = false;
                        document.getElementById('completed_docs').hidden = true;
                    }
                }
            });
        }

        function loadSelectDocuement(){
            $.ajax({
                url : "{% url 't_crm:ApiLoadRequiredDocs' %}",
                dataType : "JSON",
                type : 'GET',
                data : {'id_preinscrit' : id},
                success : function(data){
                    var option ="<option value=''>Veuillez selection un type de document</option>";
                    $.each(data, function(index, item){
                        option += "<option value="+item.id+">"+item.label+"</option>"
                    });
                    $('#documentType').html(option);
                    
                },
            })
        }

        function loadMissingFiles(){
            $.ajax({
                url : "{% url 't_crm:check_all_required_docs' %}",
                dataType: "JSON",
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(data){

                }
            })
        }

        function handleDocs(){
             $.ajax({
                url: "{% url 't_crm:check_all_required_docs' %}",
                dataType: "JSON",
                type: 'GET',
                data: {'id_prospect': id},
                success: function(data) {
                    var html = "";
                    
                    if (data.missing_docs && data.missing_docs.length > 0) {
                        document.getElementById('non_completed_docs').hidden = false;
                        document.getElementById('completed_docs').hidden = true;
                    } else {
                        document.getElementById('non_completed_docs').hidden = true;
                        document.getElementById('completed_docs').hidden = false;
                        
                    }
                    
                },
                error: function() {
                    $('#missingDocumentsList').html(
                        "<tr><td colspan='2' class='text-center text-danger'>Erreur lors du chargement des documents</td></tr>"
                    );
                }
            });
        }


        // Initialisation
        loadNotes();
        loadFicheVoeux();
        loadPersonalInfos();
        loadRappelRendezVous();
        loadDocuments();
        //CheckCompletedDocs();
        
        // Initialiser l'état des boutons de navigation
        updateNavigationButtons();

        // Gestionnaires d'événements
        $(document).on('click', '#addNoteModalBtn', function(){
            $('#addNoteModal').modal('show');
        });

        $(document).on('click', '#addReminderBtn', function(){
            $('#addReminderModal').modal('show');
        });

        $(document).on('click', '#saveReminderBtn', function(){
            var type = $('#reminderType').val();
            var subject = $('#reminderSubject').val();
            var date = $('#reminderDate').val();
            var time = $('#reminderTime').val();
            var description = $('#reminderDescription').val();

            $.ajax({
                url: "{% url 't_crm:ApiStoreRappelPreinscrit' %}",
                dataType: 'JSON',
                type: 'POST',
                data: {
                    'type': type,
                    'subject': subject,
                    'date': date,
                    'time': time,
                    'description': description,
                    'id_prospect' : id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.status === 'success') {
                        $('#addReminderModal').modal('hide');
                        loadRappelRendezVous();
                        alertify.success(data.message);
                    } else {
                        alertify.error(data.message);
                    }
                }
            });
        });

        $(document).on('click', '#saveNoteBtn', function(){
            var content = $('#content_note').val();
            var tags  = $('#note_tags').val();
            if (content === ""){
                alert("Le contenu de la note ne peut pas être vide.");
                return;
            }
            $.ajax({
                url : "{% url 't_crm:ApiStoreNotePreinscrit' %}",
                dataType : 'JSON',
                type : 'POST',
                data : {
                    'id_prospect' : id,
                    'content' : content,
                    'tags' : tags,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },
                success : function(data){
                    if (data.status === 'success'){
                        $('#addNoteModal').modal('hide');
                        loadNotes();
                        $('#content_note').val('');
                        alertify.success(data.message);
                    }else{
                        alert("Erreur lors de l'enregistrement de la note. Veuillez réessayer.");
                        alertify.error(data.message);
                    }
                }
            });
        });

        //bouton de validation de la préinscription
        $(document).on('click', '#validatePreinscritBtn', function(){
            // Vérifier si le profil et les documents sont complets avant de permettre la validation
            let profileCompleted = null;
            let documentsCompleted = null;
            
            // Vérifier la complétude du profil
            $.ajax({
                url: "{% url 't_crm:ApiCheckHasCompletedProfile' %}",
                dataType: "JSON",
                type: "GET",
                data: {'id_preinscrit': id},
                success: function(response) {
                    profileCompleted = response.profile_completed.profile_completed  === "true";
                    updateValidationStatus(profileCompleted, documentsCompleted);
                },
                error: function() {
                    profileCompleted = false;
                    updateValidationStatus(profileCompleted, documentsCompleted);
                }
            });
            
            // Vérifier la complétude des documents
            $.ajax({
                url: "{% url 't_crm:check_all_required_docs' %}",
                dataType: "JSON",
                type: 'GET',
                data: {'id_prospect': id},
                success: function(data) {
                    documentsCompleted = !(data.missing_docs && data.missing_docs.length > 0);
                    updateValidationStatus(profileCompleted, documentsCompleted);
                },
                error: function() {
                    documentsCompleted = false;
                    updateValidationStatus(profileCompleted, documentsCompleted);
                }
            });
            
            // Fonction pour mettre à jour l'état de validation
            function updateValidationStatus(profileCompleted, documentsCompleted) {
                // Mettre à jour l'interface de la modale de blocage
                if (profileCompleted === true) {
                    $('#profileStatusIcon').removeClass('ri-close-circle-line text-danger').addClass('ri-checkbox-circle-line text-success');
                } else if (profileCompleted === false) {
                    $('#profileStatusIcon').removeClass('ri-checkbox-circle-line text-success').addClass('ri-close-circle-line text-danger');
                }
                
                if (documentsCompleted === true) {
                    $('#documentsStatusIcon').removeClass('ri-close-circle-line text-danger').addClass('ri-checkbox-circle-line text-success');
                } else if (documentsCompleted === false) {
                    $('#documentsStatusIcon').removeClass('ri-checkbox-circle-line text-success').addClass('ri-close-circle-line text-danger');
                }
                
                // Si les deux vérifications sont terminées
                if (profileCompleted !== null && documentsCompleted !== null) {
                    if (profileCompleted && documentsCompleted) {
                        // Tous les critères sont remplis, afficher la modale de validation
                        $('#validatePreinscritModal').modal('show');
                    } else {
                        // Au moins un critère n'est pas rempli, afficher la modale de blocage
                        $('#validationBlockedModal').modal('show');
                    }
                }
            }
        });

        // Gestionnaire pour le bouton "Corriger les problèmes"
        $(document).on('click', '#fixIssuesBtn', function(){
            $('#validationBlockedModal').modal('hide');
            
            // Vérifier à nouveau les statuts pour déterminer où rediriger l'utilisateur
            $.ajax({
                url: "{% url 't_crm:ApiCheckHasCompletedProfile' %}",
                dataType: "JSON",
                type: "GET",
                data: {'id_preinscrit': id},
                success: function(response) {
                    let profileCompleted = response.profile_completed === "true";
                    
                    $.ajax({
                        url: "{% url 't_crm:check_all_required_docs' %}",
                        dataType: "JSON",
                        type: 'GET',
                        data: {'id_prospect': id},
                        success: function(data) {
                            let documentsCompleted = !(data.missing_docs && data.missing_docs.length > 0);
                            
                            // Rediriger selon les problèmes identifiés
                            if (!profileCompleted && !documentsCompleted) {
                                // Les deux sont incomplets, demander à l'utilisateur ce qu'il veut corriger en premier
                                alertify.confirm(
                                    "Problèmes multiples",
                                    "Le profil et les documents sont incomplets. Voulez-vous d'abord compléter le profil ?",
                                    function(){
                                        // Oui, compléter le profil
                                        $('#completeAdditionalInfoBtn').click();
                                    },
                                    function(){
                                        // Non, voir les documents manquants
                                        $('#missingDocumentsModal').modal('show');
                                    }
                                ).set('labels', {ok:'Compléter le profil', cancel:'Voir documents manquants'});
                            } else if (!profileCompleted) {
                                // Seulement le profil est incomplet
                                $('#completeAdditionalInfoBtn').click();
                            } else if (!documentsCompleted) {
                                // Seulement les documents sont incomplets
                                $('#missingDocumentsModal').modal('show');
                            }
                        }
                    });
                }
            });
        });

        $(document).on('click', '#confirmeValidationBtn', function(){
            // Simulation de validation
            $('#validatePreinscritModal').modal('hide');
            alertify.success("Pré-inscription validée avec succès");
        });

     

        $(document).on('click', '#editVoeuxBtn', function(){
            $('#editVoeuxModal').modal('show');
        });

        $(document).on('click', '#saveVoeuxBtn', function(){
            // Simulation d'enregistrement des voeux
            $('#editVoeuxModal').modal('hide');
            alertify.success("Fiche de voeux mise à jour avec succès");
        });

        // Gestion des documents
        $(document).on('click', '#addDocumentBtn', function(){
            loadSelectDocuement();
            $('#addDocumentModal').modal('show');
        });

        // Gestion de la suppression des documents
        $(document).on('click', '.delete-doc', function(){
            documentIdToDelete = $(this).data('id');
            $('#deleteDocumentModal').modal('show');
            $('#confirmDeleteDocumentBtn').data('id', documentIdToDelete);
        });

        $(document).on('click', '#confirmDeleteDocumentBtn', function(){
            var confirmDeleteDocumentBtn = $(this).data('id')
            if(documentIdToDelete !== null){
                // Appel AJAX pour supprimer le document
                $.ajax({
                    url: "{% url 't_crm:DeleteDocumentPreinscrit' %}",
                    dataType: "JSON",
                    type: 'POST',
                    data: {
                        'id_document': documentIdToDelete,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response){
                        if(response.status === "success"){
                            alertify.success(response.message);
                            // Recharger la liste des documents
                            loadDocuments();
                            // Fermer la modale
                            $('#deleteDocumentModal').modal('hide');
                            // Réinitialiser l'ID du document à supprimer
                            documentIdToDelete = null;

                            handleDocs();
                        } else {
                            alertify.error(response.message);
                        }
                    },
                    error: function(){
                        alertify.error("Erreur lors de la suppression du document");
                    }
                });
            }
        });

        // Gestion du téléchargement des documents
        $(document).on('click', '.download-doc', function(){
            var documentUrl = $(this).data('url');
            // Créer un élément <a> temporaire pour déclencher le téléchargement
            var link = document.createElement('a');
            link.href = documentUrl;
            link.download = ''; // Le nom du fichier sera déterminé par le serveur
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Gestion des informations supplémentaires
        $(document).on('click', '#completeAdditionalInfoBtn', function(){
            $('#additionalInfoModal').modal('show');
        });


        function loadProfileDetails() {
            $.ajax({
                url: "{% url 't_crm:ApiLoadPreinscrisPerosnalInfos' %}",
                dataType: "JSON",
                type: "GET",
                data: {'id_preinscrit': id},
                success: function(data) {
                    // Informations d'identité
                    $('#profile_nom_arabe').text(data.nom_arabe || '-');
                    $('#profile_prenom_arabe').text(data.prenom_arabe || '-');
                    $('#profile_date_naissance').text(data.date_naissance || '-');
                    $('#profile_nin').text(data.nin || '-');
                    
                    // Informations des parents
                    $('#profile_prenom_pere').text(data.prenom_pere || '-');
                    $('#profile_tel_pere').text(data.tel_pere || '-');
                    $('#profile_nom_mere').text(data.nom_mere || '-');
                    $('#profile_prenom_mere').text(data.prenom_mere || '-');
                    $('#profile_tel_mere').text(data.tel_mere || '-');
                    
                    // Informations médicales
                    var hasHandicap = data.has_handicap === true ? 'Oui' : (data.has_handicap === false ? 'Non' : '-');
                    $('#profile_has_handicap').text(hasHandicap);
                    $('#profile_type_handicap').text(data.type_handicap || '-');
                    $('#profile_groupe_sanguin').text(data.groupe_sanguin || '-');
                    
                    // Informations de contact
                    $('#profile_adresse').text(data.adresse || '-');
                    
                    // Informations académiques
                    $('#profile_niveau_scolaire').text(data.niveau_scolaire || '-');
                    $('#profile_diplome').text(data.diplome || '-');
                    $('#profile_etablissement_diplome').text(data.etablissement_diplome || '-');
                },
                error: function() {
                    alertify.error("Erreur lors du chargement des détails du profil");
                }
            });
        }

        // Navigation entre les onglets avec les boutons Précédent/Suivant
        function updateNavigationButtons() {
            var activeTab = $('.nav-tabs .nav-link.active');
            var prevTab = activeTab.parent().prev('li').find('.nav-link');
            var nextTab = activeTab.parent().next('li').find('.nav-link');
            
            // Mettre à jour l'état des boutons
            if (prevTab.length === 0) {
                $('#prevTabBtn').prop('disabled', true);
            } else {
                $('#prevTabBtn').prop('disabled', false);
            }
            
            if (nextTab.length === 0) {
                $('#nextTabBtn').hide();
                $('#saveAdditionalInfoBtn').show();
            } else {
                $('#nextTabBtn').show();
                $('#saveAdditionalInfoBtn').hide();
            }
        }

        // Lorsque les onglets changent, mettre à jour les boutons
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            updateNavigationButtons();
        });

        $(document).on('click', '#nextTabBtn', function(){
            var activeTab = $('.nav-tabs .nav-link.active');
            var nextTab = activeTab.parent().next('li').find('.nav-link');
            
            if (nextTab.length > 0) {
                nextTab.tab('show');
            }
            updateNavigationButtons();
        });

        $(document).on('click', '#prevTabBtn', function(){
            var activeTab = $('.nav-tabs .nav-link.active');
            var prevTab = activeTab.parent().prev('li').find('.nav-link');
            
            if (prevTab.length > 0) {
                prevTab.tab('show');
            }
            updateNavigationButtons();
        });

        // Gestion du clavier (touche Entrée) pour naviguer entre les onglets
        $('#additionalInfoModal').on('keydown', 'input, select, textarea', function(e) {
            if (e.which === 13) { // Touche Entrée
                e.preventDefault();
                $('#nextTabBtn').click();
            }
        });

        // Initialiser l'état des boutons quand la modale s'ouvre
        $('#additionalInfoModal').on('shown.bs.modal', function () {
            updateNavigationButtons();
        });

        $(document).on('click', '#saveAdditionalInfoBtn', function(){
            // Récupération des valeurs de tous les champs
            var formData = {
                // Identité
                'nom_arabe': $('#nom_arabe').val(),
                'prenom_arabe': $('#prenom_arabe').val(),
                'date_naissance': $('#date_naissance').val(),
                'nin': $('#nin').val(),
                
                // Parents
                'prenom_pere': $('#prenom_pere').val(),
                'tel_pere': $('#tel_pere').val(),
                'nom_mere': $('#nom_mere').val(),
                'prenom_mere': $('#prenom_mere').val(),
                'tel_mere': $('#tel_mere').val(),
                
                // Médical
                'has_handicap': $('#has_handicap').val(),
                'type_handicap': $('#type_handicap').val(),
                'groupe_sanguin': $('#groupe_sanguin').val(),
                
                // Adresse
                'adresse': $('#adresse_prospect').val(),
                
                // Académique
                'niveau_scolaire': $('#niveau_scolaire').val(),
                'diplome': $('#diplome').val(),
                'etablissement_diplome': $('#etablissement_diplome').val()
            };
            
            // Préparation des données pour l'affichage dans la modale de confirmation
            var confirmationHtml = "";
            
            // Identité
            confirmationHtml += '<div class="col-12"><h5 class="text-primary fw-bold border-bottom pb-2 mb-3">Informations d\'identité</h5></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Nom en arabe</p><h6 class="mb-0">' + (formData.nom_arabe || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Prénom en arabe</p><h6 class="mb-0">' + (formData.prenom_arabe || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Date de naissance</p><h6 class="mb-0">' + (formData.date_naissance || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">N° identification national (NIN)</p><h6 class="mb-0">' + (formData.nin || '-') + '</h6></div></div>';
            
            // Parents
            confirmationHtml += '<div class="col-12 mt-3"><h5 class="text-success fw-bold border-bottom pb-2 mb-3">Informations des parents</h5></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Prénom père</p><h6 class="mb-0">' + (formData.prenom_pere || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Téléphone père</p><h6 class="mb-0">' + (formData.tel_pere || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Nom mère</p><h6 class="mb-0">' + (formData.nom_mere || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Prénom mère</p><h6 class="mb-0">' + (formData.prenom_mere || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Téléphone mère</p><h6 class="mb-0">' + (formData.tel_mere || '-') + '</h6></div></div>';
            
            // Médical
            confirmationHtml += '<div class="col-12 mt-3"><h5 class="text-warning fw-bold border-bottom pb-2 mb-3">Informations médicales</h5></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Handicap</p><h6 class="mb-0">' + (formData.has_handicap || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Type handicap</p><h6 class="mb-0">' + (formData.type_handicap || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Groupe sanguin</p><h6 class="mb-0">' + (formData.groupe_sanguin || '-') + '</h6></div></div>';
            
            // Adresse
            confirmationHtml += '<div class="col-12 mt-3"><h5 class="text-info fw-bold border-bottom pb-2 mb-3">Informations de contact</h5></div>';
            confirmationHtml += '<div class="col-12"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Adresse</p><h6 class="mb-0">' + (formData.adresse || '-') + '</h6></div></div>';
            
            // Académique
            confirmationHtml += '<div class="col-12 mt-3"><h5 class="text-primary fw-bold border-bottom pb-2 mb-3">Informations académiques</h5></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Niveau scolaire</p><h6 class="mb-0">' + (formData.niveau_scolaire || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-md-6"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Diplôme</p><h6 class="mb-0">' + (formData.diplome || '-') + '</h6></div></div>';
            confirmationHtml += '<div class="col-12"><div class="bg-light rounded-3 p-3 h-100"><p class="mb-1 text-muted">Établissement d\'obtention du diplôme</p><h6 class="mb-0">' + (formData.etablissement_diplome || '-') + '</h6></div></div>';
            
            // Affichage des données dans la modale de confirmation
            $('#confirmationDetails').html(confirmationHtml);
            
            // Affichage de la modale de confirmation
            $('#additionalInfoModal').modal('hide');
            $('#confirmAdditionalInfoModal').modal('show');
        });

        function loadDataToUpdate(pays,wilaya,code_zip,lieu_naissance,nom_arabe,prenom_arabe,date_naissance,nin,prenom_pere,tel_pere,nom_mere,prenom_mere,tel_mere,has_handicap,type_handicap,groupe_sanguin,adresse,niveau_scolaire,diplome,etablissement_diplome){
            $.ajax({
                url : "{% url 't_crm:ApiUpdatePreinscritInfos' %}",
                dataType: "JSON",
                type : "POST",
                data : {
                    'nom_arabe' : nom_arabe,
                    'prenom_arabe' : prenom_arabe,
                    'date_naissance' : date_naissance,
                    'nin' : nin,
                    'prenom_pere' : prenom_pere,
                    'tel_pere' : tel_pere,
                    'nom_mere' : nom_mere,
                    'prenom_mere' : prenom_mere,
                    'tel_mere' : tel_mere,
                    'has_handicap' : has_handicap,
                    'type_handicap' : type_handicap,
                    'groupe_sanguin' : groupe_sanguin,
                    'adresse' : adresse,
                    'niveau_scolaire' : niveau_scolaire,
                    'diplome' : diplome,
                    'etablissement_diplome' : etablissement_diplome,
                    'id_preinscrit' : id,
                    'pays' : pays,
                    'wilaya' : wilaya,
                    'code_zip' : code_zip,
                    'lieu_naissance' : lieu_naissance,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },

                success : function(response){
                    if (response.status == "success"){
                            alertify.success(response.message);
                            $('#confirmAdditionalInfoModal').modal('hide');
                            loadPersonalInfos();    
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requête");
                    }
                }
            })
        }
        
        $(document).on('click', '#confirmSaveAdditionalInfoBtn', function(){
            // Récupération des valeurs des champs sous forme de variables individuelles
            var nom_arabe = $('#nom_arabe').val();
            var prenom_arabe = $('#prenom_arabe').val();
            var date_naissance = $('#date_naissance').val();
            var nin = $('#nin').val();
            var prenom_pere = $('#prenom_pere').val();
            var tel_pere = $('#tel_pere').val();
            var nom_mere = $('#nom_mere').val();
            var prenom_mere = $('#prenom_mere').val();
            var tel_mere = $('#tel_mere').val();
            var has_handicap = $('#has_handicap').val();
            var type_handicap = $('#type_handicap').val();
            var groupe_sanguin = $('#groupe_sanguin').val();
            var adresse = $('#adresse_prospect').val();
            var niveau_scolaire = $('#niveau_scolaire').val();
            var diplome = $('#diplome').val();
            var etablissement_diplome = $('#etablissement_diplome').val();


            var pays = $('#pays').val();
            var wilaya = $('#wilaya').val();
            var code_zip = $('#code_zip').val();
            var lieu_naissance = $('#lieu_naissance').val();
            
                       
            // Vérification du dossier incomplet
            var isDossierIncomplet = false;
            var champsManquants = [];
            
            // Vérifier les champs obligatoires
            if (!nom_arabe) {
                isDossierIncomplet = true;
                champsManquants.push('Nom en arabe');
            }
            if (!prenom_arabe) {
                isDossierIncomplet = true;
                champsManquants.push('Prénom en arabe');
            }
            if (!date_naissance) {
                isDossierIncomplet = true;
                champsManquants.push('Date de naissance');
            }
            
            
            // Afficher une notification si le dossier est incomplet
            if (isDossierIncomplet) {
                alertify.error("Dossier incomplet. Champs manquants : " + champsManquants.join(', '));
                
            }else{
                loadDataToUpdate(pays,wilaya,code_zip,lieu_naissance,nom_arabe,prenom_arabe,date_naissance,nin,prenom_pere,tel_pere,nom_mere,prenom_mere,tel_mere,has_handicap,type_handicap,groupe_sanguin,adresse,niveau_scolaire,diplome,etablissement_diplome)
            }
                      
        });

        
        document.getElementById("saveDocumentBtn").addEventListener("click", function () {
            let formData = new FormData();
            formData.append("name", document.getElementById("documentName").value);
            formData.append("type", document.getElementById("documentType").value);
            formData.append("file", document.getElementById("documentFile").files[0]);
            formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
            formData.append("id_prospect", id); 

            fetch("{% url 't_crm:add_document' %}", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    alertify.success("Le document a été ajouter avec succes");
                    $('#addDocumentModal').modal('hide');
                    loadDocuments();
                    handleDocs();
                } else {
                    alertify.error(data.error);
                }   
            })
            .catch(error => console.error("Erreur AJAX:", error));
        });




        // Gestion de l'affichage dans la modal
        $(document).on("click", ".view-doc", function () {
            var fileUrl = $(this).data("url");
            var previewHtml = "";

            // Réinitialiser le container
            $("#previewContent").html("");
            $("#pdfPreviewContainer").hide();

            // Déterminer le type du fichier par extension
            if (fileUrl.match(/\.(jpeg|jpg|png|gif|bmp|webp)$/i)) {
                // Image
                previewHtml = "<img src='" + fileUrl + "' class='img-fluid rounded shadow'>";
                $("#previewContent").html(previewHtml);

            } else if (fileUrl.match(/\.pdf$/i)) {
                // PDF avec pdf.js
                $("#pdfPreviewContainer").show();

                var loadingTask = pdfjsLib.getDocument(fileUrl);
                loadingTask.promise.then(function(pdf) {
                    // Charger la première page
                    pdf.getPage(1).then(function(page) {
                        var scale = 1.5;
                        var viewport = page.getViewport({scale: scale});

                        var canvas = document.getElementById("pdfCanvas");
                        var context = canvas.getContext("2d");
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        var renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        page.render(renderContext);
                    });
                }).catch(function(error){
                    $("#previewContent").html(
                        "<p class='text-danger'>Impossible de charger le PDF : " + error + "</p>"
                    );
                    $("#pdfPreviewContainer").hide();
                });

            } else {
                // Autres fichiers (Word, Excel, etc.)
                previewHtml = "<p class='text-muted'>Aucun aperçu disponible pour ce type de fichier.</p>" +
                            "<a href='" + fileUrl + "' class='btn btn-primary' target='_blank'>Télécharger le fichier</a>";
                $("#previewContent").html(previewHtml);
            }

            // Ouvrir la modal
            $("#previewDocumentModal").modal("show");
        });

        
        handleDocs();

        // Fonction pour charger les documents manquants
        function loadMissingDocuments() {
            $.ajax({
                url: "{% url 't_crm:check_all_required_docs' %}",
                dataType: "JSON",
                type: 'GET',
                data: {'id_prospect': id},
                success: function(data) {
                    var html = "";
                    
                    if (data.missing_docs && data.missing_docs.length > 0) {
                        $.each(data.missing_docs, function(index, doc) {
                            html += "<tr>";
                            html += "<td>" + doc.label + "</td>";
                            html += "<td class='text-center'>";
                            html += "<button class='btn btn-sm btn-primary add-missing-doc' data-doc-id='" + doc.id + "'>";
                            html += "<i class='ri-add-line me-1'></i>Ajouter";
                            html += "</button>";
                            html += "</td>";
                            html += "</tr>";
                        });
                    } else {
                        html += "<tr>";
                        html += "<td colspan='2' class='text-center text-success'>";
                        html += "<i class='ri-checkbox-circle-line fs-4 me-2'></i>";
                        html += "Tous les documents requis ont été fournis";
                        html += "</td>";
                        html += "</tr>";
                    }
                    
                    $('#missingDocumentsList').html(html);
                },
                error: function() {
                    $('#missingDocumentsList').html(
                        "<tr><td colspan='2' class='text-center text-danger'>Erreur lors du chargement des documents</td></tr>"
                    );
                }
            });
        }

        // Charger les documents manquants quand la modale s'ouvre
        $('#missingDocumentsModal').on('shown.bs.modal', function () {
            loadMissingDocuments();
        });

        // Rafraîchir la liste des documents manquants
        $(document).on('click', '#refreshMissingDocsBtn', function() {
            loadMissingDocuments();
        });

        // Gérer le clic sur le bouton d'ajout de document manquant
        $(document).on('click', '.add-missing-doc', function() {
            var docId = $(this).data('doc-id');
            // Charger les types de documents dans la modale d'ajout
            loadSelectDocuement();
            // Sélectionner automatiquement le document concerné
            $('#documentType').val(docId);
            // Fermer la modale des documents manquants
            $('#missingDocumentsModal').modal('hide');
            // Ouvrir la modale d'ajout de document
            $('#addDocumentModal').modal('show');
        });
        
        // Fonction pour vérifier l'état de la dérogation
        function checkDerogationStatus() {
            $.ajax({
                url: "{% url 't_crm:ApiCheckDerogationStatus' %}",
                dataType: "JSON",
                type: "GET",
                data: {'id_preinscrit': id},
                success: function(response) {
                    if (response.status === 'acceptee') {
                        document.getElementById('derogation_acceptee').hidden = false;
                        document.getElementById('derogation_refusee').hidden = true;
                        document.getElementById('derogation_attente').hidden = true;
                        document.getElementById('requestValidationBtn').disabled = false;

                        
                    } else if (response.status === 'rejetee') {
                        document.getElementById('derogation_acceptee').hidden = true;
                        document.getElementById('derogation_refusee').hidden = false;
                        document.getElementById('derogation_attente').hidden = true;
                        document.getElementById('requestValidationBtn').disabled = false;


                    } else if(response.status === "en_attente"){
                        document.getElementById('derogation_attente').hidden = false;
                        document.getElementById('derogation_acceptee').hidden = true;
                        document.getElementById('derogation_refusee').hidden = true;
                        document.getElementById('requestValidationBtn').disabled = true;
                    }else{

                    }
                },
                error: function() {
                    // En cas d'erreur, cacher les deux notifications
                    document.getElementById('derogation_acceptee').hidden = true;
                    document.getElementById('derogation_refusee').hidden = true;
                    document.getElementById('derogation_attente').hidden = true;
                    document.getElementById('requestValidationBtn').disabled = false;

                }
            });
        }

        // Charger l'état de la dérogation au chargement de la page
        checkDerogationStatus();

         // Gérer la soumission de la demande de validation par un responsable
        $(document).on('click', '#submitValidationRequestBtn', function() {
            var reason = $('#validationRequestReason').val();
            var motif  = $('#validationRequestMotif').val();
            
            if (reason.trim() === '') {
                alertify.error("Veuillez fournir un motif pour votre demande.");
                return;
            }

            $.ajax({
                url : '{% url "t_crm:ApiStoreDerogation" %}',
                dataType: 'JSON',
                type: 'POST',
                data : {
                    'id_preinscrit' : id,
                    'reason' : reason,
                    'motif' : motif,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success : function(response){
                    if (response.status === "success") {
                        alertify.success(response.message);
                        checkDerogationStatus();
                        $('#requestManagerValidationModal').modal('hide');
                        $('#validationRequestReason').val('');

                    }else{
                        alertify.error(response.message);
                    }
                }
            });      
        });

        function loadRemiderDetailsForUpdate(id_rendez_vous){
            $.ajax({
                url : "{% url 't_crm:ApiLoadRendezVousDetails' %}",
                dataType: "JSON",
                type: "GET",
                data : {'id_rendez_vous' : id_rendez_vous},
                success: function(data){
                    $('#editDescriptionRemider').val(data[0].description);
                    $('#editDateReminder').val(data[0].date_rendez_vous);
                    $('#editTimeReminer').val(data[0].heure_rendez_vous);
                    $('#editObjectReminder').val(data[0].object);
                    $('#editTypeReminder').val(data[0].type);

                    $('#reminder-type').text(data[0].type_label)
                    $('#reminder-date-time').text(data[0].heure_rendez_vous)
                    $('#reminder-object').text(data[0].object)
                    $('#reminder-status').text(data[0].statut_label)
                    $('#reminder-description').text(data[0].description)


                    
                }
            });
        }

        $(document).on('click', '#editReminderBtn', function(){
            var id_reminder = $(this).data('id');
            loadRemiderDetailsForUpdate(id_reminder);
            $('#editReminderBtnSave').data('id', id_reminder);
            $('#editReminderModal').modal('show');
        });

        $(document).on('click','#editReminderBtnSave', function(){
            var editedDescription = $('#editDescriptionRemider').val();
            var editedType = $('#editTypeReminder').val();
            var editedDate = $('#editDateReminder').val();
            var editedTime = $('#editTimeReminer').val();
            var editedObject = $('#editObjectReminder').val();
            var id_rappel = $(this).data('id');
            $.ajax({
                url : "{% url 't_crm:ApiUpdateRappel' %}",
                dataType : 'JSON',
                type: 'POST',
                data : {
                    'id_rappel' : id_rappel,
                    'type' : editedType,
                    'subject' : editedObject,
                    'date' : editedDate,
                    'time' : editedTime,
                    'description' : editedDescription,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },

                success : function(response){
                    if(response.status == "success"){
                        alertify.success(response.message);
                        loadRappelRendezVous();
                        $('#editReminderModal').modal('hide');
                        
                    }else{
                        alertify.error(response.message);
                    }
                }
            })
        });

        $(document).on('click', '#detailsReminderBtn', function(){
            var id_reminder = $(this).data('id');
            loadRemiderDetailsForUpdate(id_reminder);
            $('#detailsReminderModal').modal('show');
        });

        $(document).on('click', '#validateReminderBtn', function(){
            var id_reminder = $(this).data('id');
            $('#confirmValidateReminderBtn').data('id', id_reminder);
            $('#validateReminderModal').modal('show');
        });

        $(document).on('click','#confirmValidateReminderBtn', function(){
            var id_reminder = $(this).data('id');
            var description = $('#observation_rappel').val();
            var statut_reminder = $('#validate_statut_reminder').val();

            $.ajax({
                url : "{% url 't_crm:ApiValidateRemider' %}",
                dataType : "JSON",
                type: 'POST',
                data : {
                    'id_reminder' : id_reminder,
                    'description' : description,
                    'statut_reminder' : statut_reminder,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("La validation du rappel a été effecuter avec succès");
                        loadRappelRendezVous();
                        $('#validateReminderModal').modal('hide');
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete !");
                    }
                }
            })
        });

        $(document).on('click', '#deleteReminderBtn', function(){
            var id_reminder = $(this).data('id');
            $('#ConfirmDeleteReminderBtn').data('id', id_reminder);
            $('#deleteReminderModal').modal('show');
        });

        $(document).on('click','#ConfirmDeleteReminderBtn', function(){
            var id_reminder = $(this).data('id');
            $.ajax({
                url :"{% url 't_crm:ApiArchiveReminder' %}",
                dataType : "JSON",
                type: "GET",
                data : {
                    'id_reminder' :  id_reminder,
                },
                success : function(response){
                    if (response.status === "success"){
                        alertify.success("Suppression effectué avec succès");
                        loadRappelRendezVous();
                        $('#deleteReminderModal').modal('hide');
                    }else{  
                        alertify.error("Une erreur c'est produite lors du traitement de la requete !");
                    }
                }
            });
        });

        

       
    });
</script>

{% endblock content %}