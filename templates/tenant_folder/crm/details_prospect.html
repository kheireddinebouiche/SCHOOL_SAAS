{% extends "tenant_folder/base.html" %}

{% load static %}

{% block title %}Détails du prospect {% endblock title %}

{% block content %}
<style>
    /* Style de secours pour les icônes */
    .ri:before {
        display: inline-block;
        font-family: "remixicon" !important;
        font-style: normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* Style pour les boutons avec icônes */
    .btn i {
        vertical-align: middle;
    }
    
    .btn span {
        vertical-align: middle;
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">                                                    

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-user-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Détails du prospect</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">CRM</a>
                                    </li>
                                    <li class="breadcrumb-item active">Détails du prospect</li>
                                </ol>
                            </nav>
                            <div class="btn-group">
                                <button  type="button" hidden class="btn btn-success px-4 py-2" data-bs-toggle="modal" id="validateProspectBtn">
                                    <i class="ri-check-line me-2"></i>Valider le prospect
                                </button>
                                <button type="button" class="btn btn-primary px-4 py-2" id="udapteProspectDetailsBtn" >
                                    <i class="ri-edit-line me-2"></i>Modifier
                                </button>
                                <a href="/crm/liste-des-prospects/" class="btn btn-light px-4 py-2">
                                    <i class="ri-arrow-left-line me-2"></i>Retour à la liste
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->
            <!-- Première rangée : Informations personnelles et Fiche de Voeux -->
            <div class="row mb-4">
                <!-- Informations personnelles -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-user-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-primary mb-1">Informations de personnelles</h5>
                                    <p class="text-muted small mb-0">Détails du contact</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-user-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Nom et Prénom</small>
                                    <span class="fw-semibold" id="nom_prenom"></span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-flag-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Statut</small>
                                    <span class="fw-semibold" id="statut_prospect"></span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-mail-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Email</small>
                                    <span class="fw-semibold" id="email"></span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-phone-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Téléphone</small>
                                    <span class="fw-semibold" id="phone"></span>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-calendar-line text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Crée le</small>
                                    <span class="fw-semibold" id="created_at"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Fiche de Voeux -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-graduation-cap-line text-info fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-info mb-1">Fiche de Voeux</h5>
                                        <p class="text-muted small mb-0">Orientation académique du prospect</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-info px-4 py-2" id="editVoeuxBtn">
                                        <i class="ri-edit-line me-2"></i>Modifier les voeux
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4 d-flex align-items-center justify-content-center">
                            <div class="row w-100" id="procespectVoeuxDetails">
                                <!-- Contenu dynamique de la fiche de voeux -->
                            </div>
                        </div>
                        <div class="card-footer bg-light bg-opacity-50 border-0 px-4 py-3">
                            <div class="d-flex justify-content-center align-items-center">
                                <a href="javascript:void(0);" class="text-decoration-none me-3" id="voirVoeuxSuppLink">
                                    <i class="ri-eye-line me-1"></i>
                                    Voir les formations supplémentaires
                                    <span class="badge bg-success ms-1" id="voeuxSuppCount">0</span>
                                </a>
                                <button type="button" class="btn btn-icon btn-sm btn-ghost-secondary p-0" id="configVoeuxSuppBtn" title="Configurer les fiches de voeux supplémentaires">
                                    <i class="ri-settings-3-line fs-18 text-muted"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deuxième rangée : Rappels -->
            <div class="row">
                <!-- Colonne Prise de rendez vous -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4 w-100">
                        <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-calendar-check-line text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-success mb-1">Rappels & Rendez-vous</h5>
                                        <p class="text-muted small mb-0">Gestion des tâches et rendez-vous</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-success px-4 py-2" id="addReminderBtn">
                                    <i class="ri-add-line me-2"></i>Nouveau rappel
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Type</th>
                                            <th class="border-0">Date & Heure</th>
                                            <th class="border-0">Objet</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0 rounded-end text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listeDesRendezVous">
                                        <!-- Liste des rendez vous -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <!-- Fin Colonne de prise de rendez vous-->
            </div>
            <!--Fin Row notes-->


            <!-- Section Notes -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <!-- Header -->
                        <div class="card-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-sticky-note-line text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-warning mb-1">Notes</h5>
                                        <p class="text-muted small mb-0">Commentaires et observations</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-warning px-4 py-2" id="addNoteModalBtn">
                                    <i class="ri-add-line me-2"></i>Nouvelle note
                                </button>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="card-body p-4">
                            <!-- Liste des notes -->
                            <div class="vstack gap-4" id="ListeDesNotes">
                                

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin Section Notes-->

            <!-- Modal Nouveau Rappel -->
            <div class="modal fade" id="addReminderModal" tabindex="-1" aria-labelledby="addReminderModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-calendar-check-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-success mb-1" id="addReminderModalLabel">
                                        Nouveau rappel
                                    </h5>
                                    <p class="text-muted small mb-0">Créer un nouveau rappel ou rendez-vous</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Type de rappel</label>
                                    <select id="reminderType" class="form-select border-0 bg-light py-2">
                                        <option value="appel">Appel</option>
                                        <option value="rendez_vous">Rendez-vous</option>
                                        <option value="email">Email</option>
                                        <option value="autre">Autre</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Objet</label>
                                    <input id="reminderSubject" type="text" class="form-control border-0 bg-light py-2" placeholder="Entrez l'objet du rappel">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Date</label>
                                    <input id="reminderDate" type="date" class="form-control border-0 bg-light py-2">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Heure</label>
                                    <input id="reminderTime" type="time" class="form-control border-0 bg-light py-2">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Description</label>
                                    <textarea id="reminderDescription" class="form-control border-0 bg-light" rows="3" placeholder="Entrez une description..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-success px-4 py-2" id="saveReminderBtn">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
   
            <!-- Modal de validation du prospect -->
            <div class="modal fade" id="validateProspectModal" tabindex="-1" aria-labelledby="validateProspectModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-check-double-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-success mb-1" id="validateProspectModalLabel">
                                        Validation du prospect
                                    </h5>
                                    <p class="text-muted small mb-0">Confirmation de la validation du prospect</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div class="avatar-lg mx-auto mb-3">
                                    <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                                        <i class="ri-user-follow-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-3">Êtes-vous sûr de vouloir valider ce prospect ?</h5>
                                <p class="text-muted mb-4">
                                    La validation du prospect permettra de le convertir en client et de commencer le processus d'inscription.
                                </p>
                                <div class="alert alert-warning">
                                    <i class="ri-alert-line fs-4 me-2"></i>
                                    <strong>Attention :</strong> Une fois la spécialité validée, il ne sera plus possible de la modifier sans demande de dérogation.
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Commentaire de validation (optionnel)</label>
                                    <textarea class="form-control border-0 bg-light" rows="3" placeholder="Ajoutez un commentaire..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" id="confirmeValidationBtn" class="btn btn-success px-4 py-2">
                                <i class="ri-check-line me-2"></i>Valider le prospect
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de modification du prospect -->
            <div class="modal fade" id="editProspectModal" tabindex="-1" aria-labelledby="editProspectModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-edit-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-primary mb-1" id="editProspectModalLabel">
                                        Modifier les informations
                                    </h5>
                                    <p class="text-muted small mb-0">Modification des informations du prospect</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div class="avatar-lg mx-auto mb-3">
                                    <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                                        <i class="ri-user-settings-line"></i>
                                    </div>
                                </div>
                                <h4 class="text-primary mb-3">Modification du prospect</h4>
                                <p class="text-muted mb-4">
                                    Veuillez remplir les informations ci-dessous pour mettre à jour les détails du prospect.
                                </p>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Nom</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-user-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id='edit_nom'>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Prénom</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-user-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id='edit_prenom'>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Email</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-mail-line text-muted"></i>
                                            </span>
                                            <input type="email" class="form-control border-0 bg-light py-2" id="edit_email">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Téléphone</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-phone-line text-muted"></i>
                                            </span>
                                            <input type="tel" class="form-control border-0 bg-light py-2" id="edit_telephone">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Observation</label>
                                        <div class="input-group">
                                            <textarea class="form-control border-0 bg-light py-2" id="edit_observation"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <div class="hstack gap-2 justify-content-center w-100">
                                <button type="button" class="btn btn-light px-4 py-2 w-100" data-bs-dismiss="modal">
                                    <i class="ri-close-line me-2"></i>Annuler
                                </button>
                                <button type="button" id="validateUpdateProspectDetailsBtn" class="btn btn-primary px-4 py-2 w-100">
                                    <i class="ri-save-line me-2"></i>Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Nouvelle Note -->
            <div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-sticky-note-line text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-warning mb-1" id="addNoteModalLabel">
                                        Nouvelle note
                                    </h5>
                                    <p class="text-muted small mb-0">Ajouter une nouvelle note ou observation</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <textarea id="content_note" class="form-control border-0 bg-light" rows="4" placeholder="Saisissez votre note ici..."></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Étiquettes</label>
                                    <select id="note_tags" class="form-select border-0 bg-light py-2">
                                        <option value="important">Important</option>
                                        <option value="a_revoir">A revoir</option>
                                        <option value="a_contacte">A contacter</option>
                                        <option value="a_relancer">A relancer</option>

                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-warning px-4 py-2" id="saveNoteBtn">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Modal Modification d'une note -->
            <div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-edit-line text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-warning mb-1" id="editNoteModalLabel">
                                        Modifier le profil
                                    </h5>
                                    <p class="text-muted small mb-0">Modification des informations de Jean Martin</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Nom et Prénom</label>
                                    <input type="text" class="form-control border-0 bg-light" value="Jean Martin">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Date</label>
                                    <input type="date" class="form-control border-0 bg-light" value="2024-01-20">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-warning px-4 py-2">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Suppression d'une note -->
            <div class="modal fade" id="deleteNoteModal" tabindex="-1" aria-labelledby="deleteNoteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-delete-bin-line text-danger fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteNoteModal">
                                        Supprimer le profil
                                    </h5>
                                    <p class="text-muted small mb-0">Suppression du profil de Jean Martin</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center">
                                <div class="avatar-lg mx-auto mb-4">
                                    <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                                        <i class="ri-error-warning-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer ce profil ?</h5>
                                <p class="text-muted">
                                    La suppression du profil de Jean Martin est définitive et ne pourra pas être annulée.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" id='ConfirmDeleteNoteBtn' class="btn btn-danger px-4 py-2">
                                <i class="ri-delete-bin-line me-2"></i>Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Modification d'un rappel -->
            <div class="modal fade" id="editReminderModal" tabindex="-1" aria-labelledby="editReminderModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-calendar-check-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-primary mb-1" id="editReminderModalLabel">
                                        Modifier le rappel
                                    </h5>
                                    <p class="text-muted small mb-0">Modification des informations du rappel</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Type de rappel</label>
                                    <select id="editTypeReminder" class="form-select border-0 bg-light py-2">
                                        <option value="appel">Appel</option>
                                        <option value="rendez_vous">Rendez-vous</option>
                                        <option value="email">Email</option>
                                        <option value="autre">Autre</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Objet</label>
                                    <input type="text" id="editObjectReminder" class="form-control border-0 bg-light py-2" placeholder="Entrez l'objet du rappel">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Date</label>
                                    <input id="editDateReminder" type="date" class="form-control border-0 bg-light py-2">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Heure</label>
                                    <input id="editTimeReminer" type="time" class="form-control border-0 bg-light py-2">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Description</label>
                                    <textarea id="editDescriptionRemider" class="form-control border-0 bg-light" rows="3" placeholder="Entrez une description..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" id="editReminderBtnSave" class="btn btn-primary px-4 py-2">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Détails d'un rappel -->
            <div class="modal fade" id="detailsReminderModal" tabindex="-1" aria-labelledby="detailsReminderModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-calendar-check-line text-info fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-info mb-1" id="detailsReminderModalLabel">
                                        Détails du rappel
                                    </h5>
                                    <p class="text-muted small mb-0">Informations détaillées sur le rappel</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="ri-phone-line text-primary"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block mb-1">Type</small>
                                            <span class="fw-semibold" id="reminder-type"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="ri-time-line text-info"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block mb-1">Date & Heure</small>
                                            <span class="fw-semibold" id="reminder-date-time"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="ri-file-text-line text-success"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block mb-1">Objet</small>
                                            <span class="fw-semibold" id="reminder-object"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="ri-list-check-2 text-warning"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block mb-1">Statut</small>
                                            <span class="badge bg-warning-subtle text-warning px-2 py-1" id="reminder-status">
                                                <i class="ri-time-line me-1" ></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex">
                                        <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="ri-file-list-line text-secondary"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block mb-1">Description</small>
                                            <span class="fw-semibold" id="reminder-description"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Fermer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Suppression d'un rappel -->
            <div class="modal fade" id="deleteReminderModal" tabindex="-1" aria-labelledby="deleteReminderModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-delete-bin-line text-danger fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteReminderModalLabel">
                                        Supprimer le rappel
                                    </h5>
                                    <p class="text-muted small mb-0">Suppression du rappel/rendez-vous</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center">
                                <div class="avatar-lg mx-auto mb-4">
                                    <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                                        <i class="ri-error-warning-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer ce rappel ?</h5>
                                <p class="text-muted">
                                    La suppression de ce rappel est définitive et ne pourra pas être annulée.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" id="ConfirmDeleteReminderBtn" class="btn btn-danger px-4 py-2">
                                <i class="ri-delete-bin-line me-2"></i>Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Validation Rappel -->
            <div class="modal fade" id="validateReminderModal" tabindex="-1" aria-labelledby="validateReminderModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-check-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-success mb-1" id="validateReminderModalLabel">
                                        Valider le rappel
                                    </h5>
                                    <p class="text-muted small mb-0">Confirmer l'exécution du rappel</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Statut</label>
                                    <select id="validate_statut_reminder" class="form-select border-0 bg-light py-2">
                                        <option value="">Selectionnez une option</option>
                                        <option value="annule">Annuler</option>
                                        <option value="termine">Terminer</option>
                                        <option value="abouti">Abouti</option>
                                        <option value="nabouti">Non abouti</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Observations</label>
                                    <textarea id="observation_rappel" class="form-control border-0 bg-light" rows="4" placeholder="Entrez vos observations..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-success px-4 py-2" id="confirmValidateReminderBtn">
                                <i class="ri-check-line me-2"></i>Valider
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Modification Fiche de Voeux -->
            <div class="modal fade" id="editVoeuxModal" tabindex="-1" aria-labelledby="editVoeuxModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-primary position-relative py-4">
                            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 20%);"></div>
                            <div class="position-relative z-1 text-center w-100">
                                <div class="avatar-md mx-auto mb-3">
                                    <div class="avatar-title bg-white bg-opacity-20 rounded-circle">
                                        <i class="ri-file-edit-line text-black fs-1"></i>
                                    </div>
                                </div>
                                <h3 class="modal-title fw-bold text-white mb-1" id="editVoeuxModalLabel">
                                    Modifier la fiche de voeux
                                </h3>
                                <p class="text-white text-opacity-80 small mb-0">Mise à jour des préférences académiques</p>
                            </div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-1" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        
                        <div class="modal-body p-4">
                            <form class="vstack gap-4">
                                <!-- Sélection de la promotion/session -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-calendar-line text-primary me-2"></i>
                                        Promotion/Session
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="promo_voeux" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une promo">
                                            <option value="0">Rechercher et sélectionner une promotion/session</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>

                                <!-- Sélection de la formation avec recherche -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-book-2-line text-primary me-2"></i>
                                        Formation
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="formation_voeux" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une formation">
                                            <option value="0">Rechercher et sélectionner une formation</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Sélection de la spécialité avec recherche -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-stack-line text-primary me-2"></i>
                                        Spécialité
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="specialite_voeux" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une spécialité">
                                            <option value="0">Rechercher et sélectionner une spécialité</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Commentaires avec compteur de caractères -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-edit-2-line text-primary me-2"></i>
                                        Commentaires
                                        <small class="ms-auto text-muted"><span id="commentairesCount">0</span>/500</small>
                                    </label>
                                    <textarea id="commentaires_voeux" class="form-control border-0 bg-light-subtle py-2 rounded-3 shadow-sm" placeholder="Ajoutez vos commentaires ici..." rows="3" maxlength="500"></textarea>
                                </div>
                            </form>
                        </div>
                        
                        <div class="modal-footer border-0 bg-light bg-opacity-50 px-4 py-3">
                            <div class="d-flex justify-content-between w-100">
                                <button type="button" class="btn btn-outline-secondary px-4 py-2 rounded-pill fw-medium" data-bs-dismiss="modal">
                                    <i class="ri-arrow-left-line me-2"></i>Retour
                                </button>
                                <button type="button" class="btn btn-primary px-4 py-2 rounded-pill fw-medium shadow d-flex align-items-center" id="saveVoeuxBtn">
                                    <i class="ri-save-line me-2"></i>
                                    <span>Mettre à jour</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Création Fiche de Voeux -->
            <div class="modal fade" id="createVoeuxModal" tabindex="-1" aria-labelledby="createVoeuxModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-success position-relative py-4">
                            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 20%);"></div>
                            <div class="position-relative z-1 text-center w-100">
                                <div class="avatar-md mx-auto mb-3">
                                    <div class="avatar-title bg-white bg-opacity-20 rounded-circle">
                                        <i class="ri-file-add-line text-white fs-1"></i>
                                    </div>
                                </div>
                                <h3 class="modal-title fw-bold text-white mb-1" id="createVoeuxModalLabel">
                                    Créer une fiche de voeux
                                </h3>
                                <p class="text-white text-opacity-80 small mb-0">Enregistrement des préférences académiques</p>
                            </div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-1" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        
                        <div class="modal-body p-4">
                            <form class="vstack gap-4">
                                 <!-- Sélection de la promotion/session -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-calendar-line text-success me-2"></i>
                                        Promotion/Session
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="promo_voeux_create" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une promo">
                                            <option value="0">Rechercher et sélectionner une promotion/session</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                <!-- Sélection de la formation avec recherche -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-book-2-line text-success me-2"></i>
                                        Formation
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="create_formation_voeux" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une formation">
                                            <option value="0" selected>Rechercher et sélectionner une formation</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Sélection de la spécialité avec recherche -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-stack-line text-success me-2"></i>
                                        Spécialité
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="create_specialite_voeux" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une spécialité">
                                            <option value="0" selected>Rechercher et sélectionner une spécialité</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Commentaires avec compteur de caractères -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-edit-2-line text-success me-2"></i>
                                        Commentaires
                                        <small class="ms-auto text-muted"><span id="createCommentairesCount">0</span>/500</small>
                                    </label>
                                    <textarea id="create_commentaires_voeux" class="form-control border-0 bg-light-subtle py-2 rounded-3 shadow-sm" placeholder="Ajoutez vos commentaires ici..." rows="3" maxlength="500"></textarea>
                                </div>
                            </form>
                        </div>
                        
                        <div class="modal-footer border-0 bg-light bg-opacity-50 px-4 py-3">
                            <div class="d-flex justify-content-between w-100">
                                <button type="button" class="btn btn-outline-secondary px-4 py-2 rounded-pill fw-medium" data-bs-dismiss="modal">
                                    <i class="ri-arrow-left-line me-2"></i>Retour
                                </button>
                                <button type="button" class="btn btn-success px-4 py-2 rounded-pill fw-medium shadow d-flex align-items-center" id="saveCreateVoeuxBtn">
                                    <i class="ri-save-line me-2"></i>
                                    <span>Enregistrer</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Formations Supplémentaires -->
            <div class="modal fade" id="voeuxSuppModal" tabindex="-1" aria-labelledby="voeuxSuppModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-info position-relative py-4">
                            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 20%);"></div>
                            <div class="position-relative z-1 text-center w-100">
                                <div class="avatar-md mx-auto mb-3">
                                    <div class="avatar-title bg-opacity-20 rounded-circle">
                                        <i class="ri-flag-2-line"></i>
                                    </div>
                                </div>
                                <h3 class="modal-title fw-bold text-white mb-1" id="voeuxSuppModalLabel">
                                    Formations Supplémentaires
                                </h3>
                                <p class="text-white text-opacity-80 small mb-0">Souhaits supplémentaires du prospect</p>
                            </div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-1" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Formation</th>
                                            <th class="border-0">Spécialité</th>
                                            <th class="border-0">Commentaires</th>
                                            <th class="border-0 rounded-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listeVoeuxSupplementaires">
                                        <!-- Liste des formations supplémentaires -->
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                Aucune formation supplémentaire enregistrée
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2 rounded-pill fw-medium" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i><span>Fermer</span>
                            </button>
                            <button type="button" class="btn btn-info px-4 py-2 rounded-pill fw-medium" id="addVoeuxSuppBtn">
                                <i class="ri-add-line me-2"></i><span>Ajouter</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Suppression Fiche de Voeux Supplémentaire -->
            <div class="modal fade" id="deleteVoeuxSuppModal" tabindex="-1" aria-labelledby="deleteVoeuxSuppModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-delete-bin-line text-danger fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteVoeuxSuppModalLabel">
                                        Supprimer la fiche de voeux
                                    </h5>
                                    <p class="text-muted small mb-0">Suppression de la formation supplémentaire</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center">
                                <div class="avatar-lg mx-auto mb-4">
                                    <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                                        <i class="ri-error-warning-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer cette fiche de voeux ?</h5>
                                <p class="text-muted">
                                    La suppression de cette fiche de voeux est définitive et ne pourra pas être annulée.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteVoeuxSuppBtn">
                                <i class="ri-delete-bin-line me-2"></i>Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Validation Formations Supplémentaires -->
            <div class="modal fade" id="validateVoeuxSuppModal" tabindex="-1" aria-labelledby="validateVoeuxSuppModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning position-relative py-4">
                            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 20%);"></div>
                            <div class="position-relative z-1 text-center w-100">
                                <div class="avatar-md mx-auto mb-3">
                                    <div class="avatar-title bg-white bg-opacity-20 rounded-circle">
                                        <i class="ri-alert-line text-white fs-1"></i>
                                    </div>
                                </div>
                                <h3 class="modal-title fw-bold text-white mb-1" id="validateVoeuxSuppModalLabel">
                                    Confirmation de validation
                                </h3>
                                <p class="text-white text-opacity-80 small mb-0">Attention aux conséquences de cette action</p>
                            </div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-1" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center">
                                <div class="alert alert-warning mb-4">
                                    <i class="ri-alert-line fs-4 me-2"></i>
                                    <strong>Attention !</strong>
                                </div>
                                <p class="mb-4">
                                    En validant ces formations supplémentaires, votre choix de spécialité principal sera écrasé.
                                    Êtes-vous sûr de vouloir continuer ?
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2 rounded-pill fw-medium" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i><span>Annuler</span>
                            </button>
                            <button type="button" class="btn btn-success px-4 py-2 rounded-pill fw-medium" id="confirmValidateVoeuxSuppBtn">
                                <i class="ri-check-line me-2"></i><span>Confirmer</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Configuration Formations Supplémentaires -->
            <div class="modal fade" id="configVoeuxSuppModal" tabindex="-1" aria-labelledby="configVoeuxSuppModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning position-relative py-4">
                            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 20%);"></div>
                            <div class="position-relative z-1 text-center w-100">
                                <div class="avatar-md mx-auto mb-3">
                                    <div class="avatar-title bg-white bg-opacity-20 rounded-circle">
                                        <i class="ri-settings-3-line text-white fs-1"></i>
                                    </div>
                                </div>
                                <h3 class="modal-title fw-bold text-white mb-1" id="configVoeuxSuppModalLabel">
                                    Configurer Formations Supplémentaires
                                </h3>
                                <p class="text-white text-opacity-80 small mb-0">Ajout de souhaits de formations supplémentaires</p>
                            </div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-1" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        
                        <div class="modal-body p-4">
                            <form class="vstack gap-4">
                                <!-- Sélection de la promotion/session -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-calendar-line text-warning me-2"></i>
                                        Promotion/Session
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="config_promo_supp" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une promotion/session">
                                            <option value="0">Rechercher et sélectionner une promotion/session</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Sélection de la formation avec recherche -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-book-2-line text-warning me-2"></i>
                                        Formation
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="config_formation_supp" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une formation">
                                            <option value="0">Rechercher et sélectionner une formation</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Sélection de la spécialité avec recherche -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-stack-line text-warning me-2"></i>
                                        Spécialité
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light-subtle border-0 rounded-start-pill">
                                            <i class="ri-search-2-line text-muted"></i>
                                        </span>
                                        <select id="config_specialite_supp" class="form-select border-0 bg-light-subtle py-2 rounded-end-pill shadow-sm" aria-label="Sélectionnez une spécialité">
                                            <option value="0">Rechercher et sélectionner une spécialité</option>
                                            <!-- Options à charger dynamiquement -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Commentaires avec compteur de caractères -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold mb-2 d-flex align-items-center">
                                        <i class="ri-edit-2-line text-warning me-2"></i>
                                        Commentaires
                                        <small class="ms-auto text-muted"><span id="configCommentairesCount">0</span>/500</small>
                                    </label>
                                    <textarea id="config_commentaires_supp" class="form-control border-0 bg-light-subtle py-2 rounded-3 shadow-sm" placeholder="Ajoutez vos commentaires ici..." rows="3" maxlength="500"></textarea>
                                </div>
                            </form>
                        </div>
                        
                        <div class="modal-footer border-0 bg-light bg-opacity-50 px-4 py-3">
                            <div class="d-flex justify-content-between w-100">
                                <button type="button" class="btn btn-outline-secondary px-4 py-2 rounded-pill fw-medium" data-bs-dismiss="modal">
                                    <i class="ri-arrow-left-line me-2"></i>Retour
                                </button>
                                <button type="button" class="btn btn-warning px-4 py-2 rounded-pill fw-medium shadow d-flex align-items-center" id="saveConfigVoeuxSuppBtn">
                                    <i class="ri-save-line me-2"></i>
                                    <span>Enregistrer</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de blocage de validation du prospect -->
            <div class="modal fade" id="blockValidateProspectModal" tabindex="-1" aria-labelledby="blockValidateProspectModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-close-circle-line text-danger fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-danger mb-1" id="blockValidateProspectModalLabel">
                                        Validation impossible
                                    </h5>
                                    <p class="text-muted small mb-0">Conditions non remplies pour valider le prospect</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div class="avatar-lg mx-auto mb-3">
                                    <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                                        <i class="ri-error-warning-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-3">Impossible de valider ce prospect</h5>
                                <p class="text-muted mb-4">
                                    Pour valider un prospect, vous devez d'abord remplir la condition suivante :
                                </p>
                                <div class="text-start mb-4">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="ri-close-circle-line text-danger me-2"></i>
                                            <span>Avoir une fiche de voeux renseignée</span>
                                        </li>
                                        
                                    </ul>
                                </div>
                                <div class="alert alert-warning mb-0">
                                    <i class="ri-information-line me-2"></i>
                                    Veuillez remplir ces conditions avant de pouvoir valider le prospect.
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-danger px-4 py-2 w-100" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Fermer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>

    $(document).ready(function(){
        // Vérification du chargement des icônes
        function checkIconsLoaded() {
            // Vérifier si les icônes Remix sont chargées
            if ($('.ri-check-line').length > 0) {
                // Si les icônes sont présentes, on masque le texte de secours
                $('.btn span').each(function() {
                    if ($(this).siblings('.ri').length > 0) {
                        $(this).removeClass('d-none');
                    }
                });
            }
        }
        
        // Appeler la vérification après le chargement de la page
        setTimeout(checkIconsLoaded, 1000);
        
        let id  = "{{ pk }}";
        let type = null;
        let has_voeux = null;
       
        let has_second_wished = null;
        let promoListee = [];

        function loadNotes(){
            $.ajax({
                url :"{% url 't_crm:ApiLoadNote' %}",
                dataType: "JSON",
                type : 'GET',
                data:{'id_prospect' : id},
                success: function(data){
                    var html = "";

                    if (data.length > 0){
                        $.each(data, function(index, item){
                            html +='<div class="border-start border-4 border-warning ps-4 py-2 bg-white rounded-end">';
                            html +='<div class="d-flex justify-content-between align-items-start mb-2">';
                            html +='<div class="d-flex align-items-center">';
                            html +='<div class="avatar-sm me-3"><div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle fs-5">JM</div></div>';
                            html +='<div><h6 class="mb-0 fw-semibold">'+item.created_by__username+'</h6><small class="text-muted">'+item.created_at+'</small></div>';
                            html +='</div>';
                            html +='<div class="dropdown">';
                            html +='<button class="btn btn-icon btn-sm btn-ghost-secondary" data-bs-toggle="dropdown"><i class="ri-more-2-fill"></i></button>';
                            html +='<ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">';
                            html +='<li><button class="dropdown-item d-flex align-items-center" type="button" data-bs-toggle="modal" data-bs-target="#editNoteModal"><i class="ri-edit-line me-2"></i>Modifier</button></li>';
                            html +='<li><button class="dropdown-item d-flex align-items-center" type="button" data-bs-toggle="modal" data-id="'+item.id+'" id="deleteNoteBtn"><i class="ri-delete-bin-line me-2"></i>Supprimer</button></li>';
                            html +='</ul>';
                            html +='</div>';
                            html +='</div>';
                            html +='<p class="mb-3">'+item.note+'</p>';
                            html +='<div class="d-flex gap-2">';
                            html +='<span class="badge bg-warning-subtle text-warning">'+item.tage+'</span>';
                            html +='</div>';
                            html +='</div>';
                        });
                    }else{
                            html +='<button type="button" class="border-start border-4 border-dashed border-warning ps-4 py-4 bg-white rounded-end text-start w-100" data-bs-toggle="modal" data-bs-target="#addNoteModal">';
                            html +='<div class="d-flex align-items-center">';
                            html +='<div class="avatar-sm me-3">';
                            html +='<div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle fs-5">';
                            html +='<i class="ri-add-line"></i>';
                            html +='</div>';
                            html +='</div>';
                            html +='<div>';
                            html +='<h6 class="fw-medium text-warning mb-0">Ajouter une note</h6>';
                            html +='<small class="text-muted">Cliquez pour ajouter une nouvelle note</small>';
                            html +='</div>';
                            html +='</div>';
                            html +='</button>';
                    }

                    $('#ListeDesNotes').html(html);
                }
            });
        }   

        function loadFicheVoeux(){
            $.ajax({
                url : "{% url 't_crm:ApiLoadFicheVoeuxProspect' %}",
                dataType : 'JSON',
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(data){
                    var html="";
                    
                    if (data.fiche_voeux.length > 0){
                        $.each(data.fiche_voeux, function(index, item){
                            html += '<div class="col-12 col-md-4 text-center mb-4 mb-md-0">';
                                    html += '<div class="avatar-lg mx-auto mb-4">';
                                        html += '<div class="avatar-title bg-info bg-opacity-10 text-info display-5 rounded-circle">';
                                            html += '<i class="ri-school-line"></i>';
                                        html += '</div>';
                                    html += '</div>';
                                    html += '<h6 class="fw-semibold mb-2">Spécialité</h6>';
                                    html += '<p class="text-muted mb-0">'+item.specialite_label+'</p>';
                                    html += '<h6 class="fw-semibold mb-2 mt-3">Promotion/Session</h6>';
                                    html += '<p class="text-muted mb-0">'+item.promo+'</p>';
                                    
                                html += '</div>';
                                html += '<div class="col-12 col-md-8 d-flex align-items-center">';
                                    html += '<div class="vstack gap-4 w-100">';
                                        html += '<div class="d-flex align-items-center justify-content-center">';
                                            html += '<div class="d-flex align-items-center bg-light rounded-3 p-3 w-100">';
                                                html += '<div class="flex-shrink-0">';
                                                    html += '<div class="avatar-sm">';
                                                        html += '<div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle">';
                                                            html += '<i class="ri-calendar-line fs-5"></i>';
                                                        html += '</div>';
                                                    html += '</div>';
                                                html += '</div>';
                                                html += '<div class="flex-grow-1 ms-3 text-center">';
                                                    html += '<h6 class="mb-1">Date de création</h6>';
                                                    html += '<small class="text-muted">'+item.created_at+'</small>';
                                                html += '</div>';
                                            html += '</div>';
                                        html += '</div>';

                                        html += '<div class="d-flex align-items-center justify-content-center">';
                                            html += '<div class="d-flex align-items-center bg-light rounded-3 p-3 w-100">';
                                                html += '<div class="flex-shrink-0">';
                                                    html += '<div class="avatar-sm">';
                                                        html += '<div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle"><i class="ri-time-line fs-5"></i></div>';
                                                    html += '</div>';
                                                html += '</div>';
                                                html += '<div class="flex-grow-1 ms-3 text-center"><h6 class="mb-1">Dernière mise à jour</h6><small class="text-muted">'+item.updated_at+'</small></div>';
                                            html += '</div>';
                                        html += '</div>';
                                        
                                    html += '</div>';
                                html += '</div>';

                                $('#editVoeuxBtn').data('id',item.id);
                        });
                    }else{
                        html += '<div class="col-12 text-center py-5">';
                        html += '<div class="avatar-lg mx-auto mb-4">';
                        html += '<div class="avatar-title bg-light text-muted display-5 rounded-circle">';
                        html += '<i class="ri-file-search-line"></i>';
                        html += '</div>';
                        html += '</div>';
                        html += '<h5 class="mb-3">Aucune fiche de vœux disponible</h5>';
                        html += '<p class="text-muted mb-4">Ce prospect n\'a pas encore de fiche de vœux enregistrée.</p>';
                        html += '<button type="button" class="btn btn-primary px-4 py-2 rounded-pill fw-medium" data-bs-toggle="modal" id="createVoeuxBtn">';
                        html += '<i class="ri-add-line me-2"></i>Créer une fiche de vœux';
                        html += '</button>';
                        html += '</div>';
                    }

                    $('#procespectVoeuxDetails').html(html);

                }
            });
        }

        function loadFicheVoeuxSupplementaire(){
            // affichage des fiches de voeux supplementaire

            $.ajax({
                url : "{% url 't_crm:ApiListeSecondWishes' %}",
                dataType : "JSON",
                type : "GET",
                data : {
                    'id_prospect' : id,
                },
                success : function(data){
                    var row = "";
                    if (data.length > 0) {
                       
                        $.each(data, function(index, item){
                            
                            row += "<tr>";
                            row += "<td>"+item.formation__nom+"</td>";
                            row += "<td>"+item.specialite__label+"</td>";
                            row += "<td>"+(item.commentaires || "")+"</td>";
                            row += "<td>";
                            row += "<div class='d-flex gap-2'>";
                            row += "<button class='btn btn-success btn-sm validate-sup-btn' data-id='"+item.id+"'><i class='ri-check-line'></i><span class='ms-1'>Valider</span></button>";
                            row += "<button class='btn btn-danger btn-sm delete-sup-btn' data-id='"+item.id+"'><i class='ri-delete-bin-line'></i><span class='ms-1'>Supprimer</span></button>";
                            row += "</div>";
                            row += "</td>";
                            row += "</tr>";
                        });
                    } else {
                       
                        row += "<tr><td colspan='4' class='text-center text-muted'>Aucune formation supplémentaire enregistrée</td></tr>";
                    }

                    $('#listeVoeuxSupplementaires').html(row);
        
                }
            })
        }

        function loadPersonalInfos(){
            $.ajax({
                url : "{% url 't_crm:ApiLoadProspectPerosnalInfos' %}",
                dataType : 'JSON',
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(data){
                    $('#nom_prenom').text(data.nom + ' ' + data.prenom);
                    $('#email').text(data.email);
                    $('#phone').text(data.telephone);
                    $('#created_at').text(data.created_at);
                    $('#statut_prospect').text(data.statut_label);

                    has_second_wished = data.has_second_wish;
                }
            });
        }

        function loadRappelRendezVous(){
            $.ajax({
                url : "{% url 't_crm:ApiLoadProspectRendezVous' %}",
                dataType: "JSON",
                type : "GET",
                data : {"id_prospect" : id},
                success : function(data){
                    var row = "";
                    if (data.length > 0){
                        $.each(data, function(index, item){
                            var statutBreak = "";
                            switch(item.statut){
                                case "nabouti":
                                    statutBreak = '<span class="badge bg-primary-subtle text-primary px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "abouti":
                                    statutBreak = '<span class="badge bg-success-subtle text-success px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "termine":
                                    statutBreak = '<span class="badge bg-danger-subtle text-danger px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "nabouti":
                                    statutBreak = '<span class="badge bg-dark-subtle text-dark px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "en_attente":
                                    statutBreak = '<span class="badge bg-warning-subtle text-warning px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                                case "annule":
                                    statutBreak = '<span class="badge bg-danger-subtle text-danger px-2 py-1"><i class="ri-time-line me-1"></i>' + item.status_label + '</span>';
                                break;

                            }
                            row += '<tr>';
                                row += '<td>';
                                    row += '<div class="d-flex align-items-center">';
                                        row += '<div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-2">';
                                            row += (item.type =="appel") ? '<i class="ri-phone-line text-primary"></i>' : '<i class="ri-calendar-line text-primary"></i>';
                                        row += '</div>';
                                        row += '<span>' + item.type_label + '</span>';
                                    row += '</div>';
                                row += '</td>';
                                row += '<td>';
                                    row += '<div class="text-body">';
                                        row += '<i class="ri-time-line text-muted me-2"></i>' + item.created_at + '';
                                    row += '</div>';
                                row += '</td>';
                                row += '<td>';
                                    row += '<div class="text-wrap" style="max-width: 200px;">';
                                        row += '' + item.object + '';
                                    row += '</div>';
                                row += '</td>';
                                row += '<td>';
                                    row += ''+statutBreak+'';
                                row += '</td>';
                                row += '<td class="text-end">';
                                    row += '<div class="d-flex justify-content-end gap-2">';
                                        row += '<button class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" id="editReminderBtn" data-id=' + item.id + '  title="Modifier">';
                                            row += '<i class="ri-edit-line"></i>';
                                        row += '</button>';
                                        row += '<button class="btn btn-soft-info btn-sm" data-bs-toggle="modal" id="detailsReminderBtn" data-id=' + item.id + '  title="Détails">';
                                            row += '<i class="ri-eye-line"></i>';
                                        row += '</button>';
                                        row += '<button class="btn btn-soft-success btn-sm" data-bs-toggle="modal" id="validateReminderBtn" data-id=' + item.id + '  title="Valider">';
                                            row += '<i class="ri-check-line"></i>';
                                        row += '</button>';
                                        row += '<button class="btn btn-soft-danger btn-sm" data-bs-toggle="modal" id="deleteReminderBtn" data-id=' + item.id + '  title="Supprimer">';
                                            row += '<i class="ri-delete-bin-line"></i>';
                                        row += '</button>';
                                    row += '</div>';
                                row += '</td>';
                            row += '</tr>';
                        });
                    }else{
                       row += "<tr><td colspan='5' class='text-muted text-center'>Aucun rendez vous planiffier</td></tr>";
                    }

                    $('#listeDesRendezVous').html(row);
                }
            });
        }

        function loadVoeuxSupplementairesCount(){

            $.ajax({
                url : "{% url 't_crm:ApiCountFormationSupplementaire' %}",
                dataType : "JSON",
                type : "GET",
                data : {
                    'id_prospect' : id,
                },
                success : function(response){
                    $('#voeuxSuppCount').text(response.count);
                       
                    if (response.count === 0) {
                        $('#voeuxSuppCount').hide();
                    } else {
                        $('#voeuxSuppCount').show();
                    }
                }
            });
           
           
        }

        loadFicheVoeuxSupplementaire();

        function loadDetailsRendezVous(id_rendez_vous){
            $.ajax({
                url : "{% url 't_crm:ApiLoadRendezVousDetails' %}",
                dataType: "JSON",
                type : "GET",
                data : {"id_rendez_vous" : id_rendez_vous},
                success : function(data){

                    $('#reminder-type').text(data[0].type_label);
                    $('#reminder-date-time').text(data[0].date_rendez_vous + ' ' + data[0].heure_rendez_vous);
                    $('#reminder-object').text(data[0].object);
                    $('#reminder-status').text(data[0].statut_label);
                    $('#reminder-description').text(data[0].description);
                    $('#detailsRendezVousModal').modal('show');
                        
                }
            });
        }

        function loadRemiderDetailsForUpdate(id_rendez_vous){
            $.ajax({
                url : "{% url 't_crm:ApiLoadRendezVousDetails' %}",
                dataType: "JSON",
                type: "GET",
                data : {'id_rendez_vous' : id_rendez_vous},
                success: function(data){
                    $('#editDescriptionRemider').val(data[0].description);
                    $('#editDateReminder').val(data[0].date_rendez_vous);
                    $('#editTimeReminer').val(data[0].heure_rendez_vous);
                    $('#editObjectReminder').val(data[0].object);
                    $('#editTypeReminder').val(data[0].type);
                    
                }
            });
        }

        function CheckIfVoeuxExiste(){
            
            $.ajax({
                url : "{% url 't_crm:ApiCheckIfVoeuxExiste' %}",
                dataType : 'JSON',
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(response){
                    if (response.status == "success"){
                        document.getElementById('editVoeuxBtn').hidden = false
                        has_voeux=true
                       
                    }else{
                        document.getElementById('editVoeuxBtn').hidden = true
                        has_voeux=false
                        
                    }
                }
            });
        }

        CheckIfVoeuxExiste();

        function BlockValidation(){

            if (has_voeux == true){
                $('#validateProspectModal').modal('show');
                $('#confirmeValidationBtn').data('id',id);
            }else{
                $('#blockValidateProspectModal').modal('show');
            }
        }

        $(document).on('click', '#validateProspectBtn', function(){
    
            BlockValidation();
           
        });


        function CheckPropspectStatut(){
            $.ajax({
                url : "{% url 't_crm:ApiCheckStatutProspect' %}",
                dataType: "JSON",
                type: 'GET',
                data: {'id_prospect' : id},
                success : function(response){
                    console.log(response.data.etat);
                    if (response.data.etat === "accepte") {
                        // cacher et désactiver
                        document.getElementById('validateProspectBtn').hidden = true;
                        document.getElementById('editVoeuxBtn').disabled = true;
                        document.getElementById('udapteProspectDetailsBtn').hidden = true;

                    } else if (response.data.etat === "en_attente") {
                        // afficher et activer
                        document.getElementById('validateProspectBtn').hidden = false;
                        document.getElementById('editVoeuxBtn').disabled = false;
                        document.getElementById('udapteProspectDetailsBtn').hidden = false;

                    }
                }
                
            });

        }

        function loadFormations(){
            $.ajax({
                url: "{% url 't_crm:ApiLoadFormation' %}",
                dataType: "JSON",
                type : "GET",
                success : function(data){
                    var row = "<option value='0'>Sélectionnez une formation</option>";
                    var row1 = "<option value='0'>Sélectionnez une promotion/session </option>";
                    $.each(data.formation, function(index, item){
                        row += "<option value="+item.id+">"+item.nom+"</option>";
                    });

                    $.each(data.promo, function(index, item){
                        row1 += "<option value="+item.code+">"+item.code+"</option>";
                    });

                    $('#promo_voeux').html(row1);
                    $('#formation_voeux').html(row);
                    $('#create_formation_voeux').html(row);

                    $('#promo_voeux_create').html(row1);
                    // Ajout pour la modale de configuration des formations supplémentaires
                    $('#config_promo_supp').html(row1);
                    $('#config_formation_supp').html(row);
                }
            })
        }

        function saveAdditionalWish(promo, specialite, commentaires){
            // store additional wishes
            $.ajax({
                url : "{% url 't_crm:ApiStoreSecondWish' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'promo' : promo,
                    'specialite' : specialite,
                    'commentaires': commentaires,
                    'id_prospect' : id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("Les données ont été sauvegarder");
                        $('#configVoeuxSuppModal').modal('hide');

                    }else{
                        alertify.error("Une erreur est survenue lors du traitement de la requete");
                    }
                }
            });
        }

        CheckPropspectStatut();
        loadNotes();
        loadFicheVoeux();
        loadPersonalInfos();
        loadRappelRendezVous();
        loadVoeuxSupplementairesCount();
       
        $(document).on('click', '#addNoteModalBtn', function(){

            $('#addNoteModal').modal('show');
        });

        $(document).on('click', '#addReminderModalBtn', function(){
            $('#addReminderModal').modal('show');
        });

        $(document).on('click', '#saveReminderBtn', function(){
            var type = $('#reminderType').val();
            var subject = $('#reminderSubject').val();
            var date = $('#reminderDate').val();
            var time = $('#reminderTime').val();
            var description = $('#reminderDescription').val();

            $.ajax({
                url: "{% url 't_crm:ApiStoreRappel' %}",
                dataType: 'JSON',
                type: 'POST',
                data: {
                    'type': type,
                    'subject': subject,
                    'date': date,
                    'time': time,
                    'description': description,
                    'id_prospect' : id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.status === 'success') {
                        $('#addReminderModal').modal('hide');
                        loadRappelRendezVous();
                        alertify.success(data.message);
                    } else {
                        alertify.error(data.message);
                    }
                }
            });
        });

        $(document).on('click', '#addReminderBtn', function(){
            $('#addReminderModal').modal('show');
        });

        $(document).on('click', '#saveNoteBtn', function(){
            var content = $('#content_note').val();
            var tags  = $('#note_tags').val();
            if (content === ""){
                alert("Le contenu de la note ne peut pas être vide.");
                return;
            }
            $.ajax({
                url : "{% url 't_crm:ApiStoreNote' %}",
                dataType : 'JSON',
                type : 'POST',
                data : {
                    'id_prospect' : id,
                    'content' : content,
                    'tags' : tags,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },
                success : function(data){
                    if (data.status === 'success'){
                        $('#addNoteModal').modal('hide');
                        loadNotes();
                        $('#content_note').val('');
                        alertify.success(data.message);
                    }else{
                        alert("Erreur lors de l'enregistrement de la note. Veuillez réessayer.");
                        alertify.error(data.message);
                    }
                }
            });
        });

        $(document).on('click', '#deleteNoteBtn', function(){
            var id_note = $(this).data('id');

            $('#deleteNoteModal').modal('show');
            $('#ConfirmDeleteNoteBtn').data('id', id_note);
        });

        $(document).on('click', '#ConfirmDeleteNoteBtn', function(){
            var id_note = $(this).data('id');
            $.ajax({
                url : "{% url 't_crm:ApiDeleteNote' %}",
                dataType : 'JSON',
                type : 'POST',
                data : {
                    'id_note' : id_note,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },
                success : function(data){
                    if (data.status === 'success'){
                        $('#deleteNoteModal').modal('hide');
                        loadNotes();
                        alertify.success(data.message);
                    }else{
                        alertify.error(data.message);
                    }
                }
            });
        });

        $(document).on('click', '#editReminderBtn', function(){
            var id_rappel = $(this).data('id');
            // Load the reminder details and show the edit modal
            loadRemiderDetailsForUpdate(id_rappel);
            $('#editReminderBtnSave').data('id', id_rappel);
            $('#editReminderModal').modal('show');
                       
        });

        $(document).on('click','#editReminderBtnSave', function(){
            var editedDescription = $('#editDescriptionRemider').val();
            var editedType = $('#editTypeReminder').val();
            var editedDate = $('#editDateReminder').val();
            var editedTime = $('#editTimeReminer').val();
            var editedObject = $('#editObjectReminder').val();
            var id_rappel = $(this).data('id');
            $.ajax({
                url : "{% url 't_crm:ApiUpdateRappel' %}",
                dataType : 'JSON',
                type: 'POST',
                data : {
                    'id_rappel' : id_rappel,
                    'type' : editedType,
                    'subject' : editedObject,
                    'date' : editedDate,
                    'time' : editedTime,
                    'description' : editedDescription,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },

                success : function(response){
                    if(response.status == "success"){
                        alertify.success(response.message);
                        loadRappelRendezVous();
                        $('#editReminderModal').modal('hide');
                        
                    }else{
                        alertify.error(response.message);
                    }
                }
            })
        });

        $(document).on('click', '#detailsReminderBtn', function(){
            var id_rappel = $(this).data('id');
            loadDetailsRendezVous(id_rappel);
            
            $('#detailsReminderModal').modal('show');
        });

        $(document).on('click', '#deleteReminderBtn', function(){
            var id_rappel = $(this).data('id');
            // Load the reminder details and show the delete modal
            $('#deleteReminderModal').modal('show');
            $('#ConfirmDeleteReminderBtn').data('id', id_rappel);
        });

        $(document).on('click', '#validateReminderBtn', function(){
            var id_rappel = $(this).data('id');
            $('#observation_rappel').val('');
            $('#validateReminderModal').modal('show');
            $('#confirmValidateReminderBtn').data('id', id_rappel);
        });

        $(document).on('click', '#confirmValidateReminderBtn', function(){
            var id_rappel = $(this).data('id');
            var observation = $('#observation_rappel').val();
            var statut_reminder = $('#validate_statut_reminder').val();

            $.ajax({
                url : "{% url 't_crm:ApiValidateRemider' %}",
                dataType : "JSON",
                type: 'POST',
                data : {
                    'id_reminder' : id_rappel,
                    'description' : observation,
                    'statut_reminder' : statut_reminder,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("La validation du rappel a été effecuter avec succès");
                        loadRappelRendezVous();
                        $('#validateReminderModal').modal('hide');
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete !");
                    }
                }
            })
        });

        // Gestion de la modification des voeux
        $(document).on('click', '#editVoeuxBtn', function(){
            var id_voeux = $(this).data('id');
           
            loadFormations();
            $('#editVoeuxModal').modal('show');
            $('#saveVoeuxBtn').data('id', id_voeux);

        });

        $(document).on('click', '#createVoeuxBtn', function(){
             loadFormations();
             $('#createVoeuxModal').modal('show');
        })

        $(document).on('change', '#formation_voeux', function(){
            var id_formation = $(this).val();
            $.ajax({
                url : "{% url 't_crm:ApiLoadSpecialite' %}",
                dataType: "JSON",
                type : "GET",
                data : {"id_formation" : id_formation},
                success : function(data){
                    var row = "<option value='0'>Sélectionnez une spécialité</option>";
                    $.each(data, function(index, item){
                        row += "<option value="+item.id+">"+item.label+"</option>";
                    });
                    $('#specialite_voeux').html(row);
                }
            });
        });

        $(document).on('change', '#create_formation_voeux', function(){
            var id_formation = $(this).val();
            $.ajax({
                url : "{% url 't_crm:ApiLoadSpecialite' %}",
                dataType: "JSON",
                type : "GET",
                data : {"id_formation" : id_formation},
                success : function(data){
                    var row = "<option value='0'>Sélectionnez une spécialité</option>";
                    $.each(data, function(index, item){
                        row += "<option value="+item.id+">"+item.label+"</option>";
                    });
                    $('#create_specialite_voeux').html(row);
                }
            });
        });

        // Compteur de caractères pour les commentaires
        $('#commentaires_voeux').on('input', function() {
            var count = $(this).val().length;
            $('#commentairesCount').text(count);
        });

        $('#create_commentaires_voeux').on('input', function() {
            var count = $(this).val().length;
            $('#createCommentairesCount').text(count);
        });

        $(document).on('click', '#saveVoeuxBtn', function(){
            var specialite = $('#specialite_voeux').val();
            var commentaires = $('#commentaires_voeux').val();
            var promo  = $('#promo_voeux').val();
            var id_voeux = $(this).data('id');
            
            $.ajax({
                url : "{% url 't_crm:ApiUpdateVoeux' %}",
                dataType: "JSON",
                type : "POST",
                data : {
                    'specialite' : specialite,
                    'id_prospect' : id,
                    'id_voeux' : id_voeux,
                    'promo': promo,
                    "comment" : commentaires,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if (response.status == "success"){
                        alertify.success(response.message);
                        loadFicheVoeux()
                        $('#editVoeuxModal').modal('hide');
                    }else{
                        alertify.error(response.message);
                    }
                }
            });
        });

        $(document).on('click', '#saveCreateVoeuxBtn', function(){
            var specialite = $('#create_specialite_voeux').val();
            var commentaires = $('#create_commentaires_voeux').val();
            var promo = $('#promo_voeux_create').val();
            
            $.ajax({
                url : "{% url 't_crm:ApiCreateVoeux' %}",
                dataType: "JSON",
                type : "POST",
                data : {
                    'specialite' : specialite,
                    'id_prospect' : id,
                    'promo': promo,
                    "comment" : commentaires,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if (response.status == "success"){
                        alertify.success(response.message);
                        loadFicheVoeux()
                        $('#createVoeuxModal').modal('hide');
                        
                        // Réinitialiser les champs du formulaire
                        $('#promo_voeux_create').val('0');
                        $('#create_formation_voeux').val('0');
                        $('#create_specialite_voeux').html("<option value='0'>Sélectionnez une spécialité</option>");
                        $('#create_commentaires_voeux').val('');
                        CheckIfVoeuxExiste();
                    }else{
                        alertify.error(response.message);
                    }
                }
            });
        });

        $(document).on('click','#ConfirmDeleteReminderBtn', function(){
            var id_reminder = $(this).data('id');
            $.ajax({
                url :"{% url 't_crm:ApiArchiveReminder' %}",
                dataType : "JSON",
                type: "GET",
                data : {
                    'id_reminder' :  id_reminder,
                },
                success : function(response){
                    if (response.status === "success"){
                        alertify.success("Suppression effectué avec succès");
                        loadRappelRendezVous();
                        $('#deleteReminderModal').modal('hide');
                    }else{  
                        alertify.error("Une erreur c'est produite lors du traitement de la requete !");
                    }
                }
            });
        });
        

        $(document).on('click', '#confirmeValidationBtn', function(){
            var id_prospect = $(this).data('id');
            $.ajax({
                url : "{% url 't_crm:ApiValidateProspect' %}",
                dataType : 'JSON',
                type : 'POST',
                data : {
                    'id_prospect' : id_prospect,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },
                success : function(data){
                    if (data.status === 'success'){
                        $('#validateProspectModal').modal('hide');
                        CheckPropspectStatut();
                        alertify.success(data.message);
                        
                    }else{
                        alertify.error(data.message);
                    }
                }
            });
        });

        // Gestion du bouton de configuration des voeux supplémentaires
        $(document).on('click', '#configVoeuxSuppBtn', function(){
            loadFormations(); // Recharger les formations pour la configuration
            $('#configVoeuxSuppModal').modal('show');
        });

        // Gestion du lien pour voir les voeux supplémentaires
        $(document).on('click', '#voirVoeuxSuppLink', function(){
            loadFicheVoeuxSupplementaire();
            // Charger et afficher les formations supplémentaires
            $('#voeuxSuppModal').modal('show');
        });

        // Gestion du bouton d'ajout dans la modale des voeux supplémentaires
        $(document).on('click', '#addVoeuxSuppBtn', function(){
            $('#voeuxSuppModal').modal('hide');
            loadFormations(); // Recharger les formations pour la configuration
            $('#configVoeuxSuppModal').modal('show');
        });

        $(document).on('change', '#config_formation_supp', function(){
            var id_formation = $(this).val();
            $.ajax({
                url : "{% url 't_crm:ApiLoadSpecialite' %}",
                dataType: "JSON",
                type : "GET",
                data : {"id_formation" : id_formation},
                success : function(data){
                    var row = "<option value='0'>Sélectionnez une spécialité</option>";
                    $.each(data, function(index, item){
                        row += "<option value="+item.id+">"+item.label+"</option>";
                    });
                    $('#config_specialite_supp').html(row);
                }
            });
        })
     
        // Compteur de caractères pour les commentaires (configuration)
        $('#config_commentaires_supp').on('input', function() {
            var count = $(this).val().length;
            $('#configCommentairesCount').text(count);
        });

        // Enregistrement d'un voeu supplémentaire
        $(document).on('click', '#saveConfigVoeuxSuppBtn', function(){
            var promo = $('#config_promo_supp').val();
            var formation = $('#config_formation_supp').val();
            var specialite = $('#config_specialite_supp').val();
            var commentaires = $('#config_commentaires_supp').val();
            
            saveAdditionalWish(promo, specialite, commentaires);
            $('#configVoeuxSuppModal').modal('hide'); 
           
        });

        // Gestion du bouton de validation des voeux supplémentaires
        $(document).on('click', '#validateVoeuxSuppBtn', function(){
            $('#voeuxSuppModal').modal('hide');
            $('#validateVoeuxSuppModal').modal('show');
        });


        // Gestion des boutons de validation individuelle des formations supplémentaires
        $(document).on('click', '.validate-sup-btn', function(){
            var id_voeux_supp = $(this).data('id');
            $('#voeuxSuppModal').modal('hide');
            $('#validateVoeuxSuppModal').modal('show');
            
            // Stocker l'ID du voeu supplémentaire à valider
            $('#confirmValidateVoeuxSuppBtn').data('id', id_voeux_supp);
        });

        // Confirmation de la validation d'un voeu supplémentaire spécifique
        $(document).on('click', '#confirmValidateVoeuxSuppBtn', function(){
            var id_voeux_supp = $(this).data('id');
        
            $('#validateVoeuxSuppModal').modal('hide');
        });

        // Gestion du bouton de suppression des voeux supplémentaires
        $(document).on('click', '.delete-sup-btn', function(){
            var id_voeux_supp = $(this).data('id');
            // Afficher la modale de confirmation de suppression
            $('#deleteVoeuxSuppModal').modal('show');
            // Stocker l'ID du voeu supplémentaire à supprimer
            $('#confirmDeleteVoeuxSuppBtn').data('id', id_voeux_supp);
        });

        // Confirmation de la suppression d'un voeu supplémentaire
        $(document).on('click', '#confirmDeleteVoeuxSuppBtn', function(){
            var id_voeux_supp = $(this).data('id');
            
            $.ajax({
                url : "{% url 't_crm:ApiDeleteSecondWish' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'id_voeux_supp' : id_voeux_supp,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if (response.status === "success") {
                        // Masquer la modale de confirmation
                        $('#deleteVoeuxSuppModal').modal('hide');
                        // Recharger la liste des voeux supplémentaires
                        loadFicheVoeuxSupplementaire();
                        // Mettre à jour le compteur
                        loadVoeuxSupplementairesCount();
                        // Afficher un message de succès
                        alertify.success("La fiche de voeux a été supprimée avec succès");
                    } else {
                        // Afficher un message d'erreur
                        alertify.error("Une erreur est survenue lors de la suppression");
                    }
                },
                error : function() {
                    // Afficher un message d'erreur
                    alertify.error("Une erreur est survenue lors de la suppression");
                }
            });
        });

        $(document).on('click', '#udapteProspectDetailsBtn', function(){
            var id_prospect = $(this).data('id');

            $.ajax({
                url : "{% url 't_crm:ApiLoadProspectPerosnalInfos' %}",
                dataType : 'JSON',
                type : 'GET',
                data : {'id_prospect' : id},
                success : function(data){
                    $('#edit_nom').val(data.nom);
                    $('#edit_prenom').val(data.prenom);
                    $('#edit_email').val(data.email);
                    $('#edit_telephone').val(data.telephone);
                    $('#edit_observation').val(data.observation);
                    // Load the prospect details and show the edit modal
                    $('#editProspectModal').modal('show');
                }
            });

            
        });

        $(document).on('click','#validateUpdateProspectDetailsBtn', function(){

            var edit_nom = $("#edit_nom").val();
            var edit_prenom = $("#edit_prenom").val();
            var edit_email = $("#edit_email").val();
            var edit_telephone = $("#edit_telephone").val();
            var edit_observation = $('#edit_observation').val();

            
            $.ajax({
                url : "{% url 't_crm:ApiUpdateProspectData' %}",
                dataType: "JSON",
                type: 'POST',
                data : {
                    'nom' : edit_nom,
                    'prenom' : edit_prenom,
                    'email' : edit_email,
                    'telephone' : edit_telephone,
                    'observation' : edit_observation,
                    'id_prospect' : id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'

                },
                success : function(response){
                    if (response.status == "success"){
                        alertify.success(response.message);
                        loadPersonalInfos();
                    }else{
                        alertify.error(response.message);
                    }

                    $('#editProspectModal').modal('hide');

                }
            })
        });

    });
</script>

{% endblock content %}