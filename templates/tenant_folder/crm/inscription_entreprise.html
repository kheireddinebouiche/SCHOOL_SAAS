{% extends 'tenant_folder/base.html' %}
{% block title %}CRM - Nouveau visiteur{% endblock title %}
{% block content %}

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-building text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Nouveau prospect - Entreprise</h4>
            </div>
            <div class="page-title-right">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);" class="text-muted">
                      <i class="fas fa-home me-1"></i>CRM
                    </a>
                  </li>
                  <li class="breadcrumb-item active text-info">Nouveau prospect - Entreprise</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-gradient-info text-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                  <i class="fas fa-building me-2"></i>Nouveau prospect
                </h4>
                <span class="badge bg-white text-info px-3 py-2">Entreprise</span>
              </div>
            </div>
            <div class="card-body p-3">
              <form method="POST" class="needs-validation" novalidate onsubmit="this.querySelector('button[type=submit]').disabled = true;">
                {% csrf_token %}
                <!-- Informations entreprise -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-building text-info me-2"></i>
                    <h5 class="text-info mb-0">Informations entreprise</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-12">
                      <label class="form-label" for="id_entreprise">{{form.entreprise.label}}</label>
                      {{form.entreprise}}
                    </div>
                  </div>
                </div>

                <!-- Contact principal -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-user text-info me-2"></i>
                    <h5 class="text-info mb-0">Contact principal</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-6">
                      <label class="form-label">{{form.nom.label}}</label>
                      {{form.nom}}
                    </div>
                    <div class="col-lg-6">
                      <label class="form-label">{{form.prenom.label}}</label>
                      {{form.prenom}}
                    </div>
                  </div>
                </div>

                <!-- Coordonnées -->
                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-address-card text-info me-2"></i>
                    <h5 class="text-info mb-0">Coordonnées</h5>
                  </div>
                  <div class="row g-3">
                    <div class="col-lg-4">
                      <label class="form-label">{{form.email.label}}</label>
                      {{form.email}}
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label" for="{{ form.telephone.id_for_label }}">Téléphone</label>
                      <div class="d-flex">
                        <div class="me-2" style="max-width: 110px;">
                          {{ form.indic }}
                        </div>
                        <div style="flex: 1;">
                          {{ form.telephone }}
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label">{{form.canal.label}}</label>
                      {{form.canal}}
                    </div>
                  </div>
                </div>

                <div class="bg-light p-3 rounded-3 mb-3 border">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-comment text-info me-2"></i>
                    <h5 class="text-info mb-0">Observation</h5>
                  </div>
                  <label class="form-label">{{form.observation.label}}</label>
                      {{form.observation}}
                </div>

                <!-- Submit button -->
                <div class="text-end mt-3">
                  <button type="submit" class="btn btn-info px-4 py-2 text-white">
                    <i class="fas fa-save me-2"></i>Enregistrer
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    // Vous pouvez ajouter ici le code JavaScript nécessaire
  });
</script>

<script>
  (function() {
      // formate la valeur : 0612345678 -> 06-12-34-56-78
      function formatTelephone(val) {
          const digits = val.replace(/\D/g, '').substring(0, 10);
          return digits.replace(/(\d{2})(?=\d)/g, '$1-');
      }

      // écoute les input sur tout le document (fonctionne aussi pour éléments dynamiques)
      document.addEventListener('input', function(e) {
          const el = e.target;
          if (!el.classList || !el.classList.contains('telephoneID')) return;

          // nombre de chiffres avant le curseur (pour restaurer la position)
          const selStart = el.selectionStart || 0;
          const digitsBefore = el.value.slice(0, selStart).replace(/\D/g, '').length;

          // formater et appliquer
          const formatted = formatTelephone(el.value);
          el.value = formatted;

          // calculer nouvelle position du curseur en fonction des chiffres avant
          let pos = 0, d = 0;
          while (pos < formatted.length && d < digitsBefore) {
              if (/\d/.test(formatted[pos])) d++;
              pos++;
          }
          el.setSelectionRange(pos, pos);
      });

      // avant envoi du formulaire, supprimer les tirets (si submission classique ou via JS qui déclenche submit)
      document.addEventListener('submit', function(e) {
          const form = e.target;
          if (!(form instanceof HTMLFormElement)) return;
          form.querySelectorAll('.telephoneID').forEach(function(input) {
              input.value = input.value.replace(/\D/g, ''); // garde que les chiffres
          });
      });
  })();
</script>

{% endblock content %}