{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Configuration des Cours - Emploi du Temps{% endblock title %}

{% block extra_head %}
{% endblock extra_head %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Additional styles for configuration page */
  .config-section {
    margin-bottom: 30px;
  }
  
  .config-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .config-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .config-body {
    padding: 20px;
  }
  
  .config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .config-actions .btn {
    margin-bottom: 5px;
  }
  
  .time-input {
    width: 120px;
    display: inline-block;
    margin: 0 5px;
  }
  
  /* Course session specific styles */
  .session-card {
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-calendar-alt text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Configuration des Cours - Emploi du Temps</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Emploi du Temps</a>
                  </li>
                  <li class="breadcrumb-item active">Configuration des Cours</li>
                </ol>
              </nav>
              <button type="button" class="btn btn-info btn-sm" id="printTimetableBtn">
                <i class="ri-printer-line me-1"></i>Imprimer
              </button>
              {% if not timetable.is_validated %}
                <button type="button" class="btn btn-success btn-sm" id="validateTimetableBtn" data-bs-toggle="modal" data-bs-target="#validateTimetableModal">
                  <i class="ri-check-line me-1"></i>Valider l'Emploi du Temps
                </button>
              {% endif %}
              {% if timetable.is_validated %}
                <button type="button" class="btn btn-warning btn-sm" id="reactiveModification" data-bs-toggle="modal" data-bs-target="#timetableWarningModal">
                  <i class="ri-shield-keyhole-line me-1"></i>Réactiver la modifications
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Timetable Details Section -->
      {% if timetable %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex align-items-center">
                <i class="fas fa-calendar-alt text-info me-2"></i>
                <h5 class="card-title mb-0 text-info">Détails de l'Emploi du Temps</h5>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Label:</label>
                    <p class="mb-0">{{ timetable.label }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Groupe:</label>
                    <p class="mb-0">{{ timetable.groupe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Spécialité:</label>
                    <p class="mb-0">{{ timetable.groupe.specialite.label }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Semestre:</label>
                    <p class="mb-0">{{ timetable.semestre }}</p>
                  </div>
                </div>
              </div>
              {% if timetable.description %}
              <div class="row mt-2">
                <div class="col-12">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Description:</label>
                    <p class="mb-0">{{ timetable.description }}</p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row">
        <div class="col-lg-12">
          <!-- Course Sessions Configuration -->
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-book text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Séances de Cours</h5>
                </div>
                {% if not timetable.is_validated %}
                <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addSessionModal">
                  <i class="ri-add-line me-1"></i> Ajouter une séance
                </button>
                {% endif %}
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Module</th>
                      <th class="border-0">Jour</th>
                      <th class="border-0">Horaire</th>
                      <th class="border-0">Professeur</th>
                      <th class="border-0">Salle</th>
                      {% if not timetable.is_validated %}
                        <th class="border-0 rounded-end text-center">Actions</th>
                      {% endif %}
                    </tr>
                  </thead>
                  <tbody id="sessionsTableBody">
                    
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for adding course session -->
<div class="modal fade" id="addSessionModal" tabindex="-1" aria-labelledby="addSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-book-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="addSessionModalLabel">
              Ajouter une nouvelle séance
            </h5>
            <p class="text-muted small mb-0">Configurez les détails de la séance de cours</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Notification alert -->
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
          <i class="ri-information-line me-2"></i>
          <strong>Information:</strong> Les modules affichés sont filtrés préalablement par rapport au semestre et à la répartition semestrielle déjà configurée.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <form id="addSessionForm">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_module">Module <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_module" name="module" required>
                <option value="">Sélectionnez un module</option>
                {% for cours in modules %}
                  <option value="{{cours.module.code}}">{{ cours.module.code }} - {{ cours.module.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_professeur">Professeur <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_professeur" name="professeur" required>
                <option value="">Sélectionnez un professeur</option>
                
              </select>
            </div>
            <!-- Teacher availability section - shown when teacher is selected -->
            <div class="col-lg-12" id="teacherAvailabilitySection" style="display: none;">
              <div class="card border-info border-1 bg-light mt-3">
                <div class="card-header bg-info bg-opacity-10 p-2">
                  <h6 class="card-title mb-0 text-info d-flex align-items-center">
                    <i class="ri-user-settings-line me-2"></i>Disponibilité de l'enseignant
                  </h6>
                </div>
                <div class="card-body p-2">
                  <div class="row g-2">
                    <div class="col-md-12">
                      <div class="info-item">
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered small mb-0">
                            <thead class="table-light">
                              <tr>
                                <th class="text-center" style="width: 30%;">Jour</th>
                                <th class="text-center" style="width: 40%;">Disponibilité</th>
                                <th class="text-center" style="width: 30%;">Affectation</th>
                              </tr>
                            </thead>
                            <tbody id="teacherWorkload">
                              <tr>
                                <td colspan="3" class="text-center text-muted">Aucun</td>
                              </tr>
                            </tbody>
                          </table>
                          <div id="teacherAvailabilityLoader" class="d-none text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                              <span class="visually-hidden">Chargement...</span>
                            </div>
                            <small class="text-muted ms-2">Chargement des disponibilités...</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
           
          <div class="row g-3 mt-2">
             <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_jour">Jour <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_jour" name="jour" required>
                <option value="">Sélectionnez un jour</option>
                {% for jour in jour_data.jours_travail %}
                  <option value="{{ jour }}">{{ jour|capfirst }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_horaire">Horaire <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_horaire" name="horaire" required>
                <option value="">Sélectionnez un horaire</option>
                {% for horaire in horaire_data.plages_horaires %}
                  <option data-heure-debut="{{horaire.heure_debut}}" data-heure-fin="{{horaire.heure_fin}}" value="{{ horaire.id }}">{{ horaire.nom_creneau }} ({{ horaire.heure_debut }} - {{ horaire.heure_fin }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
            
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-12">
              <label class="form-label fw-medium" for="session_salle">Salle <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_salle" name="salle" required>
                <option value="">Sélectionnez une salle</option>
                {% for salle in salles %}
                  <option value="{{ salle.id }}">{{ salle.nom }} ({{ salle.code }}) - {{ salle.capacite }} places</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="addSessionError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="saveSessionBtn">
          <i class="ri-save-line me-2"></i>Enregistrer la séance
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming session deletion -->
<div class="modal fade" id="deleteSessionModal" tabindex="-1" aria-labelledby="deleteSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteSessionModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer la séance. 
            Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteSessionBtn">
          <i class="ri-delete-bin-line me-2"></i>Confirmer la suppression
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming timetable validation -->
<div class="modal fade" id="validateTimetableModal" tabindex="-1" aria-labelledby="validateTimetableModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-checkbox-circle-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="validateTimetableModalLabel">
              Confirmation de validation
            </h5>
            <p class="text-muted small mb-0">Cette action rendra l'emploi du temps officiel</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-checkbox-circle-line text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3">Valider l'emploi du temps ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de valider l'emploi du temps <strong>{{ timetable.label }}</strong>.
            Cette action rendra l'emploi du temps officiel et les modifications futures seront restreintes.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="confirmValidateTimetableBtn">
          <i class="ri-check-line me-2"></i>Confirmer la validation
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for warning about timetable modification risks -->
<div class="modal fade" id="timetableWarningModal" tabindex="-1" aria-labelledby="timetableWarningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-alert-line text-warning fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-warning mb-1" id="timetableWarningModalLabel">
              Avertissement - Modification de l'emploi du temps
            </h5>
            <p class="text-muted small mb-0">Veuillez prendre connaissance des risques</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <i class="ri-alert-line text-warning" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-warning mb-4 text-center">Faites attention aux risques de modification</h4>
        <div class="alert alert-warning bg-warning bg-opacity-10 border border-warning border-opacity-25">
          <ul class="mb-0">
            <li>Les modifications peuvent affecter les emplois du temps déjà distribués aux étudiants et enseignants</li>
            <li>Les conflits de salles ou d'enseignants peuvent survenir suite à des modifications inattendues</li>
            <li>Les absences ou imprévus peuvent nécessiter des modifications urgentes de dernière minute</li>
            <li>Les enseignants peuvent avoir planifié leur préparation en fonction des séances actuelles</li>
            <li>Une mauvaise coordination des modifications peut entraîner des confusions importantes</li>
          </ul>
        </div>
        <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25">
          <p class="mb-0">
            <strong>Conseil:</strong> Assurez-vous que toutes les parties concernées sont informées des modifications 
            et que les changements sont nécessaires et bien planifiés avant de procéder.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Retour
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="continueModificationBtn">
          <i class="ri-check-line me-2"></i>Continuer les modifications
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Function to dynamically load jsPDF if not already loaded
  function loadPDFLibraries() {
    return new Promise((resolve, reject) => {
      // Check if library is already loaded
      if (typeof window.jspdf !== 'undefined') {
        resolve();
        return;
      }

      // Create script element for jsPDF
      const jsPDFScript = document.createElement('script');
      jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      
      jsPDFScript.onload = () => {
        // Small delay to ensure library is fully initialized
        setTimeout(resolve, 100);
      };
      
      jsPDFScript.onerror = () => reject(new Error('Failed to load jsPDF'));
      
      document.head.appendChild(jsPDFScript);
    });
  }

  $(document).ready(function () {

    var timetable="{{pk}}";

    function loadTimeTableEntry(){
      $.ajax({
        url : "{% url 't_timetable:ApiLoadTableEntry' %}",
        dataType : "JSON",
        type: "GET",
        data:{
          'timetable' : timetable,
        },
        success : function(data){
          var row = "";
          if(data.length > 0){
              $.each(data, function(index, p){
                row +='<tr><td><div class="d-flex align-items-center">';
                row +=' <div class="flex-grow-1"><h6 class="mb-0 fw-semibold">'+p.cours__code+'-'+p.cours__label+'</h6></div></div></td>';
                row +=' <td><div class="fw-medium">'+p.jour+'</div></td>';
                row +='<td><div class="text-body">'+p.heure_debut+'-'+p.heure_fin+'</div></td>';
                row +='<td><div class="text-body">'+p.formateur__nom+' '+p.formateur__prenom+'</div></td>';
                row +='<td><div class="text-body">'+p.salle__nom+'('+p.salle__code+')'+'</div></td>';
                row +='<td class="text-end">';
                row +=' <button type="button" '+(p.timetable__is_validated ? 'hidden' : '')+' class="btn btn-danger btn-sm delete-session" data-session-id="'+p.id+'">';
                row +=' <i class="ri-delete-bin-line"></i>';
                row +='</button>';
                row +='</td>';
                row +=' </tr>';
            });
          }else{
            row+='<tr>';
              row+='<td colspan="6" class="text-center text-muted">';
                row+='<div class="d-flex flex-column align-items-center justify-content-center py-5">';
                    row+='<div class="avatar-sm mb-4">';
                        row+='<div class="avatar-title bg-light text-muted rounded-circle fs-1">';
                            row+='<i class="ri-book-line"></i>';
                        row+='</div>';
                    row+='</div>';
                    row+='<h5 class="mb-2">Aucune séance de cours trouvée</h5>';
                    row+='<p class="text-muted mb-0">Il n\'y a aucune séance de cours programmée pour le moment</p>';
                row+='</div>';
              row+='</td>';
            row+='</tr>';
          }

          $('#sessionsTableBody').html(row);
          
        },
      });
    }

    

    loadTimeTableEntry();

    // Handle adding session
    $('#saveSessionBtn').on('click', function() {

      var session_module = document.getElementById('session_module').value;
      var session_professeur = document.getElementById('session_professeur').value;
      var session_jour = document.getElementById('session_jour').value;

      var selectedOption = $('#session_horaire option:selected');

      var heure_debut = selectedOption.data('heure-debut');
      var heure_fin = selectedOption.data('heure-fin');

      var session_salle = document.getElementById('session_salle').value;

      // Hide any previous error messages
      $('#addSessionError').addClass('d-none');

      $.ajax({
        url: '{% url "t_timetable:save_session" %}',
        type: 'POST',
        data: {
          'session_module' : session_module,
          'session_professeur' : session_professeur,
          'session_jour' : session_jour,
          'heure_debut' : heure_debut,
          'heure_fin' : heure_fin,
          'session_salle' : session_salle,
          'pk' : timetable,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);

            $('#session_module').val("");
            $('#session_professeur').val("");
            $('#session_jour').val("");
            $('#session_horaire').val("");
            $('#session_salle').val("");
            $('#teacherAvailabilitySection').hide();

            $('#addSessionModal').modal('hide');
            loadTimeTableEntry();
          } else {
            $('#addSessionError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de l\'ajout de la séance.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de l\'ajout de la séance.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#addSessionError').removeClass('d-none').text(errorMessage);
        },
        
      });
    });

    
    $(document).on('click', '.delete-session', function() {
      var sessionId = $(this).data('session-id');
      console.log(sessionId);
      $('#confirmDeleteSessionBtn').data('session-id', sessionId);
      $('#deleteSessionModal').modal('show');
    });
    
    
    $(document).on('click','#confirmDeleteSessionBtn', function() {
      var sessionId = $(this).data('session-id');
      
      $.ajax({
        url: '{% url "t_timetable:ApiDeleteCoursSession" %}',
        type: 'POST',
        dataType:"JSON",
        data: {
          'id': sessionId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#deleteSessionModal').modal('hide');
            loadTimeTableEntry();

          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la suppression de la séance.');
          }
        },
        error: function(xhr, status, error) {
          alertify.error('Une erreur est survenue lors de la suppression de la séance.');
          $('#deleteSessionModal').modal('hide'); 
        }
      });
    });

    // Handle print timetable button - Generate PDF instead of opening new window
    $('#printTimetableBtn').on('click', function() {
      // Show loading message while libraries load
      const originalBtnText = $('#printTimetableBtn').html();
      $('#printTimetableBtn').html('<i class="ri-loader-4-line ri-spin me-1"></i>Chargement...');
      $('#printTimetableBtn').prop('disabled', true);
      
      loadPDFLibraries()
        .then(() => {
          // Use ApiLoadTableEntry to get the actual data for PDF generation
          $.ajax({
            url : "{% url 't_timetable:ApiLoadTableEntry' %}",
            dataType : "JSON",
            type: "GET",
            data:{
              'timetable' : timetable,
            },
            success : function(data){
              // Process the data directly in the PDF without creating HTML
              
              // Create a structured timetable with hours as rows and days as columns
              // First, we need to organize the data by hours and days
              // Get all unique days from the data and normalize them
              const allDaysSet = new Set();
              data.forEach(p => {
                if (p.jour && p.heure_debut && p.heure_fin) {  // Only add days that have complete time information
                  // Normalize day names (capitalize first letter)
                  const normalizedDay = p.jour.charAt(0).toUpperCase() + p.jour.slice(1).toLowerCase();
                  allDaysSet.add(normalizedDay);
                }
              });
              const allDays = Array.from(allDaysSet);
              
              // Define standard day order
              const dayOrder = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
              
              // Sort the days according to our preferred order, only including days that have sessions
              const orderedDays = dayOrder.filter(day => allDays.includes(day));
              
              // Get unique time slots and sort them
              const timeSlots = [...new Set(data.filter(p => p.heure_debut && p.heure_fin)
                .map(p => p.heure_debut + '-' + p.heure_fin))].sort();
              
              // Create a mapping of the data by time and day
              const scheduleMap = {};
              data.forEach(p => {
                if (p.jour && p.heure_debut && p.heure_fin) {
                  const normalizedDay = p.jour.charAt(0).toUpperCase() + p.jour.slice(1).toLowerCase();
                  const timeSlot = p.heure_debut + '-' + p.heure_fin;
                  const key = normalizedDay + '_' + timeSlot;
                  scheduleMap[key] = p;
                }
              });
              
              // Generate PDF using jsPDF with native drawing
              const doc = new window.jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
              });
              
              // Set up initial position and margins for landscape
              let yPosition = 20; // Start 20mm from top
              const pageHeight = 210; // A4 page height in landscape mm
              const pageWidth = 297; // A4 page width in landscape mm
              const leftMargin = 15;
              const rightMargin = 15;
              const contentWidth = pageWidth - leftMargin - rightMargin; // A4 width minus margins
              
              // Add title
              doc.setFontSize(20);
              doc.text('Emploi du Temps', pageWidth/2, yPosition, { align: 'center' });
              yPosition += 15;
              
              // Add timetable details
              doc.setFontSize(12);
              doc.setFont(undefined, 'bold');
              doc.text(`Label:`, leftMargin, yPosition);
              doc.setFont(undefined, 'normal');
              doc.text(`{{ timetable.label }}`, leftMargin + 25, yPosition);
              yPosition += 7;
              
              doc.setFont(undefined, 'bold');
              doc.text(`Groupe:`, leftMargin, yPosition);
              doc.setFont(undefined, 'normal');
              doc.text(`{{ timetable.groupe.nom }}`, leftMargin + 25, yPosition);
              yPosition += 7;
              
              doc.setFont(undefined, 'bold');
              doc.text(`Classe:`, leftMargin, yPosition);
              doc.setFont(undefined, 'normal');
              doc.text(`{{ timetable.groupe.classe.nom }}`, leftMargin + 25, yPosition);
              yPosition += 7;
              
              doc.setFont(undefined, 'bold');
              doc.text(`Semestre:`, leftMargin, yPosition);
              doc.setFont(undefined, 'normal');
              doc.text(`{{ timetable.semestre }}`, leftMargin + 25, yPosition);
              yPosition += 7;
              
              {% if timetable.description %}
              doc.setFont(undefined, 'bold');
              doc.text(`Description:`, leftMargin, yPosition);
              doc.setFont(undefined, 'normal');
              doc.text(`{{ timetable.description }}`, leftMargin + 25, yPosition);
              yPosition += 7;
              {% endif %}
              
              yPosition += 10; // Add some space before the table
              
              // Define table headers (time slots) and row headers (days)
              const days = orderedDays;
              if (data.length === 0 || days.length === 0) {
                // No sessions
                doc.setFontSize(12);
                doc.text('Aucune séance de cours programmée', pageWidth/2, yPosition, { align: 'center' });
                yPosition += 10;
                
                // Add footer
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text(`Impression générée le ${new Date().toLocaleString('fr-FR')}`, pageWidth/2, pageHeight - 10, { align: 'center' });
                
                // Save the PDF with a smaller file size
                doc.save(`Emploi_du_temps-${document.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                
                // Restore button
                $('#printTimetableBtn').html(originalBtnText);
                $('#printTimetableBtn').prop('disabled', false);
                return; // Exit early
              }
              
              // Calculate column widths based on number of time slots
              const headerCols = 1; // One column for days
              const numCols = timeSlots.length + headerCols; // Additional columns for each time slot
              const colWidth = contentWidth / numCols;
              
              // Draw table header with time slots
              doc.setFillColor(242, 242, 242); // Light gray background for header
              doc.rect(leftMargin, yPosition, colWidth, 10, 'F'); // Day header column
              doc.setFont(undefined, 'bold');
              doc.setFontSize(10);
              doc.text('Jours', leftMargin + colWidth/2, yPosition + 6, { align: 'center' });
              
              // Draw time slot headers
              for (let i = 0; i < timeSlots.length; i++) {
                const x = leftMargin + (i + 1) * colWidth;
                doc.rect(x, yPosition, colWidth, 10, 'F');
                doc.text(timeSlots[i], x + colWidth/2, yPosition + 6, { align: 'center' });
              }
              
              // Draw borders
              for (let i = 0; i <= numCols; i++) {
                const x = leftMargin + i * colWidth;
                doc.line(x, yPosition, x, yPosition + 10); // Vertical lines
              }
              doc.line(leftMargin, yPosition, leftMargin + contentWidth, yPosition); // Top horizontal line
              doc.line(leftMargin, yPosition + 10, leftMargin + contentWidth, yPosition + 10); // Bottom horizontal line
              
              yPosition += 10;
              
              // Add table rows for each day
              doc.setFont(undefined, 'normal');
              doc.setFontSize(9);
              
              // Process each day as a row
              if(days.length > 0){
                $.each(days, function(index, day){
                  // Check if we need a new page
                  if(yPosition > 180) { // Leave margin at bottom of landscape page
                    doc.addPage('landscape', 'a4'); // Ensure new pages are also landscape
                    yPosition = 20; // Reset position on new page
                    
                    // Add title and basic info again on new page if needed
                    doc.setFontSize(20);
                    doc.text('Emploi du Temps (suite)', pageWidth/2, yPosition, { align: 'center' });
                    yPosition += 10;
                    
                    // Draw table header again on new page
                    doc.setFillColor(242, 242, 242); // Light gray background for header
                    doc.rect(leftMargin, yPosition, colWidth, 10, 'F'); // Day header column
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('Jours', leftMargin + colWidth/2, yPosition + 6, { align: 'center' });
                    
                    // Draw time slot headers
                    for (let i = 0; i < timeSlots.length; i++) {
                      const x = leftMargin + (i + 1) * colWidth;
                      doc.rect(x, yPosition, colWidth, 10, 'F');
                      doc.text(timeSlots[i], x + colWidth/2, yPosition + 6, { align: 'center' });
                    }
                    
                    // Draw borders
                    for (let i = 0; i <= numCols; i++) {
                      const x = leftMargin + i * colWidth;
                      doc.line(x, yPosition, x, yPosition + 10); // Vertical lines
                    }
                    doc.line(leftMargin, yPosition, leftMargin + contentWidth, yPosition); // Top horizontal line
                    doc.line(leftMargin, yPosition + 10, leftMargin + contentWidth, yPosition + 10); // Bottom horizontal line
                    
                    yPosition += 10;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                  }
                  
                  // Set row height based on content
                  const rowHeight = 15;
                  
                  // Draw row background (alternating)
                  if(index % 2 === 0) {
                    doc.setFillColor(255, 255, 255); // White background
                  } else {
                    doc.setFillColor(249, 249, 249); // Light gray for alternating rows
                  }
                  doc.rect(leftMargin, yPosition, contentWidth, rowHeight, 'F');
                  
                  // Draw vertical lines for columns
                  for (let i = 0; i <= numCols; i++) {
                    const x = leftMargin + i * colWidth;
                    doc.line(x, yPosition, x, yPosition + rowHeight);
                  }
                  
                  // Draw horizontal line
                  doc.line(leftMargin, yPosition, leftMargin + contentWidth, yPosition);
                  doc.line(leftMargin, yPosition + rowHeight, leftMargin + contentWidth, yPosition + rowHeight);
                  
                  // Add day name in the first column
                  doc.text(day, leftMargin + 2, yPosition + 9);
                  
                  // Add course info for each time slot in this day
                  for (let j = 0; j < timeSlots.length; j++) {
                    const timeSlot = timeSlots[j];
                    const key = day + '_' + timeSlot;
                    const x = leftMargin + (j + 1) * colWidth + 2;
                    
                    if (scheduleMap[key]) {
                      const course = scheduleMap[key];
                      // Limit text length to fit in cell
                      const courseCode = course.cours__code ? course.cours__code.substring(0, 10) : '';
                      const courseLabel = course.cours__label ? course.cours__label.substring(0, 15) : '';
                      const teacher = course.formateur__nom ? 
                        (course.formateur__prenom ? 
                          `${course.formateur__nom} ${course.formateur__prenom.substring(0, 1)}.` : 
                          course.formateur__nom) 
                        : '';
                      const room = course.salle__nom ? course.salle__nom.substring(0, 8) : '';
                      
                      const cellText = `${courseCode}-${courseLabel}\n${teacher}\n${room}`;
                      doc.text(cellText, x, yPosition + 4);
                    }
                  }
                  
                  // Move to next row
                  yPosition += rowHeight;
                });
              } else {
                // No sessions row
                const rowHeight = 15;
                
                // Draw empty row background
                doc.setFillColor(255, 255, 255);
                doc.rect(leftMargin, yPosition, contentWidth, rowHeight, 'F');
                
                // Draw borders
                for (let i = 0; i <= numCols; i++) {
                  const x = leftMargin + i * colWidth;
                  doc.line(x, yPosition, x, yPosition + rowHeight); // Vertical lines
                }
                doc.line(leftMargin, yPosition, leftMargin + contentWidth, yPosition); // Top horizontal line
                doc.line(leftMargin, yPosition + rowHeight, leftMargin + contentWidth, yPosition + rowHeight); // Bottom horizontal line
                
                // Add "No sessions" text centered in the first cell
                doc.text('Aucune séance', leftMargin + colWidth/2, yPosition + 7, { align: 'center' });
                
                yPosition += rowHeight;
              }
              
              // Add footer
              doc.setFontSize(8);
              doc.setFont(undefined, 'normal');
              doc.text(`Impression générée le ${new Date().toLocaleString('fr-FR')}`, pageWidth/2, pageHeight - 10, { align: 'center' });
              
              // Save the PDF with a smaller file size
              doc.save(`Emploi_du_temps-${document.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
              
              // Restore button
              $('#printTimetableBtn').html(originalBtnText);
              $('#printTimetableBtn').prop('disabled', false);
            },
            error: function(xhr, status, error) {
              console.error('Error loading timetable data:', error);
              alert('Une erreur est survenue lors du chargement des données de l\'emploi du temps.');
              
              // Restore button
              $('#printTimetableBtn').html(originalBtnText);
              $('#printTimetableBtn').prop('disabled', false);
            }
          });
        })
        .catch(error => {
          console.error('Error loading PDF libraries:', error);
          alert('Une erreur est survenue lors du chargement des bibliothèques nécessaires. Veuillez réessayer.');
          
          // Restore button
          $('#printTimetableBtn').html(originalBtnText);
          $('#printTimetableBtn').prop('disabled', false);
        });
    });


    // Handle confirm validation timetable button in modal
    $('#confirmValidateTimetableBtn').on('click', function() {
      // Get the current timetable ID
      var timetable = "{{pk}}";
      
      // Show a loading indicator on the confirm button
      var originalText = $(this).html();
      $(this).prop('disabled', true);
      $(this).html('<i class="ri-loader-4-line ri-spin me-2"></i>Validation...');
      
      $.ajax({
        url: '{% url "t_timetable:ApiValidateTimetable" %}',
        type: 'GET',
        data: {
          'id_emploie': timetable,
          
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message || 'L\'emploi du temps a été validé avec succès.');
            // Close the modal
            $('#validateTimetableModal').modal('hide');
            // Reload the page to reflect changes
            location.reload();
          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la validation.');
            // Close the modal to allow retry
            $('#validateTimetableModal').modal('hide');
          }
        },
        error: function(xhr, status, error) {
          var errorMessage = 'Une erreur est survenue lors de la validation.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          alertify.error(errorMessage);
          // Close the modal to allow retry
          $('#validateTimetableModal').modal('hide');
        },
        complete: function() {
          // Restore the button text
          $('#confirmValidateTimetableBtn').prop('disabled', false);
          $('#confirmValidateTimetableBtn').html('<i class="ri-check-line me-2"></i>Confirmer la validation');
        }
      });
    });


    $(document).on('change','#session_module', function(){
      var id_module = $(this).val();
      
      $.ajax({
        url : "{% url 't_timetable:FilterFormateur' %}",
        dataType : "JSON",
        type : "GET",
        data : {
          'code_module' : id_module,
        },
        success : function(data){
          var option="<option value=''>Sélectionnez un professeur</option>";
          $.each(data, function(index, p){
            option += "<option value="+p.formateur__id+">"+p.formateur__nom+' '+p.formateur__prenom+"</option>";
          });
          $('#session_professeur').html(option);
          // Hide the availability section when module changes (since teacher selection will be reset)
          $('#teacherAvailabilitySection').hide();
        },
      })
    });

    // Handle teacher selection change to show/hide availability information
    $(document).on('change', '#session_professeur', function() {
      var selectedTeacherId = $(this).val();
      
      if (selectedTeacherId) {
        // Show the availability section
        $('#teacherAvailabilitySection').show();
        
        // Here we can fetch and display teacher availability data
        // For now, we'll populate with placeholder data or call an API
        loadTeacherAvailability(selectedTeacherId);
      } else {
        // Hide the availability section if no teacher is selected
        $('#teacherAvailabilitySection').hide();
      }
    });

    // Function to load teacher availability information
    function loadTeacherAvailability(teacherId) {
      // Show loading indicator
      $('#teacherAvailabilityLoader').removeClass('d-none');
      $('#teacherWorkload').addClass('d-none');
      
      $.ajax({
        url : "{% url 't_timetable:get_formateur_dispo_status' %}",
        dataType:"JSON",
        type: "GET",
        data : {
          'teacherId' : teacherId,
        },
        success : function(data){
            var html = "";
            $.each(data.result, function(index, p){
              html += '<tr>';
                html += '<td class="text-left"><i class="ri-calendar-2-line me-1"></i>'+p.jour+'</td>';
                html += '<td class="text-left"><i class="ri-timer-line me-1"></i>'+p.heure_debut+' - '+p.heure_fin+'</td>';
                if(p.libre.length > 0 ){
                    html += '<td class="text-left" style="color:green;"><i class="ri-timer-line me-1"></i>'; 
                    $.each(p.libre, function(index, t){
                      html += t.heure_debut+'-'+t.heure_fin;
                      if(index < p.libre.length - 1) html += ', '; 
                    });
                    html+= '</td>';
                }else{
                    html += '<td class="text-left" style="color:red;">Non disponible</td>';
                }
    
                
              html += '</tr>';
            });
            $('#teacherWorkload').html(html || '<tr><td colspan="3" class="text-center text-muted">Aucun</td></tr>');
        },
        error: function(xhr, status, error) {
          // Display error if needed
          $('#teacherWorkload').html('<tr><td colspan="3" class="text-center text-danger">Erreur de chargement</td></tr>');
        },
        complete: function() {
          // Hide loading indicator and show table
          $('#teacherAvailabilityLoader').addClass('d-none');
          $('#teacherWorkload').removeClass('d-none');
        }
      });
      
      $('#teacherScheduledSessions').text('3 séances cette semaine');
    }

    
    // Handle the continue button for different actions
    $('#continueModificationBtn').on('click', function() {
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Envoi en cours...
      `);
      $.ajax({
        url : "{% url 't_timetable:ApiMakeTimetableDraft' %}",
        dataType : "JSON",
        type : "GET",
        data : {
          'id_emploie' : timetable,
        },
        success : function(response){
          if(response.status === "success"){
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          }else{
            alertify.error(response.message);
          }
        },
        complete: function() {
          // Réactiver le bouton et restaurer son texte après la requête
          btn.prop('disabled', false);
          btn.html(originalText);
        }
      })
    });

  });
  
  
</script>

{% endblock content %}