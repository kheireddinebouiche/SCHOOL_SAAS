{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Configuration des Cours - Emploi du Temps{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Additional styles for configuration page */
  .config-section {
    margin-bottom: 30px;
  }
  
  .config-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .config-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .config-body {
    padding: 20px;
  }
  
  .config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .config-actions .btn {
    margin-bottom: 5px;
  }
  
  .time-input {
    width: 120px;
    display: inline-block;
    margin: 0 5px;
  }
  
  /* Course session specific styles */
  .session-card {
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-calendar-alt text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Configuration des Cours - Emploi du Temps</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Emploi du Temps</a>
                  </li>
                  <li class="breadcrumb-item active">Configuration des Cours</li>
                </ol>
              </nav>
              <button type="button" class="btn btn-info btn-sm" id="printTimetableBtn">
                <i class="ri-printer-line me-1"></i>Imprimer
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Timetable Details Section -->
      {% if timetable %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex align-items-center">
                <i class="fas fa-calendar-alt text-info me-2"></i>
                <h5 class="card-title mb-0 text-info">Détails de l'Emploi du Temps</h5>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Label:</label>
                    <p class="mb-0">{{ timetable.label }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Groupe:</label>
                    <p class="mb-0">{{ timetable.groupe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Classe:</label>
                    <p class="mb-0">{{ timetable.groupe.classe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Semestre:</label>
                    <p class="mb-0">{{ timetable.semestre }}</p>
                  </div>
                </div>
              </div>
              {% if timetable.description %}
              <div class="row mt-2">
                <div class="col-12">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Description:</label>
                    <p class="mb-0">{{ timetable.description }}</p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row">
        <div class="col-lg-12">
          <!-- Course Sessions Configuration -->
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-book text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Séances de Cours</h5>
                </div>
                <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addSessionModal">
                  <i class="ri-add-line me-1"></i> Ajouter une séance
                </button>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Module</th>
                      <th class="border-0">Jour</th>
                      <th class="border-0">Horaire</th>
                      <th class="border-0">Professeur</th>
                      <th class="border-0">Salle</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="sessionsTableBody">
                    {% if timetable %}
                      {% for entry in timetable.timetableentry_set.all %}
                        <tr id="session-row-{{ entry.id }}">
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="flex-grow-1">
                                <h6 class="mb-0 fw-semibold">{{ entry.cours.code }} - {{ entry.cours.nom }}</h6>
                              </div>
                            </div>
                          </td>
                          <td><div class="fw-medium">{{ entry.jour.nom }}</div></td>
                          <td><div class="text-body">{{ entry.horaire.nom }} ({{ entry.horaire.heure_debut|time:"H:i" }} - {{ entry.horaire.heure_fin|time:"H:i" }})</div></td>
                          <td><div class="text-body">{{ entry.cours.enseignant.first_name }} {{ entry.cours.enseignant.last_name }}</div></td>
                          <td><div class="text-body">{{ entry.salle.nom }} ({{ entry.salle.code }})</div></td>
                          <td class="text-end">
                            <button type="button" class="btn btn-danger btn-sm delete-session" data-session-id="{{ entry.id }}" data-session-name="{{ entry.cours.code }}">
                              <i class="ri-delete-bin-line"></i>
                            </button>
                          </td>
                        </tr>
                      {% empty %}
                        <tr>
                          <td colspan="6" class="text-center text-muted">
                            <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                <div class="avatar-sm mb-4">
                                    <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                        <i class="ri-book-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-2">Aucune séance de cours trouvée</h5>
                                <p class="text-muted mb-0">Il n'y a aucune séance de cours programmée pour le moment</p>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="6" class="text-center text-muted">Aucune séance de cours trouvée</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for adding course session -->
<div class="modal fade" id="addSessionModal" tabindex="-1" aria-labelledby="addSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-book-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="addSessionModalLabel">
              Ajouter une nouvelle séance
            </h5>
            <p class="text-muted small mb-0">Configurez les détails de la séance de cours</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Notification alert -->
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
          <i class="ri-information-line me-2"></i>
          <strong>Information:</strong> Les modules affichés sont filtrés préalablement par rapport au semestre et à la répartition semestrielle déjà configurée.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <form id="addSessionForm">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_module">Module <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_module" name="module" required>
                <option value="">Sélectionnez un module</option>
                {% for cours in modules %}
                  <option value="{{cours.module.code}}">{{ cours.module.code }} - {{ cours.module.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_professeur">Professeur <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_professeur" name="professeur" required>
                <option value="">Sélectionnez un professeur</option>
                
              </select>
            </div>
           
          <div class="row g-3 mt-2">
             <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_jour">Jour <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_jour" name="jour" required>
                <option value="">Sélectionnez un jour</option>
                {% for jour in jour_data.jours_travail %}
                  <option value="{{ jour }}">{{ jour|capfirst }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_horaire">Horaire <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_horaire" name="horaire" required>
                <option value="">Sélectionnez un horaire</option>
                {% for horaire in horaire_data.plages_horaires %}
                  <option value="{{ horaire.id }}">{{ horaire.nom_creneau }} ({{ horaire.heure_debut }} - {{ horaire.heure_fin }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
            
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-12">
              <label class="form-label fw-medium" for="session_salle">Salle <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_salle" name="salle" required>
                <option value="">Sélectionnez une salle</option>
                {% for salle in salles %}
                  <option value="{{ salle.id }}">{{ salle.nom }} ({{ salle.code }}) - {{ salle.capacite }} places</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="addSessionError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="saveSessionBtn">
          <i class="ri-save-line me-2"></i>Enregistrer la séance
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming session deletion -->
<div class="modal fade" id="deleteSessionModal" tabindex="-1" aria-labelledby="deleteSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteSessionModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer la séance <strong id="sessionToDeleteName"></strong>. 
            Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteSessionBtn">
          <i class="ri-delete-bin-line me-2"></i>Confirmer la suppression
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    
    // Handle adding session
    $('#saveSessionBtn').on('click', function() {
      var session_module = document.getElementById('session_module').val;
      var session_professeur = document.getElementById('session_professeur').val;
      var session_jour = document.getElementById('session_jour').val;
      var session_horaire = document.getElementById('session_horaire').val;
      var session_salle = document.getElementById('session_salle').val;

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#addSessionError').addClass('d-none');

      $.ajax({
        url: '{% url "t_timetable:save_session" %}',
        type: 'POST',
        data: {
          'session_module' : session_module,
          'session_professeur' : session_professeur,
          'session_jour' : session_jour,
          'session_horaire' : session_horaire,
          'session_salle' : session_salle,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
            
          } else {
            // Show error message
            $('#addSessionError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de l\'ajout de la séance.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de l\'ajout de la séance.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#addSessionError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#saveSessionBtn').html(originalBtnText);
          $('#saveSessionBtn').prop('disabled', false);
        }
      });
    });

    console.log("{{timetable.creneau.jour_data}}");
    // Handle clicking delete-session button - show confirmation modal
    $(document).on('click', '.delete-session', function() {
      var sessionId = $(this).data('session-id');
      var sessionName = $(this).data('session-name');
      
      // Set the session name in the modal
      $('#sessionToDeleteName').text(sessionName);
      
      // Store the sessionId in the confirmation button for later use
      $('#confirmDeleteSessionBtn').data('session-id', sessionId);
      
      // Show the modal
      $('#deleteSessionModal').modal('show');
    });
    
    // Handle confirming session deletion
    $('#confirmDeleteSessionBtn').on('click', function() {
      var sessionId = $(this).data('session-id');
      
      $.ajax({
        url: '#',
        type: 'POST',
        data: {
          'id': sessionId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#session-row-' + sessionId).remove(); // Remove the row from the table
            $('#deleteSessionModal').modal('hide'); // Hide the modal
            
            // If no rows left, show empty message
            if ($('#sessionsTableBody tr').length === 0) {
              var emptyRow = '<tr>' +
                '<td colspan="6" class="text-center text-muted">' +
                  '<div class="d-flex flex-column align-items-center justify-content-center py-5">' +
                    '<div class="avatar-sm mb-4">' +
                      '<div class="avatar-title bg-light text-muted rounded-circle fs-1">' +
                        '<i class="ri-book-line"></i>' +
                      '</div>' +
                    '</div>' +
                    '<h5 class="mb-2">Aucune séance de cours trouvée</h5>' +
                    '<p class="text-muted mb-0">Il n\'y a aucune séance de cours programmée pour le moment</p>' +
                  '</div>' +
                '</td>' +
              '</tr>';
              $('#sessionsTableBody').html(emptyRow);
            }
          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la suppression de la séance.');
          }
        },
        error: function(xhr, status, error) {
          alertify.error('Une erreur est survenue lors de la suppression de la séance.');
          $('#deleteSessionModal').modal('hide'); // Hide the modal
        }
      });
    });

    // Handle print timetable button
    $('#printTimetableBtn').on('click', function() {
      // Create a new window with the timetable data for printing
      var printWindow = window.open('', '_blank');
      var printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Emploi du Temps - ${document.title}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .timetable-info { margin-bottom: 20px; }
            .timetable-info div { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #333; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .day-header { background-color: #e6f3ff; font-weight: bold; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Emploi du Temps</h1>
            {% if timetable %}
            <div class="timetable-info">
              <div><strong>Label:</strong> {{ timetable.label }}</div>
              <div><strong>Groupe:</strong> {{ timetable.groupe.nom }}</div>
              <div><strong>Classe:</strong> {{ timetable.groupe.classe.nom }}</div>
              <div><strong>Semestre:</strong> {{ timetable.semestre }}</div>
              {% if timetable.description %}<div><strong>Description:</strong> {{ timetable.description }}</div>{% endif %}
            </div>
            {% endif %}
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Module</th>
                <th>Jour</th>
                <th>Horaire</th>
                <th>Professeur</th>
                <th>Salle</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in timetable.timetableentry_set.all %}
              <tr>
                <td>{{ entry.cours.code }} - {{ entry.cours.nom }}</td>
                <td>{{ entry.jour.nom }}</td>
                <td>{{ entry.horaire.nom }} ({{ entry.horaire.heure_debut|time:"H:i" }} - {{ entry.horaire.heure_fin|time:"H:i" }})</td>
                <td>{{ entry.cours.enseignant.first_name }} {{ entry.cours.enseignant.last_name }}</td>
                <td>{{ entry.salle.nom }} ({{ entry.salle.code }})</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">Aucune séance de cours programmée</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <div style="position: fixed; bottom: 20px; width: 100%; text-align: center; font-size: 12px; color: #666;">
            Impression générée le ${new Date().toLocaleString('fr-FR')}
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    });


    function loadSalle(){

    }

    function loadModule(){

    }

    $(document).on('change','#session_module', function(){
      var id_module = $(this).val();
      
      $.ajax({
        url : "{% url 't_timetable:FilterFormateur' %}",
        dataType : "JSON",
        type : "GET",
        data : {
          'code_module' : id_module,
        },
        success : function(data){
          var option="<option value=''>Sélectionnez un professeur</option>";
          $.each(data, function(index, p){
            option += "<option value="+p.id+">"+p.nom+'-'+p.prenom+"</option>";
          });
          $('#session_professeur').html(option);
        },
      })
    });

    


  });
  
  
</script>

{% endblock content %}