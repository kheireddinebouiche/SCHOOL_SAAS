{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Configuration des Cours - Emploi du Temps{% endblock title %}

{% block extra_head %}
{% endblock extra_head %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Additional styles for configuration page */
  .config-section {
    margin-bottom: 30px;
  }
  
  .config-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .config-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .config-body {
    padding: 20px;
  }
  
  .config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .config-actions .btn {
    margin-bottom: 5px;
  }

  .time-input {
    width: 120px;
    display: inline-block;
    margin: 0 5px;
  }

  /* Course session specific styles */
  .session-card {
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
  }

  /* Styles for available rooms cards */
  .room-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .room-card:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .room-card.selected {
    border-color: #0d6efd;
    background-color: #e7f1ff;
  }

  .room-card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    padding: 12px 15px;
    border-radius: 6px 6px 0 0 !important;
  }

  .room-card-body {
    padding: 15px;
  }

  .room-card.selected .room-card-header {
    background-color: #0d6efd;
    color: white;
  }

  .room-card.selected .room-card-header h6,
  .room-card.selected .room-card-header i {
    color: white !important;
  }

  /* Styles for session cards - Larger layout */
  .session-card {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    height: 100%;
    display: flex;
    flex-direction: column;
    width: 240px; /* Increased width */
  }

  .session-card:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  .session-card-header {
    background-color: #f8f9fa;
    padding: 10px 12px;
    border-radius: 5px 5px 0 0 !important;
    flex-shrink: 0;
  }

  .session-card-body {
    padding: 12px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .session-card-footer {
    background-color: #f8f9fa;
    padding: 8px 12px;
    border-radius: 0 0 5px 5px !important;
    flex-shrink: 0;
  }

  .session-info-item {
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
  }

  .session-info-label {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.75rem;
    margin-right: 3px;
  }

  .session-info-value {
    font-weight: 500;
    color: #212529;
    font-size: 0.8rem;
  }

  .session-card-title {
    font-size: 0.9rem;
    margin: 0;
    word-break: break-word;
    line-height: 1.3;
  }

  .session-card-title i {
    font-size: 0.9rem;
    margin-right: 3px;
  }

  .session-card-footer small {
    font-size: 0.75rem;
  }

  .session-card-footer button {
    padding: 3px 8px;
    font-size: 0.75rem;
  }

  /* Session cards container */
  .sessions-cards-container {
    max-height: 700px;
    overflow-y: auto;
    padding-right: 10px;
  }

  .sessions-cards-container::-webkit-scrollbar {
    width: 6px;
  }

    /* Modern Dashboard Styles */
     :root {
      --primary-soft: #e7f1ff;
      --primary-border: #b6d4fe;
      --text-muted: #6c757d;
      --card-border-radius: 12px;
    }

    body {
      background-color: #f3f6f9;
    }

    .config-card {
      border: none;
      border-radius: var(--card-border-radius);
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      background: #fff;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .config-header {
      background: transparent;
      border-bottom: 1px solid #f0f0f0;
      padding: 1.25rem 1.5rem;
    }

    .config-body {
      padding: 1.5rem;
    }

    /* Stat Cards for Details */
    .info-stat-card {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem;
      height: 100%;
      border: 1px solid #eef2f7;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .info-stat-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-color: #dfe7f1;
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #8795a1;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 600;
      color: #343a40;
    }

    .stat-icon-wrapper {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    /* Matrix Modernization */
    .timetable-matrix th {
      background: #fff;
      border-bottom: 2px solid #eef2f7;
      border-right: 1px solid #f0f0f0;
      border-top: 1px solid #f0f0f0;
      color: #495057;
      font-weight: 600;
      font-size: 0.85rem;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .timetable-matrix td {
      border: 1px solid #f0f0f0;
    }
    
    .timetable-matrix td:first-child {
        border-right: 2px solid #eef2f7;
        background-color: #fcfcfc;
        color: #495057;
        box-shadow: 2px 0 4px rgba(0,0,0,0.02);
    }

    .timetable-matrix td.time-slot-cell:hover {
        background-color: #f8faff;
    }

    .matrix-session-card {
      border-radius: 8px;
      border: 1px solid #edf2f9;
      background: #fff;
      box-shadow: 0 2px 6px rgba(52, 107, 218, 0.08); /* Slight blue tint shadow */
      padding: 8px 10px;
      margin-bottom: 6px;
      transition: all 0.2s ease;
      position: relative;
    }

    .matrix-session-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(52, 107, 218, 0.15);
        border-color: #dce7f9;
    }

    .matrix-session-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #3b7ddd;
        margin-bottom: 4px;
        display: block;
    }

    .matrix-session-info {
        font-size: 0.75rem;
        color: #6c757d;
        display: flex;
        align-items: center;
        margin-bottom: 2px;
    }

    .matrix-session-info i {
        font-size: 0.8rem;
        opacity: 0.8;
        width: 16px;
    }

    /* Primary card delete button on hover */
    .matrix-session-delete {
        background: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        top: -5px;
        right: -5px;
    }

    .matrix-session-delete i {
        font-size: 14px;
    }

    </style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-calendar-alt text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Configuration des Cours - Emploi du Temps</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Emploi du Temps</a>
                  </li>
                  <li class="breadcrumb-item active">Configuration des Cours</li>
                </ol>
              </nav>
              <a href="{% url 't_timetable:timetable_view' timetable.id %}" class="btn btn-secondary btn-sm">
                <i class="ri-eye-line me-1"></i>Consulter l'Emploi du Temps
              </a>
              <button type="button" class="btn btn-info btn-sm" id="printTimetableBtn">
                <i class="ri-printer-line me-1"></i>Imprimer
              </button>
              {% if not timetable.is_validated %}
                <button type="button" class="btn btn-success btn-sm" id="validateTimetableBtn" data-bs-toggle="modal" data-bs-target="#validateTimetableModal">
                  <i class="ri-check-line me-1"></i>Valider l'Emploi du Temps
                </button>
              {% endif %}
              {% if timetable.is_validated %}
                <button type="button" class="btn btn-warning btn-sm" id="reactiveModification" data-bs-toggle="modal" data-bs-target="#timetableWarningModal">
                  <i class="ri-shield-keyhole-line me-1"></i>Réactiver la modifications
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <!-- Notification about attendance registers -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="alert alert-info border-0 bg-info bg-opacity-10 rounded-3">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <i class="ri-information-line text-info fs-4 me-3"></i>
              </div>
              <div class="flex-grow-1">
                <h5 class="alert-heading text-info fw-semibold">Génération des registres de présences</h5>
                <p class="mb-0">
                  Pour créer les registres de présences comportant les modules planifiés afin de suivre les présences des étudiants,
                  veuillez cliquer sur <strong>"Voir"</strong> dans la liste des emplois du temps, puis confirmer la génération des registres de présences.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Timetable Details Section Modernized -->
      {% if timetable %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="config-card p-0">
             <div class="p-4 bg-white border-bottom">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                         <i class="ri-dashboard-3-line text-primary fs-3"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold text-dark mb-1">Détails de l'Emploi du Temps</h4>
                        <p class="text-muted mb-0">Vue d'ensemble et configuration</p>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="info-stat-card">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon-wrapper bg-info bg-opacity-10 text-info">
                                    <i class="ri-price-tag-3-line fs-5"></i>
                                </div>
                                <div>
                                    <div class="stat-label">Label</div>
                                    <div class="stat-value text-truncate" title="{{ timetable.label }}">{{ timetable.label }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-stat-card">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon-wrapper bg-success bg-opacity-10 text-success">
                                    <i class="ri-group-line fs-5"></i>
                                </div>
                                <div>
                                    <div class="stat-label">Groupe</div>
                                    <div class="stat-value">{{ timetable.groupe.nom }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-stat-card">
                             <div class="d-flex align-items-center">
                                <div class="stat-icon-wrapper bg-warning bg-opacity-10 text-warning">
                                    <i class="ri-book-mark-line fs-5"></i>
                                </div>
                                <div>
                                    <div class="stat-label">Spécialité</div>
                                    <div class="stat-value text-truncate">{{ timetable.groupe.specialite.label }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-stat-card">
                             <div class="d-flex align-items-center">
                                <div class="stat-icon-wrapper bg-purple bg-opacity-10 text-purple" style="color: #6f42c1; background-color: rgba(111, 66, 193, 0.1);">
                                    <i class="ri-calendar-event-line fs-5"></i>
                                </div>
                                <div>
                                    <div class="stat-label">Semestre</div>
                                    <div class="stat-value">{{ timetable.semestre }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if timetable.description %}
                 <div class="mt-4 pt-3 border-top">
                    <div class="d-flex align-items-start">
                         <i class="ri-text-wrap text-muted me-2 mt-1"></i>
                         <p class="text-muted mb-0 fst-italic">{{ timetable.description }}</p>
                    </div>
                 </div>
                {% endif %}
             </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row">
        <div class="col-lg-12">
          <!-- Course Sessions Configuration -->
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-book text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Séances de Cours</h5>
                </div>
                {% if not timetable.is_validated %}
                <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addSessionModal">
                  <i class="ri-add-line me-1"></i> Ajouter une séance
                </button>
                {% endif %}
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div id="sessionsContainer">
                <div class="timetable-matrix-container">
                  <table class="timetable-matrix table table-bordered mb-0">
                    <thead>
                      <tr>
                        <th class="text-center align-middle bg-light" style="width: 100px;">Jours / Horaires</th>
                        {% for horaire in horaire_data.plages_horaires %}
                          <th class="text-center align-middle">
                            {{ horaire.nom_creneau }}<br>
                            <small class="text-muted fw-normal">{{ horaire.heure_debut }} - {{ horaire.heure_fin }}</small>
                          </th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for jour in jour_data.jours_travail %}
                        <tr>
                          <td class="align-middle text-center bg-light fw-bold">{{ jour|capfirst }}</td>
                          {% for horaire in horaire_data.plages_horaires %}
                            <td class="time-slot-cell" data-day="{{ jour }}" data-time-start="{{ horaire.heure_debut }}" data-time-end="{{ horaire.heure_fin }}">
                              <!-- Sessions will be loaded here -->
                            </td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for adding course session -->
<div class="modal fade" id="addSessionModal" tabindex="-1" aria-labelledby="addSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-book-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="addSessionModalLabel">
              Ajouter une nouvelle séance
            </h5>
            <p class="text-muted small mb-0">Configurez les détails de la séance de cours</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Notification alert -->
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
          <i class="ri-information-line me-2"></i>
          <strong>Information:</strong> Les modules affichés sont filtrés préalablement par rapport au semestre et à la répartition semestrielle déjà configurée.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div id="sharedSessionAlert" class="alert alert-info border-0 bg-info bg-opacity-10 text-info d-none" role="alert">
          <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                  <i class="ri-information-line fs-5"></i>
              </div>
              <div class="flex-grow-1">
                  <h6 class="alert-heading fw-bold mb-1">Double Diplomation détectée</h6>
                  <p class="mb-0 small" id="sharedSessionMsg"></p>
              </div>
          </div>
        </div>
        
        <form id="addSessionForm">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_module">Module <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_module" name="module" required>
                <option value="">Sélectionnez un module</option>
                {% for cours in modules %}
                  <option value="{{cours.module.code}}">{{ cours.module.code }} - {{ cours.module.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_professeur">Professeur <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_professeur" name="professeur" required>
                <option value="">Sélectionnez un professeur</option>
                
              </select>
            </div>
            <!-- Teacher availability section - shown when teacher is selected -->
            <div class="col-lg-12" id="teacherAvailabilitySection" style="display: none;">
              <div class="card border-info border-1 bg-light mt-3">
                <div class="card-header bg-info bg-opacity-10 p-2">
                  <h6 class="card-title mb-0 text-info d-flex align-items-center">
                    <i class="ri-user-settings-line me-2"></i>Disponibilité de l'enseignant
                  </h6>
                </div>
                <div class="card-body p-2">
                  <div class="row g-2">
                    <div class="col-md-12">
                      <div class="info-item">
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered small mb-0">
                            <thead class="table-light">
                              <tr>
                                <th class="text-center" style="width: 30%;">Jour</th>
                                <th class="text-center" style="width: 40%;">Disponibilité</th>
                                <th class="text-center" style="width: 30%;">Affectation</th>
                              </tr>
                            </thead>
                            <tbody id="teacherWorkload">
                              <tr>
                                <td colspan="3" class="text-center text-muted">Aucun</td>
                              </tr>
                            </tbody>
                          </table>
                          <div id="teacherAvailabilityLoader" class="d-none text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                              <span class="visually-hidden">Chargement...</span>
                            </div>
                            <small class="text-muted ms-2">Chargement des disponibilités...</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
           
          <div class="row g-3 mt-2">
             <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_jour">Jour <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_jour" name="jour" required>
                <option value="">Sélectionnez un jour</option>
                {% for jour in jour_data.jours_travail %}
                  <option value="{{ jour }}">{{ jour|capfirst }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="session_horaire">Horaire <span class="text-danger">*</span></label>
              <select class="form-select border-0 bg-light py-2" id="session_horaire" name="horaire" required>
                <option value="">Sélectionnez un horaire</option>
                {% for horaire in horaire_data.plages_horaires %}
                  <option data-heure-debut="{{horaire.heure_debut}}" data-heure-fin="{{horaire.heure_fin}}" value="{{ horaire.id }}">{{ horaire.nom_creneau }} ({{ horaire.heure_debut }} - {{ horaire.heure_fin }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
            
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-12">
              <label class="form-label fw-medium" for="session_salle">Salle <span class="text-danger">*</span></label>
              <input type="hidden" id="session_salle" name="salle" value="" required>
              <div id="salles_disponibles_container">
                <div id="salle_loader" class="d-none text-center mt-3">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                  </div>
                  <small class="text-muted ms-2">Chargement des salles disponibles...</small>
                </div>
                <div id="salles_cards" class="row g-3">
                  <div class="col-12">
                    <div class="alert alert-info">Veuillez sélectionner un horaire pour voir les salles disponibles</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="addSessionError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="saveSessionBtn">
          <i class="ri-save-line me-2"></i>Enregistrer la séance
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming session deletion -->
<div class="modal fade" id="deleteSessionModal" tabindex="-1" aria-labelledby="deleteSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteSessionModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer la séance. 
            Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteSessionBtn">
          <i class="ri-delete-bin-line me-2"></i>Confirmer la suppression
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming timetable validation -->
<div class="modal fade" id="validateTimetableModal" tabindex="-1" aria-labelledby="validateTimetableModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-checkbox-circle-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="validateTimetableModalLabel">
              Confirmation de validation
            </h5>
            <p class="text-muted small mb-0">Cette action rendra l'emploi du temps officiel</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-checkbox-circle-line text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3">Valider l'emploi du temps ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de valider l'emploi du temps <strong>{{ timetable.label }}</strong>.
            Cette action rendra l'emploi du temps officiel et les modifications futures seront restreintes.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="confirmValidateTimetableBtn">
          <i class="ri-check-line me-2"></i>Confirmer la validation
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for warning about timetable modification risks -->
<div class="modal fade" id="timetableWarningModal" tabindex="-1" aria-labelledby="timetableWarningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-alert-line text-warning fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-warning mb-1" id="timetableWarningModalLabel">
              Avertissement - Modification de l'emploi du temps
            </h5>
            <p class="text-muted small mb-0">Veuillez prendre connaissance des risques</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <i class="ri-alert-line text-warning" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-warning mb-4 text-center">Faites attention aux risques de modification</h4>
        <div class="alert alert-warning bg-warning bg-opacity-10 border border-warning border-opacity-25">
          <ul class="mb-0">
            <li>Les modifications peuvent affecter les emplois du temps déjà distribués aux étudiants et enseignants</li>
            <li>Les conflits de salles ou d'enseignants peuvent survenir suite à des modifications inattendues</li>
            <li>Les absences ou imprévus peuvent nécessiter des modifications urgentes de dernière minute</li>
            <li>Les enseignants peuvent avoir planifié leur préparation en fonction des séances actuelles</li>
            <li>Une mauvaise coordination des modifications peut entraîner des confusions importantes</li>
          </ul>
        </div>
        <div class="alert alert-info bg-info bg-opacity-10 border border-info border-opacity-25">
          <p class="mb-0">
            <strong>Conseil:</strong> Assurez-vous que toutes les parties concernées sont informées des modifications 
            et que les changements sont nécessaires et bien planifiés avant de procéder.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Retour
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="continueModificationBtn">
          <i class="ri-check-line me-2"></i>Continuer les modifications
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Function to dynamically load jsPDF if not already loaded
  function loadPDFLibraries() {
    return new Promise((resolve, reject) => {
      // Check if library is already loaded
      if (typeof window.jspdf !== 'undefined') {
        resolve();
        return;
      }

      // Create script element for jsPDF
      const jsPDFScript = document.createElement('script');
      jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      
      jsPDFScript.onload = () => {
        // Small delay to ensure library is fully initialized
        setTimeout(resolve, 100);
      };
      
      jsPDFScript.onerror = () => reject(new Error('Failed to load jsPDF'));
      
      document.head.appendChild(jsPDFScript);
    });
  }

  $(document).ready(function () {

    var timetable="{{pk}}";

    function loadTimeTableEntry(){
      $.ajax({
        url : "{% url 't_timetable:ApiLoadTableEntry' %}",
        dataType : "JSON",
        type: "GET",
        data:{
          'timetable' : timetable,
        },
        success : function(data){
          // Clear all cells first
          $('.time-slot-cell').empty();
          
          if(data.length > 0){
              $.each(data, function(index, p){
                // Find the correct cell
                // We match primarily on day and start time.
                // Note: Ensure time formats match exactly (e.g., "08:00" vs "8:00")
                var selector = '.time-slot-cell[data-day="' + p.jour + '"][data-time-start="' + p.heure_debut + '"]';
                var cell = $(selector);
                
                if (cell.length > 0) {
                  var cardHtml = '';
                  cardHtml += '<div class="matrix-session-card" title="' + p.cours__label + '">';
                  cardHtml += '  <span class="matrix-session-title">' + p.cours__code + '</span>';
                  cardHtml += '  <span class="matrix-session-info"><i class="ri-user-line me-1"></i>' + p.formateur__nom + ' ' + p.formateur__prenom.charAt(0) + '.</span>';
                  cardHtml += '  <span class="matrix-session-info"><i class="ri-map-pin-line me-1"></i>' + p.salle__code + '</span>';
                  
                  if (!p.timetable__is_validated) {
                    cardHtml += '  <div class="matrix-session-delete delete-session" data-session-id="' + p.id + '">';
                    cardHtml += '    <i class="ri-close-circle-fill"></i>';
                    cardHtml += '  </div>';
                  }
                  
                  cardHtml += '</div>';
                  
                  cell.append(cardHtml);
                }
            });
          }
        },
      });
    }

    

    loadTimeTableEntry();

    // Handle adding session
    $('#saveSessionBtn').on('click', function() {

      var session_module = document.getElementById('session_module').value;
      var session_professeur = document.getElementById('session_professeur').value;
      var session_jour = document.getElementById('session_jour').value;

      var selectedOption = $('#session_horaire option:selected');

      var heure_debut = selectedOption.data('heure-debut');
      var heure_fin = selectedOption.data('heure-fin');

      var session_salle = document.getElementById('session_salle').value;

      // Hide any previous error messages
      $('#addSessionError').addClass('d-none');

      // Validate that a room has been selected
      if (!session_salle) {
        $('#addSessionError').removeClass('d-none').text('Veuillez sélectionner une salle pour la séance.');
        return;
      }

      $.ajax({
        url: '{% url "t_timetable:save_session" %}',
        type: 'POST',
        data: {
          'session_module' : session_module,
          'session_professeur' : session_professeur,
          'session_jour' : session_jour,
          'heure_debut' : heure_debut,
          'heure_fin' : heure_fin,
          'session_salle' : session_salle,
          'pk' : timetable,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);

            $('#session_module').val("");
            $('#session_professeur').val("");
            $('#session_jour').val("");
            $('#session_horaire').val("");
            $('#session_salle').val("");
            $('#salles_cards').html('<div class="col-12"><div class="alert alert-info">Veuillez sélectionner un horaire pour voir les salles disponibles</div></div>');
            $('#teacherAvailabilitySection').hide();

            $('#addSessionModal').modal('hide');
            loadTimeTableEntry();
          } else {
            $('#addSessionError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de l\'ajout de la séance.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de l\'ajout de la séance.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#addSessionError').removeClass('d-none').text(errorMessage);
        },

      });
    });

    
    $(document).on('click', '.delete-session', function() {
      var sessionId = $(this).data('session-id');
      console.log(sessionId);
      $('#confirmDeleteSessionBtn').data('session-id', sessionId);
      $('#deleteSessionModal').modal('show');
    });
    
    
    $(document).on('click','#confirmDeleteSessionBtn', function() {
      var sessionId = $(this).data('session-id');
      
      $.ajax({
        url: '{% url "t_timetable:ApiDeleteCoursSession" %}',
        type: 'POST',
        dataType:"JSON",
        data: {
          'id': sessionId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#deleteSessionModal').modal('hide');
            loadTimeTableEntry();

          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la suppression de la séance.');
          }
        },
        error: function(xhr, status, error) {
          alertify.error('Une erreur est survenue lors de la suppression de la séance.');
          $('#deleteSessionModal').modal('hide'); 
        }
      });
    });

    // Handle print timetable button - Generate PDF instead of opening new window
    $('#printTimetableBtn').on('click', function() {
      // Show loading message while libraries load
      const originalBtnText = $('#printTimetableBtn').html();
      $('#printTimetableBtn').html('<i class="ri-loader-4-line ri-spin me-1"></i>Chargement...');
      $('#printTimetableBtn').prop('disabled', true);
      
      loadPDFLibraries()
        .then(() => {
          // Use ApiLoadTableEntry to get the actual data for PDF generation
          $.ajax({
            url : "{% url 't_timetable:ApiLoadTableEntry' %}",
            dataType : "JSON",
            type: "GET",
            data:{
              'timetable' : timetable,
            },
            success : function(data){
              // Process the data directly in the PDF without creating HTML
              
              // Create a structured timetable with TIMES as COLUMNS and DAYS as ROWS
              
              // 1. Get unique Days and sort them
              const allDaysSet = new Set();
              data.forEach(p => {
                if (p.jour) {
                  const normalizedDay = p.jour.charAt(0).toUpperCase() + p.jour.slice(1).toLowerCase();
                  allDaysSet.add(normalizedDay);
                }
              });
              const allDays = Array.from(allDaysSet);
              const dayOrder = ['Samedi', 'Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
              const days = dayOrder.filter(d => allDays.includes(d));
              if (days.length === 0) days.push(...allDays);
              
              // 2. Get unique Time Slots and sort them
              const timeSlots = [...new Set(data.filter(p => p.heure_debut && p.heure_fin)
                .map(p => p.heure_debut + ' - ' + p.heure_fin))].sort();
                
              // 3. Create Map
              const scheduleMap = {};
              data.forEach(p => {
                 if (p.jour && p.heure_debut && p.heure_fin) {
                   const normalizedDay = p.jour.charAt(0).toUpperCase() + p.jour.slice(1).toLowerCase();
                   const slot = p.heure_debut + ' - ' + p.heure_fin;
                   scheduleMap[`${normalizedDay}_${slot}`] = p;
                 }
              });

              // Generate PDF
              const doc = new window.jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
              });

              const pageWidth = 297; 
              const pageHeight = 210;
              const leftMargin = 10;
              const rightMargin = 10;
              const topMargin = 10;
              const bottomMargin = 10;
              const contentWidth = pageWidth - leftMargin - rightMargin;

              let yPosition = topMargin;

              // Title and Info
              doc.setFontSize(18);
              doc.setTextColor(40, 40, 40);
              doc.text("Emploi du Temps", pageWidth/2, yPosition + 5, {align:'center'});
              yPosition += 15;

              doc.setFontSize(10);
              doc.setTextColor(60, 60, 60);
              const infoX = leftMargin + 5;
              doc.setFont(undefined, 'bold');
              doc.text(`Groupe: {{ timetable.groupe.nom }}`, infoX, yPosition);
              doc.text(`Semestre: {{ timetable.semestre }}`, infoX + 80, yPosition);
              doc.text(`Année: {{ timetable.annee_scolaire|default:'' }}`, infoX + 160, yPosition);
              yPosition += 10;

              // Matrix Config
              if (days.length === 0 || timeSlots.length === 0) {
                 doc.text("Aucun cours programmé.", pageWidth/2, yPosition + 20, {align:'center'});
              } else {
                  // Calculate Cell Dimensions
                  const headerColWidth = 30; // 'Day' column width
                  const timeColWidth = (contentWidth - headerColWidth) / timeSlots.length;
                  const rowHeight = 20; // Row height for each day
                  
                  // -- HEADER ROW (Time Slots) --
                  doc.setFillColor(59, 125, 221); // Primary Blue
                  doc.setTextColor(255, 255, 255);
                  
                  // Corner cell
                  doc.rect(leftMargin, yPosition, headerColWidth, 10, 'F');
                  doc.setFontSize(9);
                  doc.text("Jours", leftMargin + headerColWidth/2, yPosition + 6, {align:'center'});
                  
                  // Time headers
                  timeSlots.forEach((slot, index) => {
                      const x = leftMargin + headerColWidth + (index * timeColWidth);
                      doc.setFillColor(59, 125, 221); // Primary Blue
                      doc.rect(x, yPosition, timeColWidth, 10, 'F');
                      
                      doc.setTextColor(255, 255, 255); // White
                      doc.setFontSize(8);
                      doc.text(slot, x + timeColWidth/2, yPosition + 6, {align:'center'});
                  });
                  
                  yPosition += 10;
                  
                  // -- ROWS (Days) --
                  doc.setTextColor(0, 0, 0);
                  
                  days.forEach((day, rowIndex) => {
                      if (yPosition + rowHeight > pageHeight - bottomMargin) {
                          doc.addPage('landscape');
                          yPosition = topMargin;
                          // Ideally redraw header here (omitted for brevity)
                      }
                      
                      const rowY = yPosition;
                      
                      // 1. Day Header (Left)
                      doc.setFillColor(245, 245, 245); 
                      doc.rect(leftMargin, rowY, headerColWidth, rowHeight, 'F');
                      doc.setFont(undefined, 'bold');
                      doc.setFontSize(9);
                      doc.setTextColor(50, 50, 50);
                      doc.text(day, leftMargin + headerColWidth/2, rowY + rowHeight/2, {align:'center'});
                      
                      // 2. Session Cells (Time Slots)
                      doc.setFont(undefined, 'normal');
                      timeSlots.forEach((slot, colIndex) => {
                          const x = leftMargin + headerColWidth + (colIndex * timeColWidth);
                          const key = `${day}_${slot}`;
                          const session = scheduleMap[key];
                          
                          doc.setDrawColor(200, 200, 200);
                          doc.rect(x, rowY, timeColWidth, rowHeight); 
                          
                          if (session) {
                              const module = session.cours__label || session.cours__code;
                              const teacher = (session.formateur__nom || "") + " " + (session.formateur__prenom ? session.formateur__prenom.charAt(0)+"." : "");
                              const room = session.salle__nom || "";
                              
                              doc.setTextColor(0, 0, 0);
                              doc.setFontSize(7); // Smaller font for horizontal layout compatibility
                              doc.setFont(undefined, 'bold');
                              
                              const modText = doc.splitTextToSize(module, timeColWidth - 4);
                              doc.text(modText, x + 2, rowY + 4);
                              
                              doc.setFont(undefined, 'normal');
                              doc.setFontSize(6);
                              doc.text(teacher, x + 2, rowY + 12);
                              
                              doc.setFont(undefined, 'italic');
                              doc.setTextColor(100, 100, 100);
                              doc.text(room, x + timeColWidth - 2, rowY + 17, {align:'right'});
                          }
                      });
                      
                      yPosition += rowHeight;
                  });
              }

              // Footer
              doc.setFontSize(8);
              doc.setTextColor(150, 150, 150);
              doc.text(`Généré le ${new Date().toLocaleDateString()}`, leftMargin, pageHeight - 5);
              
              // Add footer
              doc.setFontSize(8);
              doc.setFont(undefined, 'normal');
              doc.text(`Impression générée le ${new Date().toLocaleString('fr-FR')}`, pageWidth/2, pageHeight - 10, { align: 'center' });
              
              // Save the PDF with a smaller file size
              doc.save(`Emploi_du_temps-${document.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
              
              // Restore button
              $('#printTimetableBtn').html(originalBtnText);
              $('#printTimetableBtn').prop('disabled', false);
            },
            error: function(xhr, status, error) {
              console.error('Error loading timetable data:', error);
              alert('Une erreur est survenue lors du chargement des données de l\'emploi du temps.');
              
              // Restore button
              $('#printTimetableBtn').html(originalBtnText);
              $('#printTimetableBtn').prop('disabled', false);
            }
          });
        })
        .catch(error => {
          console.error('Error loading PDF libraries:', error);
          alert('Une erreur est survenue lors du chargement des bibliothèques nécessaires. Veuillez réessayer.');
          
          // Restore button
          $('#printTimetableBtn').html(originalBtnText);
          $('#printTimetableBtn').prop('disabled', false);
        });
    });


    // Handle confirm validation timetable button in modal
    $('#confirmValidateTimetableBtn').on('click', function() {
      // Get the current timetable ID
      var timetable = "{{pk}}";
      
      // Show a loading indicator on the confirm button
      var originalText = $(this).html();
      $(this).prop('disabled', true);
      $(this).html('<i class="ri-loader-4-line ri-spin me-2"></i>Validation...');
      
      $.ajax({
        url: '{% url "t_timetable:ApiValidateTimetable" %}',
        type: 'GET',
        data: {
          'id_emploie': timetable,
          
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message || 'L\'emploi du temps a été validé avec succès.');
            // Close the modal
            $('#validateTimetableModal').modal('hide');
            // Reload the page to reflect changes
            location.reload();
          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la validation.');
            // Close the modal to allow retry
            $('#validateTimetableModal').modal('hide');
          }
        },
        error: function(xhr, status, error) {
          var errorMessage = 'Une erreur est survenue lors de la validation.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          alertify.error(errorMessage);
          // Close the modal to allow retry
          $('#validateTimetableModal').modal('hide');
        },
        complete: function() {
          // Restore the button text
          $('#confirmValidateTimetableBtn').prop('disabled', false);
          $('#confirmValidateTimetableBtn').html('<i class="ri-check-line me-2"></i>Confirmer la validation');
        }
      });
    });



    // Reset modal when opening
    var addSessionModalObj = document.getElementById('addSessionModal');
    if (addSessionModalObj) {
      addSessionModalObj.addEventListener('show.bs.modal', function (event) {
          // Reset the form
          var form = document.getElementById('addSessionForm');
          if(form) form.reset();
          
          // Reset selects just in case
          $('#session_module').val('');
          $('#session_professeur').html('<option value="">Sélectionnez un professeur</option>'); // Reset teacher list as it depends on module
          $('#session_salle').val('');
          
          // Hide alerts and sections
          $('#teacherAvailabilitySection').hide();
          $('#sharedSessionAlert').addClass('d-none');
          $('#salles_cards').html('');
      });
    }

    $(document).on('change','#session_module', function(){
      checkSharedSession();
      var id_module = $(this).val();
      
      $.ajax({
        url : "{% url 't_timetable:FilterFormateur' %}",
        dataType : "JSON",
        type : "GET",
        data : {
          'code_module' : id_module,
        },
        success : function(data){
          var option="<option value=''>Sélectionnez un professeur</option>";
          $.each(data, function(index, p){
            option += "<option value="+p.formateur__id+">"+p.formateur__nom+' '+p.formateur__prenom+"</option>";
          });
          $('#session_professeur').html(option);
          // Hide the availability section when module changes (since teacher selection will be reset)
          $('#teacherAvailabilitySection').hide();
        },
      })
    });

    // Handle teacher selection change to show/hide availability information
    $(document).on('change', '#session_professeur', function() {
      var selectedTeacherId = $(this).val();
      
      if (selectedTeacherId) {
        // Show the availability section
        $('#teacherAvailabilitySection').show();
        
        // Here we can fetch and display teacher availability data
        // For now, we'll populate with placeholder data or call an API
        loadTeacherAvailability(selectedTeacherId);

        // Check for Shared Session
        checkSharedSession();
      } else {
        // Hide the availability section if no teacher is selected
        $('#teacherAvailabilitySection').hide();
        $('#sharedSessionAlert').addClass('d-none');
      }
    });

    // Check for Shared Session Conflict/Info
    function checkSharedSession(){
        var moduleCode = $('#session_module').val();
        var timetableId = "{{ pk }}";

        if(moduleCode){
             $.ajax({
                url: '{% url "t_timetable:ApiCheckSharedSession" %}',
                type: 'GET',
                data: {
                    'timetable_id': timetableId,
                    'module_code': moduleCode
                },
                success: function(response){
                    if(response.found){
                        var msg = "Ce cours est déjà programmé pour le groupe <strong>" + response.group + "</strong> : <br>" +
                                  "📅 <strong>" + response.day + "</strong> de " + response.start_time + " à " + response.end_time + "<br>" +
                                  "🏫 Salle : <strong>" + response.room + "</strong><br>" +
                                  "👨‍🏫 Formateur : <strong>" + response.teacher + "</strong><br>" +
                                  "📚 Module Partenaire : <strong>" + response.module_matched + "</strong><br><br>" +
                                  "<button id='btnQuickSaveShared' class='btn btn-sm btn-success text-white' " +
                                  "data-teacher='" + response.teacher_id + "' " +
                                  "data-room='" + response.salle_id + "' " +
                                  "data-day='" + response.day + "' " +
                                  "data-start='" + response.start_time + "' " +
                                  "data-end='" + response.end_time + "'>" +
                                  "<i class='ri-check-double-line me-1'></i> S'aligner et Ajouter la séance</button>";
                        
                        $('#sharedSessionMsg').html(msg);
                        $('#sharedSessionAlert').removeClass('d-none');
                        
                        // Handler for Quick Save
                        $('#btnQuickSaveShared').on('click', function(e){
                            e.preventDefault();
                            var btn = $(this);
                            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ajout...');
                            
                            $.ajax({
                                url: "{% url 't_timetable:save_session' %}",
                                type: "POST",
                                data: {
                                    'session_module': moduleCode,
                                    'session_professeur': btn.data('teacher'),
                                    'session_salle': btn.data('room'),
                                    'session_jour': btn.data('day'),
                                    'heure_debut': btn.data('start'),
                                    'heure_fin': btn.data('end'),
                                    'pk': timetableId,
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function(saveResp){
                                    if(saveResp.status == "success"){
                                        alertify.success(saveResp.message);
                                        $('#addSessionModal').modal('hide');
                                        location.reload(); 
                                    } else {
                                        alertify.error(saveResp.message);
                                        btn.prop('disabled', false).html("<i class='ri-check-double-line me-1'></i> Réessayer (Erreur)");
                                    }
                                }
                            });
                        });
                    } else {
                        $('#sharedSessionAlert').addClass('d-none');
                    }
                }
             });
        }
    }

    // Function to load teacher availability information
    function loadTeacherAvailability(teacherId) {
      // Show loading indicator
      $('#teacherAvailabilityLoader').removeClass('d-none');
      $('#teacherWorkload').addClass('d-none');
      
      $.ajax({
        url : "{% url 't_timetable:get_formateur_dispo_status' %}",
        dataType:"JSON",
        type: "GET",
        data : {
          'teacherId' : teacherId,
        },
        success : function(data){
            var html = "";
            $.each(data.result, function(index, p){
              html += '<tr>';
                html += '<td class="text-left"><i class="ri-calendar-2-line me-1"></i>'+p.jour+'</td>';
                html += '<td class="text-left"><i class="ri-timer-line me-1"></i>'+p.heure_debut+' - '+p.heure_fin+'</td>';
                if(p.libre.length > 0 ){
                    html += '<td class="text-left" style="color:green;"><i class="ri-timer-line me-1"></i>'; 
                    $.each(p.libre, function(index, t){
                      html += t.heure_debut+'-'+t.heure_fin;
                      if(index < p.libre.length - 1) html += ', '; 
                    });
                    html+= '</td>';
                }else{
                    html += '<td class="text-left" style="color:red;">Non disponible</td>';
                }
    
                
              html += '</tr>';
            });
            $('#teacherWorkload').html(html || '<tr><td colspan="3" class="text-center text-muted">Aucun</td></tr>');
        },
        error: function(xhr, status, error) {
          // Display error if needed
          $('#teacherWorkload').html('<tr><td colspan="3" class="text-center text-danger">Erreur de chargement</td></tr>');
        },
        complete: function() {
          // Hide loading indicator and show table
          $('#teacherAvailabilityLoader').addClass('d-none');
          $('#teacherWorkload').removeClass('d-none');
        }
      });
      
      $('#teacherScheduledSessions').text('3 séances cette semaine');
    }

    
    // Handle the continue button for different actions
    $('#continueModificationBtn').on('click', function() {
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Envoi en cours...
      `);
      $.ajax({
        url : "{% url 't_timetable:ApiMakeTimetableDraft' %}",
        dataType : "JSON",
        type : "GET",
        data : {
          'id_emploie' : timetable,
        },
        success : function(response){
          if(response.status === "success"){
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>

                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          }else{
            alertify.error(response.message);
          }
        },
        complete: function() {
          // Réactiver le bouton et restaurer son texte après la requête
          btn.prop('disabled', false);
          btn.html(originalText);
        }
      })
    });

    // Handle day change to clear room selection
    $(document).on('change', '#session_jour', function() {
      $('#session_horaire').val('');
      $('#session_salle').val(''); // Clear the hidden input
      $('#salles_cards').html('<div class="col-12"><div class="alert alert-info">Veuillez sélectionner un horaire pour voir les salles disponibles</div></div>');
    });

    
    $(document).on('change','#session_horaire', function(){

       var selectedOption = $('#session_horaire option:selected');

      var heur_debut = selectedOption.data('heure-debut');
      var heur_fin = selectedOption.data('heure-fin');

      var jour= $('#session_jour').val();

      if (!jour) {
        alertify.error("Veuillez d'abord sélectionner un jour");
        return;
      }

      // Show loader and hide cards
      $('#salle_loader').removeClass('d-none');
      $('#salles_cards').html('');
      $('#session_salle').val(''); // Clear the hidden input

      $.ajax({
        url : "{% url 't_timetable:ApiGetSallesDispo' %}",
        dataType : "JSON",
        type: "GET",
        data : {
          'heur_debut' : heur_debut,
          'heur_fin' : heur_fin,
          'jour' : jour
        },
        success : function(response){

          if (response.status == "error") {
            alertify.error(response.message || "Aucune salle disponible pour cet horaire");
            $('#salles_cards').html('<div class="col-12"><div class="alert alert-warning">Aucune salle disponible pour cet horaire</div></div>');
          } else {
            // Display rooms as cards
            var cardsHtml = '';

            if (response.salles && response.salles.length > 0) {
              $.each(response.salles, function(index, salle) {
                cardsHtml += '<div class="col-md-6 col-lg-4">' +
                             '<div class="card room-card" data-room-id="' + salle.id + '">' +
                               '<div class="card-header room-card-header">' +
                                 '<div class="d-flex justify-content-between align-items-center">' +
                                   '<h6 class="card-title mb-0">' + salle.nom + '</h6>' +
                                   '<span class="badge bg-primary">' + salle.type + '</span>' +
                                 '</div>' +
                               '</div>' +
                               '<div class="card-body room-card-body p-3">' +
                                 '<div class="d-flex justify-content-between mb-2">' +
                                   '<span class="text-muted">Code:</span>' +
                                   '<strong>' + salle.code + '</strong>' +
                                 '</div>' +
                                 '<div class="d-flex justify-content-between mb-2">' +
                                   '<span class="text-muted">Capacité:</span>' +
                                   '<strong>' + salle.capacite + ' places</strong>' +
                                 '</div>' +
                               '</div>' +
                             '</div>' +
                           '</div>';
              });
            } else {
              cardsHtml = '<div class="col-12"><div class="alert alert-warning">Aucune salle disponible pour cet horaire</div></div>';
            }

            $('#salles_cards').html(cardsHtml);

            // Add click event to room cards
            $('.room-card').on('click', function() {
              // Remove selected class from all cards
              $('.room-card').removeClass('selected');
              // Add selected class to clicked card
              $(this).addClass('selected');
              // Update hidden input with selected room ID
              var roomId = $(this).data('room-id');
              $('#session_salle').val(roomId);
            });
          }
        },
        error: function(xhr, status, error) {
          alertify.error("Erreur lors du chargement des salles disponibles");
          $('#salles_cards').html('<div class="col-12"><div class="alert alert-danger">Erreur de chargement des salles disponibles</div></div>');
        },
        complete: function() {
          // Hide loader after completion
          $('#salle_loader').addClass('d-none');
        }
      });
    });
  
  
  });
  
  
</script>

{% endblock content %} 