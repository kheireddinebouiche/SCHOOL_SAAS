{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Emploi du Temps - Liste{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Prospect type cards */
  .prospect-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  
  .prospect-type-card:hover {
    transform: translateY(-5px);
    border-color: #dc3545;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }
  
  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }
  
  .table td.text-end {
    position: relative;
    overflow: visible;
  }
  
  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }
  
  /* Specific fix for timetable dropdown */
  .timetable-item {
    position: relative;
    z-index: 1;
  }
  
  .timetable-item:hover {
    z-index: 2;
    position: relative;
  }
  
  .timetable-item .dropdown-menu {
    z-index: 1060 !important;
  }
  
  /* Timetable specific styles */
  .timetable-item {
    transition: transform 0.3s ease;
  }
  
  .timetable-item:hover {
    transform: translateY(-3px);
  }
  
  /* Custom dropdown button without caret */
  .dropdown-toggle-no-caret {
    position: relative;
  }

  .dropdown-toggle-no-caret::after {
    display: none !important;
  }

  /* Modern View Toggle Styles */
  .view-toggle-container {
    position: relative;
    display: inline-block;
    height: 38px;
  }

  .view-toggle {
    position: relative;
    display: flex;
    background: #e9ecef;
    border-radius: 50px;
    padding: 4px;
    height: 100%;
  }

  .view-radio {
    display: none;
  }

  .view-toggle-btn {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    height: calc(100% - 8px);
    line-height: 1.2;
    margin: 4px 0;
  }

  .view-toggle-btn:hover {
    color: #0d6efd;
  }

  .view-radio:checked + .view-toggle-btn {
    color: white;
    font-weight: 600;
  }

  .toggle-indicator {
    position: absolute;
    top: 4px;
    left: 4px;
    height: calc(100% - 8px);
    width: calc(33.33% - 2px);
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    border-radius: 50px;
    transition: all 0.3s ease;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
  }

  /* Toggle Handling for 3 items */
  #cardView:checked ~ .toggle-indicator {
    transform: translateX(0);
  }

  #tableView:checked ~ .toggle-indicator {
    transform: translateX(calc(100% + 4px));
  }
  
  #groupedView:checked ~ .toggle-indicator {
    transform: translateX(calc(200% + 8px));
  }

  /* Timeline styles for help modal */
  .timeline-item {
    position: relative;
  }

  .timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 15px;
    left: 15px;
    height: calc(100% - 30px);
    width: 2px;
    background-color: #e9ecef;
    transform: translateX(-50%);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .view-toggle-btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
    }

    .view-toggle-container {
      height: 34px;
    }

    .timeline-item::after {
      display: none;
    }
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-calendar-alt text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Liste des Emplois du Temps</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Emploi du Temps</a>
                  </li>
                  <li class="breadcrumb-item active">Liste des emplois</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  <select id="filter-timetable" class="form-select rounded-pill" style="width: 220px;">
                    <option value="0">Filtrer par classe</option>
                    {% for classe in classes %}
                      <option value="{{ classe.id }}">{{ classe.nom }}</option>
                    {% endfor %}
                  </select>

                  <select id="date_filter-timetable" class="form-select rounded-pill" style="width: 220px;">
                    <option value="0">Filtrer par période</option>
                    <option value="annee_scolaire">Année scolaire</option>
                    <option value="periode">Période</option>
                  </select>

                  <!-- Modern Toggle Button for View Mode -->
                  <div class="view-toggle-container">
                    <div class="view-toggle">
                      <input type="radio" class="view-radio" name="viewMode" id="cardView" autocomplete="off" checked value="card">
                      <label class="view-toggle-btn" for="cardView">
                        <i class="ri-grid-fill me-1"></i>
                        Vue Carte
                      </label>

                      <input type="radio" class="view-radio" name="viewMode" id="tableView" autocomplete="off" value="table">
                      <label class="view-toggle-btn" for="tableView">
                        <i class="ri-table-line me-1"></i>
                        Vue Tableau
                      </label>

                      <input type="radio" class="view-radio" name="viewMode" id="groupedView" autocomplete="off" value="grouped">
                      <label class="view-toggle-btn" for="groupedView">
                        <i class="ri-group-2-line me-1"></i>
                        Vue Groupée
                      </label>

                      <div class="toggle-indicator"></div>
                    </div>
                  </div>

                  <a href="{% url 't_timetable:CreateTimeTable' %}" id="newTimetableBtn" type="button" class="btn btn-primary rounded-pill">
                    <i class="ri-add-line me-1"></i> Nouvel emploi du temps
                  </a>

                  <!-- Aide Button -->
                  <button type="button" class="btn btn-outline-info rounded-pill" data-bs-toggle="modal" data-bs-target="#timetableHelpModal">
                    <i class="ri-question-line me-1"></i> Aide
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <!-- Card View (Default now) -->
               <div id="cardViewContainer">
                {% if timetables %}
                <div class="row g-3">
                  {% for timetable in timetables %}
                  <div class="col-md-6 col-xl-4">
                    <div class="card h-100 border transition-hover shadow-sm hover-shadow-md">
                      <div class="card-header bg-white border-bottom-0 pt-3 px-3 pb-0 d-flex justify-content-between align-items-start">
                        <div>
                          <h5 class="card-title mb-1 text-info" title="{{ timetable.label }}">{{ timetable.label }}</h5>
                          <p class="text-muted small mb-0"> <i class="ri-group-line "></i> {{ timetable.groupe.nom }}</p>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-ghost-secondary btn-icon btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="ri-more-2-fill fs-5"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                             {% if timetable.is_configured %}
                                  <li>
                                    <a href="{% url 't_timetable:timetable_view' timetable.id %}" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                      <i class="ri-eye-line text-primary me-3"></i>
                                      <span>Voir</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if not timetable.is_configured %}
                                  <li>
                                    <a href="{% url 't_timetable:timetable_configure' timetable.id %}" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                      <i class="ri-settings-line text-warning me-3"></i>
                                      <span>Configurer</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if not timetable.status == "ter" and timetable.is_configured %}
                                  <li>
                                    <button id="btnCkeckValidation" data-status='{{timetable.status}}' data-id='{{timetable.id}}' class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                      <i class="ri-calendar-schedule-line text-info me-3"></i>
                                      <span>Plannification</span>
                                    </button>
                                  </li>
                                  {% endif %}
                                  <li><hr class="dropdown-divider my-1 mx-3"></li>

                                  {% if timetable.status == "enc" %}
                                  <li>
                                    <a id="PauseBtn" data-id='{{timetable.id}}' href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-warning">
                                      <i class="ri-pause-circle-line me-3"></i>
                                      <span>Pause</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if not timetable.status == "ter" and not timetable.status == "bro" %}
                                  <li>
                                    <a id="ClotureBtn"  data-id='{{timetable.id}}'  href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-danger">
                                      <i class="ri-lock-line me-3"></i>
                                      <span>Cloturer</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if timetable.is_configured and timetable.status in "bro,pau" %}
                                  <li>
                                    <a id="ActiveBtn"  data-id='{{timetable.id}}'  href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-success">
                                      <i class="ri-lock-line me-3"></i>
                                      <span>Activer</span>
                                    </a>
                                  </li>
                                  {% endif %}

                                  <li>
                                    <a href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-danger delete-timetable" data-id="{{timetable.id}}" data-status="{{timetable.status}}">
                                      <i class="ri-delete-bin-line me-3"></i>
                                      <span>Supprimer</span>
                                    </a>
                                  </li>
                          </ul>
                        </div>
                      </div>
                      <div class="card-body px-3 py-2">
                        <div class="mb-3">
                           <div class="d-flex justify-content-between mb-1">
                              <span class="badge bg-light text-dark border">{{ timetable.annee_scolaire }}</span>
                              <span class="badge bg-primary-subtle text-primary">{{ timetable.get_semestre_display }}</span>
                           </div>
                        </div>

                         <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Statut:</small>
                            <div>
                              {% if timetable.status == "bro" %}
                                <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                  <i class="ri-draft-line me-1"></i>Brouillon
                                </span>
                              {% elif timetable.status == "enc" %}
                                <span class="badge bg-success-subtle text-success border border-success-subtle">
                                  <i class="ri-run-line me-1"></i>En cours
                                </span>
                              {% elif timetable.status == "pau" %}
                                <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                  <i class="ri-pause-line me-1"></i>En pause
                                </span>
                              {% elif timetable.status == "ter" %}
                                <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                  <i class="ri-check-double-line me-1"></i>Clôturé
                                </span>
                              {% endif %}
                            </div>
                         </div>
                         <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Config:</small>
                            <div>
                               {% if timetable.is_configured %}
                                <span class="badge bg-info-subtle text-info border border-info-subtle">
                                  <i class="ri-checkbox-circle-line me-1"></i>Terminée
                                </span>
                              {% else %}
                                  <span class="badge bg-light text-muted border">
                                  <i class="ri-indeterminate-circle-line me-1"></i>Non configuré
                                </span>
                              {% endif %}
                            </div>
                         </div>

                         {% if timetable.description %}
                         <div class="mt-3 bg-light rounded p-2 border border-dashed">
                            <p class="mb-0 small text-muted text-truncate" title="{{ timetable.description }}">
                               <i class="ri-text me-1"></i> {{ timetable.description }}
                            </p>
                         </div>
                         {% endif %}

                      </div>
                      <div class="card-footer bg-white py-2 px-3 border-top-0">
                         <div class="d-flex align-items-center justify-content-between">
                            <small class="text-muted">
                               <i class="ri-calendar-line me-1"></i> {{ timetable.date_creation|date:"d M Y" }}
                            </small>
                            {% if timetable.is_validated %}
                              <i class="ri-lock-line text-success" title="Validé" data-bs-toggle="tooltip"></i>
                            {% else %}
                               <i class="ri-lock-unlock-line text-muted" title="Non validé" data-bs-toggle="tooltip"></i>
                            {% endif %}
                         </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                  <div class="text-center py-5">
                      <div class="avatar-sm mx-auto mb-4">
                          <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                              <i class="ri-layout-grid-line"></i>
                          </div>
                      </div>
                      <h5 class="mb-2">Aucun emploi du temps trouvé</h5>
                      <p class="text-muted mb-0">Commencez par en créer un nouveau.</p>
                  </div>
                {% endif %}
               </div>

              <!-- Table View (Hidden by default) -->
              <div id="tableViewContainer" style="display: none;">
                <div class="table-responsive" style="overflow-x: visible;">
                  <table id="timetableTable" class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th class="border-0 rounded-start">Nom</th>
                        <th class="border-0">Groupe</th>
                        <th class="border-0">Année scolaire</th>
                        <th class="border-0">Semestre</th>
                        <th class="border-0">Statut</th>
                        <th class="border-0">Programmation</th>
                        <th class="border-0">Date de création</th>
                        <th class="border-0 rounded-end text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="timetableListBody">
                      {% if timetables %}
                        {% for timetable in timetables %}
                          <tr class="align-middle timetable-item">
                            <td>
                              <div class="d-flex align-items-center">
                                {% if timetable.is_validated %}
                                  <i class="ri-lock-line text-success me-2" title="Emploi du temps validé"></i>
                                {% else %}
                                  <i class="ri-lock-unlock-line text-muted me-2" title="Emploi du temps non validé"></i>
                                {% endif %}
                                <div class="flex-grow-1">
                                  <h6 class="mb-0 fw-semibold">{{ timetable.label }}</h6>
                                  <p class="mb-0 text-muted small">{{ timetable.description|default:"Aucune description" }}</p>
                                  {% if not timetable.is_configured %}
                                    <span class="badge bg-warning-subtle text-warning px-2 py-1 mt-1">
                                      <i class="ri-settings-line me-1"></i>Non configuré
                                    </span>
                                  {% endif %}
                                </div>
                              </div>
                            </td>
                            <td>
                              <div class="fw-medium">
                                <span class="text-info fw-semibold">{{ timetable.groupe.nom }}</span>
                              </div>
                            </td>
                            <td>
                              <div class="text-body">{{ timetable.annee_scolaire }}</div>
                            </td>
                            <td>
                              <div class="text-body"><span class='badge bg-primary'>{{ timetable.get_semestre_display }}</span></div>
                            </td>
                            <td>
                              {% if timetable.status == "bro" %}
                                <span class="badge bg-warning-subtle text-warning px-2 py-1">
                                  <i class="ri-check-line me-1"></i>Brouillon
                                </span>
                              {% endif %}
                              {% if timetable.status == "enc" %}
                              <span class="badge bg-success-subtle text-success px-2 py-1">
                                <i class="ri-check-line me-1"></i>En cours
                              </span>
                              {% endif %}
                              {% if timetable.status == "pau" %}
                              <span class="badge bg-warning-subtle text-warning px-2 py-1">
                                <i class="ri-rest-time-line me-1"></i>En pause
                              </span>
                              {% endif %}
                              {% if timetable.status == "ter" %}
                              <span class="badge bg-danger-subtle text-danger px-2 py-1">
                                <i class="ri-check-line me-1"></i>Cloturer
                              </span>
                              {% endif %}
                            </td>
                            <td>
                              {% if timetable.is_configured %}
                                <span class="badge bg-success-subtle text-success px-2 py-1">
                                  <i class="ri-check-line me-1"></i>Configuration Terminer
                                </span>
                              {% else %}
                                  <span class="badge bg-warning-subtle text-warning px-2 py-1">
                                  <i class="ri-check-line me-1"></i>En cours de configuration
                                </span>
                              {% endif %}

                            </td>
                            <td>
                              <div class="text-body">{{ timetable.date_creation|date:"d M Y" }}</div>
                            </td>
                            <td class="text-end">
                              <div class="dropdown d-inline-block">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle-no-caret shadow-none" type="button" id="dropdownMenuButton-{{timetable.id}}" data-bs-toggle="dropdown" aria-expanded="false">
                                  <i class="ri-more-2-fill align-middle"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-2 py-2" aria-labelledby="dropdownMenuButton-{{timetable.id}}" style="z-index: 1060 !important;">
                                  
                                  {% if timetable.is_configured %}
                                  <li>
                                    <a href="{% url 't_timetable:timetable_view' timetable.id %}" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                      <i class="ri-eye-line text-primary me-3"></i>
                                      <span>Voir</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if not timetable.is_configured %}
                                  <li>
                                    <a href="{% url 't_timetable:timetable_configure' timetable.id %}" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                      <i class="ri-settings-line text-warning me-3"></i>
                                      <span>Configurer</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if not timetable.status == "ter" and timetable.is_configured %}
                                  <li>
                                    <button id="btnCkeckValidation" data-status='{{timetable.status}}' data-id='{{timetable.id}}' class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                      <i class="ri-calendar-schedule-line text-info me-3"></i>
                                      <span>Plannification</span>
                                    </button>
                                  </li>
                                  {% endif %}
                                  <li><hr class="dropdown-divider my-1 mx-3"></li>

                                  {% if timetable.status == "enc" %}
                                  <li>
                                    <a id="PauseBtn" data-id='{{timetable.id}}' href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-warning">
                                      <i class="ri-pause-circle-line me-3"></i>
                                      <span>Pause</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if not timetable.status == "ter" and not timetable.status == "bro" %}
                                  <li>
                                    <a id="ClotureBtn"  data-id='{{timetable.id}}'  href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-danger">
                                      <i class="ri-lock-line me-3"></i>
                                      <span>Cloturer</span>
                                    </a>
                                  </li>
                                  {% endif %}
                                  {% if timetable.is_configured and timetable.status in "bro,pau" %}
                                  <li>
                                    <a id="ActiveBtn"  data-id='{{timetable.id}}'  href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-success">
                                      <i class="ri-lock-line me-3"></i>
                                      <span>Activer</span>
                                    </a>
                                  </li>
                                  {% endif %}

                                  <li>
                                    <a href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-danger delete-timetable" data-id="{{timetable.id}}" data-status="{{timetable.status}}">
                                      <i class="ri-delete-bin-line me-3"></i>
                                      <span>Supprimer</span>
                                    </a>
                                  </li>
                                </ul>
                              </div>
                            </td>
                          </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="8" class="text-center text-muted">
                            <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                <div class="avatar-sm mb-4">
                                    <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                        <i class="ri-calendar-todo-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-2">Aucun emploi du temps trouvé</h5>
                                <p class="text-muted mb-0">Il n'y a aucun emploi du temps enregistré pour le moment</p>
                            </div>
                          </td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Grouped View (Hidden by default) -->
              <div id="groupedViewContainer" style="display: none;">
                {% if timetables %}
                  {% regroup timetables by groupe.annee_scolaire as timetables_by_year %}
                  {% for year_group in timetables_by_year %}
                    <div class="card mb-3 border-0">
                      <div class="card-header bg-light p-3">
                        <h5 class="mb-0 text-info">
                          <i class="ri-calendar-2-line me-2"></i>
                          Année Scolaire: {{ year_group.grouper }}
                        </h5>
                      </div>
                      <div class="card-body p-0">
                        <div class="table-responsive">
                          <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                              <tr>
                                <th class="border-0 rounded-start">Nom</th>
                                <th class="border-0">Groupe</th>
                                <th class="border-0">Semestre</th>
                                <th class="border-0">Statut</th>
                                <th class="border-0">Programmation</th>
                                <th class="border-0">Date de création</th>
                                <th class="border-0 rounded-end text-center">Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for timetable in year_group.list %}
                                <tr class="align-middle timetable-item">
                                  <td>
                                    <div class="d-flex align-items-center">
                                      {% if timetable.is_validated %}
                                        <i class="ri-lock-line text-success me-2" title="Emploi du temps validé"></i>
                                      {% else %}
                                        <i class="ri-lock-unlock-line text-muted me-2" title="Emploi du temps non validé"></i>
                                      {% endif %}
                                      <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-semibold">{{ timetable.label }}</h6>
                                        <p class="mb-0 text-muted small">{{ timetable.description|default:"Aucune description" }}</p>
                                        {% if not timetable.is_configured %}
                                          <span class="badge bg-warning-subtle text-warning px-2 py-1 mt-1">
                                            <i class="ri-settings-line me-1"></i>Non configuré
                                          </span>
                                        {% endif %}
                                      </div>
                                    </div>
                                  </td>
                                  <td>
                                    <div class="fw-medium">
                                      <span class="text-info fw-semibold">{{ timetable.groupe.nom }}</span>
                                    </div>
                                  </td>
                                  <td>
                                    <div class="text-body"><span class='badge bg-primary'>{{ timetable.get_semestre_display }}</span></div>
                                  </td>
                                  <td>
                                    {% if timetable.status == "bro" %}
                                      <span class="badge bg-warning-subtle text-warning px-2 py-1">
                                        <i class="ri-check-line me-1"></i>Brouillon
                                      </span>
                                    {% endif %}
                                    {% if timetable.status == "enc" %}
                                    <span class="badge bg-success-subtle text-success px-2 py-1">
                                      <i class="ri-check-line me-1"></i>En cours
                                    </span>
                                    {% endif %}
                                    {% if timetable.status == "pau" %}
                                    <span class="badge bg-warning-subtle text-warning px-2 py-1">
                                      <i class="ri-rest-time-line me-1"></i>En pause
                                    </span>
                                    {% endif %}
                                    {% if timetable.status == "ter" %}
                                    <span class="badge bg-danger-subtle text-danger px-2 py-1">
                                      <i class="ri-check-line me-1"></i>Cloturer
                                    </span>
                                    {% endif %}
                                  </td>
                                  <td>
                                    {% if timetable.is_configured %}
                                      <span class="badge bg-success-subtle text-success px-2 py-1">
                                        <i class="ri-check-line me-1"></i>Configuration Terminer
                                      </span>
                                    {% else %}
                                        <span class="badge bg-warning-subtle text-warning px-2 py-1">
                                        <i class="ri-check-line me-1"></i>En cours de configuration
                                      </span>
                                    {% endif %}

                                  </td>
                                  <td>
                                    <div class="text-body">{{ timetable.date_creation|date:"d M Y" }}</div>
                                  </td>
                                  <td class="text-end">
                                    <div class="dropdown d-inline-block">
                                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle-no-caret shadow-none" type="button" id="dropdownMenuButtonGrouped-{{timetable.id}}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="ri-more-2-fill align-middle"></i>
                                      </button>
                                      <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-2 py-2" aria-labelledby="dropdownMenuButtonGrouped-{{timetable.id}}" style="z-index: 1060 !important;">
                                        <li>
                                          <a href="{% url 't_timetable:timetable_view' timetable.id %}" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                            <i class="ri-eye-line text-primary me-3"></i>
                                            <span>Voir</span>
                                          </a>
                                        </li>
                                        {% if not timetable.is_configured %}
                                        <li>
                                          <a href="{% url 't_timetable:timetable_configure' timetable.id %}" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                            <i class="ri-settings-line text-warning me-3"></i>
                                            <span>Configurer</span>
                                          </a>
                                        </li>
                                        {% endif %}
                                        {% if not timetable.status == "ter" %}
                                        <li>
                                          <button id="btnCkeckValidationGrouped" data-status='{{timetable.status}}' data-id='{{timetable.id}}' class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2">
                                            <i class="ri-calendar-schedule-line text-info me-3"></i>
                                            <span>Plannification</span>
                                          </button>
                                        </li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider my-1 mx-3"></li>

                                        {% if timetable.status == "enc" %}
                                        <li>
                                          <a id="PauseBtnGrouped" data-id='{{timetable.id}}' href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-warning">
                                            <i class="ri-pause-circle-line me-3"></i>
                                            <span>Pause</span>
                                          </a>
                                        </li>
                                        {% endif %}
                                        {% if not timetable.status == "ter" and not timetable.status == "bro" %}
                                        <li>
                                          <a id="ClotureBtnGrouped"  data-id='{{timetable.id}}'  href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-danger">
                                            <i class="ri-lock-line me-3"></i>
                                            <span>Cloturer</span>
                                          </a>
                                        </li>
                                        {% endif %}
                                        {% if timetable.status == "bro" or timetable.status == "pau" %}
                                        <li>
                                          <a id="ActiveBtnGrouped"  data-id='{{timetable.id}}'  href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-success">
                                            <i class="ri-lock-line me-3"></i>
                                            <span>Activer</span>
                                          </a>
                                        </li>
                                        {% endif %}

                                        <li>
                                          <a href="#" class="dropdown-item rounded-1 d-flex align-items-center px-3 py-2 text-danger delete-timetable" data-id="{{timetable.id}}" data-status="{{timetable.status}}">
                                            <i class="ri-delete-bin-line me-3"></i>
                                            <span>Supprimer</span>
                                          </a>
                                        </li>
                                      </ul>
                                    </div>
                                  </td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-center py-5">
                    <div class="avatar-sm mx-auto mb-4">
                      <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                        <i class="ri-calendar-todo-line"></i>
                      </div>
                    </div>
                    <h5 class="mb-2">Aucun emploi du temps trouvé</h5>
                    <p class="text-muted mb-0">Il n'y a aucun emploi du temps enregistré pour le moment</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>


<!-- Pause Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1" aria-labelledby="pauseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning bg-opacity-10 border-0 pb-0 d-flex align-items-center">
        <h5 class="modal-title fw-bold text-warning flex-grow-1" id="pauseModalLabel">
          <i class="ri-pause-circle-line me-2"></i>Mettre en pause l'emploi du temps
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-0 pb-4">
        <div class="text-center py-3">
          <i class="ri-pause-circle-line text-warning" style="font-size: 48px;"></i>
          <h4 class="mt-3 fw-bold text-warning">Mise en pause</h4>
          <p class="text-muted mt-3">L'emploi du temps sera mis en pause. Les cours planifiés ne seront pas accessibles jusqu'à la réactivation.</p>
          <div class="alert alert-warning bg-warning bg-opacity-10 border-0 alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="ri-error-warning-line text-warning fs-5 me-2"></i>
              <div>
                <strong>Attention</strong><br>
                La mise en pause ne supprime pas les données. L'emploi du temps pourra être réactivé ultérieurement.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 rounded-bottom justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning text-white px-4" id="ConfirmPauseBtn">Confirmer la pause</button>
      </div>
    </div>
  </div>
</div>

<!-- Cloturer Modal -->
<div class="modal fade" id="cloturerModal" tabindex="-1" aria-labelledby="cloturerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger bg-opacity-10 border-0 pb-0 d-flex align-items-center">
        <h5 class="modal-title fw-bold text-danger flex-grow-1" id="cloturerModalLabel">
          <i class="ri-lock-line me-2"></i>Clôturer l'emploi du temps
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-0 pb-4">
        <div class="text-center py-3">
          <i class="ri-lock-line text-danger" style="font-size: 48px;"></i>
          <h4 class="mt-3 fw-bold text-danger">Clôture de l'emploi du temps</h4>
          <p class="text-muted mt-3">L'emploi du temps sera clôturé définitivement. Les cours planifiés ne seront plus accessibles.</p>
          <div class="alert alert-danger bg-danger bg-opacity-10 border-0 alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="ri-error-warning-line text-danger fs-5 me-2"></i>
              <div>
                <strong>Action irréversible</strong><br>
                La clôture est permanente et ne peut pas être annulée. Toutes les données liées seront archivées.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 rounded-bottom justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger px-4" id="ConfirmeClotureBtn">Confirmer la clôture</button>
      </div>
    </div>
  </div>
</div>

<!-- Activer Modal -->
<div class="modal fade" id="activerModal" tabindex="-1" aria-labelledby="activerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success bg-opacity-10 border-0 pb-0 d-flex align-items-center">
        <h5 class="modal-title fw-bold text-success flex-grow-1" id="activerModalLabel">
          <i class="ri-check-line me-2"></i>Activer l'emploi du temps
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-0 pb-4">
        <div class="text-center py-3">
          <i class="ri-check-line text-success" style="font-size: 48px;"></i>
          <h4 class="mt-3 fw-bold text-success">Activation de l'emploi du temps</h4>
          <p class="text-muted mt-3">L'emploi du temps sera activé. Les cours planifiés seront à nouveau accessibles.</p>
          <div class="alert alert-success bg-success bg-opacity-10 border-0 alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="ri-checkbox-circle-line text-success fs-5 me-2"></i>
              <div>
                <strong>Prêt à l'emploi</strong><br>
                L'emploi du temps sera mis à jour avec le statut actif et accessible par tous les utilisateurs concernés.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 rounded-bottom justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success px-4" id="ConfirmeActivateBtn">Confirmer l'activation</button>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Classes Warning Modal -->
<div class="modal fade" id="scheduleWarningModal" tabindex="-1" aria-labelledby="scheduleWarningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning bg-opacity-10 border-0 pb-0 d-flex align-items-center">
        <h5 class="modal-title fw-bold text-warning flex-grow-1" id="scheduleWarningModalLabel">
          <i class="ri-error-warning-line me-2"></i>Emploi du temps non validé
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-0 pb-4">
        <div class="text-center py-3">
          <i class="ri-error-warning-line text-warning" style="font-size: 48px;"></i>
          <h4 class="mt-3 fw-bold text-warning">Validation requise</h4>
          <p class="text-muted mt-3">Pour pouvoir planifier les cours, l'emploi du temps doit être validé (créé).</p>
          <div class="alert alert-warning bg-warning bg-opacity-10 border-0 alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="ri-error-warning-line text-warning fs-5 me-2"></i>
              <div>
                <strong>Attention</strong><br>
                Veuillez d'abord créer et valider l'emploi du temps avant de pouvoir planifier les cours.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 rounded-bottom justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Timetable in Use Warning Modal -->
<div class="modal fade" id="timetableInUseWarningModal" tabindex="-1" aria-labelledby="timetableInUseWarningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning bg-opacity-10 border-0 pb-0 d-flex align-items-center">
        <h5 class="modal-title fw-bold text-warning flex-grow-1" id="timetableInUseWarningModalLabel">
          <i class="ri-alert-line me-2"></i>Emploi du temps en cours d'utilisation
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-0 pb-4">
        <div class="text-center py-3">
          <i class="ri-alert-line text-warning" style="font-size: 48px;"></i>
          <h4 class="mt-3 fw-bold text-warning">Avertissement important</h4>
          <p class="text-muted mt-3">Cet emploi du temps est actuellement en cours d'utilisation.</p>
          <div class="alert alert-warning bg-warning bg-opacity-10 border-0 alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="ri-error-warning-line text-warning fs-5 me-2"></i>
              <div>
                <strong>Attention</strong><br>
                La suppression de cet emploi du temps pourrait causer une incohérence dans les données. Les cours planifiés et les horaires associés seront affectés.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 rounded-bottom justify-content-center gap-2">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Timetable Modal -->
<div class="modal fade" id="deleteTimetableModal" tabindex="-1" aria-labelledby="deleteTimetableModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger bg-opacity-10 border-0 pb-0 d-flex align-items-center">
        <h5 class="modal-title fw-bold text-danger flex-grow-1" id="deleteTimetableModalLabel">
          <i class="ri-delete-bin-line me-2"></i>Supprimer l'emploi du temps
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-0 pb-4">
        <div class="text-center py-3">
          <i class="ri-delete-bin-line text-danger" style="font-size: 48px;"></i>
          <h4 class="mt-3 fw-bold text-danger">Suppression de l'emploi du temps</h4>
          <p class="text-muted mt-3">Êtes-vous sûr de vouloir supprimer cet emploi du temps ? Cette action est irréversible.</p>
          <div class="alert alert-danger bg-danger bg-opacity-10 border-0 alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="ri-error-warning-line text-danger fs-5 me-2"></i>
              <div>
                <strong>Action irréversible</strong><br>
                La suppression est permanente et ne peut pas être annulée. Toutes les données liées seront supprimées définitivement.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 rounded-bottom justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger px-4" id="confirmDeleteTimetableBtn">Confirmer la suppression</button>
      </div>
    </div>
  </div>
</div>


<script>
  // Fix dropdown positioning
  $(document).ready(function () {
    // Ensure table responsive container doesn't hide dropdowns
    $('.table-responsive').css('overflow-x', 'visible');
    
    // Handle dropdown show events to ensure proper z-index
    $(document).on('show.bs.dropdown', function(e) {
      var dropdownMenu = $(e.target).find('.dropdown-menu');
      if (dropdownMenu.length) {
        dropdownMenu.css({
          'z-index': '1060',
          'position': 'absolute'
        });
      }
    });
    
    // Handle timetable item dropdown to ensure it appears above other rows
    $(document).on('show.bs.dropdown', '.timetable-item .dropdown', function() {
      $(this).closest('.timetable-item').css('z-index', '3');
    });
    
    $(document).on('hidden.bs.dropdown', '.timetable-item .dropdown', function() {
      $(this).closest('.timetable-item').css('z-index', '1');
    });
    
    $(document).on('click','#PauseBtn', function(){
      $('#pauseModal').modal('show');
      var id = $(this).data('id');
      $('#ConfirmPauseBtn').data('id', id);
    });

    $(document).on('click','#ConfirmPauseBtn',function(){
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Envoi en cours...
      `);
      var id = $(this).data('id');
      $.ajax({
        url : "{% url 't_timetable:ApiPausetimeTable' %}",
        dataType: "JSON",
        type: 'GET',
        data : {
          'id' : id,
        },
        success : function(response){
          if (response.status === "success"){
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          }else{
            alertify.error("Une erreur c'est produite lors du traitement de la requete")
          }
        },
        complete: function() {
            // Réactiver le bouton et restaurer son texte après la requête
            btn.prop('disabled', false);
            btn.html(originalText);
        }
      });
    });

    $(document).on('click','#ClotureBtn', function(){
      var id = $(this).data('id');
      $('#ConfirmeClotureBtn').data('id', id);
      $('#cloturerModal').modal('show');
    });

    $(document).on('click','#ConfirmeClotureBtn', function(){
      
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Envoi en cours...
      `);
      var id = $(this).data('id');
      $.ajax({
        url : "{% url 't_timetable:ApiClotureTimeTable' %}",
        dataType: "JSON",
        type : "GET",
        data: {
          'id' : id,
        },
        success : function(response){
          if (response.status === "success"){
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          }else{
            alertify.error("Une erreur c'est produite lors du traitement de la requete");
          }
        },
        complete: function() {
            // Réactiver le bouton et restaurer son texte après la requête
            btn.prop('disabled', false);
            btn.html(originalText);
        }

      });
    });

    $(document).on('click','#ActiveBtn', function(){
      var id = $(this).data('id');
      $('#ConfirmeActivateBtn').data('id', id);
      $('#activerModal').modal('show');
    });

    $(document).on('click','#ConfirmeActivateBtn', function(){
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Envoi en cours...
      `);
      var id = $(this).data('id');
      $.ajax({
        url : "{% url 't_timetable:ApiActivateTimeTable' %}",
        dataType: "JSON",
        type : "GET",
        data: {
          'id' : id,
        },
        success : function(response){
          if (response.status === "success"){
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          }else{
            alertify.error("Une erreur c'est produite lors du traitement de la requete");
          }
        },
        complete: function() {
            // Réactiver le bouton et restaurer son texte après la requête
            btn.prop('disabled', false);
            btn.html(originalText);
        }

      });
      
    });

    $(document).on('click','#btnCkeckValidation', function(){
      var id = $(this).data('id');
      var status = $(this).data('status');

      if (status === "bro"){
        $('#scheduleWarningModal').modal('show');
      }else{
        var editUrl = "{% url 't_timetable:timetable_edit' 0 %}".replace("0", id);
        window.location.href = editUrl;
      }
    });

    // Delete functionality
    $(document).on('click', '.delete-timetable', function() {
      const timetableId = $(this).data('id');
      const status = $(this).data('status');
      if(status === "enc"){
        $('#timetableInUseWarningModal').modal('show');
      }else{
        $("#confirmDeleteTimetableBtn").data('id', timetableId);
        $('#deleteTimetableModal').modal('show');
      }   
      
    });
    
  
    $(document).on('click', '#confirmDeleteTimetableBtn', function() {
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Suppression en cours...
      `);
      
      var id = $(this).data('id');
      $.ajax({
        url : "{% url 't_timetable:ApiDeleteTimeTable' %}", // Assuming there's an API endpoint for deleting timetables
        dataType: "JSON",
        type: 'GET',
        data : {
          'id' : id,
        },
        success : function(response){
          if (response.status === "success"){
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #dc3545;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #dc3545;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Suppression en cours ...
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #dc3545;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          }else{
            alertify.error("Une erreur s'est produite lors du traitement de la requête");
          }
        },
        complete: function() {
            // Réactiver le bouton et restaurer son texte après la requête
            btn.prop('disabled', false);
            btn.html(originalText);
        }
      });
    });


    // Handle view switching with enhanced animation
    $('input[name="viewMode"]').change(function() {
      if (this.id === 'cardView') {
        $('#cardViewContainer').fadeIn(300);
        $('#tableViewContainer').fadeOut(300);
        $('#groupedViewContainer').fadeOut(300);
      } else if (this.id === 'tableView') {
        $('#cardViewContainer').fadeOut(300);
        $('#tableViewContainer').fadeIn(300);
        $('#groupedViewContainer').fadeOut(300);
      } else if (this.id === 'groupedView') {
        $('#cardViewContainer').fadeOut(300);
        $('#tableViewContainer').fadeOut(300);
        $('#groupedViewContainer').fadeIn(300);
      }
    });

    // Initialize with card view (default)
    $('#cardViewContainer').show();
    $('#tableViewContainer').hide();
    $('#groupedViewContainer').hide();
  });
</script>

<!-- Modal d'Aide pour l'Emploi du Temps -->
<div class="modal fade" id="timetableHelpModal" tabindex="-1" aria-labelledby="timetableHelpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-light border-0">
        <h5 class="modal-title fw-bold text-dark">
          <i class="ri-questionnaire-line text-info me-2"></i>
          Aide - Gestion des Emplois du Temps
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <h6 class="text-info mb-3">
            <i class="ri-list-check text-info me-2"></i>Guide Étape par Étape
          </h6>

          <div class="d-flex flex-column">
            <div class="d-flex mb-4">
              <div class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle me-3" style="width: 32px; height: 32px; min-width: 32px; flex-shrink: 0;">
                <span class="fw-bold">1</span>
              </div>
              <div>
                <h6 class="mb-1"><strong>Créer un nouvel emploi du temps</strong></h6>
                <p class="text-muted mb-0">Cliquez sur le bouton "Nouvel emploi du temps" pour créer un emploi pour une classe spécifique.</p>
              </div>
            </div>

            <div class="d-flex mb-4">
              <div class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle me-3" style="width: 32px; height: 32px; min-width: 32px; flex-shrink: 0;">
                <span class="fw-bold">2</span>
              </div>
              <div>
                <h6 class="mb-1"><strong>Configurer l'emploi du temps</strong></h6>
                <p class="text-muted mb-0">Dans l'onglet "Configurer", ajoutez les cours, jours et horaires selon les besoins de la classe.</p>
              </div>
            </div>

            <div class="d-flex mb-4">
              <div class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle me-3" style="width: 32px; height: 32px; min-width: 32px; flex-shrink: 0;">
                <span class="fw-bold">3</span>
              </div>
              <div>
                <h6 class="mb-1"><strong>Valider et planifier</strong></h6>
                <p class="text-muted mb-0">Lorsque votre emploi du temps est prêt, cliquez sur "Plannification" pour le valider et planifier son activation.</p>
              </div>
            </div>

            <div class="d-flex mb-4">
              <div class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle me-3" style="width: 32px; height: 32px; min-width: 32px; flex-shrink: 0;">
                <span class="fw-bold">4</span>
              </div>
              <div>
                <h6 class="mb-1"><strong>Surveiller les statuts</strong></h6>
                <p class="text-muted mb-0">Suivez l'état de vos emplois du temps : Brouillon, En cours, En pause ou Cloturé.</p>
                <div class="d-flex gap-2 mt-2">
                  <span class="badge bg-warning-subtle text-warning px-2 py-1">
                    <i class="ri-check-line me-1"></i>Brouillon
                  </span>
                  <span class="badge bg-success-subtle text-success px-2 py-1">
                    <i class="ri-check-line me-1"></i>En cours
                  </span>
                  <span class="badge bg-warning-subtle text-warning px-2 py-1">
                    <i class="ri-rest-time-line me-1"></i>En pause
                  </span>
                  <span class="badge bg-danger-subtle text-danger px-2 py-1">
                    <i class="ri-check-line me-1"></i>Cloturer
                  </span>
                </div>
              </div>
            </div>

            <div class="d-flex">
              <div class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle me-3" style="width: 32px; height: 32px; min-width: 32px; flex-shrink: 0;">
                <span class="fw-bold">5</span>
              </div>
              <div>
                <h6 class="mb-1"><strong>Visualiser et gérer</strong></h6>
                <p class="text-muted mb-0">Utilisez les boutons d'action pour voir, modifier, activer, mettre en pause ou clôturer les emplois du temps.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info" role="alert">
          <i class="ri-lightbulb-line me-2"></i>
          <strong>Astuce :</strong> Vous pouvez utiliser les filtres en haut pour rechercher un emploi du temps spécifique par classe ou par période.
          Le bouton "Vue Groupée" permet d'afficher les emplois du temps regroupés par année scolaire.
        </div>
      </div>
      <div class="modal-footer bg-light border-0">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}