{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Configuration Emploi du Temps{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Additional styles for configuration page */
  .config-section {
    margin-bottom: 30px;
  }
  
  .config-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .config-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .config-body {
    padding: 20px;
  }
  
  .config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .config-actions .btn {
    margin-bottom: 5px;
  }
  
  .time-input {
    width: 120px;
    display: inline-block;
    margin: 0 5px;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-cog text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Configuration Emploi du Temps</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Emploi du Temps</a>
                  </li>
                  <li class="breadcrumb-item active">Configuration</li>
                </ol>
              </nav>
              <button type="button" class="btn btn-success btn-sm" id="finishConfigurationBtn">
                <i class="ri-check-double-line me-1"></i>Terminer
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Timetable Details Section -->
      {% if timetable %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex align-items-center">
                <i class="fas fa-calendar-alt text-info me-2"></i>
                <h5 class="card-title mb-0 text-info">Détails de l'Emploi du Temps</h5>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Label:</label>
                    <p class="mb-0">{{ timetable.label }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Groupe:</label>
                    <p class="mb-0">{{ timetable.groupe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Classe:</label>
                    <p class="mb-0">{{ timetable.groupe.classe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Semestre:</label>
                    <p class="mb-0">{{ timetable.semestre }}</p>
                  </div>
                </div>
              </div>
              {% if timetable.description %}
              <div class="row mt-2">
                <div class="col-12">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Description:</label>
                    <p class="mb-0">{{ timetable.description }}</p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row">
        <div class="col-lg-6">
          <!-- Days Configuration -->
          <div class="card shadow border-0 rounded-3 config-card mb-4">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-calendar-day text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Configuration des Jours</h5>
                </div>
                <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addDayModal">
                  <i class="ri-add-line me-1"></i> Ajouter un jour
                </button>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Nom</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="daysTableBody">
                    {% if jours %}
                      {% for jour in jours %}
                        <tr id="jour-row-{{ jour.id }}">
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="flex-grow-1">
                                <h6 class="mb-0 fw-semibold">{{ jour.nom }}</h6>
                              </div>
                            </div>
                          </td>
                          <td class="text-end">
                            <button type="button" class="btn btn-danger btn-sm delete-day" data-day-id="{{ jour.id }}" data-day-nom="{{ jour.nom }}">
                              <i class="ri-delete-bin-line"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="5" class="text-center text-muted">
                            <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                <div class="avatar-sm mb-4">
                                    <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                        <i class="ri-calendar-todo-fill"></i>
                                    </div>
                                </div>
                                <h5 class="mb-2">Aucune journée trouvée</h5>
                                <p class="text-muted mb-0">Il n'y a aucun jour de travaille enregistré pour le moment</p>
                            </div>
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <!-- Hours Configuration -->
          <div class="card shadow border-0 rounded-3 config-card mb-4">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-clock text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Configuration des Horaires</h5>
                </div>
                <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addHourModal">
                  <i class="ri-add-line me-1"></i> Ajouter un horaire
                </button>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Nom</th>
                      <th class="border-0">Heure de début</th>
                      <th class="border-0">Heure de fin</th>
                      <th class="border-0">Statut</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="hoursTableBody">
                    {% if horaires %}
                      {% for horaire in horaires %}
                        <tr id="horaire-row-{{ horaire.id }}">
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="flex-grow-1">
                                <h6 class="mb-0 fw-semibold">{{ horaire.nom }}</h6>
                              </div>
                            </div>
                          </td>
                          <td><div class="fw-medium">{{ horaire.heure_debut|time:"H:i" }}</div></td>
                          <td><div class="text-body">{{ horaire.heure_fin|time:"H:i" }}</div></td>
                          
                          <td>
                            <span class="badge {% if horaire.est_actif %}bg-success{% else %}bg-secondary{% endif %}-subtle {% if horaire.est_actif %}text-success{% else %}text-secondary{% endif %} px-2 py-1">
                              <i class="ri-check-line me-1"></i>{{ horaire.get_status_display }}
                            </span>
                          </td>
                          <td class="text-end">
                            <button type="button" class="btn btn-danger btn-sm delete-horaire" data-horaire-id="{{ horaire.id }}" data-horaire-nom="{{ horaire.nom }}">
                              <i class="ri-delete-bin-line"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="6" class="text-center text-muted">
                            <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                <div class="avatar-sm mb-4">
                                    <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                        <i class="ri-calendar-schedule-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-2">Aucun horaire trouvé</h5>
                                <p class="text-muted mb-0">Il n'y a aucun horaire enregistré pour le moment</p>
                            </div>
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Modal for selecting days -->
<div class="modal fade" id="addDayModal" tabindex="-1" aria-labelledby="addDayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-calendar-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="addDayModalLabel">
              Sélection des jours
            </h5>
            <p class="text-muted small mb-0">Sélectionnez les jours à ajouter aux emplois du temps</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addDayForm">
          <div class="mb-3">
            <h6 class="fw-semibold mb-3">Jours disponibles :</h6>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check mb-2">
                  <input class="form-check-input day-checkbox" type="checkbox" value="Lundi" id="day_lundi" name="selected_days">
                  <label class="form-check-label" for="day_lundi">Lundi</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input day-checkbox" type="checkbox" value="Mardi" id="day_mardi" name="selected_days">
                  <label class="form-check-label" for="day_mardi">Mardi</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input day-checkbox" type="checkbox" value="Mercredi" id="day_mercredi" name="selected_days">
                  <label class="form-check-label" for="day_mercredi">Mercredi</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check mb-2">
                  <input class="form-check-input day-checkbox" type="checkbox" value="Jeudi" id="day_jeudi" name="selected_days">
                  <label class="form-check-label" for="day_jeudi">Jeudi</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input day-checkbox" type="checkbox" value="Vendredi" id="day_vendredi" name="selected_days">
                  <label class="form-check-label" for="day_vendredi">Vendredi</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input day-checkbox" type="checkbox" value="Samedi" id="day_samedi" name="selected_days">
                  <label class="form-check-label" for="day_samedi">Samedi</label>
                </div>
              </div>
            </div>
          </div>
          <!-- Error message container -->
          <div id="addDayError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="saveDayBtn">
          <i class="ri-save-line me-2"></i>Enregistrer les jours
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for editing day -->
<div class="modal fade" id="editDayModal" tabindex="-1" aria-labelledby="editDayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-calendar-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="editDayModalLabel">
              Modifier le jour
            </h5>
            <p class="text-muted small mb-0">Modifiez les informations du jour</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="editDayForm">
          <input type="hidden" id="edit_day_id" name="id">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="edit_day_nom">Nom du jour <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-calendar-line text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="edit_day_nom" name="nom" placeholder="Ex: Lundi" required>
              </div>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="edit_day_abrev">Abréviation <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-text text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="edit_day_abrev" name="abreviation" placeholder="Ex: Lun" required>
              </div>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="edit_day_ordre">Ordre <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-sort-numeric text-muted"></i></span>
                <input type="number" class="form-control border-0 bg-light py-2" id="edit_day_ordre" name="ordre" min="1" required>
              </div>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="edit_day_actif">Statut</label>
              <select class="form-select border-0 bg-light py-2" id="edit_day_actif" name="est_actif">
                <option value="true">Actif</option>
                <option value="false">Inactif</option>
              </select>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="editDayError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="updateDayBtn">
          <i class="ri-save-line me-2"></i>Mettre à jour le jour
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for adding hour -->
<div class="modal fade" id="addHourModal" tabindex="-1" aria-labelledby="addHourModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-time-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="addHourModalLabel">
              Ajouter un nouvel horaire
            </h5>
            <p class="text-muted small mb-0">Configurez un nouvel horaire pour les emplois du temps</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addHourForm">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="add_horaire_nom">Nom de l'horaire <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-time-line text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="add_horaire_nom" name="nom" placeholder="Ex: Matin 1" required>
              </div>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium">Heure de début <span class="text-danger">*</span></label>
              <input type="time" class="form-control border-0 bg-light py-2" id="add_horaire_debut" name="heure_debut" required>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-6">
              <label class="form-label fw-medium">Heure de fin <span class="text-danger">*</span></label>
              <input type="time" class="form-control border-0 bg-light py-2" id="add_horaire_fin" name="heure_fin" required>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="add_horaire_actif">Statut</label>
              <select class="form-select border-0 bg-light py-2" id="add_horaire_actif" name="est_actif">
                <option value="true">Actif</option>
                <option value="false">Inactif</option>
              </select>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="addHourError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="saveHourBtn">
          <i class="ri-save-line me-2"></i>Enregistrer l'horaire
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming day deletion -->
<div class="modal fade" id="deleteDayModal" tabindex="-1" aria-labelledby="deleteDayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteDayModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer le jour <strong id="dayToDeleteName"></strong>. 
            Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteDayBtn">
          <i class="ri-delete-bin-line me-2"></i>Confirmer la suppression
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming hour deletion -->
<div class="modal fade" id="deleteHourModal" tabindex="-1" aria-labelledby="deleteHourModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteHourModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer l'horaire <strong id="hourToDeleteName"></strong>. 
            Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteHourBtn">
          <i class="ri-delete-bin-line me-2"></i>Confirmer la suppression
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for editing hour -->
<div class="modal fade" id="editHourModal" tabindex="-1" aria-labelledby="editHourModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-time-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="editHourModalLabel">
              Modifier l'horaire
            </h5>
            <p class="text-muted small mb-0">Modifiez les informations de l'horaire</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="editHourForm">
          <input type="hidden" id="edit_horaire_id" name="id">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="edit_horaire_nom">Nom de l'horaire <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-time-line text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="edit_horaire_nom" name="nom" placeholder="Ex: Matin 1" required>
              </div>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium">Heure de début <span class="text-danger">*</span></label>
              <input type="time" class="form-control border-0 bg-light py-2" id="edit_horaire_debut" name="heure_debut" required>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-6">
              <label class="form-label fw-medium">Heure de fin <span class="text-danger">*</span></label>
              <input type="time" class="form-control border-0 bg-light py-2" id="edit_horaire_fin" name="heure_fin" required>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="edit_horaire_actif">Statut</label>
              <select class="form-select border-0 bg-light py-2" id="edit_horaire_actif" name="est_actif">
                <option value="true">Actif</option>
                <option value="false">Inactif</option>
              </select>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="editHourError" class="alert alert-danger d-none mt-3" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="updateHourBtn">
          <i class="ri-save-line me-2"></i>Mettre à jour l'horaire
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    var id_emploie = "{{timetable.id}}";
    
    // Handle adding day
    $('#saveDayBtn').on('click', function() {

        var btn = $(this); // référence du bouton
        btn.prop('disabled', true); // désactive le bouton

        // Optionnel : afficher un spinner pour indiquer le chargement
        var originalText = btn.html();
        btn.html(`
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Envoi en cours...
        `);
      
        var formData = $('#addDayForm').serialize();
        formData += '&csrfmiddlewaretoken=' + '{{ csrf_token }}';
        {% if timetable %}
        formData += '&timetable_id=' + {{ timetable.id }};
        {% endif %}

        // Show loading state
        var originalBtnText = $(this).html();
        $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
        $(this).prop('disabled', true);

        // Hide any previous error messages
        $('#addDayError').addClass('d-none');

        $.ajax({
            url: '{% url "t_timetable:save_day" %}',
            type: 'POST',
            data: formData,
            success: function(response) {
            if (response.status === 'success') {
                alertify.success(response.message);
                $('#addDayModal').modal('hide');
                $('#addDayForm')[0].reset(); // Reset form
                
                let spinner = document.createElement("div");
                spinner.innerHTML = `
                    <div id="loadingSpinner" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                        backdrop-filter: blur(3px);">
                        <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                        <div class="success-message" style="
                            font-family: Arial, sans-serif;
                            font-size: 18px;
                            color: #3b7ddd;
                            font-weight: 500;
                            text-align: center;
                            margin-bottom: 10px;">
                            <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                        </div>
                        
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                        .modern-spinner {
                            width: 60px;
                            height: 60px;
                            border: 5px solid #e0e0e0;
                            border-top: 5px solid #3b7ddd;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                        }
                    </style>
                `;
                document.body.appendChild(spinner);
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                // Show error message
                $('#addDayError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de l\'ajout du jour.');
            }
            },
            error: function(xhr, status, error) {
            // Show error message
            var errorMessage = 'Une erreur est survenue lors de l\'ajout du jour.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            $('#addDayError').removeClass('d-none').text(errorMessage);
            },
            complete: function() {
                // Reset button state
                $('#saveDayBtn').html(originalBtnText);
                $('#saveDayBtn').prop('disabled', false);
            }
        });
    });

    // Handle editing day
    $(document).on('click', '.edit-day', function() {
      var dayId = $(this).data('day-id');
      var dayNom = $(this).data('day-nom');
      var dayAbrev = $(this).data('day-abrev');
      var dayOrdre = $(this).data('day-ordre');
      var dayActif = $(this).data('day-actif');

      $('#edit_day_id').val(dayId);
      $('#edit_day_nom').val(dayNom);
      $('#edit_day_abrev').val(dayAbrev);
      $('#edit_day_ordre').val(dayOrdre);
      $('#edit_day_actif').val(dayActif);
      
      $('#editDayModal').modal('show');
    });

    // Handle updating day
    $('#updateDayBtn').on('click', function() {
      var formData = $('#editDayForm').serialize();
      formData += '&csrfmiddlewaretoken=' + '{{ csrf_token }}';

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Mise à jour...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#editDayError').addClass('d-none');

      $.ajax({
        url: '{% url "t_timetable:update_day" %}',
        type: 'POST',
        data: formData,
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#editDayModal').modal('hide');
            $('#editDayForm')[0].reset(); // Reset form
            location.reload(); // Reload to update the list
          } else {
            // Show error message
            $('#editDayError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de la mise à jour du jour.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de la mise à jour du jour.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#editDayError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#updateDayBtn').html(originalBtnText);
          $('#updateDayBtn').prop('disabled', false);
        }
      });
    });

    // Handle clicking delete-day button - show confirmation modal
    $(document).on('click', '.delete-day', function() {
      var dayId = $(this).data('day-id');
      var dayNom = $(this).data('day-nom');
        console.log(dayId);
      // Set the day name in the modal
      $('#dayToDeleteName').text(dayNom);
      
      // Store the dayId in the confirmation button for later use
      $('#confirmDeleteDayBtn').data('day-id', dayId);
      
      // Show the modal
      $('#deleteDayModal').modal('show');
    });
    
    // Handle confirming day deletion
    $('#confirmDeleteDayBtn').on('click', function() {
      var dayId = $(this).data('day-id');
      $.ajax({
        url: '{% url "t_timetable:delete_day" %}',
        type: 'POST',
        data: {
          'id': dayId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#deleteDayModal').modal('hide'); // Hide the modal
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: red;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Opération de suppression en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la suppression du jour.');
          }
        },
        error: function(xhr, status, error) {
          alertify.error('Une erreur est survenue lors de la suppression du jour.');
          $('#deleteDayModal').modal('hide'); // Hide the modal
        }
      });
      
    });

    // Handle adding hour
    $('#saveHourBtn').on('click', function() {
      var formData = $('#addHourForm').serialize();
      formData += '&csrfmiddlewaretoken=' + '{{ csrf_token }}';
      {% if timetable %}
      formData += '&timetable_id=' + {{ timetable.id }};
      {% endif %}

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#addHourError').addClass('d-none');

      $.ajax({
        url: '{% url "t_timetable:save_horaire" %}',
        type: 'POST',
        data: formData,
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#addHourModal').modal('hide');
            $('#addHourForm')[0].reset(); // Reset form
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
           
          } else {
            // Show error message
            $('#addHourError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de l\'ajout de l\'horaire.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de l\'ajout de l\'horaire.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#addHourError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#saveHourBtn').html(originalBtnText);
          $('#saveHourBtn').prop('disabled', false);
        }
      });
    });

    // Handle editing hour
    $(document).on('click', '.edit-horaire', function() {
      var horaireId = $(this).data('horaire-id');
      var horaireNom = $(this).data('horaire-nom');
      var horaireDebut = $(this).data('horaire-debut');
      var horaireFin = $(this).data('horaire-fin');
      var horaireActif = $(this).data('horaire-actif');

      $('#edit_horaire_id').val(horaireId);
      $('#edit_horaire_nom').val(horaireNom);
      $('#edit_horaire_debut').val(horaireDebut);
      $('#edit_horaire_fin').val(horaireFin);
      $('#edit_horaire_actif').val(horaireActif);
      
      $('#editHourModal').modal('show');
    });

    // Handle updating hour
    $('#updateHourBtn').on('click', function() {
      var formData = $('#editHourForm').serialize();
      formData += '&csrfmiddlewaretoken=' + '{{ csrf_token }}';

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Mise à jour...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#editHourError').addClass('d-none');

      $.ajax({
        url: '{% url "t_timetable:update_horaire" %}',
        type: 'POST',
        data: formData,
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#editHourModal').modal('hide');
            $('#editHourForm')[0].reset(); // Reset form
            location.reload(); // Reload to update the list
          } else {
            // Show error message
            $('#editHourError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de la mise à jour de l\'horaire.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de la mise à jour de l\'horaire.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#editHourError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#updateHourBtn').html(originalBtnText);
          $('#updateHourBtn').prop('disabled', false);
        }
      });
    });

    // Handle clicking delete-horaire button - show confirmation modal
    $(document).on('click', '.delete-horaire', function() {
      var horaireId = $(this).data('horaire-id');
      var horaireNom = $(this).data('horaire-nom');
      
      // Set the hour name in the modal
      $('#hourToDeleteName').text(horaireNom);
      
      // Store the horaireId in the confirmation button for later use
      $('#confirmDeleteHourBtn').data('horaire-id', horaireId);
      
      // Show the modal
      $('#deleteHourModal').modal('show');
    });
    
    // Handle confirming hour deletion
    $('#confirmDeleteHourBtn').on('click', function() {
      var horaireId = $(this).data('horaire-id');
      
      $.ajax({
        url: '{% url "t_timetable:delete_horaire" %}',
        type: 'POST',
        data: {
          'id': horaireId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
           
            $('#deleteHourModal').modal('hide'); // Hide the modal
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: red;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Opération de suppression en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          } else {
            alertify.error(response.message || 'Une erreur est survenue lors de la suppression de l\'horaire.');
          }
        },
        error: function(xhr, status, error) {
          alertify.error('Une erreur est survenue lors de la suppression de l\'horaire.');
          $('#deleteHourModal').modal('hide'); // Hide the modal
        }
      });
    });
  });
  
  // Handle finish configuration button
  $('#finishConfigurationBtn').on('click', function() {
    // Show the confirmation modal first
    $('#finishConfirmationModal').modal('show');
  });
  
  // Handle confirmation of finishing configuration
  $(document).on('click','#confirmFinishBtn', function() {
    var btn = $(this); // référence du bouton
    btn.prop('disabled', true); // désactive le bouton

    // Optionnel : afficher un spinner pour indiquer le chargement
    var originalText = btn.html();
    btn.html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Envoi en cours...
    `);

    $.ajax({
        url : "{% url 't_timetable:ApiMakeTimetableDone' %}",
        dataType : "JSON",
        type: "GET",
        data : {
            'id_emploie' : "{{timetable.id}}",
        },
        success : function(response){
            if (response.status == "success"){
               
                $('#finishConfirmationModal').modal('hide');
                $('#courseConfigurationModal').modal('show');
            }else{

            }
        },
        complete: function() {
            // Réactiver le bouton et restaurer son texte après la requête
            btn.prop('disabled', false);
            btn.html(originalText);
        }
    })
    
  });
  
  // Handle configure courses button
  $('#configureCoursesBtn').on('click', function() {
    // For now, redirect to the timetable view page or course configuration page
    // We'll need to set up the proper URL in the future
    alert("Fonctionnalité de configuration des cours bientôt disponible !");
    $('#courseConfigurationModal').modal('hide');
  });
  
  // Handle return later button
  $('#returnLaterBtn').on('click', function() {
    // Redirect to the timetable list page
    window.location.href = "{% url 't_timetable:ListeDesEmploie' %}";
  });
</script>

<!-- Modal for confirmation before course configuration -->
<div class="modal fade" id="finishConfirmationModal" tabindex="-1" aria-labelledby="finishConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-check-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="finishConfirmationModalLabel">
              Confirmation
            </h5>
            <p class="text-muted small mb-0">Veuillez confirmer la validation</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-check-line text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3">Valider les configurations ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de valider vos configurations de base (jours et horaires). 
            Êtes-vous sûr de vouloir continuer ?
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="confirmFinishBtn">
          <i class="ri-check-line me-2"></i>Valider
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for course configuration options -->
<div class="modal fade" id="courseConfigurationModal" tabindex="-1" aria-labelledby="courseConfigurationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-todo-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="courseConfigurationModalLabel">
              Configuration des cours
            </h5>
            <p class="text-muted small mb-0">Que souhaitez-vous faire maintenant ?</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-todo-line text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3">Configuration terminée !</h4>
          <p class="text-muted mb-4">
            Vous avez terminé la configuration de base de l'emploi du temps. 
            Que souhaitez-vous faire maintenant ?
          </p>
        </div>
        
        <div class="d-flex flex-column align-items-center gap-3">
          <button type="button" class="btn btn-primary btn-lg w-100 py-3" id="configureCoursesBtn">
            <i class="ri-settings-3-line me-2"></i>Configurer les cours maintenant
          </button>
          <button type="button" class="btn btn-outline-secondary btn-lg w-100 py-3" id="returnLaterBtn">
            <i class="ri-timer-line me-2"></i>Revenir plus tard
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}