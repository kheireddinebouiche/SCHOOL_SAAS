{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Configuration Emploi du Temps{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Additional styles for configuration page */
  .config-section {
    margin-bottom: 30px;
  }
  
  .config-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .config-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .config-body {
    padding: 20px;
  }
  
  .config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .config-actions .btn {
    margin-bottom: 5px;
  }
  
  .time-input {
    width: 120px;
    display: inline-block;
    margin: 0 5px;
  }
</style>


<script>
  // Pass the ModelCrenau data to JavaScript
  var crenauData = [
    {% for crenau_model in crenau %}
    {
      id: {{ crenau_model.id }},
      label: "{{ crenau_model.label|default:"Modèle sans nom"|escapejs }}",
      description: "{{ crenau_model.description|default:""|escapejs }}",
      jour_data: {{ crenau_model.jour_data|safe }},
      horaire_data: {{ crenau_model.horaire_data|safe }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-cog text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Configuration Emploi du Temps</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Emploi du Temps</a>
                  </li>
                  <li class="breadcrumb-item active">Configuration</li>
                </ol>
              </nav>
              <button type="button" class="btn btn-success btn-sm" id="finishConfigurationBtn">
                <i class="ri-check-double-line me-1"></i>Terminer
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Timetable Details Section -->
      {% if timetable %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow border-0 rounded-3 config-card">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex align-items-center">
                <i class="fas fa-calendar-alt text-info me-2"></i>
                <h5 class="card-title mb-0 text-info">Détails de l'Emploi du Temps</h5>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Label:</label>
                    <p class="mb-0">{{ timetable.label }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Groupe:</label>
                    <p class="mb-0">{{ timetable.groupe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Classe:</label>
                    <p class="mb-0">{{ timetable.groupe.classe.nom }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Semestre:</label>
                    <p class="mb-0">{{ timetable.semestre }}</p>
                  </div>
                </div>
              </div>
              {% if timetable.description %}
              <div class="row mt-2">
                <div class="col-12">
                  <div class="info-item">
                    <label class="form-label fw-bold text-muted">Description:</label>
                    <p class="mb-0">{{ timetable.description }}</p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row">
        <!-- Time Slot Template Selection -->
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3 config-card mb-4">
            <div class="card-header bg-white p-3 config-header">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-clock text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Modèle de Créneau</h5>
                </div>
              </div>
            </div>
            <div class="card-body p-3 config-body">
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label fw-medium" for="timeSlotTemplate">Sélectionner un modèle de créneau <span class="text-danger">*</span></label>
                  <select class="form-select border-0 bg-light py-2" id="timeSlotTemplate" name="time_slot_template">
                    <option value="">Sélectionner un modèle</option>
                    {% for crenau_model in crenau %}
                      <option value="{{ crenau_model.id }}">{{ crenau_model.label|default:"Modèle sans nom" }}</option>
                    {% endfor %}
                    <option value="personnalise">Personnalisé</option>
                  </select>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-12">
                  <h6 class="text-muted mb-3">Aperçu du modèle sélectionné :</h6>
                  <div class="border rounded p-3 bg-light" id="templatePreview">
                    <p class="text-center text-muted mb-0">Sélectionnez un modèle pour voir l'aperçu</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        

      </div>
    </div>
  </div>
</div>




<!-- Modal for confirmation before course configuration -->
<div class="modal fade" id="finishConfirmationModal" tabindex="-1" aria-labelledby="finishConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-check-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="finishConfirmationModalLabel">
              Confirmation
            </h5>
            <p class="text-muted small mb-0">Veuillez confirmer la validation</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-check-line text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3">Valider les configurations ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de valider vos configurations de base (jours et horaires). 
            Êtes-vous sûr de vouloir continuer ?
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="confirmFinishBtn">
          <i class="ri-check-line me-2"></i>Valider
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for course configuration options -->
<div class="modal fade" id="courseConfigurationModal" tabindex="-1" aria-labelledby="courseConfigurationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-todo-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="courseConfigurationModalLabel">
              Configuration des cours
            </h5>
            <p class="text-muted small mb-0">Que souhaitez-vous faire maintenant ?</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-todo-line text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3">Configuration terminée !</h4>
          <p class="text-muted mb-4">
            Vous avez terminé la configuration de base de l'emploi du temps. 
            Que souhaitez-vous faire maintenant ?
          </p>
        </div>
        
        <div class="d-flex flex-column align-items-center gap-3">
          <button type="button" class="btn btn-primary btn-lg w-100 py-3" id="configureCoursesBtn">
            <i class="ri-settings-3-line me-2"></i>Configurer les cours maintenant
          </button>
          <button type="button" class="btn btn-outline-secondary btn-lg w-100 py-3" id="returnLaterBtn">
            <i class="ri-timer-line me-2"></i>Revenir plus tard
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    var id_emploie = "{{timetable.id}}";
    
    // Update template preview when selection changes
    $('#timeSlotTemplate').on('change', function() {
      var selectedValue = $(this).val();
      var previewContainer = $('#templatePreview');
      
      if (selectedValue === '') {
        previewContainer.html('<p class="text-center text-muted mb-0">Sélectionnez un modèle pour voir l\'aperçu</p>');
        return;
      }
      
      if (selectedValue === 'personnalise') {
        previewContainer.html('<p class="text-center text-muted mb-0">Vous configurerez les créneaux manuellement dans la prochaine étape</p>');
        return;
      }
      
      // Find the selected ModelCrenau in our data array
      var selectedCrenau = crenauData.find(function(item) {
        return item.id == selectedValue;
      });
      
      if (selectedCrenau) {
        var previewHtml = '<div class="row"><div class="col-md-6"><h6 class="text-primary">Jours configurés:</h6><ul class="list-group">';
        
        // Handle jour_data - based on the actual structure: {"jours_travail": ["lundi", "mardi", ...]}
        if (selectedCrenau.jour_data && selectedCrenau.jour_data.jours_travail) {
          // Handle the jours_travail array
          if (Array.isArray(selectedCrenau.jour_data.jours_travail)) {
            selectedCrenau.jour_data.jours_travail.forEach(function(jour) {
              if (typeof jour === 'string') {
                // Capitalize the first letter of the day
                var capitalizedJour = jour.charAt(0).toUpperCase() + jour.slice(1);
                previewHtml += '<li class="list-group-item">' + capitalizedJour + '</li>';
              }
            });
          }
        } else if (selectedCrenau.jour_data && Array.isArray(selectedCrenau.jour_data)) {
          // Fallback: if jour_data is directly an array
          selectedCrenau.jour_data.forEach(function(jour) {
            if (typeof jour === 'string') {
              // Capitalize the first letter of the day
              var capitalizedJour = jour.charAt(0).toUpperCase() + jour.slice(1);
              previewHtml += '<li class="list-group-item">' + capitalizedJour + '</li>';
            } else if (jour && jour.nom) {
              previewHtml += '<li class="list-group-item">' + jour.nom + '</li>';
            }
          });
        } else if (selectedCrenau.jour_data && typeof selectedCrenau.jour_data === 'object' && selectedCrenau.jour_data.nom) {
          // If it's a single object with a 'nom' property
          previewHtml += '<li class="list-group-item">' + selectedCrenau.jour_data.nom + '</li>';
        } else {
          previewHtml += '<li class="list-group-item">Aucun jour configuré</li>';
        }
        
        previewHtml += '</ul></div><div class="col-md-6"><h6 class="text-primary">Créneaux horaires:</h6><ul class="list-group">';
        
        // Handle horaire_data - based on the actual structure: {"plages_horaires": [{"heure_debut": "09:00", "heure_fin": "10:00"}, ...]}
        if (selectedCrenau.horaire_data && selectedCrenau.horaire_data.plages_horaires) {
          // Handle the plages_horaires array
          if (Array.isArray(selectedCrenau.horaire_data.plages_horaires)) {
            selectedCrenau.horaire_data.plages_horaires.forEach(function(horaire) {
              if (horaire && horaire.heure_debut && horaire.heure_fin) {
                // Check if there's a 'nom' property, otherwise create a generic name based on the times
                var nom = horaire.nom_creneau || horaire.nom_creneau + horaire.heure_debut + '-' + horaire.heure_fin;
                previewHtml += '<li class="list-group-item">' + horaire.nom_creneau + ' (' + horaire.heure_debut + ' - ' + horaire.heure_fin + ')</li>';
              }
            });
          }
        } else if (selectedCrenau.horaire_data && Array.isArray(selectedCrenau.horaire_data)) {
          // Fallback: if horaire_data is directly an array of time slots
          selectedCrenau.horaire_data.forEach(function(horaire) {
            if (horaire && horaire.heure_debut && horaire.heure_fin) {
              var nom = horaire.nom || 'Créneau ' + horaire.heure_debut + '-' + horaire.heure_fin;
              previewHtml += '<li class="list-group-item">' + nom + ' (' + horaire.heure_debut + ' - ' + horaire.heure_fin + ')</li>';
            } else if (typeof horaire === 'string') {
              // If the array contains strings (time slots)
              previewHtml += '<li class="list-group-item">' + horaire + '</li>';
            }
          });
        } else if (selectedCrenau.horaire_data && typeof selectedCrenau.horaire_data === 'object' && 
                   selectedCrenau.horaire_data.heure_debut && selectedCrenau.horaire_data.heure_fin) {
          // If it's a single time slot object
          var nom = selectedCrenau.horaire_data.nom || 'Créneau ' + selectedCrenau.horaire_data.heure_debut + '-' + selectedCrenau.horaire_data.heure_fin;
          previewHtml += '<li class="list-group-item">' + nom + ' (' + selectedCrenau.horaire_data.heure_debut + ' - ' + selectedCrenau.horaire_data.heure_fin + ')</li>';
        } else {
          previewHtml += '<li class="list-group-item">Aucun horaire configuré</li>';
        }
        
        previewHtml += '</ul></div></div>';
        
        previewContainer.html(previewHtml);
      }
    });
    
    // Handle finish configuration button
    $('#finishConfigurationBtn').on('click', function() {
      var selectedTemplate = $('#timeSlotTemplate').val();
      if (!selectedTemplate) {
        alert('Veuillez sélectionner un modèle de créneau avant de continuer.');
        return;
      }
      
      // Show the confirmation modal
      $('#finishConfirmationModal').modal('show');
    });
    
    // Handle confirmation of finishing configuration
    $(document).on('click','#confirmFinishBtn', function() {
      var selectedTemplate = $('#timeSlotTemplate').val();
      var btn = $(this); // référence du bouton
      btn.prop('disabled', true); // désactive le bouton

      // Optionnel : afficher un spinner pour indiquer le chargement
      var originalText = btn.html();
      btn.html(`
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Envoi en cours...
      `);

      $.ajax({
          url : "{% url 't_timetable:ApiMakeTimetableDone' %}",
          dataType : "JSON",
          type: "GET",
          data : {
              'id_emploie' : "{{timetable.id}}",
              'crenau_model_id': selectedTemplate  // Using the actual ModelCrenau ID instead of template name
          },
          success : function(response){
              if (response.status == "success"){
                
                  $('#finishConfirmationModal').modal('hide');
                  $('#courseConfigurationModal').modal('show');
              } else {
                alert('Une erreur est survenue lors de la configuration. Veuillez réessayer.');
              }
          },
          error: function() {
            alert('Une erreur est survenue. Veuillez réessayer.');
          },
          complete: function() {
              // Réactiver le bouton et restaurer son texte après la requête
              btn.prop('disabled', false);
              btn.html(originalText);
          }
      })
      
    });
  
    // Handle configure courses button
    $('#configureCoursesBtn').on('click', function() {
      // For now, redirect to the timetable view page or course configuration page
      // We'll need to set up the proper URL in the future
      alert("Fonctionnalité de configuration des cours bientôt disponible !");
      $('#courseConfigurationModal').modal('hide');
    });
    
    // Handle return later button
    $('#returnLaterBtn').on('click', function() {
      // Redirect to the timetable list page
      window.location.href = "{% url 't_timetable:ListeDesEmploie' %}";
    });
    
  });
</script>



{% endblock content %}