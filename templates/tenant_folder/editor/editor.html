{% extends 'tenant_folder/base.html' %}
{% block title %}Éditeur de documents{% endblock title %}

{% block content %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Éditeur de documents</h4>

            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item"><a href="javascript: void(0);">Documents</a></li>
                <li class="breadcrumb-item active">Éditeur</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                {% if template %}
                  Édition: {{ template.name }}
                {% else %}
                  Nouveau modèle de document
                {% endif %}
              </h5>
              <div>
                <button class="btn btn-success me-2" id="saveTemplate">
                  <i class="fas fa-save me-1"></i>Enregistrer
                </button>
                <button class="btn btn-primary me-2" id="previewTemplate">
                  <i class="fas fa-eye me-1"></i>Prévisualiser
                </button>
                <button class="btn btn-info" id="exportTemplate">
                  <i class="fas fa-download me-1"></i>Exporter
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Left Sidebar - Tools -->
                <div class="col-lg-2 border-end">
                  <div class="p-3">
                    <h6 class="mb-3">Outils</h6>
                    <div class="mb-3">
                      <button class="btn btn-outline-primary w-100 mb-2" id="addTextBtn">
                        <i class="fas fa-font me-1"></i>Texte
                      </button>
                      <button class="btn btn-outline-primary w-100 mb-2" id="addImageBtn">
                        <i class="fas fa-image me-1"></i>Image
                      </button>
                      <button class="btn btn-outline-primary w-100 mb-2" id="addRectangleBtn">
                        <i class="fas fa-square me-1"></i>Rectangle
                      </button>
                      <button class="btn btn-outline-primary w-100 mb-2" id="addLineBtn">
                        <i class="fas fa-minus me-1"></i>Ligne
                      </button>
                    </div>

                    <h6 class="mb-3">Variables</h6>
                    <div id="variablesList" class="mb-3">
                      <!-- Variables will be loaded here -->
                      <div class="text-center text-muted py-3" id="variablesLoading">
                        <i class="fas fa-sync fa-spin me-2"></i>Chargement des variables...
                      </div>
                    </div>

                    <div class="card bg-light mb-3">
                      <div class="card-header py-2">
                        <h6 class="mb-0">
                          <i class="fas fa-info-circle me-1 text-info"></i>
                          Aide sur les variables
                        </h6>
                      </div>
                      <div class="card-body p-2">
                        <p class="mb-1 small">Les variables sont des champs dynamiques qui seront remplacés par des données réelles lors de la génération du document.</p>
                        <p class="mb-1 small">Cliquez sur une variable pour l'ajouter à votre document.</p>
                        <p class="mb-0 small text-muted fst-italic">Ex: {{formation}} sera remplacé par le nom de la formation.</p>
                      </div>
                    </div>

                    <div class="card bg-light">
                      <div class="card-header py-2">
                        <h6 class="mb-0">
                          <i class="fas fa-list me-1 text-info"></i>
                          Variables disponibles
                        </h6>
                      </div>
                      <div class="card-body p-2">
                        <ul class="mb-0 small">
                          <li><strong>{{formation}}</strong> - Nom de la formation</li>
                          <li><strong>{{specialite}}</strong> - Spécialité de l'étudiant</li>
                          <li><strong>{{qualification}}</strong> - Qualification de la formation</li>
                          <li><strong>{{prix_formation}}</strong> - Prix de la formation</li>
                          <li><strong>{{annee_academique}}</strong> - Année académique en cours</li>
                          <li><strong>{{ville}}</strong> - Ville de l'établissement</li>
                          <li><strong>{{date}}</strong> - Date du document</li>
                          <li><strong>{{institut}}</strong> - Nom de l'institut</li>
                          <li><strong>{{date_naissance_etudiant}}</strong> - Date de naissance de l'étudiant</li>
                          <li><strong>{{lieu_naissance_etudiant}}</strong> - Lieu de naissance de l'étudiant</li>
                          <li><strong>{{adresse_etudiant}}</strong> - Adresse de l'étudiant</li>
                          <li><strong>{{branche}}</strong> - Branche de la formation</li>
                        </ul>
                      </div>
                    </div>

                    <h6 class="mb-3">Propriétés</h6>
                    <div id="propertiesPanel">
                      <div class="mb-2">
                        <label class="form-label">Police</label>
                        <select class="form-select form-select-sm" id="fontFamilyInput">
                          <option value="Arial">Arial</option>
                          <option value="Times New Roman">Times New Roman</option>
                          <option value="Courier New">Courier New</option>
                          <option value="Georgia">Georgia</option>
                          <option value="Verdana">Verdana</option>
                          <option value="Helvetica">Helvetica</option>
                          <option value="Impact">Impact</option>
                          <option value="Comic Sans MS">Comic Sans MS</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Taille de police</label>
                        <input type="number" class="form-control form-control-sm" id="fontSizeInput" min="8" max="72">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Couleur</label>
                        <input type="color" class="form-control form-control-sm" id="colorInput">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Alignement</label>
                        <select class="form-select form-select-sm" id="alignInput">
                          <option value="left">Gauche</option>
                          <option value="center">Centre</option>
                          <option value="right">Droite</option>
                          <option value="justify">Justifié</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="boldInput">
                          <label class="form-check-label" for="boldInput">Gras</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="italicInput">
                          <label class="form-check-label" for="italicInput">Italique</label>
                        </div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Espacement</label>
                        <div class="row">
                          <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="lineHeightInput" min="0.5" max="3" step="0.1" placeholder="Hauteur">
                          </div>
                          <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="charSpacingInput" min="-5" max="20" placeholder="Caractères">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Main Canvas Area -->
                <div class="col-lg-8">
                  <div class="p-3">
                    <div class="canvas-container position-relative" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                      <canvas id="canvas" width="800" height="1000"></canvas>
                    </div>
                  </div>
                </div>

                <!-- Right Sidebar - Templates -->
                <div class="col-lg-2">
                  <div class="p-3">
                    <h6 class="mb-3">Modèles existants</h6>
                    <div class="list-group" id="templatesList">
                      {% if templates %}
                        {% for temp in templates %}
                          <a href="{% url 't_documents_maker:edit_template' temp.id %}"
                             class="list-group-item list-group-item-action">
                            {{ temp.name }}
                          </a>
                        {% endfor %}
                      {% else %}
                        <p class="text-muted">Aucun modèle existant</p>
                      {% endif %}
                    </div>

                    <div class="mt-3">
                      <a href="{% url 't_documents_maker:create_template' %}"
                         class="btn btn-outline-primary w-100">
                        <i class="fas fa-plus me-1"></i>Nouveau modèle
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
  // Initialize canvas
  const canvas = new fabric.Canvas('canvas', {
    selection: true,
    preserveObjectStacking: true,
    width: 800,
    height: 1000
  });

  // Set canvas background to white
  canvas.backgroundColor = '#ffffff';
  canvas.renderAll();

  // Template ID from Django context
  const templateId = {% if template %}{{ template.id }}{% else %}null{% endif %};
  let currentTemplateName = {% if template %}"{{ template.name|escapejs }}"{% else %}"Nouveau modèle"{% endif %};

  // Current selected object for property updates
  let currentObject = null;

  // Load variables
  function loadVariables() {
    fetch('{% url "t_documents_maker:list_variables" %}')
      .then(response => response.json())
      .then(data => {
        const variablesList = document.getElementById('variablesList');

        if (data.variables && data.variables.length > 0) {
          variablesList.innerHTML = ''; // Clear loading indicator
          data.variables.forEach(variable => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-secondary btn-sm w-100 mb-1';
            btn.textContent = '{{' + variable.name + '}} - ' + variable.label;
            btn.title = variable.description || variable.label;
            btn.onclick = () => addVariableText(variable.name, variable.label);
            variablesList.appendChild(btn);
          });
        } else {
          variablesList.innerHTML = '<div class="text-center text-muted py-2">Aucune variable disponible</div>';
        }
      })
      .catch(error => {
        console.error('Error loading variables:', error);
        const variablesList = document.getElementById('variablesList');
        variablesList.innerHTML = '<div class="text-center text-danger py-2">Erreur de chargement des variables</div>';
      });
  }

  function addVariableText(name, label) {
    const text = new fabric.IText('{{' + name + '}}', {
      left: 100,
      top: 100,
      fontSize: 16,
      fill: '#007bff',
      fontFamily: 'Arial',
      variableName: name
    });
    canvas.add(text);
    canvas.setActiveObject(text);
    canvas.renderAll();
  }

  // Add text element
  function addText() {
    const text = new fabric.IText('Texte éditable', {
      left: 100,
      top: 100,
      fontSize: 20,
      fontFamily: 'Arial',
      fill: '#000000',
      originX: 'left',
      originY: 'top'
    });
    canvas.add(text);
    canvas.setActiveObject(text);
    canvas.renderAll();
  }

  // Add image element
  function addImage() {
    // Create a placeholder image
    const rect = new fabric.Rect({
      left: 100,
      top: 100,
      width: 150,
      height: 100,
      fill: '#e9ecef',
      stroke: '#adb5bd',
      strokeWidth: 1,
      strokeDashArray: [5, 5]
    });

    const text = new fabric.Text('Image', {
      left: 125,
      top: 140,
      fontSize: 14,
      fill: '#6c757d'
    });

    const group = new fabric.Group([rect, text], {
      left: 100,
      top: 100,
      originX: 'left',
      originY: 'top'
    });

    canvas.add(group);
    canvas.setActiveObject(group);
    canvas.renderAll();
  }

  // Add rectangle element
  function addRectangle() {
    const rect = new fabric.Rect({
      left: 100,
      top: 100,
      width: 100,
      height: 50,
      fill: 'transparent',
      stroke: '#000000',
      strokeWidth: 1,
      originX: 'left',
      originY: 'top'
    });
    canvas.add(rect);
    canvas.setActiveObject(rect);
    canvas.renderAll();
  }

  // Add line element
  function addLine() {
    const line = new fabric.Line([50, 50, 150, 50], {
      left: 100,
      top: 100,
      stroke: '#000000',
      strokeWidth: 1,
      originX: 'left',
      originY: 'top'
    });
    canvas.add(line);
    canvas.setActiveObject(line);
    canvas.renderAll();
  }

  // Update properties panel when object is selected
  canvas.on('selection:created', updatePropertiesPanel);
  canvas.on('selection:updated', updatePropertiesPanel);
  canvas.on('object:selected', updatePropertiesPanel);
  canvas.on('object:modified', function(e) {
    updatePropertiesPanel(e);
  });

  function updatePropertiesPanel(e) {
    const obj = e.selected ? e.selected[0] : (e.target || null);
    if (!obj) return;

    currentObject = obj;

    // Update properties panel based on object type
    if (obj.type === 'i-text' || obj.type === 'text') {
      // Set values for text objects
      document.getElementById('fontSizeInput').value = obj.fontSize || 16;
      document.getElementById('colorInput').value = obj.fill || '#000000';
      document.getElementById('alignInput').value = obj.textAlign || 'left';
      document.getElementById('fontFamilyInput').value = obj.fontFamily || 'Arial';
      document.getElementById('boldInput').checked = obj.fontWeight === 'bold';
      document.getElementById('italicInput').checked = obj.fontStyle === 'italic';
      document.getElementById('lineHeightInput').value = obj.lineHeight || 1.16;
      document.getElementById('charSpacingInput').value = obj.charSpacing || 0;

      // Show properties panel
      document.getElementById('propertiesPanel').style.display = 'block';
    } else {
      // Hide properties that don't apply to non-text objects
      document.getElementById('propertiesPanel').style.display = 'block';
      // Reset inputs for non-text objects
      document.getElementById('fontSizeInput').value = '';
      document.getElementById('colorInput').value = '#000000';
      document.getElementById('alignInput').value = 'left';
      document.getElementById('fontFamilyInput').value = 'Arial';
      document.getElementById('boldInput').checked = false;
      document.getElementById('italicInput').checked = false;
      document.getElementById('lineHeightInput').value = '';
      document.getElementById('charSpacingInput').value = '';
    }

    // Update properties when inputs change
    document.getElementById('fontSizeInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('fontSize', parseInt(this.value));
        canvas.renderAll();
      }
    };

    document.getElementById('colorInput').onchange = function() {
      if (currentObject) {
        currentObject.set('fill', this.value);
        canvas.renderAll();
      }
    };

    document.getElementById('alignInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('textAlign', this.value);
        canvas.renderAll();
      }
    };

    document.getElementById('fontFamilyInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('fontFamily', this.value);
        canvas.renderAll();
      }
    };

    document.getElementById('boldInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('fontWeight', this.checked ? 'bold' : 'normal');
        canvas.renderAll();
      }
    };

    document.getElementById('italicInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('fontStyle', this.checked ? 'italic' : 'normal');
        canvas.renderAll();
      }
    };

    document.getElementById('lineHeightInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('lineHeight', parseFloat(this.value));
        canvas.renderAll();
      }
    };

    document.getElementById('charSpacingInput').onchange = function() {
      if (currentObject && (currentObject.type === 'i-text' || currentObject.type === 'text')) {
        currentObject.set('charSpacing', parseInt(this.value));
        canvas.renderAll();
      }
    };
  }

  // Deselect when clicking on canvas background
  canvas.on('mouse:down', function(opt) {
    if (opt.target === null) {
      canvas.discardActiveObject();
      canvas.renderAll();
      currentObject = null;
      // Reset properties panel
      document.getElementById('fontSizeInput').value = '';
      document.getElementById('colorInput').value = '#000000';
      document.getElementById('alignInput').value = 'left';
    }
  });

  // Button event handlers
  document.getElementById('addTextBtn').onclick = addText;
  document.getElementById('addImageBtn').onclick = addImage;
  document.getElementById('addRectangleBtn').onclick = addRectangle;
  document.getElementById('addLineBtn').onclick = addLine;

  // Save template
  document.getElementById('saveTemplate').onclick = function() {
    const layout = canvas.toJSON(['variableName']);

    fetch('{% url "t_documents_maker:save_template" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        id: templateId,
        name: currentTemplateName,
        layout: layout
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Modèle sauvegardé avec succès !');
        if (!templateId) {
          // Redirect to edit the newly created template
          window.location.href = '{% url "t_documents_maker:edit_template" 0 %}'.replace('0', data.id);
        }
      } else {
        alert('Erreur lors de la sauvegarde du modèle');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erreur lors de la sauvegarde du modèle');
    });
  };

  // Preview template - opens in new window
  document.getElementById('previewTemplate').onclick = function() {
    // Get canvas data URL
    const dataUrl = canvas.toDataURL({
      format: 'png',
      quality: 0.8
    });

    // Open preview in new window
    const previewWindow = window.open('', '_blank');
    previewWindow.document.write(`
      <html>
        <head>
          <title>Prévisualisation du modèle</title>
          <style>
            body {
              margin: 0;
              padding: 20px;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              background: #f0f0f0;
            }
            img {
              max-width: 100%;
              max-height: 100vh;
              box-shadow: 0 4px 8px rgba(0,0,0,0.1);
              background: white;
            }
          </style>
        </head>
        <body>
          <img src="${dataUrl}" alt="Preview" />
        </body>
      </html>
    `);
  };

  // Export template
  document.getElementById('exportTemplate').onclick = function() {
    if (templateId) {
      window.location.href = '{% url "t_documents_maker:export_template" 0 %}'.replace('0', templateId);
    } else {
      alert('Veuillez d\'abord sauvegarder le modèle avant de l\'exporter');
    }
  };

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl + S to save
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      document.getElementById('saveTemplate').click();
    }

    // Delete selected object
    if (e.key === 'Delete' && canvas.getActiveObject()) {
      canvas.remove(canvas.getActiveObject());
    }
  });

  // Load template if editing existing
  if (templateId) {
    fetch('{% url "t_documents_maker:load_template" 0 %}'.replace('0', templateId))
      .then(response => response.json())
      .then(data => {
        currentTemplateName = data.name;
        if (data.layout && data.layout.objects) {
          canvas.loadFromJSON(data.layout, function() {
            canvas.renderAll();
          });
        }
      })
      .catch(error => console.error('Error loading template:', error));
  }

  // Load variables on page load
  loadVariables();
</script>
{% endblock content %}
