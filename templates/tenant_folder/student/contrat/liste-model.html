{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Contrats - Liste des modèles{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* Empêche l'icône de capturer les événements souris */
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Prospect type cards */
  .prospect-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  
  .prospect-type-card:hover {
    transform: translateY(-5px);
    border-color: #0d6efd;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }
  
  .prospect-type-card[data-type="entreprise"]:hover {
    border-color: #dc3545;
  }
  
  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }
  
  .table td.text-end {
    position: relative;
    overflow: visible;
  }
  
  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }
  
  /* Contrat-specific styles */
  .card-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 card-icon me-2">
                <i class="fas fa-file-contract text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Liste des modèles de contrat</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Contrats</a>
                  </li>
                  <li class="breadcrumb-item active">Liste des modèles</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->
      
      <!-- KPIs Section -->
      <div class="row">
        <div class="col-12 mb-4">
          <div class="row g-3">
            <!-- Total Contrats -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 card-icon me-3">
                      <i class="ri-file-text-line text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Total Modèles</h5>
                      <h3 class="mb-0 fw-bold" id="totalContrats">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Actifs -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 card-icon me-3">
                      <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Actifs</h5>
                      <h3 class="mb-0 fw-bold" id="actifsCount">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Inactifs -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-danger bg-opacity-10 card-icon me-3">
                      <i class="ri-close-line text-danger fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Inactifs</h5>
                      <h3 class="mb-0 fw-bold" id="inactifsCount">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- En Attente -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-warning bg-opacity-10 card-icon me-3">
                      <i class="ri-time-line text-warning fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">En Attente</h5>
                      <h3 class="mb-0 fw-bold" id="enAttenteCount">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  <select id="filter-type" class="form-select rounded-pill" style="width: 220px;">
                    <option value="0">Filtrer par type de contrat</option>
                    <option value="initial">Contrat Initial</option>
                    <option value="professionnalisation">Contrat de Professionnalisation</option>
                    <option value="apprentissage">Contrat d'Apprentissage</option>
                  </select>

                  <select id="date_filter" class="form-select rounded-pill" style="width: 220px;">
                    <option value="0">Filtrer par date de création</option>
                    <option value="-created_at">Date (récent)</option>
                    <option value="created_at">Date (ancien)</option>
                  </select>
                  
                  <button type="button" class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#createModeleModal">
                    <i class="ri-add-line me-1"></i> Nouveau modèle
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <div class="table-responsive" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Nom du Modèle</th>
                      <th class="border-0">Type de Contrat</th>
                      <th class="border-0">Année Scolaire</th>
                      <th class="border-0">Statut</th>
                      <th class="border-0">Date de Création</th>
                      <th class="border-0">Dernière Modification</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeItem" class="border-top-0">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer ce modèle de contrat. Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Confirmer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de création -->
<div id="createModeleModal" class="modal fade" tabindex="-1" aria-labelledby="createModeleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-add-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="createModeleModalLabel">
                            Création d'un nouveau modèle de contrat
                        </h5>
                        <p class="text-muted small mb-0">Ajouter un nouveau modèle de contrat</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="createModeleForm">
                    <div class="row g-3">
                        <div class="col-lg-12">
                            <label class="form-label fw-medium" for="create_nom">Nom du modèle</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="create_nom" name="nom" required placeholder="Nom du modèle de contrat">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label fw-medium" for="create_formation">Formation</label>
                            <select class="form-select border-0 bg-light py-2" id="create_formation" name="formation_id">
                                <option value="">Sélectionner une formation</option>
                            </select>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label fw-medium" for="create_annee_scolaire">Année scolaire</label>
                            <input type="text" class="form-control border-0 bg-light py-2" id="create_annee_scolaire" name="annee_scolaire" placeholder="ex: 2024/2025">
                            <div id="create_annee_scolaire_error" class="text-danger mt-1" style="display: none;"></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label fw-medium" for="create_statut">Statut</label>
                            <select class="form-select border-0 bg-light py-2" id="create_statut" name="statut" required>
                                <option value="act">Actif</option>
                                <option value="att" selected>En attente</option>
                                <option value="ina">Inactif</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="createModeleBtn">
                    <i class="ri-save-line me-2"></i>Créer le modèle
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de modification -->
<div id="updateModeleModal" class="modal fade" tabindex="-1" aria-labelledby="updateModeleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-edit-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="updateModeleModalLabel">
                            Modification du modèle de contrat
                        </h5>
                        <p class="text-muted small mb-0">Mise à jour des informations du modèle</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="updateModeleForm">
                    <input type="hidden" id="id_modele">
                    <div class="row g-3">
                        <div class="col-lg-12">
                            <label class="form-label fw-medium" for="update_nom">Nom du modèle</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="update_nom" name="nom" required>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label fw-medium" for="update_formation">Formation</label>
                            <select class="form-select border-0 bg-light py-2" id="update_formation" name="formation_id">
                                <option value="">Sélectionner une formation</option>
                            </select>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label fw-medium" for="update_annee_scolaire">Année scolaire</label>
                            <input type="text" class="form-control border-0 bg-light py-2" id="update_annee_scolaire" name="annee_scolaire" placeholder="ex: 2024/2025">
                            <div id="update_annee_scolaire_error" class="text-danger mt-1" style="display: none;"></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label fw-medium" for="update_statut">Statut</label>
                            <select class="form-select border-0 bg-light py-2" id="update_statut" name="statut" required>
                                <option value="act">Actif</option>
                                <option value="att">En attente</option>
                                <option value="ina">Inactif</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary px-4 py-2" id="updateModeleBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer les modifications
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de gestion des articles -->
<div id="articlesModal" class="modal fade" tabindex="-1" aria-labelledby="articlesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-list-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="articlesModalLabel">
                            Gestion des articles du modèle de contrat
                        </h5>
                        <p class="text-muted small mb-0" id="articlesModalSubtitle">Articles pour <span id="articlesModelName"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="current_modele_id">
                
                <!-- Formulaire d'ajout d'article -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-12">
                                <label class="form-label fw-medium" for="new_article">Nouvel article</label>
                                <textarea class="form-control border-0 bg-light" id="new_article" name="article" rows="3" placeholder="Saisissez le texte de l'article..."></textarea>
                                <div id="article_error" class="text-danger mt-1" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="addArticleBtn">
                                <i class="ri-add-line me-2"></i>Ajouter l'article
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des articles -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white pt-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="card-title mb-0 text-muted">Articles du modèle</h6>
                            <span class="badge bg-primary" id="articlesCount">0 article(s)</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Article</th>
                                        <th>Date de création</th>
                                        <th>Dernière modification</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="articlesList">
                                    <!-- Les articles seront chargés dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression d'article -->
<div class="modal fade articleDeleteModal" tabindex="-1" role="dialog" aria-labelledby="articleDeleteModalLabel" aria-hidden="true" id="articleDeleteModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="articleDeleteModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer l'article suivant : <strong>"..."</strong>. Cette action est irréversible.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmDeleteArticleBtn" class="btn btn-danger">Confirmer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Fix dropdown positioning
  $(document).ready(function () {
    // Ensure table responsive container doesn't hide dropdowns
    $('.table-responsive').css('overflow-x', 'visible');
    
    // Handle dropdown show events
    $(document).on('show.bs.dropdown', function(e) {
      var dropdownMenu = $(e.target).find('.dropdown-menu');
      if (dropdownMenu.length) {
        dropdownMenu.css({
          'z-index': '1050',
          'position': 'absolute'
        });
      }
    });

    // Global variables to store data and filter states for contracts
    let allContratsData = []; // Store all contracts data for search functionality
    let currentFilterType = '0'; // Default: '0' means no type filter
    let currentFilterDate = '0'; // Default: '0' means no date filter
    let currentSearchTerm = ''; // Default: empty search term
    
    function updateKPIs(data) {
      // Total contracts
      $('#totalContrats').text(data.length);
      
      // Count by status
      let actifs = 0;
      let inactifs = 0;
      let enAttente = 0;
      
      $.each(data, function(index, item) {
        if (item.statut === 'act') {
          actifs++;
        } else if (item.statut === 'ina') {
          inactifs++;
        }
        
        if (item.statut === 'att') {
          enAttente++;
        }
      });
      
      $('#actifsCount').text(actifs);
      $('#inactifsCount').text(inactifs);
      $('#enAttenteCount').text(enAttente);
    }

    function displayContrats(data) {
      var row = "";
      if (data.length === 0) {
        row += '<tr><td colspan="7" class="text-center text-muted"><div class="d-flex flex-column align-items-center justify-content-center py-5">';
          row += '<div class="avatar-sm mb-4">';
              row += '<div class="avatar-title bg-light text-muted rounded-circle fs-1">';
                  row += '<i class="ri-file-text-line"></i>';
              row += '</div>';
          row += '</div>';
          row += '<h5 class="mb-2">Aucun modèle de contrat trouvé</h5>';
          row += '<p class="text-muted mb-0">Il n\'y a aucun modèle de contrat enregistré pour le moment</p>';
           row += '</div></td></tr>';
      } else {
        $.each(data, function(index, item) {
          var statusBadge = '';
          var statusLabels = {
            'act': 'Actif',
            'att': 'En attente', 
            'ina': 'Inactif'
          };
          var statusLabel = statusLabels[item.statut] || item.statut;
          
          if (item.statut === 'act') {
            statusBadge = '<span class="badge bg-success-subtle text-success px-2 py-1"><i class="ri-check-line me-1"></i>Actif</span>';
          } else if (item.statut === 'ina') {
            statusBadge = '<span class="badge bg-danger-subtle text-danger px-2 py-1"><i class="ri-close-line me-1"></i>Inactif</span>';
          } else {
            statusBadge = '<span class="badge bg-warning-subtle text-warning px-2 py-1"><i class="ri-time-line me-1"></i>En attente</span>';
          }

          row += "<tr class='align-middle'>";
          row += "<td><a href='#'><div class='d-flex align-items-center'><div class='flex-grow-1'><strong>" + item.nom + "</strong></div></div></a></td>";
          row += "<td><div class='fw-medium'>" + item.type_contrat + "</div></td>";
          row += "<td><div class='fw-medium'>" + (item.annee_scolaire || 'N/A') + "</div></td>";
          row += "<td>" + statusBadge + "</td>";
          row += "<td><div class='text-body'><i class='ri-calendar-line text-muted me-2'></i>" + item.date_creation + "</div></td>";
          row += "<td><div class='text-body'><i class='ri-calendar-2-line text-muted me-2'></i>" + item.date_modification + "</div></td>";
          row += '<td class="text-end">';
          row += '<div class="dropdown d-inline-block">';
          row += '<button class="btn btn-soft-info btn-sm dropdown shadow-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
          row += '<i class="ri-more-2-fill"></i>';
          row += '</button>';
          row += '<ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">';
          row += '<li><a href="#" class="dropdown-item d-flex align-items-center px-3 py-2">';
          row += '<i class="ri-eye-line text-info me-2"></i>Voir</a></li>';
          row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 update-modele" data-id="' + item.id + '">';
          row += '<i class="ri-edit-line text-primary me-2"></i>Modifier</button></li>';
          row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 articles-modele" data-id="' + item.id + '" data-name="' + item.nom + '">';
          row += '<i class="ri-file-list-line text-info me-2"></i>Articles</button></li>';
          row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2">';
          row += '<i class="ri-download-line text-info me-2"></i>Télécharger</button></li>';
          row += '<li><hr class="dropdown-divider my-1"></li>';
          
          if(item.statut === "act"){
            row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 deactivate-modele" data-id="' + item.id + '">';
            row += '<i class="ri-toggle-off-line me-2"></i>Désactiver';
            row += '</button></li>';
          } else if(item.statut === "ina"){
            row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 activate-modele" data-id="' + item.id + '">';
            row += '<i class="ri-toggle-on-line me-2"></i>Activer';
            row += '</button></li>';
          } else {
            row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 activate-modele" data-id="' + item.id + '">';
            row += '<i class="ri-toggle-on-line me-2"></i>Activer';
            row += '</button></li>';
          }
          
          row += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 text-danger delete-modele" data-id="' + item.id + '" data-name="' + item.nom + '">';
          row += '<i class="ri-delete-bin-line me-2"></i>Supprimer';
          row += '</button></li>';
          
          row += '</ul>';
          row += '</div>';
          row += '</td>';
          row += "</tr>";
        });
      }
      $("#listeItem").html(row);
      
      // Update KPIs
      updateKPIs(data);
    }

    function loadContrats(){
        $.ajax({
          url : '{% url "t_etudiants:ApiLoadModelesContrat" %}',
          dataType: "JSON",
          type: 'GET',
          success : function(data){
            // Store the data for search functionality
            allContratsData = data;
            
            // Apply current filters and search
            applyFiltersAndSearch();
          },
          error: function(xhr, status, error) {
            console.error('Error loading contracts:', error);
            alert('Erreur lors du chargement des modèles de contrat');
          }
        });
    }

    function applyFiltersAndSearch() {
      try {
        // Start with all contracts data
        let filteredData = [...allContratsData];
        
        // Apply search filter first if there's a search term
        if (currentSearchTerm.trim() !== '') {
          const searchTerm = currentSearchTerm.toLowerCase();
          filteredData = filteredData.filter(function(item) {
            return (item.nom.toLowerCase().includes(searchTerm) || 
                    item.type_contrat.toLowerCase().includes(searchTerm) || 
                    item.statut.toLowerCase().includes(searchTerm));
          });
        }
        
        // Apply type filter if not default
        if (currentFilterType !== '0') {
          filteredData = filteredData.filter(function(item) {
            return item.type_contrat.toLowerCase().includes(currentFilterType);
          });
        }
        
        // Apply date filter if not default (for sorting)
        if (currentFilterDate !== '0') {
          filteredData.sort(function(a, b) {
            // Check if created_at field exists and is valid, otherwise skip sorting or use id as fallback
            var dateA, dateB;
            
            if (a.date_creation && !isNaN(Date.parse(a.date_creation))) {
              dateA = new Date(a.date_creation);
            } else {
              // If date_creation is not available or invalid, use a fallback (like id as timestamp if possible)
              dateA = new Date(0); // Default to epoch time if no valid date
            }
            
            if (b.date_creation && !isNaN(Date.parse(b.date_creation))) {
              dateB = new Date(b.date_creation);
            } else {
              dateB = new Date(0); // Default to epoch time if no valid date
            }
            
            if (currentFilterDate === '-created_at') {
              // Sort by most recent first
              return dateB - dateA;
            } else if (currentFilterDate === 'created_at') {
              // Sort by oldest first
              return dateA - dateB;
            }
          });
        }
        
        // Display the results
        displayContrats(filteredData);
      } catch (error) {
        console.error('Error in applyFiltersAndSearch:', error);
      }
    }

    // Load contracts on page load
    loadContrats();

    $(document).on('click','.delete-modele', function(){
      var id_modele = $(this).data('id');
      var modele_name = $(this).data('name');
      // Store the ID for later use in the confirmation
      $('.deleteModal').data('delete-id', id_modele);
      // Mettre à jour le message dans la modal pour inclure le nom du modèle
      $('.deleteModal .modal-body p.text-muted.mb-0').html(
        'Vous êtes sur le point de supprimer le modèle de contrat <strong>' + modele_name + '</strong>. ' +
        'Cette action est irréversible et toutes les données associées seront définitivement supprimées.'
      );
      $('.deleteModal').modal('show');
    });

    // Confirmer la suppression d'un modèle
    $(document).on('click', '#confirmDeleteBtn', function(){
      var id_modele = $('.deleteModal').data('delete-id');

      $.ajax({
        url : "{% url 't_etudiants:ApiDeleteModeleContrat' %}",
        type : "POST",
        dataType : "JSON",
        data : {'id_modele' : id_modele,'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success : function(response){
          if (response.status === "success"){
            alertify.success(response.message);
            loadContrats(); // Reload the full list after deletion
            $('.deleteModal').modal('hide');
          }else{
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error deleting contract:', error);
          alertify.error('Erreur lors de la suppression du modèle');
        }
      });
    });
    });

    $(document).on('click', '#confirmDeleteBtn', function(){
      var id_modele = $('.deleteModal').data('delete-id');

      $.ajax({
        url : "{% url 't_etudiants:ApiDeleteModeleContrat' %}",
        type : "POST",
        dataType : "JSON",
        data : {'id_modele' : id_modele,'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success : function(response){
          if (response.status === "success"){
            alertify.success(response.message);
            loadContrats(); // Reload the full list after deletion
            $('.deleteModal').modal('hide');
          }else{
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error deleting contract:', error);
          alertify.error('Erreur lors de la suppression du modèle');
        }
      });
    });
    
    // Handle type filter change
    $(document).on('change','#filter-type', function(){
      currentFilterType = $(this).val();
      applyFiltersAndSearch();
    });

    // Handle date filter change
    $(document).on('change','#date_filter', function(){
      currentFilterDate = $(this).val();
      applyFiltersAndSearch();
    });

    // Handle search input - simplified version
    $(document).on('input', '#table-filter', function() {
        currentSearchTerm = $(this).val();
        // Only apply the search filter part, without triggering all filters
        try {
            if (allContratsData && allContratsData.length > 0) {
                let filteredData = [...allContratsData];
                
                // Only apply the search filter
                if (currentSearchTerm.trim() !== '') {
                    const searchTerm = currentSearchTerm.toLowerCase();
                    filteredData = filteredData.filter(function(item) {
                        return (item.nom.toLowerCase().includes(searchTerm) || 
                                item.type_contrat.toLowerCase().includes(searchTerm) || 
                                item.statut.toLowerCase().includes(searchTerm));
                    });
                } else {
                    // If search is empty, show all contracts that match other filters
                    if (currentFilterType !== '0') {
                        filteredData = filteredData.filter(function(item) {
                            return item.type_contrat.toLowerCase().includes(currentFilterType);
                        });
                    }
                    if (currentFilterDate !== '0') {
                        filteredData.sort(function(a, b) {
                            var dateA, dateB;

                            if (a.date_creation && !isNaN(Date.parse(a.date_creation))) {
                                dateA = new Date(a.date_creation);
                            } else {
                                dateA = new Date(0);
                            }

                            if (b.date_creation && !isNaN(Date.parse(b.date_creation))) {
                                dateB = new Date(b.date_creation);
                            } else {
                                dateB = new Date(0);
                            }

                            if (currentFilterDate === '-created_at') {
                                return dateB - dateA;
                            } else if (currentFilterDate === 'created_at') {
                                return dateA - dateB;
                            }
                        });
                    }
                }
                
                displayContrats(filteredData);
            }
        } catch (error) {
            console.error('Error in search handler:', error);
        }
    });
    
    // Handle update model
    $(document).on('click', '.update-modele', function(){
      var id_modele = $(this).data('id');
      var modele = allContratsData.find(m => m.id == id_modele);
      
      if (modele) {
        $('#id_modele').val(modele.id);
        $('#update_nom').val(modele.nom);
        $('#update_annee_scolaire').val(modele.annee_scolaire);
        $('#update_statut').val(modele.statut);
        
        // Charger les formations
        var options = '<option value="">Sélectionner une formation</option>';
        {% for formation in formations %}
            options += '<option value="{{ formation.id }}">{{ formation.nom }}</option>';
        {% endfor %}
        
        // Mettre à jour le select
        $('#update_formation').html(options);
        
        // Attendre un peu pour que les options soient chargées, puis sélectionner la bonne formation
        setTimeout(function() {
            $('#update_formation').val(modele.formation_id);
        }, 100);
        
        $('#updateModeleModal').modal('show');
      }
    });
    
    $(document).on('click', '#updateModeleBtn', function(){
      // Cacher les erreurs précédentes
      hideError('update_annee_scolaire_error');

      var id_modele = $('#id_modele').val();
      var nom = $('#update_nom').val();
      var formation_id = $('#update_formation').val();
      var annee_scolaire = $('#update_annee_scolaire').val();
      var statut = $('#update_statut').val();

      if (!nom) {
        $('#update_nom').addClass('is-invalid');
        showError('update_annee_scolaire_error', 'Veuillez saisir un nom pour le modèle');
        return;
      } else {
        $('#update_nom').removeClass('is-invalid');
      }

      // Valider le format de l'année scolaire
      if (annee_scolaire && !validateAnneeScolaire(annee_scolaire)) {
        showError('update_annee_scolaire_error', 'Le format de l\'année scolaire est incorrect. Utilisez le format: 2024/2025');
        return;
      }

      $.ajax({
        url : "{% url 't_etudiants:ApiUpdateModeleContrat' %}",
        type : "POST",
        dataType : "JSON",
        data : {
          'id_modele' : id_modele,
          'nom' : nom,
          'formation_id' : formation_id,
          'annee_scolaire' : annee_scolaire,
          'statut' : statut,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response){
          if (response.status === "success"){
            alertify.success(response.message);
            loadContrats();
            $('#updateModeleModal').modal('hide');
            // Cacher les erreurs
            hideError('update_annee_scolaire_error');
          }else{
            showError('update_annee_scolaire_error', response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error updating contract:', error);
          showError('update_annee_scolaire_error', 'Erreur lors de la mise à jour du modèle');
        }
      });
    });
    
    // Charger les formations du contexte Django dans les selects
    function loadFormationsFromContext() {
      var options = '<option value="">Sélectionner une formation</option>';
      {% for formation in formations %}
      options += '<option value="{{ formation.id }}">{{ formation.nom }}</option>';
      {% endfor %}
      $('#create_formation').html(options);
      $('#update_formation').html(options);
    }
    
    // Charger les formations au chargement de la page
    loadFormationsFromContext();
    
    // Fonction pour valider le format de l'année scolaire
    function validateAnneeScolaire(annee) {
      if (!annee) return true; // Laisser vide est autorisé
      // Format attendu: 4 chiffres / 4 chiffres (ex: 2024/2025)
      var regex = /^\d{4}\/\d{4}$/;
      return regex.test(annee);
    }

    // Fonction pour afficher les erreurs
    function showError(elementId, message) {
      $('#' + elementId).text(message).show();
    }

    // Fonction pour cacher les erreurs
    function hideError(elementId) {
      $('#' + elementId).text('').hide();
    }

    // Gestion de la création d'un nouveau modèle
    $(document).on('click', '#createModeleBtn', function(){
      // Cacher les erreurs précédentes
      hideError('create_annee_scolaire_error');

      var nom = $('#create_nom').val();
      var formation_id = $('#create_formation').val();
      var annee_scolaire = $('#create_annee_scolaire').val();
      var statut = $('#create_statut').val();

      if (!nom) {
        $('#create_nom').addClass('is-invalid');
        showError('create_annee_scolaire_error', 'Veuillez saisir un nom pour le modèle');
        return;
      } else {
        $('#create_nom').removeClass('is-invalid');
      }

      // Valider le format de l'année scolaire
      if (annee_scolaire && !validateAnneeScolaire(annee_scolaire)) {
        showError('create_annee_scolaire_error', 'Le format de l\'année scolaire est incorrect. Utilisez le format: 2024/2025');
        return;
      }

      $.ajax({
        url : "{% url 't_etudiants:ApiCreateModeleContrat' %}",
        type : "POST",
        dataType : "JSON",
        data : {
          'nom' : nom,
          'formation_id' : formation_id,
          'annee_scolaire' : annee_scolaire,
          'statut' : statut,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response){
          if (response.status === "success"){
            alertify.success(response.message);
            loadContrats();
            $('#createModeleModal').modal('hide');
            // Réinitialiser le formulaire
            $('#createModeleForm')[0].reset();
            $('#create_statut').val('att'); // Réinitialiser au statut par défaut
            // Cacher les erreurs
            hideError('create_annee_scolaire_error');
          }else{
            showError('create_annee_scolaire_error', response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error creating contract:', error);
          showError('create_annee_scolaire_error', 'Erreur lors de la création du modèle');
        }
      });
    });
    
    // Activation/désactivation des modèles
    $(document).on('click', '.activate-modele', function(){
      var id_modele = $(this).data('id');
      
      $.ajax({
        url : "{% url 't_etudiants:ApiUpdateModeleContrat' %}",
        type : "POST",
        dataType : "JSON",
        data : {
          'id_modele' : id_modele,
          'statut' : 'act',
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response){
          if (response.status === "success"){
            alertify.success(response.message);
            loadContrats();
          }else{
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error activating contract:', error);
          alertify.error('Erreur lors de l\'activation du modèle');
        }
      });
    });
    
    $(document).on('click', '.deactivate-modele', function(){
      var id_modele = $(this).data('id');
      
      $.ajax({
        url : "{% url 't_etudiants:ApiUpdateModeleContrat' %}",
        type : "POST",
        dataType : "JSON",
        data : {
          'id_modele' : id_modele,
          'statut' : 'ina',
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response){
          if (response.status === "success"){
            alertify.success(response.message);
            loadContrats();
          }else{
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error deactivating contract:', error);
          alertify.error('Erreur lors de la désactivation du modèle');
        }
      });
    });
    
    // Fonction pour charger les articles d'un modèle
    function loadArticles(modeleId) {
      $.ajax({
        url: '{% url "t_etudiants:ApiLoadArticlesContrat" %}',
        type: 'GET',
        data: { modele_id: modeleId },
        success: function(articles) {
          displayArticles(articles);
        },
        error: function(xhr, status, error) {
          console.error('Error loading articles:', error);
          alertify.error('Erreur lors du chargement des articles');
        }
      });
    }
    
    // Fonction pour afficher les articles
    function displayArticles(articles) {
      var html = '';
      if (articles.length === 0) {
        html = '<tr><td colspan="4" class="text-center text-muted py-4">Aucun article pour ce modèle de contrat</td></tr>';
      } else {
        $.each(articles, function(index, article) {
          html += '<tr class="align-middle" data-article-id="' + article.id + '">';
          html += '<td>' + (article.article || '') + '</td>';
          html += '<td>' + (article.created_at || '') + '</td>';
          html += '<td>' + (article.updated_at || '') + '</td>';
          html += '<td class="text-end">';
          html += '<div class="dropdown d-inline-block">';
          html += '<button class="btn btn-soft-info btn-sm dropdown shadow-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
          html += '<i class="ri-more-2-fill"></i>';
          html += '</button>';
          html += '<ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">';
          html += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 edit-article" data-id="' + article.id + '">';
          html += '<i class="ri-edit-line text-primary me-2"></i>Modifier</button></li>';
          html += '<li><button class="dropdown-item d-flex align-items-center px-3 py-2 text-danger delete-article" data-id="' + article.id + '">';
          html += '<i class="ri-delete-bin-line me-2"></i>Supprimer</button></li>';
          html += '</ul>';
          html += '</div>';
          html += '</td>';
          html += '</tr>';
        });
      }
      $('#articlesList').html(html);
      $('#articlesCount').text(articles.length + ' article(s)');
    }
    
    // Gestion de l'ouverture de la modal des articles
    $(document).on('click', '.articles-modele', function(){
      var id_modele = $(this).data('id');
      var modele_name = $(this).data('name');
      
      $('#current_modele_id').val(id_modele);
      $('#articlesModelName').text(modele_name);
      $('#articlesModal').modal('show');
      
      // Charger les articles du modèle
      loadArticles(id_modele);
    });
    
    // Gestion de l'ajout d'un article
    $(document).on('click', '#addArticleBtn', function(){
      var modele_id = $('#current_modele_id').val();
      var article = $('#new_article').val();
      
      if (!article.trim()) {
        $('#article_error').text('Veuillez saisir le contenu de l\'article').show();
        return;
      }
      
      $.ajax({
        url: '{% url "t_etudiants:ApiCreateArticleContrat" %}',
        type: 'POST',
        data: {
          modele_id: modele_id,
          article: article,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            $('#new_article').val(''); // Réinitialiser le champ
            $('#article_error').hide(); // Cacher l'erreur
            loadArticles(modele_id); // Recharger la liste
          } else {
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error creating article:', error);
          alertify.error('Erreur lors de la création de l\'article');
        }
      });
    });
    
    // Gestion de la modification d'un article
    $(document).on('click', '.edit-article', function(){
      var article_id = $(this).data('id');
      var current_row = $(this).closest('tr');
      var current_article = current_row.find('td:first').text();
      
      // Créer un champ d'édition temporaire
      var edit_row = '<tr id="edit_row_' + article_id + '" class="align-middle">';
      edit_row += '<td colspan="3"><textarea class="form-control" id="edit_article_' + article_id + '">' + current_article + '</textarea></td>';
      edit_row += '<td class="text-end">';
      edit_row += '<button class="btn btn-success btn-sm save-edit-article me-2" data-id="' + article_id + '">';
      edit_row += '<i class="ri-check-line"></i></button>';
      edit_row += '<button class="btn btn-secondary btn-sm cancel-edit-article" data-id="' + article_id + '">';
      edit_row += '<i class="ri-close-line"></i></button>';
      edit_row += '</td>';
      edit_row += '</tr>';
      
      current_row.after(edit_row);
      current_row.hide();
    });
    
    // Sauvegarder la modification
    $(document).on('click', '.save-edit-article', function(){
      var article_id = $(this).data('id');
      var article = $('#edit_article_' + article_id).val();
      var modele_id = $('#current_modele_id').val();
      
      if (!article.trim()) {
        alertify.error('Veuillez saisir le contenu de l\'article');
        return;
      }
      
      $.ajax({
        url: '{% url "t_etudiants:ApiUpdateArticleContrat" %}',
        type: 'POST',
        data: {
          article_id: article_id,
          article: article,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            loadArticles(modele_id); // Recharger la liste
          } else {
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error updating article:', error);
          alertify.error('Erreur lors de la mise à jour de l\'article');
        }
      });
    });
    
    // Annuler la modification
    $(document).on('click', '.cancel-edit-article', function(){
      var article_id = $(this).data('id');
      $('#edit_row_' + article_id).remove();
      $('#articlesList tr[data-article-id="' + article_id + '"]').show();
    });
    
    // Modal de confirmation pour la suppression d'article
    $(document).on('click', '.delete-article', function(){
      var article_id = $(this).data('id');
      var current_row = $(this).closest('tr');
      var article_content = current_row.find('td:first').text();
      
      // Store the article ID for later use in the confirmation
      $('#articleDeleteModal').data('article-id', article_id);
      // Mettre à jour le message dans la modal pour inclure le contenu de l'article
      $('#articleDeleteModal .modal-body p.text-muted.mb-0').html(
        'Vous êtes sur le point de supprimer l\'article suivant : <strong>"' + article_content.substring(0, 50) + (article_content.length > 50 ? '...' : '') + '"</strong>. ' +
        'Cette action est irréversible.'
      );
      $('#articleDeleteModal').modal('show');
    });
    
    // Confirmer la suppression d'un article
    $(document).on('click', '#confirmDeleteArticleBtn', function(){
      var article_id = $('#articleDeleteModal').data('article-id');
      var modele_id = $('#current_modele_id').val();
      
      $.ajax({
        url: '{% url "t_etudiants:ApiDeleteArticleContrat" %}',
        type: 'POST',
        data: {
          article_id: article_id,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === 'success') {
            alertify.success(response.message);
            loadArticles(modele_id); // Recharger la liste
            $('#articleDeleteModal').modal('hide');
          } else {
            alertify.error(response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error deleting article:', error);
          alertify.error('Erreur lors de la suppression de l\'article');
        }
      });
    });
  });
</script>

{% endblock content %}