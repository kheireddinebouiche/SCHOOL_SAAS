{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Formateurs - Liste des formateurs{% endblock title %}

{% block content %}
<style>
  /* Modern styling for Teacher List */
  :root {
    --primary-soft: #eef2ff;
    --primary-main: #4f46e5;
    --success-soft: #ecfdf5;
    --success-main: #10b981;
    --warning-soft: #fffbeb;
    --warning-main: #f59e0b;
    --info-soft: #f0f9ff;
    --info-main: #0ea5e9;
  }

  .stat-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 12px;
  }
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }
  .search-box-integrated {
    position: relative;
    max-width: 300px;
  }
  .search-box-integrated .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
  }
  .search-box-integrated input {
    padding-left: 35px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }
  .table-modern {
    border-collapse: separate;
    border-spacing: 0 8px;
  }
  .table-modern thead th {
    background: transparent;
    border: none;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.025em;
    padding: 12px 16px;
  }
  .table-modern tbody tr {
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    transition: all 0.2s ease;
  }
  .table-modern tbody tr:hover {
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  }
  .table-modern tbody td {
    padding: 16px;
    border: none;
  }
  .table-modern tbody td:first-child {
    border-radius: 8px 0 0 8px;
  }
  .table-modern tbody td:last-child {
    border-radius: 0 8px 8px 0;
  }
  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
  }
  .btn-action {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
  }
  
  /* Dropdown styling */
  .table-responsive { overflow: visible !important; }
  .dropdown-menu {
    border: none;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 8px;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex align-items-center justify-content-between p-2">
            <div>
              <h4 class="mb-1 font-weight-bold">Gestion des Enseignants</h4>
              <p class="text-muted mb-0">Consultez et gérez la liste de vos formateurs et leurs disponibilités.</p>
            </div>
            <button id="newFormateurBtn" type="button" class="btn btn-primary px-4 shadow-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#newFormateurModal">
              <i class="ri-add-line me-1"></i> Nouveau formateur
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card stat-card shadow-sm">
            <div class="card-body p-4">
              <div class="d-flex align-items-center">
                <div class="avatar-circle me-3" style="background-color: var(--primary-main);">
                  <i class="fas fa-users"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Total Formateurs</h6>
                  <h3 class="mb-0 font-weight-bold">{{ formateurs|length }}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stat-card shadow-sm">
            <div class="card-body p-4">
              <div class="d-flex align-items-center">
                <div class="avatar-circle me-3" style="background-color: var(--success-main);">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Actifs ce mois</h6>
                  <h3 class="mb-0 font-weight-bold">{{ formateurs|length }}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stat-card shadow-sm">
            <div class="card-body p-4">
              <div class="d-flex align-items-center">
                <div class="avatar-circle me-3" style="background-color: var(--info-main);">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Dernières Disponibilités</h6>
                  <h3 class="mb-0 font-weight-bold">A jour</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card border-0 shadow-sm rounded-3">
            <div class="card-header bg-white border-0 py-3">
              <div class="d-flex justify-content-between align-items-center px-2">
                <div class="search-box-integrated">
                  <i class="fas fa-search search-icon"></i>
                  <input type="text" placeholder="Rechercher un enseignant..." id="table-filter" class="form-control" autocomplete="off"/>
                </div>
                <div class="d-flex gap-2">
                   <!-- Placeholder for filters if needed -->
                </div>
              </div>
            </div>
            <div class="card-body p-0" id="cardContentBody">
              <div class="table-responsive">
                <table id="example" class="table table-modern align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="ps-4">Nom & Prénom</th>
                      <th>Téléphone</th>
                      <th>Email</th>
                      <th class="text-end pe-4">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeItem">
                  {% if formateurs %}
                    {% for formateur in formateurs %}
                      <tr>
                        <td class="ps-4">
                          <div class="d-flex align-items-center">
                            <div class="avatar-circle me-3" style="background-color: {% cycle '#4f46e5' '#10b981' '#f59e0b' '#0ea5e9' '#ec4899' %};">
                              {{ formateur.nom|slice:":1"|upper }}{{ formateur.prenom|slice:":1"|upper }}
                            </div>
                            <div>
                              <h6 class="mb-0 font-weight-bold">{{formateur.nom}} {{formateur.prenom}}</h6>
                              <span class="badge bg-light text-dark fw-normal mt-1 border" style="font-size: 0.7rem;">{{ formateur.diplome|default:"Enseignant" }}</span>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="d-flex align-items-center text-muted">
                            <i class="ri-phone-line me-2"></i>
                            <span>{{formateur.telephone}}</span>
                          </div>
                        </td>
                        <td>
                          <div class="d-flex align-items-center text-muted">
                            <i class="ri-mail-line me-2"></i>
                            <span>{{formateur.email}}</span>
                          </div>
                        </td>
                        <td class="text-end pe-4">
                          <div class="dropdown">
                            <button class="btn btn-light btn-sm rounded-circle shadow-sm" type="button" data-bs-toggle="dropdown" data-bs-boundary="viewport" aria-expanded="false" style="width: 32px; height: 32px; padding: 0;">
                              <i class="ri-more-2-fill text-muted"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="z-index: 9999;">
                              <li><a class="dropdown-item view-profile py-2" href="#" data-formateur-id="{{ formateur.id }}" data-formateur-nom="{{ formateur.nom }}" data-formateur-prenom="{{ formateur.prenom }}" data-formateur-email="{{ formateur.email }}" data-formateur-telephone="{{ formateur.telephone }}" data-formateur-diplome="{{ formateur.diplome }}"><i class="ri-eye-line text-info me-2"></i>Voir le profil</a></li>
                              <li><a class="dropdown-item edit-profile py-2" href="#" data-formateur-id="{{ formateur.id }}" data-formateur-nom="{{ formateur.nom }}" data-formateur-prenom="{{ formateur.prenom }}" data-formateur-email="{{ formateur.email }}" data-formateur-telephone="{{ formateur.telephone }}" data-formateur-diplome="{{ formateur.diplome }}"><i class="ri-edit-line text-warning me-2"></i>Modifier</a></li>
                              <li><a class="dropdown-item dispo-profile py-2" href="#" data-formateur-id="{{ formateur.id }}" data-formateur-nom="{{ formateur.nom }}" data-formateur-prenom="{{ formateur.prenom }}" data-formateur-email="{{ formateur.email }}" data-formateur-telephone="{{ formateur.telephone }}" data-formateur-diplome="{{ formateur.diplome }}"><i class="ri-time-line text-success me-2"></i>Disponibilité</a></li>
                              <li><hr class="dropdown-divider opacity-50"></li>
                              <li><a class="dropdown-item print-global-timetable py-2" href="#" data-formateur-id="{{ formateur.id }}" data-formateur-nom="{{ formateur.nom }}" data-formateur-prenom="{{ formateur.prenom }}"><i class="ri-printer-line text-primary me-2"></i>Imprimer Emploi Global</a></li>
                            </ul>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                     <tr>
                      <td colspan="4">
                        <div class="d-flex flex-column align-items-center justify-content-center py-5">
                            <div class="avatar-sm mb-4">
                                <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                    <i class="ri-user-unfollow-line"></i>
                                </div>
                            </div>
                            <h5 class="mb-2">Aucun formateur trouvé</h5>
                            <p class="text-muted mb-0">Il n'y a aucun formateur enregistré pour le moment</p>
                        </div>
                      </td>
                     </tr>
                  {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal for new formateur creation -->
<div class="modal fade" id="newFormateurModal" tabindex="-1" aria-labelledby="newFormateurModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-user-add-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="newFormateurModalLabel">
              Créer un nouveau formateur
            </h5>
            <p class="text-muted small mb-0">Remplissez les informations pour le nouveau formateur</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="createFormateurForm">
          <!-- Formateur information -->
          <div class="card border-0 shadow-sm mb-4 overflow-hidden">
            <div class="card-header border-0 bg-white pt-3">
              <div class="d-flex align-items-center">
                <span class="icon-circle bg-primary bg-opacity-10 rounded me-2">
                  <i class="ri-user-line text-primary"></i>
                </span>
                <h6 class="card-title mb-0 text-primary">Informations du formateur</h6>
              </div>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-lg-6">
                  <label class="form-label fw-medium" for="formateur_nom">Nom <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="ri-user-line text-muted"></i></span>
                    <input type="text" class="form-control border-0 bg-light py-2" id="formateur_nom" name="nom" placeholder="Entrez le nom du formateur" required>
                  </div>
                </div>
                <div class="col-lg-6">
                  <label class="form-label fw-medium" for="formateur_prenom">Prénom <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="ri-user-line text-muted"></i></span>
                    <input type="text" class="form-control border-0 bg-light py-2" id="formateur_prenom" name="prenom" placeholder="Entrez le prénom du formateur" required>
                  </div>
                </div>
              </div>
              <div class="row g-3 mt-3">
                <div class="col-lg-6">
                  <label class="form-label fw-medium" for="formateur_telephone">Téléphone <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="ri-phone-line text-muted"></i></span>
                    <input type="tel" class="form-control border-0 bg-light py-2" id="formateur_telephone" name="telephone" placeholder="Entrez le numéro de téléphone" required>
                  </div>
                </div>
                <div class="col-lg-6">
                  <label class="form-label fw-medium" for="formateur_email">Email <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="ri-mail-line text-muted"></i></span>
                    <input type="email" class="form-control border-0 bg-light py-2" id="formateur_email" name="email" placeholder="Entrez l'adresse email" required>
                  </div>
                </div>
              </div>
              <div class="row g-3 mt-3">
                <div class="col-lg-12">
                  <label class="form-label fw-medium" for="formateur_diplome">Diplôme <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="ri-graduation-cap-line text-muted"></i></span>
                    <input type="text" class="form-control border-0 bg-light py-2" id="formateur_diplome" name="diplome" placeholder="Entrez le diplôme du formateur" required>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Error message container -->
          <div id="createFormateurError" class="alert alert-danger d-none" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="saveFormateurBtn">
          <i class="ri-save-line me-2"></i>Enregistrer le formateur
        </button>
      </div>
    </div>
  </div>
</div>

<!--Modal-->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer ce formateur. Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100"></div>
      </div>
    </div>
  </div>
</div>
<!-- /.modal -->

<!-- Modal pour suppression impossible -->
<div class="modal fade deleteImpossibleModal" tabindex="-1" role="dialog" aria-labelledby="deleteImpossibleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-error-warning-line text-warning fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-warning mb-1" id="deleteImpossibleModalLabel">
              Suppression impossible
            </h5>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-error-warning-line text-warning" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-warning mb-3">Action non autorisée</h4>
          <p class="text-muted mb-0">
            La suppression du formateur ne peut pas être effectuée car il est assigné à une formation.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Compris</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /.modal -->

<!--MODAL-->
<div id="updateInfoFormateur" class="modal fade" tabindex="-1" aria-labelledby="updateInfoFormateurLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-user-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="updateInfoFormateurLabel">
                            Modification des informations
                        </h5>
                        <p class="text-muted small mb-0">Mise à jour des informations du formateur</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Informations personnelles -->
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="card-header border-0 bg-white pt-3">
                        <div class="d-flex align-items-center">
                            <span class="icon-circle bg-primary bg-opacity-10 rounded me-2">
                                <i class="ri-user-line text-primary"></i>
                            </span>
                            <h6 class="card-title mb-0 text-primary">Informations personnelles</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="id_last_name">Nom</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-user-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="id_last_name" name="nom">
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="id_first_name">Prénom</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-user-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="id_first_name" name="prenom">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coordonnées -->
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="card-header border-0 bg-white pt-3">
                        <div class="d-flex align-items-center">
                            <span class="icon-circle bg-warning bg-opacity-10 rounded me-2">
                                <i class="ri-contacts-line text-warning"></i>
                            </span>
                            <h6 class="card-title mb-0 text-warning">Coordonnées</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="id_email">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-mail-line text-muted"></i></span>
                                    <input type="email" class="form-control border-0 bg-light py-2" id="id_email" name="email">
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="id_telephone">Téléphone</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-phone-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="id_telephone" name="telephone">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Diplôme -->
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="card-header border-0 bg-white pt-3">
                        <div class="d-flex align-items-center">
                            <span class="icon-circle bg-success bg-opacity-10 rounded me-2">
                                <i class="ri-graduation-cap-line text-success"></i>
                            </span>
                            <h6 class="card-title mb-0 text-success">Diplôme</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-12">
                                <label class="form-label fw-medium" for="id_diplome">Diplôme</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-graduation-cap-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="id_diplome" name="diplome">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary px-4 py-2" id="updateInfoFormateurBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer les modifications
                </button>
            </div>
        </div>
    </div>
</div><!-- /.modal -->

<!-- Modal for availability creation -->
<div class="modal fade" id="availabilityModal" tabindex="-1" aria-labelledby="availabilityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-calendar-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="availabilityModalLabel">
              Définir la disponibilité du formateur
            </h5>
            <p class="text-muted small mb-0">Sélectionnez les jours et les plages horaires de disponibilité</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="createAvailabilityForm">
          <input type="hidden" id="formateur_id" name="formateur_id" value="">
          
          <!-- Display existing availability -->
          <div id="existingAvailabilityContainer" class="mb-4">
            <div class="card border-0 shadow-sm">
              <div class="card-header border-0 bg-light pt-3">
                <div class="d-flex align-items-center">
                  <span class="icon-circle bg-success bg-opacity-10 rounded me-2">
                    <i class="ri-calendar-check-line text-success"></i>
                  </span>
                  <h6 class="card-title mb-0 text-success">Disponibilités actuelles</h6>
                </div>
              </div>
              <div class="card-body">
                <div id="existingAvailabilityList">
                  <!-- Existing availability will be loaded here -->
                  <p class="text-center text-muted">Chargement des disponibilités...</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Divider -->
          <div class="border-top my-4"></div>
          
          <!-- Button to add new availability entry -->
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary btn-sm" id="addAvailabilityEntry">
              <i class="ri-add-line me-1"></i>Ajouter une disponibilité
            </button>
          </div>
          
          <!-- Container for multiple availability entries -->
          <div id="availabilityEntriesContainer">
            <!-- First availability entry will be added here dynamically -->
          </div>
          
          <!-- Error message container -->
          <div id="createAvailabilityError" class="alert alert-danger d-none" role="alert">
            <!-- Error messages will appear here -->
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="saveAvailabilityBtn">
          <i class="ri-save-line me-2"></i>Enregistrer les disponibilités
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation pour suppression de disponibilité -->
<div class="modal fade" id="confirmDeleteAvailabilityModal" tabindex="-1" aria-labelledby="confirmDeleteAvailabilityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="confirmDeleteAvailabilityModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer cette disponibilité. Cette action est irréversible.
          </p>
          <div id="availabilityToDeleteInfo" class="mt-3 fw-semibold">
            <!-- Information about the availability to delete will be shown here -->
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteAvailabilityBtn">
          <i class="ri-delete-bin-line me-2"></i>Supprimer
        </button>
      </div>
    </div>
  </div>
</div>


<script>
  // Fix dropdown positioning
  $(document).ready(function () {
    // Ensure table responsive container doesn't hide dropdowns
    $('.table-responsive').css('overflow-x', 'visible');
    
    // Handle dropdown show events
    $(document).on('show.bs.dropdown', function(e) {
      var dropdownMenu = $(e.target).find('.dropdown-menu');
      if (dropdownMenu.length) {
        dropdownMenu.css({
          'z-index': '1050',
          'position': 'absolute'
        });
      }
    });

    // Initialize search functionality
    $('#table-filter').prop('disabled', false);
    $('#table-filter').on('keyup', function() {
      var value = $(this).val().toLowerCase();
      var found = false;
      
      $('#listeItem tr').filter(function() {
        var isVisible = $(this).text().toLowerCase().indexOf(value) > -1;
        $(this).toggle(isVisible);
        if(isVisible) found = true;
      });
      
      // Show/hide the "no results" message
      if(value !== '') {
        if(!found) {
          // Show no results message if it doesn't already exist
          if($('#noResultsMessage').length === 0) {
            $('#listeItem').append(`
              <tr id="noResultsMessage">
                <td colspan="4" class="text-center text-muted py-4">
                  <div class="d-flex flex-column align-items-center justify-content-center">
                    <div class="avatar-sm mb-3">
                      <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                        <i class="ri-search-line"></i>
                      </div>
                    </div>
                    <h5 class="mb-1">Aucun résultat trouvé</h5>
                    <p class="text-muted mb-0">Aucun formateur ne correspond à votre recherche</p>
                  </div>
                </td>
              </tr>
            `);
          } else {
            $('#noResultsMessage').show();
          }
        } else {
          // Hide the no results message if it exists
          $('#noResultsMessage').hide();
        }
      } else {
        // If search is empty, hide the no results message
        $('#noResultsMessage').hide();
      }
    });
    
    // Ensure the input field is always enabled
    $('#table-filter').on('focus', function() {
      $(this).prop('disabled', false);
    });

    // Handle saving formateur
    $(document).on('click', '#saveFormateurBtn', function() {
      // Get form data
      var nom = $('#formateur_nom').val();
      var prenom = $('#formateur_prenom').val();
      var telephone = $('#formateur_telephone').val();
      var email = $('#formateur_email').val();
      var diplome = $('#formateur_diplome').val();
      
      // Basic validation
      if (!nom || !prenom || !telephone || !email || !diplome) {
        $('#createFormateurError').removeClass('d-none').text('Veuillez remplir tous les champs obligatoires.');
        return;
      }

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#createFormateurError').addClass('d-none');

     

      $.ajax({
        url : "{% url 't_formations:create_formateur' %}",
        type : "POST",
        dataType : "JSON",
        data : {
          'nom': nom,
          'prenom': prenom,
          'telephone': telephone,
          'email': email,
          'diplome': diplome,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response) {
          if (response.status === "success") {
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          } else {
            // Show error message
            $('#createFormateurError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de la création du formateur.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de la création du formateur.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          $('#createFormateurError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#saveFormateurBtn').html(originalBtnText);
          $('#saveFormateurBtn').prop('disabled', false);
        }
      });
    });
 
    // Handle view profile action
    $(document).on('click', '.view-profile', function(e) {
      e.preventDefault();
      var formateurId = $(this).data('formateur-id');
      var formateurNom = $(this).data('formateur-nom');
      var formateurPrenom = $(this).data('formateur-prenom');
      var formateurEmail = $(this).data('formateur-email');
      var formateurTelephone = $(this).data('formateur-telephone');
      var formateurDiplome = $(this).data('formateur-diplome');
      
      // Populate the update modal with formateur data
      $('#id_last_name').val(formateurNom);
      $('#id_first_name').val(formateurPrenom);
      $('#id_email').val(formateurEmail);
      $('#id_telephone').val(formateurTelephone);
      $('#id_diplome').val(formateurDiplome);
      
      // Disable all fields for viewing only
      $('#updateInfoFormateur input, #updateInfoFormateur select').prop('readonly', true);
      $('#updateInfoFormateurBtn').hide(); // Hide the save button
      $('#updateInfoFormateurLabel').text('Profil du formateur'); // Change modal title
      
      // Open the update modal (the one that already exists in the template)
      $('#updateInfoFormateur').modal('show');
    });
    
    // Handle edit profile action
    $(document).on('click', '.edit-profile', function(e) {
      e.preventDefault();
      var formateurId = $(this).data('formateur-id');
      var formateurNom = $(this).data('formateur-nom');
      var formateurPrenom = $(this).data('formateur-prenom');
      var formateurEmail = $(this).data('formateur-email');
      var formateurTelephone = $(this).data('formateur-telephone');
      var formateurDiplome = $(this).data('formateur-diplome');
      
      // Store the formateur ID in a hidden field or data attribute for later use during update
      $('#updateInfoFormateur').data('formateur-id', formateurId);
      
      // Populate the update modal with formateur data
      $('#id_last_name').val(formateurNom);
      $('#id_first_name').val(formateurPrenom);
      $('#id_email').val(formateurEmail);
      $('#id_telephone').val(formateurTelephone);
      $('#id_diplome').val(formateurDiplome);
      
      // Enable all fields for editing
      $('#updateInfoFormateur input, #updateInfoFormateur select').prop('readonly', false);
      $('#updateInfoFormateurBtn').show(); // Show the save button
      $('#updateInfoFormateurLabel').text('Modification des informations'); // Change modal title
      
      // Open the update modal (the one that already exists in the template)
      $('#updateInfoFormateur').modal('show');
    });
    
    // Handle profile update
    $(document).on('click', '#updateInfoFormateurBtn', function() {
      var formateurId = $('#updateInfoFormateur').data('formateur-id');
      var nom = $('#id_last_name').val();
      var prenom = $('#id_first_name').val();
      var email = $('#id_email').val();
      var telephone = $('#id_telephone').val();
      var diplome = $('#id_diplome').val();
      
      // Basic validation
      if (!nom || !prenom || !email || !telephone || !diplome) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return;
      }

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
      $(this).prop('disabled', true);

      $.ajax({
        url : "{% url 't_formations:update_formateur' %}", // Replace with actual update URL
        type : "POST",
        dataType : "JSON",
        data : {
          'id': formateurId,
          'nom': nom,
          'prenom': prenom,
          'email': email,
          'telephone': telephone,
          'diplome': diplome,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response) {
          if (response.status === "success") {
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Mise à jour en cours ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          } else {
            alert(response.message || 'Une erreur est survenue lors de la mise à jour du formateur.');
          }
        },
        error: function(xhr, status, error) {
          alert('Une erreur est survenue lors de la mise à jour du formateur.');
        },
        complete: function() {
          // Reset button state
          $('#updateInfoFormateurBtn').html(originalBtnText);
          $('#updateInfoFormateurBtn').prop('disabled', false);
        }
      });
    });

    // Reset modal when it's closed
    $('#updateInfoFormateur').on('hidden.bs.modal', function () {
      // Re-enable all fields and show save button in case it was in view mode
      $('#updateInfoFormateur input, #updateInfoFormateur select').prop('readonly', false);
      $('#updateInfoFormateurBtn').show();
      $('#updateInfoFormateurLabel').text('Modification des informations'); // Reset modal title
    });

    // Handle availability profile action
    $(document).on('click', '.dispo-profile', function(e) {
      e.preventDefault();
      var formateurId = $(this).data('formateur-id');
      var formateurNom = $(this).data('formateur-nom');
      var formateurPrenom = $(this).data('formateur-prenom');
      var formateurEmail = $(this).data('formateur-email');
      var formateurTelephone = $(this).data('formateur-telephone');
      var formateurDiplome = $(this).data('formateur-diplome');
      
      // Store the formateur ID in the availability modal
      $('#formateur_id').val(formateurId);
      
      // Set the modal title with formateur name
      $('#availabilityModalLabel').html('Définir la disponibilité de <strong>' + formateurNom + ' ' + formateurPrenom + '</strong>');
      
      // Reset the form
      $('#createAvailabilityForm')[0].reset();
      $('#createAvailabilityError').addClass('d-none');
      
      // Load existing availability
      loadExistingAvailability(formateurId);
      
      // Open the availability modal
      $('#availabilityModal').modal('show');
    });
    
    // Function to load existing availability
    function loadExistingAvailability(formateurId) {
      // Show loading message
      $('#existingAvailabilityList').html('<p class="text-center text-muted">Chargement des disponibilités...</p>');
      
      $.ajax({
        url: "{% url 't_formations:get_availability' %}",
        type: "GET",
        dataType: "JSON",
        data: {
          'formateur_id': formateurId
        },
        success: function(response) {
          if (response.status === 'success') {
            displayAvailabilityList(response.disponibilites);
          } else {
            $('#existingAvailabilityList').html('<p class="text-center text-danger">' + (response.message || 'Erreur lors du chargement des disponibilités') + '</p>');
          }
        },
        error: function(xhr, status, error) {
          $('#existingAvailabilityList').html('<p class="text-center text-danger">Erreur lors du chargement des disponibilités</p>');
        }
      });
    }
    
    // Function to display availability list
    function displayAvailabilityList(disponibilites) {
      if (!disponibilites || disponibilites.length === 0) {
        $('#existingAvailabilityList').html('<p class="text-center text-muted">Aucune disponibilité enregistrée</p>');
        return;
      }
      
      let html = '<div class="table-responsive">';
      html += '<table class="table table-sm table-bordered">';
      html += '<thead class="table-light">';
      html += '<tr><th>Jour</th><th>Heure de début</th><th>Heure de fin</th><th>Actions</th></tr>';
      html += '</thead><tbody>';
      
      disponibilites.forEach(function(dispo, index) {
        html += '<tr>';
        html += '<td>' + capitalizeFirstLetter(dispo.jour) + '</td>';
        html += '<td>' + dispo.heure_debut + '</td>';
        html += '<td>' + dispo.heure_fin + '</td>';
        html += '<td class="text-center">';
        html += '<button type="button" class="btn btn-outline-danger btn-sm delete-availability" data-index="' + index + '" data-jour="' + dispo.jour + '" data-heure-debut="' + dispo.heure_debut + '" data-heure-fin="' + dispo.heure_fin + '">';
        html += '<i class="ri-delete-bin-line"></i>';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      $('#existingAvailabilityList').html(html);
    }
    
    // Helper function to capitalize first letter
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Handle saving availability
    $(document).on('click', '#saveAvailabilityBtn', function() {
      // Get form data
      var formateurId = $('#formateur_id').val();
      var jour = $('#jour_disponibilite').val();
      var heureDebut = $('#heure_debut').val();
      var heureFin = $('#heure_fin').val();
      
      // Basic validation
      if (!formateurId || !jour || !heureDebut || !heureFin) {
        $('#createAvailabilityError').removeClass('d-none').text('Veuillez remplir tous les champs obligatoires.');
        return;
      }

      // Validate that end time is after start time
      if (heureDebut >= heureFin) {
        $('#createAvailabilityError').removeClass('d-none').text('L\'heure de fin doit être supérieure à l\'heure de début.');
        return;
      }

      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#createAvailabilityError').addClass('d-none');

      $.ajax({
        url : "{% url 't_formations:create_availability' %}", // You'll need to adjust this URL to match your actual endpoint
        type : "POST",
        dataType : "JSON",
        data : {
          'formateur_id': formateurId,
          'jour': jour,
          'heure_debut': heureDebut,
          'heure_fin': heureFin,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response) {
          if (response.status === "success") {
            let spinner = document.createElement("div");
            spinner.innerHTML = `
                <div id="loadingSpinner" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(3px);">
                    <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                    <div class="success-message" style="
                        font-family: Arial, sans-serif;
                        font-size: 18px;
                        color: #3b7ddd;
                        font-weight: 500;
                        text-align: center;
                        margin-bottom: 10px;">
                        <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Disponibilité enregistrée ...
                    </div>
                    
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .modern-spinner {
                        width: 60px;
                        height: 60px;
                        border: 5px solid #e0e0e0;
                        border-top: 5px solid #3b7ddd;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;
            document.body.appendChild(spinner);
            setTimeout(function() {
                location.reload();
            }, 1000);
          } else {
            // Show error message
            $('#createAvailabilityError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de la création de la disponibilité.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de la création de la disponibilité.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          } else if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMessage = xhr.responseJSON.error;
          }
          $('#createAvailabilityError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#saveAvailabilityBtn').html(originalBtnText);
          $('#saveAvailabilityBtn').prop('disabled', false);
        }
      });
    });

    // Add availability entry functionality
    function addAvailabilityEntry() {
      const entryId = Date.now(); // Unique ID for this entry
      const entryHtml = `
        <div class="availability-entry card border-0 shadow-sm mb-3 overflow-hidden" data-entry-id="${entryId}">
          <div class="card-header border-0 bg-white pt-2 pb-1">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <span class="icon-circle bg-success bg-opacity-10 rounded me-2">
                  <i class="ri-calendar-line text-success"></i>
                </span>
                <h6 class="card-title mb-0 text-success">Disponibilité #${$('#availabilityEntriesContainer .availability-entry').length + 1}</h6>
              </div>
              <button type="button" class="btn btn-outline-danger btn-sm remove-entry" data-entry-id="${entryId}">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
          <div class="card-body pt-2">
            <div class="row g-3">
              <div class="col-lg-4">
                <label class="form-label fw-medium">Jour de la semaine <span class="text-danger">*</span></label>
                <select class="form-select border-0 bg-light py-2 jour_disponibilite" required>
                  <option value="">Sélectionnez un jour</option>
                  <option value="lundi">Lundi</option>
                  <option value="mardi">Mardi</option>
                  <option value="mercredi">Mercredi</option>
                  <option value="jeudi">Jeudi</option>
                  <option value="vendredi">Vendredi</option>
                  <option value="samedi">Samedi</option>
                  <option value="dimanche">Dimanche</option>
                </select>
              </div>
              <div class="col-lg-4">
                <label class="form-label fw-medium heure_debut_label">Heure de début <span class="text-danger">*</span></label>
                <input type="time" class="form-control border-0 bg-light py-2 heure_debut" required>
              </div>
              <div class="col-lg-4">
                <label class="form-label fw-medium heure_fin_label">Heure de fin <span class="text-danger">*</span></label>
                <input type="time" class="form-control border-0 bg-light py-2 heure_fin" required>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#availabilityEntriesContainer').append(entryHtml);
    }

    // Add first availability entry when modal is shown
    $('#availabilityModal').on('shown.bs.modal', function () {
      // Clear existing entries
      $('#availabilityEntriesContainer').empty();
      // Add first entry
      addAvailabilityEntry();
    });
    
    // Add new availability entry
    $(document).on('click', '#addAvailabilityEntry', function() {
      addAvailabilityEntry();
    });
    
    // Remove availability entry
    $(document).on('click', '.remove-entry', function() {
      const entryId = $(this).data('entry-id');
      $(`.availability-entry[data-entry-id="${entryId}"]`).remove();
      
      // Renumber the entries
      $('#availabilityEntriesContainer .availability-entry').each(function(index) {
        $(this).find('h6').text(`Disponibilité #${index + 1}`);
      });
    });
    
    // Handle saving multiple availabilities
    $(document).on('click', '#saveAvailabilityBtn', function() {
      const formateurId = $('#formateur_id').val();
      const entries = $('.availability-entry');
      let hasErrors = false;
      let errorMessage = '';
      
      // Validate each entry
      entries.each(function() {
        const $entry = $(this);
        const jour = $entry.find('.jour_disponibilite').val();
        const heureDebut = $entry.find('.heure_debut').val();
        const heureFin = $entry.find('.heure_fin').val();
        
        // Check if any field is empty
        if (!jour || !heureDebut || !heureFin) {
          hasErrors = true;
          $entry.addClass('border border-danger');
        } else {
          $entry.removeClass('border border-danger');
        }
        
        // Validate that end time is after start time
        if (heureDebut && heureFin && heureDebut >= heureFin) {
          hasErrors = true;
          errorMessage = 'L\'heure de fin doit être supérieure à l\'heure de début.';
          $entry.addClass('border border-danger');
        }
      });
      
      // Show error if validation failed
      if (hasErrors) {
        $('#createAvailabilityError').removeClass('d-none').text(errorMessage || 'Veuillez remplir tous les champs obligatoires.');
        return;
      }
      
      // Show loading state
      var originalBtnText = $(this).html();
      $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...');
      $(this).prop('disabled', true);

      // Hide any previous error messages
      $('#createAvailabilityError').addClass('d-none');

      // Prepare data for all entries
      const availabilityData = [];
      entries.each(function() {
        const $entry = $(this);
        const entryData = {
          formateur_id: formateurId,
          jour: $entry.find('.jour_disponibilite').val(),
          heure_debut: $entry.find('.heure_debut').val(),
          heure_fin: $entry.find('.heure_fin').val(),
        };
        availabilityData.push(entryData);
      });

      // Send all availability entries to the server in a single request
      $.ajax({
        url : "{% url 't_formations:create_availability' %}",
        type : "POST",
        dataType : "JSON",
        data : {
          'formateur_id': formateurId,
          'availabilities': JSON.stringify(availabilityData),
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success : function(response) {
          if (response.status === "success") {
            // Clear the form entries
            $('#availabilityEntriesContainer').empty();
            
            // Show success message temporarily
            let successDiv = $('<div class="alert alert-success" id="saveSuccessMessage">Disponibilités enregistrées avec succès!</div>');
            $('#createAvailabilityForm').prepend(successDiv);
            setTimeout(function() {
              successDiv.fadeOut(function() {
                successDiv.remove();
              });
            }, 3000);
            
            // Refresh the availability list
            loadExistingAvailability(formateurId);
            
            // Add a new empty entry for continued input if desired
            addAvailabilityEntry();
          } else {
            // Show error message
            $('#createAvailabilityError').removeClass('d-none').text(response.message || 'Une erreur est survenue lors de la création des disponibilités.');
          }
        },
        error: function(xhr, status, error) {
          // Show error message
          var errorMessage = 'Une erreur est survenue lors de la création des disponibilités.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          } else if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMessage = xhr.responseJSON.error;
          }
          $('#createAvailabilityError').removeClass('d-none').text(errorMessage);
        },
        complete: function() {
          // Reset button state
          $('#saveAvailabilityBtn').html(originalBtnText);
          $('#saveAvailabilityBtn').prop('disabled', false);
        }
      });
    });

    // Reset availability form when modal is closed
    $('#availabilityModal').on('hidden.bs.modal', function () {
      // Reset the form
      $('#createAvailabilityForm')[0].reset();
      $('#createAvailabilityError').addClass('d-none');
      // Reset the formateur ID
      $('#formateur_id').val('');
      // Clear all availability entries
      $('#availabilityEntriesContainer').empty();
    });

    // Handle click on delete availability button
  $(document).on('click', '.delete-availability', function() {
    var jour = $(this).data('jour');
    var heureDebut = $(this).data('heure-debut');
    var heureFin = $(this).data('heure-fin');
    var index = $(this).data('index');
    
    // Set the availability information in the modal
    $('#availabilityToDeleteInfo').html(
      '<p>Jour: <strong>' + capitalizeFirstLetter(jour) + '</strong></p>' +
      '<p>Heure de début: <strong>' + heureDebut + '</strong></p>' +
      '<p>Heure de fin: <strong>' + heureFin + '</strong></p>'
    );
    
    // Store the index of the availability to delete
    $('#confirmDeleteAvailabilityBtn').data('index', index);
    
    // Show the confirmation modal
    $('#confirmDeleteAvailabilityModal').modal('show');
  });
  
  // Handle confirmation of delete availability
  $(document).on('click', '#confirmDeleteAvailabilityBtn', function() {
    var index = $(this).data('index');
    var formateurId = $('#formateur_id').val();
    
    // Show loading state
    var originalBtnText = $(this).html();
    $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Suppression...');
    $(this).prop('disabled', true);
    
    $.ajax({
      url: "{% url 't_formations:delete_availability' %}",
      type: "POST",
      dataType: "JSON",
      data: {
        'formateur_id': formateurId,
        'availability_index': index,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      success: function(response) {
        if (response.status === 'success') {
          // Close the modal
          $('#confirmDeleteAvailabilityModal').modal('hide');
          
          // Reload the availability list
          loadExistingAvailability(formateurId);
        } else {
          alert(response.message || 'Erreur lors de la suppression de la disponibilité');
        }
      },
      error: function(xhr, status, error) {
        alert('Erreur lors de la suppression de la disponibilité');
      },
      complete: function() {
        // Reset button state
        $('#confirmDeleteAvailabilityBtn').html(originalBtnText);
        $('#confirmDeleteAvailabilityBtn').prop('disabled', false);
      }
    });
  });
  
  // --- PRINT TEACHER TIMETABLE LOGIC ---
  
  function loadPDFLibraries() {
    return new Promise((resolve, reject) => {
      if (window.jspdf) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function generateTeacherTimetablePDF(data, teacherName) {
      await loadPDFLibraries();

      const allDaysSet = new Set();
      data.forEach(p => {
        if (p.jour) {
          const normalizedDay = p.jour.charAt(0).toUpperCase() + p.jour.slice(1).toLowerCase();
          allDaysSet.add(normalizedDay);
        }
      });
      const dayOrder = ['Samedi', 'Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
      const days = dayOrder.filter(d => Array.from(allDaysSet).includes(d));
      if (days.length === 0) days.push(...Array.from(allDaysSet));

      const timeSlots = [...new Set(data.filter(p => p.heure_debut && p.heure_fin)
        .map(p => p.heure_debut + ' - ' + p.heure_fin))].sort();

      if (days.length === 0 || timeSlots.length === 0) {
          alert("Aucune séance trouvée pour ce formateur dans les emplois du temps en cours.");
          return;
      }

      const doc = new window.jspdf.jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });

      const scheduleMap = {};
      data.forEach(p => {
         if (p.jour && p.heure_debut && p.heure_fin) {
           const normalizedDay = p.jour.charAt(0).toUpperCase() + p.jour.slice(1).toLowerCase();
           const slot = p.heure_debut + ' - ' + p.heure_fin;
           const key = `${normalizedDay}_${slot}`;
           if (!scheduleMap[key]) scheduleMap[key] = [];
           scheduleMap[key].push(p);
         }
      });

      const pageWidth = 297; 
      const pageHeight = 210;
      const leftMargin = 10;
      const topMargin = 10;
      const contentWidth = pageWidth - 20;
      let yPosition = topMargin;

      doc.setFontSize(16);
      doc.setTextColor(40, 40, 40);
      doc.text("Emploi du Temps Global Enseignant", pageWidth/2, yPosition + 5, {align:'center'});
      yPosition += 15;

      doc.setFontSize(12);
      doc.setTextColor(60, 60, 60);
      doc.setFont(undefined, 'bold');
      doc.text("Enseignant: " + teacherName, leftMargin + 5, yPosition);
      yPosition += 10;

      const headerColWidth = 30; 
      const timeColWidth = (contentWidth - headerColWidth) / timeSlots.length;
      const rowHeight = 20; 

      doc.setFillColor(59, 125, 221); 
      doc.rect(leftMargin, yPosition, headerColWidth, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(9);
      doc.text("Jours", leftMargin + headerColWidth/2, yPosition + 6, {align:'center'});

      timeSlots.forEach((slot, idx) => {
          const x = leftMargin + headerColWidth + (idx * timeColWidth);
          doc.setFillColor(59, 125, 221); 
          doc.rect(x, yPosition, timeColWidth, 10, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(8);
          doc.text(slot, x + timeColWidth/2, yPosition + 6, {align:'center'});
      });

      yPosition += 10;
      doc.setTextColor(0, 0, 0);

      days.forEach((day, rIdx) => {
          const rowY = yPosition;
          doc.setFillColor(245, 245, 245); 
          doc.rect(leftMargin, rowY, headerColWidth, rowHeight, 'F');
          doc.setFont(undefined, 'bold');
          doc.setFontSize(9);
          doc.setTextColor(50, 50, 50);
          doc.text(day, leftMargin + headerColWidth/2, rowY + rowHeight/2, {align:'center'});

          timeSlots.forEach((slot, cIdx) => {
              const x = leftMargin + headerColWidth + (cIdx * timeColWidth);
              const key = `${day}_${slot}`;
              const sessions = scheduleMap[key]; // This is now an array

              doc.setDrawColor(200, 200, 200);
              doc.rect(x, rowY, timeColWidth, rowHeight); 

              if (sessions && sessions.length > 0) {
                  sessions.forEach((session, sIdx) => {
                      const sessionHeight = rowHeight / sessions.length;
                      const sessionRowY = rowY + (sIdx * sessionHeight);

                      const module = session.cours__label || session.cours__code;
                      const room = session.salle__nom || "";

                      doc.setTextColor(0, 0, 0);
                      doc.setFontSize(sessions.length > 1 ? 6 : 7);
                      doc.setFont(undefined, 'bold');
                      const modText = doc.splitTextToSize(module, timeColWidth - 4);
                      doc.text(modText, x + 2, sessionRowY + (sessions.length > 1 ? 3 : 5));

                      doc.setFont(undefined, 'italic');
                      doc.setTextColor(100, 100, 100);
                      doc.setFontSize(sessions.length > 1 ? 5 : 6);
                      doc.text(room, x + timeColWidth - 2, sessionRowY + (sessions.length > 1 ? sessionHeight - 2 : 17), {align:'right'});
                      
                      if (sIdx < sessions.length - 1) {
                          doc.setDrawColor(230, 230, 230);
                          doc.line(x + 2, sessionRowY + sessionHeight, x + timeColWidth - 2, sessionRowY + sessionHeight);
                      }
                  });
              }
          });
          yPosition += rowHeight;
      });
      
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(`Généré le ${new Date().toLocaleDateString()}`, leftMargin, pageHeight - 5);

      doc.save(`Emploi_Global_${teacherName.replace(/\s+/g, '_')}.pdf`);
  }

  $(document).on('click', '.print-global-timetable', function(e) {
      e.preventDefault();
      var btn = $(this);
      var teacherId = btn.data('formateur-id');
      var teacherName = btn.data('formateur-nom') + ' ' + btn.data('formateur-prenom');
      
      var icon = btn.find('i');
      var originalClass = icon.attr('class');
      icon.attr('class', 'fas fa-spinner fa-spin me-2');
      
      $.ajax({
          url: "{% url 't_timetable:ApiLoadTeacherGlobalTimetable' %}",
          type: "GET",
          data: { 'teacher_id': teacherId },
          success: function(data) {
              generateTeacherTimetablePDF(data, teacherName);
          },
          error: function() {
              alert("Erreur lors de la récupération de l'emploi du temps.");
          },
          complete: function() {
              icon.attr('class', originalClass);
          }
      });
  });

  });
</script>

{% endblock content %}