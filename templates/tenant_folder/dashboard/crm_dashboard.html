{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Tableau de bord Institut {% endblock title %}
{% block content %}
<!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0">Tableau de bord CRM</h4>

                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="javascript: void(0);">CRM</a></li>
                                        <li class="breadcrumb-item active">Tableau de bord</li>
                                    </ol>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- end page title -->
                   
                    <!-- KPIs Section -->
                    <div class="row">
                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Total Prospects</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-success fs-14 mb-0">
                                                <i class="ri-arrow-up-line fs-13 align-middle"></i> +16.24 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_prospects }}">0</span></h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-primary-subtle rounded fs-3">
                                                <i class="ri-group-line text-primary"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Nouveaux cette semaine</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-success fs-14 mb-0">
                                                <i class="ri-arrow-up-line fs-13 align-middle"></i> +22.57 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ new_prospects_this_week }}">0</span></h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-warning-subtle rounded fs-3">
                                                <i class="ri-user-add-line text-warning"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Rappels en attente</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-danger fs-14 mb-0">
                                                <i class="ri-arrow-down-line fs-13 align-middle"></i> -0.57 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ pending_reminders }}">0</span></h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-success-subtle rounded fs-3">
                                                <i class="ri-calendar-line text-success"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Conversion</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-success fs-14 mb-0">
                                                <i class="ri-arrow-up-line fs-13 align-middle"></i> +2.57 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4">{{ conversion_rate }}%</h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-info-subtle rounded fs-3">
                                                <i class="ri-bar-chart-line text-info"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div> <!-- end row -->

                    <!-- Compteur de visites et appels -->
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Suivi des Activités</h4>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-soft-info btn-sm" id="refresh-counters">
                                            <i class="ri-refresh-line align-middle"></i> Actualiser
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded text-center">
                                                <h5 class="mb-0 text-primary">
                                                    <i class="ri-calendar-line align-middle me-1"></i>
                                                    <span id="current-date-display">Date du jour</span>
                                                </h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                                                <div>
                                                    <h5 class="mb-1">Visites</h5>
                                                    <p class="text-muted mb-0">Nombre de visites reçues aujourd'hui</p>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="mb-2" id="visit-counter">0</h3>
                                                    <button type="button" class="btn btn-primary" id="increment-visits">
                                                        <i class="ri-add-line align-middle"></i> 1
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                                                <div>
                                                    <h5 class="mb-1">Appels Téléphoniques</h5>
                                                    <p class="text-muted mb-0">Nombre d'appels reçus aujourd'hui</p>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="mb-2" id="call-counter">0</h3>
                                                    <button type="button" class="btn btn-success" id="increment-calls">
                                                        <i class="ri-add-line align-middle"></i> 1
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end row -->

                    <!-- Répartition des prospects par statut -->
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition des Prospects par Statut</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end card header -->

                                <div class="card-body">
                                    <!-- Debug: Afficher les données pour vérifier leur présence -->
                                    <!--
                                    <p>Debug - Total prospects: {{ total_prospects }}</p>
                                    <p>Debug - Prospects by status: {{ prospects_by_status }}</p>
                                    -->
                                    
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Statut</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">Pourcentage</th>
                                                    <th scope="col">Barre de progression</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for status_data in prospects_by_status %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-0">{{ status_data.label|default:status_data.status }}</h6>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ status_data.count|default:0 }}</td>
                                                    <td>
                                                        {% if total_prospects and total_prospects > 0 %}
                                                            {% widthratio status_data.count total_prospects 100 %}% 
                                                        {% else %}
                                                            0%
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="progress" style="height: 6px;">
                                                            {% if total_prospects and total_prospects > 0 %}
                                                                {% widthratio status_data.count total_prospects 100 as percentage %}
                                                                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ percentage }}%" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                            {% else %}
                                                                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr><!-- end -->
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">Aucune donnée disponible</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody><!-- end tbody -->
                                        </table><!-- end table -->
                                    </div><!-- end -->
                                </div><!-- end cardbody -->
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div><!-- end row -->

                    <div class="row">
                        <!-- Derniers rappels -->
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Derniers Rappels & Rendez-vous</h4>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-soft-primary btn-sm">
                                            + Nouveau
                                        </button>
                                    </div>
                                </div><!-- end card header -->

                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Prospect</th>
                                                    <th scope="col">Objet</th>
                                                    <th scope="col">Date</th>
                                                    <th scope="col">Statut</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for reminder in recent_reminders %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                {% if reminder.prospect.photo %}
                                                                    <img src="{{ reminder.prospect.photo.url }}" alt="" class="avatar-xs rounded-circle">
                                                                {% else %}
                                                                    <div class="avatar-xs rounded-circle bg-primary-subtle text-primary d-flex align-items-center justify-content-center">
                                                                        <i class="ri-user-line"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0">{{ reminder.prospect.nom }} {{ reminder.prospect.prenom }}</h6>
                                                                <p class="text-muted mb-0">{{ reminder.prospect.email|default:"N/A" }}</p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ reminder.object|default:"N/A" }}</td>
                                                    <td>
                                                        {% if reminder.date_rendez_vous %}
                                                            {{ reminder.date_rendez_vous|date:"d M Y" }} 
                                                            {% if reminder.heure_rendez_vous %}
                                                                <small class="text-muted">{{ reminder.heure_rendez_vous|time:"H:i" }}</small>
                                                            {% endif %}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if reminder.statut == 'en_attente' %}
                                                            <span class="badge bg-warning">En attente</span>
                                                        {% elif reminder.statut == 'confirme' %}
                                                            <span class="badge bg-success">Confirmé</span>
                                                        {% elif reminder.statut == 'annule' %}
                                                            <span class="badge bg-danger">Annulé</span>
                                                        {% elif reminder.statut == 'termine' %}
                                                            <span class="badge bg-info">Terminé</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{{ reminder.get_statut_display }}</span>
                                                        {% endif %}
                                                    </td>
                                                </tr><!-- end -->
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">Aucun rappel trouvé</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody><!-- end tbody -->
                                        </table><!-- end table -->
                                    </div><!-- end -->
                                    
                                    <div class="mt-3 text-center">
                                        <a href="javascript:void(0);" class="text-muted text-decoration-underline">Voir tous les rappels</a>
                                    </div>
                                </div><!-- end cardbody -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <!-- Répartition des prospects par canal -->
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition des Prospects par Canal</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                                <a class="dropdown-item" href="#">Taux de conversion</a>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end card header -->

                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Canal</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">Taux de conversion</th>
                                                    <th scope="col">Tendance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for channel_data in channel_conversion_data %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                <div class="avatar-xs">
                                                                    {% if channel_data.canal == 'facebook' %}
                                                                        <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-6">
                                                                            <i class="ri-facebook-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'email' %}
                                                                        <span class="avatar-title bg-info-subtle text-info rounded-circle fs-6">
                                                                            <i class="ri-mail-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'telephone' %}
                                                                        <span class="avatar-title bg-danger-subtle text-danger rounded-circle fs-6">
                                                                            <i class="ri-phone-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'site' %}
                                                                        <span class="avatar-title bg-success-subtle text-success rounded-circle fs-6">
                                                                            <i class="ri-global-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'bouche-a-oreille' %}
                                                                        <span class="avatar-title bg-warning-subtle text-warning rounded-circle fs-6">
                                                                            <i class="ri-user-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'instagram' %}
                                                                        <span class="avatar-title bg-danger-subtle text-danger rounded-circle fs-6">
                                                                            <i class="ri-instagram-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'linkedin' %}
                                                                        <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-6">
                                                                            <i class="ri-linkedin-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'tiktok' %}
                                                                        <span class="avatar-title bg-dark-subtle text-dark rounded-circle fs-6">
                                                                            <i class="ri-tiktok-line"></i>
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="avatar-title bg-secondary-subtle text-secondary rounded-circle fs-6">
                                                                            <i class="ri-question-line"></i>
                                                                        </span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0">
                                                                    {% if channel_data.canal %}
                                                                        {{ channel_data.canal|title }}
                                                                    {% else %}
                                                                        Non spécifié
                                                                    {% endif %}
                                                                </h6>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ channel_data.count }}</td>
                                                    <td>{{ channel_data.conversion_rate }}%</td>
                                                    <td>
                                                        {% if channel_data.conversion_rate > 25 %}
                                                            <span class="text-success"><i class="ri-arrow-up-line"></i> {{ channel_data.conversion_rate|floatformat:1 }}%</span>
                                                        {% elif channel_data.conversion_rate > 15 %}
                                                            <span class="text-warning"><i class="ri-arrow-right-line"></i> {{ channel_data.conversion_rate|floatformat:1 }}%</span>
                                                        {% else %}
                                                            <span class="text-danger"><i class="ri-arrow-down-line"></i> {{ channel_data.conversion_rate|floatformat:1 }}%</span>
                                                        {% endif %}
                                                    </td>
                                                </tr><!-- end -->
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">Aucune donnée disponible</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody><!-- end tbody -->
                                        </table><!-- end table -->
                                    </div><!-- end -->
                                </div><!-- end cardbody -->
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div><!-- end row -->

                    <div class="row">
                        <!-- Upcoming Formations Section -->
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Prochaines formations</h4>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-soft-primary btn-sm">
                                            Voir tout
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex mb-3">
                                                <div class="flex-grow-1">
                                                    <p class="text-truncate text-muted fs-14 mb-0"><i class="mdi mdi-circle align-middle text-primary me-2"></i>Développement Web Full Stack
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <p class="mb-0">15 Sept 2023</p>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex mb-3">
                                                <div class="flex-grow-1">
                                                    <p class="text-truncate text-muted fs-14 mb-0"><i class="mdi mdi-circle align-middle text-info me-2"></i>Marketing Digital
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <p class="mb-0">20 Sept 2023</p>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex">
                                                <div class="flex-grow-1">
                                                    <p class="text-truncate text-muted fs-14 mb-0"><i class="mdi mdi-circle align-middle text-success me-2"></i>Data Science avec Python
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <p class="mb-0">25 Sept 2023</p>
                                                </div>
                                            </div>
                                        </div><!-- end col -->
                                        
                                        <div class="col-md-6">
                                            <div class="d-flex mb-3">
                                                <div class="flex-grow-1">
                                                    <p class="text-truncate text-muted fs-14 mb-0"><i class="mdi mdi-circle align-middle text-warning me-2"></i>Design UX/UI
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <p class="mb-0">01 Oct 2023</p>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex mb-3">
                                                <div class="flex-grow-1">
                                                    <p class="text-truncate text-muted fs-14 mb-0"><i class="mdi mdi-circle align-middle text-danger me-2"></i>Intelligence Artificielle
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <p class="mb-0">10 Oct 2023</p>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex">
                                                <div class="flex-grow-1">
                                                    <p class="text-truncate text-muted fs-14 mb-0"><i class="mdi mdi-circle align-middle text-primary me-2"></i>Cybersécurité
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <p class="mb-0">15 Oct 2023</p>
                                                </div>
                                            </div>
                                        </div><!-- end col -->
                                    </div><!-- end row -->

                                    <div class="mt-2 text-center">
                                        <a href="javascript:void(0);" class="text-muted text-decoration-underline">Voir toutes les formations</a>
                                    </div>

                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <!-- Formation Distribution Chart -->
                        <div class="col-xl-6">
                            <div class="card card-height-100">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition par formation</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Popularité<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Popularité</a>
                                                <a class="dropdown-item" href="#">Nombre d'étudiants</a>
                                                <a class="dropdown-item" href="#">Taux de réussite</a>
                                                <a class="dropdown-item" href="#">Durée</a>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end card header -->
                                <div class="card-body p-0">
                                    <div>
                                        <div id="formation_distribution_chart" data-colors='["--vz-success", "--vz-info"]' class="apex-charts"></div>
                                    </div>
                                </div><!-- end cardbody -->
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div><!-- end row -->
            
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <script>document.write(new Date().getFullYear())</script> © Velzon.
                        </div>
                        <div class="col-sm-6">
                            <div class="text-sm-end d-none d-sm-block">
                                Design & Develop by Themesbrand
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
        <!-- end main content-->

        <script>
            // Fonction pour formater la date en français
            function formatDateToFrench(date) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const frenchDate = date.toLocaleDateString('fr-FR', options);
                // Mettre la première lettre en majuscule
                return frenchDate.charAt(0).toUpperCase() + frenchDate.slice(1);
            }

            // Fonction pour obtenir la date d'aujourd'hui au format YYYY-MM-DD
            function getTodayString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            
            function sendIncrementRequest(type) {
                $.ajax({
                    url : "{% url 't_crm:increment_crm_counter' %}",
                    type: 'POST',
                    dataType : 'JSON',
                    data : {
                        'type' : type,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response){
                        if (response.status === "success"){
                              loadCounters();
                        }
                     
                    }
                })
            }

            // Fonction pour charger les compteurs depuis la base de données
            function loadCounters() {
                $.ajax({
                    url : '{% url "t_crm:get_crm_counters" %}',
                    dataType: "JSON",
                    type : 'GET',
                    success : function(data){
                        $('#visit-counter').text(data[0].visite_counter);

                        $('#call-counter').text(data[0].phone_counter);
                    }
                })

            }

            // Fonction pour obtenir le cookie CSRF (nécessaire pour Django)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Afficher la date du jour
            document.addEventListener('DOMContentLoaded', function() {
                const today = new Date();
                const formattedDate = formatDateToFrench(today);
                document.getElementById('current-date-display').textContent = formattedDate;
                
                // Charger les compteurs depuis la base de données
                loadCounters();
                
                // Bouton d'incrémentation pour les visites
                document.getElementById('increment-visits').addEventListener('click', function() {
                    sendIncrementRequest('visit');
                });
                
                // Bouton d'incrémentation pour les appels
                document.getElementById('increment-calls').addEventListener('click', function() {
                    sendIncrementRequest('call');
                });
                
                // Bouton d'actualisation
                document.getElementById('refresh-counters').addEventListener('click', function() {
                    // Mettre à jour la date au cas où la page reste ouverte plusieurs jours
                    const today = new Date();
                    const formattedDate = formatDateToFrench(today);
                    document.getElementById('current-date-display').textContent = formattedDate;
                    
                    // Recharger les compteurs depuis la base de données
                    loadCounters();
                });
            });
        </script>
{% endblock content %}