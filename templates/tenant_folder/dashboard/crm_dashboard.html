{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Tableau de bord Institut {% endblock title %}
{% block content %}
<!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0">Tableau de bord CRM</h4>

                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="javascript: void(0);">CRM</a></li>
                                        <li class="breadcrumb-item active">Tableau de bord</li>
                                    </ol>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- end page title -->
                    
                    <!-- Overview Row - KPIs -->
                    <div class="row">
                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Total Prospects</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-success fs-14 mb-0">
                                                <i class="ri-arrow-up-line fs-13 align-middle"></i> +16.24 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_prospects }}">0</span></h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-primary-subtle rounded fs-3">
                                                <i class="ri-group-line text-primary"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Nouveaux cette semaine</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-success fs-14 mb-0">
                                                <i class="ri-arrow-up-line fs-13 align-middle"></i> +22.57 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ new_prospects_this_week }}">0</span></h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-warning-subtle rounded fs-3">
                                                <i class="ri-user-add-line text-warning"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Rappels en attente</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-danger fs-14 mb-0">
                                                <i class="ri-arrow-down-line fs-13 align-middle"></i> -0.57 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ pending_reminders }}">0</span></h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-success-subtle rounded fs-3">
                                                <i class="ri-calendar-line text-success"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->

                        <div class="col-xl-3 col-md-6">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 overflow-hidden">
                                            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Conversion</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <h5 class="text-success fs-14 mb-0">
                                                <i class="ri-arrow-up-line fs-13 align-middle"></i> +2.57 %
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-4">
                                        <div>
                                            <h4 class="fs-22 fw-semibold ff-secondary mb-4">{{ conversion_rate }}%</h4>
                                            <a href="{% url 't_crm:ListeDesProspects' %}" class="text-decoration-underline">Voir détails</a>
                                        </div>
                                        <div class="avatar-sm flex-shrink-0">
                                            <span class="avatar-title bg-info-subtle rounded fs-3">
                                                <i class="ri-bar-chart-line text-info"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div> <!-- end row -->

                    <!-- Main Content Row - Combined Activity and Reminders Section -->
                    <div class="row">
                        <!-- Combined Activity Tracking and Recent Reminders -->
                        <div class="col-xl-8">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Suivi des Activités et Rappels</h4>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-soft-info btn-sm" id="refresh-counters">
                                            <i class="ri-refresh-line align-middle"></i> Actualiser
                                        </button>
                                        <button type="button" class="btn btn-soft-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#activityHistoryModal">
                                            <i class="ri-history-line align-middle"></i> Historique
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded text-center">
                                                <h5 class="mb-0 text-primary">
                                                    <i class="ri-calendar-line align-middle me-1"></i>
                                                    <span id="current-date-display">Date du jour</span>
                                                </h5>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Activity Counters -->
                                    <div class="row g-4 mb-4">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center justify-content-between p-4 bg-light rounded-2 shadow-sm">
                                                <div>
                                                    <h5 class="mb-2 text-primary">Visites</h5>
                                                    <p class="text-muted mb-0 font-size-14">Nombre de visites reçues aujourd'hui</p>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="mb-2 font-size-24 fw-bold" id="visit-counter">0</h3>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" id="increment-visits">
                                                        <i class="ri-add-line align-middle"></i> Ajouter
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center justify-content-between p-4 bg-light rounded-2 shadow-sm">
                                                <div>
                                                    <h5 class="mb-2 text-success">Appels Téléphoniques</h5>
                                                    <p class="text-muted mb-0 font-size-14">Nombre d'appels reçus aujourd'hui</p>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="mb-2 font-size-24 fw-bold" id="call-counter">0</h3>
                                                    <button type="button" class="btn btn-outline-success btn-sm" id="increment-calls">
                                                        <i class="ri-add-line align-middle"></i> Ajouter
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Recent Reminders Section -->
                                    <div class="table-responsive table-card mt-4">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Prospect</th>
                                                    <th scope="col">Objet</th>
                                                    <th scope="col">Date</th>
                                                    <th scope="col">Statut</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for reminder in recent_reminders %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                {% if reminder.prospect.photo %}
                                                                    <img src="{{ reminder.prospect.photo.url }}" alt="" class="avatar-xs rounded-circle">
                                                                {% else %}
                                                                    <div class="avatar-xs rounded-circle bg-primary-subtle text-primary d-flex align-items-center justify-content-center">
                                                                        <i class="ri-user-line"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0">{{ reminder.prospect.nom }} {{ reminder.prospect.prenom }}</h6>
                                                                <p class="text-muted mb-0">{{ reminder.prospect.email|default:"N/A" }}</p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ reminder.object|default:"N/A" }}</td>
                                                    <td>
                                                        {% if reminder.date_rendez_vous %}
                                                            {{ reminder.date_rendez_vous|date:"d M Y" }}
                                                            {% if reminder.heure_rendez_vous %}
                                                                <small class="text-muted">{{ reminder.heure_rendez_vous|time:"H:i" }}</small>
                                                            {% endif %}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if reminder.statut == 'en_attente' %}
                                                            <span class="badge bg-warning">En attente</span>
                                                        {% elif reminder.statut == 'confirme' %}
                                                            <span class="badge bg-success">Confirmé</span>
                                                        {% elif reminder.statut == 'annule' %}
                                                            <span class="badge bg-danger">Annulé</span>
                                                        {% elif reminder.statut == 'termine' %}
                                                            <span class="badge bg-info">Terminé</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{{ reminder.get_statut_display }}</span>
                                                        {% endif %}
                                                    </td>
                                                </tr><!-- end -->
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">Aucun rappel trouvé</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div class="mt-3 text-center">
                                        <a href="javascript:void(0);" class="text-muted text-decoration-underline">Voir tous les rappels</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Segmentation Charts -->
                        <div class="col-xl-4">
                            <!-- Répartition des prospects par statut -->
                            <div class="card mb-4">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition par Statut</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Statut</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">%</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for status_data in prospects_by_status %}
                                                <tr>
                                                    <td>
                                                        <h6 class="mb-0">{{ status_data.label|default:status_data.status }}</h6>
                                                    </td>
                                                    <td>{{ status_data.count|default:0 }}</td>
                                                    <td>
                                                        {% if total_prospects and total_prospects > 0 %}
                                                            {% widthratio status_data.count total_prospects 100 %}%
                                                        {% else %}
                                                            0%
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="3" class="text-center">Aucune donnée</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Répartition des prospects par canal -->
                            <div class="card mb-4">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition par Canal</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                                <a class="dropdown-item" href="#">Taux de conversion</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Canal</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">Conv.%</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for channel_data in channel_conversion_data %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                <div class="avatar-xs">
                                                                    {% if channel_data.canal == 'facebook' %}
                                                                        <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-6">
                                                                            <i class="ri-facebook-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'email' %}
                                                                        <span class="avatar-title bg-info-subtle text-info rounded-circle fs-6">
                                                                            <i class="ri-mail-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'telephone' %}
                                                                        <span class="avatar-title bg-danger-subtle text-danger rounded-circle fs-6">
                                                                            <i class="ri-phone-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'site' %}
                                                                        <span class="avatar-title bg-success-subtle text-success rounded-circle fs-6">
                                                                            <i class="ri-global-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'bouche-a-oreille' %}
                                                                        <span class="avatar-title bg-warning-subtle text-warning rounded-circle fs-6">
                                                                            <i class="ri-user-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'instagram' %}
                                                                        <span class="avatar-title bg-danger-subtle text-danger rounded-circle fs-6">
                                                                            <i class="ri-instagram-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'linkedin' %}
                                                                        <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-6">
                                                                            <i class="ri-linkedin-line"></i>
                                                                        </span>
                                                                    {% elif channel_data.canal == 'tiktok' %}
                                                                        <span class="avatar-title bg-dark-subtle text-dark rounded-circle fs-6">
                                                                            <i class="ri-tiktok-line"></i>
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="avatar-title bg-secondary-subtle text-secondary rounded-circle fs-6">
                                                                            <i class="ri-question-line"></i>
                                                                        </span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0">
                                                                    {% if channel_data.canal %}
                                                                        {{ channel_data.canal|title }}
                                                                    {% else %}
                                                                        Non spécifié
                                                                    {% endif %}
                                                                </h6>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ channel_data.count }}</td>
                                                    <td>{{ channel_data.conversion_rate }}%</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="3" class="text-center">Aucune donnée</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Répartition des prospects par source -->
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition par Source</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Source</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">%</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for source_data in lead_source_data %}
                                                <tr>
                                                    <td>
                                                        <h6 class="mb-0">{{ source_data.label|default:source_data.source }}</h6>
                                                    </td>
                                                    <td>{{ source_data.count|default:0 }}</td>
                                                    <td>
                                                        {% if total_prospects and total_prospects > 0 %}
                                                            {% widthratio source_data.count total_prospects 100 %}%
                                                        {% else %}
                                                            0%
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="3" class="text-center">Aucune donnée</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Section - Prospects Distribution -->
                    <div class="row">
                        <!-- Répartition des prospects par spécialité -->
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition par Spécialité</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Spécialité</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">%</th>
                                                    <th scope="col">Progression</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for speciality_data in prospects_by_speciality %}
                                                <tr>
                                                    <td>
                                                        <h6 class="mb-0">{{ speciality_data.specialite__label|default:"Non spécifiée" }}</h6>
                                                    </td>
                                                    <td>{{ speciality_data.count|default:0 }}</td>
                                                    <td>
                                                        {% if total_prospects and total_prospects > 0 %}
                                                            {% widthratio speciality_data.count total_prospects 100 %}%
                                                        {% else %}
                                                            0%
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="progress" style="height: 6px;">
                                                            {% if total_prospects and total_prospects > 0 %}
                                                                {% widthratio speciality_data.count total_prospects 100 as percentage %}
                                                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ percentage }}%" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                            {% else %}
                                                                <div class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">Aucune donnée disponible</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Répartition des prospects par promotion -->
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Répartition par Promotion</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Trier par: </span><span class="text-muted">Volume<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#">Volume</a>
                                                <a class="dropdown-item" href="#">Croissance</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                            <thead class="text-muted table-light">
                                                <tr>
                                                    <th scope="col">Promotion</th>
                                                    <th scope="col">Volume</th>
                                                    <th scope="col">%</th>
                                                    <th scope="col">Progression</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for promo_data in prospects_by_promo %}
                                                <tr>
                                                    <td>
                                                        <h6 class="mb-0">{{ promo_data.promo__label|default:"Non spécifiée" }}</h6>
                                                    </td>
                                                    <td>{{ promo_data.count|default:0 }}</td>
                                                    <td>
                                                        {% if total_prospects and total_prospects > 0 %}
                                                            {% widthratio promo_data.count total_prospects 100 %}%
                                                        {% else %}
                                                            0%
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="progress" style="height: 6px;">
                                                            {% if total_prospects and total_prospects > 0 %}
                                                                {% widthratio promo_data.count total_prospects 100 as percentage %}
                                                                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ percentage }}%" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                            {% else %}
                                                                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">Aucune donnée disponible</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <script>document.write(new Date().getFullYear())</script> © Velzon.
                        </div>
                        <div class="col-sm-6">
                            <div class="text-sm-end d-none d-sm-block">
                                Design & Develop by Themesbrand
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
        <!-- end main content-->

        <script>
            // Fonction pour formater la date en français
            function formatDateToFrench(date) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const frenchDate = date.toLocaleDateString('fr-FR', options);
                // Mettre la première lettre en majuscule
                return frenchDate.charAt(0).toUpperCase() + frenchDate.slice(1);
            }

            // Fonction pour obtenir la date d'aujourd'hui au format YYYY-MM-DD
            function getTodayString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            
            function sendIncrementRequest(type) {
                $.ajax({
                    url : "{% url 't_crm:increment_crm_counter' %}",
                    type: 'POST',
                    dataType : 'JSON',
                    data : {
                        'type' : type,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response){
                        if (response.status === "success"){
                              loadCounters();
                        }
                     
                    }
                })
            }

            // Fonction pour charger les compteurs depuis la base de données
            function loadCounters() {
                $.ajax({
                    url : '{% url "t_crm:get_crm_counters" %}',
                    dataType: "JSON",
                    type : 'GET',
                    success : function(data){
                        $('#visit-counter').text(data[0].visite_counter);

                        $('#call-counter').text(data[0].phone_counter);
                    }
                })

            }

            // Fonction pour obtenir le cookie CSRF (nécessaire pour Django)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Afficher la date du jour
            document.addEventListener('DOMContentLoaded', function() {
                const today = new Date();
                const formattedDate = formatDateToFrench(today);
                document.getElementById('current-date-display').textContent = formattedDate;
                
                // Charger les compteurs depuis la base de données
                loadCounters();
                
                // Bouton d'incrémentation pour les visites
                document.getElementById('increment-visites').addEventListener('click', function() {
                    sendIncrementRequest('visit');
                });
                
                // Bouton d'incrémentation pour les appels
                document.getElementById('increment-calls').addEventListener('click', function() {
                    sendIncrementRequest('call');
                });
                
                // Bouton d'actualisation
                document.getElementById('refresh-counters').addEventListener('click', function() {
                    // Mettre à jour la date au cas où la page reste ouverte plusieurs jours
                    const today = new Date();
                    const formattedDate = formatDateToFrench(today);
                    document.getElementById('current-date-display').textContent = formattedDate;
                    
                    // Recharger les compteurs depuis la base de données
                    loadCounters();
                });
                
                // Chargement de l'historique des activités lorsque le modal s'ouvre
                document.getElementById('activityHistoryModal').addEventListener('show.bs.modal', function () {
                    loadActivityHistory();
                });
                
                // Initialiser les fonctionnalités de tri et de filtrage
                initSorting();
                initFilters();
            });
            
            // Variables pour la pagination
            let currentData = [];
            let filteredData = [];
            let currentPage = 1;
            const itemsPerPage = 10;

            // Fonction pour charger l'historique des activités
            function loadActivityHistory() {
                $.ajax({
                    url: "{% url 't_crm:get_activity_history' %}",
                    type: 'GET',
                    dataType: 'JSON',
                    success: function(data) {
                        currentData = [];
                        
                        if (data.length > 0) {
                            data.forEach(item => {
                                // Formater la date en français
                                const dateObj = new Date(item.date);
                                const formattedDate = dateObj.toLocaleDateString('fr-FR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                });
                                
                                // Ajouter une entrée pour les visites
                                if (item.visits !== undefined) {
                                    currentData.push({
                                        date: item.date,
                                        formattedDate: formattedDate,
                                        type: 'Visites',
                                        count: item.visits,
                                        user: item.user
                                    });
                                }
                                
                                // Ajouter une entrée pour les appels
                                if (item.calls !== undefined) {
                                    currentData.push({
                                        date: item.date,
                                        formattedDate: formattedDate,
                                        type: 'Appels Téléphoniques',
                                        count: item.calls,
                                        user: item.user
                                    });
                                }
                            });
                        }
                        
                        // Initialiser les données filtrées
                        filteredData = [...currentData];
                        
                        // Afficher les données
                        displayActivityHistory();
                        
                        // Mettre à jour le total
                        document.getElementById('total-activities').textContent = filteredData.length;
                    },
                    error: function() {
                        document.getElementById('activity-history-body').innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center text-danger">
                                    Erreur lors du chargement de l'historique
                                </td>
                            </tr>
                        `;
                    }
                });
            }

            // Fonction pour afficher l'historique des activités avec pagination
            function displayActivityHistory() {
                // Trier les données avant l'affichage
                sortActivityHistory();

                // Calculer les index de pagination
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageData = filteredData.slice(startIndex, endIndex);

                let tableContent = '';
                        
                if (pageData.length > 0) {
                    pageData.forEach(item => {
                        tableContent += `
                            <tr>
                                <td>${item.formattedDate}</td>
                                <td>${item.type}</td>
                                <td><span class="badge bg-primary">${item.count}</span></td>
                                <td>${item.user}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableContent = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="d-flex flex-column align-items-center justify-content-center">
                                    <i class="ri-history-line ri-2x text-muted mb-2"></i>
                                    <p class="text-muted mb-0">Aucun historique disponible</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                        
                document.getElementById('activity-history-body').innerHTML = tableContent;
                        
                // Mettre à jour la pagination
                updatePagination();
            }

            // Fonction pour trier les données
            function sortActivityHistory() {
                const sortColumn = document.querySelector('.sortable.active');
                if (!sortColumn) return;
                
                const sortKey = sortColumn.dataset.sort;
                const sortOrder = sortColumn.classList.contains('asc') ? 1 : -1;
                
                filteredData.sort((a, b) => {
                    let valA = a[sortKey];
                    let valB = b[sortKey];
                    
                    // Pour les dates, on convertit en timestamp pour le tri
                    if (sortKey === 'date') {
                        valA = new Date(valA).getTime();
                        valB = new Date(valB).getTime();
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    
                    if (valA < valB) return -1 * sortOrder;
                    if (valA > valB) return 1 * sortOrder;
                    return 0;
                });
            }

            // Fonction pour filtrer les données
            function filterActivityHistory() {
                const typeFilter = document.getElementById('activity-type-filter').value;
                const dateFromFilter = document.getElementById('date-from-filter').value;
                const dateToFilter = document.getElementById('date-to-filter').value;
                
                filteredData = currentData.filter(item => {
                    // Filtrer par type d'activité
                    if (typeFilter && item.type !== typeFilter) {
                        return false;
                    }
                    
                    // Filtrer par date de début
                    if (dateFromFilter && new Date(item.date) < new Date(dateFromFilter)) {
                        return false;
                    }
                    
                    // Filtrer par date de fin
                    if (dateToFilter && new Date(item.date) > new Date(dateToFilter)) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Réinitialiser la page courante
                currentPage = 1;
                
                // Mettre à jour le total
                document.getElementById('total-activities').textContent = filteredData.length;
                
                // Afficher les données filtrées
                displayActivityHistory();
            }

            // Fonction pour mettre à jour la pagination
            function updatePagination() {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                const paginationContainer = document.getElementById('pagination-container');
                paginationContainer.innerHTML = '';
                
                if (totalPages <= 1) return;
                
                // Bouton "Précédent"
                const prevButton = document.createElement('li');
                prevButton.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevButton.innerHTML = `<a class="page-link" href="#" aria-label="Previous" onclick="changePage(${currentPage - 1})">Précédent</a>`;
                paginationContainer.appendChild(prevButton);
                
                // Pages
                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('li');
                    pageButton.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    pageButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                    paginationContainer.appendChild(pageButton);
                }
                
                // Bouton "Suivant"
                const nextButton = document.createElement('li');
                nextButton.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextButton.innerHTML = `<a class="page-link" href="#" aria-label="Next" onclick="changePage(${currentPage + 1})">Suivant</a>`;
                paginationContainer.appendChild(nextButton);
            }

            // Fonction pour changer de page
            function changePage(page) {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                if (page < 1 || page > totalPages) return;
                
                currentPage = page;
                displayActivityHistory();
            }

            // Initialiser les événements de tri
            function initSorting() {
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', function() {
                        const currentSort = this.classList.contains('asc') ? 'asc' : 'desc';
                        
                        // Retirer la classe active des autres en-têtes
                        document.querySelectorAll('.sortable').forEach(h => {
                            h.classList.remove('active', 'asc', 'desc');
                        });
                        
                        // Ajouter la classe active à l'en-tête cliqué
                        if (currentSort === 'asc') {
                            this.classList.add('active', 'desc');
                        } else {
                            this.classList.add('active', 'asc');
                        }
                        
                        // Réinitialiser la page courante
                        currentPage = 1;
                        
                        // Afficher les données triées
                        displayActivityHistory();
                    });
                });
            }

            // Initialiser les événements de filtre
            function initFilters() {
                document.getElementById('apply-filters-btn').addEventListener('click', function() {
                    filterActivityHistory();
                });

                // Réinitialiser les champs de filtre
                document.getElementById('activity-type-filter').addEventListener('change', function() {
                    if (this.value === '') filterActivityHistory();
                });
            }
        </script>

        <!-- Modal pour l'historique des activités -->
        <div class="modal fade" id="activityHistoryModal" tabindex="-1" aria-labelledby="activityHistoryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="activityHistoryModalLabel">Historique des Activités</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Filtres et recherche -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label for="activity-type-filter" class="form-label">Type d'activité</label>
                                <select class="form-select" id="activity-type-filter">
                                    <option value="">Tous les types</option>
                                    <option value="Visites">Visites</option>
                                    <option value="Appels Téléphoniques">Appels Téléphoniques</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date-from-filter" class="form-label">Date début</label>
                                <input type="date" class="form-control" id="date-from-filter">
                            </div>
                            <div class="col-md-3">
                                <label for="date-to-filter" class="form-label">Date fin</label>
                                <input type="date" class="form-control" id="date-to-filter">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" id="apply-filters-btn">
                                    <i class="ri-filter-line align-middle me-1"></i> Filtrer
                                </button>
                            </div>
                        </div>

                        <!-- Pagination et tri -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <label class="me-2">Afficher</label>
                                <select class="form-select form-select-sm w-auto" id="items-per-page">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <label class="ms-2">éléments</label>
                            </div>
                            <div class="text-muted">Total: <span id="total-activities">0</span> activités</div>
                        </div>

                        <!-- Tableau d'historique -->
                        <div class="table-responsive table-card">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="sortable" data-sort="date">
                                            Date
                                            <i class="ri-arrow-down-s-line sort-icon ms-1"></i>
                                        </th>
                                        <th class="sortable" data-sort="type">
                                            Type d'activité
                                            <i class="ri-arrow-down-s-line sort-icon ms-1"></i>
                                        </th>
                                        <th class="sortable" data-sort="count">
                                            Nombre
                                            <i class="ri-arrow-down-s-line sort-icon ms-1"></i>
                                        </th>
                                        <th class="sortable" data-sort="user">
                                            Utilisateur
                                            <i class="ri-arrow-down-s-line sort-icon ms-1"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="activity-history-body">
                                    <!-- Les données seront chargées ici via AJAX -->
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <div class="d-flex flex-column align-items-center justify-content-center">
                                                <div class="spinner-border text-primary mb-3" role="status">
                                                    <span class="visually-hidden">Chargement...</span>
                                                </div>
                                                <p class="text-muted mb-0">Chargement de l'historique des activités...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav class="mt-3 d-flex justify-content-center" aria-label="Navigation de pagination">
                            <ul class="pagination" id="pagination-container">
                                <!-- Les boutons de pagination seront générés ici dynamiquement -->
                            </ul>
                        </nav>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

{% endblock content %}