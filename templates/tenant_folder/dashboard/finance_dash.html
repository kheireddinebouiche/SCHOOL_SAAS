{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Tableau de bord financier {% endblock title %}

{% block content %}
<style>
    :root {
        --finance-primary: #4361ee;
        --finance-secondary: #3f37c9;
        --finance-accent: #4895ef;
        --finance-success: #4cc9f0;
        --finance-warning: #f72585;
    }
    
    .finance-card {
        border-radius: 16px;
        border: none;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
    }
    
    .finance-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .card-gradient-1 { background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); color: white; }
    .card-gradient-2 { background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%); color: white; }
    .card-gradient-3 { background: linear-gradient(135deg, #f72585 0%, #b5179e 100%); color: white; }
    .card-gradient-4 { background: linear-gradient(135deg, #480ca8 0%, #560bad 100%); color: white; }
    
    .finance-icon {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    
    .table-modern {
        border-collapse: separate;
        border-spacing: 0 8px;
    }
    
    .table-modern tbody tr {
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        transition: transform 0.2s;
        border-radius: 8px;
    }
    
    .table-modern tbody tr:hover {
        transform: scale(1.005);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .table-modern td {
        border: none;
        padding: 16px 20px;
    }
    
    .table-modern td:first-child {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }
    
    .table-modern td:last-child {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .status-upcoming { background: rgba(67, 97, 238, 0.1); color: #4361ee; }
    .status-today { background: rgba(247, 37, 133, 0.1); color: #f72585; }
    
    .chart-container {
        position: relative;
        height: 350px;
        border-radius: 16px;
        background: white;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.01);
    }

    /* Scrollbar invisible but functional */
    .table-responsive::-webkit-scrollbar {
        height: 6px;
    }
    .table-responsive::-webkit-scrollbar-thumb {
        background: #e9ecef;
        border-radius: 3px;
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid user-select-none">

            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="fs-24 fw-bold text-dark mb-1">Aperçu Financier</h4>
                        <p class="text-muted mb-0">Suivi des paiements, recouvrements et projections</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light shadow-sm"><i class="ri-calendar-line me-2"></i>Ce mois</button>
                        <button class="btn btn-primary shadow-sm"><i class="ri-download-line me-2"></i>Rapport</button>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="row g-4 mb-4">
                <!-- Total Collected -->
                <div class="col-xl-3 col-md-6">
                    <div class="card finance-card card-gradient-1 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <p class="mb-1 opacity-75 fw-medium">Revenus Encaissés</p>
                                    <h3 class="fw-bold mb-0 text-white"><span id="totalPayments">--</span></h3>
                                </div>
                                <div class="finance-icon">
                                    <i class="ri-wallet-3-line fs-24 text-white"></i>
                                </div>
                            </div>
                            <div class="d-flex align-items-center opacity-75">
                                <i class="ri-arrow-up-circle-line me-1"></i>
                                <span class="small">Mis à jour à l'instant</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collection Rate -->
                <div class="col-xl-3 col-md-6">
                    <div class="card finance-card card-gradient-2 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <p class="mb-1 opacity-75 fw-medium">Taux de Recouvrement</p>
                                    <h3 class="fw-bold mb-0 text-white"><span id="collectionRate">--</span></h3>
                                </div>
                                <div class="finance-icon">
                                    <i class="ri-pie-chart-line fs-24 text-white"></i>
                                </div>
                            </div>
                            <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                <div class="progress-bar bg-white" id="collectionProgressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Due Today -->
                <div class="col-xl-3 col-md-6">
                    <div class="card finance-card card-gradient-3 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <p class="mb-1 opacity-75 fw-medium">À Encaisser Aujourd'hui</p>
                                    <h3 class="fw-bold mb-0 text-white"><span id="todayDueAmount">--</span></h3>
                                </div>
                                <div class="finance-icon">
                                    <i class="ri-alarm-warning-line fs-24 text-white"></i>
                                </div>
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="badge bg-white text-danger bg-opacity-25"><span id="todayDueCount">0</span> paiements</span>
                                <a href="#today-section" class="text-white small text-decoration-underline">Voir liste</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overdue -->
                <div class="col-xl-3 col-md-6">
                    <div class="card finance-card card-gradient-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <p class="mb-1 opacity-75 fw-medium">Impayés / Retard</p>
                                    <h3 class="fw-bold mb-0 text-white"><span id="overdueAmount">--</span></h3>
                                </div>
                                <div class="finance-icon">
                                    <i class="ri-error-warning-line fs-24 text-white"></i>
                                </div>
                            </div>
                             <div class="d-flex align-items-center opacity-75">
                                <i class="ri-history-line me-1"></i>
                                <span class="small">Action requise</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts & Analysis -->
            <div class="row mb-5">
                <div class="col-xl-8">
                    <div class="card shadow-none h-100">
                        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold text-dark mb-0">Analyse Mensuelle (Revenus vs Dépenses)</h5>
                            <button class="btn btn-sm btn-soft-primary rounded-pill">Détails <i class="ri-arrow-right-line ms-1"></i></button>
                        </div>
                        <div class="card-body">
                            <div id="revenueChart" style="height: 350px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4">
                    <div class="card shadow-none h-100">
                         <div class="card-header bg-transparent border-0">
                            <h5 class="fw-bold text-dark mb-0">Reste à Recouvrer par Promo</h5>
                        </div>
                        <div class="card-body px-0">
                            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                                <table class="table table-borderless align-middle mb-0">
                                    <thead class="bg-light text-muted">
                                        <tr>
                                            <th class="ps-4">Promo</th>
                                            <th class="text-end pe-4">Reste Dû</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in unpaid_dues_by_promo %}
                                        <tr>
                                            <td class="ps-4 fw-medium">{{ item.promo_label }}</td>
                                            <td class="text-end pe-4 text-danger fw-bold">{{ item.total_amount|floatformat:2|floatformat:"g" }} DA</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="2" class="text-center text-muted py-4">Tout est à jour !</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Situation History -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-none">
                         <div class="card-header bg-transparent border-0">
                            <h5 class="fw-bold text-dark mb-0">Situation Mensuelle des Paiements</h5>
                        </div>
                        <div class="card-body">
                             <div class="table-responsive">
                                <table class="table table-modern w-100">
                                    <thead>
                                        <tr class="text-muted text-uppercase fs-12">
                                            <th style="border:none;">Année</th>
                                            <th style="border:none;">Mois</th>
                                            <th style="border:none;">Nb Transactions</th>
                                            <th style="border:none;">Total Encaissé</th>
                                            <th style="border:none;">Total Dépenses</th>
                                            <th style="border:none;">Résultat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in payment_history %}
                                        <tr>
                                            <td class="fw-medium">{{ row.date|date:"Y" }}</td>
                                            <td class="text-capitalize">{{ row.date|date:"F" }}</td>
                                            <td><span class="badge bg-light text-dark">{{ row.count }}</span></td>
                                            <td class="fw-bold text-success">{{ row.revenue|floatformat:0|floatformat:"g" }} DA</td>
                                            <td class="fw-bold text-danger">{{ row.expense|floatformat:0|floatformat:"g" }} DA</td>
                                            <td>
                                                <span class="badge {% if row.is_positive %}bg-soft-success text-success{% else %}bg-soft-danger text-danger{% endif %} rounded-pill px-3">
                                                    {{ row.result|floatformat:0|floatformat:"g" }} DA
                                                </span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">Aucun historique disponible</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEADLINES LISTS -->
            <div class="row g-4">
                
                <!-- Today's Deadlines -->
                <div class="col-lg-6" id="today-section">
                    <div class="d-flex align-items-center mb-3">
                         <div class="finance-icon bg-danger-subtle text-danger me-3" style="width: 40px; height: 40px;">
                            <i class="ri-calendar-check-line fs-20"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold text-dark mb-0">Échéances du Jour</h5>
                            <small class="text-muted">Paiements attendus aujourd'hui</small>
                        </div>
                         <span class="badge bg-danger ms-auto rounded-pill px-3" id="todayCountBadge">0</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-modern w-100">
                             <thead>
                                <tr class="text-muted text-uppercase fs-12">
                                    <th style="border:none;">Étudiant</th>
                                    <th style="border:none;">Motif</th>
                                    <th style="border:none;">Montant</th>
                                    <th style="border:none;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="dailyPaymentsTableBody">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                        <div id="noDailyPayments" class="text-center py-5 bg-white rounded-3 shadow-sm" style="display:none;">
                            <i class="ri-checkbox-circle-line ri-3x text-success opacity-50 mb-2"></i>
                            <p class="text-muted fw-medium mb-0">Aucun paiement pour aujourd'hui</p>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Deadlines -->
                <div class="col-lg-6">
                    <div class="d-flex align-items-center mb-3">
                        <div class="finance-icon bg-primary-subtle text-primary me-3" style="width: 40px; height: 40px;">
                            <i class="ri-calendar-event-line fs-20"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold text-dark mb-0">Prochaines Échéances</h5>
                            <small class="text-muted">30 prochains jours</small>
                        </div>
                        <a href="#" class="btn btn-sm btn-link ms-auto">Voir tout</a>
                    </div>

                    <div class="table-responsive">
                         <table class="table table-modern w-100">
                             <thead>
                                <tr class="text-muted text-uppercase fs-12">
                                    <th style="border:none;">Date</th>
                                    <th style="border:none;">Étudiant</th>
                                    <th style="border:none;">Montant</th>
                                    <th style="border:none;">Jours restants</th>
                                </tr>
                            </thead>
                            <tbody id="upcomingPaymentsTableBody">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                         <div id="noUpcomingPayments" class="text-center py-5 bg-white rounded-3 shadow-sm" style="display:none;">
                            <i class="ri-calendar-line ri-3x text-muted opacity-50 mb-2"></i>
                            <p class="text-muted fw-medium mb-0">Aucune échéance à venir</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    $(document).ready(function(){
        
        // --- 1. Load Data ---
        function loadKpiData(){
            $.ajax({
                url : "{% url 'institut_app:ApiFinanceKPIs' %}",
                dataType: "JSON",
                type : 'GET',
                success : function(data){
                    
                    // Formatters
                    const dzFormat = new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    
                    // --- KPIs ---
                    $('#totalPayments').text(dzFormat.format(data.total_collected) + ' DA');
                    $('#collectionRate').text(data.collection_rate + '%');
                    $('#collectionProgressBar').css('width', data.collection_rate + '%');
                    
                    $('#overdueAmount').text(dzFormat.format(data.overdue_amount) + ' DA');
                    
                    // --- Today's Deadlines ---
                    const daily = data.echeance_du_jours || [];
                    const todayTotal = daily.reduce((sum, item) => sum + parseFloat(item.montant_due || 0), 0);
                    
                    $('#todayDueAmount').text(dzFormat.format(todayTotal) + ' DA');
                    $('#todayDueCount').text(daily.length);
                    $('#todayCountBadge').text(daily.length);
                    
                    const dailyBody = $('#dailyPaymentsTableBody');
                    dailyBody.empty();
                    
                    if (daily.length > 0) {
                        $('#noDailyPayments').hide();
                        daily.forEach(item => {
                            dailyBody.append(`
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-xs me-2">
                                                <span class="avatar-title rounded-circle bg-primary-subtle text-primary text-uppercase">
                                                    ${item.client__nom.charAt(0)}${item.client__prenom.charAt(0)}
                                                </span>
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fs-14">${item.client__nom} ${item.client__prenom}</h6>
                                                <small class="text-muted">ID: ${item.id}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-light text-dark border">${item.label || 'Échéance'}</span></td>
                                    <td class="fw-bold text-dark">${dzFormat.format(item.montant_due)} DA</td>
                                    <td><button class="btn btn-sm btn-soft-success rounded-pill px-3">Encaisser</button></td>
                                </tr>
                            `);
                        });
                    } else {
                        $('#noDailyPayments').show();
                    }

                    // --- Upcoming Deadlines ---
                    const upcoming = data.liste_echeance_avenir || [];
                    const upcomingBody = $('#upcomingPaymentsTableBody');
                    upcomingBody.empty();

                    if (upcoming.length > 0) {
                        $('#noUpcomingPayments').hide();
                        upcoming.forEach(item => {
                            // Calculate days remaining
                            const today = new Date();
                            const due = new Date(item.date_echeance);
                            const diffTime = Math.abs(due - today);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                            
                            upcomingBody.append(`
                                <tr>
                                    <td><i class="ri-calendar-line text-muted me-1"></i> ${new Date(item.date_echeance).toLocaleDateString()}</td>
                                    <td>
                                        <div class="fw-medium text-dark">${item.client__nom} ${item.client__prenom}</div>
                                        <small class="text-muted">${item.label || ''}</small>
                                    </td>
                                    <td class="fw-bold">${dzFormat.format(item.montant_due)} DA</td>
                                    <td><span class="badge bg-soft-primary text-primary">J-${diffDays}</span></td>
                                </tr>
                            `);
                        });
                    } else {
                        $('#noUpcomingPayments').show();
                    }
                }
            });
        }

        loadKpiData();
        
        // --- 2. Chart Initialization ---
        // (Assuming you passed monthly_stats from view as JSON or loop)
        // For dynamic charts, we'd normally pass data via json_script. 
        // Here I'll mock init with data from context if available, else static for demo structure
        var options = {
          series: [{
            name: 'Revenus',
            data: [{% for stat in monthly_stats %}{{ stat.revenue }},{% endfor %}]
          }, {
            name: 'Dépenses',
            data: [{% for stat in monthly_stats %}{{ stat.expenses }},{% endfor %}]
          }],
          chart: {
            height: 350,
            type: 'area',
            toolbar: { show: false },
            fontFamily: 'inherit'
          },
          dataLabels: { enabled: false },
          stroke: { curve: 'smooth', width: 2 },
          xaxis: {
            categories: [{% for stat in monthly_stats %}'{{ stat.period }}',{% endfor %}]
          },
          colors: ['#4361ee', '#f72585'],
          fill: {
            type: 'gradient',
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.7,
              opacityTo: 0.2,
              stops: [0, 90, 100]
            }
          },
          grid: {
            borderColor: '#f1f1f1',
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return val + " DA"
              }
            }
          }
        };

        // Only render if we have data
        if(document.querySelector("#revenueChart")) {
            var chart = new ApexCharts(document.querySelector("#revenueChart"), options);
            chart.render();
        }

    });
</script>

{% endblock content %}