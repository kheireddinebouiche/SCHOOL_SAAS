{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Tableau de bord Pédagogique {% endblock title %}
{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0 font-size-24">
                            <i class="ri-book-open-line text-primary me-2"></i>
                            Tableau de bord Pédagogique
                        </h4>
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Pédagogie</a></li>
                                <li class="breadcrumb-item active">Tableau de bord</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="card border-bottom border-3 border-primary shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-sm flex-shrink-0 me-3">
                                    <span class="avatar-title bg-primary-subtle text-primary rounded-3 fs-20">
                                        <i class="ri-team-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="text-muted text-uppercase fs-13 mb-0">Total Groupes</h5>
                                    <h2 class="mb-0 fw-bold">{{ total_groups }}</h2>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success-subtle text-success border border-success-subtle p-1">
                                    <i class="ri-checkbox-circle-line align-middle"></i> {{ active_groups }}
                                </span>
                                <span class="text-muted fs-12 ms-2">Actifs ce semestre</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card border-bottom border-3 border-info shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-sm flex-shrink-0 me-3">
                                    <span class="avatar-title bg-info-subtle text-info rounded-3 fs-20">
                                        <i class="ri-user-follow-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="text-muted text-uppercase fs-13 mb-0">Total Étudiants</h5>
                                    <h2 class="mb-0 fw-bold">{{ total_students }}</h2>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="text-muted fs-12">
                                    <i class="ri-information-line text-info me-1"></i> Inscrits dans des groupes
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card border-bottom border-3 border-warning shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-sm flex-shrink-0 me-3">
                                    <span class="avatar-title bg-warning-subtle text-warning rounded-3 fs-20">
                                        <i class="ri-calendar-check-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="text-muted text-uppercase fs-13 mb-0">Emplois du temps</h5>
                                    <h2 class="mb-0 fw-bold">{{ active_timetables }}</h2>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-warning-subtle text-warning border border-warning-subtle p-1">
                                    Validés
                                </span>
                                <span class="text-muted fs-12 ms-2">et en cours</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div class="col-xl-3 col-md-6">
                    <div class="card border-bottom border-3 border-success shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-sm flex-shrink-0 me-3">
                                    <span class="avatar-title bg-success-subtle text-success rounded-3 fs-20">
                                        <i class="ri-time-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="text-muted text-uppercase fs-13 mb-0">Cours aujourd'hui</h5>
                                    <h2 class="mb-0 fw-bold">{{ todays_sessions|length }}</h2>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="text-muted fs-12">
                                    <i class="ri-calendar-2-line text-success me-1"></i> {{ today_label }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row g-4 mb-4">
                <div class="col-xl-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-bottom border-light py-3 px-4">
                            <h5 class="card-title mb-0 flex-grow-1 text-uppercase fs-13 text-muted">
                                <i class="ri-pie-chart-2-fill me-2 text-primary"></i>
                                Répartition des étudiants par spécialité
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="specialityChart" class="apex-charts" dir="ltr"></div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-bottom border-light py-3 px-4">
                            <h5 class="card-title mb-0 flex-grow-1 text-uppercase fs-13 text-muted">
                                <i class="ri-building-4-fill me-2 text-warning"></i>
                                Utilisation des Salles
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="roomChart" class="apex-charts" dir="ltr"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables Section -->
            <div class="row g-4">
                <!-- Today's Classes -->
                <div class="col-xl-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-bottom border-light py-3 px-4 d-flex align-items-center">
                            <h5 class="card-title mb-0 flex-grow-1 text-uppercase fs-13 text-muted">
                                <i class="ri-calendar-event-fill me-2 text-success"></i>
                                Cours de la journée ({{ today_label }})
                            </h5>
                            <a href="#" class="btn btn-sm btn-soft-primary rounded-pill">Voir calendrier</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-nowrap mb-0 align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">Horaire</th>
                                            <th>Cours</th>
                                            <th>Groupe</th>
                                            <th>Salle</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for session in todays_sessions %}
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-soft-primary text-primary">{{ session.heure_debut|time:"H:i" }} - {{ session.heure_fin|time:"H:i" }}</span>
                                            </td>
                                            <td>
                                                <h6 class="mb-0">{{ session.cours.label|default:session.cours }}</h6>
                                                <small class="text-muted">{{ session.formateur.nom|default:"Non assigné" }}</small>
                                            </td>
                                            <td>{{ session.timetable.groupe.nom }}</td>
                                            <td>
                                                <span class="badge bg-soft-info text-info">{{ session.salle.nom }}</span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <div class="empty-state">
                                                    <i class="ri-calendar-check-line ri-2x text-muted mb-2"></i>
                                                    <p class="text-muted mb-0">Aucun cours prévu aujourd'hui</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Groups -->
                <div class="col-xl-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-bottom border-light py-3 px-4 d-flex align-items-center">
                            <h5 class="card-title mb-0 flex-grow-1 text-uppercase fs-13 text-muted">
                                <i class="ri-history-line me-2 text-secondary"></i>
                                Derniers Groupes mis à jour
                            </h5>
                            <a href="{% url 'institut_app:ListGroupePage' %}" class="btn btn-sm btn-soft-primary rounded-pill">Voir tout</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-nowrap mb-0 align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">Groupe</th>
                                            <th>Spécialité</th>
                                            <th>Statut</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group in recent_groups %}
                                        <tr>
                                            <td class="ps-4">
                                                <h6 class="mb-0">{{ group.nom }}</h6>
                                                <small class="text-muted">{{ group.annee_scolaire }}</small>
                                            </td>
                                            <td>{{ group.specialite.label }}</td>
                                            <td>
                                                {% if group.etat == 'valider' %}
                                                    <span class="badge bg-soft-success text-success">Validé</span>
                                                {% elif group.etat == 'brouillon' %}
                                                    <span class="badge bg-soft-secondary text-secondary">Brouillon</span>
                                                {% elif group.etat == 'inscription' %}
                                                    <span class="badge bg-soft-warning text-warning">Inscription</span>
                                                {% elif group.etat == 'enc' %}
                                                    <span class="badge bg-soft-primary text-primary">En cours</span>
                                                {% else %}
                                                    <span class="badge bg-soft-dark text-dark">{{ group.get_etat_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="#" class="btn btn-sm btn-soft-info">
                                                    <i class="ri-eye-line"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center py-4">Aucun groupe récent</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts for charts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prepare Data
        const specialityLabels = {{ speciality_labels|safe }};
        const specialityCounts = {{ speciality_counts|safe }};
        
        // Gantt Data (Already serialized in view)
        const ganttData = {{ gantt_data|safe }};

        // Students per Speciality Chart
        var specialityOptions = {
            series: [{
                name: 'Étudiants',
                data: specialityCounts
            }],
            chart: {
                type: 'bar',
                height: 350,
                toolbar: { show: false }
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    horizontal: true,
                    distributed: true // colorful bars
                }
            },
            dataLabels: { enabled: true },
            xaxis: {
                categories: specialityLabels,
            },
            colors: ['#556ee6', '#f1b44c', '#34c38f', '#50a5f1', '#f46a6a'],
            grid: {
                borderColor: '#f1f1f1',
            }
        };

        if (specialityLabels.length > 0) {
            var specialityChart = new ApexCharts(document.querySelector("#specialityChart"), specialityOptions);
            specialityChart.render();
        } else {
             document.querySelector("#specialityChart").innerHTML = '<p class="text-center text-muted my-5">Pas assez de données pour afficher le graphique</p>';
        }

        // Room Gantt Chart
        var ganttOptions = {
            series: [
                {
                    data: ganttData
                }
            ],
            chart: {
                height: 350,
                type: 'rangeBar',
                toolbar: { show: false }
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    barHeight: '50%',
                    rangeBarGroupRows: true
                }
            },
            colors: ['#34c38f', '#556ee6', '#f46a6a', '#f1b44c'],
            fill: {
                type: 'solid'
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    datetimeFormatter: {
                        year: 'yyyy',
                        month: 'MMM \'yy',
                        day: 'dd MMM',
                        hour: 'HH:mm'
                    }
                }
            },
            tooltip: {
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    var data = w.globals.initialSeries[seriesIndex].data[dataPointIndex];
                    var start = new Date(data.y[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    var end = new Date(data.y[1]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    return '<div class="px-3 py-2">' +
                        '<div class="mb-1 text-primary fw-bold">' + data.x + '</div>' + // Room Name
                        '<div class="mb-1"><b>Cours:</b> ' + data.course + '</div>' +
                        '<div class="mb-1"><b>Groupe:</b> ' + data.group + '</div>' +
                        '<div class="mb-1"><b>Formateur:</b> ' + data.teacher + '</div>' +
                        '<div class="text-muted small">' + start + ' - ' + end + '</div>' +
                        '</div>';
                }
            },
            grid: {
                borderColor: '#f1f1f1',
            }
        };

        if (ganttData.length > 0) {
            var roomChart = new ApexCharts(document.querySelector("#roomChart"), ganttOptions);
            roomChart.render();
        } else {
            document.querySelector("#roomChart").innerHTML = '<p class="text-center text-muted my-5">Aucune occupation des salles pour aujourd\'hui</p>';
        }
    });
</script>
{% endblock content %}
