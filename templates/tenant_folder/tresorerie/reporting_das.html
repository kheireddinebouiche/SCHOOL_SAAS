{% extends 'tenant_folder/base.html' %}
{% load static %}

{% block title %} Trésorerie - Rapport par Catégorie DAS {% endblock title %}

{% block content %}

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      
      <!-- Header -->
      <div class="row mb-4">
          <div class="col-12">
              <div class="card shadow-sm border-0 bg-soft-primary">
                  <div class="card-body d-flex align-items-center justify-content-between">
                      <div>
                          <h4 class="card-title text-primary mb-1">Rapport DAS</h4>
                          <p class="text-muted mb-0">Vue consolidée des performances financières</p>
                      </div>
                      <div class="d-flex align-items-center">
                           <div class="text-end me-4">
                                <h4 class="mb-0 fw-bold text-dark">{{ total_all|floatformat:0 }} <small class="text-muted fs-6">DZD</small></h4>
                                <small class="text-muted">Chiffre d'affaires Global</small>
                           </div>
                           <div class="text-end me-4">
                                <h4 class="mb-0 fw-bold text-danger">{{ total_expenses_all|floatformat:0 }} <small class="text-muted fs-6">DZD</small></h4>
                                <small class="text-muted">Dépenses Globales</small>
                           </div>
                           
                           <!-- Year Selector -->
                           <form method="get" class="d-inline-block">
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="ri-calendar-event-line text-primary"></i></span>
                                    <select name="year" class="form-select border-start-0 ps-0" style="min-width: 140px; font-weight: 500;" onchange="this.form.submit()">
                                        {% for y in available_years %}
                                            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                                                {{ y }} - {{ y|add:1 }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                           </form>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- Main Content -->
      {% if report_data_by_entity %}
      
      <!-- Nav Tabs -->
      <ul class="nav nav-tabs nav-tabs-custom card-header-tabs border-bottom-0 mb-3" id="entityTabs" role="tablist">
        {% for entity_block in report_data_by_entity %}
        <li class="nav-item">
            <a class="nav-link {% if forloop.first %}active{% endif %}" 
               id="tab-entity-{{ forloop.counter }}" 
               data-bs-toggle="tab" 
               href="#entity-{{ forloop.counter }}" 
               role="tab" 
               aria-controls="entity-{{ forloop.counter }}" 
               aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
               <span class="d-none d-md-block">{{ entity_block.entity.designation }}</span>
               <span class="d-md-none">{{ entity_block.entity.designation|truncatechars:10 }}</span>
               <span class="badge bg-soft-secondary text-primary ms-2">{{ entity_block.total|floatformat:0 }} DA</span>
            </a>
        </li>
        {% endfor %}
      </ul>

      <!-- Tab Content -->
      <div class="tab-content text-muted">
        {% for entity_block in report_data_by_entity %}
        <div class="tab-pane {% if forloop.first %}active{% endif %}" 
             id="entity-{{ forloop.counter }}" 
             role="tabpanel" 
             aria-labelledby="tab-entity-{{ forloop.counter }}">
             
               <!-- TABS HEADER -->
               <div class="card bg-transparent shadow-none">
                    <div class="card-header border-0 bg-transparent p-0 pb-3">
                        <ul class="nav nav-pills nav-custom nav-custom-light" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#revenue-{{ forloop.counter }}" role="tab">
                                    <i class="ri-money-dollar-circle-line me-1 align-bottom"></i> Recettes
                                    <span class="badge bg-soft-primary text-primary ms-1">{{ entity_block.total|floatformat:0 }} DA</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#expenses-{{ forloop.counter }}" role="tab">
                                    <i class="ri-shopping-cart-line me-1 align-bottom"></i> Dépenses
                                    <span class="badge bg-soft-danger text-danger ms-1">{{ entity_block.expenses_total|floatformat:0 }} DA</span>
                                </a>
                            </li>
                        </ul>
                    </div>
               </div>

               <!-- TABS CONTENT -->
               <div class="tab-content text-muted">
                    <!-- REVENUE TAB -->
                    <div class="tab-pane active" id="revenue-{{ forloop.counter }}" role="tabpanel">
                        <div class="card">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1">Recettes - {{ entity_block.entity.designation }}</h4>
                                <div class="flex-shrink-0">
                                    <span class="badge bg-primary fs-12">Total: {{ entity_block.total|floatformat:2 }} DA</span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                              <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                  <thead class="table-light">
                                    <tr>
                                      <th scope="col" class="ps-4">Catégorie</th>
                                      <th scope="col" class="text-center">Formations (Étudiants)</th>
                                      <th scope="col" class="text-center">Conseil / Education</th>
                                      <th scope="col" class="text-center">Autres Produits</th>
                                      <th scope="col" class="text-end pe-4">Total Général</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for item in entity_block.data %}
                                    <tr class="{% if item.is_root %}bg-light fw-bold{% endif %}">
                                      <td class="ps-4">
                                        <div class="d-flex align-items-center" style="padding-left: {{ item.level|add:item.level }}rem;">
                                           {% if item.is_root %}
                                              <i class="ri-folder-3-fill text-primary me-2"></i>
                                              <span class="text-primary text-uppercase">{{ item.category.name }}</span>
                                           {% else %}
                                               {% if item.is_parent %}
                                                 <i class="ri-folder-3-line text-warning me-2"></i>
                                                 <span class="text-dark">{{ item.category.name }}</span>
                                               {% else %}
                                                 <i class="ri-price-tag-3-line text-muted me-2"></i>
                                                 <span>{{ item.category.name }}</span>
                                               {% endif %}
                                           {% endif %}
                                           
                                           {% if not item.is_parent %}
                                           {% with cat_id=item.category.id|stringformat:"s" %}
                                           {% with ent_id=entity_block.entity.id|stringformat:"s" %}
                                           {% with details_id="details-data-"|add:cat_id|add:"-"|add:ent_id %}
                                           <button class="btn btn-sm btn-ghost-primary p-0 ms-2 detail-btn text-muted" type="button" 
                                                   onclick="openDetailsModal('{{ item.category.name|escapejs }}', '{{ details_id }}')">
                                              <i class="ri-eye-line"></i>
                                           </button>
                                           {{ item.details|json_script:details_id }}
                                           {% endwith %}
                                           {% endwith %}
                                           {% endwith %}
                                           {% endif %}
                                         </div>
                                      </td>
                                      <td class="text-center">
                                        {% if item.stats.student_total != 0 %}
                                          <span class="{% if item.stats.student_total < 0 %}text-danger{% else %}text-dark{% endif %}">
                                            {{ item.stats.student_total|floatformat:0 }} DA
                                          </span>
                                        {% else %}
                                          <span class="text-muted">-</span>
                                        {% endif %}
                                      </td>
                                      <td class="text-center">
                                        {% if item.stats.consulting_total != 0 %}
                                          <span class="{% if item.stats.consulting_total < 0 %}text-danger{% else %}text-dark{% endif %}">
                                            {{ item.stats.consulting_total|floatformat:0 }} DA
                                          </span>
                                        {% else %}
                                          <span class="text-muted">-</span>
                                        {% endif %}
                                      </td>
                                      <td class="text-center">
                                        {% if item.stats.other_total != 0 %}
                                          <span class="{% if item.stats.other_total < 0 %}text-danger{% else %}text-dark{% endif %}">
                                            {{ item.stats.other_total|floatformat:0 }} DA
                                          </span>
                                        {% else %}
                                          <span class="text-muted">-</span>
                                        {% endif %}
                                      </td>
                                      <td class="text-end pe-4">
                                        <span class="fw-bold {% if item.stats.grand_total < 0 %}text-danger{% elif item.is_root %}text-primary{% else %}text-dark{% endif %}">
                                           {{ item.stats.grand_total|floatformat:0 }} DA
                                        </span>
                                      </td>
                                    </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                        </div>
                    </div>

                    <!-- EXPENSES TAB -->
                    <div class="tab-pane" id="expenses-{{ forloop.counter }}" role="tabpanel">
                      {% if entity_block.expenses_data %}
                          <div class="card shadow-sm border-top border-danger border-2">
                            <div class="card-header align-items-center d-flex bg-soft-danger">
                                <h4 class="card-title mb-0 flex-grow-1 text-danger">Dépenses (Charges) - {{ entity_block.entity.designation }}</h4>
                                <div class="flex-shrink-0">
                                    <span class="badge bg-danger fs-12">Total: {{ entity_block.expenses_total|floatformat:2 }} DA</span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                  <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                      <thead class="table-light">
                                        <tr>
                                          <th scope="col" class="ps-4">Catégorie de Dépense</th>
                                          <th scope="col" class="text-end pe-4">Montant Total</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {% for item in entity_block.expenses_data %}
                                        <tr class="{% if item.is_root %}bg-light fw-bold{% endif %}">
                                          <td class="ps-4">
                                            <div class="d-flex align-items-center" style="padding-left: {{ item.level|add:item.level }}rem;">
                                               {% if item.is_root %}
                                                  <i class="ri-folder-reduce-fill text-danger me-2"></i>
                                                  <span class="text-danger text-uppercase">{{ item.category.name }}</span>
                                               {% else %}
                                                   {% if item.is_parent %}
                                                     <i class="ri-folder-reduce-line text-warning me-2"></i>
                                                     <span class="text-dark">{{ item.category.name }}</span>
                                                   {% else %}
                                                     <i class="ri-price-tag-3-line text-muted me-2"></i>
                                                     <span>{{ item.category.name }}</span>
                                                   {% endif %}
                                               {% endif %}
                                               
                                               {% if not item.is_parent %}
                                                {% with cat_id=item.category.id|stringformat:"s" %}
                                                {% with ent_id=entity_block.entity.id|stringformat:"s" %}
                                                {% with details_id="exp-details-"|add:cat_id|add:"-"|add:ent_id %}
                                                <button class="btn btn-sm btn-ghost-danger p-0 ms-2 detail-btn text-muted" type="button" 
                                                        onclick="openDetailsModal('{{ item.category.name|escapejs }}', '{{ details_id }}')">
                                                    <i class="ri-eye-line"></i>
                                                </button>
                                                {{ item.details|json_script:details_id }}
                                                {% endwith %}
                                                {% endwith %}
                                                {% endwith %}
                                               {% endif %}
                                            </div>
                                          </td>
                                          <td class="text-end pe-4">
                                            <span class="fw-bold {% if item.total > 0 %}text-danger{% else %}text-muted{% endif %}">
                                               {{ item.total|floatformat:0 }} DA
                                            </span>
                                          </td>
                                        </tr>
                                        {% endfor %}
                                      </tbody>
                                    </table>
                                  </div>
                            </div>
                          </div>
                      {% else %}
                          <div class="card">
                              <div class="card-body text-center py-5">
                                  <i class="ri-shopping-cart-2-line fs-1 text-muted"></i>
                                  <h5 class="text-muted mt-2">Aucune dépense enregistrée pour cette période.</h5>
                              </div>
                          </div>
                      {% endif %}
                    </div>
               </div>


        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="row">
        <div class="col-12">
          <div class="card">
             <div class="card-body text-center py-5">
                <i class="ri-inbox-line fs-1 text-muted"></i>
                <h5 class="text-muted mt-2">Aucune donnée financière trouvée.</h5>
             </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<!-- Details Modal (Standard) -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Détails de la catégorie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Libellé</th>
                        <th class="text-center">Type</th>
                        <th class="pe-4 text-end">Montant (DA)</th>
                    </tr>
                </thead>
                <tbody id="detailsModalBody">
                    <!-- JS Injected Content -->
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="2" class="ps-4 fw-bold">Total Général</td>
                        <td class="pe-4 text-end fw-bold text-primary" id="detailsModalTotal">0.00</td>
                    </tr>
                </tfoot>
            </table>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
    function openDetailsModal(categoryName, scriptId) {
        // 1. Get Element and Parse JSON
        
        const modalTitle = document.getElementById('detailsModalLabel');
        const modalBody = document.getElementById('detailsModalBody');
        const modalTotal = document.getElementById('detailsModalTotal');
        
        modalTitle.textContent = "Détails : " + categoryName;
        modalBody.innerHTML = '';
        
        let data = [];
        console.log("Opening modal for:", categoryName, "Script ID:", scriptId);
        
        try {
            const scriptEl = document.getElementById(scriptId);
            if (scriptEl) {
                 data = JSON.parse(scriptEl.textContent);
            } else {
                console.error("Script element not found for ID:", scriptId);
            }
        } catch(e) {
            console.error("Error parsing details JSON", e);
        }

        if (!data || data.length === 0) {
            modalBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center py-4 text-muted">
                        Aucun détail disponible pour cette catégorie.
                    </td>
                </tr>`;
            modalTotal.textContent = "0.00 DA";
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
            return;
        }

        let total = 0;
        data.forEach(item => {
            const amount = parseFloat(item.total) || 0;
            total += amount;
            
            const isNegative = amount < 0;
            
            // Format Currency
            const formattedAmount = new Intl.NumberFormat('fr-DZ', { 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + ' DA';

            let typeBadge = '';
            if (item.type === 'Etudiant') typeBadge = '<span class="badge bg-soft-primary text-primary">Étudiant</span>';
            else if (item.type === 'Conseil') typeBadge = '<span class="badge bg-soft-success text-success">Conseil</span>';
            else if (item.type === 'Depense') typeBadge = '<span class="badge bg-soft-danger text-danger">Dépense</span>';
            else typeBadge = '<span class="badge bg-light text-dark border">Autre</span>';

            modalBody.innerHTML += `
                <tr>
                    <td class="ps-4">${item.label}</td>
                    <td class="text-center">${typeBadge}</td>
                    <td class="text-end pe-4 font-monospace ${isNegative ? 'text-danger fw-bold' : ''}">${formattedAmount}</td>
                </tr>
            `;
        });
        
        const formattedTotal = new Intl.NumberFormat('fr-DZ', { 
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(total) + ' DA';
        
        modalTotal.textContent = formattedTotal;

        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }
</script>
{% endblock extra_js %}
