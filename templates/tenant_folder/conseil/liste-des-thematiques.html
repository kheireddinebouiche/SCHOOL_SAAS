{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Conseil - Liste des thématiques {% endblock title %}

{% block content %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.2);
  }

  .main-content {
    background: #f8fafc;
  }

  .page-title-box h4 {
    font-weight: 700;
  }

  .folder-card {
    transition: all 0.3s ease;
  }

  .folder-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
  }

  .modal-header-custom {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 1.5rem 2rem;
  }

  .form-control-custom {
    border-radius: 8px;
    padding: 0.6rem 1rem;
    border: 1px solid #e2e8f0;
  }

  .form-control-custom:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
</style>

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                <i class="ri-lightbulb-line text-primary"></i>
              </div>
              <h4 class="mb-0 text-primary">Liste des thématiques</h4>
            </div>
            <div class="page-title-right">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);" class="text-muted">
                      <i class="ri-home-line me-1"></i>Conseil
                    </a>
                  </li>
                  <li class="breadcrumb-item active text-primary">Thématiques</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <!-- Action Bar -->
      <div class="row mb-4 align-items-center">
        <div class="col-sm-auto">
          <div class="d-flex gap-2">
            <div class="search-box">
              <input type="text" id="table-filter" class="form-control" placeholder="Rechercher une thématique..." style="min-width: 300px; padding-left: 2.5rem;">
              <i class="ri-search-line search-icon" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
            </div>
            <select id="category-filter" class="form-select" style="width: 153px;">
              <option value="all">Toutes</option>
              <option value="service" class="text-success">Services</option>
              <option value="produit" class="text-warning">Produits</option>
            </select>
          </div>
        </div>
        <div class="col-sm-auto ms-auto">
          <button class="btn btn-primary bg-gradient shadow-sm" id="btnAddThematique">
            <i class="ri-add-line me-1"></i> Nouvelle Thématique
          </button>
        </div>
      </div>

      <!-- Content Grid -->
      <div class="row" id="listItem">
          <!-- Data loaded via AJAX -->
      </div>

    </div>
  </div>
</div>

<!-- Modal Creation -->
<div id="newThematique" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header-custom d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <div class="bg-primary bg-opacity-10 p-3 rounded-pill me-3">
            <i class="ri-add-circle-line fs-2 text-primary"></i>
          </div>
          <div>
            <h4 class="modal-title mb-0 text-dark fw-bold">Ajouter une thématique</h4>
            <p class="mb-0 text-muted small">Créez une nouvelle proposition de conseil</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="formNewThematique">
          <div class="row g-4">
            <div class="col-md-12">
              <label class="form-label fw-semibold">Désignation</label>
              <input type="text" class="form-control form-control-custom" id="labelThematique" placeholder="Ex: Audit de performance">
            </div>
            <div class="col-md-12">
              <label class="form-label fw-semibold">Prix Unitaire (HT)</label>
              <div class="input-group">
                <input type="number" class="form-control form-control-custom" id="prixThematique">
                <span class="input-group-text bg-light border-start-0">DZD</span>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">TVA par défaut (%)</label>
              <select class="form-select form-control-custom" id="tvaThematique">
                {% for tva in tvas %}
                <option value="{{ tva.valeur|stringformat:'.2f' }}">{{ tva.label }} ({{ tva.valeur }}%)</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Catégorie</label>
              <select class="form-select form-control-custom" id="categorieThematique">
                <option value="service">Service</option>
                <option value="produit">Produit</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Description</label>
              <textarea class="form-control form-control-custom" id="descriptionThematique" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer bg-light p-3 border-top-0">
        <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary px-4 shadow-sm" id="saveThematique">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Edition -->
<div id="updateThematique" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header-custom d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <div class="bg-info bg-opacity-10 p-3 rounded-pill me-3">
            <i class="ri-edit-line fs-2 text-info"></i>
          </div>
          <div>
            <h4 class="modal-title mb-0 text-dark fw-bold">Modifier la thématique</h4>
            <p class="mb-0 text-muted small">Mettez à jour les informations</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="updateIdThematique">
        <div class="row g-4">
          <div class="col-md-12">
            <label class="form-label fw-semibold">Désignation</label>
            <input type="text" class="form-control form-control-custom" id="updatelabelThematique">
          </div>
          <div class="col-md-12">
            <label class="form-label fw-semibold">Prix Unitaire (HT)</label>
            <input type="number" class="form-control form-control-custom" id="updateprixThematique">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">TVA par défaut (%)</label>
            <select class="form-select form-control-custom" id="updatetvaThematique">
                {% for tva in tvas %}
                <option value="{{ tva.valeur|stringformat:'.2f' }}">{{ tva.label }} ({{ tva.valeur }}%)</option>
                {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Catégorie</label>
            <select class="form-select form-control-custom" id="updatecategorieThematique">
              <option value="service">Service</option>
              <option value="produit">Produit</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Description</label>
            <textarea class="form-control form-control-custom" id="updatedescriptionThematique" rows="3"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light p-3 border-top-0">
        <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-info text-white px-4 shadow-sm" id="saveUpdateThematique">Mettre à jour</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation -->
<div class="modal fade deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
    <div class="modal-content">
      <div class="p-5 text-center">
        <div class="bg-danger bg-opacity-10 text-danger p-4 rounded-circle d-inline-block mb-4">
          <i class="ri-delete-bin-line fs-1"></i>
        </div>
        <h3 class="fw-bold mb-2">Supprimer ?</h3>
        <p class="text-muted mb-4">Cette action est définitive. Êtes-vous sûr de vouloir supprimer cette thématique ?</p>
        <div class="hstack gap-3 justify-content-center">
          <button type="button" class="btn btn-light w-100" data-bs-dismiss="modal">Annuler</button>
          <button type="button" id="confirmDeleteBtn" class="btn btn-danger w-100">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Archive Confirmation -->
<div class="modal fade archiveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
    <div class="modal-content">
      <div class="p-5 text-center">
        <div class="bg-warning bg-opacity-10 text-warning p-4 rounded-circle d-inline-block mb-4">
          <i class="ri-inbox-archive-line fs-1"></i>
        </div>
        <h3 class="fw-bold mb-2">Archiver ?</h3>
        <p class="text-muted mb-4">La thématique sera archivée. Vous pourrez la restaurer ultérieurement.</p>
        <div class="hstack gap-3 justify-content-center" id="archiveActions">
          <!-- Buttons injected JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){

    function loadThematique(){
        $.ajax({
            url : "{% url 't_conseil:ApiLoadThematique' %}",
            type : "GET",
            dataType : 'JSON',
            success : function(data){
                var row = "";
                if (data.length > 0){
                    $.each(data, function(index, p){
                        let catBadge = p.categorie === 'produit' ? 'badge-soft-warning' : 'badge-soft-success';
                        let pricing = p.billing_type === 'jour' ? 'Jour' : 'Heure';
                        
                        row += '<div class="col-xxl-3 col-xl-4 col-sm-6 mb-4 card-item" data-category="'+(p.categorie || 'service')+'">';
                        row += '  <div class="card shadow-sm border-0 h-100 folder-card">';
                        row += '    <div class="card-body pb-0 pt-4">';
                        row += '      <div class="d-flex justify-content-between align-items-start mb-3">';
                        row += '        <div class="avatar-sm flex-shrink-0">';
                        row += '          <span class="avatar-title bg-light rounded shadow-sm text-primary display-5">';
                        row += '            <i class="ri-lightbulb-flash-line"></i>';
                        row += '          </span>';
                        row += '        </div>';
                        row += '        <div class="dropdown">';
                        row += '          <button class="btn btn-ghost-primary btn-icon btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                        row += '            <i class="ri-more-2-fill fs-16"></i>';
                        row += '          </button>';
                        row += '          <ul class="dropdown-menu dropdown-menu-end">';
                        row += '            <li><button class="dropdown-item btnUpdate" data-id="'+p.id+'"><i class="ri-pencil-line me-2 align-bottom text-muted"></i>Modifier</button></li>';
                        row += '            <li><button class="dropdown-item archiveBtn" data-id="'+p.id+'"><i class="ri-inbox-archive-line me-2 align-bottom text-muted"></i>Archiver</button></li>';
                        row += '            <li><hr class="dropdown-divider"></li>';
                        row += '            <li><button class="dropdown-item text-danger deleteBtn" data-id="'+p.id+'"><i class="ri-delete-bin-line me-2 align-bottom text-muted"></i>Supprimer</button></li>';
                        row += '          </ul>';
                        row += '        </div>';
                        row += '      </div>';
                        
                        row += '      <h5 class="fs-15 mb-2 text-truncate">';
                        row += '        <a href="javascript:void(0);" class="text-dark fw-bold">'+p.label+'</a>';
                        row += '      </h5>';
                        
                        row += '      <div class="mb-3">';
                        row += '        <span class="badge '+catBadge+' text-uppercase fs-10">'+p.categorie+'</span>';
                        row += '      </div>';
                        
                        row += '      <p class="text-muted small mb-3 line-clamp-2" style="height: 2.5rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">';
                        row +=         (p.description || 'Aucune description');
                        row += '      </p>';

                        row += '      <div class="d-flex align-items-center justify-content-between border-top border-light pt-3 mt-auto pb-3">';
                        row += '        <div>';
                        row += '          <span class="badge badge-soft-primary fs-12">';
                        row += '            <i class="ri-calendar-event-line me-1 align-bottom"></i> '+new Date(p.created_at).toLocaleDateString();
                        row += '          </span>';
                        row += '        </div>';
                        row += '        <div>';
                        row += '          <h5 class="fs-14 mb-0 text-primary fw-bold">'+parseFloat(p.prix).toLocaleString('fr-DZ', { minimumFractionDigits: 2 })+' DZD</h5>';
                        row += '        </div>';
                        row += '      </div>';
                        row += '    </div>';
                        row += '    <div class="card-footer bg-transparent border-top-0 pt-0 pb-3">';
                        row += '      <button data-id="'+p.id+'" class="btn btn-soft-primary w-100 btn-sm btnUpdate">';
                        row += '        Gérer la thématique <i class="ri-arrow-right-line ms-1 align-bottom"></i>';
                        row += '      </button>';
                        row += '    </div>';
                        row += '  </div>';
                        row += '</div>';
                    });
                } else {
                    row = '<div class="col-12">' +
                          '  <div class="card shadow-sm border-0">' +
                          '    <div class="card-body">' +
                          '      <div class="text-center py-5">' +
                          '        <div class="avatar-lg bg-light rounded-circle mx-auto mb-4 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">' +
                          '          <i class="ri-file-search-line fs-1 text-muted"></i>' +
                          '        </div>' +
                          '        <h5 class="fw-bold">Aucune thématique trouvée</h5>' +
                          '        <p class="text-muted mb-4">Commencez par ajouter votre première proposition de conseil pour vos clients.</p>' +
                          '        <button class="btn btn-primary" onclick="$(\'#btnAddThematique\').click()">' +
                          '          <i class="ri-add-line me-1"></i> Ajouter une thématique' +
                          '        </button>' +
                          '      </div>' +
                          '    </div>' +
                          '  </div>' +
                          '</div>';
                }
                $('#listItem').html(row);
            }
        });
    }

    loadThematique();

    // Filter function
    function filterThematiques() {
      var searchValue = $("#table-filter").val().toLowerCase();
      var categoryValue = $("#category-filter").val();

      $("#listItem .card-item").each(function() {
        var text = $(this).text().toLowerCase();
        var category = $(this).data('category');

        var matchesSearch = text.indexOf(searchValue) > -1;
        var matchesCategory = categoryValue === "all" || category === categoryValue;

        if (matchesSearch && matchesCategory) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    }

    // Event listeners for filters
    $("#table-filter").on("keyup", filterThematiques);
    $("#category-filter").on("change", filterThematiques);

    $(document).on('click', '#btnAddThematique', function(){
        $('#newThematique').modal('show');
    });

    $(document).on('click', '#saveThematique', function(){
        var label = $('#labelThematique').val();
        var prix  = $('#prixThematique').val();
        var description = $('#descriptionThematique').val();
        var default_tva = $('#tvaThematique').val();
        var categorie = $('#categorieThematique').val();

        if(label == ""){
            alertify.error('Le label est obligatoire');
            return false;
        }

        $.ajax({
            url: "{% url 't_conseil:ApiSaveThematique' %}",
            method: "POST",
            data: {
                'label': label,
                'prix' : prix,
                'description' : description,
                'default_tva' : default_tva,
                'categorie' : categorie,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response){
                if(response.status == 'success'){
                    alertify.success(response.message);
                    loadThematique();
                    $('#newThematique').modal('hide');
                    $('#formNewThematique')[0].reset();
                } else {
                    alertify.error('Une erreur est survenue.');
                }
            }
        });
    });

    $(document).on('click', '.btnUpdate', function(){
        var id_thematique = $(this).attr('data-id');
        $('#updateIdThematique').val(id_thematique);
        $('#saveUpdateThematique').attr('data-id', id_thematique);
        
        $.ajax({
            url : "{% url 't_conseil:ApiLoadThematiqueDetails' %}",
            dataType: "JSON",
            type: 'GET',
            data : {'id_thematique': id_thematique },
            success : function(data){
                $('#updatelabelThematique').val(data.label);
                $('#updatedescriptionThematique').val(data.description);
                $('#updateprixThematique').val(data.prix);
                if (data.default_tva) {
                    $('#updatetvaThematique').val(parseFloat(data.default_tva).toFixed(2));
                }
                $('#updatecategorieThematique').val(data.categorie);
                $('#updateThematique').modal('show');
            }
        });
    });

    $(document).on('click', '#saveUpdateThematique', function(){
        var id_thematique = $(this).attr('data-id') || $('#updateIdThematique').val();
        
        if (!id_thematique) {
            alertify.error('Erreur: ID de thématique manquant.');
            return;
        }

        var label = $('#updatelabelThematique').val();
        var prix = $('#updateprixThematique').val();
        var description = $('#updatedescriptionThematique').val();
        var default_tva = $('#updatetvaThematique').val();
        var categorie = $('#updatecategorieThematique').val();

        $.ajax({
            url: "{% url 't_conseil:ApiUpdateThematique' %}",
            method: "POST",
            data: {
                'id_thematique': id_thematique,
                'label': label,
                'prix': prix,
                'description': description,
                'default_tva': default_tva,
                'categorie': categorie,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response){
                if(response.status == 'success'){
                    alertify.success(response.message);
                    loadThematique();
                    $('#updateThematique').modal('hide');
                }
            }
        });
    });

    $(document).on('click', '.deleteBtn', function(){
        var id = $(this).data('id');
        $('#confirmDeleteBtn').data('id', id);
        $('.deleteModal').modal('show');
    });

    $(document).on('click', '#confirmDeleteBtn', function(){
        var id = $(this).data('id');
        $.ajax({
            url: "{% url 't_conseil:ApiArchiveThematique' %}",
            method: "POST",
            data: {
                'id_thematique': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response){
                if(response.status == 'success'){
                    alertify.success('Thématique supprimée');
                    loadThematique();
                    $('.deleteModal').modal('hide');
                }
            }
        });
    });

    $(document).on('click', '.archiveBtn', function(){
        var id = $(this).data('id');
        var buttons = '<button type="button" class="btn btn-light w-100" data-bs-dismiss="modal">Annuler</button>'+
                      '<button id="confirmArchiveBtn" data-id="'+id+'" class="btn btn-warning w-100 fw-bold">Confirmer l\'archivage</button>';
        $('#archiveActions').html(buttons);
        $('.archiveModal').modal('show');
    });

    $(document).on('click', '#confirmArchiveBtn', function(){
        var id = $(this).data('id');
        $.ajax({
            url: "{% url 't_conseil:ApiArchiveThematique' %}",
            method: "POST",
            data: {
                'id_thematique': id,
                'archive': true,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response){
                if(response.status == 'success'){
                    alertify.success('Thématique archivée');
                    loadThematique();
                    $('.archiveModal').modal('hide');
                }
            }
        });
    });
  
  });
</script>
{% endblock content %}
           



    