{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Conseil - Nouvelle facture {% endblock title %}

{% block content %}
<style>
    :root {
        --primary-color: #6571ff; /* Purple for Conseil/Facture */
        --primary-soft: #f0f2ff;
        --secondary-color: #405189;
        --text-muted: #878a99;
        --border-color: #e9ebec;
        --card-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }

    .page-content {
        background-color: #f3f6f9;
        min-height: 100vh;
    }

    .card-premium {
        border: none;
        box-shadow: var(--card-shadow);
        border-radius: 16px;
        background: #fff;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .card-header-premium {
        background: linear-gradient(135deg, #6571ff 0%, #5a64e1 100%);
        padding: 24px 32px;
        border-bottom: none;
    }

    .section-title {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 24px;
        position: relative;
        padding-left: 15px;
        border-left: 3px solid var(--primary-color);
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .form-control, .form-select {
        border: 1px solid var(--border-color);
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .input-group-text {
        background-color: #fcfcfc;
        border-color: var(--border-color);
    }

    .btn-action {
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(101, 113, 255, 0.2);
    }

    .breadcrumb-item.active {
        color: var(--primary-color);
        font-weight: 500;
    }

    /* Modal Styling Adapter */
    .modal-content-premium {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .modal-header-premium {
        background: linear-gradient(135deg, #6571ff 0%, #5a64e1 100%);
        color: white;
        padding: 20px 24px;
        border-bottom: none;
    }

    .btn-close-white {
        filter: brightness(0) invert(1);
    }

    .segment-container {
        background-color: #f3f6f9;
        padding: 5px;
        border-radius: 8px;
        display: flex;
        margin-bottom: 20px;
    }

    .segment-option {
        flex: 1;
        text-align: center;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
        color: var(--text-muted);
        transition: all 0.3s ease;
        position: relative;
        margin-bottom: 0;
    }

    .segment-input {
        display: none;
    }

    .segment-input:checked + .segment-option {
        background-color: white;
        color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        font-weight: 600;
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- Breadcrumb -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-0 fw-bold text-dark">Nouvelle Facture</h4>
                            <p class="text-muted mb-0 fs-13 mt-1">Création d'une nouvelle pièce comptable</p>
                        </div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);" class="text-muted">Conseil</a></li>
                                <li class="breadcrumb-item"><a href="#" class="text-muted">Factures</a></li>
                                <li class="breadcrumb-item active">Nouvelle</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-xl-9 col-lg-10">
                    <div class="card card-premium">
                        <!-- Header -->
                        <div class="card-header-premium">
                            <div class="d-flex justify-content-between align-items-center text-white">
                                <div>
                                    <h5 class="card-title mb-1 text-white opacity-100 fs-16">Configuration de la Facture</h5>
                                    <p class="mb-0 opacity-75 fs-12">Sélectionnez le client et définissez les dates</p>
                                </div>
                                <div class="avatar-sm bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="ri-bill-line fs-20 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-4 p-md-5">
                            <form method="POST" id="factureForm" class="needs-validation" novalidate>
                                {% csrf_token %}
                                
                                {% if form.non_field_errors %}
                                <div class="alert alert-danger alert-borderless shadow-sm mb-4" role="alert">
                                    <i class="ri-error-warning-line me-2"></i>
                                    {{ form.non_field_errors }}
                                </div>
                                {% endif %}

                                <!-- Informations Client -->
                                <div class="mb-5">
                                    <h6 class="section-title">Destinataire</h6>
                                    <div class="row g-4">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <label for="{{ form.client.id_for_label }}" class="form-label mb-0">Client / Prospect <span class="text-danger">*</span></label>
                                                <button type="button" class="btn btn-sm text-primary fw-medium p-0" data-bs-toggle="modal" data-bs-target="#newProspectModal">
                                                    <i class="ri-add-circle-line pb-1 align-middle"></i> Nouveau Prospect
                                                </button>
                                            </div>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="ri-user-star-line text-muted"></i></span>
                                                {{ form.client }}
                                            </div>
                                            {% if form.client.errors %}
                                                <div class="text-danger small mt-1">{{ form.client.errors }}</div>
                                            {% endif %}
                                            <div class="form-text fs-11 text-muted mt-1">Sélectionnez le client facturé.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-5">
                                    <h6 class="section-title">Entreprise émettrice</h6>
                                    <div class="row g-4">
                                        <div class="col-12">
                                            <label for="{{ form.entreprise.id_for_label }}" class="form-label">Sélectionner l'entreprise <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="ri-building-line text-muted"></i></span>
                                                {{ form.entreprise }}
                                            </div>
                                            {% if form.entreprise.errors %}
                                                <div class="text-danger small mt-1">{{ form.entreprise.errors }}</div>
                                            {% endif %}
                                            <div class="form-text fs-11 text-muted mt-1">L'entreprise qui émet cette facture.</div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="border-dashed my-4">

                                <!-- Dates -->
                                <div class="mb-5">
                                    <h6 class="section-title">Période et Échéance</h6>
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <label for="{{ form.date_emission.id_for_label }}" class="form-label">Date d'émission <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="ri-calendar-event-line text-muted"></i></span>
                                                <input type="date" class="form-control" id="{{ form.date_emission.id_for_label }}" name="{{ form.date_emission.html_name }}" required>
                                            </div>
                                            {% if form.date_emission.errors %}
                                                <div class="text-danger small mt-1">{{ form.date_emission.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            <label for="{{ form.date_echeance.id_for_label }}" class="form-label">Date d'échéance <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="ri-calendar-check-line text-muted"></i></span>
                                                <input type="date" class="form-control" id="{{ form.date_echeance.id_for_label }}" name="{{ form.date_echeance.html_name }}" required>
                                            </div>
                                            {% if form.date_echeance.errors %}
                                                <div class="text-danger small mt-1">{{ form.date_echeance.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="d-flex justify-content-end gap-2 mt-5">
                                    <button type="button" class="btn btn-light btn-action" onclick="window.history.back()">
                                        <i class="ri-arrow-left-line me-1 align-middle"></i> Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-action shadow-lg" style="background-color: var(--primary-color); border-color: var(--primary-color);">
                                        <i class="ri-save-line me-1 align-middle"></i> Enregistrer et Configurer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal Nouveau Prospect Premium Style -->
<div class="modal fade" id="newProspectModal" tabindex="-1" aria-labelledby="newProspectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-premium">
            <div class="modal-header modal-header-premium">
                <h5 class="modal-title fs-16" id="newProspectModalLabel">
                    <i class="ri-user-add-line me-2 align-middle"></i>Ajouter un Prospect
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="quickProspectForm">
                    
                    <div class="segment-container">
                        <label class="segment-option" for="typeParticulier">
                            <input type="radio" class="segment-input check-type" name="type_prospect" id="typeParticulier" value="particulier" checked>
                            <span>Particulier</span>
                        </label>
                        <label class="segment-option" for="typeEntreprise">
                            <input type="radio" class="segment-input check-type" name="type_prospect" id="typeEntreprise" value="entreprise">
                            <span>Entreprise</span>
                        </label>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="prospectNom">Nom <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="prospectNom" name="nom" required placeholder="Nom">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="prospectPrenom">Prénom</label>
                            <input type="text" class="form-control" id="prospectPrenom" name="prenom" placeholder="Prénom">
                        </div>
                    </div>
                    
                    <div id="entrepriseFields" class="d-none">
                        <div class="mb-3">
                            <label class="form-label" for="prospectEntreprise">Entreprise <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="prospectEntreprise" name="entreprise" placeholder="Nom de l'entreprise">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="prospectPoste">Poste</label>
                            <input type="text" class="form-control" id="prospectPoste" name="poste" placeholder="Poste occupé">
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label" for="prospectEmail">Email</label>
                                <input type="email" class="form-control" id="prospectEmail" name="email" placeholder="exemple@mail.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label" for="prospectTelephone">Téléphone <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="prospectTelephone" name="telephone" required placeholder="05XXXXXXXX">
                            </div>
                        </div>
                    </div>
                </form>
                
                <div id="prospectError" class="alert alert-danger d-none mt-3 fs-13">
                    <i class="ri-error-warning-fill me-1 align-middle"></i> <span id="errorText"></span>
                </div>

            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light fw-medium" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary fw-medium" id="saveProspectBtn" style="background-color: var(--primary-color); border-color: var(--primary-color);">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const factureForm = document.getElementById('factureForm');
        const dateEmissionInput = document.getElementById('{{ form.date_emission.id_for_label }}');
        const dateEcheanceInput = document.getElementById('{{ form.date_echeance.id_for_label }}');
        
        // Defaults
        if (!dateEmissionInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateEmissionInput.value = today;
        }
        if (!dateEcheanceInput.value) {
            const today = new Date();
            const echeanceDate = new Date(today.setDate(today.getDate() + 30));
            dateEcheanceInput.value = echeanceDate.toISOString().split('T')[0];
        }
        
        // Validation
        function validateDates() {
            const emissionDate = new Date(dateEmissionInput.value);
            const echeanceDate = new Date(dateEcheanceInput.value);
            
            if (echeanceDate < emissionDate) {
                dateEcheanceInput.setCustomValidity('La date d\'échéance doit être postérieure à la date d\'émission.');
            } else {
                dateEcheanceInput.setCustomValidity('');
            }
        }
        
        dateEcheanceInput.addEventListener('change', validateDates);
        dateEmissionInput.addEventListener('change', function() {
            if (dateEcheanceInput.value) validateDates();
        });
        
        // Submit Animation
        factureForm.addEventListener('submit', function(e) {
            const submitBtn = factureForm.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Traitement...';
            submitBtn.style.opacity = '0.7';
            submitBtn.style.pointerEvents = 'none';
        });

        // Modal Logic
        const typeRadios = document.querySelectorAll('.check-type');
        const entrepriseFields = document.getElementById('entrepriseFields');
        const prospectNomInput = document.getElementById('prospectNom');
        
        const saveProspectBtn = document.getElementById('saveProspectBtn');
        const quickProspectForm = document.getElementById('quickProspectForm');
        const prospectError = document.getElementById('prospectError');
        const errorText = document.getElementById('errorText');
        const clientSelect = document.getElementById('{{ form.client.id_for_label }}');
        const modalEl = document.getElementById('newProspectModal');
        const modal = new bootstrap.Modal(modalEl);

        const toggleFields = (type) => {
             if (type === 'particulier') {
                entrepriseFields.classList.add('d-none');
                prospectNomInput.placeholder = "Nom";
            } else {
                entrepriseFields.classList.remove('d-none');
                 prospectNomInput.placeholder = "Nom du contact";
            }
        };

        typeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                toggleFields(this.value);
            });
        });

        saveProspectBtn.addEventListener('click', function() {
            if (!quickProspectForm.checkValidity()) {
                quickProspectForm.reportValidity();
                return;
            }

            const formData = new FormData(quickProspectForm);
            
            const originalBtnText = saveProspectBtn.innerHTML;
            saveProspectBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            saveProspectBtn.disabled = true;
            prospectError.classList.add('d-none');

            fetch("{% url 't_conseil:ApiQuickCreateProspect' %}", {
                method: 'POST',
                body: formData,
                headers: { 
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    modal.hide();
                    const option = new Option(data.prospect.nom, data.prospect.id, true, true);
                    clientSelect.add(option, undefined);
                    clientSelect.dispatchEvent(new Event('change'));
                    quickProspectForm.reset();
                    // Reset to Particulier
                    document.getElementById('typeParticulier').checked = true;
                    document.getElementById('typeParticulier').dispatchEvent(new Event('change'));
                } else {
                    errorText.textContent = data.message || 'Erreur inconnue.';
                    prospectError.classList.remove('d-none');
                }
            })
            .catch(err => {
                console.error(err);
                errorText.textContent = 'Erreur serveur.';
                prospectError.classList.remove('d-none');
            })
            .finally(() => {
                saveProspectBtn.innerHTML = originalBtnText;
                saveProspectBtn.disabled = false;
            });
        });
    });
</script>
{% endblock content %}
