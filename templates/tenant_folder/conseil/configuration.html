{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Conseil - Configuration {% endblock title %}

{% block content %}
<style>
    :root {
        --primary-color: #3b7ddd;
        --secondary-bg: #f8fafc;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --text-muted: #64748b;
    }

    .page-content {
        background-color: #f1f5f9;
        min-height: 100vh;
    }

    /* Settings Hub Layout */
    .settings-container {
        display: flex;
        gap: 24px;
        align-items: flex-start;
    }

    /* Sidebar Navigation */
    .settings-sidebar {
        width: 260px;
        flex-shrink: 0;
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        position: sticky;
        top: 90px;
    }

    .nav-pills-custom .nav-link {
        color: var(--text-muted);
        font-weight: 500;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .nav-pills-custom .nav-link i { font-size: 1.1rem; }

    .nav-pills-custom .nav-link:hover {
        background-color: var(--secondary-bg);
        color: var(--primary-color);
    }

    .nav-pills-custom .nav-link.active {
        background-color: rgba(59, 125, 221, 0.1);
        color: var(--primary-color);
        font-weight: 600;
    }

    /* Content Area */
    .settings-content {
        flex-grow: 1;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .settings-header {
        padding: 24px 32px;
        border-bottom: 1px solid var(--border-color);
    }

    .settings-body {
        padding: 32px;
    }

    .section-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
        font-weight: 700;
        margin-bottom: 12px;
        display: block;
    }

    /* Form Controls */
    .form-group-custom {
        margin-bottom: 24px;
    }
    
    .form-label-custom {
        font-weight: 600;
        color: var(--text-main);
        font-size: 0.9rem;
        margin-bottom: 6px;
    }

    .form-text-custom {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .custom-card-input {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        transition: all 0.2s;
    }
    .custom-card-input:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 125, 221, 0.1);
    }

    /* Toggles */
    .form-switch .form-check-input {
        width: 2.5em; 
        height: 1.25em;
        cursor: pointer;
    }
    
    /* Config Items */
    .config-strip {
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: #fff;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .enterprise-select-wrapper {
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 12px 20px;
        margin-bottom: 24px;
        border: 1px solid rgba(255,255,255,0.5);
    }

</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <div class="row align-items-center mb-4">
                <div class="col">
                    <h4 class="fs-18 fw-bold text-dark mb-1">Configuration Conseil</h4>
                    <p class="text-muted mb-0 fs-13">Personnalisez les règles de gestion et l'apparence des documents.</p>
                </div>
            </div>

            <!-- Enterprise Selector -->
            <div class="enterprise-select-wrapper shadow-sm">
                <form method="GET" id="enterpriseSelectorForm" class="m-0">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-xs bg-white text-primary rounded-circle d-flex align-items-center justify-content-center border border-light shadow-sm">
                            <i class="ri-building-line"></i>
                        </div>
                        <span class="text-muted small fw-bold text-uppercase">Contexte :</span>
                        <select name="enterprise_id" class="form-select form-select-sm border-0 bg-transparent shadow-none fw-bold text-dark" style="width: auto; cursor: pointer;" onchange="this.form.submit()">
                            <option value="" {% if not current_enterprise %}selected{% endif %}>Configuration Globale</option>
                            {% for ent in enterprises %}
                                <option value="{{ ent.id }}" {% if current_enterprise.id == ent.id %}selected{% endif %}>{{ ent.designation }}</option>
                            {% endfor %}
                        </select>
                        {% if current_enterprise %}
                        <span class="badge bg-soft-primary text-primary ms-auto">Mode Entreprise</span>
                        {% else %}
                        <span class="badge bg-soft-secondary text-secondary ms-auto">Mode Global</span>
                        {% endif %}
                    </div>
                </form>
            </div>

            <form method="POST" id="configForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="save_config">
                <input type="hidden" name="enterprise_id" value="{{ current_enterprise.id|default:'' }}">

                <div class="settings-container">
                    
                    <!-- Sidebar -->
                    <div class="settings-sidebar">
                        <span class="section-label px-3">Menu</span>
                        <div class="nav flex-column nav-pills-custom" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <a class="nav-link active" id="v-pills-taxes-tab" data-bs-toggle="pill" href="#v-pills-taxes" role="tab" aria-controls="v-pills-taxes" aria-selected="true">
                                <i class="ri-percent-line"></i> Taxes & Fiscalité
                            </a>
                            <a class="nav-link" id="v-pills-docs-tab" data-bs-toggle="pill" href="#v-pills-docs" role="tab" aria-controls="v-pills-docs" aria-selected="false">
                                <i class="ri-file-text-line"></i> Documents
                            </a>
                            <a class="nav-link" id="v-pills-offers-tab" data-bs-toggle="pill" href="#v-pills-offers" role="tab" aria-controls="v-pills-offers" aria-selected="false">
                                <i class="ri-coupon-3-line"></i> Offres & Remises
                            </a>
                            <a class="nav-link" id="v-pills-mentions-tab" data-bs-toggle="pill" href="#v-pills-mentions" role="tab" aria-controls="v-pills-mentions" aria-selected="false">
                                <i class="ri-article-line"></i> Mentions Légales
                            </a>
                        </div>

                        <hr class="my-4 opacity-25">
                        <button type="submit" class="btn btn-primary w-100 fw-medium shadow-sm">
                            <i class="ri-save-line me-1"></i> Enregistrer
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="settings-content tab-content" id="v-pills-tabContent">
                        
                        <!-- Taxes Tab -->
                        <div class="tab-pane fade show active" id="v-pills-taxes" role="tabpanel">
                            <div class="settings-header">
                                <h5 class="mb-1">Taxes & Fiscalité</h5>
                                <p class="text-muted mb-0 small">Gérez les taux de TVA applicables.</p>
                            </div>
                            <div class="settings-body">
                                <div class="row">
                                    <div class="col-md-6 form-group-custom">
                                        <label class="form-label-custom">Taux par défaut</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="default_tva_percent" value="{{ config.default_tva_percent|stringformat:'f' }}" step="0.01" min="0">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <p class="form-text-custom">Appliqué automatiquement aux nouveaux devis.</p>
                                    </div>
                                    <div class="col-md-6 form-group-custom">
                                        <label class="form-label-custom">Affichage</label>
                                        <div class="config-strip">
                                            <span class="small fw-medium">Sur Devis</span>
                                            <div class="form-check form-switch m-0">
                                                <input class="form-check-input" type="checkbox" name="show_tva_on_devis" {% if config.show_tva_on_devis %}checked{% endif %}>
                                            </div>
                                        </div>
                                        <div class="config-strip">
                                            <span class="small fw-medium">Sur Factures</span>
                                            <div class="form-check form-switch m-0">
                                                <input class="form-check-input" type="checkbox" name="show_tva_on_facture" {% if config.show_tva_on_facture %}checked{% endif %}>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="border-dashed my-4">
                                <h6 class="fw-bold mb-3 small text-uppercase text-muted">Taux configurés</h6>
                                
                                <div class="table-responsive border rounded-3 mb-3">
                                    <table class="table table-sm align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="ps-3 py-2">Libellé</th>
                                                <th>Valeur</th>
                                                <th class="text-end pe-3">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for tva in tvas %}
                                            <tr>
                                                <td class="ps-3 fw-medium">{{ tva.label }}</td>
                                                <td><span class="badge bg-light text-dark border">{{ tva.valeur }}%</span></td>
                                                <td class="text-end pe-3">
                                                    <button type="button" class="btn btn-sm btn-ghost-danger text-danger p-0" onclick="deleteTva({{ tva.id }})" title="Supprimer">
                                                        <i class="ri-delete-bin-line fs-16"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="3" class="text-center text-muted py-3 small">Aucun taux additionnel.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="bg-light p-3 rounded-3">
                                    <label class="small fw-bold mb-2">Ajouter un taux</label>
                                    <div class="row g-2">
                                        <div class="col-5">
                                            <input type="text" class="form-control form-control-sm" id="new_tva_label" placeholder="Libellé (ex: Réduit)">
                                        </div>
                                        <div class="col-4">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="new_tva_valeur" placeholder="0" step="0.01">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <button type="button" class="btn btn-sm btn-secondary w-100" onclick="addTva()">Ajouter</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Tab -->
                        <div class="tab-pane fade" id="v-pills-docs" role="tabpanel">
                            <div class="settings-header">
                                <h5 class="mb-1">Documents & Numérotation</h5>
                                <p class="text-muted mb-0 small">Formats des numéros de devis et factures.</p>
                            </div>
                            <div class="settings-body">
                                <div class="row">
                                    <div class="col-md-12 mb-4">
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <div class="avatar-xs bg-soft-info text-info rounded-circle d-flex align-items-center justify-content-center">
                                                <i class="ri-hashtag"></i>
                                            </div>
                                            <h6 class="mb-0 fw-bold">Devis</h6>
                                        </div>
                                        <div class="row g-3 ms-1 border-start ps-4">
                                            <div class="col-md-5">
                                                <label class="form-label text-muted small">Préfixe</label>
                                                <input type="text" class="form-control" name="devis_prefix" value="{{ config.devis_prefix|default:'DEV' }}">
                                            </div>
                                            <div class="col-md-5">
                                                <label class="form-label text-muted small">Largeur Compteur</label>
                                                <input type="number" class="form-control" name="devis_counter_width" value="{{ config.devis_counter_width|default:4 }}">
                                            </div>
                                            <div class="col-12">
                                                <small class="text-muted">Aperçu : <span class="fw-bold text-dark">{{ config.devis_prefix|default:'DEV' }}-0001</span></small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <div class="avatar-xs bg-soft-success text-success rounded-circle d-flex align-items-center justify-content-center">
                                                <i class="ri-article-line"></i>
                                            </div>
                                            <h6 class="mb-0 fw-bold">Facture</h6>
                                        </div>
                                        <div class="row g-3 ms-1 border-start ps-4">
                                            <div class="col-md-5">
                                                <label class="form-label text-muted small">Préfixe</label>
                                                <input type="text" class="form-control" name="facture_prefix" value="{{ config.facture_prefix|default:'FAC' }}">
                                            </div>
                                            <div class="col-md-5">
                                                <label class="form-label text-muted small">Largeur Compteur</label>
                                                <input type="number" class="form-control" name="facture_counter_width" value="{{ config.facture_counter_width|default:4 }}">
                                            </div>
                                            <div class="col-12">
                                                <small class="text-muted">Aperçu : <span class="fw-bold text-dark">{{ config.facture_prefix|default:'FAC' }}-0001</span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Offers Tab -->
                        <div class="tab-pane fade" id="v-pills-offers" role="tabpanel">
                            <div class="settings-header">
                                <h5 class="mb-1">Offres & Remises</h5>
                                <p class="text-muted mb-0 small">Configuration des réductions commerciales.</p>
                            </div>
                            <div class="settings-body">
                                <div class="config-strip bg-soft-warning border-warning border-opacity-25">
                                    <div>
                                        <h6 class="fw-bold mb-1 text-dark">Activer les remises</h6>
                                        <small class="text-muted">Permet d'appliquer des réductions sur les devis.</small>
                                    </div>
                                    <div class="form-check form-switch m-0">
                                        <input class="form-check-input" type="checkbox" name="enable_remise_global" id="enableRemiseGlobal" {% if config.enable_remise_global %}checked{% endif %}>
                                    </div>
                                </div>

                                <div id="remiseSettings" class="{% if not config.enable_remise_global %}d-none{% endif %} mt-4">
                                    <div class="form-group-custom">
                                        <label class="form-label-custom">Remise standard (%)</label>
                                        <div class="input-group" style="max-width: 200px;">
                                            <input type="number" class="form-control fw-bold" name="default_remise_percent" value="{{ config.default_remise_percent|stringformat:'f' }}" step="0.01">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>

                                    <h6 class="small text-uppercase text-muted fw-bold mt-4 mb-3">Visibilité</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="config-strip">
                                                <span class="font-size-14">Sur Devis</span>
                                                <div class="form-check ms-auto">
                                                    <input class="form-check-input scale-125" type="checkbox" name="show_remise_on_devis" {% if config.show_remise_on_devis %}checked{% endif %}>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="config-strip">
                                                <span class="font-size-14">Sur Facture</span>
                                                <div class="form-check ms-auto">
                                                    <input class="form-check-input scale-125" type="checkbox" name="show_remise_on_facture" {% if config.show_remise_on_facture %}checked{% endif %}>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mentions Tab -->
                        <div class="tab-pane fade" id="v-pills-mentions" role="tabpanel">
                            <div class="settings-header">
                                <h5 class="mb-1">Mentions Légales</h5>
                                <p class="text-muted mb-0 small">Textes par défaut sur les documents.</p>
                            </div>
                            <div class="settings-body">
                                <div class="form-group-custom">
                                    <label class="form-label-custom">Conditions Commerciales</label>
                                    <textarea class="form-control bg-light border-0" name="default_conditions_commerciales" rows="5" placeholder="Validité, Acomptes...">{{ config.default_conditions_commerciales|default:'' }}</textarea>
                                    <p class="form-text-custom">Ajouté automatiquement en bas des devis.</p>
                                </div>

                                <div class="form-group-custom">
                                    <label class="form-label-custom">Instructions de Paiement</label>
                                    <textarea class="form-control bg-light border-0" name="payment_methods" rows="4" placeholder="RIB, Banque...">{{ config.payment_methods }}</textarea>
                                    <p class="form-text-custom">Ajouté en bas des factures (RIB, Iban, etc).</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleRemise = document.getElementById('enableRemiseGlobal');
        const settingsContainer = document.getElementById('remiseSettings');
        
        toggleRemise.addEventListener('change', function() {
            if (this.checked) {
                settingsContainer.classList.remove('d-none');
            } else {
                settingsContainer.classList.add('d-none');
            }
        });
    });

    function addTva() {
        const label = document.getElementById('new_tva_label').value;
        const valeur = document.getElementById('new_tva_valeur').value;
        
        if (!label || !valeur) {
            alertify.error('Veuillez remplir le libellé et la valeur.');
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        const csrf = document.createElement('input');
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);
        
        const action = document.createElement('input');
        action.name = 'action';
        action.value = 'add_tva';
        form.appendChild(action);
        
        const l = document.createElement('input');
        l.name = 'tva_label';
        l.value = label;
        form.appendChild(l);
        
        const v = document.createElement('input');
        v.name = 'tva_valeur';
        v.value = valeur;
        form.appendChild(v);

        const ent = document.createElement('input');
        ent.name = 'enterprise_id';
        ent.value = '{{ current_enterprise.id|default:"" }}';
        form.appendChild(ent);
        
        document.body.appendChild(form);
        form.submit();
    }

    function deleteTva(id) {
        // Simple implementation for immediate deletion via form post
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        const csrf = document.createElement('input');
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);
        
        const action = document.createElement('input');
        action.name = 'action';
        action.value = 'delete_tva';
        form.appendChild(action);
        
        const tid = document.createElement('input');
        tid.name = 'tva_id';
        tid.value = id;
        form.appendChild(tid);

        const ent = document.createElement('input');
        ent.name = 'enterprise_id';
        ent.value = '{{ current_enterprise.id|default:"" }}';
        form.appendChild(ent);
        
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock content %}
