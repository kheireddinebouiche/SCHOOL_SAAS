{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Conseil - Configurer devis {% endblock title %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #3b7ddd;
        --primary-soft: #eef2fb;
        --secondary-color: #405189;
        --text-muted: #878a99;
        --border-color: #e9ebec;
        --card-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }

    .main-content {
        background-color: #f3f6f9;
        min-height: 100vh;
    }

    .card-premium {
        border: none;
        box-shadow: var(--card-shadow);
        border-radius: 12px;
        background: #fff;
        margin-bottom: 1.5rem;
    }

    .card-header-premium {
        background: linear-gradient(135deg, #3b7ddd 0%, #326bc9 100%);
        padding: 1.25rem 1.5rem;
        border-bottom: none;
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .section-title-premium {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-control-premium, .form-select-premium {
        border: 1px solid var(--border-color);
        padding: 0.6rem 1rem;
        font-size: 14px;
        border-radius: 8px;
        transition: all 0.2s;
        background-color: #fff;
    }

    .form-control-premium:focus, .form-select-premium:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
        outline: none;
    }

    /* Items Table */
    .table-premium thead th {
        background-color: #f8fafb;
        color: #495057;
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        padding: 12px 15px;
        border-bottom: 2px solid #eff2f7;
    }

    .table-premium tbody td {
        padding: 15px;
        border-bottom: 1px solid #eff2f7;
        vertical-align: middle;
        font-size: 14px;
    }

    .item-row:hover {
        background-color: #f9fbfd;
    }

    /* Summary Card */
    .summary-card-premium {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        position: sticky;
        top: 90px;
    }

    .total-row-premium {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: 500;
        color: #495057;
    }

    .total-main-premium {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px dashed #eff2f7;
        font-size: 22px;
        font-weight: 800;
        color: var(--primary-color);
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }

    .btn-premium-action {
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-premium-primary {
        background-color: var(--primary-color);
        border: none;
        color: white;
    }

    .btn-premium-primary:hover {
        background-color: #326bc9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 125, 221, 0.2);
        color: white;
    }

    .input-row-premium {
        background-color: #f8fafc;
        border-top: 2px solid #eff2f7;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            
            <!-- Page Header -->
            <div class="row mb-4 align-items-center">
                <div class="col">
                    <h4 class="mb-0 fw-bold text-dark">Configuration du Devis</h4>
                    <p class="text-muted mb-0 fs-13">Référence : #{{ devis.num_devis }} | Client : {{ devis.client.nom }} {{ devis.client.prenom }}</p>
                </div>
                <div class="col-auto d-flex gap-2">
                    <button class="btn btn-light btn-premium-action border" id="previewBtn">
                        <i class="ri-eye-line"></i> Aperçu
                    </button>
                    {% if can_edit %}
                    <button class="btn btn-premium-primary btn-premium-action" id="saveBtn">
                        <i class="ri-save-3-line"></i> Enregistrer
                    </button>
                    <button class="btn btn-success btn-premium-action shadow-sm" id="validateDevisBtn">
                        <i class="ri-checkbox-circle-line"></i> Valider le Devis
                    </button>
                    {% else %}
                    <span class="badge bg-soft-success text-success fs-14 p-2 px-3 border border-success border-opacity-25 d-flex align-items-center gap-2">
                        <i class="ri-checkbox-circle-fill"></i> DEVIS VALIDÉ
                    </span>
                    <a href="{% url 't_conseil:DetailsDevis' devis.num_devis %}" class="btn btn-primary btn-premium-action">
                        <i class="ri-article-line"></i> Voir les détails
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="row g-4">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Global Info Card -->
                    <div class="card-premium">
                        <div class="card-body p-4">
                            <h6 class="section-title-premium"><i class="ri-information-line"></i> Informations Générales</h6>
                            <div class="row g-3">
                                <div class="col-md-7">
                                    <label class="form-label fs-12 fw-bold text-muted text-uppercase mb-1">Entreprise émettrice</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="ri-building-line text-muted"></i></span>
                                        <select class="form-select form-select-premium border-start-0 ps-0" id="devisEnterprise" {% if not can_edit %}disabled{% endif %}>
                                            <option value="">-- Non définie --</option>
                                            {% for ent in enterprises %}
                                            <option value="{{ ent.id }}" {% if devis.entreprise.id == ent.id %}selected{% endif %}>{{ ent.designation }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label fs-12 fw-bold text-muted text-uppercase mb-1">Date émission</label>
                                            <div class="form-control form-control-premium bg-light text-center">{{ devis.date_emission|date:"d/m/Y" }}</div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label fs-12 fw-bold text-muted text-uppercase mb-1">Date échéance</label>
                                            <div class="form-control form-control-premium bg-light text-center text-danger">{{ devis.date_echeance|date:"d/m/Y" }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Card -->
                    <div class="card-premium">
                        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center p-4 pb-0">
                            <h6 class="section-title-premium mb-0"><i class="ri-list-settings-line"></i> Prestations & Articles</h6>
                            {% if devis.etat == 'brouillon' %}
                            <button class="btn btn-sm btn-outline-danger px-3 rounded-pill" id="btnDeleteItems">
                                <i class="ri-delete-bin-line"></i> Vider tout
                            </button>
                            {% endif %}
                        </div>
                        <div class="card-body p-0 mt-3">
                            <div class="table-responsive">
                                <table class="table table-premium mb-0">
                                    <thead>
                                        <tr>
                                        <th style="width: 35%;">Service / Designation</th>
                                        <th style="width: 10%;" class="text-center">Quantité</th>
                                        <th style="width: 15%;" class="text-end">Prix Unitaire HT</th>
                                        <th style="width: 10%;" class="text-center col-remise">Remise (%)</th>
                                        <th style="width: 10%;" class="text-center col-tva">TVA</th>
                                        <th style="width: 15%;" class="text-end">Total HT</th>
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="itemsContainer">
                                    <!-- Items will be injected here -->
                                </tbody>
                                <tfoot class="bg-light item-row" id="newItemRow">
                                    <tr>
                                        <td>
                                            <div class="d-flex flex-column gap-2">
                                                <select class="form-select form-select-premium" id="newThematique">
                                                    <option value="">-- Sélectionner --</option>
                                                </select>
                                                <input type="text" class="form-control form-control-premium fs-12" id="newDesignation" placeholder="Désignation personnalisée (Optionnel)">
                                                <textarea class="form-control form-control-premium fs-12" id="newLongDescription" rows="2" placeholder="Description détaillée (Optionnel)"></textarea>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-premium text-center" id="newQty" value="1" min="1">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-premium text-end" id="newPrice" value="0.00" step="0.01">
                                        </td>
                                        <td class="col-remise">
                                            <input type="number" class="form-control form-control-premium text-center" id="newRemise" value="0" min="0" max="100">
                                        </td>
                                        <td class="col-tva">
                                            <select class="form-select form-select-premium text-center" id="newTva" {% if not can_edit %}disabled{% endif %}>
                                                {% for tva in tvas %}
                                                <option value="{{ tva.valeur|stringformat:'f' }}" {% if tva.is_default %}selected{% endif %}>{{ tva.valeur }}%</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="text-end">
                                            <div class="fw-bold text-primary" id="newRowTotal">0.00</div>
                                            <div class="fs-10 text-muted">DZA</div>
                                        </td>
                                            <td class="text-center">
                                                <button class="btn btn-primary rounded-circle shadow-sm" id="addItemBtn" style="width: 40px; height: 40px; padding: 0;" {% if not can_edit %}disabled{% endif %}>
                                                    <i class="ri-add-line fs-18"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <style>
                        @keyframes pulse-warning {
                            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
                            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
                            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
                        }
                        .pulse-animation {
                            animation: pulse-warning 2s infinite;
                        }
                    </style>

                    <!-- Commercial Conditions Card -->
                    <div class="card-premium mt-4">
                        <div class="card-body p-4">
                            <h6 class="section-title-premium"><i class="ri-file-text-line"></i> Conditions Commerciales</h6>
                            <p class="text-muted small mb-3">Ces conditions seront affichées en bas de votre devis.</p>
                            <textarea class="form-control form-control-premium" id="conditionsCommerciales" rows="4" placeholder="Saisissez les conditions spécifiques à ce devis..." {% if not can_edit %}readonly{% endif %}>{{ devis.conditions_commerciales|default:"" }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Summary Sidebar -->
                <div class="col-lg-4">
                    <div class="summary-card-premium">
                        <h6 class="section-title-premium mb-4"><i class="ri-calculator-line"></i> Récapitulatif Financier</h6>
                        
                        <div class="total-row-premium">
                            <span class="text-muted">Total Hors Taxes</span>
                            <span class="fw-bold fs-16" id="subTotal">0.00 DZA</span>
                        </div>

                        <div class="mt-4">
                            <div class="form-check form-switch d-flex justify-content-between align-items-center p-0 w-100 mb-2">
                                <label class="form-check-label text-muted fs-13" for="toggleTva">Afficher la TVA</label>
                                <input class="form-check-input ms-0" type="checkbox" id="toggleTva" {% if devis.show_tva %}checked{% endif %}>
                            </div>
                            <div class="form-check form-switch d-flex justify-content-between align-items-center p-0 w-100">
                                <label class="form-check-label text-muted fs-13" for="toggleRemise">Afficher la Remise</label>
                                <input class="form-check-input ms-0" type="checkbox" id="toggleRemise" {% if devis.show_remise %}checked{% endif %}>
                            </div>
                            <div id="tvaBreakdownContainer" class="mt-3">
                                <!-- TVAs -->
                            </div>
                        </div>

                        <div class="total-main-premium">
                            <div class="fs-13 text-muted fw-bold text-uppercase letter-spacing-1">NET À PAYER</div>
                            <div id="totalAmount">0.00 DZA</div>
                        </div>

                        <div class="mt-5 border-top pt-4">
                            <button class="btn btn-info w-100 btn-premium-action text-white mb-3" id="convertToInvoiceBtn">
                                <i class="ri-file-text-line"></i> CONVERTIR EN FACTURE
                            </button>
                            <div id="unsavedWarning" class="text-center text-danger small fw-bold mb-2" style="display: none;">
                                <i class="ri-alert-line"></i> Modifications non enregistrées
                            </div>
                            <div class="text-center">
                                <span class="badge bg-soft-primary text-primary px-3 py-2 rounded-pill fs-12">{{ devis.get_etat_display }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Conversion -->
<div class="modal fade" id="convertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header border-0 bg-primary text-white p-4">
                <h5 class="modal-title fw-bold"><i class="ri-exchange-line me-2"></i>Conversion en Facture</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                     <p class="text-muted fs-14 mb-0">Cette action génèrera une facture définitive basée sur les articles de ce devis.</p>
                     <input type="hidden" id="selectTvaConversion" value="{{ config.default_tva_percent|stringformat:'f' }}">
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary px-4 fw-bold shadow" id="confirmConversionBtn">Confirmer la transformation</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Validation -->
<div class="modal fade" id="validateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header border-0 bg-success text-white p-4">
                <h5 class="modal-title fw-bold"><i class="ri-checkbox-circle-line me-2"></i>Valider le Devis</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <i class="ri-mail-send-line text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="fw-bold mb-3">Êtes-vous sûr de vouloir valider ce devis ?</h6>
                <p class="text-muted mb-0">Une fois validé, vous ne pourrez plus le modifier. Il sera marqué comme "Envoyé" et prêt pour la facturation.</p>
            </div>
            <div class="modal-footer border-0 p-4 pt-0 justify-content-center">
                <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success px-4 fw-bold shadow" id="confirmValidationBtn">Oui, Valider le Devis</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let items = [];
        let thematiques = [];
        const devisId = "{{ devis.num_devis }}"; 
        const devisState = "{{ devis.etat }}";
        let hasUnsavedChanges = false;
        
        const convertBtn = document.getElementById('convertToInvoiceBtn');
        const validateBtn = document.getElementById('validateDevisBtn');
        const unsavedWarning = document.getElementById('unsavedWarning');

        const itemsContainer = document.getElementById('itemsContainer');
        const toggleTva = document.getElementById('toggleTva');
        const toggleRemise = document.getElementById('toggleRemise');
        const newThematique = document.getElementById('newThematique');
        const newDesignation = document.getElementById('newDesignation');
        const newLongDescription = document.getElementById('newLongDescription');
        const newQty = document.getElementById('newQty');
        const newPrice = document.getElementById('newPrice');
        const newRemise = document.getElementById('newRemise');
        const newTva = document.getElementById('newTva');
        const newRowTotal = document.getElementById('newRowTotal');
        const addItemBtn = document.getElementById('addItemBtn');

        // Styles logic for badge-like display tag
        const getTvaBadge = (rate) => `<span class="badge bg-light text-muted border px-2 py-1 fs-10">${parseFloat(rate)}%</span>`;

        // Initial Toggle State Application
        function applyColumnVisibility() {
            const showTva = document.getElementById('toggleTva').checked;
            const showRemise = document.getElementById('toggleRemise').checked;

            // Headers
            document.querySelectorAll('.col-tva').forEach(el => el.style.display = showTva ? '' : 'none');
            document.querySelectorAll('.col-remise').forEach(el => el.style.display = showRemise ? '' : 'none');
        }

        // Toggle Events
        document.getElementById('toggleTva').addEventListener('change', applyColumnVisibility);
        document.getElementById('toggleRemise').addEventListener('change', applyColumnVisibility);

        // Initial call
        applyColumnVisibility();
        updateConvertButtonState();

        // Load Services
        fetch("{% url 't_conseil:ApiLoadThematique' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            thematiques = data;
            data.forEach(t => {
                const opt = new Option(t.label, t.id);
                opt.dataset.price = t.prix;
                opt.dataset.tva = t.default_tva;
                newThematique.add(opt);
            });
        });

        // Helper for safe parsing
        const parseMoney = (val) => {
             if(!val) return 0;
             // Handle '1 000,00' or '1,000.00'
             let v = val.toString().replace(/\s/g, '').replace(',', '.');
             return parseFloat(v) || 0;
        }

        // Load Initial State
        {% for l in lignes_devis %}
        items.push({
            id: {{ l.id }},
            thematique_id: "{{ l.thematique.id|default:'' }}",
            description: "{{ l.description|escapejs }}",
            long_description: "{{ l.long_description|default:''|escapejs }}",
            quantity: parseMoney("{{ l.quantite|floatformat:2 }}"),
            unitPrice: parseMoney("{{ l.montant|floatformat:2 }}") / (parseMoney("{{ l.quantite|floatformat:2 }}") || 1),
            remise_percent: parseMoney("{{ l.remise_percent|floatformat:2 }}"),
            tva_percent: parseMoney("{{ l.tva_percent|floatformat:2 }}") || 0,
            total: parseMoney("{{ l.montant|floatformat:2 }}")
        });
        {% endfor %}
        
        let editingIndex = -1; // Track which item is being edited
        renderItems();

        newThematique.addEventListener('change', function() {
            const tId = this.value;
            if(!tId) return;
            const th = thematiques.find(x => x.id == tId);
            if(th) {
                newDesignation.value = th.label;
                newPrice.value = th.prix;
                newTva.value = parseFloat(th.default_tva).toFixed(6); // Set pre-calculated decimal
                newLongDescription.value = th.description || ""; // Pre-fill description
                // Trigger updates
                updateInputRowTotal();
            }
        });

        [newQty, newPrice, newRemise, newTva].forEach(el => {
            if(el) el.addEventListener('input', updateInputRowTotal);
        });
        
        // Use a flag to prevent initial load from triggering dirty state if needed
        // But here we attach listeners after initial render, so it should be fine.
        
        if(toggleTva) toggleTva.addEventListener('change', () => { updateTotals(); setDirty(true); });
        if(toggleRemise) toggleRemise.addEventListener('change', () => { updateTotals(); setDirty(true); });

        const saveBtn = document.getElementById('saveBtn');

        function setDirty(isDirty) {
            hasUnsavedChanges = isDirty;
            updateConvertButtonState();
            
            if(saveBtn) {
                if(isDirty) {
                    saveBtn.classList.remove('btn-premium-primary');
                    saveBtn.classList.add('btn-warning', 'shadow-lg', 'pulse-animation');
                    saveBtn.innerHTML = '<i class="ri-save-3-fill"></i> Enregistrer *';
                } else {
                    saveBtn.classList.add('btn-premium-primary');
                    saveBtn.classList.remove('btn-warning', 'shadow-lg', 'pulse-animation');
                    saveBtn.innerHTML = '<i class="ri-save-3-line"></i> Enregistrer';
                }
            }
        }



        function updateConvertButtonState() {
            const isEmpty = items.length === 0;
            const isBlocked = hasUnsavedChanges || isEmpty;
            
            // Handle Convert Button
            if(convertBtn) {
                if (isBlocked) {
                    convertBtn.disabled = true;
                    convertBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else if(devisState === 'brouillon') {
                     // Block if not validated (still draft)
                    convertBtn.disabled = true;
                    convertBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    convertBtn.title = "Le devis doit être validé avant d'être converti.";
                } else {
                    convertBtn.disabled = false;
                    convertBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    convertBtn.title = "Convertir en Facture";
                }
            }
            
            // Handle Validate Button
            if(validateBtn) {
                 if (hasUnsavedChanges) { // Validation blocked only if unsaved changes (allow empty validation? No, probably should allow empty validation if business logic passes, but definitely block on dirty)
                    validateBtn.disabled = true;
                    validateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    validateBtn.title = "Veuillez enregistrer les modifications avant de valider.";
                } else {
                    validateBtn.disabled = false;
                    validateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    validateBtn.title = "";
                }
            }

            // Warning Message
            if(unsavedWarning) unsavedWarning.style.display = hasUnsavedChanges ? 'block' : 'none';
        }


        function updateInputRowTotal() {
            const q = parseFloat(newQty.value) || 0;
            const p = parseFloat(newPrice.value) || 0;
            const r = (parseFloat(newRemise.value) || 0); // Always calculate, visibility is just UI
            const base = q * p;
            const discounted = base * (1 - r/100);
            newRowTotal.textContent = discounted.toLocaleString('fr-FR', { minimumFractionDigits: 2 });
        }

        if(addItemBtn) {
            addItemBtn.addEventListener('click', () => {
                const d = newDesignation.value.trim();
                const longDesc = newLongDescription.value.trim();
                const q = parseFloat(newQty.value);
                const p = parseFloat(newPrice.value);
                const r = (parseFloat(newRemise.value) || 0);
                const tva = parseFloat(newTva ? newTva.value : 0) || 0;
                const tId = newThematique.value;

                if(!d && !tId) return alertify.error("Saisie invalide: Veuillez sélectionner une thématique ou entrer une désignation.");
                if(q <= 0 || p < 0) return alertify.error("Saisie invalide: Quantité ou prix unitaire incorrect.");

                const baseAt = q * p;
                const discountedAt = baseAt * (1 - r/100);

                const itemData = {
                    id: editingIndex > -1 ? items[editingIndex].id : Date.now(),
                    thematique_id: tId,
                    description: d || getTLab(tId),
                    long_description: longDesc,
                    quantity: q,
                    unitPrice: p,
                    remise_percent: r,
                    tva_percent: tva,
                    total: discountedAt
                };

                if(editingIndex > -1) {
                    items[editingIndex] = itemData;
                    editingIndex = -1;
                    addItemBtn.innerHTML = '<i class="ri-add-line fs-18"></i>';
                    addItemBtn.classList.remove('btn-warning');
                    addItemBtn.classList.add('btn-primary');
                } else {
                    items.push(itemData);
                }

                setDirty(true);
                renderItems();
                newThematique.value = ""; newDesignation.value=""; newLongDescription.value=""; newPrice.value="0.00"; newQty.value="1"; newRemise.value="0"; newRowTotal.textContent="0.00";
            });
        }
        
        window.editItem = (idx) => {
            const it = items[idx];
            editingIndex = idx;
            
            newThematique.value = it.thematique_id;
            newDesignation.value = it.description;
            newLongDescription.value = it.long_description || "";
            newQty.value = it.quantity;
            newPrice.value = it.unitPrice.toFixed(2);
            newRemise.value = it.remise_percent;
            if(newTva) newTva.value = it.tva_percent.toFixed(6);
            
            // Update UI
            addItemBtn.innerHTML = '<i class="ri-pencil-line fs-18"></i>';
            addItemBtn.classList.remove('btn-primary');
            addItemBtn.classList.add('btn-warning');
            
            updateInputRowTotal();
            document.getElementById('newItemRow').scrollIntoView({behavior: 'smooth'});
            setDirty(true);
        };

        function renderItems() {
            itemsContainer.innerHTML = '';
            items.forEach((it, idx) => {
                const tr = document.createElement('tr');
                tr.classList.add('item-row');
                tr.innerHTML = `
                    <td>
                        <div class="fw-bold text-dark">${it.description}</div>
                        ${it.long_description ? `<div class="text-muted small mt-1" style="white-space: pre-wrap;">${it.long_description}</div>` : ''}
                    </td>
                    <td class="text-center fw-bold text-dark">${it.quantity}</td>
                    <td class="text-end text-muted">${it.unitPrice.toFixed(2)}</td>
                    <td class="text-center text-danger col-remise">${it.remise_percent}%</td>
                    <td class="text-center col-tva">${getTvaBadge(it.tva_percent)}</td>
                    <td class="text-end fw-bold text-dark">${it.total.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="editItem(${idx})" {% if not can_edit %}disabled{% endif %}>
                            <i class="ri-pencil-line fs-18"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="removeItem(${idx})" {% if not can_edit %}disabled{% endif %}>
                            <i class="ri-delete-bin-line fs-18"></i>
                        </button>
                    </td>
                `;
                itemsContainer.appendChild(tr);
            });
            updateTotals();
            applyColumnVisibility(); // Apply visibility after rendering items
            updateConvertButtonState();
        }

        window.removeItem = (idx) => {
            if(editingIndex === idx) {
                // Cancel edit if deleting the item being edited
                editingIndex = -1;
                addItemBtn.innerHTML = '<i class="ri-add-line fs-18"></i>';
                addItemBtn.classList.remove('btn-warning');
                addItemBtn.classList.add('btn-primary');
                newThematique.value = ""; newDesignation.value=""; newLongDescription.value=""; newPrice.value="0.00"; newQty.value="1"; newRemise.value="0"; newRowTotal.textContent="0.00";
            } else if (editingIndex > idx) {
                editingIndex--; // Shift index if deleting item above
            }
            
            items.splice(idx, 1);
            setDirty(true);
            renderItems();
        };

        function getTLab(id) {
            const x = thematiques.find(z => z.id == id);
            return x ? x.label : 'SERVICE';
        }

        function updateTotals() {
            const sub = items.reduce((a, c) => a + c.total, 0);
            const showTvaOnSummary = toggleTva.checked; // Use the checkbox state for summary
            const breakdown = document.getElementById('tvaBreakdownContainer');
            breakdown.innerHTML = '';
            let totalTva = 0;

            if(showTvaOnSummary) {
                const groups = {};
                items.forEach(i => {
                    const r = parseFloat(i.tva_percent);
                    const amt = i.total * (r/100);
                    const key = r.toFixed(2);
                    groups[key] = (groups[key] || 0) + amt;
                    totalTva += amt;
                });
                Object.entries(groups).forEach(([r, a]) => {
                    breakdown.innerHTML += `
                        <div class="d-flex justify-content-between mb-2 small text-muted">
                            <span>TVA (${parseFloat(r)}%)</span>
                            <span class="fw-medium">${a.toLocaleString('fr-FR', { minimumFractionDigits: 2 })} DZA</span>
                        </div>
                    `;
                });
            }

            document.getElementById('subTotal').textContent = sub.toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + ' DZA';
            document.getElementById('totalAmount').textContent = (sub + totalTva).toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + ' DZA';
        }

        if(saveBtn) {
            saveBtn.addEventListener('click', function() {
                if(!items.length) return alertify.warning("Aucun article");
                this.disabled = true;
                fetch("{% url 't_conseil:ApiSaveDevisItems' %}", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        devis_id: devisId, 
                        items: items, 
                        show_tva: document.getElementById('toggleTva').checked,
                        show_remise: document.getElementById('toggleRemise').checked,
                        entreprise_id: document.getElementById('devisEnterprise').value,
                        conditions_commerciales: document.getElementById('conditionsCommerciales').value
                    })
                }).then(r => r.json()).then(d => {
                    if(d.status === 'success') {
                        alertify.success(d.message);
                        setDirty(false);
                        setTimeout(() => location.reload(), 800);
                    } else {
                        alertify.error(d.message);
                        this.disabled = false;
                    }
                });
            });
        }

        const devisEnterprise = document.getElementById('devisEnterprise');
        if (devisEnterprise) {
            devisEnterprise.addEventListener('change', function() {
                const entId = this.value;
                if (!entId) return;

                fetch("{% url 't_conseil:ApiFetchEnterpriseTvas' %}?enterprise_id=" + entId, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Rebuild newTva select
                        if (newTva) {
                            newTva.innerHTML = '';
                            data.tvas.forEach(t => {
                                const opt = new Option(t.valeur + '%', t.valeur.toFixed(6));
                                if (t.is_default) opt.selected = true;
                                newTva.add(opt);
                            });
                        }
                    }
                });
            });
        }
    
        const btnDeleteItems = document.getElementById('btnDeleteItems');
        if(btnDeleteItems) {
            btnDeleteItems.addEventListener('click', () => {
                alertify.confirm("Vider le panier", "Êtes-vous sûr de vouloir supprimer tous les articles ?", () => {
                    items = [];
                    renderItems();
                }, null);
            });
        }

        if(convertBtn) {
            convertBtn.addEventListener('click', () => {
                const modalEl = document.getElementById('convertModal');
                if(modalEl) {
                    let modal = bootstrap.Modal.getInstance(modalEl);
                    if (!modal) {
                        modal = new bootstrap.Modal(modalEl);
                    }
                    modal.show();
                } else {
                    alert("Erreur: Le modal de conversion est introuvable.");
                }
            });
        }

        const confirmConversionBtn = document.getElementById('confirmConversionBtn');
        if(confirmConversionBtn) {
            confirmConversionBtn.addEventListener('click', function() {
                this.disabled = true;
                const fd = new FormData();
                fd.append('devis_id', devisId);
                fd.append('tva', document.getElementById('selectTvaConversion').value);
                fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                fetch("{% url 't_conseil:ApiStartTransformationDevisToFacture' %}", { 
                    method: 'POST', 
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: fd 
                })
                .then(r=>r.json()).then(d => {
                    if(d.status==='success') location.href="{% url 't_conseil:ListeDesFactures' %}";
                    else { alertify.error(d.message); this.disabled=false; }
                });
            });
        }

        // Validation Devis logic
        if(validateBtn) {
            validateBtn.addEventListener('click', function() {
                 const modalEl = document.getElementById('validateModal');
                 if(modalEl) {
                    let modal = bootstrap.Modal.getInstance(modalEl);
                    if (!modal) {
                        modal = new bootstrap.Modal(modalEl);
                    }
                    modal.show();
                 }
            });
        }

        const confirmValidationBtn = document.getElementById('confirmValidationBtn');
        if(confirmValidationBtn) {
            confirmValidationBtn.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="ri-loader-4-line ri-spin me-2"></i> Validation...';
                
                const formData = new FormData();
                formData.append('devis_id', devisId);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch("{% url 't_conseil:ApiValidateDevis' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                }).then(r => r.json()).then(d => {
                    if(d.status === 'success') {
                        alertify.success(d.message);
                        setTimeout(() => location.reload(), 800);
                    } else {
                        alertify.error(d.message);
                        this.disabled = false;
                        this.innerHTML = 'Oui, Valider le Devis';
                    }
                }).catch(err => {
                    console.error(err);
                    alertify.error("Une erreur est survenue.");
                    this.disabled = false;
                    this.innerHTML = 'Oui, Valider le Devis';
                });
            });
        }

    });
</script>
{% endblock content %}