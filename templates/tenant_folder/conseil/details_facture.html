{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Facture #{{ facture.num_facture }} {% endblock title %}

{% block content %}
<style>
    :root {
        --primary-color: #3b7ddd;
        --secondary-color: #405189;
        --text-muted: #878a99;
        --border-color: #e9ebec;
        --premium-bg: #f3f6f9;
    }

    .main-content {
        background-color: var(--premium-bg);
        min-height: 100vh;
    }

    .invoice-card-premium {
        border: none;
        box-shadow: 0 5px 25px rgba(0,0,0,0.05);
        border-radius: 16px;
        background: #fff;
        overflow: hidden;
    }

    .invoice-header-premium {
        background: linear-gradient(135deg, #3b7ddd 0%, #326bc9 100%);
        padding: 3rem;
        color: white;
    }

    .premium-badge {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        padding: 6px 16px;
        border-radius: 30px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .invoice-body-premium {
        padding: 3rem;
    }

    .premium-info-label {
        font-size: 11px;
        font-weight: 800;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        display: block;
    }

    .premium-info-value {
        font-weight: 700;
        color: #495057;
        font-size: 16px;
        margin-bottom: 0;
    }

    .table-premium-details {
        width: 100%;
        margin: 2.5rem 0;
    }

    .table-premium-details th {
        background: #f8fafb;
        color: #495057;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        padding: 15px;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #eff2f7;
    }

    .table-premium-details td {
        padding: 20px 15px;
        border-bottom: 1px solid #eff2f7;
        vertical-align: top;
    }

    .summary-box-premium {
        background: #f8fafb;
        border-radius: 12px;
        padding: 2rem;
    }

    .summary-row-premium {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 14px;
        color: #495057;
    }

    .total-main-bold {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px dashed #e9ebec;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .total-amount-display {
        font-size: 28px;
        font-weight: 900;
        color: var(--primary-color);
    }

    @media print {
        .no-print { display: none !important; }
        .main-content { padding: 0 !important; background: white !important; }
        .invoice-card-premium { box-shadow: none !important; border: 1px solid #eee !important; }
        .invoice-header-premium { background: #3b7ddd !important; -webkit-print-color-adjust: exact; }
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Top Actions -->
            <div class="row mb-4 no-print align-items-center">
                <div class="col">
                    <h5 class="mb-0 fw-bold text-dark">Détails de la Facture</h5>
                </div>
                <div class="col-auto d-flex gap-2">
                    <button class="btn btn-primary px-4 shadow" onclick="window.print()">
                        <i class="ri-printer-line me-2"></i> Imprimer / PDF
                    </button>
                    {% if facture.etat == 'envoye' %}
                    <button class="btn btn-warning px-4" id="btnRevertFacture">
                        <i class="ri-refresh-line me-2"></i> Rendre en brouillon
                    </button>
                    {% endif %}
                    
                    {% if facture.etat == 'brouillon' %}
                    <a href="{% url 't_conseil:configure-facture' facture.num_facture %}" class="btn btn-outline-secondary px-4">
                        <i class="ri-edit-line me-2"></i> Modifier
                    </a>
                    {% endif %}

                    {% if facture.etat != 'brouillon' and facture.etat != 'annule' and facture.etat != 'paye' %}
                    <button class="btn btn-success px-4" onclick="openPaymentModal()">
                        <i class="ri-hand-coin-line me-2"></i> Saisir Paiement
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-xl-10">
                    <div class="invoice-card-premium">
                        <!-- Header Section -->
                        <div class="invoice-header-premium d-flex justify-content-between align-items-start">
                            <div>
                                <span class="premium-badge mb-3 d-inline-block">Facture Client</span>
                                <h1 class="text-white fw-bold mb-1 display-5">FACTURE #{{ facture.num_facture }}</h1>
                                <p class="mb-0 opacity-75 fw-medium">Émise le {{ facture.date_emission|date:"d F Y" }}</p>
                                {% if facture.devis_source %}
                                <p class="mb-0 opacity-75 fw-medium mt-1"><i class="ri-file-list-3-line me-1"></i>Ref. Devis: {{ facture.devis_source.num_devis }}</p>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                {% if tenant.logo %}
                                    <img src="{{ tenant.logo.url }}" alt="Logo" height="50" class="mb-3" style="filter: brightness(0) invert(1);">
                                {% else %}
                                    <h2 class="text-white fw-bold mb-3">{{ tenant.nom|default:"SALDAE" }}</h2>
                                {% endif %}
                                <div class="badge bg-white text-primary px-3 py-2 rounded-pill fw-bold">
                                    {{ facture.get_etat_display|upper }}
                                </div>
                            </div>
                        </div>

                        <div class="invoice-body-premium">
                            <!-- Info Grid -->
                            <div class="row g-5 mb-4">
                                <div class="col-md-4">
                                    <span class="premium-info-label">ÉMETTEUR</span>
                                    <p class="premium-info-value mb-1">{{ facture.entreprise.designation|default:tenant.nom }}</p>
                                    <div class="text-muted small">
                                        {{ facture.entreprise.adresse|default:tenant.adresse }}<br>
                                        {{ facture.entreprise.telephone|default:tenant.telephone }}<br>
                                        {{ facture.entreprise.email|default:"" }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <span class="premium-info-label">CLIENT</span>
                                    <p class="premium-info-value mb-1">{{ facture.client.nom }} {{ facture.client.prenom }}</p>
                                    <div class="text-muted small">
                                        {% if facture.client.entreprise %}<strong>{{ facture.client.entreprise }}</strong><br>{% endif %}
                                        {{ facture.client.adresse|default:"" }}<br>
                                        {{ facture.client.telephone|default:"-" }}
                                    </div>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <div class="mb-4">
                                        <span class="premium-info-label">DATE ÉCHÉANCE</span>
                                        <p class="fw-bold text-danger fs-5">{{ facture.date_echeance|date:"d F Y" }}</p>
                                    </div>
                                    {% if facture.mode_paiement %}
                                    <div>
                                        <span class="premium-info-label">MODE DE PAIEMENT</span>
                                        <p class="fw-bold text-dark">{{ facture.get_mode_paiement_display }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="table-responsive">
                                <table class="table-premium-details">
                                    <thead>
                                        <tr>
                                            <th style="width: 50%">Désignation</th>
                                            <th class="text-center">Qté</th>
                                            <th class="text-end">Prix Unit. HT</th>
                                            {% if facture.show_remise %}
                                            <th class="text-center">Remise</th>
                                            {% endif %}
                                            {% if facture.show_tva %}
                                            <th class="text-center">TVA</th>
                                            {% endif %}
                                            <th class="text-end">Total HT</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in lignes_facture %}
                                        <tr>
                                            <td>
                                                <div class="fw-bold text-dark fs-15">{{ item.description }}</div>
                                                {% if item.long_description %}
                                                <div class="text-muted small mt-1" style="white-space: pre-wrap;">{{ item.long_description }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center fw-bold text-dark">{{ item.quantite|floatformat:0 }}</td>
                                            <td class="text-end text-muted">{{ item.prix_unitaire|floatformat:2 }}</td>
                                            {% if facture.show_remise %}
                                            <td class="text-center text-danger fw-medium">{{ item.remise_percent|floatformat:0 }}%</td>
                                            {% endif %}
                                            {% if facture.show_tva %}
                                            <td class="text-center"><span class="badge bg-light text-dark">{{ item.tva_percent|floatformat:0 }}%</span></td>
                                            {% endif %}
                                            <td class="text-end fw-bold text-dark">{{ item.montant_ht|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Summary -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <h6 class="premium-info-label">CONDITIONS COMMERCIALES</h6>
                                    <p class="text-muted small">
                                        {{ facture.conditions_commerciales|linebreaksbr|default:"Aucune condition spécifique." }}
                                    </p>
                                </div>
                                <div class="col-md-5 ms-auto">
                                    <div class="summary-box-premium">
                                        <div class="summary-row-premium">
                                            <span class="text-muted fw-medium">Sous-total Hors Taxes</span>
                                            <span class="fw-bold text-dark">{{ total_ht|floatformat:2 }} DZA</span>
                                        </div>
                                        
                                        {% if facture.show_tva %}
                                        <div class="summary-row-premium">
                                            <span class="text-muted fw-medium">Total TVA</span>
                                            <span class="fw-bold text-muted">{{ total_tva|floatformat:2 }} DZA</span>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="total-main-bold">
                                            <div>
                                                <span class="premium-info-label mb-1">NET À PAYER</span>
                                                <p class="text-muted small mb-0">Montant total TTC</p>
                                            </div>
                                            <div class="total-amount-display">{{ facture.total_ttc|floatformat:2 }} DZA</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer -->
                            <div class="mt-5 pt-5 text-center border-top border-light">
                                <p class="mb-1 fw-bold text-dark">{{ tenant.nom|default:"Saldae Consulting" }}</p>
                                <p class="small text-muted mb-0">Document numérique généré via SALDAE ERP</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments History Section -->
            <div class="row justify-content-center mt-4 no-print">
                <div class="col-xl-10">
                    <div class="card shadow-sm border-0" style="border-radius: 16px;">
                        <div class="card-header bg-white border-bottom p-4">
                            <h5 class="mb-0 fw-bold"><i class="ri-history-line me-2 text-primary"></i>Historique des Paiements</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">Date</th>
                                            <th>Mode</th>
                                            <th>Référence</th>
                                            <th class="text-end pe-4">Montant</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTableBody">
                                        {% for p in facture.paiements.all %}
                                        <tr>
                                            <td class="ps-4">{{ p.date_paiement|date:"d/m/Y" }}</td>
                                            <td>{{ p.get_mode_paiement_display }}</td>
                                            <td>{{ p.reference|default:"-" }}</td>
                                            <td class="text-end pe-4 fw-bold text-success">{{ p.montant|floatformat:2 }} DZA</td>
                                        </tr>
                                        {% empty %}
                                        <tr id="emptyPaymentsRow">
                                            <td colspan="4" class="text-center py-4 text-muted">Aucun paiement enregistré pour le moment.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="ri-add-circle-line me-2"></i>Saisir un Paiement</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="paymentForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Montant du Paiement (DZA)</label>
                        <input type="number" step="0.01" class="form-control" id="payMontant" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Date</label>
                            <input type="date" class="form-control" id="payDate" value="{{ today|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Mode de Paiement</label>
                            <select class="form-select" id="payMode" required>
                                <option value="virement">Virement Bancaire</option>
                                <option value="cheque">Chèque</option>
                                <option value="espece">Espèces</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Référence (N° Chèque, etc.)</label>
                        <input type="text" class="form-control" id="payRef" placeholder="Optionnel">
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-bold">Note / Commentaire</label>
                        <textarea class="form-control" id="payNote" rows="2" placeholder="Optionnel"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success px-4" onclick="submitPayment()">Enregistrer le paiement</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Revert to Draft logic
        const revertBtn = document.getElementById('btnRevertFacture');
        if (revertBtn) {
            revertBtn.addEventListener('click', function() {
                alertify.confirm("Remettre en Brouillon", "Voulez-vous repasser cette facture en état de brouillon pour la modifier ?", 
                function() {
                    const formData = new FormData();
                    formData.append('facture_id', "{{ facture.num_facture }}");
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                    fetch("{% url 't_conseil:ApiRevertFactureToDraft' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    }).then(r => r.json()).then(d => {
                        if(d.status === 'success') {
                            alertify.success(d.message);
                            setTimeout(() => {
                                location.href = "{% url 't_conseil:configure-facture' facture.num_facture %}";
                            }, 800);
                        } else {
                            alertify.error(d.message);
                        }
                    });
                }, null).set('labels', {ok:'Confirmer', cancel:'Annuler'});
            });
        }
    });

    function openPaymentModal() {
        // Calculate remaining balance roughly (can be refined)
        const total = parseFloat("{{ facture.total_ttc }}".replace(',', '.'));
        let paid = 0;
        {% for p in facture.paiements.all %}
            paid += parseFloat("{{ p.montant }}".replace(',', '.'));
        {% endfor %}
        
        const remaining = total - paid;
        document.getElementById('payMontant').value = remaining > 0 ? remaining.toFixed(2) : 0;
        document.getElementById('payDate').value = new Date().toISOString().split('T')[0];
        
        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();
    }

    function submitPayment() {
        const montant = document.getElementById('payMontant').value;
        const date = document.getElementById('payDate').value;
        const mode = document.getElementById('payMode').value;
        const ref = document.getElementById('payRef').value;
        const note = document.getElementById('payNote').value;

        if(!montant || montant <= 0) {
            alertify.error("Veuillez saisir un montant valide.");
            return;
        }

        const formData = new FormData();
        formData.append('facture_id', "{{ facture.num_facture }}");
        formData.append('montant', montant);
        formData.append('date_paiement', date);
        formData.append('mode_paiement', mode);
        formData.append('reference', ref);
        formData.append('note', note);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 't_conseil:ApiAddPaiement' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                alertify.success(data.message);
                
                // Update Badge in UI
                const badge = document.querySelector('.badge.bg-white.text-primary');
                if(badge) badge.textContent = data.new_status.toUpperCase();
                
                // Add to table
                const tableBody = document.getElementById('paymentsTableBody');
                const emptyRow = document.getElementById('emptyPaymentsRow');
                if(emptyRow) emptyRow.remove();

                const modeLabel = document.getElementById('payMode').options[document.getElementById('payMode').selectedIndex].text;
                
                const newRow = `
                    <tr>
                        <td class="ps-4">${date.split('-').reverse().join('/')}</td>
                        <td>${modeLabel}</td>
                        <td>${ref || '-'}</td>
                        <td class="text-end pe-4 fw-bold text-success">${parseFloat(montant).toFixed(2)} DZA</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('afterbegin', newRow);

                // Close modal
                const modalEl = document.getElementById('paymentModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();

                // If fully paid, hide the button?
                // For simplicity, we can reload if partial payment logic gets too complex for status visibility, 
                // but let's stick to dynamic for now.
                if(data.new_status.toLowerCase() === 'payée') {
                     const payBtn = document.querySelector('button[onclick="openPaymentModal()"]');
                     if(payBtn) payBtn.remove();
                }

            } else {
                alertify.error(data.message);
            }
        });
    }
</script>
{% endblock %}
