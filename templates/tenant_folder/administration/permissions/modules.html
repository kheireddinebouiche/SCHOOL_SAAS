{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Administration - Modules{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }

  /* Module status badges */
  .status-active {
    background-color: #d4edda;
    color: #155724;
  }
  .status-inactive {
    background-color: #f8d7da;
    color: #721c24;
  }

  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }

  .table td.text-end {
    position: relative;
    overflow: visible;
  }

  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-cube text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Gestion des Modules</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Configuration</a>
                  </li>
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Administration</a>
                  </li>
                  <li class="breadcrumb-item active">Modules</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->
      
      <div class="row">
        <!-- KPIs Section -->
        <div class="col-12 mb-4">
          <div class="row g-3">
            <!-- Total Modules -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-cube-line text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Total Modules</h5>
                      <h3 class="mb-0 fw-bold" id="totalModules">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modules Actifs -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Actifs</h5>
                      <h3 class="mb-0 fw-bold" id="activeModules">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modules Inactifs -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-close-line text-warning fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Inactifs</h5>
                      <h3 class="mb-0 fw-bold" id="inactiveModules">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Types de Modules -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-apps-line text-info fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Types</h5>
                      <h3 class="mb-0 fw-bold" id="moduleTypes">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  <select id="filter-module-status" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les statuts</option>
                    <option value="active">Actifs</option>
                    <option value="inactive">Inactifs</option>
                  </select>

                  <select id="date_filter-module" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Trier par date</option>
                    <option value="-created_at">Date (récent)</option>
                    <option value="created_at">Date (ancien)</option>
                  </select>

                  <button id="addModuleBtn" type="button" class="btn btn-primary rounded-pill">
                    <i class="ri-add-line me-1"></i> Nouveau module
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <div class="table-responsive" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Nom</th>
                      <th class="border-0">Description</th>
                      <th class="border-0">Statut</th>
                      <th class="border-0">Date de création</th>
                      <th class="border-0">Dernière modification</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeModules" class="border-top-0">
                    <!-- Module rows will be populated by JavaScript -->
                  </tbody>
                </table>

                <!-- Empty state -->
                <div id="noModulesMessage" class="text-center py-5" style="display: none;">
                  <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                    <i class="ri-cube-line text-muted fs-1"></i>
                  </div>
                  <h5 class="mb-2">Aucun module trouvé</h5>
                  <p class="text-muted mb-4">Il n'y a aucun module enregistré pour le moment</p>
                  <button id="addModuleEmptyStateBtn" class="btn btn-primary">
                    <i class="ri-add-line me-1"></i> Créer un module
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade deleteModuleModal" tabindex="-1" role="dialog" aria-labelledby="deleteModuleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteModuleModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <div id="deleteModalMessage">
            <p class="text-muted mb-0">
              Vous êtes sur le point de supprimer ce module. Cette action est irréversible.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
            <i class="ri-close-line me-2"></i>Annuler
          </button>
          <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteModuleBtn">
            <i class="ri-delete-bin-line me-2"></i>Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de changement de statut -->
<div class="modal fade changeStatusModal" tabindex="-1" role="dialog" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-toggle-line text-warning fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-warning mb-1" id="changeStatusModalLabel">
              Confirmation de changement de statut
            </h5>
            <p class="text-muted small mb-0">Cette action modifiera le statut du module</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-toggle-line text-warning" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-warning mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0" id="statusChangeMessage">
            Vous êtes sur le point de changer le statut de ce module.
          </p>
          <div class="mt-3">
            <span id="currentStatus" class="badge bg-info">Statut actuel</span>
            <i class="fas fa-arrow-right mx-2"></i>
            <span id="newStatus" class="badge bg-success">Nouveau statut</span>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
            <i class="ri-close-line me-2"></i>Annuler
          </button>
          <button type="button" class="btn btn-warning px-4 py-2" id="confirmStatusChangeBtn">
            <i class="ri-check-line me-2"></i>Confirmer le changement
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour modification de module -->
<div id="updateModuleModal" class="modal fade" tabindex="-1" aria-labelledby="updateModuleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-cube-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="updateModuleModalLabel">
              Modification du module
            </h5>
            <p class="text-muted small mb-0">Mise à jour des informations du module</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="updateModuleForm">
          <input type="hidden" id="moduleId" name="id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-medium" for="updateModuleName">Nom du module</label>
              <select class="form-select border-0 bg-light py-2" id="updateModuleName" name="name" required>
                <option value="">Sélectionner un module</option>
                <option value="crm">CRM</option>
                <option value="ped">Pédagogie</option>
                <option value="eva">Evaluation</option>
                <option value="con">Conseil</option>
                <option value="adm">Administration</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" for="updateModuleStatus">Statut</label>
              <select class="form-select border-0 bg-light py-2" id="updateModuleStatus" name="is_active" required>
                <option value="1">Actif</option>
                <option value="0">Inactif</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-medium" for="updateModuleDescription">Description</label>
              <textarea class="form-control border-0 bg-light" id="updateModuleDescription" name="description" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="updateModuleBtn">
          <i class="ri-save-line me-2"></i>Enregistrer les modifications
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour ajout de module -->
<div id="addModuleModal" class="modal fade" tabindex="-1" aria-labelledby="addModuleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-add-box-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="addModuleModalLabel">
              Nouveau module
            </h5>
            <p class="text-muted small mb-0">Ajouter un nouveau module au système</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addModuleForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-medium" for="addModuleName">Nom du module</label>
              <select class="form-select border-0 bg-light py-2" id="addModuleName" name="name" required>
                <option value="">Sélectionner un module</option>
                <option value="crm">CRM</option>
                <option value="ped">Pédagogie</option>
                <option value="eva">Evaluation</option>
                <option value="con">Conseil</option>
                <option value="adm">Administration</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" for="addModuleStatus">Statut</label>
              <select class="form-select border-0 bg-light py-2" id="addModuleStatus" name="is_active" required>
                <option value="1">Actif</option>
                <option value="0">Inactif</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-medium" for="addModuleDescription">Description</label>
              <textarea class="form-control border-0 bg-light" id="addModuleDescription" name="description" rows="3" placeholder="Description du module (optionnelle)"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="saveNewModuleBtn">
          <i class="ri-add-line me-2"></i>Ajouter le module
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    // Load initial modules data (this would typically come from an API)
    function loadModules() {
      // Show loading state while fetching data
      $('#listeModules').empty();
      $('#noModulesMessage').hide();

      $.ajax({
        url : "{% url 'institut_app:ApiListeModules' %}",
        dataType: "JSON",
        type : "GET",
        success: function(data){
          var modules = data;

          var tbody = $('#listeModules');
          tbody.empty();

          var activeCount = 0;
          var inactiveCount = 0;

          if (modules.length === 0) {
            // Show empty state message
            $('#listeModules').hide();
            $('#noModulesMessage').show();
          } else {
            // Hide empty state message and show table
            $('#noModulesMessage').hide();
            $('#listeModules').show();

            modules.forEach(function(module) {
              if (module.is_active) {
                activeCount++;
              } else {
                inactiveCount++;
              }

              var statusClass = module.is_active ? 'status-active' : 'status-inactive';
              var statusText = module.is_active ? 'Actif' : 'Inactif';
              var statusIcon = module.is_active ? 'ri-check-line' : 'ri-close-line';

              var row = `
                <tr data-module-id="${module.id}">
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="ri-cube-line text-primary me-2"></i>
                      <div>
                        <span class="fw-semibold">${module.name}</span>
                      </div>
                    </div>
                  </td>
                  <td>${module.description || '--'}</td>
                  <td>
                    <span class="badge ${statusClass}">
                      <i class="${statusIcon} me-1"></i>
                      ${statusText}
                    </span>
                  </td>
                  <td>${module.created_at}</td>
                  <td>${module.updated_at}</td>
                  <td class="text-end">
                    <div class="dropdown d-inline-block">
                      <button class="btn btn-soft-primary btn-sm dropdown-toggle shadow-none" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        <i class="ri-more-2-fill"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-3 p-2" style="min-width: 200px;">
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 edit-module" data-module-id="${module.id}">
                            <i class="ri-edit-line text-primary me-2"></i>Modifier
                          </a>
                        </li>
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 toggle-status" data-module-id="${module.id}">
                            <i class="ri-toggle-line text-info me-2"></i>Changer statut
                          </a>
                        </li>
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 configure-permissions" data-module-id="${module.id}">
                            <i class="ri-settings-3-line text-warning me-2"></i>Configurer les permissions
                          </a>
                        </li>
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 view-permissions" data-module-id="${module.id}">
                            <i class="ri-list-check text-info me-2"></i>Liste des permissions
                          </a>
                        </li>
                        <li><hr class="dropdown-divider my-1"></li>
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 text-danger delete-module" data-module-id="${module.id}">
                            <i class="ri-delete-bin-line me-2"></i>Supprimer
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              `;
              tbody.append(row);
            });
          }

          // Update KPIs
          $('#totalModules').text(modules.length);
          $('#activeModules').text(activeCount);
          $('#inactiveModules').text(inactiveCount);
          $('#moduleTypes').text(modules.length);
        },
        error: function(xhr, status, error) {
          // In case of error, show empty state
          $('#listeModules').hide();
          $('#noModulesMessage').show();
          console.error("Error loading modules: " + error);
        }
      });
    }
    
    // Load modules on page load
    loadModules();
    
    // Handle table filtering
    $('#table-filter').on('input', function() {
      var searchTerm = $(this).val().toLowerCase();
      $('#listeModules tr').each(function() {
        var $row = $(this);
        var rowText = $row.text().toLowerCase();
        
        if (rowText.indexOf(searchTerm) > -1) {
          $row.show();
        } else {
          $row.hide();
        }
      });
    });
    
    // Handle status filter
    $('#filter-module-status').on('change', function() {
      var statusFilter = $(this).val();
      $('#listeModules tr').each(function() {
        var $row = $(this);
        var isActive = $row.find('span.status-active').length > 0;
        var isInactive = $row.find('span.status-inactive').length > 0;
        
        if (statusFilter === 'active') {
          if (isActive) {
            $row.show();
          } else {
            $row.hide();
          }
        } else if (statusFilter === 'inactive') {
          if (isInactive) {
            $row.show();
          } else {
            $row.hide();
          }
        } else {
          $row.show();
        }
      });
    });
    
    // Handle sort filter
    $('#date_filter-module').on('change', function() {
      // In a real implementation, you'd re-sort the data based on the selected option
    });

    // Handle edit module
    $(document).on('click', '.edit-module', function(e) {
      e.preventDefault();
      var moduleId = $(this).data('module-id');

      // Fetch the module details from the new ApiGetModuleDetails endpoint
      $.ajax({
        url: "{% url 'institut_app:ApiGetModuleDetails' %}",
        type: "GET",
        dataType: "JSON",
        data: {
          'id': moduleId
        },
        success: function(data) {
          if (data.status !== "error") {
            $('#moduleId').val(data.id);
            $('#updateModuleName').val(data.name);
            $('#updateModuleStatus').val(data.is_active ? '1' : '0');
            $('#updateModuleDescription').val(data.description || '');

            $('#updateModuleModal').modal('show');
          } else {
            alertify.error(data.message || "Module non trouvé");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error fetching module details:", error);
          alertify.error("Erreur lors de la récupération des détails du module");
        }
      });
    });

    // Handle delete module
    $(document).on('click', '.delete-module', function(e) {
      e.preventDefault();
      var moduleId = $(this).data('module-id');
      var $row = $(this).closest('tr');
      var moduleName = $row.find('span.fw-semibold').text();
      var moduleStatus = $row.find('span.status-active').length > 0 ? 'Actif' : 'Inactif';

      // Store the module ID for deletion confirmation
      $('.deleteModuleModal').data('module-id', moduleId);

      // Update the modal content based on module status
      if (moduleStatus === 'Actif') {
        $('#deleteModalMessage').html(`
          <p>Vous êtes sur le point de supprimer ce module <strong>"${moduleName}"</strong>.</p>
          <div class="alert alert-warning d-flex align-items-center mt-3">
            <i class="ri-error-warning-line fs-4 me-2"></i>
            <div>
              <strong>Attention!</strong> Ce module est actuellement <strong>actif</strong>.<br>
              Il est impossible de supprimer un module actif. Veuillez désactiver le module avant de le supprimer.
            </div>
          </div>
        `);
        $('#confirmDeleteModuleBtn').prop('disabled', true);
        $('#confirmDeleteModuleBtn').addClass('btn-disabled');
      } else {
        $('#deleteModalMessage').html(`
          <p>Vous êtes sur le point de supprimer ce module <strong>"${moduleName}"</strong>.</p>
          <p class="text-muted">Cette action est irréversible.</p>
        `);
        $('#confirmDeleteModuleBtn').prop('disabled', false);
        $('#confirmDeleteModuleBtn').removeClass('btn-disabled');
      }

      $('.deleteModuleModal').modal('show');
    });

    // Confirm delete module
    $('#confirmDeleteModuleBtn').on('click', function() {
      var moduleId = $('.deleteModuleModal').data('module-id');

      if ($('#confirmDeleteModuleBtn').prop('disabled')) {
        // If button is disabled, it means the module is active
        alertify.error("Ce module est actif et ne peut pas être supprimé.");
        return;
      }

      $.ajax({
        url: "{% url 'institut_app:ApiDeleteModule' %}",
        type: "POST",
        dataType: "JSON",
        data: {
          'id': moduleId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === "success") {
            alertify.success(response.message);
            $('.deleteModuleModal').modal('hide');
            loadModules();
          } else {
            alertify.error(response.message || "Erreur lors de la suppression du module");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error deleting module:", error);
          alertify.error("Une erreur est survenue lors de la suppression du module");
        }
      });
    });

    // Handle toggle status - Open confirmation modal
    $(document).on('click', '.toggle-status', function(e) {
      e.preventDefault();
      var moduleId = $(this).data('module-id');
      var $row = $(this).closest('tr');
      var currentStatus = $row.find('span.status-active, span.status-inactive').text().includes('Actif');
      var newStatus = currentStatus ? 'Inactif' : 'Actif';
      var newStatusValue = currentStatus ? '0' : '1';
      var moduleName = $row.find('span.fw-semibold').text();

      // Store the module info for the confirmation
      $('.changeStatusModal').data('module-id', moduleId);
      $('.changeStatusModal').data('new-status', newStatusValue);

      // Update the modal content
      $('#currentStatus').attr('class', currentStatus ? 'badge bg-success' : 'badge bg-danger')
                         .text(currentStatus ? 'Actif' : 'Inactif');
      $('#newStatus').attr('class', currentStatus ? 'badge bg-danger' : 'badge bg-success')
                     .text(currentStatus ? 'Inactif' : 'Actif');
      $('#statusChangeMessage').text(`Vous êtes sur le point de changer le statut du module "${moduleName}".`);

      // Show the modal
      $('.changeStatusModal').modal('show');
    });

    // Confirm status change
    $('#confirmStatusChangeBtn').on('click', function() {
      var moduleId = $('.changeStatusModal').data('module-id');
      var newStatus = $('.changeStatusModal').data('new-status');

      // Perform the status change via API
      $.ajax({
        url: "{% url 'institut_app:ApiChangeModuleStatus' %}",
        type: "POST",
        dataType: "JSON",
        data: {
          'id': moduleId,
          'is_active': newStatus,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === "success") {
            alertify.success(response.message);
            $('.changeStatusModal').modal('hide');
            loadModules(); // Reload the modules list to reflect changes
          } else {
            alertify.error(response.message || "Erreur lors de la mise à jour du statut");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error changing module status:", error);
          alertify.error("Une erreur est survenue lors de la mise à jour du statut");
        }
      });
    });

    $(document).on('click','#addModuleBtn', function(){
        $('#addModuleForm')[0].reset();
        $('#addModuleModal').modal('show');
    });

    // Handle add module form submission
    $(document).on('click','#saveNewModuleBtn', function() {
        var addModuleName = $('#addModuleName').val();
        var addModuleStatus = $('#addModuleStatus').val();
        var addModuleDescription = $('#addModuleDescription').val();

        $.ajax({
            url : "{% url 'institut_app:ApiAddModule' %}",
            dataType: "JSON",
            type : "POST",
            data : {
                'addModuleName' : addModuleName,
                'addModuleStatus' : addModuleStatus,
                'addModuleDescription' : addModuleDescription,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response){
                if (response.status === "success"){
                    alertify.success(response.message);
                    $('#addModuleModal').modal('hide');
                    loadModules();
                }else{
                    alertify.error(response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error adding module:", error);
                alertify.error("Une erreur est survenue lors de l'ajout du module");
            }
        });
    });

    // Handle update module form submission
    $('#updateModuleBtn').on('click', function() {
      var moduleId = $('#moduleId').val();
      var updateModuleName = $('#updateModuleName').val();
      var updateModuleStatus = $('#updateModuleStatus').val();
      var updateModuleDescription = $('#updateModuleDescription').val();

      $.ajax({
        url: "{% url 'institut_app:ApiUpdateModule' %}",
        type: "POST",
        dataType: "JSON",
        data: {
          'id': moduleId,
          'name': updateModuleName,
          'is_active': updateModuleStatus,
          'description': updateModuleDescription,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === "success") {
            alertify.success(response.message);
            $('#updateModuleModal').modal('hide');
            loadModules();
          } else {
            alertify.error(response.message || "Erreur lors de la mise à jour du module");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error updating module:", error);
          alertify.error("Une erreur est survenue lors de la mise à jour du module");
        }
      });
    });
  });
</script>

{% endblock content %}