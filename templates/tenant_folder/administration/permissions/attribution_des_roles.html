{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Administration - Attribution des rôles{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }

  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }

  .table td.text-end {
    position: relative;
    overflow: visible;
  }

  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }

  .role-badge {
    font-size: 0.8em;
  }

  .module-badge {
    background-color: #e7f1ff;
    color: #3b7ddd;
  }

  .user-badge {
    background-color: #e7f7ff;
    color: #1594ef;
  }

  .role-badge {
    background-color: #f0f9ff;
    color: #0d9488;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-user-tag text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Attribution des rôles</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Configuration</a>
                  </li>
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Administration</a>
                  </li>
                  <li class="breadcrumb-item active">Attribution des rôles</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row">
        <!-- KPIs Section -->
        <div class="col-12 mb-4">
          <div class="row g-3">
            <!-- Total Attributions -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-user-star-line text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Total Attributions</h5>
                      <h3 class="mb-0 fw-bold" id="totalAttributions">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Utilisateurs avec rôles -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-user-line text-success fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Utilisateurs avec rôles</h5>
                      <h3 class="mb-0 fw-bold" id="usersWithRoles">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modules configurés -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-apps-line text-warning fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Modules configurés</h5>
                      <h3 class="mb-0 fw-bold" id="configuredModules">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rôles attribués -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-shield-user-line text-info fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Rôles attribués</h5>
                      <h3 class="mb-0 fw-bold" id="assignedRoles">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  
                  <select id="filter-user" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les utilisateurs</option>
                  </select>

                  <select id="filter-module" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les modules</option>
                  </select>

                  <select id="filter-role" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les rôles</option>
                  </select>

                  <button id="addAttributionBtn" type="button" class="btn btn-primary rounded-pill">
                    <i class="ri-add-line me-1"></i> Nouvelle attribution
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <div class="table-responsive" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0 border rounded-3">
                  <thead class="table-light sticky-top">
                    <tr class="align-middle">
                      <th class="border-0 rounded-start ps-4 py-3">Utilisateur</th>
                      <th class="border-0 py-3">Module</th>
                      <th class="border-0 py-3">Rôle</th>
                      <th class="border-0 py-3">Assigné par</th>
                      <th class="border-0 py-3">Date d'attribution</th>
                      <th class="border-0 py-3">Dernière modification</th>
                      <th class="border-0 rounded-end text-center py-3">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeAttributions" class="border-top-0">
                    <!-- Attribution rows will be populated by JavaScript -->
                  </tbody>
                </table>

                <!-- Empty state -->
                <div id="noAttributionsMessage" class="text-center py-5" style="display: none;">
                  <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                    <i class="ri-user-star-line text-muted fs-1"></i>
                  </div>
                  <h5 class="mb-2">Aucune attribution trouvée</h5>
                  <p class="text-muted mb-4">Il n'y a aucune attribution de rôle enregistrée pour le moment</p>
                  <button id="addAttributionEmptyStateBtn" class="btn btn-primary">
                    <i class="ri-add-line me-1"></i> Créer une attribution
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal pour consultation des permissions -->
<div id="viewPermissionsModal" class="modal fade" tabindex="-1" aria-labelledby="viewPermissionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-shield-keyhole-line text-info fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-info mb-1" id="viewPermissionsModalLabel">
              Consultation des permissions
            </h5>
            <p class="text-muted small mb-0">Permissions du rôle <span id="roleNameForPermissionsView"></span> pour le module <span id="moduleNameForPermissionsView"></span></p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row g-4">
          <div class="col-md-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0 d-flex align-items-center">
                  <i class="ri-shield-user-line text-info me-2"></i>
                  Permissions du rôle
                </h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 40%;">Permission</th>
                        <th style="width: 40%;">Description</th>
                        <th class="text-center" style="width: 20%;">Module</th>
                      </tr>
                    </thead>
                    <tbody id="permissionsList">
                      <!-- Permissions will be loaded dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade deleteAttributionModal" tabindex="-1" role="dialog" aria-labelledby="deleteAttributionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteAttributionModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <div id="deleteModalMessage">
            <p class="text-muted mb-0">
              Vous êtes sur le point de supprimer cette attribution de rôle. Cette action est irréversible.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
            <i class="ri-close-line me-2"></i>Annuler
          </button>
          <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteAttributionBtn">
            <i class="ri-delete-bin-line me-2"></i>Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour modification d'attribution -->
<div id="updateAttributionModal" class="modal fade" tabindex="-1" aria-labelledby="updateAttributionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-edit-box-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="updateAttributionModalLabel">
              Modification de l'attribution
            </h5>
            <p class="text-muted small mb-0">Mettre à jour les informations de l'attribution</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="updateAttributionForm">
          <input type="hidden" id="attributionId" name="id">
          <div class="row g-4">
            <div class="col-12">
              <div class="card border-0 shadow-sm bg-light-subtle">
                <div class="card-body p-4">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold text-muted" for="updateAttributionUser">
                        <i class="ri-user-line text-primary me-1"></i>Utilisateur
                      </label>
                      <select class="form-select border-0 bg-white py-3 shadow-none" id="updateAttributionUser" name="user" required>
                        <option value="">Sélectionner un utilisateur</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-semibold text-muted" for="updateAttributionModule">
                        <i class="ri-apps-line text-info me-1"></i>Module
                      </label>
                      <select class="form-select border-0 bg-white py-3 shadow-none" id="updateAttributionModule" name="module" required>
                        <option value="">Sélectionner un module</option>
                        <!-- Les options seront chargées dynamiquement -->
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-semibold text-muted" for="updateAttributionRole">
                        <i class="ri-shield-user-line text-success me-1"></i>Rôle
                      </label>
                      <select class="form-select border-0 bg-white py-3 shadow-none" id="updateAttributionRole" name="role" required>
                        <option value="">Sélectionner un rôle</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-outline-secondary px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="updateAttributionBtn">
          <i class="ri-save-3-line me-2"></i>Enregistrer les modifications
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour ajout d'attribution -->
<div id="addAttributionModal" class="modal fade" tabindex="-1" aria-labelledby="addAttributionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-add-circle-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="addAttributionModalLabel">
              Nouvelle attribution
            </h5>
            <p class="text-muted small mb-0">Attribuer un rôle à un utilisateur pour un module</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addAttributionForm">
          <div class="row g-4">
            <div class="col-12">
              <div class="card border-0 shadow-sm bg-light-subtle">
                <div class="card-body p-4">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold text-muted" for="addAttributionUser">
                        <i class="ri-user-line text-primary me-1"></i>Utilisateur
                      </label>
                      <select class="form-select border-0 bg-white py-3 shadow-none" id="addAttributionUser" name="user" required>
                        <option value="">Sélectionner un utilisateur</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-semibold text-muted" for="addAttributionModule">
                        <i class="ri-apps-line text-info me-1"></i>Module
                      </label>
                      <select class="form-select border-0 bg-white py-3 shadow-none" id="addAttributionModule" name="module" required>
                        <option value="">Sélectionner un module</option>
                        <!-- Les options seront chargées dynamiquement -->
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-semibold text-muted" for="addAttributionRole">
                        <i class="ri-shield-user-line text-success me-1"></i>Rôle
                      </label>
                      <select class="form-select border-0 bg-white py-3 shadow-none" id="addAttributionRole" name="role" required>
                        <option value="">Sélectionner un rôle</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-outline-secondary px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="saveNewAttributionBtn">
          <i class="ri-add-circle-line me-2"></i>Attribuer le rôle
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    // Load initial attributions data
    function loadAttributions() {
      // Show loading state while fetching data
      $('#listeAttributions').empty();
      $('#noAttributionsMessage').hide();

      // Fetch data from the API
      $.ajax({
        url: "{% url 'institut_app:ApiListeAttributions' %}",
        type: "GET",
        dataType: "JSON",
        success: function(response) {
          var tbody = $('#listeAttributions');
          tbody.empty();

          if (response.status === 'success' && response.data && response.data.length > 0) {
            // Hide empty state message and show table
            $('#noAttributionsMessage').hide();
            $('#listeAttributions').show();

            response.data.forEach(function(attribution) {
              var userDisplay = attribution.user.first_name + ' ' + attribution.user.last_name + ' (' + attribution.user.username + ')';
              var moduleDisplay = attribution.module.name;
              var roleDisplay = attribution.role.name;
              var assignedByDisplay = attribution.assigned_by.first_name + ' ' + attribution.assigned_by.last_name;

              var row = `
                <tr data-attribution-id="${attribution.id}" class="border-bottom">
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs rounded-circle bg-primary bg-opacity-10 me-3 d-flex align-items-center justify-content-center">
                        <i class="ri-user-line text-primary fs-6"></i>
                      </div>
                      <div>
                        <h6 class="mb-0 fw-semibold">${attribution.user.first_name} ${attribution.user.last_name}</h6>
                        <small class="text-muted">@${attribution.user.username}</small>
                      </div>
                    </div>
                  </td>
                  <td class="py-3">
                    <div class="d-flex align-items-center">
                      <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                        <i class="ri-apps-line text-primary fs-6"></i>
                      </div>
                      <span class="fw-medium">${attribution.module.name}</span>
                    </div>
                  </td>
                  <td class="py-3">
                    <span class="badge bg-gradient bg-primary-subtle text-primary rounded-pill px-3 py-2">
                      <i class="ri-shield-user-line me-1"></i>${attribution.role.name}
                    </span>
                  </td>
                  <td class="py-3">
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs rounded-circle bg-info bg-opacity-10 me-2 d-flex align-items-center justify-content-center">
                        <i class="ri-account-circle-line text-info fs-6"></i>
                      </div>
                      <span>${attribution.assigned_by.first_name} ${attribution.assigned_by.last_name}</span>
                    </div>
                  </td>
                  <td class="py-3">
                    <div class="d-flex align-items-center">
                      <i class="ri-calendar-2-line text-muted me-2"></i>
                      <span>${attribution.assigned_at}</span>
                    </div>
                  </td>
                  <td class="py-3">
                    <div class="d-flex align-items-center">
                      <i class="ri-refresh-line text-muted me-2"></i>
                      <span>${attribution.updated_at}</span>
                    </div>
                  </td>
                  <td class="py-3 text-end">
                    <div class="dropdown">
                      <button class="btn btn-soft-primary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="ri-more-2-fill"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2" style="min-width: 200px;">
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center edit-attribution" data-attribution-id="${attribution.id}">
                            <i class="ri-edit-line text-primary me-2"></i>Modifier
                          </a>
                        </li>
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center view-permissions" data-attribution-id="${attribution.id}">
                            <i class="ri-eye-line text-info me-2"></i>Consulter les permissions
                          </a>
                        </li>
                        <li><hr class="dropdown-divider my-1"></li>
                        <li>
                          <a href="#" class="dropdown-item d-flex align-items-center text-danger delete-attribution" data-attribution-id="${attribution.id}">
                            <i class="ri-delete-bin-line me-2"></i>Supprimer
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              `;
              tbody.append(row);
            });

            // Update KPIs
            $('#totalAttributions').text(response.data.length);
            var usersSet = new Set(response.data.map(item => item.user.id));
            var modulesSet = new Set(response.data.map(item => item.module.id));
            $('#usersWithRoles').text(usersSet.size);
            $('#configuredModules').text(modulesSet.size);
            $('#assignedRoles').text(response.data.length);
          } else {
            // Show empty state message
            $('#listeAttributions').hide();
            $('#noAttributionsMessage').show();

            // Update KPIs
            $('#totalAttributions').text(0);
            $('#usersWithRoles').text(0);
            $('#configuredModules').text(0);
            $('#assignedRoles').text(0);
          }
        },
        error: function(xhr, status, error) {
          console.error("Error loading attributions:", error);
          // Show empty state message
          $('#listeAttributions').hide();
          $('#noAttributionsMessage').show();

          // Update KPIs
          $('#totalAttributions').text(0);
          $('#usersWithRoles').text(0);
          $('#configuredModules').text(0);
          $('#assignedRoles').text(0);

          alertify.error("Erreur lors du chargement des attributions");
        }
      });
    }

    // Load attributions on page load
    loadAttributions();

    // Handle table filtering
    $('#table-filter').on('input', function() {
      var searchTerm = $(this).val().toLowerCase();
      $('#listeAttributions tr').each(function() {
        var $row = $(this);
        var rowText = $row.text().toLowerCase();

        if (rowText.indexOf(searchTerm) > -1) {
          $row.show();
        } else {
          $row.hide();
        }
      });
    });

    // Handle add attribution button click
    $('#addAttributionBtn, #addAttributionEmptyStateBtn').on('click', function() {
      $('#addAttributionForm')[0].reset();
      $('#addAttributionModal').modal('show');
    });

    // Handle edit attribution
    $(document).on('click', '.edit-attribution', function(e) {
      e.preventDefault();
      var attributionId = $(this).data('attribution-id');

      // Fetch the attribution details from the server
      $.ajax({
        url: "{% url 'institut_app:ApiGetAttributionDetails' %}",
        type: "GET",
        dataType: "JSON",
        data: {
          'id': attributionId
        },
        success: function(response) {
          if (response.status === 'success' && response.data) {
            var attribution = response.data;

            // Fill the modal form with the attribution details
            $('#attributionId').val(attribution.id);
            $('#updateAttributionUser').val(attribution.user_id);
            $('#updateAttributionModule').val(attribution.module_id);
            $('#updateAttributionRole').val(attribution.role_id);

            // Show the modal
            $('#updateAttributionModal').modal('show');
          } else {
            alertify.error(response.message || "Erreur lors de la récupération des détails de l'attribution");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error loading attribution details:", error);
          alertify.error("Erreur lors du chargement des détails de l'attribution");
        }
      });
    });

    // Handle delete attribution
    $(document).on('click', '.delete-attribution', function(e) {
      e.preventDefault();
      var attributionId = $(this).data('attribution-id');
      var $row = $(this).closest('tr');
      var userName = $row.find('td:eq(0)').text();
      var moduleName = $row.find('td:eq(1)').text();

      // Update the modal content
      $('#deleteModalMessage').html(`
        <p>Vous êtes sur le point de supprimer l'attribution de rôle pour <strong>"${userName}"</strong> dans le module <strong>"${moduleName}"</strong>.</p>
      `);

      // Store the attribution ID for deletion confirmation
      $('.deleteAttributionModal').data('attribution-id', attributionId);

      // Show the modal
      $('.deleteAttributionModal').modal('show');
    });

    // Handle update attribution
    $('#updateAttributionBtn').on('click', function() {
      var attributionId = $('#attributionId').val();
      var userId = $('#updateAttributionUser').val();
      var moduleId = $('#updateAttributionModule').val();
      var roleId = $('#updateAttributionRole').val();

      if (!attributionId || !userId || !moduleId || !roleId) {
        alertify.error("Veuillez remplir tous les champs obligatoires");
        return;
      }

      // Send the updated attribution data to the server
      $.ajax({
        url: "{% url 'institut_app:ApiUpdateAttribution' %}",
        type: "POST",
        dataType: "JSON",
        data: {
          'id': attributionId,
          'user_id': userId,
          'module_id': moduleId,
          'role_id': roleId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === "success") {
            alertify.success(response.message || "Attribution mise à jour avec succès");
            $('#updateAttributionModal').modal('hide');
            loadAttributions(); // Reload the attributions list
          } else {
            alertify.error(response.message || "Erreur lors de la mise à jour de l'attribution");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error updating attribution:", error);
          alertify.error("Une erreur est survenue lors de la mise à jour de l'attribution");
        }
      });
    });

    // Confirm delete attribution
    $('#confirmDeleteAttributionBtn').on('click', function() {
      var attributionId = $('.deleteAttributionModal').data('attribution-id');

      // Send the delete request to the server
      $.ajax({
        url: "{% url 'institut_app:ApiDeleteAttribution' %}",
        type: "POST",
        dataType: "JSON",
        data: {
          'id': attributionId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === "success") {
            alertify.success(response.message || "Attribution supprimée avec succès");
            $('.deleteAttributionModal').modal('hide');
            loadAttributions(); // Reload the attributions list
          } else {
            alertify.error(response.message || "Erreur lors de la suppression de l'attribution");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error deleting attribution:", error);
          alertify.error("Une erreur est survenue lors de la suppression de l'attribution");
          $('.deleteAttributionModal').modal('hide');
        }
      });
    });

    // Load users for dropdowns
    function loadUsers() {
      // Fetch users from the server
      $.ajax({
        url: "{% url 'institut_app:ApiListeDesUtilisateurs' %}",
        type: "GET",
        dataType: "JSON",
        success: function(response) {
          var users = response;

          var userSelects = ['#addAttributionUser', '#updateAttributionUser', '#filter-user'];

          userSelects.forEach(function(selectId) {
            var select = $(selectId);
            select.empty();
            select.append('<option value="">Sélectionner un utilisateur</option>');

            users.forEach(function(user) {
              var displayName = user.first_name + ' ' + user.last_name + ' (' + user.username + ')';
              select.append(`<option value="${user.id}">${displayName}</option>`);
            });
          });
        },
        error: function(xhr, status, error) {
          console.error("Error loading users:", error);

          // Fallback to basic user selection
          var userSelects = ['#addAttributionUser', '#updateAttributionUser', '#filter-user'];

          userSelects.forEach(function(selectId) {
            var select = $(selectId);
            select.empty();
            select.append('<option value="">Sélectionner un utilisateur</option>');
          });
        }
      });
    }

    // Load modules for dropdowns
    function loadModules() {
      // Fetch modules from the server
      $.ajax({
        url: "{% url 'institut_app:ApiListeModules' %}",
        type: "GET",
        dataType: "JSON",
        success: function(response) {
          var modules = response;

          var moduleSelects = ['#addAttributionModule', '#updateAttributionModule'];

          moduleSelects.forEach(function(selectId) {
            var select = $(selectId);
            select.empty();
            select.append('<option value="">Sélectionner un module</option>');

            modules.forEach(function(module) {
              select.append(`<option value="${module.id}">${module.name_display}</option>`);
            });
          });
        },
        error: function(xhr, status, error) {
          console.error("Error loading modules:", error);

          // Fallback to basic module selection
          var moduleSelects = ['#addAttributionModule', '#updateAttributionModule'];

          moduleSelects.forEach(function(selectId) {
            var select = $(selectId);
            select.empty();
            select.append('<option value="">Sélectionner un module</option>');
          });
        }
      });
    }

    // Load roles for dropdowns
    function loadRoles() {
      // Fetch roles from the server
      $.ajax({
        url: "{% url 'institut_app:ApiListeRoles' %}",
        type: "GET",
        dataType: "JSON",
        success: function(response) {
          var roles = response;

          var roleSelects = ['#addAttributionRole', '#updateAttributionRole', '#filter-role'];

          roleSelects.forEach(function(selectId) {
            var select = $(selectId);
            select.empty();
            select.append('<option value="">Sélectionner un rôle</option>');

            roles.forEach(function(role) {
              select.append(`<option value="${role.id}">${role.name}</option>`);
            });
          });
        },
        error: function(xhr, status, error) {
          console.error("Error loading roles:", error);

          // Fallback to basic role selection
          var roleSelects = ['#addAttributionRole', '#updateAttributionRole', '#filter-role'];

          roleSelects.forEach(function(selectId) {
            var select = $(selectId);
            select.empty();
            select.append('<option value="">Sélectionner un rôle</option>');
          });
        }
      });
    }

    // Initialize dropdowns
    loadUsers();
    loadModules();
    loadRoles();

    // Handle save new attribution
    $('#saveNewAttributionBtn').on('click', function() {
      var userId = $('#addAttributionUser').val();
      var moduleId = $('#addAttributionModule').val();
      var roleId = $('#addAttributionRole').val();

      if (!userId || !moduleId || !roleId) {
        alertify.error("Veuillez remplir tous les champs obligatoires");
        return;
      }

      // Send the data to the server using ApiAddAttribution
      $.ajax({
        url: "{% url 'institut_app:ApiAddAttribution' %}",
        type: "POST",
        dataType: "JSON",
        data: {
          'user_id': userId,
          'module_id': moduleId,
          'role_id': roleId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.status === "success") {
            alertify.success(response.message || "Rôle attribué avec succès");
            $('#addAttributionModal').modal('hide');
            loadAttributions();
          } else {
            alertify.error(response.message || "Erreur lors de l'attribution du rôle");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error adding attribution:", error);
          alertify.error("Une erreur est survenue lors de l'attribution du rôle");
        }
      });
    });

    // Handle update attribution
    $('#updateAttributionBtn').on('click', function() {
      var formData = $('#updateAttributionForm').serialize();
      var attributionId = $('#attributionId').val();
      
      // In a real implementation, you would send the data to the server
      // For now, we'll just show a success message
      alertify.success("Attribution mise à jour avec succès");
      $('#updateAttributionModal').modal('hide');
      loadAttributions();
    });

    // Handle view permissions
    $(document).on('click', '.view-permissions', function(e) {
      e.preventDefault();
      var attributionId = $(this).data('attribution-id');
      var $row = $(this).closest('tr');
      var userName = $row.find('td:eq(0)').find('h6').text();
      var moduleName = $row.find('td:eq(1) span').text();
      var roleName = $row.find('td:eq(2) span').text();

      // Set the role and module names in the modal header
      $('#roleNameForPermissionsView').text(roleName);
      $('#moduleNameForPermissionsView').text(moduleName);

      // Load permissions for the role in the module
      loadRolePermissionsForModule(attributionId);

      // Show the modal
      $('#viewPermissionsModal').modal('show');
    });

    // Function to load role permissions for a specific attribution
    function loadRolePermissionsForModule(attributionId) {
      // Show loading state
      $('#permissionsList').empty();
      $('#permissionsList').append(`
        <tr>
          <td colspan="3" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">Chargement des permissions...</p>
          </td>
        </tr>
      `);

      // First, get the attribution details to get the role ID
      $.ajax({
        url: "{% url 'institut_app:ApiGetAttributionDetails' %}",
        type: "GET",
        dataType: "JSON",
        data: {
          'id': attributionId
        },
        success: function(response) {
          if (response.status === "success" && response.data) {
            var role_id = response.data.role_id;

            // Now fetch the permissions for this role and module
            $.ajax({
              url: "{% url 'institut_app:ApiGetRolePermissionsByRoleId' %}",
              type: "GET",
              dataType: "JSON",
              data: {
                'role_id': role_id,
                'module_id': response.data.module_id  // Passer l'ID du module pour filtrer les permissions
              },
              success: function(permResponse) {
                $('#permissionsList').empty();

                if (permResponse.status === "success" && permResponse.permissions && permResponse.permissions.length > 0) {
                  permResponse.permissions.forEach(function(permission) {
                    var grantedBadge = permission.is_granted ?
                      '<span class="badge bg-success">Accordée</span>' :
                      '<span class="badge bg-secondary">Non accordée</span>';

                    var row = `
                      <tr>
                        <td>${permission.permission_type}</td>
                        <td>${permission.description || '--'}</td>
                        <td class="text-center">${grantedBadge}</td>
                      </tr>
                    `;
                    $('#permissionsList').append(row);
                  });
                } else {
                  $('#permissionsList').append(`
                    <tr>
                      <td colspan="3" class="text-center py-4 text-muted">
                        Aucune permission trouvée pour ce module
                      </td>
                    </tr>
                  `);
                }
              },
              error: function(xhr, status, error) {
                console.error("Error loading role permissions:", error);
                $('#permissionsList').empty();
                $('#permissionsList').append(`
                  <tr>
                    <td colspan="3" class="text-center py-4 text-danger">
                      Erreur lors du chargement des permissions
                    </td>
                  </tr>
                `);
              }
            });
          } else {
            console.error("Error getting attribution details:", response.message);
            $('#permissionsList').empty();
            $('#permissionsList').append(`
              <tr>
                <td colspan="3" class="text-center py-4 text-danger">
                  Erreur lors du chargement des détails de l'attribution
                </td>
              </tr>
            `);
          }
        },
        error: function(xhr, status, error) {
          console.error("Error getting attribution details:", error);
          $('#permissionsList').empty();
          $('#permissionsList').append(`
            <tr>
              <td colspan="3" class="text-center py-4 text-danger">
                Erreur lors du chargement des détails de l'attribution
              </td>
            </tr>
          `);
        }
      });
    }
  });
</script>

{% endblock content %}