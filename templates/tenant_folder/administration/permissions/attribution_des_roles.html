{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Administration - Attribution des rôles{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }

  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }

  .table td.text-end {
    position: relative;
    overflow: visible;
  }

  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }

  .role-badge {
    font-size: 0.8em;
  }

  .module-badge {
    background-color: #e7f1ff;
    color: #3b7ddd;
  }

  .user-badge {
    background-color: #e7f7ff;
    color: #1594ef;
  }

  .role-badge {
    background-color: #f0f9ff;
    color: #0d9488;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-user-tag text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Attribution des rôles</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Configuration</a>
                  </li>
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Administration</a>
                  </li>
                  <li class="breadcrumb-item active">Attribution des rôles</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row">
        <!-- KPIs Section -->
        <div class="col-12 mb-4">
          <div class="row g-3">
            <!-- Total Attributions -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-user-star-line text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Total Attributions</h5>
                      <h3 class="mb-0 fw-bold" id="totalAttributions">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Utilisateurs avec rôles -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-user-line text-success fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Utilisateurs avec rôles</h5>
                      <h3 class="mb-0 fw-bold" id="usersWithRoles">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modules configurés -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-apps-line text-warning fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Modules configurés</h5>
                      <h3 class="mb-0 fw-bold" id="configuredModules">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rôles attribués -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-shield-user-line text-info fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Rôles attribués</h5>
                      <h3 class="mb-0 fw-bold" id="assignedRoles">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  
                  <select id="filter-user" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les utilisateurs</option>
                  </select>

                  <select id="filter-module" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les modules</option>
                  </select>

                  <select id="filter-role" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Tous les rôles</option>
                  </select>

                  <button id="addAttributionBtn" type="button" class="btn btn-primary rounded-pill">
                    <i class="ri-add-line me-1"></i> Nouvelle attribution
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <div class="table-responsive" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Utilisateur</th>
                      <th class="border-0">Module</th>
                      <th class="border-0">Rôle</th>
                      <th class="border-0">Assigné par</th>
                      <th class="border-0">Date d'attribution</th>
                      <th class="border-0">Dernière modification</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeAttributions" class="border-top-0">
                    <!-- Attribution rows will be populated by JavaScript -->
                  </tbody>
                </table>

                <!-- Empty state -->
                <div id="noAttributionsMessage" class="text-center py-5" style="display: none;">
                  <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                    <i class="ri-user-star-line text-muted fs-1"></i>
                  </div>
                  <h5 class="mb-2">Aucune attribution trouvée</h5>
                  <p class="text-muted mb-4">Il n'y a aucune attribution de rôle enregistrée pour le moment</p>
                  <button id="addAttributionEmptyStateBtn" class="btn btn-primary">
                    <i class="ri-add-line me-1"></i> Créer une attribution
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade deleteAttributionModal" tabindex="-1" role="dialog" aria-labelledby="deleteAttributionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteAttributionModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <div id="deleteModalMessage">
            <p class="text-muted mb-0">
              Vous êtes sur le point de supprimer cette attribution de rôle. Cette action est irréversible.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
            <i class="ri-close-line me-2"></i>Annuler
          </button>
          <button type="button" class="btn btn-danger px-4 py-2" id="confirmDeleteAttributionBtn">
            <i class="ri-delete-bin-line me-2"></i>Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour modification d'attribution -->
<div id="updateAttributionModal" class="modal fade" tabindex="-1" aria-labelledby="updateAttributionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-user-star-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="updateAttributionModalLabel">
              Modification de l'attribution
            </h5>
            <p class="text-muted small mb-0">Mise à jour des informations de l'attribution</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="updateAttributionForm">
          <input type="hidden" id="attributionId" name="id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-medium" for="updateAttributionUser">Utilisateur</label>
              <select class="form-select border-0 bg-light py-2" id="updateAttributionUser" name="user" required>
                <option value="">Sélectionner un utilisateur</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" for="updateAttributionModule">Module</label>
              <select class="form-select border-0 bg-light py-2" id="updateAttributionModule" name="module" required>
                <option value="">Sélectionner un module</option>
                <option value="crm">CRM</option>
                <option value="ped">Pédagogie</option>
                <option value="eva">Evaluation</option>
                <option value="con">Conseil</option>
                <option value="adm">Administration</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" for="updateAttributionRole">Rôle</label>
              <select class="form-select border-0 bg-light py-2" id="updateAttributionRole" name="role" required>
                <option value="">Sélectionner un rôle</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" id="updateAttributionBtn">
          <i class="ri-save-line me-2"></i>Enregistrer les modifications
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour ajout d'attribution -->
<div id="addAttributionModal" class="modal fade" tabindex="-1" aria-labelledby="addAttributionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-add-box-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="addAttributionModalLabel">
              Nouvelle attribution
            </h5>
            <p class="text-muted small mb-0">Attribuer un rôle à un utilisateur pour un module</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addAttributionForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-medium" for="addAttributionUser">Utilisateur</label>
              <select class="form-select border-0 bg-light py-2" id="addAttributionUser" name="user" required>
                <option value="">Sélectionner un utilisateur</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" for="addAttributionModule">Module</label>
              <select class="form-select border-0 bg-light py-2" id="addAttributionModule" name="module" required>
                <option value="">Sélectionner un module</option>
                <option value="crm">CRM</option>
                <option value="ped">Pédagogie</option>
                <option value="eva">Evaluation</option>
                <option value="con">Conseil</option>
                <option value="adm">Administration</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" for="addAttributionRole">Rôle</label>
              <select class="form-select border-0 bg-light py-2" id="addAttributionRole" name="role" required>
                <option value="">Sélectionner un rôle</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-success px-4 py-2" id="saveNewAttributionBtn">
          <i class="ri-add-line me-2"></i>Attribuer le rôle
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    // Load initial attributions data
    function loadAttributions() {
      // Show loading state while fetching data
      $('#listeAttributions').empty();
      $('#noAttributionsMessage').hide();

      // This would typically come from an API
      // For now, we'll simulate with mock data
      var mockData = [
        {
          id: 1,
          user: { username: 'john_doe', first_name: 'John', last_name: 'Doe' },
          module: 'crm',
          role: { name: 'Administrateur', level: 4 },
          assigned_by: { username: 'admin', first_name: 'Admin', last_name: '' },
          assigned_at: '2023-01-15',
          updated_at: '2023-01-15'
        },
        {
          id: 2,
          user: { username: 'jane_smith', first_name: 'Jane', last_name: 'Smith' },
          module: 'ped',
          role: { name: 'Manager', level: 3 },
          assigned_by: { username: 'admin', first_name: 'Admin', last_name: '' },
          assigned_at: '2023-02-20',
          updated_at: '2023-02-20'
        }
      ];

      var tbody = $('#listeAttributions');
      tbody.empty();

      if (mockData.length === 0) {
        // Show empty state message
        $('#listeAttributions').hide();
        $('#noAttributionsMessage').show();
      } else {
        // Hide empty state message and show table
        $('#noAttributionsMessage').hide();
        $('#listeAttributions').show();

        mockData.forEach(function(attribution) {
          var userDisplay = attribution.user.first_name + ' ' + attribution.user.last_name + ' (' + attribution.user.username + ')';
          var moduleDisplay = attribution.module === 'crm' ? 'CRM' : 
                             attribution.module === 'ped' ? 'Pédagogie' : 
                             attribution.module === 'eva' ? 'Evaluation' : 
                             attribution.module === 'con' ? 'Conseil' : 
                             'Administration';
          var roleDisplay = attribution.role.name;

          var row = `
            <tr data-attribution-id="${attribution.id}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-xs rounded-circle bg-primary bg-opacity-10 me-2 d-flex align-items-center justify-content-center">
                    <i class="ri-user-line text-primary"></i>
                  </div>
                  <div>
                    <h6 class="mb-0 fw-medium">${userDisplay}</h6>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge bg-primary module-badge">${moduleDisplay}</span>
              </td>
              <td>
                <span class="badge bg-success role-badge">${roleDisplay}</span>
              </td>
              <td>${attribution.assigned_by.first_name} ${attribution.assigned_by.last_name}</td>
              <td>${attribution.assigned_at}</td>
              <td>${attribution.updated_at}</td>
              <td class="text-end">
                <div class="dropdown d-inline-block">
                  <button class="btn btn-soft-primary btn-sm dropdown-toggle shadow-none" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                    <i class="ri-more-2-fill"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-3 p-2" style="min-width: 200px;">
                    <li>
                      <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 edit-attribution" data-attribution-id="${attribution.id}">
                        <i class="ri-edit-line text-primary me-2"></i>Modifier
                      </a>
                    </li>
                    <li><hr class="dropdown-divider my-1"></li>
                    <li>
                      <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 text-danger delete-attribution" data-attribution-id="${attribution.id}">
                        <i class="ri-delete-bin-line me-2"></i>Supprimer
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      // Update KPIs
      $('#totalAttributions').text(mockData.length);
      $('#usersWithRoles').text([...new Set(mockData.map(item => item.user.username))].length);
      $('#configuredModules').text([...new Set(mockData.map(item => item.module))].length);
      $('#assignedRoles').text(mockData.length);
    }

    // Load attributions on page load
    loadAttributions();

    // Handle table filtering
    $('#table-filter').on('input', function() {
      var searchTerm = $(this).val().toLowerCase();
      $('#listeAttributions tr').each(function() {
        var $row = $(this);
        var rowText = $row.text().toLowerCase();

        if (rowText.indexOf(searchTerm) > -1) {
          $row.show();
        } else {
          $row.hide();
        }
      });
    });

    // Handle add attribution button click
    $('#addAttributionBtn, #addAttributionEmptyStateBtn').on('click', function() {
      $('#addAttributionForm')[0].reset();
      $('#addAttributionModal').modal('show');
    });

    // Handle edit attribution
    $(document).on('click', '.edit-attribution', function(e) {
      e.preventDefault();
      var attributionId = $(this).data('attribution-id');

      // In a real implementation, you would fetch the attribution details from the server
      // For now, we'll simulate by showing the update modal
      $('#attributionId').val(attributionId);
      $('#updateAttributionModal').modal('show');
    });

    // Handle delete attribution
    $(document).on('click', '.delete-attribution', function(e) {
      e.preventDefault();
      var attributionId = $(this).data('attribution-id');
      var $row = $(this).closest('tr');
      var userName = $row.find('td:eq(0)').text();
      var moduleName = $row.find('td:eq(1)').text();

      // Update the modal content
      $('#deleteModalMessage').html(`
        <p>Vous êtes sur le point de supprimer l'attribution de rôle pour <strong>"${userName}"</strong> dans le module <strong>"${moduleName}"</strong>.</p>
      `);

      // Store the attribution ID for deletion confirmation
      $('.deleteAttributionModal').data('attribution-id', attributionId);

      // Show the modal
      $('.deleteAttributionModal').modal('show');
    });

    // Confirm delete attribution
    $('#confirmDeleteAttributionBtn').on('click', function() {
      var attributionId = $('.deleteAttributionModal').data('attribution-id');

      // In a real implementation, you would make an API call to delete the attribution
      // For now, we'll just reload the attributions
      alertify.success("Attribution supprimée avec succès");
      $('.deleteAttributionModal').modal('hide');
      loadAttributions();
    });

    // Load users for dropdowns
    function loadUsers() {
      // In a real implementation, you would fetch users from the server
      // For now, we'll add some mock users
      var users = [
        { id: 1, username: 'john_doe', first_name: 'John', last_name: 'Doe' },
        { id: 2, username: 'jane_smith', first_name: 'Jane', last_name: 'Smith' },
        { id: 3, username: 'bob_wilson', first_name: 'Bob', last_name: 'Wilson' }
      ];

      var userSelects = ['#addAttributionUser', '#updateAttributionUser', '#filter-user'];
      
      userSelects.forEach(function(selectId) {
        var select = $(selectId);
        select.empty();
        select.append('<option value="">Sélectionner un utilisateur</option>');
        
        users.forEach(function(user) {
          var displayName = user.first_name + ' ' + user.last_name + ' (' + user.username + ')';
          select.append(`<option value="${user.id}">${displayName}</option>`);
        });
      });
    }

    // Load roles for dropdowns
    function loadRoles() {
      // In a real implementation, you would fetch roles from the server
      // For now, we'll add some mock roles
      var roles = [
        { id: 1, name: 'Utilisateur', level: 1 },
        { id: 2, name: 'Superviseur', level: 2 },
        { id: 3, name: 'Manager', level: 3 },
        { id: 4, name: 'Administrateur', level: 4 }
      ];

      var roleSelects = ['#addAttributionRole', '#updateAttributionRole', '#filter-role'];
      
      roleSelects.forEach(function(selectId) {
        var select = $(selectId);
        select.empty();
        select.append('<option value="">Sélectionner un rôle</option>');
        
        roles.forEach(function(role) {
          select.append(`<option value="${role.id}">${role.name}</option>`);
        });
      });
    }

    // Initialize dropdowns
    loadUsers();
    loadRoles();

    // Handle save new attribution
    $('#saveNewAttributionBtn').on('click', function() {
      var formData = $('#addAttributionForm').serialize();
      
      // In a real implementation, you would send the data to the server
      // For now, we'll just show a success message
      alertify.success("Rôle attribué avec succès");
      $('#addAttributionModal').modal('hide');
      loadAttributions();
    });

    // Handle update attribution
    $('#updateAttributionBtn').on('click', function() {
      var formData = $('#updateAttributionForm').serialize();
      var attributionId = $('#attributionId').val();
      
      // In a real implementation, you would send the data to the server
      // For now, we'll just show a success message
      alertify.success("Attribution mise à jour avec succès");
      $('#updateAttributionModal').modal('hide');
      loadAttributions();
    });
  });
</script>

{% endblock content %}