{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Tr√©sorerie - Suivie des √©ch√©anciers{% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Add search box styling */
    .search-box {
        position: relative;
    }
    
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }
    
    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }
    
    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }
    
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item i {
        width: 1.2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    /* Fix dropdown z-index issue */
    .table-responsive {
        overflow-x: visible;
    }
    
    .table td.text-end {
        position: relative;
        overflow: visible;
    }
    
    .table .dropdown-menu {
        z-index: 1050;
        position: absolute;
    }
    
    .view-container {
        display: none;
    }
    
    .view-container.active {
        display: block;
    }
    
    .view-toggle-btn.active {
        background-color: #3b7ddd !important;
        color: white !important;
        border-color: #3b7ddd !important;
    }
    
    .payment-status-badge {
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .payment-status-badge.paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .payment-status-badge.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .payment-status-badge.overdue {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    /* Style pour le curseur au survol des lignes de la table */
    #promoTableBody tr {
        cursor: pointer;
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-calendar-check-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Suivie des √©ch√©anciers</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Finance</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Tr√©sorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Suivie des √©ch√©anciers</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Notification message -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="ri-information-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Informations importantes :</div>
                            <div class="small">Seuls les prospects dont l'inscription est confirm√©e s'affichent dans cette page. La validation de l'inscription se fait dans la page <strong>En attente de paiement</strong> dans le menu Finance > Tr√©sorerie.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View toggle buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary view-toggle-btn active" data-view="promo">Vue par Promotion</button>
                        <button class="btn btn-outline-primary view-toggle-btn" data-view="prospect">Vue par Prospect</button>
                    </div>
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-user-line text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalConvertedProspects">0</h5>
                                    <p class="mb-0 text-muted small">Prospects convertis</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-check-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="paidCount">0</h5>
                                    <p class="mb-0 text-muted small">Paiements effectu√©s</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-time-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="pendingCount">0</h5>
                                    <p class="mb-0 text-muted small">Paiements en attente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-danger bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-danger bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-alert-line text-danger fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="overdueCount">0</h5>
                                    <p class="mb-0 text-muted small">Paiements √©chus</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View containers -->
            <div class="row">
                <div class="col-lg-12">
                    <!-- View by Promotion -->
                    <div id="promoView" class="view-container active">
                        <div class="card shadow border-0 rounded-3">
                            <div class="card-header bg-white p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-filter text-info me-2"></i>
                                        <h5 class="card-title mb-0 text-info">Filtres - Vue par promotion</h5>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="search-box position-relative">
                                            <input type="text" placeholder="Rechercher..." id="promo-table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                            <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                        </div>
                                        <select id="promoFilter" class="form-select rounded-pill" style="width: 200px;">
                                            <option value="">Toutes les promotions</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="table-responsive" style="overflow-x: visible;">
                                    <table id="promoTable" class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="border-0 rounded-start">Promotion</th>
                                                <th class="border-0">Nombre d'√©tudiants</th>
                                                <th class="border-0">Total √† payer</th>
                                                <th class="border-0">Total pay√©</th>
                                                <th class="border-0">Reste √† payer</th>
                                                <th class="border-0">Paiement √©chus</th>
                                                <th class="border-0">Rembourssement</th>
                                                <th class="border-0">Total</th>
                                                
                                            </tr>
                                        </thead>
                                        <tbody id="promoTableBody">
                                            <!-- Data will be loaded here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- View by Prospect -->
                    <div id="prospectView" class="view-container">
                        <div class="card shadow border-0 rounded-3">
                            <div class="card-header bg-white p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-filter text-info me-2"></i>
                                        <h5 class="card-title mb-0 text-info">Filtres - Vue par prospect converti</h5>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="search-box position-relative">
                                            <input type="text" placeholder="Rechercher un prospect..." id="prospect-table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                            <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                        </div>
                                        <div>
                                            <button id="clearDateFilter" class="btn btn-light btn-sm rounded-pill">
                                                <i class="ri-close-line me-1"></i>Effacer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="table-responsive" style="overflow-x: visible;">
                                    <table id="prospectTable" class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="border-0 rounded-start">Nom & Pr√©nom</th>
                                                <th class="border-0">Type de paiement</th>
                                                <th class="border-0">Montant pay√©</th>
                                                <th class="border-0">Statut</th>
                                                <th class="border-0 rounded-end text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prospectTableBody">
                                            <!-- Data will be loaded here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal pour afficher les sp√©cialit√©s d'une promotion -->
<div class="modal fade" id="specialitesPromoModal" tabindex="-1" aria-labelledby="specialitesPromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-3 shadow-lg border-0">
            <div class="modal-header bg-primary bg-opacity-10 px-4 py-3 border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-2 p-2 me-3">
                        <i class="ri-book-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-0" id="specialitesPromoModalLabel">Sp√©cialit√©s de la promotion</h5>
                        <p class="text-muted small mb-0 fs-6"><span id="promoNameInModal"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Liste des sp√©cialit√©s</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Sp√©cialit√©</th>
                                <th>Nombre d'√©tudiants</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="specialitesTableBody">
                            <!-- Les sp√©cialit√©s seront charg√©es ici dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher les prospects d'une promotion -->
<div class="modal fade" id="prospectListModal" tabindex="-1" aria-labelledby="prospectListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-3 shadow-lg border-0">
            <div class="modal-header bg-success bg-opacity-10 px-4 py-3 border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-2 p-2 me-3">
                        <i class="ri-user-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-0" id="prospectListModalLabel">Liste des prospects de la promotion</h5>
                        <p class="text-muted small mb-0 fs-6"><span id="promoNameForProspects"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nom & Pr√©nom</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Date d'inscription</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="prospectListTableBody">
                            <!-- Les prospects seront charg√©es ici dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        // Initialize with promo view
        $('#promoView').addClass('active');
        $('#prospectView').removeClass('active');
        
        // View toggle functionality
        $('.view-toggle-btn').on('click', function(){
            var view = $(this).data('view');
            
            // Remove active class from buttons
            $('.view-toggle-btn').removeClass('active');
            
            // Add active class to clicked button
            $(this).addClass('active');
            
            // Hide all view containers
            $('.view-container').removeClass('active');
            
            // Show selected view container
            $('#' + view + 'View').addClass('active');
        });
        
        // Load initial data
        loadPromoData();
        loadProspectData();
        
        // Search functionality for promo view
        $('#promo-table-filter').on('keyup', function() {
            applyPromoFilter();
        });
        
        // Search functionality for prospect view
        $('#prospect-table-filter').on('keyup', function() {
            applyProspectFilter();
        });
        
        // Filter by promo in prospect view
        $('#prospectPromoFilter').on('change', function() {
            applyProspectFilter();
        });
        
        // Filter by status in prospect view
        $('#prospectStatusFilter').on('change', function() {
            applyProspectFilter();
        });
        
        // Filter by promo in promo view
        $('#promoFilter').on('change', function() {
            applyPromoFilter();
        });
        
        // Load promo data from API
        function loadPromoData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadConvertedProspects' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(response) {
                    
                    allPromoData = response.promos.map(function(promo) {
                        var totalToPay = promo.montant_total || 0;
                        var totalPaid = promo.montant_paye || 0;
                        var restant_a_paye = promo.montant_restant || 0;
                        var montant_echu = promo.montant_restant || 0;
                        var rembourssement = promo.montant_rembouser || 0;
                        
                        return {
                            id: promo.id,
                            name: promo.session + ' (' + promo.begin_year + '-' + promo.end_year + ')',
                            code: promo.code, // Store the code for filtering
                            studentCount: promo.total_inscrit || 0,
                            totalToPay: totalToPay,
                            totalPaid: totalPaid,
                            restant_a_paye : restant_a_paye,
                            montant_echu: montant_echu,
                            rembourssement: rembourssement,
                        };
                    });
                    
                    
                    // Render data
                    renderPromoTable(allPromoData);
                    
                    // Populate the promo filter dropdown
                    populatePromoFilter();
                },
                error: function() {
                    var html = '<tr><td colspan="7" class="text-center text-danger">Erreur lors du chargement des donn√©es des promotions.</td></tr>';
                    $('#promoTableBody').html(html);
                }
            });
        }
        
        // Store all prospect data for filtering (converted prospects only)
        var allProspectData = [];
        var currentProspectSearchTerm = '';

        // Load prospect data (converted prospects with due payments)
        function loadProspectData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadConvertedProspects' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(response) {
                    // Store all data for filtering (using clients array from response)
                    allProspectData = response.clients;
                    
                    // Render data
                    renderProspectTable(response.clients);
                   
                },
                error: function() {
                    console.error("Erreur lors du chargement des donn√©es");
                    var html = '<tr><td colspan="6" class="text-center text-danger">Erreur lors du chargement des donn√©es.</td></tr>';
                    $('#prospectTableBody').html(html);
                }
            });
        }
        
        // Render promo table
        function renderPromoTable(data) {
            var html = '';
            if (data.length > 0) {
                $.each(data, function(index, item) {
                    html += '<tr class="promo-row" data-promo-id="' + item.id + '" data-promo-name="' + item.name + '">';
                    html += '<td><div class="fw-medium">' + item.name + '</div></td>';
                    html += '<td><div class="fw-medium">' + item.studentCount + '</div></td>';
                    html += '<td><div class="fw-medium">' + item.totalToPay.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td><div class="fw-medium text-success">' + item.totalPaid.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td><div class="fw-medium text-danger">' + item.restant_a_paye.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td><div class="fw-medium text-danger">' + item.montant_echu.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td><div class="fw-medium text-danger">' + item.rembourssement.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '</tr>';
                });
            } else {
                html = '<tr><td colspan="7" class="text-center text-muted">Aucune donn√©e disponible</td></tr>';
            }
            
            $('#promoTableBody').html(html);
            
            // Ajouter l'√©v√©nement de clic sur les lignes de la table
            $('.promo-row').on('click', function() {
                var promoId = $(this).data('promo-id');
                var promoName = $(this).data('promo-name');
                
                // Mettre √† jour le titre de la modal
                $('#promoNameInModal').text(promoName);
                
                // Charger les sp√©cialit√©s pour cette promotion
                loadSpecialitesForPromo(promoId);
                
                // Afficher la modal
                $('#specialitesPromoModal').modal('show');
            });
        }
        
        // Render prospect table (converted prospects only)
        function renderProspectTable(data) {
            var html = '';
            if (data.length > 0) {
                $.each(data, function(index, client) {
                    html += '<tr>';
                    html += '<td><strong>' + (client.nom || '') + " " + (client.prenom || '') + '</strong></td>';
                    html += '<td><strong>Frais de formation</strong></td>'; // Using a default value since context isn't in the response
                    html += '<td><strong>' + (client.total_paye ? parseFloat(client.total_paye).toLocaleString('fr-FR') : '0') + ' DA</strong></td>';
                    html += '<td><strong><span class="badge bg-success">Pay√©</span></strong></td>'; // Assuming paid since they have payment records
                    
                    var actions = '<div class="dropdown d-inline-block">'+
                        '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">'+
                        '<i class="ri-more-fill align-middle"></i>'+
                        '</button>'+
                        '<ul class="dropdown-menu dropdown-menu-end">'+
                        '<li><a href="#" id="detailsEcheancierBtn" data-is_double='+client.is_double+' data-id-client='+client.id+' class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i> D√©tails</a></li>'+
                        '<li><a href="/comptabilite/tresorerie/paiements-prospect/'+client.id+'" class="dropdown-item"><i class="ri-money-dollar-circle-line align-bottom me-2 text-muted"></i> Paiements</a></li>'+
                        '</ul>'+
                        '</div>';
                    html += '<td class="text-center">' + actions + '</td>';
                    html += '</tr>';
                });
            } else {
                html = '<tr><td colspan="6" class="text-center text-muted">Aucune donn√©e disponible</td></tr>';
            }
            
            $('#prospectTableBody').html(html);
        }
        
        // Update promo statistics
        function updatePromoStatistics() {

            $.ajax({
                url : "{% url 't_tresorerie:ApiStats' %}",
                dataType : "JSON",
                type : "GET",
                success : function(data){
                    $('#totalConvertedProspects').text(data.data.nombre_inscrit);
                    $('#paidCount').text(data.data.nombre_paiement);
                    $('#pendingCount').text(data.data.montant_echu);
                    $('#overdueCount').text(data.data.paiement_attente);
                }
            })
        }

        updatePromoStatistics();
        
        // Store all promo data for filtering
        var allPromoData = [];

        // Populate promo filter dropdown
        function populatePromoFilter() {
            var promoFilter = $('#promoFilter');
            promoFilter.empty(); // Clear existing options
            
            // Add default option
            promoFilter.append($('<option>', {
                value: '',
                text: 'Toutes les promotions'
            }));
            
            // Add options from the loaded data
            $.each(allPromoData, function(index, promo) {
                promoFilter.append($('<option>', {
                    value: promo.code.toLowerCase(),
                    text: promo.name
                }));
            });
        }

        // Apply promo filter
        function applyPromoFilter() {
            var searchTerm = $('#promo-table-filter').val().toLowerCase();
            var promoFilter = $('#promoFilter').val();
            
            // Filter the stored data
            var filteredData = allPromoData;
            
            // Apply search filter
            if (searchTerm) {
                filteredData = filteredData.filter(function(promo) {
                    return (
                        promo.name.toLowerCase().includes(searchTerm) ||
                        promo.code.toLowerCase().includes(searchTerm) ||
                        promo.studentCount.toString().includes(searchTerm)
                    );
                });
            }
            
            // Apply promo-specific filter if needed
            if (promoFilter) {
                filteredData = filteredData.filter(function(promo) {
                    return promo.code.toLowerCase().includes(promoFilter.toLowerCase());
                });
            }
            
            // Render the filtered data
            renderPromoTable(filteredData);
        }
        
        // Search functionality for prospect view
        $('#prospect-table-filter').on('keyup', function() {
            console.log('Search term:', this.value); // Debug log
            currentProspectSearchTerm = this.value.toLowerCase();
            applyProspectFilters();
        }).on('focus', function() {
            console.log('Search input focused'); // Debug log
        }).on('click', function() {
            console.log('Search input clicked'); // Debug log
        });
        
        // Enhanced filtering that combines search and date filters for prospect view
        function applyProspectFilters() {
            var filteredData = allProspectData;
            
            // Apply search filter
            if (currentProspectSearchTerm) {
                filteredData = filteredData.filter(function(client) {
                    // Search in client name
                    return (
                        (client.nom && client.nom.toLowerCase().includes(currentProspectSearchTerm)) ||
                        (client.prenom && client.prenom.toLowerCase().includes(currentProspectSearchTerm)) ||
                        (client.email && client.email.toLowerCase().includes(currentProspectSearchTerm)) ||
                        (client.telephone && client.telephone.toLowerCase().includes(currentProspectSearchTerm))
                    );
                });
            }
            
            // Add filtered data to table
            renderProspectTable(filteredData);
        }
        
        // Clear date filter button
        $(document).on('click', '#clearDateFilter', function(){
            $('#prospect-table-filter').val('');
            currentProspectSearchTerm = '';
            applyProspectFilters();
        });
        
        // Also filter when pressing Enter in date fields
        $(document).on('keypress', '#dateFrom, #dateTo', function(e){
            if (e.which === 13) { // Enter key
                applyProspectFilters();
            }
        });
        
     
        function loadSpecialitesForPromo(promoId) {
            var p = promoId;
            $('#specialitesTableBody').html('<tr><td colspan="3" class="text-center text-muted">Chargement des sp√©cialit√©s...</td></tr>');
            
            $.ajax({
                url  : "{%  url 't_tresorerie:ApiGetLunchedSpec' %}",
                dataType : "JSON",
                type : "GET",
                data : {
                    'id_promo' : promoId,
                },
                success: function(data){
                    var html = '';
                    var badge = '';

                    if (data.length > 0) {
                        $.each(data, function(index, i) {
                            if (i.type === "double") {
                                badge = "üéì Double diplomation"
                            }
                            html += '<tr data-specialite-id="' + i.id + '">';
                            html += '<td>' + i.label +'<p class="text-muted">'+badge+'</p></td>';
                            
                            html += '<td>'+ i.total_student+ '</td>';
                            html += '<td class="text-center"><button type="button" class="btn btn-outline-primary btn-sm btn-specialite-prospects" data-type='+i.type+' data-promo="'+p+'" data-specialite-id="' + i.id + '"><i class="ri-user-line me-1"></i>Afficher les prospects</button></td>';
                            html += '</tr>';
                        });
                    } else {
                        html = '<tr><td colspan="3" class="text-center text-muted">Aucune sp√©cialit√© disponible</td></tr>';
                    }
                              
                    $('#specialitesTableBody').html(html);
                }
            })
            
            
        }


        // Function to load prospects for a given promotion
        function loadProspectsForPromo(promoId) {
            // Show loading message
            $('#prospectListTableBody').html('<tr><td colspan="4" class="text-center text-muted">Chargement des prospects...</td></tr>');
            
            // Make an API call to get prospects for this promotion
            // Since there's no specific API for this purpose, we need to get prospects via existing APIs
            // We'll get all converted prospects and then determine which ones belong to the promotion
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadConvertedProspects' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'promo_id': promoId  // This would need to be handled server-side
                },
                success: function(response) {
                    // For now, we'll use the clients data and need to get the actual prospect data
                    // This would require an updated backend API to get prospects by promotion
                    // For now, we'll use a placeholder implementation that fetches from the API we just created
                    loadProspectsByPromoId(promoId);
                },
                error: function() {
                    var html = '<tr><td colspan="4" class="text-center text-danger">Erreur lors du chargement des prospects.</td></tr>';
                    $('#prospectListTableBody').html(html);
                }
            });
        }

        // Function to load prospects by promo ID
        function loadProspectsByPromoId(promoId) {
            // Show loading message
            $('#prospectListTableBody').html('<tr><td colspan="5" class="text-center text-muted">Chargement des prospects...</td></tr>');

            $.ajax({
                url: "{% url 't_tresorerie:ApiGetProspectsList' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'promo_id': promoId
                },
                success: function(data) {
                    var html = '';
                    if (data.prospects && data.prospects.length > 0) {
                        $.each(data.prospects, function(index, prospect) {
                            html += '<tr>';
                            html += '<td><strong>' + prospect.full_name + '</strong></td>';
                            html += '<td>' + prospect.email + '</td>';
                            html += '<td>' + prospect.telephone + '</td>';
                            html += '<td>' + prospect.created_at + '</td>';
                            html += '<td class="text-center"><button type="button" class="btn btn-outline-primary btn-sm btn-consulter-prospect" data-is_double='+prospect.is_double+' data-prospect-id="' + prospect.id + '"><i class="ri-eye-line me-1"></i>Consulter</button></td>';
                            html += '</tr>';
                        });
                    } else {
                        html = '<tr><td colspan="5" class="text-center text-muted">Aucun prospect disponible pour cette promotion</td></tr>';
                    }
                    
                    $('#prospectListTableBody').html(html);
                },
                error: function() {
                    var html = '<tr><td colspan="5" class="text-center text-danger">Erreur lors du chargement des prospects.</td></tr>';
                    $('#prospectListTableBody').html(html);
                }
            });
        }

        // Handle click on specialty-specific prospect button
        $(document).on('click', '.btn-specialite-prospects', function() {
            var specialiteId = $(this).data('specialite-id');
            var currentPromoId = $(this).data('promo');
            var type = $(this).data('type');

            
            // Load the prospects for this specialty within the promotion
            loadProspectsForSpecialite(currentPromoId, specialiteId, type);
            // Show the modal
            $('#prospectListModal').modal('show');
            
        });

        // Function to load prospects for a specific specialty within a promotion
        function loadProspectsForSpecialite(promoId, specialiteId,type) {
            // Show loading message
            $('#prospectListTableBody').html('<tr><td colspan="5" class="text-center text-muted">Chargement des prospects...</td></tr>');
           
            $.ajax({
                url: "{% url 't_tresorerie:ApiGetProspectsList' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'promo_id': promoId,
                    'specialite_id': specialiteId,
                    'type' : type,
                },
                success: function(data) {
                    var html = '';
                    if (data.prospects && data.prospects.length > 0) {
                        $.each(data.prospects, function(index, prospect) {
                            html += '<tr>';
                            html += '<td><strong>' + prospect.full_name + '</strong></td>';
                            html += '<td>' + prospect.email + '</td>';
                            html += '<td>' + prospect.telephone + '</td>';
                            html += '<td>' + prospect.created_at + '</td>';
                            html += '<td class="text-center"><a href="#" type="button" class="btn btn-outline-primary btn-sm btn-consulter-prospect" data-is_double='+prospect.is_double+' data-prospect-id="' + prospect.id + '"><i class="ri-eye-line me-1"></i>Consulter</a></td>';
                            html += '</tr>';
                        });
                    } else {
                        html = '<tr><td colspan="5" class="text-center text-muted">Aucun prospect disponible pour cette sp√©cialit√©</td></tr>';
                    }
                    
                    $('#prospectListTableBody').html(html);
                },
                error: function() {
                    var html = '<tr><td colspan="5" class="text-center text-danger">Erreur lors du chargement des prospects.</td></tr>';
                    $('#prospectListTableBody').html(html);
                }
            });
        }

       
        $(document).on('click','.btn-consulter-prospect', function(){
            var is_double = $(this).data('is_double');
            var id_client = $(this).data('prospect-id');

            console.log(is_double, id_client);
        });

        $(document).on('click','#detailsEcheancierBtn', function(){
            var id_client= $(this).data('id-client');
            var is_double = $(this).data('is_double');

            console.log(is_double, id_client);
        });
        
    });
</script>
{% endblock content %}