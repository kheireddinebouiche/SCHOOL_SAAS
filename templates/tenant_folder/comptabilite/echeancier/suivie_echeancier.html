{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Trésorerie - Suivie des échéanciers{% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Add search box styling */
    .search-box {
        position: relative;
    }
    
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }
    
    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }
    
    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }
    
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item i {
        width: 1.2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    /* Fix dropdown z-index issue */
    .table-responsive {
        overflow-x: visible;
    }
    
    .table td.text-end {
        position: relative;
        overflow: visible;
    }
    
    .table .dropdown-menu {
        z-index: 1050;
        position: absolute;
    }
    
    .view-container {
        display: none;
    }
    
    .view-container.active {
        display: block;
    }
    
    .view-toggle-btn.active {
        background-color: #3b7ddd !important;
        color: white !important;
        border-color: #3b7ddd !important;
    }
    
    .payment-status-badge {
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .payment-status-badge.paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .payment-status-badge.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .payment-status-badge.overdue {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-calendar-check-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Suivie des échéanciers</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Finance</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Suivie des échéanciers</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- View toggle buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary view-toggle-btn active" data-view="promo">Vue par Promotion</button>
                        <button class="btn btn-outline-primary view-toggle-btn" data-view="prospect">Vue par Prospect</button>
                    </div>
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-user-line text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalConvertedProspects">0</h5>
                                    <p class="mb-0 text-muted small">Prospects convertis</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-check-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="paidCount">0</h5>
                                    <p class="mb-0 text-muted small">Paiements effectués</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-time-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="pendingCount">0</h5>
                                    <p class="mb-0 text-muted small">Paiements en attente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-danger bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-danger bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-alert-line text-danger fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="overdueCount">0</h5>
                                    <p class="mb-0 text-muted small">Paiements échus</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View containers -->
            <div class="row">
                <div class="col-lg-12">
                    <!-- View by Promotion -->
                    <div id="promoView" class="view-container active">
                        <div class="card shadow border-0 rounded-3">
                            <div class="card-header bg-white p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-filter text-info me-2"></i>
                                        <h5 class="card-title mb-0 text-info">Filtres - Vue par promotion</h5>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="search-box position-relative">
                                            <input type="text" placeholder="Rechercher..." id="promo-table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                            <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                        </div>
                                        <select id="promoFilter" class="form-select rounded-pill" style="width: 200px;">
                                            <option value="">Toutes les promotions</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="table-responsive" style="overflow-x: visible;">
                                    <table id="promoTable" class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="border-0 rounded-start">Promotion</th>
                                                <th class="border-0">Nombre d'étudiants</th>
                                                <th class="border-0">Total à payer</th>
                                                <th class="border-0">Total payé</th>
                                                <th class="border-0">Reste à payer</th>
                                                <th class="border-0">Taux de paiement</th>
                                                <th class="border-0 rounded-end text-center">Statut</th>
                                            </tr>
                                        </thead>
                                        <tbody id="promoTableBody">
                                            <!-- Data will be loaded here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- View by Prospect -->
                    <div id="prospectView" class="view-container">
                        <div class="card shadow border-0 rounded-3">
                            <div class="card-header bg-white p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-filter text-info me-2"></i>
                                        <h5 class="card-title mb-0 text-info">Filtres - Vue par prospect converti</h5>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="search-box position-relative">
                                            <input type="text" placeholder="Rechercher un prospect..." id="prospect-table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                            <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                        </div>
                                        <div>
                                            <button id="clearDateFilter" class="btn btn-light btn-sm rounded-pill">
                                                <i class="ri-close-line me-1"></i>Effacer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="table-responsive" style="overflow-x: visible;">
                                    <table id="prospectTable" class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="border-0 rounded-start">Nom & Prénom</th>
                                                <th class="border-0">Type de paiement</th>
                                                <th class="border-0">Montant payé</th>
                                                <th class="border-0">Statut</th>
                                                <th class="border-0">Dernière mise à jour</th>
                                                <th class="border-0 rounded-end text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prospectTableBody">
                                            <!-- Data will be loaded here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>
    $(document).ready(function(){
        // Initialize with promo view
        $('#promoView').addClass('active');
        $('#prospectView').removeClass('active');
        
        // View toggle functionality
        $('.view-toggle-btn').on('click', function(){
            var view = $(this).data('view');
            
            // Remove active class from buttons
            $('.view-toggle-btn').removeClass('active');
            
            // Add active class to clicked button
            $(this).addClass('active');
            
            // Hide all view containers
            $('.view-container').removeClass('active');
            
            // Show selected view container
            $('#' + view + 'View').addClass('active');
        });
        
        // Load initial data
        loadPromoData();
        loadProspectData();
        
        // Search functionality for promo view
        $('#promo-table-filter').on('keyup', function() {
            applyPromoFilter();
        });
        
        // Search functionality for prospect view
        $('#prospect-table-filter').on('keyup', function() {
            applyProspectFilter();
        });
        
        // Filter by promo in prospect view
        $('#prospectPromoFilter').on('change', function() {
            applyProspectFilter();
        });
        
        // Filter by status in prospect view
        $('#prospectStatusFilter').on('change', function() {
            applyProspectFilter();
        });
        
        // Filter by promo in promo view
        $('#promoFilter').on('change', function() {
            applyPromoFilter();
        });
        
        // Load promo data from API
        function loadPromoData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadConvertedProspects' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(response) {
                    // Convert API data to match the expected format
                    allPromoData = response.promos.map(function(promo) {
                        var totalToPay = promo.montant_total || 0;
                        var totalPaid = promo.montant_paye || 0;
                        var remaining = totalToPay - totalPaid;
                        var paymentRate = totalToPay > 0 ? (totalPaid / totalToPay) * 100 : 0;
                        
                        return {
                            id: promo.id,
                            name: promo.session + ' (' + promo.begin_year + '-' + promo.end_year + ')',
                            code: promo.code, // Store the code for filtering
                            studentCount: promo.total_inscrit || 0,
                            totalToPay: totalToPay,
                            totalPaid: totalPaid,
                            remaining: remaining,
                            paymentRate: paymentRate
                        };
                    });
                    
                    // Update statistics
                    updatePromoStatistics(allPromoData);
                    
                    // Render data
                    renderPromoTable(allPromoData);
                    
                    // Populate the promo filter dropdown
                    populatePromoFilter();
                },
                error: function() {
                    console.error("Erreur lors du chargement des données des promotions");
                    var html = '<tr><td colspan="7" class="text-center text-danger">Erreur lors du chargement des données des promotions.</td></tr>';
                    $('#promoTableBody').html(html);
                }
            });
        }
        
        // Store all prospect data for filtering (converted prospects only)
        var allProspectData = [];
        var currentProspectSearchTerm = '';

        // Load prospect data (converted prospects with due payments)
        function loadProspectData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadConvertedProspects' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(response) {
                    // Store all data for filtering (using clients array from response)
                    allProspectData = response.clients;
                    
                    // Render data
                    renderProspectTable(response.clients);
                   
                },
                error: function() {
                    console.error("Erreur lors du chargement des données");
                    var html = '<tr><td colspan="6" class="text-center text-danger">Erreur lors du chargement des données.</td></tr>';
                    $('#prospectTableBody').html(html);
                }
            });
        }
        
        // Render promo table
        function renderPromoTable(data) {
            var html = '';
            if (data.length > 0) {
                $.each(data, function(index, item) {
                    html += '<tr>';
                    html += '<td><div class="fw-medium">' + item.name + '</div></td>';
                    html += '<td><div class="fw-medium">' + item.studentCount + '</div></td>';
                    html += '<td><div class="fw-medium">' + item.totalToPay.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td><div class="fw-medium text-success">' + item.totalPaid.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td><div class="fw-medium text-danger">' + item.remaining.toLocaleString('fr-FR') + ' DA</div></td>';
                    html += '<td>' + '<div class="progress" style="height: 10px;"><div class="progress-bar" role="progressbar" style="width: ' + item.paymentRate + '%;" aria-valuenow="' + item.paymentRate + '" aria-valuemin="0" aria-valuemax="100"></div></div>';
                    html += '<div class="text-center mt-1">' + item.paymentRate.toFixed(1) + '%</div>';
                    html += '</td>';
                    html += '<td class="text-center"><span class="payment-status-badge ' + (item.paymentRate > 80 ? 'paid' : item.paymentRate > 50 ? 'pending' : 'overdue') + '">' + (item.paymentRate > 80 ? 'Bon' : item.paymentRate > 50 ? 'Moyen' : 'Faible') + '</span></td>';
                    html += '</tr>';
                });
            } else {
                html = '<tr><td colspan="7" class="text-center text-muted">Aucune donnée disponible</td></tr>';
            }
            
            $('#promoTableBody').html(html);
        }
        
        // Render prospect table (converted prospects only)
        function renderProspectTable(data) {
            var html = '';
            if (data.length > 0) {
                $.each(data, function(index, client) {
                    html += '<tr>';
                    html += '<td><strong><a href="/comptabilite/tresorerie/details-prospect/'+client.id+'">' + (client.nom || '') + " " + (client.prenom || '') + '</a></strong></td>';
                    html += '<td><strong>Frais de formation</strong></td>'; // Using a default value since context isn't in the response
                    html += '<td><strong>' + (client.total_paye ? parseFloat(client.total_paye).toLocaleString('fr-FR') : '0') + ' DA</strong></td>';
                    html += '<td><strong><span class="badge bg-success">Payé</span></strong></td>'; // Assuming paid since they have payment records
                    html += '<td></td>';
                    
                    var actions = '<div class="dropdown d-inline-block">'+
                        '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">'+
                        '<i class="ri-more-fill align-middle"></i>'+
                        '</button>'+
                        '<ul class="dropdown-menu dropdown-menu-end">'+
                        '<li><a href="/comptabilite/tresorerie/details-suivie-echeancier/'+client.id+'" class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i> Détails</a></li>'+
                        '<li><a href="/comptabilite/tresorerie/paiements-prospect/'+client.id+'" class="dropdown-item"><i class="ri-money-dollar-circle-line align-bottom me-2 text-muted"></i> Paiements</a></li>'+
                        '</ul>'+
                        '</div>';
                    html += '<td class="text-center">' + actions + '</td>';
                    html += '</tr>';
                });
            } else {
                html = '<tr><td colspan="6" class="text-center text-muted">Aucune donnée disponible</td></tr>';
            }
            
            $('#prospectTableBody').html(html);
        }
        
        // Update promo statistics
        function updatePromoStatistics(data) {
            var totalStudents = 0;
            var totalPaid = 0;
            var totalPending = 0;
            var totalOverdue = 0;
            
            $.each(data, function(index, item) {
                totalStudents += item.studentCount;
                
                // Calculate based on actual payment rates from the API
                if (item.paymentRate >= 100) {
                    totalPaid += item.studentCount;
                } else if (item.paymentRate > 0) {
                    // Estimate based on payment percentage
                    var paidCount = Math.floor(item.studentCount * (item.paymentRate / 100));
                    var pendingCount = item.studentCount - paidCount;
                    totalPaid += paidCount;
                    totalPending += pendingCount;
                } else {
                    // If no payment made, all are overdue/awaiting payment
                    totalOverdue += item.studentCount;
                }
            });
            
            $('#totalConvertedProspects').text(totalStudents);
            $('#paidCount').text(totalPaid);
            $('#pendingCount').text(totalPending);
            $('#overdueCount').text(totalOverdue);
        }
        
        // Store all promo data for filtering
        var allPromoData = [];

        // Populate promo filter dropdown
        function populatePromoFilter() {
            var promoFilter = $('#promoFilter');
            promoFilter.empty(); // Clear existing options
            
            // Add default option
            promoFilter.append($('<option>', {
                value: '',
                text: 'Toutes les promotions'
            }));
            
            // Add options from the loaded data
            $.each(allPromoData, function(index, promo) {
                promoFilter.append($('<option>', {
                    value: promo.code.toLowerCase(),
                    text: promo.name
                }));
            });
        }

        // Apply promo filter
        function applyPromoFilter() {
            var searchTerm = $('#promo-table-filter').val().toLowerCase();
            var promoFilter = $('#promoFilter').val();
            
            // Filter the stored data
            var filteredData = allPromoData;
            
            // Apply search filter
            if (searchTerm) {
                filteredData = filteredData.filter(function(promo) {
                    return (
                        promo.name.toLowerCase().includes(searchTerm) ||
                        promo.code.toLowerCase().includes(searchTerm) ||
                        promo.studentCount.toString().includes(searchTerm)
                    );
                });
            }
            
            // Apply promo-specific filter if needed
            if (promoFilter) {
                filteredData = filteredData.filter(function(promo) {
                    return promo.code.toLowerCase().includes(promoFilter.toLowerCase());
                });
            }
            
            // Render the filtered data
            renderPromoTable(filteredData);
        }
        
        // Search functionality for prospect view
        $('#prospect-table-filter').on('keyup', function() {
            console.log('Search term:', this.value); // Debug log
            currentProspectSearchTerm = this.value.toLowerCase();
            applyProspectFilters();
        }).on('focus', function() {
            console.log('Search input focused'); // Debug log
        }).on('click', function() {
            console.log('Search input clicked'); // Debug log
        });
        
        // Enhanced filtering that combines search and date filters for prospect view
        function applyProspectFilters() {
            var filteredData = allProspectData;
            
            // Apply search filter
            if (currentProspectSearchTerm) {
                filteredData = filteredData.filter(function(client) {
                    // Search in client name
                    return (
                        (client.nom && client.nom.toLowerCase().includes(currentProspectSearchTerm)) ||
                        (client.prenom && client.prenom.toLowerCase().includes(currentProspectSearchTerm)) ||
                        (client.email && client.email.toLowerCase().includes(currentProspectSearchTerm)) ||
                        (client.telephone && client.telephone.toLowerCase().includes(currentProspectSearchTerm))
                    );
                });
            }
            
            // Add filtered data to table
            renderProspectTable(filteredData);
        }
        
        // Clear date filter button
        $(document).on('click', '#clearDateFilter', function(){
            $('#prospect-table-filter').val('');
            currentProspectSearchTerm = '';
            applyProspectFilters();
        });
        
        // Also filter when pressing Enter in date fields
        $(document).on('keypress', '#dateFrom, #dateTo', function(e){
            if (e.which === 13) { // Enter key
                applyProspectFilters();
            }
        });

        
    });
</script>
{% endblock content %}