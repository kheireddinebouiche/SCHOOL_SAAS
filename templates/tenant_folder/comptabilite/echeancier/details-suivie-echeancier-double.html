{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Trésorerie - Suivie des echeanciers {% endblock title %}

{% block content %}
<style>
    :root {
        --primary-color: #3b7ddd;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --dark-text: #212529;
        --light-text: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        --transition: all 0.3s ease;
    }
    
    /* Ajout du dégradé primaire */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #3b7ddd 0%, #1a56b0 100%) !important;
    }
    
    ._inputDetails {
       background-color: transparent !important;
       border : none !important;
       outline : none;
       font-weight : 700 !important;
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .echeancier-special-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .percentage-input {
        width: 80px;
    }
    
    .montant-cell {
        font-weight: 600;
    }
    
    .total-row {
        background-color: #e9ecef;
        font-weight: 700;
    }
    
    .card-equal-height {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .card-equal-height .card-body {
        flex: 1 1 auto;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Nouveaux styles pour une disposition moderne */
    
    .section-card {
        transition: var(--transition);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        margin-bottom: 1.5rem;
        border: none;
    }
    
    /* Styles pour les tables de paiements */
    .payment-table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        background-color: #f8f9fa;
    }
    
    .payment-table td {
        vertical-align: middle;
    }
    
    .amount-due {
        color: var(--warning-color);
        font-weight: 600;
    }
    
    .amount-paid {
        color: var(--success-color);
        font-weight: 600;
    }
    
    .amount-balance {
        color: var(--danger-color);
        font-weight: 700;
    }
    
    .action-cell {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-payment-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-payment-action i {
        margin-right: 0.25rem;
    }
    
    .badge-payment-status {
        padding: 0.25em 0.4em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        display: inline-block;
    }
    
    .badge-payment-due {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .badge-payment-paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .badge-payment-partial {
        background-color: rgba(23, 162, 184, 0.2);
        color: #17a2b8;
    }
    
    /* Styles pour les cellules de montant avec ombre */
    .amount-cell {
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .amount-due-cell {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    
    .amount-paid-cell {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    .amount-balance-cell {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .section-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    .section-card .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1rem 1.5rem;
    }
    
    .section-card .card-body {
        padding: 1.5rem;
    }
    
    .sticky-top-custom {
        position: sticky;
        top: 20px;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: var(--transition);
        border: none;
    }
    
    .btn-action i {
        margin-right: 0.5rem;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .btn-warning {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .info-card {
        border-left: 4px solid;
    }
    
    .info-card.demandeur {
        border-left-color: var(--primary-color);
    }
    
    .info-card.formation {
        border-left-color: var(--success-color);
    }
    
    /* Styles pour les onglets de navigation */
    .nav-tabs-custom {
        border-bottom: 2px solid #e9ecef;
    }
    
    .nav-tabs-custom .nav-item {
        margin-bottom: -2px;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        border-bottom: 2px solid transparent;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        transition: all 0.3s ease;
        color: var(--light-text);
    }
    
    .nav-tabs-custom .nav-link.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background-color: transparent;
    }
    
    .nav-tabs-custom .nav-link:hover:not(.active) {
        color: var(--dark-text);
        border-bottom-color: #adb5bd;
    }
    
    .nav-tabs-custom .nav-link i {
        margin-right: 0.5rem;
    }
    
    .tab-content {
        min-height: 300px;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .notification-banner {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 1rem;
        border: none;
    }
    
    .avatar-lg {
        width: 4rem;
        height: 4rem;
    }
    
    .avatar-md {
        width: 3rem;
        height: 3rem;
    }
    
    .avatar-sm {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    .stats-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        background: white;
        box-shadow: var(--box-shadow);
    }
    
    .stats-card .number {
        font-size: 2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    
    .stats-card .label {
        font-size: 0.9rem;
        color: var(--light-text);
    }
    
    .payment-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--light-bg);
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .payment-summary .amount {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .payment-summary .status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    @media (max-width: 992px) {
        .sticky-top-custom {
            position: static;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
        }
    }
    
    /* Fix dropdown z-index issue */
    .dropdown {
        position: relative;
    }
    
    .dropdown-menu {
        z-index: 9999 !important;
        position: absolute !important;
    }
    
    /* Ensure dropdown is visible */
    .table-responsive {
        overflow: visible !important;
    }
    
    .action-cell {
        overflow: visible !important;
        position: relative;
    }
    
    /* Additional dropdown fixes */
    .dropdown-menu-end {
        right: 0 !important;
        left: auto !important;
    }
    
    /* Force dropdown to appear above all elements */
    .dropdown-menu.show {
        z-index: 99999 !important;
        transform: translate3d(0px, 38px, 0px) !important;
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.lordicon.com/lordicon.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    // Function to load special schedule details into the modal
    function loadSpecialEcheancierDetails() {
        // Get client ID from the hidden field
        const clientId = document.getElementById('clientIdInput').value;
        
        if (!clientId) {
            console.error('Client ID not found');
            return;
        }
        
        // Make API call to get client echeancier data
        fetch(`/t_tresorerie/api-get-client-echeancier/?id=${clientId}`)
            .then(response => response.json())
            .then(data => {
                if (data.special_echeancier_line && data.special_echeancier_line.length > 0) {
                    const tableBody = document.querySelector('#echeancierSpecialLinesTable');
                    tableBody.innerHTML = ''; // Clear existing content
                    
                    // Populate the table with special schedule lines
                    data.special_echeancier_line.forEach(line => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${line.id_echeancier_special}</td>
                            <td>${line.taux}%</td>
                            <td>${parseFloat(line.montant_tranche).toLocaleString('fr-DZ', {minimumFractionDigits: 2, maximumFractionDigits: 2})} DA</td>
                            <td>${line.date_echeancier}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    // Show a message if no special schedule lines are available
                    const tableBody = document.querySelector('#echeancierSpecialLinesTable');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted py-3">
                                <i class="ri-information-line me-2"></i>
                                Aucun échéancier spécial disponible
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading special echeancier details:', error);
            });
    }

    // Add event listener to the modal when it's shown
    document.addEventListener('DOMContentLoaded', function() {
        const specialEcheancierModal = document.getElementById('echeancierSpecialDetailsModal');
        if (specialEcheancierModal) {
            specialEcheancierModal.addEventListener('shown.bs.modal', function() {
                loadSpecialEcheancierDetails();
            });
        }
    });
</script>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">

    <div class="page-content">
        <div class="container-fluid">
            
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-money-dollar-circle-line text-info"></i>
                            </div>
                            <h4 class="mb-0 text-info">Suivie des echéanciers</h4>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#aideTraitementPaiementModal">
                                <i class="ri-question-line me-1"></i> Aide
                            </button>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Suivie des echéanciers</li>
                                    
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Notifications -->
            <div class="row mb-4">
                <div class="col-12">
                    <!-- Notification d'échéancier spécial avec bouton Détails -->
                    <div style="display: none !important" class="alert alert-info d-flex align-items-center notification-banner mt-2" role="alert" id="echeancierSpecialNotification">
                        <i class="ri-star-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>Un échéancier spécial est disponible pour ce demandeur.</strong>
                            <p class="mb-0 text-muted small">Cliquez sur détails pour voir les informations de l'échéancier.</p>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <button type="button" class="btn btn-primary btn-sm" id="showEcheancierSpecialNotification">
                                <i class="ri-eye-line me-1"></i>Détails
                            </button>
                        </div>
                    </div>

                    <!-- Notification d'échéancier en cours d'examen -->
                    <div style="display: none !important" class="alert alert-warning d-flex align-items-center notification-banner" role="alert" id="echeancierExamenNotification">
                        <i class="ri-time-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>L'échéancier demandé est actuellement en cours d'examen.</strong>
                            <p class="mb-0 text-muted small">Veuillez patienter pendant que nous traitons votre demande.</p>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <button type="button" class="btn btn-warning btn-sm" id="showEcheancierExamenDetails">
                                <i class="ri-eye-line me-1"></i>Détails
                            </button>
                        </div>
                    </div>

                    <!-- Notification de succès pour echeancier special appliquée -->
                    <div style="display: none !important;" class="alert alert-success d-flex align-items-center notification-banner" role="alert" id="applicedEcheancierSpecial">
                        <i class="ri-checkbox-circle-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>Le client à bénificier d'un echéancier spécial !</strong>
                            <p class="mb-0 text-muted small">L'echéancier est valider.</p>
                        </div>
                    </div>

                        <!-- Notification de réduction avec bouton Consulter -->
                    <div style="display: none !important;" class="alert alert-warning d-flex align-items-center notification-banner" role="alert" id="reductionNotification" >
                        <i class="ri-error-warning-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>Le demandeur bénéficie d'une réduction de prix.</strong>
                            <p class="mb-0 text-muted small">Cliquez sur consulter pour voir les détails de la réduction.</p>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#reductionDetailsModal">
                                <i class="ri-eye-line me-1"></i>Consulter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Notification de succès pour la réduction appliquée -->
                    <div  style="display: none !important;" class="alert alert-success d-flex align-items-center notification-banner" role="alert" id="reductionSuccessNotification">
                        <i class="ri-checkbox-circle-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>Réduction appliquée avec succès !</strong>
                            <p class="mb-0 text-muted small">La réduction a été appliquée à la formation.</p>
                        </div>
                    </div>
                    
                    <!-- Notification d'attente de remboursement -->
                    <div style="display: none !important;" class="alert alert-warning d-flex align-items-center notification-banner" role="alert" id="remboursementEnAttenteNotification">
                        <i class="ri-refund-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>Remboursement en attente de traitement.</strong>
                            <p class="mb-0 text-muted small">Une demande de remboursement a été soumise et est en cours de traitement.</p>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#remboursementDetailsModal">
                                <i class="ri-eye-line me-1"></i>Détails
                            </button>
                        </div>
                    </div>
                    
                    <!-- Notification de remboursement traité -->
                    <div style="display: none !important;" class="alert alert-success d-flex align-items-center notification-banner" role="alert" id="remboursementTraiteNotification">
                        <i class="ri-check-line me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <strong>Remboursement traité avec succès !</strong>
                            <p class="mb-0 text-muted small">La demande de remboursement a été traitée et validée.</p>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <button id="btnShowRefundResult" type="button" class="btn btn-success btn-sm" >
                                <i class="ri-eye-line me-1"></i>Détails
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main content -->
            <div class="row">
                <!-- Left column - Informations -->
                <div class="col-xl-4 col-lg-5">
                    <div class="sticky-top-custom">
                        <!-- Informations du demandeur -->
                        <div class="card section-card info-card demandeur mb-4">
                            <div class="card-header bg-white">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                                        <i class="ri-user-line text-primary fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-primary mb-0">Informations du demandeur</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                            <i class="ri-user-line text-primary fs-3"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <input type="hidden" id="clientIdInput" value="{{ pk }}" /> 
                                        <h5 class="mb-1" id="demandeur"></h5>
                                        <p class="text-muted mb-0 small">Nom complet</p>
                                    </div>
                                    <button class="btn btn-sm btn-link p-0" data-bs-toggle="modal" data-bs-target="#clientDetailsModal">
                                        <i class="ri-link"></i>
                                    </button>
                                </div>
                                <div class="d-flex align-items-center mb-4">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                            <i class="ri-calendar-line text-primary fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1" id="created_at"></h6>
                                        <p class="text-muted mb-0 small">Date de demande</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                            <i class="ri-file-text-line text-primary fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1" id="statutClient"></h6>
                                        <p class="text-muted mb-0 small">Statut</p>
                                    </div>
                                </div>
                            </div> 
                        </div>
                        
                        <!-- Informations sur la formation -->
                        <div class="card section-card info-card formation mb-4">
                            <div class="card-header bg-white">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-2 me-3">
                                        <i class="ri-book-line text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-success mb-0">Informations sur la formation</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                            <i class="ri-book-line text-success fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1" id="specialite"></h6>
                                        <p class="text-muted mb-0 small">Spécialité</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mb-4">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                            <i class="ri-graduation-cap-line text-success fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1" id="promo"></h6>
                                        <p class="text-muted mb-0 small">Promo</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                            <i class="ri-money-dollar-circle-line text-success fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1" id="prix_formation"></h6>
                                        <p class="text-muted mb-0 small">Prix de la formation</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Summary -->
                        <div class="card section-card">
                            <div class="card-header bg-white">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-2 me-3">
                                        <i class="ri-money-cny-circle-line text-info fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-info mb-0">Résumé des paiements</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="payment-summary">
                                    <div>
                                        <div class="text-muted small">Total dû</div>
                                        <div class="amount text-primary" id="totalDueAmount">0.00 DA</div>
                                    </div>
                                    <span class="status bg-warning bg-opacity-10 text-warning">En attente</span>
                                </div>
                                <div class="payment-summary">
                                    <div>
                                        <div class="text-muted small">Total payé</div>
                                        <div class="amount text-success" id="totalPaidAmount">0.00 DA</div>
                                    </div>
                                    <span class="status bg-success bg-opacity-10 text-success">Payé</span>
                                </div>
                                <div class="payment-summary mb-0">
                                    <div>
                                        <div class="text-muted small">Solde</div>
                                        <div class="amount text-danger" id="balanceAmount">0.00 DA</div>
                                    </div>
                                    <span class="status bg-danger bg-opacity-10 text-danger">Restant</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right column - Payment details -->
                <div class="col-xl-8 col-lg-7">
                    <!-- Action buttons -->
                    <div class="card section-card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="mb-3 mb-md-0">Actions disponibles</h5>
                                <div class="action-buttons">
                                    <button id="btnPrintEngagement" class="btn btn-success btn-action">
                                        <i class="ri-printer-line"></i> Imprimer Engagement
                                    </button>
                                    <button type="button" class="btn btn-primary btn-action" data-bs-toggle="modal" data-bs-target="#consultationEcheancierModal">
                                        <i class="ri-eye-line me-1"></i> Consulter l'échéancier
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Hidden fields for logo URLs -->
                            <input type="hidden" id="_logoHeader" />
                            <input type="hidden" id="_logoFooter" />
                        </div>
                    </div>
                    <!-- Payment sections -->
                    <div class="row">
                        <!-- Paiements -->
                        <div class="col-12">
                            <div class="card section-card h-100">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-2 me-3">
                                                <i class="ri-money-cny-circle-line text-info fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-info mb-0">Paiements</h5>
                                                <p class="text-muted small mb-0">Suivi des paiements effectués</p>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 mt-2 mt-md-0">
                                            <button id="btnNewPaiementModal" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nouveauPaiementModal">
                                                <i class="ri-add-line me-1"></i>Nouveau paiement
                                            </button>
                                            <button id="btnRefundRequestModal" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#refundModal">
                                                <i class="ri-refund-line me-1"></i>Remboursement
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs nav-tabs-custom nav-primary mb-4" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-bs-toggle="tab" href="#nav-border-top-paiement_dus" role="tab" aria-selected="false">
                                                <i class="ri-money-dollar-circle-line me-1 align-middle"></i> Dus 
                                                <span class="badge bg-warning rounded-circle ms-1" id="NbrPaiementDue">0</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#nav-border-top-paiements_done" role="tab" aria-selected="false">
                                                <i class="ri-check-double-line me-1 align-middle"></i> Effectués
                                                <span class="badge bg-success rounded-circle ms-1" id="NbrPaiementDone">0</span>
                                            </a>
                                        </li>
                                    </ul>
                                    <div class="tab-content text-muted">
                                        <div class="tab-pane active" id="nav-border-top-paiement_dus" role="tabpanel">
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle table-nowrap mb-0 payment-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th scope="col">Description</th>
                                                            <th scope="col">Date d'échéance</th>
                                                            <th scope="col">Montant dû</th>
                                                            <th scope="col">Restant à payer</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="ListePaiementRequestLine">
                                                        
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="nav-border-top-paiements_done" role="tabpanel">
                                            <div class="table-responsive">
                                                    <table class="table table-hover align-middle table-nowrap mb-0 payment-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th scope="col">N° Reçu</th>
                                                            <th scope="col">Description</th>
                                                            <th scope="col">Montant payé</th>
                                                            <th scope="col">Date de paiement</th>
                                                            <th scope="col">Mode</th>
                                                            <th scope="col">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="ListePaiementRequestLineDone">
                                                        <!-- Liste des paiements effectués -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal de configuration de la facture -->
<div class="modal fade" id="invoiceConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0 py-3">
                <h5 class="modal-title fw-bold">
                    <i class="ri-file-list-3-line me-2"></i>Configuration de la facture
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="modalPaiementId">
                <div class="mb-4">
                    <label class="form-label fw-semibold text-muted mb-2">Sélectionner le taux de TVA</label>
                    <div class="row g-3">
                        <div class="col-4">
                            <input type="radio" class="btn-check" name="tvaRate" id="tva0" value="0">
                            <label class="btn btn-outline-success w-100 py-3" for="tva0">
                                <span class="d-block fw-bold fs-5">0%</span>
                                <small>Sans TVA</small>
                            </label>
                        </div>
                        <div class="col-4">
                            <input type="radio" class="btn-check" name="tvaRate" id="tva9" value="9">
                            <label class="btn btn-outline-success w-100 py-3" for="tva9">
                                <span class="d-block fw-bold fs-5">9%</span>
                                <small>Taux réduit</small>
                            </label>
                        </div>
                        <div class="col-4">
                            <input type="radio" class="btn-check" name="tvaRate" id="tva19" value="19" checked>
                            <label class="btn btn-outline-success w-100 py-3" for="tva19">
                                <span class="d-block fw-bold fs-5">19%</span>
                                <small>Taux normal</small>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info border-0 bg-info bg-opacity-10 d-flex align-items-center mb-0" role="alert">
                    <i class="ri-information-line fs-4 me-3 text-info"></i>
                    <div class="small text-info">
                        L'invoice sera générée avec le numéro suivant dans la séquence de facturation.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success px-4 bg-gradient-success shadow-sm" id="confirmGenerateInvoice">
                    <i class="ri-check-line me-1"></i> Générer la facture
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Échéancier (Première étape) -->
<div class="modal fade" id="confirmEcheancierModal" tabindex="-1" aria-labelledby="confirmEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmEcheancierModalLabel">Confirmation de l'échéancier</h5>
                        <p class="text-muted small mb-0">Veuillez confirmer l'échéancier de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                            <i class="ri-check-double-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Confirmer l'échéancier de paiement</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir confirmer cet échéancier ?</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        En confirmant cet échéancier, vous acceptez les termes et conditions associés. Cette action est irréversible.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmEcheancierBtn">
                    <i class="ri-check-line me-2"></i>Voir les détails
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de Confirmation (Deuxième étape) -->
<div class="modal fade" id="confirmationDetailsModal" tabindex="-1" aria-labelledby="confirmationDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-text-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="confirmationDetailsModalLabel">Détails de confirmation</h5>
                        <p class="text-muted small mb-0">Récapitulatif de l'échéancier de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Informations de la formation</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Spécialité:</span>
                                    <span class="fw-medium" id="modalSpecialite"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="modalPromo"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Prix de la formation:</span>
                                    <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                </div>
                                <div class="d-flex justify-content-between" id="modalPrixFinalRow" style="display: none;">
                                    <span class="text-muted">Prix final (avec réduction):</span>
                                    <span class="fw-bold text-success" id="modalPrixFinal"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Échéancier de paiement</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Libellé</th>
                                                <th>Date d'échéance</th>
                                                <th>Montant</th>
                                                <th id="modalPrixFinalHeader" style="display: none;">Prix final</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalEcheancesTable">
                                            <!-- Échéances seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En confirmant ces informations, l'échéancier sera définitivement enregistré dans le système.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="finalConfirmBtn">
                    <i class="ri-check-double-line me-2"></i>Confirmer définitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de Confirmation -->
<div class="modal fade" id="confirmationDetailsModal" tabindex="-1" aria-labelledby="confirmationDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-text-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="confirmationDetailsModalLabel">Détails de confirmation</h5>
                        <p class="text-muted small mb-0">Récapitulatif de l'échéancier de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Informations de la formation</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Spécialité:</span>
                                    <span class="fw-medium" id="modalSpecialite"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="modalPromo"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Prix de la formation:</span>
                                    <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                </div>
                                <div class="d-flex justify-content-between" id="modalPrixFinalRow" style="display: none;">
                                    <span class="text-muted">Prix final (avec réduction):</span>
                                    <span class="fw-bold text-success" id="modalPrixFinal"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Échéancier de paiement</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Libellé</th>
                                                <th>Date d'échéance</th>
                                                <th>Montant</th>
                                                <th id="modalPrixFinalHeader" style="display: none;">Prix final</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalEcheancesTable">
                                            <!-- Échéances seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En confirmant ces informations, l'échéancier sera définitivement enregistré dans le système.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="finalConfirmBtn">
                    <i class="ri-check-double-line me-2"></i>Confirmer définitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Échéancier Spécial -->
<div class="modal fade" id="specialEcheancierModal" tabindex="-1" aria-labelledby="specialEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-star-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="specialEcheancierModalLabel">Échéancier spécial</h5>
                        <p class="text-muted small mb-0">Générez un échéancier personnalisé</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card border border-primary card-equal-height">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0 text-primary">Informations de la formation</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Spécialité:</span>
                                    <span class="fw-medium" id="modalSpecialite"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="modalPromo"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Prix de la formation:</span>
                                    <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card border border-warning card-equal-height">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h6 class="mb-0 text-warning">Configuration de l'échéancier</h6>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="mb-3">
                                    <label for="nombreTranches" class="form-label fw-medium">Nombre de tranches</label>
                                    <input type="number" class="form-control border-0 bg-light py-2" id="nombreTranches" min="1" value="3">
                                </div>
                                <div class="mt-auto">
                                    <button class="btn btn-warning w-100" id="genererTranchesBtn">
                                        <i class="ri-refresh-line me-1"></i>Générer les tranches
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Échéancier généré</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0 echeancier-special-table">
                                        <thead>
                                            <tr>
                                                <th>Tranche</th>
                                                <th>Pourcentage</th>
                                                <th>Montant</th>
                                                <th>Date d'échéance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="specialEcheancierTable">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-4">
                                                    <i class="ri-information-line me-2"></i>
                                                    Veuillez générer les tranches en cliquant sur le bouton ci-dessus
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot id="specialEcheancierFooter">
                                            <tr class="total-row">
                                                <td><strong>Total</strong></td>
                                                <td id="totalPercentage">0%</td>
                                                <td id="totalAmount">0 DA</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div id="percentageWarning" class="alert alert-info mt-3" role="alert">
                                    <i class="ri-information-line me-2"></i>
                                    <span>Modifiez les pourcentages manuellement. La somme totale peut dépasser ou être inférieure à 100%.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="saveSpecialEcheancierBtn" disabled>
                    <i class="ri-save-line me-2"></i>Enregistrer l'échéancier
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Enregistrement Échéancier Spécial -->
<div class="modal fade" id="confirmSaveEcheancierModal" tabindex="-1" aria-labelledby="confirmSaveEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-alert-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="confirmSaveEcheancierModalLabel">Confirmation d'enregistrement</h5>
                        <p class="text-muted small mb-0">Échéancier spécial</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-warning bg-opacity-10 text-warning display-5 rounded-circle">
                            <i class="ri-file-warning-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Enregistrer l'échéancier spécial</h5>
                    <p class="text-muted">Vous êtes sur le point d'enregistrer cet échéancier.</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        Cet échéancier sera soumis à validation par un responsable avant d'être définitivement appliqué.
                    </div>
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="confirmValidationCheck">
                    <label class="form-check-label" for="confirmValidationCheck">
                        Je comprends que cet échéancier nécessite une validation
                    </label>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="confirmSaveEcheancierBtn" disabled>
                    <i class="ri-checkbox-circle-line me-2"></i>Confirmer l'enregistrement
                </button>
            </div>
        </div>
    </div>
</div>

<div id="paiementsModal" class="modal fade" tabindex="-1" aria-labelledby="paiementsModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-money-dollar-circle-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="paiementsModalLabel">Enregistrement de paiement</h5>
                        <p class="text-muted small mb-0">Saisissez les détails du paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
               
                <div class="row">
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="due_paiements">Veuillez sélectionner le paiement dû :</label>
                        <select  required class="form-control border-0 bg-light py-2" id="due_paiements" >

                        </select>
                    </div>
                     <div class="col-lg-4">
                        <label class="form-label fw-medium" for="date_paiement">Date de paiement :</label>
                        <input type="date" required class="form-control border-0 bg-light py-2" id="date_paiement" />
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="received_amount">Montant reçu :</label>
                        <input type="text" required class="form-control border-0 bg-light py-2" id="received_amount" />
                    </div>
                </div> 
                <div class="row mt-2">
                    <div class="col-lg-6">
                        <label class="form-label fw-medium" for="paiement_mode">Mode de paiement:</label>
                        <select class="form-control border-0 bg-light py-2" id="paiement_mode">
                            <option value="esp">Espèce</option>
                            <option value="che">Chèque</option>
                            <option value="vir">Virement</option>
                        </select>
                    </div>
                     <div class="col-lg-6">
                        <label for="paiement_ref" class="form-label fw-medium">Référence de paiement </label>
                        <input type="text" class="form-control border-0 bg-light py-2" id="paiement_ref" />
                    </div>
                    
                </div>
                <div class="row mt-2 ">
                    <div class="col-lg-12">
                        <label for="observation" class="form-label fw-medium">Observations</label>
                        <textarea class="form-control border-0 bg-light py-2" id="observation"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="StorePaimentBnt">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
       
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="paiementsModalDetails" class="modal fade" tabindex="-1" aria-labelledby="paiementsModalDetailsLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-list-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="paiementsModalDetailsLabel">Détails du paiement</h5>
                        <p class="text-muted small mb-0">Informations détaillées sur le paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
               
                <div class="row">
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="due_paiements">Veuillez sélectionner le paiement dû :</label>
                        <select  required class="form-control border-0 bg-light py-2" id="due_paiements" >

                        </select>
                    </div>
                     <div class="col-lg-4">
                        <label class="form-label fw-medium" for="date_paiement">Date de paiement :</label>
                        <input type="date" required class="form-control border-0 bg-light py-2" id="date_paiement" />
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="received_amount">Montant reçu :</label>
                        <input type="text" required class="form-control border-0 bg-light py-2" id="received_amount" />
                    </div>
                </div> 
                <div class="row mt-2">
                    <div class="col-lg-6">
                        <label class="form-label fw-medium" for="paiement_mode">Mode de paiement:</label>
                        <select class="form-control border-0 bg-light py-2" id="paiement_mode">
                            <option value="esp">Espèce</option>
                            <option value="che">Chèque</option>
                            <option value="vir">Virement</option>
                        </select>
                    </div>
                     <div class="col-lg-6">
                        <label for="paiement_ref" class="form-label fw-medium">Référence de paiement </label>
                        <input type="text" class="form-control border-0 bg-light py-2" id="paiement_ref" />
                    </div>
                    
                </div>
                <div class="row mt-2 ">
                    <div class="col-lg-12">
                        <label for="observation" class="form-label fw-medium">Observations</label>
                        <textarea class="form-control border-0 bg-light py-2" id="observation"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="StorePaimentBnt">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
       
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-body text-center p-5">
                <div class="avatar-lg mx-auto mb-4">
                    <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                        <i class="ri-close-circle-line"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <h4 class="mb-3">Vous êtes sur le point de supprimer le paiement</h4>
                    <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                    <div class="hstack gap-2 justify-content-center">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Demande de remboursement de paiement -->
<div class="modal fade refundModal" tabindex="-1" role="dialog" aria-labelledby="refundModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-body p-5">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-refund-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1">Demande de remboursement</h5>
                        <p class="text-muted small mb-0">Soumettre une demande de remboursement</p>
                    </div>
                </div>
                <div class="mt-4">
                    <h4 class="mb-3">Vous êtes sur le point de faire une demande de remboursement</h4>
                    <p class="text-muted mb-4">La demande de remboursement doit être validée par un compte de niveau supérieur. Veuillez indiquer le motif du remboursement.</p>
                    
                    <div class="mb-4">
                        <label for="refundReason" class="form-label fw-medium">Motif du remboursement <span class="text-danger">*</span></label>
                        <textarea class="form-control border-0 bg-light py-2" id="refundReason" rows="3" placeholder="Veuillez indiquer la raison du remboursement..."></textarea>
                    </div>
                    
                    <div class="alert alert-warning d-flex align-items-center mt-4" role="alert">
                        <i class="ri-alert-line me-2"></i>
                        <div>
                            <span>Le remboursement ne sera traité qu'après validation par un responsable.</span>
                        </div>
                    </div>
                    
                    <div class="hstack gap-2 justify-content-center mt-3">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-warning" id="confirmRefundBtn">Demander le remboursement</button>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal Détails du Client -->
<div class="modal fade" id="clientDetailsModal" tabindex="-1" aria-labelledby="clientDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-4 overflow-hidden shadow-lg">
            <div class="modal-header bg-gradient-primary text-white px-4 py-3" style="background: linear-gradient(135deg, #3b7ddd 0%, #1a56b0 100%) !important;">
                <div class="d-flex align-items-center w-100">
                    <div class="modal-icon bg-white bg-opacity-20 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="min-width: 40px; min-height: 40px;">
                        <i class="ri-user-line text-white fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="modal-title fw-bold text-white mb-0" id="clientDetailsModalLabel">Détails du client</h5>
                        <p class="text-white text-opacity-75 mb-0 fs-6">Informations complètes sur le demandeur</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="container-fluid p-4">
                    <div class="row">
                        <div class="col-lg-4 mb-4 mb-lg-0">
                            <div class="text-center p-3">
                                <div class="avatar-xl mx-auto mb-4 position-relative">
                                    <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; font-size: 2.5rem;">
                                        <i class="ri-user-line"></i>
                                    </div>
                                    <div class="position-absolute top-0 end-0 transform-middle">
                                        <span class="badge bg-success rounded-circle p-2">
                                            <i class="ri-check-line fs-6"></i>
                                        </span>
                                    </div>
                                </div>
                                <h6 class="mb-1 fs-4" id="clientFullName"></h6>
                                
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-light py-3 px-4 border-0 rounded-top-3">
                                    <h6 class="mb-0 text-primary fw-semibold d-flex align-items-center">
                                        <i class="ri-user-3-line me-2"></i>
                                        Informations personnelles
                                    </h6>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 p-2 bg-primary bg-opacity-10 rounded-circle me-3">
                                                    <i class="ri-mail-line text-primary fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <p class="mb-1 text-muted small">Email</p>
                                                    <p class="mb-0 fw-medium" id="clientEmail">-</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 p-2 bg-primary bg-opacity-10 rounded-circle me-3">
                                                    <i class="ri-phone-line text-primary fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <p class="mb-1 text-muted small">Téléphone</p>
                                                    <p class="mb-0 fw-medium" id="clientPhone">-</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 p-2 bg-primary bg-opacity-10 rounded-circle me-3">
                                                    <i class="ri-map-pin-line text-primary fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <p class="mb-1 text-muted small">Adresse</p>
                                                    <p class="mb-0 fw-medium" id="clientAddress">-</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 p-2 bg-primary bg-opacity-10 rounded-circle me-3">
                                                    <i class="ri-calendar-line text-primary fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <p class="mb-1 text-muted small">Date de naissance</p>
                                                    <p class="mb-0 fw-medium" id="clientBirthDate">-</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 p-2 bg-primary bg-opacity-10 rounded-circle me-3">
                                                    <i class="ri-map-pin-user-line text-primary fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <p class="mb-1 text-muted small">Lieu de naissance</p>
                                                    <p class="mb-0 fw-medium" id="clientBirthPlace">-</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 p-2 bg-success bg-opacity-10 rounded-circle me-3">
                                                    <i class="ri-calendar-check-line text-success fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <p class="mb-1 text-muted small">Date d'inscription</p>
                                                    <p class="mb-0 fw-medium" id="clientRegistrationDate">-</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light px-4 py-3 border-top">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i> Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de la Réduction -->
<div class="modal fade" id="reductionDetailsModal" tabindex="-1" aria-labelledby="reductionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-coupon-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="reductionDetailsModalLabel">Détails de la réduction</h5>
                        <p class="text-muted small mb-0">Informations sur la réduction applicable</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="card border border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h6 class="mb-0 text-warning">Réduction disponible</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted">Type de réduction</td>
                                        <td id="reductionType">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Montant de la réduction</td>
                                        <td id="reductionAmount">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Prix initial</td>
                                        <td id="initialPrice">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Prix après réduction</td>
                                        <td id="finalPrice">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <span>En appliquant cette réduction, le prix de la formation sera mis à jour automatiquement.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="applyReductionBtn">
                    <i class="ri-check-line me-2"></i>Appliquer la réduction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails Échéancier Spécial -->
<div class="modal fade" id="echeancierSpecialDetailsModal" tabindex="-1" aria-labelledby="echeancierSpecialDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-2 p-2 me-2">
                        <i class="ri-star-line text-primary fs-5"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-0" id="echeancierSpecialDetailsModalLabel">Détails de l'échéancier spécial</h5>
                        <p class="text-muted small mb-0 fs-6">Informations sur l'échéancier personnalisé</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10 py-1 px-2">
                                <h6 class="mb-0 text-success fs-6">Détail des tranches</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0 small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tranche</th>
                                                <th>Pourcentage</th>
                                                <th>Montant</th>
                                                <th>Date d'échéance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="echeancierSpecialLinesTable">
                                            <!-- Les lignes seront chargées dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3 py-2 px-2" role="alert">
                    <i class="ri-information-line me-1"></i>
                    <span class="small">Cet échéancier spécial a été créé pour répondre aux besoins spécifiques du client. Vous pouvez l'appliquer à cette demande de paiement.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-3 py-2">
                <button type="button" class="btn btn-sm btn-light px-3 py-1" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
                <button type="button" class="btn btn-sm btn-success px-3 py-1" id="applyEcheancierSpecialBtn">
                    <i class="ri-check-line me-1"></i>Appliquer
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal Confirmation Application Échéancier Spécial -->
<div class="modal fade" id="confirmApplyEcheancierSpecialModal" tabindex="-1" aria-labelledby="confirmApplyEcheancierSpecialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmApplyEcheancierSpecialModalLabel">Confirmation d'application</h5>
                        <p class="text-muted small mb-0">Échéancier spécial</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                            <i class="ri-star-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Appliquer l'échéancier spécial</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir appliquer cet échéancier spécial à la demande de paiement ?</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        En confirmant, cet échéancier spécial remplacera l'échéancier standard actuel.
                    </div>
                </div>
               
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmApplyEcheancierSpecialBtn">
                    <i class="ri-check-line me-2"></i>Appliquer l'échéancier
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails du remboursement traité -->
<div class="modal fade" id="remboursementTraiteDetailsModal" tabindex="-1" aria-labelledby="remboursementTraiteDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-2 p-2 me-2">
                        <i class="ri-check-line text-success fs-5"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-0" id="remboursementTraiteDetailsModalLabel">Détails du remboursement traité</h5>
                        <p class="text-muted small mb-0 fs-6">Informations sur le remboursement validé</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10 py-1 px-2">
                                <h6 class="mb-0 text-success fs-6">Détails du remboursement</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="mb-3">
                                    <label class="form-label fw-medium">Montant autorisé (DA)</label>
                                    <input type="number" class="form-control border-0 bg-light py-2" id="autoriserMontant" value="0.00" placeholder="Saisir le montant autorisé" disabled>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0 smaller">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Mode de rembourssement</td>
                                                <td>
                                                    <span id="mode_de_rembourssement" class="badge bg-primary bg-opacity-10 text-primary">-</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Statut</td>
                                                <td>
                                                    <span id="texte_statut_refund" class="badge bg-primary bg-opacity-10 text-primary">-</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Date de validation</td>
                                                <td id="remboursementTraiteDateValidation">-</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Motif</td>
                                                <td id="remboursementTraiteMotif">-</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Observations</td>
                                                <td id="remboursementTraiteObservations">-</td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-2 py-2 px-2" role="alert">
                    <i class="ri-information-line me-1"></i>
                    <span class="small">Le montant autorisé a été validé et est non modifiable.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-2 py-1">
                <button type="button" class="btn btn-sm btn-light px-2 py-1" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
                <button type="button" class="btn btn-sm btn-success px-2 py-1" data-bs-toggle="modal" data-bs-target="#confirmationRemboursementModal">
                    <i class="ri-refund-line me-1"></i>Effectuer le remboursement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Remboursement -->
<div class="modal fade" id="confirmationRemboursementModal" tabindex="-1" aria-labelledby="confirmationRemboursementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmationRemboursementModalLabel">Confirmation de remboursement</h5>
                        <p class="text-muted small mb-0">Valider le remboursement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                            <i class="ri-refund-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Effectuer le remboursement</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir effectuer ce remboursement ?</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        Cette action effectuera le remboursement au client. Cette opération est irréversible.
                    </div>
                </div>
                
                <div class="card border border-info mb-3">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Montant:</span>
                            <span class="fw-bold text-success" id="confirmMontantRemboursement">0.00 DA</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmerRemboursementBtn">
                    <i class="ri-check-line me-2"></i>Confirmer le remboursement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Consultation Échéancier -->
<div class="modal fade" id="consultationEcheancierModal" tabindex="-1" aria-labelledby="consultationEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="consultationEcheancierModalLabel">Consultation de l'échéancier</h5>
                        <p class="text-muted small mb-0">Détails de l'échéancier appliqué</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div style="display: none !important;" id="alertEcheancierSpecial" class="alert alert-info d-flex align-items-center mb-4" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <div>
                        <strong>Échéancier spécial appliqué</strong>
                        <p class="mb-0">Un échéancier spécial a été appliqué à cette demande de paiement. Il remplace l'échéancier standard.</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Détail de l'échéancier</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Échéance</th>
                                                <th>Date d'échéance</th>
                                                <th>Montant (DA)</th>
                                                <th>Prix final(Reduction)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="echeancierDetailsTable">
                                            <!-- Les détails de l'échéancier seront chargés dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aide Échéancier -->
<div class="modal fade" id="aideEcheancierModal" tabindex="-1" aria-labelledby="aideEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-question-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="aideEcheancierModalLabel">Aide - Échéancier de paiement</h5>
                        <p class="text-muted small mb-0">Explication des fonctionnalités</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Fonctionnalités des boutons</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                            <i class="ri-check-line text-success"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-success">Bouton "Confirmer"</h6>
                                        <p class="mb-0">Valide l'échéancier standard actuel et le marque comme confirmé dans le système.</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-warning bg-opacity-10 rounded icon-center">
                                            <i class="ri-star-line text-warning"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-warning">Bouton "Spécial"</h6>
                                        <p class="mb-0">Permet de créer un échéancier personnalisé avec des tranches modifiables selon les besoins spécifiques.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <span>Un échéancier doit être confirmé avant de pouvoir enregistrer des paiements.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-info px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aide - Traitement des paiements des étudiants -->
<div class="modal fade" id="aideTraitementPaiementModal" tabindex="-1" aria-labelledby="aideTraitementPaiementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-question-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="aideTraitementPaiementModalLabel">Aide - Traitement des paiements des étudiants</h5>
                        <p class="text-muted small mb-0">Fonctionnalités des boutons</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Fonctionnalités des boutons</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                            <i class="ri-add-line text-success"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-success">Bouton "Nouveau paiement"</h6>
                                        <p class="mb-0">Permet d'enregistrer un nouveau paiement pour l'étudiant. Vous pouvez spécifier le montant, la date, le mode de paiement et la référence.</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex mb-3">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-warning bg-opacity-10 rounded icon-center">
                                            <i class="ri-refund-line text-warning"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-warning">Bouton "Remboursement"</h6>
                                        <p class="mb-0">Permet de soumettre une demande de remboursement. Cette demande devra être validée par un responsable avant traitement.</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                            <i class="ri-printer-line text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-primary">Bouton "Imprimer Engagement"</h6>
                                        <p class="mb-0">Génère et imprime l'engagement de paiement pour l'étudiant avec les détails de sa formation et de son échéancier.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>Si une demande de remboursement est créée, toutes les interactions avec les boutons seront désactivées jusqu'à ce que la demande soit traitée.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-info px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Paiement -->
<div class="modal fade" id="nouveauPaiementModal" tabindex="-1" aria-labelledby="nouveauPaiementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary px-4 py-3" style="background: linear-gradient(135deg, #3b7ddd 0%, #1a56b0 100%) !important;">
                <div class="d-flex align-items-center">
                    <div class="modal-icon rounded-3 p-3 me-3" style="background-color: rgba(255, 255, 255, 0.2) !important;">
                        <i class="ri-money-dollar-circle-line text-white fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-white mb-1" id="nouveauPaiementModalLabel">Enregistrement de paiement</h5>
                        <p class="text-white text-opacity-75 small mb-0">Saisissez les détails du nouveau paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="card border" style="border-color: rgba(59, 125, 221, 0.2) !important; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;">
                            <div class="card-header py-2" style="background-color: rgba(59, 125, 221, 0.1) !important;">
                                <h6 class="mb-0 fw-semibold" style="color: #3b7ddd !important;">Détails du paiement</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-medium" for="echeancierSelection">Échéance à payer <span class="text-danger">*</span></label>
                                    <select class="form-select border-0 py-2" id="echeancierSelection" required style="background-color: #f8f9fa !important;">
                                        <option value="">Sélectionnez une échéance</option>
                                        <!-- Les options seront remplies dynamiquement -->
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="datePaiement">Date de paiement <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control border-0 py-2" id="datePaiement" required style="background-color: #e9ecef !important; cursor: not-allowed;" readonly />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="montantPaiement">Montant <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="number" class="form-control border-0 py-2" id="montantPaiement" step="0.01" min="0" required style="background-color: #f8f9fa !important;" />
                                            <span class="input-group-text border-0" style="background-color: rgba(59, 125, 221, 0.1) !important;">DA</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="modePaiement">Mode de paiement <span class="text-danger">*</span></label>
                                        <select class="form-select border-0 py-2" id="modePaiement" required style="background-color: #f8f9fa !important;">
                                            <option value="">Sélectionnez un mode</option>
                                            <option value="esp">Espèce</option>
                                            <option value="che">Chèque</option>
                                            <option value="vir">Virement</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="referencePaiement">Référence de paiement</label>
                                        <input type="text" class="form-control border-0 py-2" id="referencePaiement" placeholder="N° chèque, virement, etc." style="background-color: #f8f9fa !important;" />
                                    </div>
                                </div>
                                
                                <div class="mb-0">
                                    <label class="form-label fw-medium" for="observationPaiement">Observations</label>
                                    <textarea class="form-control border-0 py-2" id="observationPaiement" rows="2" placeholder="Informations supplémentaires..." style="background-color: #f8f9fa !important;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-5">
                        <div class="card border h-100" style="border-color: rgba(40, 167, 69, 0.2) !important; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;">
                            <div class="card-header py-2" style="background-color: rgba(40, 167, 69, 0.1) !important;">
                                <h6 class="mb-0 fw-semibold" style="color: #28a745 !important;">Résumé de la transaction</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Échéance sélectionnée:</span>
                                    <span class="fw-medium" id="resumeEcheance">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Date de paiement:</span>
                                    <span class="fw-medium" id="resumeDate">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Montant:</span>
                                    <span class="fw-bold fs-5" style="color: #3b7ddd !important;" id="resumeMontant">0.00 DA</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Mode de paiement:</span>
                                    <span class="fw-medium" id="resumeMode">-</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Référence:</span>
                                    <span class="fw-medium" id="resumeReference">-</span>
                                </div>
                                
                                <div class="alert" role="alert" style="background-color: rgba(23, 162, 184, 0.1) !important; border-color: rgba(23, 162, 184, 0.2) !important;">
                                    <i class="ri-information-line me-2" style="color: #17a2b8 !important;"></i>
                                    <span class="small" style="color: #17a2b8 !important;">Vérifiez attentivement les informations avant d'enregistrer le paiement.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2 rounded-pill" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary px-4 py-2 rounded-pill" id="enregistrerPaiementBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aide Traitement des Paiements -->
<div class="modal fade" id="aideTraitementPaiementModal" tabindex="-1" aria-labelledby="aideTraitementPaiementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-question-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="aideTraitementPaiementModalLabel">Aide - Traitement des paiements des étudiants</h5>
                        <p class="text-muted small mb-0">Procédure complète de gestion des paiements</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Procédure de traitement des paiements</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-4">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="ri-percent-line text-success fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-success">1. Application de la réduction</h6>
                                        <p class="mb-0">Si le demandeur bénéficie d'une réduction, cliquez sur le bouton "Consulter" dans la notification de réduction et utilisez le bouton "Appliquer la réduction" pour valider la réduction sur la formation.</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex mb-4">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="ri-calendar-check-line text-warning fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-warning">2. Confirmation de l'échéancier</h6>
                                        <p class="mb-0">Confirmez l'échéancier de paiement en cliquant sur le bouton "Confirmer". Si un échéancier spécial est disponible, vous devrez peut-être attendre sa validation. Vous pouvez créer un échéancier personnalisé à l'aide du bouton "Spécial".</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex mb-4">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="ri-clock-line text-primary fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-primary">3. Attente de confirmation de l'échéancier spécial</h6>
                                        <p class="mb-0">Dans le cas d'un échéancier spécial, ce dernier est soumis à validation par un responsable. Vous devrez attendre sa validation avant de pouvoir enregistrer des paiements. La notification "Échéancier en cours d'examen" vous informera de l'état de votre demande.</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex mb-4">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="ri-money-box-line text-info fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-info">4. Enregistrement des paiements</h6>
                                        <p class="mb-0">Enregistrez les paiements reçus en utilisant le bouton "Nouveau paiement". Sélectionnez la tranche concernée et entrez les détails du paiement (date, montant, mode de paiement, etc.).</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="ri-user-check-line text-warning fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-warning">5. Confirmation de l'inscription</h6>
                                        <p class="mb-0">Une fois au moins un paiement enregistré, vous pouvez confirmer l'inscription de l'étudiant. Cliquez sur "Confirmer l'inscription" pour officialiser l'inscription et diriger l'étudiant vers la scolarité.</p>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mt-4" role="alert">
                                    <i class="ri-information-line me-2"></i>
                                    <span>Rappelez-vous que vous devez avoir enregistré au moins un paiement avant de pouvoir confirmer l'inscription d'un étudiant.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-info px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation d'Inscription -->
<div class="modal fade" id="confirmInscriptionModal" tabindex="-1" aria-labelledby="confirmInscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-checkbox-circle-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="confirmInscriptionModalLabel">Confirmation d'inscription</h5>
                        <p class="text-muted small mb-0">Veuillez confirmer l'inscription de l'étudiant</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-primary">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0 text-primary">Informations de l'étudiant</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Nom de l'étudiant:</span>
                                    <span class="fw-medium" id="confirmStudentName"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Formation:</span>
                                    <span class="fw-medium" id="confirmFormation"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="confirmPromo"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Confirmation d'inscription</h6>
                            </div>
                            <div class="card-body">
                                <p>En confirmant cette inscription, le préinscrit <strong id="confirmStudentName2"></strong> sera officiellement inscrit à la formation et sera dirigé vers la scolarité.</p>
                                
                                <div class="alert alert-info d-flex align-items-center mt-3" role="alert">
                                    <i class="ri-information-line me-2"></i>
                                    <div>
                                        <strong>Note:</strong> Pour confirmer l'inscription, il est nécessaire qu'au moins un paiement ait été enregistré pour cet étudiant.
                                    </div>
                                </div>
                                
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="confirmInscriptionCheck">
                                    <label class="form-check-label" for="confirmInscriptionCheck">
                                        Je confirme l'inscription de cet étudiant
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En confirmant cette inscription, l'étudiant sera officiellement inscrit et sera dirigé vers la scolarité. Cette action est irréversible.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary px-4 py-2" id="confirmInscriptionBtn" disabled>
                    <i class="ri-check-line me-2"></i>Confirmer l'inscription
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Engagement -->
<div class="modal fade" id="engagementModal" tabindex="-1" aria-labelledby="engagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="engagementModalLabel">Engagement de l'étudiant</h5>
                        <p class="text-muted small mb-0">Confirmation de prise de connaissance des échéances de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Informations de l'étudiant</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Nom de l'étudiant:</span>
                                    <span class="fw-medium" id="engagementStudentName"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Formation:</span>
                                    <span class="fw-medium" id="engagementFormation"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="engagementPromo"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Échéances de paiement</h6>
                            </div>
                            <div class="card-body">
                                <p>Je soussigné(e), <strong id="engagementStudentName2"></strong>, déclare avoir pris connaissance des échéances de paiement ci-dessous et m'engage à les respecter:</p>
                                
                                <ul class="list-group list-group-flush" id="engagementPaymentsList">
                                    <!-- Les paiements seront chargés ici dynamiquement -->
                                </ul>
                                
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="engagementConfirmationCheck">
                                    <label class="form-check-label" for="engagementConfirmationCheck">
                                        Je confirme avoir lu et compris les conditions de paiement
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En cochant la case de confirmation, vous acceptez les termes et conditions associés aux échéances de paiement. Cette action est irréversible.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmEngagementBtn" disabled>
                    <i class="ri-check-line me-2"></i>Confirmer l'engagement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Synthèse et Confirmation Paiement -->
<div class="modal fade" id="synthesePaiementModal" tabindex="-1" aria-labelledby="synthesePaiementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-text-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="synthesePaiementModalLabel">Synthèse du paiement</h5>
                        <p class="text-muted small mb-0">Vérification des informations avant enregistrement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-primary">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0 text-primary">Détails du paiement</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Échéance sélectionnée:</td>
                                                <td class="fw-medium" id="syntheseEcheance"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Date de paiement:</td>
                                                <td class="fw-medium" id="syntheseDate"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Montant:</td>
                                                <td class="fw-bold text-primary" id="syntheseMontant"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Mode de paiement:</td>
                                                <td class="fw-medium" id="syntheseMode"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Référence:</td>
                                                <td class="fw-medium" id="syntheseReference"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Observations</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0" id="syntheseObservations">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En confirmant ces informations, le paiement sera définitivement enregistré dans le système.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary px-4 py-2" id="confirmerPaiementBtn">
                    <i class="ri-check-double-line me-2"></i>Confirmer le paiement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation d'inscription finalisée -->
<div class="modal fade" id="inscriptionFinaliseeModal" tabindex="-1" aria-labelledby="inscriptionFinaliseeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-body text-center p-5">
                <div class="avatar-lg mx-auto mb-4">
                    <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                        <i class="ri-checkbox-circle-line"></i>
                    </div>
                </div>
                <h4 class="mb-3 text-success">Inscription finalisée !</h4>
                <p class="text-muted mb-4">L'inscription de l'étudiant a été confirmée avec succès.</p>
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <div class="flex-grow-1">
                        Vous allez être redirigé vers la page de gestion de la scolarité dans quelques instants.
                    </div>
                </div>
                <div class="mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails Remboursement -->
<div class="modal fade" id="remboursementDetailsModal" tabindex="-1" aria-labelledby="remboursementDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-refund-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="remboursementDetailsModalLabel">Détails du remboursement</h5>
                        <p class="text-muted small mb-0">Informations sur la demande de remboursement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="card border border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h6 class="mb-0 text-warning">Demande de remboursement</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted">Date de la demande</td>
                                        <td id="remboursementDate">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Montant demandé</td>
                                        <td id="remboursementMontant">-</td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="text-muted">Statut de la demande</td>
                                        <td>
                                            <span class="badge bg-warning badge-payment-status">En attente de traitement</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Motif du remboursement</td>
                                        <td id="remboursementMotif">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <span>Cette demande de remboursement est en cours de traitement. Vous serez informé(e) dès que la demande aura été traitée.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails du remboursement avec signalement danger -->
<div class="modal fade" id="remboursementDetailsDangerModal" tabindex="-1" aria-labelledby="remboursementDetailsDangerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-alert-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="remboursementDetailsDangerModalLabel">Détails du remboursement</h5>
                        <p class="text-muted small mb-0">Informations du remboursement avec danger</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                    <i class="ri-error-warning-line me-2 fs-4"></i>
                    <div>
                        <strong>Alerte Remboursement</strong>
                        <p class="mb-0">Ce remboursement nécessite une attention particulière</p>
                    </div>
                </div>
                
                <div class="card border border-danger">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h6 class="mb-0 text-danger">Informations sur le remboursement</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Statut</label>
                            <p class="form-control border-0 bg-light py-2 mb-0" id="remboursementStatut">-</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-medium">Date de validation</label>
                            <p class="form-control border-0 bg-light py-2 mb-0" id="remboursementDateValidation">-</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-medium">Motif</label>
                            <p class="form-control border-0 bg-light py-2 mb-0" id="remboursementMotifDanger">-</p>
                        </div>
                        
                        <div>
                            <label class="form-label fw-medium">Observations</label>
                            <p class="form-control border-0 bg-light py-2 mb-0" id="remboursementObservations">-</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour notifier que le paiement précédent n'est pas passé -->
<div class="modal fade" id="unpaidPaymentModal" tabindex="-1" aria-labelledby="unpaidPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-alert-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="unpaidPaymentModalLabel">Paiement en attente</h5>
                        <p class="text-muted small mb-0">Un paiement précédent n'est pas encore traité</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-warning bg-opacity-10 text-warning display-5 rounded-circle">
                            <i class="ri-money-euro-circle-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Attention: Paiement en attente</h5>
                    <p class="text-muted">Le paiement précédent pour cette échéance n'est pas encore enregistré comme effectué.</p>
                </div>
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <div>
                        Veuillez vous assurer que le paiement précédent a été correctement enregistré avant de continuer.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-check-line me-2"></i>Compris
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Assistant Engagement -->
<div class="modal fade" id="engagementAssistantModal" tabindex="-1" aria-labelledby="engagementAssistantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-info-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="engagementAssistantModalLabel">Assistant d'impression d'engagement</h5>
                        <p class="text-muted small mb-0">Sélectionnez les informations pour l'impression de l'engagement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Signataire *</label>
                        <select class="form-select" id="signataireSelect" required>
                            <option value="">Sélectionnez le signataire</option>
                            <option value="Apprenant">Apprenant</option>
                            <option value="Parents">Parents</option>
                            <option value="Tuteur">Tuteur</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Pièce d'identité *</label>
                        <select class="form-select" id="pieceIdentiteSelect" required>
                            <option value="">Sélectionnez la pièce</option>
                            <option value="CNI">CNI</option>
                            <option value="Passeport">Passeport</option>
                            <option value="Permis de conduire">Permis de conduire</option>
                        </select>
                    </div>
                </div>
                
                <!-- Champs nom et prénom pour Parents/Tuteur -->
                <div id="parentTuteurFields" class="row d-none">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Nom du parent/tuteur *</label>
                        <input type="text" class="form-control" id="nomParentTuteurInput" placeholder="Nom du parent ou tuteur" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Prénom du parent/tuteur *</label>
                        <input type="text" class="form-control" id="prenomParentTuteurInput" placeholder="Prénom du parent ou tuteur" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Adresse du parent/tuteur *</label>
                        <input type="text" class="form-control" id="adresseParentTuteurInput" placeholder="Adresse du parent ou tuteur" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Contact téléphonique du parent/tuteur *</label>
                        <input type="tel" class="form-control" id="contactParentTuteurInput" placeholder="Contact téléphonique du parent ou tuteur" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">N° *</label>
                        <input type="text" class="form-control" id="numeroPieceInput" placeholder="Numéro de la pièce" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Date de délivrance *</label>
                        <input type="date" class="form-control" id="dateDelivranceInput" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Lieu de délivrance *</label>
                        <input type="text" class="form-control" id="lieuDelivranceInput" placeholder="Lieu de délivrance" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="printEngagementWithDetails">
                    <i class="ri-printer-line me-2"></i>Imprimer l'engagement
                </button>
            </div>
        </div>
    </div>
</div>

<input disabled type="hidden" id="_logoHeader" />
<input disabled type="hidden" id="_logoFooter" />

<input disabled type="hidden" id="_date_naissance" />
<input disabled type="hidden" id="_lieu_naissance" />

<input disabled type="hidden" id="_groupe_name" />
<input disabled type="hidden" id="_semestre" />

<script>
    
    
    $(document).ready(function(){
        
        var id_client = "{{pk}}";

        var prixFormation = 0.00;
        var prixFormationReduction = 0.00;
        let hasReduction =  false;
        let reductionApprouved = false;
        var clientId = null;
        let promoCode = null;
        let has_pending_refund = false;
        let has_special_echeancier = false;
        let specialEcheancierState = false;
        let IdSpecialEcheancier = null; 
        let RefundState = false;
        let designation = null;
        
        let applied_echeacier = [];
       
        function HideReducNotif(){
           
            let notif = document.getElementById("reductionNotification");
            let appliedRedu = document.getElementById('reductionSuccessNotification');
            
            if (reductionApprouved){
                appliedRedu.style.setProperty("display", "flex", "important");

            }else if (hasReduction && !reductionApprouved) {
                 notif.style.setProperty("display", "flex", "important");  
            }else {
                notif.style.setProperty("display", "none", "important");
            }

           
        }

        function HideSpecialEcheancierNotif(){
            let special_notif = document.getElementById('echeancierSpecialNotification');
            let exam_special_notif = document.getElementById('echeancierExamenNotification');
            

             if (has_special_echeancier && specialEcheancierState === false ){
                    special_notif.style.setProperty("display", "none", "important"); 
                    exam_special_notif.style.setProperty("display", "flex", "important");
                   
                    
                } else {
                    special_notif.style.setProperty("display", "none", "important");
                    exam_special_notif.style.setProperty("display", "none", "important");
                    
                    

                }   
        }
    
        // Add a global variable to store payment data
        var paymentData = {};
                
        

        function formatComptable(number) {
            if (number == null || number === '') return "0,00";

            return parseFloat(number)
                .toFixed(2)                       // deux décimales
                .replace('.', ',')                // virgule pour décimales
                .replace(/\B(?=(\d{3})+(?!\d))/g, "."); // points pour milliers
        }

        function SummeryPaiement(totalPaye, total_initial, total_solde) {
            $('#totalPaidAmount').text(formatComptable(totalPaye) + ' DA');
            $('#totalDueAmount').text(formatComptable(total_initial) + ' DA');
            $('#balanceAmount').text(formatComptable(total_solde) + ' DA');
        }

        
        function loadDatas(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiGetClientEcheancierDouble' %}",
                dataType: 'JSON',
                type : 'GET',
                data : {'id' : id_client},
                success : function(data){
                    // Informations du demandeur
                    $('#demandeur').text(data.user_data.demandeur_nom+" "+data.user_data.demandeur_prenom);
                    $('#created_at').text(data.user_data.created_at.split('T')[0]);
                    $('#statutClient').text(data.user_data.statut_demandeur);

                    const createdAt = new Date(data.user_data.created_at);
                    const date_frais_inscription = createdAt.toISOString().split('T')[0];

                    
                    
                    // Store client ID
                    clientId = data.user_data.client_id;
                    promoCode = data.voeux.promo;
                    $('#clientIdInput').val(clientId);

                    $('#_groupe_name').val(data.groupe.nom);
                    $('#_semestre').val(data.groupe.semestre);

                    
                    // Informations du client pour la modale
                    $('#clientFullName').text(data.user_data.demandeur_nom+" "+data.user_data.demandeur_prenom);
                    $('#clientEmail').text(data.user_data.email || 'Non spécifié');
                    $('#clientPhone').text(data.user_data.telephone || 'Non spécifié');
                    $('#clientAddress').text(data.user_data.adresse || 'Non spécifié');
                    $('#clientBirthDate').text(data.user_data.date_naissance || 'Non spécifié');
                    $('#clientBirthPlace').text(data.user_data.lieu_naissance || 'Non spécifié');

                    $('#_logoHeader').val(data.voeux.logo_header);
                    $('#_logoFooter').val(data.voeux.logo_footer);

                    $('#_date_naissance').val(data.user_data.demandeur_date_naissance);
                    $('#_lieu_naissance').val(data.user_data.demandeur_lieu_naissance);
                    
                    // Informations sur la formation
                    $('#specialite').text(data.voeux.specialite_label);
                    $('#promo').text(data.voeux.promo);
                    $('#prix_formation').text(formatComptable(data.voeux.prix_formation) + " DA");
                    
                    // Stocker le prix de la formation pour le modal spécial
                    prixFormation = data.voeux.prix_formation;
                                                          
                    var echeancierHtml = "";

                    if(data.remise){
                       
                        $('#applyReductionBtn').data('id', data.remise.id_applied_reduction);
                       
                        hasReduction = true;
                        

                        prixFormationReduction = parseFloat(prixFormation-(prixFormation*(data.remise.valeur/100)));

                        $('#reductionType').text(data.remise.type_remise);
                        $('#reductionAmount').text(data.remise.valeur+" %");
                        $('#initialPrice').text(prixFormation);
                        $('#finalPrice').text(parseFloat(prixFormationReduction));
                        
                        if (data.remise.remise_approuver){
                            reductionApprouved = true;
                            
                            $('#prixFinalHeader').show();
                            $('[id^=prixFinal]').show();
                        }else{
                            reductionApprouved = false;
                        }          
                        
                        HideReducNotif();

                       
                    }


                    if(data.has_due_paiement){
                        // Afficher les paiements dus
                        var duePaiementHtml = "";
                        var duePaiementCount = 0;
                        
                        $.each(data.due_paiement_data, function(index, item){
                            duePaiementCount++;
                            duePaiementHtml += '<tr>';
                            duePaiementHtml += '<td hidden>' + item.id_due_paiement + '</td>';
                            duePaiementHtml += '<td>' + item.label + '</td>';
                            duePaiementHtml += '<td>' + item.date_echeance + '</td>';
                            duePaiementHtml += '<td><span class="amount-cell amount-due-cell">' + item.montant_due + ' DA</span></td>';
                            duePaiementHtml += '<td><span class="amount-cell amount-balance-cell">' + item.montant_restant + ' DA</span></td>';
                            duePaiementHtml += '</td>';
                            duePaiementHtml += '</tr>';
                        });
                        
                        $('#ListePaiementRequestLine').html(duePaiementHtml);
                        $('#NbrPaiementDue').text(duePaiementCount);
                        document.getElementById('btnNewPaiementModal').disabled = false;

                    } else {
                        // Masquer le bouton d'engagement s'il n'y a pas de paiements dus
                       
                        $('#ListePaiementRequestLine').html('<tr><td colspan="6" class="text-center">Aucun paiement dû</td></tr>');
                        $('#NbrPaiementDue').text('0');

                        document.getElementById('btnNewPaiementModal').disabled = true;
                    }
                    
                    
                    if(data.has_paiement){
                        var row = "";
                        var count = data.paiements_done_data.length;
                        
                        // Store payment data for later use
                        paymentData = {};
                        $.each(data.paiements_done_data, function(index, item){
                            // Store payment data with payment number as key
                            paymentData[item.num] = {
                                num: item.num,
                                montant_paye: item.montant_paye,
                                date_paiement: item.date_paiement,
                                mode_paiement: item.mode_paiement || 'Non spécifié',
                                reference_paiement: item.reference_paiement || 'Non spécifié',
                                label_paiements : item.label_paiements,                               
                            };
                            
                            row += "<tr>";
                            row += "<td>"+item.num+"</td>";

                            row += "<td>" + 
                                        (item.is_refund 
                                            ? "<span class='badge bg-danger'>" + item.label_paiements + "</span>" 
                                            : item.label_paiements
                                        ) + 
                                    "</td>";

                            row += "<td>" + 
                                        (item.is_refund 
                                            ? "<span class='badge bg-danger'>" + formatComptable(item.montant_paye) + "</span>" 
                                            : formatComptable(item.montant_paye)
                                        ) + 
                                    "</td>";
                            row += "<td>"+item.date_paiement+"</td>";
                            
                            // Afficher le mode de paiement avec un badge
                            var modePaiementBadge = "";
                            if(item.is_refund){
                                 modePaiementBadge = '<span class="badge bg-danger text-danger">'+item.mode_paiement+'</span>';
                            }else{
                                switch(item.mode_paiement) {
                                    case 'esp':
                                        modePaiementBadge = '<span class="badge-payment-status badge-payment-paid">Espèce</span>';
                                        break;
                                    case 'che':
                                        modePaiementBadge = '<span class="badge-payment-status badge-payment-due">Chèque</span>';
                                        break;
                                    case 'vir':
                                        modePaiementBadge = '<span class="badge-payment-status badge-payment-partial">Virement</span>';
                                        break;
                                    default:
                                        modePaiementBadge = '<span class="badge-payment-status badge-payment-paid">'+(item.mode_paiement || 'Non spécifié')+'</span>';
                                }
                            }
                            row += "<td>"+modePaiementBadge+"</td>";
                            
                            row += "<td class='action-cell position-relative'>";
                            row += "<div class='dropdown'>";
                            row += "<button class='btn btn-sm btn-outline-primary dropdown-toggle' type='button' id='dropdownMenuButton"+item.num+"' data-bs-toggle='dropdown' aria-expanded='false'>";
                            row += "<i class='ri-more-2-fill'></i>";
                            row += "</button>";
                            row += "<div class='dropdown-menu dropdown-menu-end' aria-labelledby='dropdownMenuButton"+item.num+"'>";
                            row += "<button class='dropdown-item print-quittance-btn' type='button' data-id='"+item.num+"'><i class='ri-file-text-line me-2'></i>Quittance</button>";
                            row += "<button class='dropdown-item print-facture-btn' type='button' data-id='"+item.num+"'><i class='ri-printer-line me-2'></i>Facture</button>";
                            //row += "<div class='dropdown-divider'></div>";
                            //row += "<button class='dropdown-item delete-btn' type='button' data-id='"+item.num+"'><i class='ri-delete-bin-line me-2'></i>Supprimer</button>";
                            row += "</div>";
                            row += "</div>";
                            row += "</td>";
                            row += "</tr>";
                        });
                        $('#NbrPaiementDone').text(count);
                        $('#ListePaiementRequestLineDone').html(row);
                        
                        document.getElementById('btnRefundRequestModal').disabled = false;
                    }else{
                        $('#ListePaiementRequestLineDone').html('<tr><td colspan="6" class="text-center">Aucun paiement effectué</td></tr>');
                        $('#NbrPaiementDone').text('0');
                      
                        document.getElementById('btnRefundRequestModal').disabled = true;

                    }
                    SummeryPaiement(data.total_paiement,data.total_initial,data.total_solde);
                
                    ShowRefundNotification(data.has_pending_refund, data.has_processed_refund, data.is_appliced);

                    if (data.has_pending_refund){
                        //DetailsRefund(data.refund_data.date_de_demande, data.refund_data.montant_paye, data.refund_data.allowed_amount, data.refund_data.motif_rembourssement);
                    }
                    
                    if (data.has_processed_refund && data.refund_data) {
                        DetailsRefundTraite(
                            data.refund_data.date_de_traitement, 
                            data.refund_data.montant_rembarque, 
                            data.refund_data.motif_rembourssement,
                            data.refund_data.observation || '',
                            data.refund_data.allowed_amount,
                            data.refund_data.etat,
                            data.refund_data.mode_rembourssement_label,
                        );

                         $('#confirmationRemboursementModal').data('amount', data.refund_data.allowed_amount);
                         $('#confirmationRemboursementModal').data('mode_paiement', data.refund_data.mode_rembourssement);
                         $('#confirmationRemboursementModal').data('id_refund', data.refund_data.id);
                         $('#confirmMontantRemboursement').text(data.refund_data.allowed_amount+ " DA");

                        RefundState = data.refund_data.etat_key
                        if(RefundState === "ref"){
                            $('#remboursementStatut').text(data.refund_data.etat);
                            $('#remboursementDateValidation').text(data.refund_data.date_de_traitement);
                            $('#remboursementMotifDanger').text(data.refund_data.motif_rembourssement);
                            $('#remboursementObservations').text(data.refund_data.observation);
                        }

                    }

                    if(data.has_special_echeancier){
                        document.getElementById('applicedEcheancierSpecial').style.setProperty('display', "flex", "important");
                    }

                    // Affichage des echéancier
                    if (data.voeux.frais_inscription > 0) {
                        echeancierHtml += '<tr>';
                        echeancierHtml += '<td><span class="badge bg-info">Frais d\'inscription</span></td>';
                        echeancierHtml += '<td>'+date_frais_inscription+'</td>';
                        echeancierHtml += '<td><span class="fw-bold">' + parseFloat(data.voeux.frais_inscription).toFixed(2) + ' DA</span></td>';
                        
                        echeancierHtml += '</tr>';
                    }

                    // Ajouter les autres échéances
                    $.each(data.echeancier, function(index, echeance){ 
                        var label = "Tranche " + (index + 1);
                        
                        echeancierHtml += '<tr>';
                        echeancierHtml += '<td><span class="badge bg-primary">' + label + '</span></td>';
                        echeancierHtml += '<td>' + (echeance.date_echeancier ? echeance.date_echeancier : '') + '</td>';
                        echeancierHtml += '<td><span class="fw-bold">' + echeance.montant_tranche + ' DA</span></td>';
                        if(hasReduction && reductionApprouved) {
                            var montantReduction = parseFloat(echeance.montant_tranche - (echeance.montant_tranche * (data.remise.valeur/100)));
                            echeancierHtml += '<td id="prixFinalTranche' + index + '" style="display: table-cell;"><span class="fw-bold text-success">' + montantReduction.toFixed(2) + ' DA</span></td>';
                        }
                        echeancierHtml += '</tr>';
                    });

                    $('#echeancierDetailsTable').html(echeancierHtml);

                    if(data.has_special_echeancier){
                        console.log("hier");
                        document.getElementById('alertEcheancierSpecial').style.setProperty("display", "flex", "important");
                    }else{
                        document.getElementById('alertEcheancierSpecial').style.setProperty("display", "none", "important");

                    }

                    ShowClientDetails(
                        data.user_data.demandeur_email,
                        data.user_data.demandeur_telephone,
                        data.user_data.demandeur_adresse,
                        data.user_data.demandeur_date_naissance,
                        data.user_data.demandeur_lieu_naissance,
                        data.user_data.demandeur_date_inscription,
                    )

                    DetailsRembourssementAvantTraitement(data.refund_data.date_de_demande, data.refund_data.montant_paye, data.refund_data.motif_rembourssement);
                },
            });
        }

        loadDatas();
        
        function ShowRefundNotification(has_pending_refund, has_processed_refund = false, is_appliced = false){
            if(has_processed_refund && !is_appliced){
                console.log(has_processed_refund,is_appliced);
                // Show the processed refund notification
                document.getElementById('remboursementTraiteNotification').style.setProperty("display", "flex", "important");
                document.getElementById('remboursementEnAttenteNotification').style.setProperty("display", "none", "important");
                document.getElementById('btnNewPaiementModal').disabled = true;
                document.getElementById('btnRefundRequestModal').disabled = true;
                document.getElementById('btnPrintEngagement').disabled = true;
            } else if(has_pending_refund){
                console.log(has_processed_refund,is_appliced);
                // Show the pending refund notification
                document.getElementById('remboursementEnAttenteNotification').style.setProperty("display", "flex", "important");
                document.getElementById('remboursementTraiteNotification').style.setProperty("display", "none", "important");
                document.getElementById('btnNewPaiementModal').disabled = true;
                document.getElementById('btnRefundRequestModal').disabled = true;
                document.getElementById('btnPrintEngagement').disabled = true;
            }else if(has_processed_refund && is_appliced){
                console.log(has_processed_refund,is_appliced);
                // Hide both notifications
                document.getElementById('remboursementEnAttenteNotification').style.setProperty("display", "none", "important");
                document.getElementById('remboursementTraiteNotification').style.setProperty("display", "none", "important");
                document.getElementById('btnNewPaiementModal').disabled = false;
                document.getElementById('btnRefundRequestModal').disabled = false;  
                document.getElementById('btnPrintEngagement').disabled = false;
            }else{
                // Hide both notifications
                document.getElementById('remboursementEnAttenteNotification').style.setProperty("display", "none", "important");
                document.getElementById('remboursementTraiteNotification').style.setProperty("display", "none", "important");
                document.getElementById('btnNewPaiementModal').disabled = false;
                document.getElementById('btnRefundRequestModal').disabled = false;  
                document.getElementById('btnPrintEngagement').disabled = false;
            }
        }

        function ShowClientDetails(clientEmail,clientPhone,clientAddress,clientBirthDate,clientBirthPlace,clientRegistrationDate){
            $('#clientEmail').text(clientEmail);
            $('#clientPhone').text(clientPhone);
            $('#clientAddress').text(clientAddress);
            $('#clientBirthDate').text(clientBirthDate);
            $('#clientBirthPlace').text(clientBirthPlace);
            $('#clientRegistrationDate').text(clientRegistrationDate);
        }

        function DetailsRembourssementAvantTraitement(date_demande,montant_paye,motif){
            $('#remboursementDate').text(date_demande);
            $('#remboursementMontant').text(montant_paye +" DA");
            $('#remboursementMotif').text(motif);
        }
        
        function DetailsRefundTraite(remboursementDate, remboursementMontant, remboursementMotif, observations = '', montantAutoriser, etat, mode_de_rembourssement_label){
            $('#remboursementTraiteDateValidation').text(remboursementDate);
            $('#remboursementTraiteMontant').text(remboursementMontant);
            $('#remboursementTraiteMotif').text(remboursementMotif);
            $('#remboursementTraiteObservations').text(observations || 'Aucune observation');
            $('#autoriserMontant').val(montantAutoriser);
            $('#texte_statut_refund').text(etat);
            $('#mode_de_rembourssement').text(mode_de_rembourssement_label);
            
        }

        $(document).on("click", '#btnShowRefundResult', function(){
            if(RefundState === "acp"){
                $('#remboursementTraiteDetailsModal').modal('show');
            }else{
                $('#remboursementDetailsDangerModal').modal('show');
            }            
        });

        $(document).on('click', '#confirmerRemboursementBtn', function(){
            var amount = $('#confirmationRemboursementModal').data('amount');
            var mode_rembourssement = $('#confirmationRemboursementModal').data('mode_paiement');
            var id_refund = $('#confirmationRemboursementModal').data('id_refund');

            $.ajax({
                url : "{% url 't_tresorerie:ApiSaveRefundOperation' %}",
                dataType : 'JSON',
                type : 'POST',
                data : {
                    'id_client' : id_client,
                    'refund_amount' : amount,
                    'mode_rembourssement' : mode_rembourssement,
                    'id_refund' : id_refund,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        let spinner = document.createElement("div");
                        spinner.innerHTML = `
                            <div id="loadingSpinner" style="
                                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                z-index: 9999;
                                backdrop-filter: blur(3px);">
                                <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                                <div class="success-message" style="
                                    font-family: Arial, sans-serif;
                                    font-size: 18px;
                                    color: #3b7ddd;
                                    font-weight: 500;
                                    text-align: center;
                                    margin-bottom: 10px;">
                                    <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                                </div>
                                
                            </div>
                            <style>
                                @keyframes spin {
                                    0% { transform: rotate(0deg); }
                                    100% { transform: rotate(360deg); }
                                }
                                .modern-spinner {
                                    width: 60px;
                                    height: 60px;
                                    border: 5px solid #e0e0e0;
                                    border-top: 5px solid #3b7ddd;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                }
                            </style>
                        `;
                        document.body.appendChild(spinner);
                        setTimeout(function() {
                            window.location.href = "{% url 't_tresorerie:DetailsRembourssement' pk=0 %}".replace('0',response.rembourssementId);
                        }, 1000);
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");

                    }
                }
            })
           
        });
                  
        $(document).on('click', '#confirmEcheancierBtn', function(){
            // Remplir la modale avec les informations actuelles
            $('#modalSpecialite').text($('#specialite').text());
            $('#modalPromo').text($('#promo').text());
            $('#modalPrixFormation').text($('#prix_formation').text());
            
            // Vérifier s'il y a une réduction et mettre à jour l'affichage
            if (hasReduction && reductionApprouved) {
                $('#modalPrixFormation').text($('#initialPrice').text() + ' DA');
                $('#modalPrixFinalRow').show();
                $('#modalPrixFinal').text($('#finalPrice').text() + ' DA');
                // Afficher la colonne Prix final dans le tableau
                $('#modalPrixFinalHeader').show();
            } else {
                $('#modalPrixFinalRow').hide();
                // Masquer la colonne Prix final dans le tableau
                $('#modalPrixFinalHeader').hide();
            }
            
            // Remplir le tableau des échéances dans la modale
            var echeancesHtml = '';
            $('#echeancierTable tr').each(function(index) {
                var libelle = $(this).find('td:eq(0)').text();
                var date = $(this).find('td:eq(1)').text();
                var montant = $(this).find('td:eq(2)').text();
                
                echeancesHtml += '<tr>';
                echeancesHtml += '<td>' + libelle + '</td>';
                echeancesHtml += '<td>' + date + '</td>';
                echeancesHtml += '<td>' + montant + '</td>';
                
                // Ajouter le prix final si une réduction est appliquée
                if (hasReduction && reductionApprouved) {
                    var prixReduitElement = $(this).find('td:eq(3)');
                    if (prixReduitElement.length > 0) {
                        var prixReduit = prixReduitElement.text();
                        echeancesHtml += '<td>' + prixReduit + '</td>';
                    }
                }
                
                echeancesHtml += '</tr>';
            });
            $('#modalEcheancesTable').html(echeancesHtml);
            
            // Afficher la modale de détails
            $('#confirmEcheancierModal').modal('hide');
            $('#confirmationDetailsModal').modal('show');
        });
        
        // Pré-remplir les informations dans le modal spécial
        $('#specialEcheancierModal').on('show.bs.modal', function () {
            $('#modalSpecialite').text($('#specialite').text());
            $('#modalPromo').text($('#promo').text());
            $('#modalPrixFormation').text($('#prix_formation').text());
        });
        
        // Générer les tranches
        $(document).on('click', '#genererTranchesBtn', function(){
            var nombreTranches = parseInt($('#nombreTranches').val());
            var prix = parseFloat(prixFormation);
            
            if (isNaN(nombreTranches) || nombreTranches <= 0) {
                alert("Veuillez entrer un nombre de tranches valide");
                return;
            }
            
            if (isNaN(prix) || prix <= 0) {
                alert("Prix de formation invalide");
                return;
            }
            
            var html = '';
            var pourcentageParTranche = (100 / nombreTranches).toFixed(2);
            
            // Initialiser le tableau des pourcentages précédents
            previousPercentages = [];
            
            for (var i = 1; i <= nombreTranches; i++) {
                var montant = (prix * (pourcentageParTranche / 100)).toFixed(2);
                previousPercentages.push(parseFloat(pourcentageParTranche));
                html += '<tr>';
                html += '<td class="tranche-cell-special"><span class="badge bg-warning">Tranche ' + i + '</span></td>';
                html += '<td><div class="d-flex align-items-center"><input type="number" class="form-control border-0 bg-light py-1 percentage-input" value="' + pourcentageParTranche + '" data-index="' + (i-1) + '" step="0.01" min="0" style="width: 80px;"><span class="ms-1">%</span></div></td>';
                html += '<td class="montant-cell">' + montant + ' DA</td>';
                html += '<td><input type="date" class="form-control border-0 bg-light py-1" style="width: 150px;"></td>';
                html += '</tr>';
            }
            
            $('#specialEcheancierTable').html(html);
            $('#saveSpecialEcheancierBtn').prop('disabled', false);
            
            // Calculer les totaux initiaux
            calculateTotals();
        });
        
        // Mise à jour manuelle des pourcentages sans recalcul des autres
        $(document).on('input', '.percentage-input', function(){
            var $this = $(this);
            var newPercentage = parseFloat($this.val()) || 0;
            var prix = parseFloat(prixFormation) || 0;
            
            // Mettre à jour le montant pour l'élément modifié
            updateMontant($this, newPercentage, prix);
            
            // Recalculer les totaux
            calculateTotals();
        });
        
        // Fonction pour mettre à jour le montant
        function updateMontant($input, percentage, prix) {
            var montant = (prix * (percentage / 100)).toFixed(2);
            $input.closest('tr').find('.montant-cell').text(montant + ' DA');
        }
        
        // Fonction pour calculer les totaux
        function calculateTotals() {
            var totalPercentage = 0;
            var totalAmount = 0;
            var prix = parseFloat(prixFormation) || 0;
            
            // Calculer les totaux
            $('.percentage-input').each(function(){
                var percentage = parseFloat($(this).val()) || 0;
                totalPercentage += percentage;
                totalAmount += (prix * (percentage / 100));
            });
            
            // Mettre à jour les totaux dans le footer
            $('#totalPercentage').text(totalPercentage.toFixed(2) + '%');
            $('#totalAmount').text(totalAmount.toFixed(2) + ' DA');
            
            // Activer/désactiver le bouton d'enregistrement (toujours activé maintenant)
            $('#saveSpecialEcheancierBtn').prop('disabled', false);
        }
        
        // Ouvrir la modale de confirmation lors du clic sur "Enregistrer l'échéancier"
        $(document).on('click', '#saveSpecialEcheancierBtn', function(){
            $('#confirmSaveEcheancierModal').modal('show');
        });
        
        // Gérer la case à cocher de confirmation
        $(document).on('change', '#confirmValidationCheck', function(){
            if ($(this).is(':checked')) {
                $('#confirmSaveEcheancierBtn').prop('disabled', false);
            } else {
                $('#confirmSaveEcheancierBtn').prop('disabled', true);
            }
        });
        
        // Confirmer l'enregistrement de l'échéancier
        $(document).on('click', '#confirmSaveEcheancierBtn', function(){
            // Collect data from the special echeancier table
            var echeancierLines = [];
            var isValid = true;
            
            $('#specialEcheancierTable tr').each(function() {
                var $row = $(this);
                var taux = $row.find('.percentage-input').val();
                var nom_tranche = $row.find('.tranche-cell-special').text();
                var montant = $row.find('.montant-cell').text().replace(' DA', '');
                var date = $row.find('input[type="date"]').val();
                
                // Validate required fields
                if (!taux || !montant || !date) {
                    isValid = false;
                    return false; // Break the loop
                }
                
                echeancierLines.push({
                    taux: taux,
                    value: nom_tranche, // We don't have this value in the UI, so leave it empty
                    montant_tranche: montant,
                    date_echeancier: date
                });
            });
            
            if (!isValid) {
                alert("Veuillez remplir tous les champs pour chaque tranche.");
                return;
            }
            
            // Get other required data
            var prospectId = clientId; // Use the stored client ID
            var nombreTranches = $('#nombreTranches').val();
            
            // Prepare data for API call
            var data = {
                prospect_id: prospectId,
                nombre_tranches: nombreTranches,
                echeancier_lines: echeancierLines
            };
            
            // Get CSRF token
            var csrftoken = $('input[name=csrfmiddlewaretoken]').val();
            
            // Call API to save echeancier
            $.ajax({
                url: "{% url 't_tresorerie:ApiStoreEcheancierSpecial' %}",
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.status === 'success') {
                        alert("Échéancier spécial enregistré avec succès !");
                        $('#confirmSaveEcheancierModal').modal('hide');
                        $('#specialEcheancierModal').modal('hide');
                        loadDatas();
                    } else {
                        alert("Erreur: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erreur lors de l'enregistrement:", error);
                    alert("Erreur lors de l'enregistrement de l'échéancier spécial.");
                }
            });
        });
        
        // Confirmation définitive de l'échéancier
        $(document).on('click', '#finalConfirmBtn', function(){
            // Récupérer les données nécessaires
            var id_demande = "{{pk}}";
            
            // Collecter les données de l'échéancier configuré
            var echeancierData = [];
            $('#echeancierTable tr').each(function() {
                var libelle = $(this).find('td:eq(0)').text().trim();
                var date = $(this).find('td:eq(1)').text().trim();
                var montant = $(this).find('td:eq(2)').text().trim().replace(' DA', '');
                
                var montantFinal = montant; 
                if (hasReduction && $(this).find('td:eq(3)').length > 0) {
                    montantFinal = $(this).find('td:eq(3)').text().trim().replace(' DA', '');
                }
                
                // Ne pas ajouter les lignes vides
                if (libelle && montant) {
                    echeancierData.push({
                        'libelle': libelle,
                        'date_echeance': date,
                        'montant': montant,
                        'montant_final': montantFinal
                    });
                }
            });
            
            // Appeler l'API pour récupérer les détails du paiement
            $.ajax({
                url: "{% url 't_tresorerie:ApiGetPaiementRequestDetails' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'id_client': clientId,
                    'has_reduction': hasReduction,
                    'reduction': hasReduction ? $('#reductionAmount').text().replace('%', '') : '0',
                    'echeancier_data': JSON.stringify(echeancierData)
                },
                success: function(response) {
                    if(response.status === "success"){
                        alertify.success("Les paiements ont été générer avec succès")
                        $('#confirmationDetailsModal').modal('hide');
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");
                    }
                   
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors de la récupération des détails du paiement:', error);
                    alert('Erreur lors de la récupération des détails du paiement.');
                }
            });
        });

        $(document).on('click','#showEcheancierSpecialDetails', function(){
            $('#echeancierSpecialDetailsModal').modal('show');
        });
        
        $(document).on('click','#showEcheancierExamenDetails', function(){
            // Copier les données du modal d'échéancier spécial vers le modal d'examen
            $('#echeancierExamenClientName').text($('#echeancierClientName').text());
            $('#echeancierExamenFormation').text($('#echeancierFormation').text());
            $('#echeancierExamenNombreTranches').text($('#echeancierNombreTranches').text());
            $('#echeancierExamenDateCreation').text($('#echeancierDateCreation').text());
            
            // Copier les lignes du tableau
            $('#echeancierExamenLinesTable').html($('#echeancierSpecialLinesTable').html());
            
            // Afficher le modal d'examen
            $('#echeancierExamenDetailsModal').modal('show');
        });

        
        
         // Gestionnaires d'événements pour les boutons d'engagement et d'impression
        $(document).on('click', '#btnEngagement', function(){
            // Vérifier si jsPDF est chargé
            if (typeof window.jspdf === 'undefined') {
                console.error("jsPDF n'est pas chargé");
                alert("Erreur: La bibliothèque PDF n'est pas chargée correctement.");
                return;
            }
            
            // Remplir la modale avec les informations de l'étudiant et les paiements
            var studentName = $('#demandeur').text();
            var formation = $('#specialite').text();
            var promo = $('#promo').text();
            
            // Construire la liste des paiements
            var paymentsList = '';
            $('#ListePaiementRequestLine tr').each(function() {
                var label = $(this).find('td:eq(0)').text();
                var date_echeance = $(this).find('td:eq(1)').text();
                var amount = $(this).find('td:eq(2)').text();
                // Vérifier que la ligne n'est pas vide
                if (label && amount) {
                    paymentsList += '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                                    '<span>' + label + '</span>' +
                                    '<span class="text-muted">' + date_echeance + '</span>' +
                                    '<span class="badge bg-primary rounded-pill">' + amount + '</span>' +
                                    '</li>';
                }
            });
            
            // Mettre à jour le contenu de la modale
            $('#engagementStudentName').text(studentName);
            $('#engagementStudentName2').text(studentName);
            $('#engagementFormation').text(formation);
            $('#engagementPromo').text(promo);
            $('#engagementPaymentsList').html(paymentsList);
            
            // Afficher la modale
            $('#engagementModal').modal('show');
        });
        
        
        $(document).on('click', '.print-bon-btn', function(){
            var id = $(this).data('id');
            alert("Fonctionnalité d'impression de bon - à implémenter pour le paiement ID: " + id);
        });
             
        
        // Gérer la case à cocher de confirmation d'engagement
        $(document).on('change', '#engagementConfirmationCheck', function(){
            if ($(this).is(':checked')) {
                $('#confirmEngagementBtn').prop('disabled', false);
            } else {
                $('#confirmEngagementBtn').prop('disabled', true);
            }
        });
       

        // Imprimer l'engagement
        $(document).on('click', '#btnPrintEngagement', function(){
            // Récupérer les données de l'étudiant
            var studentName = $('#demandeur').text();
            var formation = $('#specialite').text();
            var promo = $('#promo').text();
            var currentDate = new Date().toLocaleDateString('fr-FR');
            
            // Vérifier qu'on a les données de l'étudiant
            if (!studentName || !formation || !promo) {
                alert("Les informations de l'étudiant ne sont pas complètes.");
                return;
            }
            
            // Récupérer les paiements dus
            var paymentsData = [];
            var hasPayments = false;
            
            $('#ListePaiementRequestLine tr').each(function() {
                var label = $(this).find('td:eq(1)').text().trim();
                var date_echeance = $(this).find('td:eq(2)').text().trim();
                var amount = $(this).find('td:eq(3)').text().trim();
                
                // Vérifier que la ligne n'est pas vide
                if (label && amount && date_echeance) {
                    paymentsData.push({
                        label: label,
                        amount: amount,
                        date_echeance: date_echeance
                    });
                    hasPayments = true;
                }
            });
            
            // Vérifier qu'il y a des paiements
            if (!hasPayments) {
                alertify.error("Veuillez valider l'echéancier de paiement avec de pouvoir proceder a l'impression de l'engagement.");
                return;
            }
            
            
        }); 

     
        $(document).on('click', "#applyReductionBtn", function(){
            var remiseId = $(this).data('id');
                      
           
            
            // Faire un appel AJAX pour appliquer la réduction
            $.ajax({
                url: "{% url 't_tresorerie:ApiApplyRemiseToPaiement' %}",
                type: 'POST',
                dataType : "JSON",
                data : {
                    'remiseId' : remiseId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("La remise a été appliquer avec succès");
                        $('#reductionDetailsModal').modal('hide');
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete.");
                    }
                },
            });
        });
        
        // Gestion de la modale de nouveau paiement
        $('#nouveauPaiementModal').on('show.bs.modal', function () {
            // Charger les échéances dans le dropdown
            var echeancesOptions = '<option value="">Sélectionnez une échéance</option>';

            // Parcourir les lignes du tableau des échéances dues
            $('#ListePaiementRequestLine tr').each(function() {
                var id_due_paiement = $(this).find('td:eq(0)').text().trim();
                var label = $(this).find('td:eq(1)').text().trim();
                var date = $(this).find('td:eq(2)').text().trim();
                var montant = $(this).find('td:eq(3)').text().trim();
                var restant = $(this).find('td:eq(4)').text().trim();

                // Vérifier que la ligne n'est pas vide
                if (label && montant) {
                    var optionText = label + " - " + restant;
                    if (date) {
                        optionText += " - Échéance: " + date;
                    }
                    echeancesOptions += '<option data-id_due_paiement = "'+ id_due_paiement +'" value="' + label + '" data-montant="' + restant.replace(" DA", "") + '">' + optionText + '</option>';
                }
            });

            $('#echeancierSelection').html(echeancesOptions);

            // Réinitialiser le résumé
            $('#resumeEcheance').text('-');
            $('#resumeDate').text('-');
            $('#resumeMontant').text('0.00 DA');
            $('#resumeMode').text('-');
            $('#resumeReference').text('-');

            // Set the date field to the current date
            var today = new Date().toISOString().split('T')[0];
            $('#datePaiement').val(today);
            // Update the summary with today's date
            $('#resumeDate').text(new Date(today).toLocaleDateString('fr-FR'));
        });
        
        // Mettre à jour le montant quand une échéance est sélectionnée
        $(document).on('change', '#echeancierSelection', function(){
            var selectedOption = $(this).find('option:selected');
            var montant = selectedOption.data('montant');
            var id_due_paiement = selectedOption.data('id_due_paiement');
            var label = selectedOption.text();
            
            $('#enregistrerPaiementBtn').data('id',id_due_paiement );
            if (montant) {
                $('#montantPaiement').val(montant);
                // Mettre à jour le résumé
                $('#resumeEcheance').text(label.split(" - Échéance:")[0]);
            }
        });
        
        // Mettre à jour le résumé en temps réel (date is frozen to current date)
        // The date field is readonly and will always show the current date
        
        $(document).on('change keyup', '#montantPaiement', function(){
            var montant = $(this).val();
            if (montant) {
                $('#resumeMontant').text(parseFloat(montant).toFixed(2) + ' DA');
            } else {
                $('#resumeMontant').text('0.00 DA');
            }
        });
        
        $(document).on('change', '#modePaiement', function(){
            var mode = $(this).find('option:selected').text();
            if (mode && mode !== 'Sélectionnez un mode') {
                $('#resumeMode').text(mode);
            } else {
                $('#resumeMode').text('-');
            }
        });
        
        $(document).on('keyup', '#referencePaiement', function(){
            var reference = $(this).val();
            if (reference) {
                $('#resumeReference').text(reference);
            } else {
                $('#resumeReference').text('-');
            }
        });
        
        // Afficher la synthèse du paiement
        $(document).on('click', '#enregistrerPaiementBtn', function(){
            // Récupérer les données du formulaire
            var id_due_paiement = $(this).data('id');
            var echeance = $('#echeancierSelection').val();
            var datePaiement = $('#datePaiement').val();
            var montant = $('#montantPaiement').val();
            var modePaiement = $('#modePaiement').val();
            var reference = $('#referencePaiement').val();
            var observation = $('#observationPaiement').val();
            var clientIdPaiement = $('#clientIdInput').val();
            
            // Validation simple
            if (!echeance || !datePaiement || !montant || !modePaiement) {
                alertify.error("Veuillez remplir tous les champs obligatoires.");
                return;
            }

            // Validation spécifique pour les modes de paiement qui nécessitent une référence
            if ((modePaiement === 'che' || modePaiement === 'vir') && !reference) {
                alertify.error("Veuillez indiquer la référence du paiement pour les modes Chèque et Virement.");
                return;
            }
            
            // Remplir la modale de synthèse
            $('#syntheseEcheance').text($('#echeancierSelection option:selected').text());
            $('#syntheseDate').text(new Date(datePaiement).toLocaleDateString('fr-FR'));
            $('#syntheseMontant').text(parseFloat(montant).toFixed(2) + ' DA');
            
            // Afficher le mode de paiement en texte lisible
            var modeText = '';
            switch(modePaiement) {
                case 'esp': modeText = 'Espèce'; break;
                case 'che': modeText = 'Chèque'; break;
                case 'vir': modeText = 'Virement'; break;
                default: modeText = modePaiement;
            }
            $('#syntheseMode').text(modeText);
            $('#syntheseReference').text(reference || '-');
            $('#syntheseObservations').text(observation || '-');
            
            // Stocker les données pour la confirmation
            $('#confirmerPaiementBtn').data('id_due_paiement', id_due_paiement);
            $('#confirmerPaiementBtn').data('echeance', echeance);
            $('#confirmerPaiementBtn').data('datePaiement', datePaiement);
            $('#confirmerPaiementBtn').data('montant', montant);
            $('#confirmerPaiementBtn').data('modePaiement', modePaiement);
            $('#confirmerPaiementBtn').data('reference', reference);
            $('#confirmerPaiementBtn').data('observation', observation);
            $('#confirmerPaiementBtn').data('clientIdPaiement', clientIdPaiement);
            
            // Fermer la modale de paiement et ouvrir la modale de synthèse
            $('#nouveauPaiementModal').modal('hide');
            $('#synthesePaiementModal').modal('show');
        });
        
        // Confirmer le paiement
        $(document).on('click', '#confirmerPaiementBtn', function(){
            // Récupérer les données stockées
            var id_due_paiement = $(this).data('id_due_paiement');
            var echeance = $(this).data('echeance');
            var datePaiement = $(this).data('datePaiement');
            var montant = $(this).data('montant');
            var modePaiement = $(this).data('modePaiement');
            var reference = $(this).data('reference');
            var observation = $(this).data('observation');
            var clientIdPaiement = $(this).data('clientIdPaiement');
            
            $.ajax({
                url : "{% url 't_tresorerie:ApiStoreClientPaiement' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'id_due_paiement' : id_due_paiement,
                    'echeance' : echeance,
                    'datePaiement' : datePaiement,
                    'montant' : montant,
                    'modePaiement' : modePaiement,
                    'reference' : reference,
                    'observation' : observation,
                    'clientId' : clientIdPaiement,
                    'promo' : promoCode,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },

                success : function(response){
                    if(response.status === "success"){
                        alertify.success("Le paiement à été enregistrer avec succès");
                        loadDatas();
                    }else{
                        showUnpaidPaymentNotification();
                    }
                }
            })
            
            // Fermer la modale de synthèse
            $('#synthesePaiementModal').modal('hide');
            
            // Réinitialiser le formulaire
            $('#echeancierSelection').val('');
            $('#datePaiement').val('');
            $('#montantPaiement').val('');
            $('#modePaiement').val('');
            $('#referencePaiement').val('');
            $('#observationPaiement').val('');
            
            // Réinitialiser le résumé
            $('#resumeEcheance').text('-');
            $('#resumeDate').text('-');
            $('#resumeMontant').text('0.00 DA');
            $('#resumeMode').text('-');
            $('#resumeReference').text('-');
        });
        
        // Imprimer la quittance
        $(document).on('click', '.print-quittance-btn', function(){
            var id = $(this).data('id');
            
            // Get payment data
            var payment = paymentData[id];
            if (!payment) {
                alert("Données de paiement non trouvées pour l'ID: " + id);
                return;
            }
            
            // Get student information
            var studentName = $('#demandeur').text();
            var formation = $('#specialite').text();
            var promo = $('#promo').text();
            var currentDate = new Date().toLocaleDateString('fr-FR');
            
            // Generate PDF
            generateQuittancePDF(payment, studentName, formation, promo, currentDate,id_client);
        });
        
       
        // === Charger les infos entreprise ===
        function loadEntrepriseDatas(id_client) {
            return $.ajax({
                url: "{% url 't_tresorerie:ApiGetEntrepriseInfos' %}",
                dataType: "JSON",
                type: 'GET',
                data: { 'id_client': id_client },
            });
        }

        // === Fonction principale pour générer le PDF ===
        function generateQuittancePDF(payment, studentName, formation, promo, currentDate, id_client) {

            // Étape 1 : Charger les infos de l'entreprise avant de générer le PDF
            loadEntrepriseDatas(id_client).done(function(entreprise) {
                
                // Étape 2 : Vérifier jsPDF
                var jsPDFInstance = null;

                if (typeof jsPDF !== 'undefined') {
                    jsPDFInstance = jsPDF;
                    createQuittancePDF(payment, studentName, formation, promo, currentDate, jsPDFInstance, entreprise);
                } 
                else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                    jsPDFInstance = window.jspdf.jsPDF;
                    createQuittancePDF(payment, studentName, formation, promo, currentDate, jsPDFInstance, entreprise);
                } 
                else {
                    // Étape 3 : Charger jsPDF dynamiquement
                    var script1 = document.createElement('script');
                    script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script1.onload = function() {
                        var script2 = document.createElement('script');
                        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js';
                        script2.onload = function() {
                            var loadedJsPDF = null;
                            if (typeof jsPDF !== 'undefined') {
                                loadedJsPDF = jsPDF;
                            } else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                                loadedJsPDF = window.jspdf.jsPDF;
                            }

                            if (loadedJsPDF) {
                                createQuittancePDF(payment, studentName, formation, promo, currentDate, loadedJsPDF, entreprise);
                            } else {
                                alert("Erreur lors du chargement de jsPDF.");
                            }
                        };
                        script2.onerror = function() {
                            alert("Erreur lors du chargement de jsPDF AutoTable.");
                        };
                        document.head.appendChild(script2);
                    };
                    script1.onerror = function() {
                        alert("Erreur lors du chargement de jsPDF.");
                    };
                    document.head.appendChild(script1);
                }
            })
            .fail(function() {
                alert("Impossible de charger les informations de l'entreprise.");
            });
        }

        // === Fonction pour créer le PDF ===
       function createQuittancePDF(payment, studentName, formation, promo, currentDate, jsPDFInstance, entreprise) {
            try {
                var doc = new jsPDFInstance('p', 'mm', 'a4');
                doc.setFont("helvetica");

                const pageHeight = doc.internal.pageSize.height;
                const middle = pageHeight / 2;

                var groupe_name= $('#_groupe_name').val();
                var semestre= $('#_semestre').val();

                // Get current print date
                var today = new Date();
                var printDate = today.toLocaleDateString('fr-FR');

                function drawQuittance(yOffset) {
                    doc.setFontSize(14);
                    doc.setTextColor(40, 40, 40);
                    if(payment.label_paiements === "Frais d'inscription")
                        doc.text("BON DE PRE-INSCRIPTION", 105, yOffset + 15, null, null, 'center');
                    else{
                        doc.text("BON DE PAIEMENT", 105, yOffset + 15, null, null, 'center');
                    }

                    doc.setDrawColor(59, 125, 221);
                    doc.setLineWidth(0.5);
                    doc.line(20, yOffset + 20, 190, yOffset + 20);

                    doc.setFontSize(10);  // Set the same font size as other texts
                    doc.setTextColor(40, 40, 40);
                    doc.text("Date: " + currentDate, 150, yOffset + 25);
                    doc.text("N° Bon: " + payment.num, 150, yOffset + 30);

                    doc.setFontSize(10);
                    doc.text("Reçu de:", 20, yOffset + 35);
                    doc.setFontSize(9);
                    doc.text(studentName, 40, yOffset + 35);

                    doc.setFontSize(10);
                    doc.text("Formation:", 20, yOffset + 41);
                    doc.setFontSize(9);
                    doc.text(formation, 40, yOffset + 41);

                    doc.setFontSize(10);
                    doc.text("Promo:", 20, yOffset + 47);
                    doc.setFontSize(9);
                    doc.text(promo, 35, yOffset + 47);

                    doc.setFontSize(10);
                    doc.text("Groupe:", 60, yOffset + 47);
                    doc.setFontSize(9);
                    doc.text(groupe_name, 75, yOffset + 47);

                    doc.setFontSize(10);
                    doc.text("Semestre:", 110, yOffset + 47);
                    doc.setFontSize(9);
                    doc.text(semestre, 130, yOffset + 47);

                    // Get date of birth and place of birth from hidden input fields
                    const dateNaissance = document.getElementById('_date_naissance').value;
                    const lieuNaissance = document.getElementById('_lieu_naissance').value;

                    // Add date and place of birth if available
                    if (dateNaissance) {
                        doc.setFontSize(10);
                        doc.text("Date de naissance:", 20, yOffset + 53);
                        doc.setFontSize(9);
                        doc.text(dateNaissance, 52, yOffset + 53);
                    }
                    
                    if (lieuNaissance) {
                        doc.setFontSize(10);
                        doc.text("Lieu de naissance:", 20, yOffset + (dateNaissance ? 59 : 53));
                        doc.setFontSize(9);
                        doc.text(lieuNaissance, 52, yOffset + (dateNaissance ? 59 : 53));
                    }

                    doc.setFontSize(11);
                    doc.text("DÉTAILS DU PAIEMENT", 20, yOffset + (dateNaissance || lieuNaissance ? 70 : 60));

                    doc.setFontSize(9);
                    doc.setTextColor(40, 40, 40);
                    doc.text("Motif de paiement :", 20, yOffset + (dateNaissance || lieuNaissance ? 77 : 67));
                    doc.text(payment.label_paiements || "N/A", 60, yOffset + (dateNaissance || lieuNaissance ? 77 : 67));

                    doc.text("Montant payé :", 20, yOffset + (dateNaissance || lieuNaissance ? 83 : 73));
                    doc.setFont("helvetica", "bold");
                    doc.text(payment.montant_paye + " DA", 60, yOffset + (dateNaissance || lieuNaissance ? 83 : 73));
                    doc.setFont("helvetica", "normal");

                    doc.text("Date de paiement :", 20, yOffset + (dateNaissance || lieuNaissance ? 89 : 79));
                    doc.text(payment.date_paiement, 60, yOffset + (dateNaissance || lieuNaissance ? 89 : 79));

                    doc.text("Mode de paiement :", 20, yOffset + (dateNaissance || lieuNaissance ? 95 : 85));
                    doc.text(payment.mode_paiement, 60, yOffset + (dateNaissance || lieuNaissance ? 95 : 85));

                    doc.text("Référence :", 20, yOffset + (dateNaissance || lieuNaissance ? 101 : 91));
                    doc.text(payment.reference_paiement || "N/A", 60, yOffset + (dateNaissance || lieuNaissance ? 101 : 91));


                    doc.setFontSize(8);
                    doc.setTextColor(80, 80, 80);
                    doc.text("Date d'impression: " + printDate, 20, yOffset + (dateNaissance || lieuNaissance ? 117 : 107));
                   

                    doc.text("Signature", 120, yOffset + (dateNaissance || lieuNaissance ? 123 : 113));
                    doc.line(120, yOffset + (dateNaissance || lieuNaissance ? 126 : 116), 180, yOffset + (dateNaissance || lieuNaissance ? 126 : 116));
                }

                // Première quittance
                drawQuittance(0);

                // Ligne de séparation
                doc.setFontSize(8);
                // Dessiner le texte "À découper ici" sur toute la largeur
                doc.text("--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------", 10, middle - 2);
                doc.text("À découper ici", 105, middle - 2, null, null, 'center');

                // Deuxième quittance
                drawQuittance(middle + 5);

                // Sauvegarde
                doc.save("pre_inscription_" + payment.num + "_" + studentName.replace(/\s+/g, '_') + ".pdf");
                alertify.success("Deux bons de pré-inscription générés avec succès !");
            } catch (error) {
                console.error("Erreur lors de la génération du PDF:", error);
                alert("Erreur : " + error.message);
            }
        }


        // Ouvrir le modal de configuration de la facture
        $(document).on('click', '.print-facture-btn', function(e){
            e.preventDefault();
            var id = $(this).data('id');
            $('#modalPaiementId').val(id);
            var modal = new bootstrap.Modal(document.getElementById('invoiceConfigModal'));
            modal.show();
        });

        $(document).on('click', '#confirmGenerateInvoice', function(){
            var id = $('#modalPaiementId').val();
            var tva = $('input[name="tvaRate"]:checked').val();
            var btn = $(this);
            
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Génération...');

            $.ajax({
                url: "{% url 't_tresorerie:ApiGenerateInvoiceFromPayment' %}",
                type: "POST",
                data: {
                    'paiement_id': id,
                    'tva_percent': tva,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        alertify.success(response.message);
                        $('#invoiceConfigModal').modal('hide');
                        if(response.facture_num) {
                             setTimeout(() => {
                                window.location.href = `/comptabilite/tresorerie/details-facture/${response.facture_num}/`;
                             }, 1000);
                        }
                    } else {
                        alertify.error(response.message || 'Erreur lors de la génération');
                        btn.prop('disabled', false).html('<i class="ri-check-line me-1"></i> Générer la facture');
                    }
                },
                error: function() {
                    alertify.error('Erreur réseau');
                    btn.prop('disabled', false).html('<i class="ri-check-line me-1"></i> Générer la facture');
                }
            });
        });
        
        
        // Confirmation de suppression
        $(document).on('click', '#confirmDeleteBtn', function(){
            var num_bon = $(this).data('id');
            $.ajax({
                url : "{% url 't_tresorerie:ApiDeletePaiement' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'num_bon' : num_bon,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("Le paiement à été supprimer avec succès");
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");

                    }
                }
                
        });
            $('.deleteModal').modal('hide');
        });
        
        // Demande de remboursement (nouveau bouton)
        $(document).on('click', '#btnRefundRequestModal', function(){
            
            $('#confirmRefundBtn').data('clientId', clientId);
            $('.refundModal').modal('show');
        });
        
        // Confirmation de remboursement
        $(document).on('click', '#confirmRefundBtn', function(){
            var clientId = $(this).data('clientId');
            var reason = $('#refundReason').val();
           
            if (!reason.trim()) {
                alertify.error("Veuillez indiquer le motif du remboursement.");
                return;
            }
            
            if (!clientId) {
                alertify.error("Aucun client sélectionné pour la demande de remboursement.");
                return;
            }
            
            $.ajax({
                url : "{% url 't_tresorerie:ApiRequestRefundPaiement' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'client_id' : clientId,
                    'reason' : reason,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("La demande de remboursement à été envoyée avec succès");
                        loadDatas();
                        $('.refundModal').modal('hide');
                        $('#refundReason').val(''); // Clear the reason field
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");

                    }
                }
            });
            
        });

        $(document).on('click', '#confirmApplyEcheancierSpecialBtn', function(){

            $.ajax({
                url : "{% url 't_tresorerie:ApiApplyEcheancierSpecial' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'id_echeancier_special' : IdSpecialEcheancier,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("L'échéancier spécial a été appliqué avec succès");
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");

                    }
                }
            });
            $('#specialEcheancierModal').modal('hide');

        });
        
         function showUnpaidPaymentNotification() {
            $('#unpaidPaymentModal').modal('show');
        }


         // Imprimer l'engagement
        $(document).on('click', '#btnPrintEngagement', function(){
            $('#engagementAssistantModal').modal('show');
        });
    
        // Add click handler for the assistant modal print button
        $(document).on('click', '#printEngagementWithDetails', function() {
            // Validate required fields from assistant modal
            var signataire = $('#signataireSelect').val();
            var pieceIdentite = $('#pieceIdentiteSelect').val();
            var numeroPiece = $('#numeroPieceInput').val();
            var dateDelivrance = $('#dateDelivranceInput').val();
            var lieuDelivrance = $('#lieuDelivranceInput').val();
            var demandeurAdresse = $('#_demandeurAdresse').val();
            var demandeurContact = $('#_demandeurContact').val();

            
            if (!signataire || !pieceIdentite || !numeroPiece || !dateDelivrance || !lieuDelivrance) {
                alert("Veuillez remplir tous les champs obligatoires dans l'assistant.");
                return;
            }

            // Vérifier si les champs nom et prénom sont requis (pour Parents ou Tuteur)
            if (signataire === 'Parents' || signataire === 'Tuteur') {
                var nomParentTuteur = $('#nomParentTuteurInput').val();
                var prenomParentTuteur = $('#prenomParentTuteurInput').val();
                var adresseParentTuteur = $('#adresseParentTuteurInput').val();
                var contactParentTuteur = $('#contactParentTuteurInput').val();
                

                if (!nomParentTuteur || !prenomParentTuteur || !adresseParentTuteur || !contactParentTuteur ) {
                    alert("Veuillez remplir les informations du parent ou tuteur.");
                    return;
                }
            }
            
            // Close the assistant modal
            bootstrap.Modal.getOrCreateInstance(document.getElementById('engagementAssistantModal')).hide();
            
            // Call the original printEngagement function which will now have access to the modal data
            if (signataire === 'Parents' || signataire === 'Tuteur') {
                var nomParentTuteur = $('#nomParentTuteurInput').val();
                var prenomParentTuteur = $('#prenomParentTuteurInput').val();
                var adresseParentTuteur = $('#adresseParentTuteurInput').val();
                var contactParentTuteur = $('#contactParentTuteurInput').val();

                printEngagement(numeroPiece, signataire, nomParentTuteur, prenomParentTuteur,adresseParentTuteur,contactParentTuteur,pieceIdentite,dateDelivrance,numeroPiece, lieuDelivrance);
            } else {
                printEngagement(numeroPiece, signataire, null, null, demandeurAdresse, demandeurContact,pieceIdentite,dateDelivrance, numeroPiece, lieuDelivrance);
            }
        });
        
        function printEngagement(numeroPiece, signataire, nomParentTuteur, prenomParentTuteur,adresseParentTuteur,contactParentTuteur,pieceIdentite,dateDelivrance,numeroPiece, lieuDelivrance){
            // Récupérer les données de l'étudiant
            var studentName = $('#demandeur').text();
            var specialite = $('#specialite').text();
            var formationLabel =$('#_formation').val();
            var promo = $('#promo').text();
            var currentDate = new Date().toLocaleDateString('fr-FR');
            var _date_naissance = $('#_date_naissance').val();
            var _lieu_naissance = $('#_lieu_naissance').val();
            var entite = $('#_entite').val();
            var ville = $('#_ville').val();
            var montant = $('#_montant_formation').val();
            var montant_lettre = numberToWordsDZD(montant);

            var numeroPiece = numeroPiece;
            var signataire = signataire;
            var nomParentTuteur = nomParentTuteur;
            var prenomParentTuteur = prenomParentTuteur;
            var adresseParentTuteur = adresseParentTuteur;
            var contactParentTuteur = contactParentTuteur;
            var pieceIdentite = pieceIdentite;
            var  dateDelivrance = dateDelivrance;
            var  numeroPiece = numeroPiece;
            var lieuDelivrance = lieuDelivrance;

            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('fr-FR');

            // Vérifier qu'on a les données de l'étudiant
            if (!studentName || !promo) {
                alert("Les informations de l'étudiant ne sont pas complètes.");
                return;
            }
            
            // Récupérer les paiements dus
            var paymentsData = [];
              
            $('#ListePaiementRequestLine tr').each(function() {
                var label = $(this).find('td:eq(1)').text().trim();
                var date_echeance = $(this).find('td:eq(2)').text().trim();
                var amount = $(this).find('td:eq(3)').text().trim();
                
                // Vérifier que la ligne n'est pas vide et qu'elle ne contient pas "frais d'inscription"
                if (label && amount && date_echeance && !label.toLowerCase().includes('frais d\'inscription')) {
                    paymentsData.push({
                        label: label,
                        amount: amount,
                        date_echeance: date_echeance
                    });
                    hasPayments = true;
                }
            });
            
            // Vérifier qu'il y a des paiements
            if (!hasPayments) {
                alertify.error("Veuillez valider l'echéancier de paiement avec de pouvoir proceder a l'impression de l'engagement.");
                return;
            }
            
            // Fonction pour charger jsPDF dynamiquement si nécessaire
            function loadJsPDFLibraries(callback) {
                // Vérifier si jsPDF est déjà disponible
                if (typeof jsPDF !== 'undefined') {
                    callback();
                    return;
                }
                
                // Charger jsPDF
                var script1 = document.createElement('script');
                script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script1.onload = function() {
                    // Charger autoTable
                    var script2 = document.createElement('script');
                    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js';
                    script2.onload = callback;
                    script2.onerror = function() {
                        console.error('Erreur lors du chargement de jsPDF AutoTable');
                        alert("Erreur lors du chargement de la bibliothèque PDF (AutoTable).");
                        callback();
                    };
                    document.head.appendChild(script2);
                };
                script1.onerror = function() {
                    console.error('Erreur lors du chargement de jsPDF');
                    // Si le chargement échoue, utiliser la solution de secours
                    generateTextDocument();
                };
                document.head.appendChild(script1);
            }
              
            // Fonction pour générer le PDF
            function generateEngagementPDF() {
                var jsPDFInstance = null;
                if (typeof jsPDF !== 'undefined') {
                    jsPDFInstance = jsPDF;
                } else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                    jsPDFInstance = window.jspdf.jsPDF;
                } else if (typeof jspdf !== 'undefined' && typeof jspdf.jsPDF !== 'undefined') {
                    jsPDFInstance = jspdf.jsPDF;
                }

                if (jsPDFInstance) {
                    try {
                        const doc = new jsPDFInstance();

                        // Logos
                        const logoHeaderUrl = document.getElementById('_logoHeader').value;
                        const logoFooterUrl = document.getElementById('_logoFooter').value;

                        const addLogosToPDF = () => {
                            if (logoHeaderUrl) {
                                const headerLogoUrl = logoHeaderUrl.startsWith('/') ? window.location.origin + logoHeaderUrl : logoHeaderUrl;
                                const headerLogoWidth = doc.internal.pageSize.width * 0.25;
                                doc.addImage(headerLogoUrl, 'PNG', 150, 10, headerLogoWidth, headerLogoWidth * 0.375);
                            }

                            if (logoFooterUrl) {
                                const footerLogoUrl = logoFooterUrl.startsWith('/') ? window.location.origin + logoFooterUrl : logoFooterUrl;
                                doc.addImage(footerLogoUrl, 'PNG', 20, doc.internal.pageSize.height - 20, doc.internal.pageSize.width - 40, 15);
                            }
                        };

                        addLogosToPDF();
                        doc.setFont('helvetica');
                        doc.setFontSize(16);
                        if(has_special_echeancier){
                            doc.text("LETTRE D'ENGAGEMENT POUR UN ÉCHÉANCIER SPÉCIAL", 105, 50, null, null, 'center');
                        }else{
                            doc.text("LETTRE D'ENGAGEMENT", 105, 50, null, null, 'center');
                        }
                        

                        doc.setFontSize(10);
                        let y = 68; // point de départ légèrement plus haut
                        const line = (step = 6) => y += step; // espacement réduit entre les lignes

                        // Afficher le signataire avec le nom/prénom si c'est un parent ou tuteur
                        if (signataire === 'Parents' || signataire === 'Tuteur') {
                            doc.text("Je soussigné(e),  "+prenomParentTuteur+" "+nomParentTuteur, 20, line());
                            doc.text("Agissant en qualité de : "+signataire, 20, line());
                        } else {
                            doc.text("Je soussigné(e),  "+studentName, 20, line());
                            doc.text("Agissant en qualité de : "+signataire, 20, line());
                        }
                        doc.text("Demeurant à : "+adresseParentTuteur, 20, line());
                        doc.text("Contact téléphonique : "+contactParentTuteur, 20, line(8));

                        doc.text("M'engage formellement à régler la somme de :", 20, line(8));
                        doc.text("(en chiffres) "+montant+" DZD", 30, line());
                        doc.text("(en lettres) "+montant_lettre+"", 30, line(8));

                        doc.text("Au titre des frais de scolarité et de formation de l'apprenant(e) :", 20, line(8));
                        doc.text("Nom et prénom : "+studentName, 30, line());
                        doc.text("Né(e) le : "+_date_naissance+"  À : "+_lieu_naissance+"", 30, line());
                        doc.text("Inscrit(e) au niveau de "+entite+", pour la formation de : "+formationLabel, 30, line());
                        doc.text("Spécialité :"+specialite, 30, line());
                        doc.text("Année académique : 2023 / 2024", 30, line(8));

                        doc.text("Le paiement de la somme susmentionnée s’effectuera selon l’échéancier suivant :", 20, line(8));

                        // Tableau = seulement les paiements existants
                        const columns = ["N°", "Montant (DZD)", "Date de règlement prévue"];
                        const rows = paymentsData.map((p, i) => [
                            i + 1,
                            p.amount || "",
                            p.date_echeance || ""
                        ]);

                        if (typeof doc.autoTable === 'function') {
                            doc.autoTable({
                                head: [columns],
                                body: rows,
                                startY: line(5),
                                theme: 'plain',
                                styles: { textColor: [0, 0, 0], lineWidth: 0.1, fontSize: 11 },
                                headStyles: { halign: 'center', fontStyle: 'bold' },
                                bodyStyles: { halign: 'center' }
                            });
                            y = doc.lastAutoTable.finalY + 10;
                        } else {
                            doc.text("Erreur : AutoTable non chargée.", 20, line());
                        }

                        doc.text("Fait à "+ville+", le "+formattedDate, 150, y); y += 5;
                        doc.text("Signature précédée de la mention « Lu et approuvé » :", 20, y-5); y += 5;
                        doc.text("(Signature de l'apprenant / parent / tuteur légal)", 20, y-5); y += 5;

                        doc.text("Pièce d'identité :", 20, y+6); y += 10;
                        doc.text("Type : "+pieceIdentite, 30, y); y += 6;
                        doc.text("N° : "+numeroPiece, 30, y); y += 6;
                        doc.text("Délivrée le : "+dateDelivrance+"   Par : "+lieuDelivrance+"", 30, y); y += 10;

                        doc.text("Visa de l'administration", 150, y-30);

                        doc.save("engagement_special_" + studentName.replace(/\s+/g, '_') + ".pdf");
                        alertify.success("Document d'engagement spécial généré avec succès !");
                    } catch (error) {
                        console.error("Erreur lors de la génération du PDF:", error);
                        alert("Erreur lors de la génération du document : " + error.message);
                    }
                }
            }

            // Générer le document (PDF ou texte)
            generateEngagementPDF();
        }

        // Convertir un nombre en lettres (ex : 12500 -> "douze mille cinq cents dinars algériens")
        function numberToWordsDZD(nombre) {
            if (!nombre || isNaN(nombre)) return "";

            nombre = parseInt(nombre);

            const unite = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf"];
            const dizaine = ["", "dix", "vingt", "trente", "quarante", "cinquante", "soixante"];
            const dizaine_special = ["dix", "onze", "douze", "treize", "quatorze", "quinze", "seize", "dix-sept", "dix-huit", "dix-neuf"];

            function toWords(n) {
                let words = "";

                if (n < 10) {
                    words = unite[n];
                } else if (n < 20) {
                    words = dizaine_special[n - 10];
                } else if (n < 70) {
                    words = dizaine[Math.floor(n / 10)];
                    if (n % 10 === 1 && n !== 11 && n !== 71 && n !== 91) words += " et un";
                    else if (n % 10 > 0) words += "-" + unite[n % 10];
                } else if (n < 80) {
                    words = "soixante-" + toWords(n - 60);
                } else if (n < 100) {
                    words = "quatre-vingt";
                    if (n > 80) words += "-" + toWords(n - 80);
                }

                return words.trim();
            }

            function underThousand(n) {
                let words = "";
                const hundreds = Math.floor(n / 100);
                const remainder = n % 100;

                if (hundreds > 0) {
                    if (hundreds === 1) words = "cent";
                    else words = unite[hundreds] + " cent";
                    if (remainder === 0 && hundreds > 1) words += "s";
                }

                if (remainder > 0) {
                    words += (words ? " " : "") + toWords(remainder);
                }

                return words;
            }

            function fullNumberToWords(n) {
                if (n === 0) return "zéro";

                const parts = [];
                const milliards = Math.floor(n / 1_000_000_000);
                const millions = Math.floor((n % 1_000_000_000) / 1_000_000);
                const milliers = Math.floor((n % 1_000_000) / 1000);
                const reste = n % 1000;

                if (milliards > 0) {
                    parts.push((milliards > 1 ? underThousand(milliards) + " milliards" : "un milliard"));
                }

                if (millions > 0) {
                    parts.push((millions > 1 ? underThousand(millions) + " millions" : "un million"));
                }

                if (milliers > 0) {
                    if (milliers === 1) parts.push("mille");
                    else parts.push(underThousand(milliers) + " mille");
                }

                if (reste > 0) {
                    parts.push(underThousand(reste));
                }

                return parts.join(" ").replace(/\s+/g, " ").trim();
            }

            const resultat = fullNumberToWords(nombre);
            return resultat.charAt(0).toUpperCase() + resultat.slice(1) + " dinars algériens";
        }

    });
 

</script>



{% endblock content %}