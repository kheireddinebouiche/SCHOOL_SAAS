{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité - Nouveau fournisseur {% endblock title %}

{% block content %}
<style>
    .form-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
</style>

<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-store-2-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Nouveau fournisseur</h4>
                        </div>
                        <div class="page-title-right">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);" class="text-muted">
                                            <i class="ri-home-line me-1"></i>Comptabilité
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="{% url 't_tresorerie:PageFournisseur' %}" class="text-muted">
                                            Fournisseurs
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active text-primary">Nouveau fournisseur</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-gradient-primary text-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0">
                                    <i class="ri-store-2-line me-2"></i>Formulaire d'ajout d'un fournisseur
                                </h4>
                                <span class="badge bg-white text-primary px-3 py-2">Fournisseur</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <form method="POST" class="needs-validation" novalidate>
                                {% csrf_token %}
                                
                                <!-- Informations générales -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-file-text-line text-primary me-2"></i>
                                        <h5 class="text-primary mb-0">Informations générales</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-6">
                                            <label class="form-label">Dénomination *</label>
                                            <input type="text" class="form-control" name="designation" required>
                                            <div class="invalid-feedback">Veuillez entrer la dénomination du fournisseur</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Code fournisseur</label>
                                            <input type="text" class="form-control" name="code">
                                            <div class="invalid-feedback">Veuillez entrer un code pour le fournisseur</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations de contact -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-contacts-line text-primary me-2"></i>
                                        <h5 class="text-primary mb-0">Informations de contact</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-3">
                                            <label class="form-label">Téléphone *</label>
                                            <input type="tel" class="form-control" name="telephone" required>
                                            <div class="invalid-feedback">Veuillez entrer le numéro de téléphone</div>
                                        </div>
                                        <div class="col-lg-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="email">
                                            <div class="invalid-feedback">Veuillez entrer une adresse email valide</div>
                                        </div>
                                         <div class="col-lg-3">
                                            <label class="form-label">Site web</label>
                                            <input type="url" class="form-control" name="site_web">
                                            <div class="invalid-feedback">Veuillez entrer une URL valide</div>
                                        </div>
                                        <div class="col-lg-3">
                                            <label class="form-label">Contact principal</label>
                                            <input type="text" class="form-control" name="contact_principal">
                                            <div class="invalid-feedback">Veuillez entrer le nom du contact principal</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Adresse et localisation -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-map-pin-line text-primary me-2"></i>
                                        <h5 class="text-primary mb-0">Adresse et localisation</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-12">
                                            <label class="form-label">Adresse *</label>
                                            <input type="text" class="form-control" name="adresse" required>
                                            <div class="invalid-feedback">Veuillez entrer l'adresse du fournisseur</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-3">
                                            <label class="form-label">Ville/Commune *</label>
                                            <input type="text" class="form-control" name="commune" required>
                                            <div class="invalid-feedback">Veuillez entrer la ville ou la commune</div>
                                        </div>
                                        <div class="col-lg-3">
                                            <label class="form-label">Wilaya *</label>
                                            <input type="text" class="form-control" name="wilaya" required>
                                            <div class="invalid-feedback">Veuillez entrer la wilaya</div>
                                        </div>
                                        <div class="col-lg-3">
                                            <label class="form-label">Pays *</label>
                                            <input type="text" class="form-control" name="pays" required value="Algérie">
                                            <div class="invalid-feedback">Veuillez entrer le pays</div>
                                        </div>
                                        <div class="col-lg-3">
                                            <label class="form-label">Code postal *</label>
                                            <input type="text" class="form-control" name="code_postal" required>
                                            <div class="invalid-feedback">Veuillez entrer le code postal</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations fiscales -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-bank-card-line text-primary me-2"></i>
                                        <h5 class="text-primary mb-0">Informations fiscales</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-6">
                                            <label class="form-label">R.C (Registre de commerce)</label>
                                            <input type="text" class="form-control" name="rc">
                                            <div class="invalid-feedback">Veuillez entrer le numéro de registre de commerce</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">NIF (Numéro d'Identification Fiscale)</label>
                                            <input type="text" class="form-control" name="nif">
                                            <div class="invalid-feedback">Veuillez entrer le numéro d'identification fiscale</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">NIS (Numéro d'Immatriculation de la Sécurité Sociale)</label>
                                            <input type="text" class="form-control" name="nis">
                                            <div class="invalid-feedback">Veuillez entrer le numéro d'immatriculation de sécurité sociale</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Article d'impôt</label>
                                            <input type="text" class="form-control" name="art_impot">
                                            <div class="invalid-feedback">Veuillez entrer l'article d'impôt</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations bancaires -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-bank-line text-primary me-2"></i>
                                        <h5 class="text-primary mb-0">Informations bancaires</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-4">
                                            <label class="form-label">Nom de la banque</label>
                                            <input type="text" class="form-control" name="banque">
                                            <div class="invalid-feedback">Veuillez entrer le nom de la banque</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Numéro de compte</label>
                                            <input type="text" class="form-control" name="numero_compte">
                                            <div class="invalid-feedback">Veuillez entrer le numéro de compte</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Code banque</label>
                                            <input type="text" class="form-control" name="code_banque">
                                            <div class="invalid-feedback">Veuillez entrer le code banque</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes et observations -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-sticky-note-line text-primary me-2"></i>
                                        <h5 class="text-primary mb-0">Notes et observations</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Observations</label>
                                            <textarea class="form-control" name="observations" rows="3" placeholder="Entrez toute observation ou information complémentaire sur le fournisseur..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit button -->
                                <div class="text-end mt-3">
                                    <button type="button" class="btn btn-light px-4 py-2 me-2" onclick="window.history.back()">
                                        <i class="ri-close-line me-2"></i>Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary px-4 py-2">
                                        <i class="ri-save-line me-2"></i>Enregistrer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!--end col-->
            </div>
            <!--end row-->
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>
    $(document).ready(function(){
        // Form validation
        $('.needs-validation').on('submit', function(event) {
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            $(this).addClass('was-validated');
        });
        
        // Set default value for pays field
        if (!$('input[name="pays"]').val()) {
            $('input[name="pays"]').val('Algérie');
        }
        
        // Convert designation and code fields to uppercase as user types
        $('input[name="designation"]').on('input', function() {
            $(this).val($(this).val().toUpperCase());
        });
        
        $('input[name="code"]').on('input', function() {
            $(this).val($(this).val().toUpperCase());
        });

        // Format telephone field to handle different country codes
        $('input[name="telephone"]').on('input', function() {
            let input = $(this).val().replace(/\D/g, ''); // Remove all non-digit characters

            // Check if input starts with a known country code
            let countryCode = '';
            let shouldUseDefault = true; // Flag to determine if we should use default country code
            
            if (input.length >= 1) {
                // Check if user is typing a specific country code
                if (input.length >= 3 && input.substring(0, 3) === '213') {
                    countryCode = '213';
                    shouldUseDefault = false;
                } 
                else if (input.length >= 2 && input.substring(0, 2) === '33') {
                    countryCode = '33';
                    shouldUseDefault = false;
                } 
                else if (input.length >= 1 && input.substring(0, 1) === '1') {
                    countryCode = '1';
                    shouldUseDefault = false;
                } 
                else if (input.length >= 2 && input.substring(0, 2) === '44') {
                    countryCode = '44';
                    shouldUseDefault = false;
                } 
                else if (input.length >= 2 && input.substring(0, 2) === '49') {
                    countryCode = '49';
                    shouldUseDefault = false;
                } 
                else if (input.length >= 2 && input.substring(0, 2) === '34') {
                    countryCode = '34';
                    shouldUseDefault = false;
                } 
                // Add more specific country code checks as needed
                else if (input.length >= 2 && input.substring(0, 2) === '39') {
                    countryCode = '39';
                    shouldUseDefault = false;
                } 
                else if (input.length >= 2 && input.substring(0, 2) === '43') {
                    countryCode = '43';
                    shouldUseDefault = false;
                }
                else if (input.length >= 2 && input.substring(0, 2) === '32') {
                    countryCode = '32';
                    shouldUseDefault = false;
                }
                else if (input.length >= 2 && input.substring(0, 2) === '31') {
                    countryCode = '31';
                    shouldUseDefault = false;
                }
                else if (input.length >= 2 && input.substring(0, 2) === '41') {
                    countryCode = '41';
                    shouldUseDefault = false;
                }
                // Check if it starts with '0' (common for local Algerian numbers)
                else if (input.startsWith('0')) {
                    countryCode = '213'; // Convert 0 to 213
                    input = '213' + input.substring(1);
                    shouldUseDefault = false;
                }
            }

            // Only use the default if no specific country code was detected
            if (shouldUseDefault && input.length > 0 && !input.startsWith('2') && !input.startsWith('3') && !input.startsWith('4')) {
                // Default to 213 only for numbers that don't look like they're starting with another country code
                countryCode = '213';
                // If the number doesn't already have a country code, add the default
                if (!input.startsWith('213')) {
                    input = countryCode + input;
                }
            }

            // Extract numbers after country code to format them
            let nationalNumber = input;
            if (countryCode && input.startsWith(countryCode)) {
                nationalNumber = input.substring(countryCode.length);
            }

            let formattedNumber = '';
            
            if (input.length > 0) {
                formattedNumber = '+' + countryCode;
                
                // Format the national number part based on country code
                if (countryCode === '213' || countryCode === '33') {
                    // For Algeria and France, format as XXX-XX-XX-XX after the country code
                    if (nationalNumber.length > 0) {
                        formattedNumber += ' - ' + nationalNumber.substring(0, 3); // First 3 digits
                    }
                    if (nationalNumber.length > 3) {
                        formattedNumber += '-' + nationalNumber.substring(3, 5); // Next 2 digits
                    }
                    if (nationalNumber.length > 5) {
                        formattedNumber += '-' + nationalNumber.substring(5, 7); // Next 2 digits
                    }
                    if (nationalNumber.length > 7) {
                        formattedNumber += '-' + nationalNumber.substring(7, 9); // Final 2 digits
                    }
                } else if (countryCode === '1') {
                    // For US/Canada format as (XXX) XXX-XXXX
                    if (nationalNumber.length > 0) {
                        formattedNumber += ' (' + nationalNumber.substring(0, 3) + ') ';
                    }
                    if (nationalNumber.length > 3) {
                        formattedNumber += nationalNumber.substring(3, 6);
                    }
                    if (nationalNumber.length > 6) {
                        formattedNumber += '-' + nationalNumber.substring(6, 10);
                    }
                } else if (countryCode === '44') {
                    // For UK format as XXXX XXX XXXX
                    if (nationalNumber.length > 0) {
                        formattedNumber += ' ' + nationalNumber.substring(0, 4);
                    }
                    if (nationalNumber.length > 4) {
                        formattedNumber += ' ' + nationalNumber.substring(4, 7);
                    }
                    if (nationalNumber.length > 7) {
                        formattedNumber += ' ' + nationalNumber.substring(7, 11);
                    }
                } else {
                    // Default formatting for other country codes
                    if (nationalNumber.length > 0) {
                        formattedNumber += ' ' + nationalNumber.substring(0, 3);
                    }
                    if (nationalNumber.length > 3) {
                        formattedNumber += '-' + nationalNumber.substring(3, 5);
                    }
                    if (nationalNumber.length > 5) {
                        formattedNumber += '-' + nationalNumber.substring(5, 7);
                    }
                    if (nationalNumber.length > 7) {
                        formattedNumber += '-' + nationalNumber.substring(7, 9);
                    }
                }
            }
            
            $(this).val(formattedNumber);
        });

        // Handle form submission with AJAX
        $('form').on('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
            // Check if form is valid
            if (!this.checkValidity()) {
                $(this).addClass('was-validated');
                return;
            }
            
            // Show loading state
            const submitBtn = $('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.html('<i class="ri-loader-4-line me-2"></i>Enregistrement...').prop('disabled', true);
            
            // Collect form data
            const formData = {
                'designation': $('input[name="designation"]').val(),
                'code': $('input[name="code"]').val(),
                'telephone': $('input[name="telephone"]').val(),
                'email': $('input[name="email"]').val(),
                'site_web': $('input[name="site_web"]').val(),
                'contact_principal': $('input[name="contact_principal"]').val(),
                'adresse': $('input[name="adresse"]').val(),
                'adresse_complement': $('input[name="adresse_complement"]').val(),
                'commune': $('input[name="commune"]').val(),
                'wilaya': $('input[name="wilaya"]').val(),
                'pays': $('input[name="pays"]').val(),
                'rc': $('input[name="rc"]').val(),
                'nif': $('input[name="nif"]').val(),
                'nis': $('input[name="nis"]').val(),
                'art_impot': $('input[name="art_impot"]').val(),
                'banque': $('input[name="banque"]').val(),
                'numero_compte': $('input[name="numero_compte"]').val(),
                'code_banque': $('input[name="code_banque"]').val(),
                'observations': $('textarea[name="observations"]').val(),
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
            };
            
            // Send AJAX request
            $.ajax({
                url: "{% url 't_tresorerie:enregistrer_fournisseur' %}", // Using a standard naming convention for the URL
                type: 'POST',
                data: formData,
                success: function(response) {
                    // Success handling
                    submitBtn.html('<i class="ri-check-line me-2"></i>Enregistré!').removeClass('btn-primary').addClass('btn-success');
                    
                    // Show success notification
                    alertify.success('Le fournisseur a été enregistré avec succès!', 'success');
                    
                    // Optionally redirect to the suppliers list page after a delay
                    setTimeout(function() {
                        window.location.href = "{% url 't_tresorerie:PageFournisseur' %}";
                    }, 2000);
                },
                error: function(xhr, status, error) {
                    // Error handling
                    submitBtn.html(originalText).prop('disabled', false);
                    
                    // Show error notification
                    let errorMessage = 'Une erreur est survenue lors de l\'enregistrement du fournisseur.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr.status === 400) {
                        errorMessage = 'Les données soumises sont invalides. Veuillez vérifier les champs du formulaire.';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Erreur serveur. Veuillez réessayer plus tard.';
                    }
                    
                    alertify.error(errorMessage);
                }
            });
        });
    });
</script>
{% endblock content %}