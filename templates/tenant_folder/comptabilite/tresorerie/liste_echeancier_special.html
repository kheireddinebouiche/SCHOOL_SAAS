{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Trésorerie - Liste des échéanciers spéciaux {% endblock title %}

{% block content %}
<style>
    .echeancier-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25em 0.5em;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .detail-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .detail-card .card-header {
        background-color: rgba(0, 0, 0, 0.03);
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .info-box {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }
    
    .modal-content {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .badge-sm {
        font-size: 0.75em;
        padding: 0.25em 0.4em;
    }
    
    /* Icon centering */
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Button styles with low opacity */
    .btn-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        border: 1px solid rgba(40, 167, 69, 0.3) !important;
    }
    
    .btn-success:hover {
        background-color: rgba(40, 167, 69, 0.3) !important;
        border: 1px solid rgba(40, 167, 69, 0.5) !important;
    }
    
    .btn-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        border: 1px solid rgba(220, 53, 69, 0.3) !important;
    }
    
    .btn-danger:hover {
        background-color: rgba(220, 53, 69, 0.3) !important;
        border: 1px solid rgba(220, 53, 69, 0.5) !important;
    }
    
    .btn-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        border: 1px solid rgba(59, 125, 221, 0.3) !important;
    }
    
    .btn-primary:hover {
        background-color: rgba(59, 125, 221, 0.3) !important;
        border: 1px solid rgba(59, 125, 221, 0.5) !important;
    }
    
    .btn-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        border: 1px solid rgba(255, 193, 7, 0.3) !important;
    }
    
    .btn-warning:hover {
        background-color: rgba(255, 193, 7, 0.3) !important;
        border: 1px solid rgba(255, 193, 7, 0.5) !important;
    }
</style>
</style>
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-star-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Échéanciers spéciaux</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Échéanciers spéciaux</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="alert-content mb-4">
                <!-- Alerts will be displayed here -->
            </div>

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-list-check-2 text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalEcheanciers">0</h5>
                                    <p class="mb-0 text-muted small">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-checkbox-circle-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="approvedEcheanciers">0</h5>
                                    <p class="mb-0 text-muted small">Approuvés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-time-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="pendingEcheanciers">0</h5>
                                    <p class="mb-0 text-muted small">En attente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-info bg-opacity-10">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-info bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-calendar-line text-info fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="validatedEcheanciers">0</h5>
                                    <p class="mb-0 text-muted small">Validés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-list-check-2 text-primary fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-primary mb-1">Liste des échéanciers spéciaux</h5>
                                        <p class="text-muted small mb-0">Gestion des échéanciers personnalisés</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" id="refreshEcheanciers">
                                        <i class="ri-refresh-line me-1"></i>Actualiser
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle table-nowrap mb-0 echeancier-table" id="echeancierTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Client</th>
                                            <th>Nombre de tranches</th>
                                            <th>Validation</th>
                                            <th>Approbation</th>
                                            <th>Date de création</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="echeancierTableBody">
                                        {% if echeanciers %}
                                            {% for echeancier in echeanciers %}
                                                <tr>
                                                    <td>{{ echeancier.id }}</td>
                                                    <td>{{ echeancier.prospect.nom }} {{ echeancier.prospect.prenom }}</td>
                                                    <td>{{ echeancier.nombre_tranche }}</td>
                                                    <td>
                                                        {% if echeancier.is_validate %}
                                                            <span class="badge bg-success status-badge">Validé</span>
                                                        {% else %}
                                                            <span class="badge bg-warning status-badge">En attente</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if echeancier.is_approuved %}
                                                            <span class="badge bg-success status-badge">Approuvé</span>
                                                        {% else %}
                                                            <span class="badge bg-warning status-badge">En attente</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ echeancier.created_at }}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary view-details" data-id="{{ echeancier.id }}">
                                                            <i class="ri-eye-line me-1"></i>Détails
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="7" class="text-center">Aucun échéancier spécial trouvé</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal for Echeancier Details -->
<div class="modal fade" id="echeancierDetailsModal" tabindex="-1" aria-labelledby="echeancierDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                        <i class="ri-file-list-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="echeancierDetailsModalLabel">Détails échéancier spécial</h5>
                        <p class="text-muted small mb-0">ID: <span id="detailId"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Client and Status Info -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center bg-light bg-opacity-50 rounded-3 p-3">
                            <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                <i class="ri-user-line text-primary fs-5"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted small">Client</h6>
                                <h6 class="mb-0 fw-semibold" id="detailClient"></h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center bg-light bg-opacity-50 rounded-3 p-3">
                            <div class="avatar-sm bg-info bg-opacity-10 rounded-circle icon-center me-3">
                                <i class="ri-calendar-line text-info fs-5"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted small">Date de création</h6>
                                <h6 class="mb-0 fw-semibold" id="detailDateCreation"></h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center bg-light bg-opacity-50 rounded-3 p-3">
                            <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                <i class="ri-list-check-2 text-warning fs-5"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted small">Tranches</h6>
                                <h6 class="mb-0 fw-semibold" id="detailNombreTranches"></h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center bg-light bg-opacity-50 rounded-3 p-3">
                            <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                <i class="ri-money-dollar-circle-line text-success fs-5"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted small">Montant total</h6>
                                <h6 class="mb-0 fw-semibold" id="totalMontant">0 DA</h6>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Badges -->
                <div class="d-flex gap-2 mb-4">
                    <div class="flex-grow-1">
                        <label class="text-muted small mb-1">Validation</label>
                        <div id="detailValidation"></div>
                    </div>
                    <div class="flex-grow-1">
                        <label class="text-muted small mb-1">Approbation</label>
                        <div id="detailApprobation"></div>
                    </div>
                </div>

                <!-- Tranches Details -->
                <div class="card border-0 bg-light bg-opacity-50 rounded-3">
                    <div class="card-header bg-transparent border-0 px-3 py-2">
                        <h6 class="mb-0 text-primary fw-semibold">Détail des tranches</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle table-nowrap mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="small">#</th>
                                        <th class="small">Taux</th>
                                        <th class="small">Montant</th>
                                        <th class="small">Échéance</th>
                                    </tr>
                                </thead>
                                <tbody id="linesTableBody" class="small">
                                    <!-- Lines will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="approveEcheancierBtn">
                    <i class="ri-checkbox-circle-line me-1"></i>Accepter
                </button>
                <button type="button" class="btn btn-danger px-4 py-2" id="rejectEcheancierBtn">
                    <i class="ri-close-circle-line me-1"></i>Rejeter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Accepting Echeancier -->
<div class="modal fade" id="acceptEcheancierModal" tabindex="-1" aria-labelledby="acceptEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                        <i class="ri-checkbox-circle-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="acceptEcheancierModalLabel">Accepter l'échéancier</h5>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                        <i class="ri-checkbox-circle-line text-success fs-1"></i>
                    </div>
                    <h5 class="fw-semibold">Confirmation d'acceptation</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir accepter cet échéancier spécial ?</p>
                </div>
                <div class="bg-light bg-opacity-50 rounded-3 p-3 mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">ID Échéancier:</span>
                        <span class="fw-semibold" id="acceptEcheancierId"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Client:</span>
                        <span class="fw-semibold" id="acceptEcheancierClient"></span>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label for="acceptComment" class="form-label">Commentaire (optionnel)</label>
                    <textarea class="form-control" id="acceptComment" rows="3" placeholder="Ajoutez un commentaire sur l'acceptation..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmEcheancierAcceptBtn">
                    <i class="ri-checkbox-circle-line me-1"></i>Accepter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Rejecting Echeancier -->
<div class="modal fade" id="rejectEcheancierModal" tabindex="-1" aria-labelledby="rejectEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                        <i class="ri-close-circle-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="rejectEcheancierModalLabel">Rejeter l'échéancier</h5>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                        <i class="ri-close-circle-line text-danger fs-1"></i>
                    </div>
                    <h5 class="fw-semibold">Confirmation de rejet</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir rejeter cet échéancier spécial ?</p>
                </div>
                <div class="bg-light bg-opacity-50 rounded-3 p-3 mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">ID Échéancier:</span>
                        <span class="fw-semibold" id="rejectEcheancierId"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Client:</span>
                        <span class="fw-semibold" id="rejectEcheancierClient"></span>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label for="rejectComment" class="form-label">Motif du rejet <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="rejectComment" rows="3" placeholder="Veuillez indiquer le motif du rejet..." required></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger px-4 py-2" id="confirmRejectBtn">
                    <i class="ri-close-circle-line me-1"></i>Rejeter
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){

        // Function to load echeanciers
        function loadEcheanciers() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiListEcheancierSpecial' %}",
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'success') {
                        var html = '';
                        
                        if (response.echeanciers.length > 0) {
                            $.each(response.echeanciers, function(index, echeancier) {
                                var validationBadge = echeancier.is_validate ? 
                                    '<span class="badge bg-success status-badge">Validé</span>' : 
                                    '<span class="badge bg-warning status-badge">En attente</span>';
                                    
                                var approbationBadge = echeancier.is_approuved ? 
                                    '<span class="badge bg-success status-badge">Approuvé</span>' : 
                                    '<span class="badge bg-warning status-badge">En attente</span>';
                                    
                                html += '<tr>';
                                html += '<td>' + echeancier.id + '</td>';
                                html += '<td>' + echeancier.prospect.nom + ' ' + echeancier.prospect.prenom + '</td>';
                                html += '<td>' + echeancier.nombre_tranche + '</td>';
                                html += '<td>' + validationBadge + '</td>';
                                html += '<td>' + approbationBadge + '</td>';
                                html += '<td>' + echeancier.created_at + '</td>';
                                html += '<td>';
                                html += '<button class="btn btn-sm btn-primary view-details" data-id="' + echeancier.id + '">';
                                html += '<i class="ri-eye-line me-1"></i>Détails';
                                html += '</button>';
                                html += '</td>';
                                html += '</tr>';
                            });

                            
                        } else {
                            html += '<tr><td colspan="7" class="text-center">Aucun échéancier spécial trouvé</td></tr>';
                        }
                        
                        // Update statistics
                        if (response.statistics) {
                            $('#totalEcheanciers').text(response.statistics.total);
                            $('#approvedEcheanciers').text(response.statistics.approved);
                            $('#pendingEcheanciers').text(response.statistics.pending);
                            $('#validatedEcheanciers').text(response.statistics.validated);
                        }
                        
                        $('#echeancierTableBody').html(html);
                    } else {
                        $('#echeancierTableBody').html('<tr><td colspan="7" class="text-center text-danger">Erreur lors du chargement des données</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erreur lors du chargement des échéanciers:", error);
                    $('#echeancierTableBody').html('<tr><td colspan="7" class="text-center text-danger">Erreur de connexion</td></tr>');
                }
            });
        }

        loadEcheanciers();
        
        // Refresh button click event
        $(document).on('click', '#refreshEcheanciers', function() {
            // Show loading spinner
            $('#echeancierTableBody').html('<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div></td></tr>');
            loadEcheanciers();
        });
        
        // View details button click event
        $(document).on('click', '.view-details', function() {
            var echeancierId = $(this).data('id');
            
            // Find the echeancier in our data
            $.ajax({
                url: "{% url 't_tresorerie:ApiListEcheancierSpecial' %}",
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'success') {
                        var echeancier = response.echeanciers.find(e => e.id == echeancierId);
                        if (echeancier) {
                            // Fill modal with echeancier details
                            $('#detailId').text(echeancier.id);
                            $('#detailClient').text(echeancier.prospect.nom + ' ' + echeancier.prospect.prenom);
                            $('#detailNombreTranches').text(echeancier.nombre_tranche);
                            
                            var validationText = echeancier.is_validate ? 
                                '<span class="badge bg-success">Validé</span>' : 
                                '<span class="badge bg-warning">En attente</span>';
                            $('#detailValidation').html(validationText);
                            
                            var approbationText = echeancier.is_approuved ? 
                                '<span class="badge bg-success">Approuvé</span>' : 
                                '<span class="badge bg-warning">En attente</span>';
                            $('#detailApprobation').html(approbationText);
                            
                            $('#detailDateCreation').text(echeancier.created_at);
                            
                            // Calculate total amount
                            var totalMontant = 0;
                            var linesHtml = '';
                            $.each(echeancier.lines, function(index, line) {
                                totalMontant += parseFloat(line.montant_tranche);
                                linesHtml += '<tr>';
                                linesHtml += '<td>' + (index + 1) + '</td>';
                                linesHtml += '<td>' + (line.taux || 'N/A') + '%</td>';
                                linesHtml += '<td>' + parseFloat(line.montant_tranche).toFixed(2) + ' DA</td>';
                                linesHtml += '<td>' + (line.date_echeancier || 'N/A') + '</td>';
                                linesHtml += '</tr>';
                            });
                            
                            $('#totalMontant').text(totalMontant.toFixed(2) + ' DA');
                            $('#linesTableBody').html(linesHtml);
                            
                           
                             if(echeancier.is_approuved){
                                document.getElementById('approveEcheancierBtn').disabled = true;
                                document.getElementById('rejectEcheancierBtn').disabled = true;
                            }

                            // Store current echeancier ID for approval/rejection
                            $('#approveEcheancierBtn').data('id', echeancier.id);
                            $('#rejectEcheancierBtn').data('id', echeancier.id);
                            
                            // Show modal
                            $('#echeancierDetailsModal').modal('show');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erreur lors du chargement des détails:", error);
                    alert("Erreur lors du chargement des détails de l'échéancier");
                }
            });
        });
        
        // Approve echeancier button click event
        $(document).on('click', '#approveEcheancierBtn', function() {
            var echeancierId = $(this).data('id');
            // Show accept modal
            $('#confirmEcheancierAcceptBtn').data('id', echeancierId);
            $('#acceptEcheancierModal').modal('show');
        });
        
        // Reject echeancier button click event
        $(document).on('click', '#rejectEcheancierBtn', function() {
            var echeancierId = $(this).data('id');
            $('#rejectEcheancierModal').modal('show');
        });

        $(document).on('click', "#confirmEcheancierAcceptBtn", function(){
            var echeancierId = $(this).data('id');
            $.ajax({
                url : "{% url 't_tresorerie:ApiApproveEcheancierSpecial' %}",
                dataType: "JSON",
                type : "GET",
                data : {
                    'echeancierId' : echeancierId,
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("Echéancier validé avec succès");
                        loadEcheanciers();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete.");
                    }
                }
            })
        });
    });
</script>



{% endblock content %}