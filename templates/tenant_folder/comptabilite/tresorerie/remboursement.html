{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité/Trésorerie - Demandes de Rembourssement {% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Add search box styling */
    .search-box {
        position: relative;
    }
    
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }
    
    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }
    
    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }
    
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item i {
        width: 1.2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    /* Fix dropdown z-index issue */
    .table-responsive {
        overflow-x: visible;
    }
    
    .table td.text-end {
        position: relative;
        overflow: visible;
    }
    
    .table .dropdown-menu {
        z-index: 1050;
        position: absolute;
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-refund-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Demandes de Rembourssement</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Comptabilité/Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Demandes de Rembourssement</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-list-check-2 text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-time-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="pendingRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">En attente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-checkbox-circle-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="approvedRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">Acceptés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-danger bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-danger bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-close-circle-line text-danger fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="rejectedRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">Rejetés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-filter text-info me-2"></i>
                                    <h5 class="card-title mb-0 text-info">Filtres</h5>
                                </div>

                                <div class="d-flex align-items-center gap-3">
                                    <div class="search-box position-relative">
                                        <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                        <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                    </div>
                                    
                                    <div class="d-flex align-items-center">
                                        <label for="dateFrom" class="me-2 mb-0">Du:</label>
                                        <input type="date" id="dateFrom" class="form-control form-control-sm rounded-pill" style="width: 150px;">
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label for="dateTo" class="me-2 mb-0">Au:</label>
                                        <input type="date" id="dateTo" class="form-control form-control-sm rounded-pill" style="width: 150px;">
                                    </div>
                                    <div>
                                        <button id="filterByDate" class="btn btn-primary btn-sm rounded-pill">
                                            <i class="ri-filter-line me-1"></i>Filtrer
                                        </button>
                                        <button id="clearDateFilter" class="btn btn-light btn-sm rounded-pill">
                                            <i class="ri-close-line me-1"></i>Effacer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                            
                        <div class="card-body p-3">
                            <div class="table-responsive" style="overflow-x: visible;">
                                <table id="example" class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Client</th>
                                            <th class="border-0">Motif</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0">Crée le</th>
                                            <th class="border-0 rounded-end text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listItem"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>
<!-- Details Modal -->
<div class="modal fade detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-refund-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="detailsModalLabel">
                            Détails de la demande de remboursement
                        </h5>
                        <p class="text-muted small mb-0">Informations complètes sur la demande</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Informations principales -->
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="card-header border-0 bg-white pt-3">
                        <div class="d-flex align-items-center">
                            <span class="icon-circle bg-primary bg-opacity-10 rounded me-2">
                                <i class="ri-user-line text-primary"></i>
                            </span>
                            <h6 class="card-title mb-0 text-primary">Informations principales</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="detail_client">Client</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-user-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="detail_client" name="client" readonly>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="detail_date">Date de création</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-calendar-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="detail_date" name="date" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations remboursement -->
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="card-header border-0 bg-white pt-3">
                        <div class="d-flex align-items-center">
                            <span class="icon-circle bg-success bg-opacity-10 rounded me-2">
                                <i class="ri-refund-line text-success"></i>
                            </span>
                            <h6 class="card-title mb-0 text-success">Informations remboursement</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="detail_motif">Motif</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="detail_motif" name="motif" readonly>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="detail_statut">Statut</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-toggle-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="detail_statut" name="statut" readonly>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label fw-medium" for="detail_montant">Montant</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="ri-money-dollar-circle-line text-muted"></i></span>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="detail_montant" name="montant" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="card-header border-0 bg-white pt-3">
                        <div class="d-flex align-items-center">
                            <span class="icon-circle bg-warning bg-opacity-10 rounded me-2">
                                <i class="ri-chat-1-line text-warning"></i>
                            </span>
                            <h6 class="card-title mb-0 text-warning">Description</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control border-0 bg-light" id="detail_description" name="description" rows="3" readonly></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
                <button type="button" class="btn btn-primary px-4 py-2" id="traiterBtn">
                    <i class="ri-check-line me-2"></i>Traiter
                </button>
            </div>
        </div>
    </div>
</div><!-- /.modal -->

<!-- Traitement Remboursement Modal -->
<div class="modal fade traitementModal" tabindex="-1" role="dialog" aria-labelledby="traitementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-refund-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="traitementModalLabel">
                            Traitement de remboursement
                        </h5>
                        <p class="text-muted small mb-0">Saisir les informations de traitement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="traitementForm">
                    <div class="mb-3">
                        <label for="decisionTraitement" class="form-label fw-medium">Décision</label>
                        <select class="form-select border-0 bg-light py-2" id="decisionTraitement" name="decisionTraitement">
                            <option value="">Sélectionner une décision</option>
                            <option value="accepter">Accepter</option>
                            <option value="rejeter">Rejeter</option>
                        </select>
                    </div>
                    <div id="additionalFields">
                        <!-- Additional fields will be loaded here based on selection -->
                    </div>
                    <div class="mb-3" id="motifRejetGroup" style="display: none;">
                        <label for="motifRejet" class="form-label fw-medium">Motif de rejet</label>
                        <textarea class="form-control border-0 bg-light" id="motifRejet" name="motifRejet" placeholder="Saisir le motif de rejet" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="validerTraitementBtn">
                    <i class="ri-check-line me-2"></i>Valider
                </button>
            </div>
        </div>
    </div>
</div><!-- /.modal -->

<!-- Delete Confirmation Modal -->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <lord-icon src="https://cdn.lordicon.com/hwjcdycb.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:120px;height:120px">
                </lord-icon>
                <div class="mt-4">
                    <h4 class="mb-3">Vous étes sur le point de supprimer la demande de remboursement</h4>
                    <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                    <div class="hstack gap-2 justify-content-center">
                        
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    $(document).ready(function(){
        // Store all refund data for filtering
        var allRefundData = [];
        var currentSearchTerm = '';
    

        function loadItems(){
            $.ajax({
                url :"{% url 't_tresorerie:ApiLoadRefundData' %}",
                dataType : 'JSON',
                type : 'GET',
                success : function(data){
                    // Store all data for filtering
                    allRefundData = data;
                    
                    var html = "";
                    if (data.length > 0){
                        $.each(data, function(index, p){
                            var statusClass = '';
                            var statusText = '';
                            switch(p.etat) {
                                case 'enc':
                                    statusClass = 'badge bg-warning';
                                    statusText = 'En attente';
                                    break;
                                case 'accepte':
                                    statusClass = 'badge bg-success';
                                    statusText = 'Accepté';
                                    break;
                                case 'rejete':
                                    statusClass = 'badge bg-danger';
                                    statusText = 'Rejeté';
                                    break;
                                default:
                                    statusClass = 'badge bg-secondary';
                                    statusText = p.etat_label;
                            }
                            
                            // Format the date
                            var date = new Date(p.created_at);
                            var formattedDate = date.toLocaleDateString('fr-FR', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            
                           html +="<tr>";
                           html +="<td><a href='javascript:void(0);' class='text-body'><div class='d-flex align-items-center'><div class='flex-grow-1'>" + (p.client__nom || '') + " " + (p.client__prenom || '') + "</div></div></a></td>";
                           html +="<td><div class='fw-medium'>" + (p.motif_rembourssement || 'N/A') + "</div></td>";
                           html +="<td><span class='"+statusClass+"'>"+statusText+"</span></td>";
                           html +="<td>" + formattedDate + "</td>";
                           html +="<td class='text-end'>";
                           html +="    <div class='dropdown d-inline-block'>";
                           html +="        <button class='btn btn-soft-info btn-sm dropdown shadow-none' type='button' data-bs-toggle='dropdown' aria-expanded='false'>";
                           html +="            <i class='ri-more-2-fill'></i>";
                           html +="        </button>";
                           html +="        <ul class='dropdown-menu dropdown-menu-end border-0 shadow-sm'>";
                           html +="            <li><button id='detailsBtn' data-client='" + p.client__id + "' data-id='" + p.id + "' class='dropdown-item details-item-btn d-flex align-items-center'><i class='ri-eye-line text-info me-2'></i>Détails</button></li>";
                           html +="            <li><button id='deleteConfirmation' data-id='" + p.id + "' class='dropdown-item remove-item-btn d-flex align-items-center text-danger'><i class='ri-delete-bin-line me-2'></i>Supprimer</button></li>";
                           html +="        </ul>";
                           html +="    </div>";
                           html +="</td>";
                           html +="</tr>";
                        });
                    } else {
                        html = "<tr><td colspan='5' class='text-center text-muted'>Aucune demande de remboursement trouvée</td></tr>";
                    }
                    
                    $('#listItem').html(html);
                    
                    // Update statistics
                    updateStatistics(data);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading refund data:', error);
                    var html = "<tr><td colspan='5' class='text-center text-danger'>Erreur lors du chargement des données.</td></tr>";
                    $('#listItem').html(html);
                }
            });
        }

        function updateStatistics(data) {
            var total = data.length;
            var pending = 0;
            var approved = 0;
            var rejected = 0;
            
            $.each(data, function(index, p) {
                if (p.etat == 'en_attente') {
                    pending++;
                } else if (p.etat == 'accepte') {
                    approved++;
                } else if (p.etat == 'rejete') {
                    rejected++;
                }
            });
            
            // Update statistics
            $('#totalRemboursements').text(total);
            $('#pendingRemboursements').text(pending);
            $('#approvedRemboursements').text(approved);
            $('#rejectedRemboursements').text(rejected);
        }

        // Search functionality
        $('#table-filter').on('keyup', function() {
            console.log('Search term:', this.value); // Debug log
            currentSearchTerm = this.value.toLowerCase();
            applyFilters();
        }).on('focus', function() {
            console.log('Search input focused'); // Debug log
        }).on('click', function() {
            console.log('Search input clicked'); // Debug log
        });
        
        // Enhanced filtering that combines search and date filters
        function applyFilters() {
            var dateFrom = $('#dateFrom').val();
            var dateTo = $('#dateTo').val();
            
            var filteredData = allRefundData;
            
            // Apply search filter
            if (currentSearchTerm) {
                filteredData = filteredData.filter(function(refund) {
                    // Search in client name, motif, and status
                    return (
                        (refund.client__nom && refund.client__nom.toLowerCase().includes(currentSearchTerm)) ||
                        (refund.client__prenom && refund.client__prenom.toLowerCase().includes(currentSearchTerm)) ||
                        (refund.motif_rembourssement && refund.motif_rembourssement.toLowerCase().includes(currentSearchTerm)) ||
                        (refund.etat && refund.etat.toLowerCase().includes(currentSearchTerm))
                    );
                });
            }
            
            // Apply date filtering if dates are provided
            if (dateFrom || dateTo) {
                filteredData = filteredData.filter(function(refund) {
                    var refundDate = new Date(refund.created_at);
                    
                    if (dateFrom && dateTo) {
                        var fromDate = new Date(dateFrom);
                        var toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999); // Include the entire end date
                        return refundDate >= fromDate && refundDate <= toDate;
                    } else if (dateFrom) {
                        var fromDate = new Date(dateFrom);
                        return refundDate >= fromDate;
                    } else if (dateTo) {
                        var toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999); // Include the entire end date
                        return refundDate <= toDate;
                    }
                    
                    return true;
                });
            }
            
            // Add filtered data to display
            var html = "";
            if (filteredData.length > 0){
                $.each(filteredData, function(index, p){
                    // Format the status
                    var statusClass = '';
                    var statusText = '';
                    switch(p.etat) {
                        case 'enc':
                            statusClass = 'badge bg-warning';
                            statusText = 'En attente';
                            break;
                        case 'accepte':
                            statusClass = 'badge bg-success';
                            statusText = 'Accepté';
                            break;
                        case 'rejete':
                            statusClass = 'badge bg-danger';
                            statusText = 'Rejeté';
                            break;
                        default:
                            statusClass = 'badge bg-secondary';
                            statusText = p.etat_label;
                    }
                    
                    // Format the date
                    var date = new Date(p.created_at);
                    var formattedDate = date.toLocaleDateString('fr-FR', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                   html +="<tr>";
                   html +="<td><a href='javascript:void(0);' class='text-body'><div class='d-flex align-items-center'><div class='flex-grow-1'>" + (p.client__nom || '') + " " + (p.client__prenom || '') + "</div></div></a></td>";
                   html +="<td><div class='fw-medium'>" + (p.motif_rembourssement || 'N/A') + "</div></td>";
                   html +="<td><span class='"+statusClass+"'>"+statusText+"</span></td>";
                   html +="<td>" + formattedDate + "</td>";
                   html +="<td class='text-end'>";
                   html +="    <div class='dropdown d-inline-block'>";
                   html +="        <button class='btn btn-soft-info btn-sm dropdown shadow-none' type='button' data-bs-toggle='dropdown' aria-expanded='false'>";
                   html +="            <i class='ri-more-2-fill'></i>";
                   html +="        </button>";
                   html +="        <ul class='dropdown-menu dropdown-menu-end border-0 shadow-sm'>";
                   html +="            <li><button id='detailsBtn'  data-client='" + p.client__id + "' data-id='" + p.id + "' class='dropdown-item details-item-btn d-flex align-items-center'><i class='ri-eye-line text-info me-2'></i>Détails</button></li>";
                   html +="            <li><button id='deleteConfirmation' data-id='" + p.id + "' class='dropdown-item remove-item-btn d-flex align-items-center text-danger'><i class='ri-delete-bin-line me-2'></i>Supprimer</button></li>";
                   html +="        </ul>";
                   html +="    </div>";
                   html +="</td>";
                   html +="</tr>";
                });
            } else {
                html = "<tr><td colspan='5' class='text-center text-muted'>Aucune demande de remboursement trouvée</td></tr>";
            }
            
            $('#listItem').html(html);
            
            // Update statistics based on filtered data
            updateStatistics(filteredData);
        }
        
        // Date filtering functionality
        function filterByDateRange() {
            applyFilters();
        }

        // Load the initial data and statistics
        loadItems();
        
        // Refresh data on button click
        $(document).on('click', '#refreshRemboursements', function(){
            loadItems();
            // Clear date filters and search
            $('#dateFrom').val('');
            $('#dateTo').val('');
            $('#table-filter').val('');
            currentSearchTerm = '';
        });

        // Date filter button
        $(document).on('click', '#filterByDate', function(){
            filterByDateRange();
        });
        
        // Clear date filter button
        $(document).on('click', '#clearDateFilter', function(){
            $('#dateFrom').val('');
            $('#dateTo').val('');
            applyFilters();
        });
        
        // Also filter when pressing Enter in date fields
        $(document).on('keypress', '#dateFrom, #dateTo', function(e){
            if (e.which === 13) { // Enter key
                filterByDateRange();
            }
        });

        $(document).on('click', '#deleteConfirmation', function(){
            var id_demande = $(this).data('id');
            var row = '<button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>'+
                   '<button id="confirmDeleteBtn" data-id="' + id_demande + '" class="btn btn-danger">Confirmer</button>';

            $('.hstack').html(row);

            $('.deleteModal').modal('show');
        });
        
        // Handle confirmation of deletion
        $(document).on('click', '#confirmDeleteBtn', function(){
            var id = $(this).data('id');
            
            // You would typically call an API endpoint to delete the refund request
            // Since ApiSetRembourssement is for setting refund status, I'll use a generic delete approach
            // This would require an actual backend endpoint for deletion
            alertify.confirm("Confirmation", "Êtes-vous sûr de vouloir supprimer cette demande de remboursement ?", 
                function(){
                    // In a real implementation, you would call an API endpoint to delete the refund request
                    // For now, just reload the data
                    loadItems(); // This would be replaced with actual API call
                    $('.deleteModal').modal('hide');
                    alertify.success("Demande supprimée avec succès");
                },
                function(){
                    // Cancel
                });
        });
        
        // Handle details button click
        $(document).on('click', '#detailsBtn', function(){
            var id_demande = $(this).data('id');
            $('#traiterBtn').data('id', id_demande);
            var client = $(this).data('client');
            console.log('Client ID:', client); // Debug log
            $('#traiterBtn').data('client', $(this).data('client'));
            
            loadRefundDetails(id_demande);
        });
        
        function loadRefundDetails(id_demande) {
           
            $.ajax({
                url : "{% url 't_tresorerie:ApiLoadRefundDetails' %}",
                dataType :"JSON",
                data : {
                    'id': id_demande,
                },
                type : 'GET',
                success : function(data){
                   

                    $('#detail_client').val(data.client_nom + ' ' + data.client_prenom);

                    $('#detail_description').val(data.description || 'N/A');
                    $('#detail_date').val(data.date_demande);
                    $('#detail_motif').val(data.motif_rembourssement);
                    $('#detail_statut').val(data.etat);
                    $('#detail_montant').val(data.paiement_total);
                    $('.detailsModal').modal('show');

                    $('#traiterBtn').data('montant_paye', data.paiement_total);
                }
            });
        }
        
        
        // Handle traitement button click
        $(document).on('click', '#traiterBtn', function(){
            var id_demande = $(this).data('id');
            var client = $(this).data('client');
            $('#validerTraitementBtn').data('client', client);
            $('#validerTraitementBtn').data('id', id_demande);
            var montant_paye = $(this).data('montant_paye');
           
            $('#decisionTraitement').data('montant_paye', montant_paye);

            $('.traitementModal').modal('show');
        });
        
        
        // Handle decision change
        $(document).on('change', '#decisionTraitement', function(){
            var decision = $(this).val();
            var additionalFields = $('#additionalFields');
            var montant_paye = $(this).data('montant_paye');
            

            // Clear any existing additional fields
            additionalFields.empty();
            
            if (decision === 'accepter') {
                additionalFields.html(`
                    <div class="mb-3">
                        <label for="montantPaye" class="form-label fw-medium">Montant déjà payé (DA)</label>
                        <input type="number" class="form-control border-0 bg-light py-2" id="montantPaye" name="montantPaye" placeholder="Saisir le montant déjà payé">
                    </div>
                    <div class="mb-3">
                        <label for="montantRembourser" class="form-label fw-medium">Montant à rembourser (DA)</label>
                        <input type="number" class="form-control border-0 bg-light py-2" id="montantRembourser" name="montantRembourser" placeholder="Saisir le montant à rembourser">
                    </div>
                    <div class="mb-3">
                        <label for="dateRemboursement" class="form-label fw-medium">Date de remboursement</label>
                        <input type="date" class="form-control border-0 bg-light py-2" id="dateRemboursement" name="dateRemboursement">
                    </div>
                    <div class="mb-3">
                        <label for="modePaiement" class="form-label fw-medium">Mode de paiement</label>
                        <select class="form-select border-0 bg-light py-2" id="modePaiement" name="modePaiement">
                            <option value="">Sélectionner un mode de paiement</option>
                            <option value="espece">Espèce</option>
                            <option value="cheque">Chèque</option>
                            <option value="virement">Virement bancaire</option>
                            <option value="carte_bancaire">Carte bancaire</option>
                        </select>
                    </div>
                `);

                $('#montantPaye').val(montant_paye);
                
                // Hide motif de rejet field
                $('#motifRejetGroup').hide();
            } else if (decision === 'rejeter') {
                // Show motif de rejet field only
                $('#motifRejetGroup').show();
            } else {
                
                // When no decision is selected, hide everything except the decision
                $('#motifRejetGroup').hide();
            }
        });


        function RemboursementAccepter(montantRembourser ,dateRemboursement,modePaiement,client){
            $.ajax({
                url : "{% url 't_tresorerie:ApiAccepteRembourssement' %}",
                dataType :"JSON",
                data : {
                    'montantRembourser': montantRembourser,
                    'dateRemboursement': dateRemboursement,
                    'modePaiement': modePaiement,
                    'client': client,
                },
                type : 'GET',
                success : function(response){
                    if(response.status === 'success'){
                        // Close the modal
                        $('.traitementModal').modal('hide');
                        // Refresh the data
                        alertify.success("Remboursement accepté avec succès");
                        loadItems();
                    }else{
                        alertify.error("Erreur lors du traitement du remboursement");
                        return;
                    }
                    
                }
            })
        }

        function RemboursementRejeter(motifRejet){
            $.ajax({
                url : "{% url 't_tresorerie:ApiRejectRembourssement' %}",
            })
        }
        
        // Handle validation of traitement
        $(document).on('click', '#validerTraitementBtn', function(){
            var refundId = $('.traitementModal').data('refund-id');
            var decision = $('#decisionTraitement').val();
            var client = $(this).data('client');

            // Validate decision
            if (!decision) {
                alertify.error("Veuillez sélectionner une décision");
                return;
            }
            
            if (decision === 'accepter') {
                var montantPaye = $('#montantPaye').val();
                var montantRembourser = $('#montantRembourser').val();
                var dateRemboursement = $('#dateRemboursement').val();
                var modePaiement = $('#modePaiement').val();
                
                               
                RemboursementAccepter(montantRembourser ,dateRemboursement,modePaiement,client);

            } else if (decision === 'rejeter') {
                var motifRejet = $('#motifRejet').val();
                
                // Validation for rejected refunds
                if (!motifRejet) {
                    alertify.error("Veuillez saisir le motif de rejet");
                    return;
                }
                
                // In a real application, you would send this data to your server for rejection
                alertify.success("Remboursement rejeté avec succès");
            }
            
            // Close the traitement modal and refresh the data
            $('.traitementModal').modal('hide');
            loadItems();
        });
    });
 
</script>
{% endblock content %}