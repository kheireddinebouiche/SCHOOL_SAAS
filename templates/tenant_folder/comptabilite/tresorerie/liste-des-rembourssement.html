{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Trésorerie - Liste des Remboursements{% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Add search box styling */
    .search-box {
        position: relative;
    }
    
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }
    
    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }
    
    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }
    
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item i {
        width: 1.2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    /* Fix dropdown z-index issue */
    .table-responsive {
        overflow-x: visible;
    }
    
    .table td.text-end {
        position: relative;
        overflow: visible;
    }
    
    .table .dropdown-menu {
        z-index: 1050;
        position: absolute;
    }
    
    .payment-status-badge {
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .payment-status-badge.paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .payment-status-badge.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .payment-status-badge.overdue {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    /* Style pour le curseur au survol des lignes de la table */
    #remboursementTableBody tr {
        cursor: pointer;
    }
    
    /* Style pour le badge d'annulation */
    .status-cancelled {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-refund-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Liste des Remboursements</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Finance</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Liste des Remboursements</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-user-line text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalCancelledProspects">0</h5>
                                    <p class="mb-0 text-muted small">Prospects annulés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-danger bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-danger bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-refund-line text-danger fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">Remboursements totaux</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-money-dollar-circle-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalMontantRembourse">0</h5>
                                    <p class="mb-0 text-muted small">Montant total remboursé</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-money-euro-circle-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalMontantRestant">0</h5>
                                    <p class="mb-0 text-muted small">Montant restant</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and search bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-filter text-info me-2"></i>
                                    <h5 class="card-title mb-0 text-info">Filtres</h5>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="search-box position-relative">
                                        <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                        <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                    </div>
                                    <select id="promoFilter" class="form-select rounded-pill" style="width: 200px;">
                                        <option value="">Toutes les promotions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table of cancelled prospects with remboursements -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-body p-3">
                            <div class="table-responsive" style="overflow-x: visible;">
                                <table id="remboursementTable" class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Nom & Prénom</th>
                                            <th class="border-0">Email</th>
                                            <th class="border-0">Téléphone</th>
                                            <th class="border-0">Promotion</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0">Montant à rembourser</th>
                                            <th class="border-0">Date d'annulation</th>
                                            <th class="border-0">Date de remboursement</th>
                                            <th class="border-0">Méthode de remboursement</th>
                                            <th class="border-0 rounded-end text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="remboursementTableBody">
                                        <!-- Data will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav class="mt-3 d-flex justify-content-center" aria-label="Navigation de pagination">
                                <ul class="pagination" id="pagination-container">
                                    <!-- Les boutons de pagination seront générés ici dynamiquement -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal pour afficher les détails de remboursement -->
<div class="modal fade" id="detailsRemboursementModal" tabindex="-1" aria-labelledby="detailsRemboursementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-3 shadow-lg border-0">
            <div class="modal-header bg-primary bg-opacity-10 px-4 py-3 border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-2 p-2 me-3">
                        <i class="ri-file-info-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-0" id="detailsRemboursementModalLabel">Détails du Remboursement</h5>
                        <p class="text-muted small mb-0 fs-6"><span id="prospectNameInModal"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Nom & Prénom</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailNomPrenom">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Email</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailEmail">-</div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Téléphone</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailTelephone">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Promotion</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailPromotion">-</div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Statut</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailStatut">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Date d'annulation</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailDateAnnulation">-</div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Montant total payé</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailMontantPaye">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Montant à rembourser</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailMontantRembourse">-</div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Date de remboursement</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailDateRemboursement">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Méthode de remboursement</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailMethodeRemboursement">-</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label fw-medium">Motif d'annulation</label>
                        <div class="border rounded-3 p-2 bg-light" id="detailMotifAnnulation">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        // Load initial data
        loadRemboursementsData();
        
        // Search functionality
        $('#table-filter').on('keyup', function() {
            applyFilters();
        });
        
        // Filter by promo
        $('#promoFilter').on('change', function() {
            applyFilters();
        });
        
        // Store all data for filtering
        var allRemboursementData = [];
        var currentSearchTerm = '';
        var currentPromoFilter = '';
        var currentPage = 1;
        var itemsPerPage = 10;
        
        // Load remboursement data from API
        function loadRemboursementsData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadRemboursements' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(response) {
                    // Store all data for filtering - transform the API response to match our expected structure
                    allRemboursementData = [];
                    
                    // Response contains an array of objects with 'client' and 'remboursements' properties
                    $.each(response, function(index, item) {
                        // Create a flat structure for each client with their remboursement info
                        var client = item.client;
                        var remboursements = item.remboursements;
                        
                        // If there are remboursements, add each as a separate row
                        if (remboursements.length > 0) {
                            $.each(remboursements, function(rIndex, remboursement) {
                                allRemboursementData.push({
                                    id: client.id,
                                    nom: client.nom,
                                    prenom: client.prenom,
                                    montant_rembourse: remboursement.allowed_amount,
                                    remboursement_id: remboursement.id
                                });
                            });
                        } else {
                            // If there are no remboursements, still add the client
                            allRemboursementData.push({
                                id: client.id,
                                nom: client.nom,
                                prenom: client.prenom,
                                montant_rembourse: 0,
                                remboursement_id: null
                            });
                        }
                    });
                    
                    // Update statistics
                    updateStatistics(allRemboursementData);
                    
                    // Render data
                    renderRemboursementTable(allRemboursementData);
                    
                    // Populate the promo filter dropdown
                    populatePromoFilter();
                    
                    // Update pagination
                    updatePagination(allRemboursementData.length);
                },
                error: function() {
                    console.error("Erreur lors du chargement des données des remboursements");
                    var html = '<tr><td colspan="10" class="text-center text-danger">Erreur lors du chargement des données des remboursements.</td></tr>';
                    $('#remboursementTableBody').html(html);
                }
            });
        }
        
        // Update statistics
        function updateStatistics(data) {
            var totalProspects = data.length;
            var totalRemboursements = 0;
            var totalMontantRembourse = 0;
            var totalMontantRestant = 0;
            
            $.each(data, function(index, item) {
                if(item.remboursement_id) {
                    totalRemboursements++;
                }
                totalMontantRembourse += parseFloat(item.montant_rembourse || 0);
                // Note: Since the API doesn't provide montant_restant, we'll use the same value as montant_rembourse for now
                totalMontantRestant += parseFloat(item.montant_rembourse || 0);
            });
            
            $('#totalCancelledProspects').text(totalProspects);
            $('#totalRemboursements').text(totalRemboursements);
            $('#totalMontantRembourse').text(totalMontantRembourse.toLocaleString('fr-FR') + ' DA');
            $('#totalMontantRestant').text(totalMontantRestant.toLocaleString('fr-FR') + ' DA');
        }
        
        // Render remboursement table
        function renderRemboursementTable(data) {
            var startIndex = (currentPage - 1) * itemsPerPage;
            var endIndex = startIndex + itemsPerPage;
            var pageData = data.slice(startIndex, endIndex);
            
            var html = '';
            if (pageData.length > 0) {
                $.each(pageData, function(index, item) {
                    var formattedMontant = (item.montant_rembourse || 0).toLocaleString('fr-FR') + ' DA';
                    
                    html += '<tr class="remboursement-row" data-remboursement-id="' + item.id + '" data-prospect-name="' + item.nom + ' ' + item.prenom + '">';
                    html += '<td><strong>' + item.nom + ' ' + item.prenom + '</strong></td>';
                    html += '<td>-</td>'; // email not available in current API
                    html += '<td>-</td>'; // telephone not available in current API (with original API)
                    html += '<td>-</td>'; // fiche de voeux not available in current API
                    html += '<td><span class="status-cancelled">Annulé</span></td>';
                    html += '<td><strong class="text-danger">' + formattedMontant + '</strong></td>';
                    html += '<td>-</td>'; // date update not available in current API
                    html += '<td>-</td>'; // date traitement not available in current API
                    html += '<td>-</td>'; // mode remboursement not available in current API
                    html += '<td class="text-center">';
                    html += '<div class="dropdown d-inline-block">';
                    html += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation();">';
                    html += '<i class="ri-more-fill align-middle"></i>';
                    html += '</button>';
                    html += '<ul class="dropdown-menu dropdown-menu-end">';
                    html += '<li><button class="btn-details-remboursement dropdown-item" data-remboursement-id="' + item.id + '">';
                    html += '<i class="ri-eye-fill align-bottom me-2 text-muted"></i> Détails</button></li>';
                    html += '<li><hr class="dropdown-divider"></li>';
                    html += '<li><button class="btn-process-remboursement dropdown-item" onclick="event.stopPropagation();">';
                    html += '<i class="ri-refund-2-line align-bottom me-2 text-muted"></i> Traiter</button></li>';
                    html += '</ul>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                });
            } else {
                html = '<tr><td colspan="10" class="text-center text-muted">Aucun remboursement disponible</td></tr>';
            }
            
            $('#remboursementTableBody').html(html);
            
            // Add click events for the actions
            $(document).on('click', '.btn-details-remboursement', function(e) {
                e.stopPropagation();
                var remboursementId = $(this).data('remboursement-id');
                var remboursementRow = $(this).closest('.remboursement-row');
                var prospectName = remboursementRow.data('prospect-name');
                
                // Update modal title
                $('#prospectNameInModal').text(prospectName);
                
                // Load details
                loadRemboursementDetails(remboursementId);
            });
            
            // Add click event for row to show details
            $('.remboursement-row').on('click', function() {
                var remboursementId = $(this).data('remboursement-id');
                var prospectName = $(this).data('prospect-name');
                
                // Update modal title
                $('#prospectNameInModal').text(prospectName);
                
                // Load details
                loadRemboursementDetails(remboursementId);
                
                // Show modal
                $('#detailsRemboursementModal').modal('show');
            });
        }
        
        // Function to load remboursement details
        function loadRemboursementDetails(remboursementId) {
            // Find the client in the main data list
            var remboursement = allRemboursementData.find(item => item.id == remboursementId);
            
            if (remboursement) {
                // For now, set the available data
                $('#detailNomPrenom').text(remboursement.nom + ' ' + remboursement.prenom);
                $('#detailEmail').text('-'); // Email not available in current API
                $('#detailTelephone').text('-'); // Telephone not available in current API (with original structure)
                $('#detailPromotion').text('-'); // Fiche de voeux not available in current API
                $('#detailStatut').html('<span class="status-cancelled">Annulé</span>');
                $('#detailDateAnnulation').text('-'); // Date update not available in current API
                $('#detailDateRemboursement').text('-'); // Date traitement not available in current API
                $('#detailMontantPaye').text((remboursement.montant_rembourse || 0).toLocaleString('fr-FR') + ' DA'); // Using montant_rembourse as montant_paye
                $('#detailMontantRembourse').text((remboursement.montant_rembourse || 0).toLocaleString('fr-FR') + ' DA');
                $('#detailMethodeRemboursement').text('-'); // Mode remboursement not available in current API
                $('#detailMotifAnnulation').text('-'); // Motif annulation not available in current API
                
                // Load additional details from a separate API call
                loadAdditionalProspectDetails(remboursementId);
            }
        }
        
        // Function to load additional prospect details not available in the main API
        function loadAdditionalProspectDetails(prospectId) {
            // Since we can't modify the original API, we'll need to make a new API endpoint
            // that provides more detailed information. For now, I'll show how this could be done
            // with a hypothetical endpoint that returns detailed information.
            
            // We would need to create an endpoint that gets all client details including telephone, etc.
            // This is a limitation of not modifying the original API - we need additional endpoints
        }
        
        // Populate promo filter dropdown
        function populatePromoFilter() {
            var promoFilter = $('#promoFilter');
            promoFilter.empty(); // Clear existing options
            
            // Add default option (there's no promotion data in current API response)
            promoFilter.append($('<option>', {
                value: '',
                text: 'Toutes les promotions'
            }));
            
            // For now, since the API doesn't return promotion data, we'll just have the default option
            // If we need to filter by promotion, we would need to modify the API to include that information
        }
        
        // Apply filters
        function applyFilters() {
            currentSearchTerm = $('#table-filter').val().toLowerCase();
            // currentPromoFilter is not used since promotion data is not available in current API
            
            // Filter the stored data
            var filteredData = allRemboursementData;
            
            // Apply search filter (only on available fields: nom and prenom)
            if (currentSearchTerm) {
                filteredData = filteredData.filter(function(item) {
                    return (
                        item.nom.toLowerCase().includes(currentSearchTerm) ||
                        item.prenom.toLowerCase().includes(currentSearchTerm)
                    );
                });
            }
            
            // Reset to first page and render the filtered data
            currentPage = 1;
            renderRemboursementTable(filteredData);
            updatePagination(filteredData.length);
        }
        
        // Update pagination
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = $('#pagination-container');
            paginationContainer.empty();
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            const prevButton = $('<li class="page-item ' + prevDisabled + '"><a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">Précédent</a></li>');
            paginationContainer.append(prevButton);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                const pageButton = $('<li class="page-item ' + activeClass + '"><a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a></li>');
                paginationContainer.append(pageButton);
            }
            
            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            const nextButton = $('<li class="page-item ' + nextDisabled + '"><a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">Suivant</a></li>');
            paginationContainer.append(nextButton);
        }
        
        // Change page function (global for onclick)
        window.changePage = function(page) {
            if (page < 1 || page > Math.ceil(allRemboursementData.length / itemsPerPage)) return;
            
            currentPage = page;
            
            // Apply filters to get current filtered data
            var filteredData = allRemboursementData;
            
            if (currentSearchTerm) {
                filteredData = filteredData.filter(function(item) {
                    return (
                        item.nom.toLowerCase().includes(currentSearchTerm) ||
                        item.prenom.toLowerCase().includes(currentSearchTerm) ||
                        item.email.toLowerCase().includes(currentSearchTerm) ||
                        item.telephone.toLowerCase().includes(currentSearchTerm) ||
                        item.promotion.toLowerCase().includes(currentSearchTerm)
                    );
                });
            }
            
            if (currentPromoFilter) {
                filteredData = filteredData.filter(function(item) {
                    return item.promotion && item.promotion.toLowerCase().includes(currentPromoFilter);
                });
            }
            
            renderRemboursementTable(filteredData);
            updatePagination(filteredData.length);
        };
    });
</script>
{% endblock content %}