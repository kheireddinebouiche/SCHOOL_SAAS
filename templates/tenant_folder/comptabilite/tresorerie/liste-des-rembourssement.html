{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Trésorerie - Liste des Remboursements{% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Add search box styling */
    .search-box {
        position: relative;
    }
    
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }
    
    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }
    
    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }
    
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item i {
        width: 1.2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    /* Fix dropdown z-index issue */
    .table-responsive {
        overflow-x: visible;
    }
    
    .table td.text-end {
        position: relative;
        overflow: visible;
    }
    
    .table .dropdown-menu {
        z-index: 1050;
        position: absolute;
    }
    
    .payment-status-badge {
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .payment-status-badge.paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .payment-status-badge.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .payment-status-badge.overdue {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    /* Style pour le curseur au survol des lignes de la table */
    #remboursementTableBody tr {
        cursor: pointer;
    }
    
    /* Style pour le badge d'annulation */
    .status-cancelled {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-refund-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Liste des Remboursements</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Finance</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Liste des Remboursements</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-user-line text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalCancelledProspects">0</h5>
                                    <p class="mb-0 text-muted small">Prospects annulés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-danger bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-danger bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-refund-line text-danger fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">Remboursements totaux</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-money-dollar-circle-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalMontantRembourse">0</h5>
                                    <p class="mb-0 text-muted small">Montant total remboursé</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and search bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-filter text-info me-2"></i>
                                    <h5 class="card-title mb-0 text-info">Filtres</h5>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="search-box position-relative">
                                        <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                        <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                    </div>
                                    <select id="promoFilter" class="form-select rounded-pill" style="width: 200px;">
                                        <option value="">Toutes les promotions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table of cancelled prospects with remboursements -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-body p-3">
                            <div class="table-responsive" style="overflow-x: visible;">
                                <table id="remboursementTable" class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Nom & Prénom</th>
                                            <th class="border-0">Formation/Specialite</th>
                                            <th class="border-0">Promotion</th>
                                            <th class="border-0">Montant à rembourser</th>
                                            
                                            <th class="border-0">Date de remboursement</th>
                                            <th class="border-0">Méthode de remboursement</th>
                                            <th class="border-0 rounded-end text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="remboursementTableBody">
                                        <!-- Data will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav class="mt-3 d-flex justify-content-center" aria-label="Navigation de pagination">
                                <ul class="pagination" id="pagination-container">
                                    <!-- Les boutons de pagination seront générés ici dynamiquement -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal pour afficher les détails de remboursement -->
<div class="modal fade" id="detailsRemboursementModal" tabindex="-1" aria-labelledby="detailsRemboursementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-refund-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="detailsRemboursementModalLabel">
                            Détails du Remboursement
                        </h5>
                        <p class="text-muted small mb-0"><span id="prospectNameInModal"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm rounded-4 h-100">
                            <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-user-line text-info fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-info mb-1">Informations du prospect</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Nom & Prénom</label>
                                    <p class="mb-0 fw-semibold" id="detailNomPrenom">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Email</label>
                                    <p class="mb-0 fw-semibold" id="detailEmail">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Téléphone</label>
                                    <p class="mb-0 fw-semibold" id="detailTelephone">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Spécialité</label>
                                    <p class="mb-0 fw-semibold" id="detailSpecialite">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Motif d'annulation</label>
                                    <p class="mb-0 fw-semibold" id="detailMotifAnnulation">-</p>
                                </div>
                                <div>
                                    <label class="form-label fw-medium text-muted">Statut</label>
                                    <span class="badge" id="detailStatut">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm rounded-4 h-100">
                            <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-money-dollar-circle-line text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-success mb-1">Informations financières</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Montant à rembourser</label>
                                    <p class="mb-0 fw-semibold" id="detailMontantRembourse">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Total Payé</label>
                                    <p class="mb-0 fw-semibold" id="detailMontantPaye">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Méthode de remboursement</label>
                                    <p class="mb-0 fw-semibold" id="detailMethodeRemboursement">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-muted">Date de remboursement</label>
                                    <p class="mb-0 fw-semibold" id="detailDateRemboursement">-</p>
                                </div>
                                <div>
                                    <label class="form-label fw-medium text-muted">Promotion</label>
                                    <p class="mb-0 fw-semibold" id="detailPromotion">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-bank-card-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-success mb-1">Historique des Paiements</h5>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Date</th>
                                            <th class="border-0">N°</th>
                                            <th class="border-0">Méthode</th>
                                            <th class="border-0">Motif</th>
                                            <th class="border-0">Montant</th>
                                            <th class="border-0">Statut</th>
                                            <th class="border-0 rounded-end text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paiementsTableBody">
                                        <!-- Payment rows will be populated dynamically -->
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="ri-bank-card-line fs-2 mb-2"></i>
                                                <p class="mb-0">Aucun paiement enregistré pour le moment</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-primary px-4 py-2" id="printDechargeBtn">
                    <i class="ri-printer-line me-2"></i>Décharge de remboursement
                </button>
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function(){
             
        let allRemboursementsData = [];

        
        function formatComptable(number) {
            if (number == null || number === '') return "0,00";

            return parseFloat(number)
                .toFixed(2)                       // deux décimales
                .replace('.', ',')                // virgule pour décimales
                .replace(/\B(?=(\d{3})+(?!\d))/g, "."); // points pour milliers
        }

        function calculateAndDisplayKPIs(data) {
            // Calculate KPIs
            const totalCancelledProspects = data.length; // Count all cancelled prospects
            const remboursementsWithData = data.filter(item => item.remboursement_id); // Only prospects with actual remboursement records
            const totalRemboursements = remboursementsWithData.length; // Count actual remboursements
            const totalMontantRembourse = remboursementsWithData.reduce((sum, item) => {
                return sum + (parseFloat(item.allowed_amount) || 0);
            }, 0);

            // Update the DOM elements with the calculated values
            $('#totalCancelledProspects').text(totalCancelledProspects);
            $('#totalRemboursements').text(totalRemboursements);
            $('#totalMontantRembourse').text(formatComptable(totalMontantRembourse) + ' DA');
        }

        function loadRemboursementsData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadRemboursements' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(data) {
                    allRemboursementsData = data;
                    populatePromoFilter(data);
                    displayRemboursements(data);
                    calculateAndDisplayKPIs(data); // Calculate and display KPIs after data is loaded
                },
                error: function(xhr, status, error) {

                    var html = '<tr><td colspan="10" class="text-center text-danger">Erreur lors du chargement des données des remboursements.</td></tr>';
                    $('#remboursementTableBody').html(html);
                }
            });
        }

        function populatePromoFilter(data) {
            const promos = [...new Set(data.map(item => item.promotion_session))];
            const promoFilter = $('#promoFilter');
            promoFilter.empty();
            promoFilter.append('<option value="">Toutes les promotions</option>');
            
            promos.forEach(promo => {
                if (promo) {
                    promoFilter.append(`<option value="${promo}">${promo}</option>`);
                }
            });
        }
        const remboursementUrlBase = "{% url 't_tresorerie:DetailsRembourssement' pk=0 %}".replace("/0/", "/");
        function displayRemboursements(data) {
            var html = "";
            if(data.length > 0){
                $.each(data, function(index, item){
                    
                    var remboursementId = item.remboursement_id || item.id || item.pk || item._id;
                    html += '<tr class="remboursement-row" data-remboursement-id="' + remboursementId + '" data-prospect-name="' + item.nom + ' ' + item.prenom + '">';
                    html += '<td><strong>' + item.nom + ' ' + item.prenom + '</strong></td>';
                    html += '<td><strong>' + item.formation + '/' + item.specialite + '</strong></td>';
                    html += '<td>'+item.promotion_session + '-' +item.promotion_start +'/'+item.promotion_end+'</td>';
                    html += '<td><strong class="text-danger">'+formatComptable(item.allowed_amount)+' DA</strong></td>';
                    
                    html += '<td>'+item.updated_at+'</td>'; 
                    html += '<td><span class="badge bg-info">'+item.mode_rembourssement+'</span></td>'; 
                    html += '<td class="text-center">';
                    html += '<div class="dropdown d-inline-block">';
                    html += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation();">';
                    html += '<i class="ri-more-fill align-middle"></i>';
                    html += '</button>';
                    html += '<ul class="dropdown-menu dropdown-menu-end">';
                    //html += '<li><a class="btn-details-remboursement dropdown-item" href="javascript:void(0);" data-remboursement-id="' + remboursementId + '">';
                    html += '<li><a href="' + remboursementUrlBase + remboursementId +'" class="dropdown-item" data-remboursement-id="' + remboursementId + '">';
                    html += '<i class="ri-eye-fill align-bottom me-2 text-muted"></i> Détails</a></li>';
                    html += '</ul>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';   
                });
            }else{
                html = "<tr><td colspan='7' class='text-muted text-center'>"+
                        "<div class='d-flex flex-column align-items-center justify-content-center py-5'>"+
                    "<div class='avatar-sm mb-4'>"+
                       " <div class='avatar-title bg-light text-muted rounded-circle fs-1'>"+
                           "<i class='ri-wallet-2-line'></i>"+
                        "</div>"+
                    "</div>"+
                    "<h5 class='mb-2'>Aucun remboursement trouvé</h5>"+
                    "<p class='text-muted mb-0'>Il n'y a aucun remboursement enregistré pour le moment</p>"+
                "</div></td></tr> ";
            }

            $('#remboursementTableBody').html(html);
        }

        // Filter functionality
        $('#promoFilter, #table-filter').on('input change', function() {
            const promoFilterValue = $('#promoFilter').val().toLowerCase();
            const searchFilterValue = $('#table-filter').val().toLowerCase();

            const filteredData = allRemboursementsData.filter(item => {
                const matchesPromo = !promoFilterValue || item.promotion_session.toLowerCase().includes(promoFilterValue);
                const matchesSearch = !searchFilterValue ||
                    (item.nom && item.nom.toLowerCase().includes(searchFilterValue)) ||
                    (item.prenom && item.prenom.toLowerCase().includes(searchFilterValue)) ||
                    (item.promotion_session && item.promotion_session.toLowerCase().includes(searchFilterValue)) ||
                    (item.allowed_amount && item.allowed_amount.toString().includes(searchFilterValue)) ||
                    (item.mode_rembourssement && item.mode_rembourssement.toLowerCase().includes(searchFilterValue));

                return matchesPromo && matchesSearch;
            });

            displayRemboursements(filteredData);
            calculateAndDisplayKPIs(filteredData); // Update KPIs based on filtered data
        });

        // Handle print engagement button click
        $(document).on('click', '#printEngagementBtn', function() {
            // Get the current prospect ID from the modal
            // We'll need to store the current remboursement being viewed
            var currentRemboursementId = $('#detailsRemboursementModal').data('remboursement-id');

            if (currentRemboursementId) {
                // Open a new window/tab for the engagement printing
                // This would be replaced with the actual URL for the engagement document
                var printUrl = '/path/to/engagement/' + currentRemboursementId + '/'; // TODO: Replace with actual URL
                window.open(printUrl, '_blank');
            } else {
                alert('Impossible de récupérer les informations du remboursement pour l\'impression.');
            }
        });


        // Function to load and display payment history
        function loadPaymentHistory(remboursementId) {
            // Clear existing payment rows
            $('#paiementsTableBody').empty();

            // For now, display a message indicating no payments are found
            // In a real implementation, this would fetch data from an API endpoint
            var noPaymentsRow = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="ri-bank-card-line fs-2 mb-2"></i>
                        <p class="mb-0">Aucun paiement enregistré pour le moment</p>
                    </td>
                </tr>
            `;
            $('#paiementsTableBody').append(noPaymentsRow);
            
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadPaiements' %}", // Replace with actual URL
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'remboursement_id': remboursementId
                },
                success: function(data) {
                    $('#paiementsTableBody').empty();

                    if (data.length > 0) {

                        $.each(data, function(index, paiement) {

                            let classBadge = paiement.is_refund ? "bg-danger" : "bg-info";
                            let fontColor = paiement.is_refund ? "red" : "green";

                            let row = `
                                <tr>
                                    <td>${paiement.date_paiement ?? '-'}</td>
                                    <td><b>#${paiement.num ?? '-'}</b></td>
                                    <td><span class="badge bg-info">${paiement.mode_paiement_label ?? '-'}</span></td>
                                    <td><span class="badge ${classBadge}">${paiement.paiement_label ?? '-'}</span></td>
                                    <td style="color : ${fontColor}">${formatComptable(paiement.montant_paye ?? 0)} DA</td>
                                    <td><span class="badge bg-success">Payé</span></td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">

                                            <button type="button" 
                                                class="btn btn-outline-primary btn-sm" 
                                                onclick="event.preventDefault(); getQuittance(${paiement.id ?? index});" 
                                                title="Quittance">
                                                <i class="ri-file-pdf-line"></i>
                                            </button>

                                            <button type="button" 
                                                class="btn btn-outline-info btn-sm" 
                                                onclick="event.preventDefault(); getInvoice(${paiement.id ?? index});" 
                                                title="Facture">
                                                <i class="ri-file-list-line"></i>
                                            </button>

                                        </div>
                                    </td>
                                </tr>
                            `;

                            $('#paiementsTableBody').append(row);
                        });

                    } else {
                        $('#paiementsTableBody').append(noPaymentsRow);
                    }
                },
                error: function() {
                    $('#paiementsTableBody').empty();
                    $('#paiementsTableBody').append(noPaymentsRow);
                }
            });
            
        }


        loadRemboursementsData();

        $(document).on('click','#printDechargeBtn', function(){
            $('#refundAssistantModal').modal('show');
        });

        

        function generateDechargeRemboursementPDF(signataireSelectRefund,pieceIdentiteSelectPID,nomParentTuteurInputRefund,prenomParentTuteurInputRefund,adresseParentTuteurInputRefund,contactParentTuteurInputRefund,numeroPieceInputRefund,dateDelivranceInputRefund,lieuDelivranceInputRefund) {
            var clientFullName  = $('#clientFullName').text();

            var etudiant = $('#demandeur').text();
            var date_naissance = $('#_date_naissance').val();
            var lieu_naissance = $('#_lieu_naissance').val();
            var formation = $('#_formation').val();

            var signataire = signataireSelectRefund;
            var TypeId = pieceIdentiteSelectPID;
            var dateDelivrance = dateDelivranceInputRefund;
            var numerPiece = numeroPieceInputRefund;
            var lieuDeDelivrance = lieuDelivranceInputRefund;
            var nomParentTuteur = nomParentTuteurInputRefund;
            var prenomParentTuteur = prenomParentTuteurInputRefund;

            var groupe = $('#_nom_groupe').val();
            var semestre=$('#_semestre_groupe').val();
            var specialite = $('#specialite').text();
            var entite = $('#_entite').val();
            var ville = $('#_ville').val();

            var _allowed_amount = $('#_allowed_amount').val();
            var _total_paid = $('#_total_paid').val();
            var _motif_remboursement = $('#_motif_remboursement').val();
            var amountLettre = numberToWordsDZD(_allowed_amount);

            const today = new Date();
            const formattedDate = today.toLocaleDateString('fr-FR');
            

            if(signataireSelectRefund === "Parents" || signataireSelectRefund === "Tuteur"){
                clientFullName = nomParentTuteur+" "+prenomParentTuteur;
            }


            var jsPDFInstance = null;
            if (typeof jsPDF !== 'undefined') {
                jsPDFInstance = jsPDF;
            } else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                jsPDFInstance = window.jspdf.jsPDF;
            } else if (typeof jspdf !== 'undefined' && typeof jspdf.jsPDF !== 'undefined') {
                jsPDFInstance = jspdf.jsPDF;
            }

            if (jsPDFInstance) {
                try {
                    const doc = new jsPDFInstance();

                    // Charger les logos si disponibles
                    const logoHeaderUrl = document.getElementById('_logoHeader')?.value;
                    const logoFooterUrl = document.getElementById('_logoFooter')?.value;

                    const addLogosToPDF = () => {
                        if (logoHeaderUrl) {
                            const headerLogoUrl = logoHeaderUrl.startsWith('/') ? window.location.origin + logoHeaderUrl : logoHeaderUrl;
                            const headerLogoWidth = doc.internal.pageSize.width * 0.25;
                            doc.addImage(headerLogoUrl, 'PNG', 150, 10, headerLogoWidth, headerLogoWidth * 0.375);
                        }

                        if (logoFooterUrl) {
                            const footerLogoUrl = logoFooterUrl.startsWith('/') ? window.location.origin + logoFooterUrl : logoFooterUrl;
                            doc.addImage(footerLogoUrl, 'PNG', 20, doc.internal.pageSize.height - 20, doc.internal.pageSize.width - 40, 15);
                        }
                    };

                    addLogosToPDF();

                    // Police et format
                    doc.setFont('helvetica');
                    doc.setFontSize(16);
                    doc.text("DÉCHARGE DE REMBOURSEMENT", 105, 50, null, null, 'center');

                    doc.setFontSize(12);
                    let y = 55;
                    const line = (step = 6) => y += step; 

                    // Corps du document
                    doc.text("Je soussigné(e) : "+clientFullName, 20, line());
                    doc.text("Qualité : "+signataire, 20, line(8));

                    doc.text("Agissant en ma qualité de représentant(e) de l'apprenant(e) :", 20, line(10));
                    doc.text("Nom et Prénom : "+etudiant, 30, line());
                    doc.text("Né(e) le : "+date_naissance+"   À : "+lieu_naissance, 30, line(8));

                    doc.text("Préinscrit(e) / Inscrit(e) en formation :", 20, line(10));
                    doc.text(formation, 30, line());
                    doc.text("Spécialité : "+specialite, 30, line());
                    if(groupe){
                        doc.text("Semestre : "+semestre+"   Groupe : "+groupe, 30, line());
                    }
                    doc.text("Année académique : 2025 – 2026", 30, line(8));

                    doc.text("Je reconnais avoir reçu, en espèces, en chèque, autres, ce jour, de la caisse de", 20, line(10));
                    doc.text("l'INSIM / HIMI, la somme de :", 20, line(6));
                    doc.text(_allowed_amount+"DZD", 30, line());
                    doc.text("(en toutes lettres : "+amountLettre+").", 30, line(8));

                    doc.text("Cette somme représente le remboursement (total / partiel) des frais de formation", 20, line(10));
                    doc.text("réglés en date du : ____________________", 20, line(8));

                    doc.text("Raison du remboursement :"+_motif_remboursement, 20, line(10));

                    doc.text("Fait à "+ville+", le "+formattedDate, 150, line(12));

                    doc.text("Signature du bénéficiaire précédée de la mention « Lu et approuvé » :", 20, line(12));
                    doc.text(TypeId, 20, line(10));
                    doc.text("Délivré(e) le : "+dateDelivrance, 20, line(8));
                    doc.text("Par : "+lieuDeDelivrance, 20, line(8));

                    doc.text("_____________________________________", 20, line(15));
                    doc.text("(Signature)", 20, line());

                    doc.text("Visa et cachet de l’administration :", 20, line(15));

                    // Sauvegarde du fichier
                    doc.save("decharge_remboursement.pdf");
                    alertify.success("Décharge de remboursement générée avec succès !");
                } catch (error) {
                    console.error("Erreur lors de la génération du PDF:", error);
                    alert("Erreur lors de la génération du document : " + error.message);
                }
            }
        }
    
        


    });
</script>
{% endblock content %}


