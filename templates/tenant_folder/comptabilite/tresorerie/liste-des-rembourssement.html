{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Trésorerie - Liste des Remboursements{% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Add search box styling */
    .search-box {
        position: relative;
    }
    
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }
    
    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }
    
    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }
    
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item i {
        width: 1.2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    /* Fix dropdown z-index issue */
    .table-responsive {
        overflow-x: visible;
    }
    
    .table td.text-end {
        position: relative;
        overflow: visible;
    }
    
    .table .dropdown-menu {
        z-index: 1050;
        position: absolute;
    }
    
    .payment-status-badge {
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .payment-status-badge.paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .payment-status-badge.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .payment-status-badge.overdue {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    /* Style pour le curseur au survol des lignes de la table */
    #remboursementTableBody tr {
        cursor: pointer;
    }
    
    /* Style pour le badge d'annulation */
    .status-cancelled {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border-radius: 20px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-refund-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Liste des Remboursements</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Finance</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Trésorerie</a>
                                    </li>
                                    <li class="breadcrumb-item active">Liste des Remboursements</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Statistics Section -->
            <div class="row mb-4" id="statisticsSection">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-user-line text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalCancelledProspects">0</h5>
                                    <p class="mb-0 text-muted small">Prospects annulés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-danger bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-danger bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-refund-line text-danger fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalRemboursements">0</h5>
                                    <p class="mb-0 text-muted small">Remboursements totaux</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-money-dollar-circle-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalMontantRembourse">0</h5>
                                    <p class="mb-0 text-muted small">Montant total remboursé</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-money-euro-circle-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalMontantRestant">0</h5>
                                    <p class="mb-0 text-muted small">Montant restant</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and search bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-filter text-info me-2"></i>
                                    <h5 class="card-title mb-0 text-info">Filtres</h5>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="search-box position-relative">
                                        <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                        <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                    </div>
                                    <select id="promoFilter" class="form-select rounded-pill" style="width: 200px;">
                                        <option value="">Toutes les promotions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table of cancelled prospects with remboursements -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-body p-3">
                            <div class="table-responsive" style="overflow-x: visible;">
                                <table id="remboursementTable" class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Nom & Prénom</th>
                                            <th class="border-0">Promotion</th>
                                            <th class="border-0">Montant à rembourser</th>
                                            
                                            <th class="border-0">Date de remboursement</th>
                                            <th class="border-0">Méthode de remboursement</th>
                                            <th class="border-0 rounded-end text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="remboursementTableBody">
                                        <!-- Data will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav class="mt-3 d-flex justify-content-center" aria-label="Navigation de pagination">
                                <ul class="pagination" id="pagination-container">
                                    <!-- Les boutons de pagination seront générés ici dynamiquement -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Modal pour afficher les détails de remboursement -->
<div class="modal fade" id="detailsRemboursementModal" tabindex="-1" aria-labelledby="detailsRemboursementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-xl border-0 overflow-hidden">
            <div class="modal-header bg-gradient bg-primary text-white px-4 py-3 border-0">
                <div class="d-flex align-items-center w-100">
                    <div class="avatar-sm bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-3">
                        <i class="ri-refund-line text-white fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="modal-title fw-bold mb-0" id="detailsRemboursementModalLabel">Détails du Remboursement</h5>
                        <p class="text-white text-opacity-75 mb-0 fs-6"><span id="prospectNameInModal"></span></p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-4">
                <!-- Main info card -->
                <div class="card shadow-sm border mb-4">
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="avatar-md bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                                        <i class="ri-user-line text-primary fs-3"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title text-dark mb-1" id="detailNomPrenom">-</h5>
                                        <div class="d-flex gap-3">
                                            <span class="badge bg-primary bg-opacity-10 text-primary" id="detailStatut">Statut</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex gap-4">
                                    <div>
                                        <p class="text-muted mb-1">Email</p>
                                        <h6 class="text-dark mb-0" id="detailEmail">-</h6>
                                    </div>
                                    <div>
                                        <p class="text-muted mb-1">Téléphone</p>
                                        <h6 class="text-dark mb-0" id="detailTelephone">-</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="bg-light rounded-3 p-3 text-center">
                                    <i class="ri-money-dollar-circle-line text-success fs-2 mb-2"></i>
                                    <h5 class="text-dark mb-1" id="detailMontantRembourse">0 DA</h5>
                                    <p class="text-muted mb-0">Montant à rembourser</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Details grid -->
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card border shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-xs rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center">
                                            <i class="ri-calendar-2-line text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1">Promotion</p>
                                        <h6 class="text-dark mb-0" id="detailPromotion">-</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-xs rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center">
                                            <i class="ri-brain-line text-success"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1">Spécialité</p>
                                        <h6 class="text-dark mb-0" id="detailSpecialite">-</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-xs rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center">
                                            <i class="ri-bank-card-line text-info"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1">Méthode</p>
                                        <h6 class="text-dark mb-0" id="detailMethodeRemboursement">-</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional details -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="card border shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="ri-money-dollar-box-line text-warning fs-5 me-2"></i>
                                    <h6 class="card-title mb-0">Total Payé <p class="text-muted" style="font-size : 9pt;">Montant paye aprés rembourssement</p></h6>
                                </div>
                                <h5 class="text-dark mb-0" id="detailMontantPaye">0 DA</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="ri-calendar-line text-secondary fs-5 me-2"></i>
                                    <h6 class="card-title mb-0">Date Remboursement</h6>
                                </div>
                                <h5 class="text-dark mb-0" id="detailDateRemboursement">-</h5>
                            </div>
                        </div>
                    </div>
                </div>
                
            
                
                <!-- Cancellation reason -->
                <div class="card border shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="ri-file-text-line text-muted fs-5 me-2"></i>
                            <h6 class="card-title mb-0">Motif d'annulation</h6>
                        </div>
                        <p class="text-dark mb-0" id="detailMotifAnnulation">-</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light px-4 py-3 border-0">
                <button type="button" class="btn btn-light btn-lg px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
             
        let allRemboursementsData = [];

        function loadRemboursementsData() {
            $.ajax({
                url: "{% url 't_tresorerie:ApiLoadRemboursements' %}",
                dataType: 'JSON',
                type: 'GET',
                success: function(data) {
                    allRemboursementsData = data;
                    populatePromoFilter(data);
                    displayRemboursements(data);
                },
                error: function(xhr, status, error) {
                
                    var html = '<tr><td colspan="10" class="text-center text-danger">Erreur lors du chargement des données des remboursements.</td></tr>';
                    $('#remboursementTableBody').html(html);
                }
            });
        }

        function populatePromoFilter(data) {
            const promos = [...new Set(data.map(item => item.promotion_session))];
            const promoFilter = $('#promoFilter');
            promoFilter.empty();
            promoFilter.append('<option value="">Toutes les promotions</option>');
            
            promos.forEach(promo => {
                if (promo) {
                    promoFilter.append(`<option value="${promo}">${promo}</option>`);
                }
            });
        }

        function displayRemboursements(data) {
            var html = "";
            if(data.lenght > 0){
                $.each(data, function(index, item){
                    
                    var remboursementId = item.remboursement_id || item.id || item.pk || item._id;
                    html += '<tr class="remboursement-row" data-remboursement-id="' + remboursementId + '" data-prospect-name="' + item.nom + ' ' + item.prenom + '">';
                    html += '<td><strong>' + item.nom + ' ' + item.prenom + '</strong></td>';
                    
                    html += '<td>'+item.promotion_session + '-' +item.promotion_start +'/'+item.promotion_end+'</td>';
                    html += '<td><strong class="text-danger">'+item.allowed_amount+' DA</strong></td>';
                    
                    html += '<td>'+item.updated_at+'</td>'; 
                    html += '<td>'+item.mode_rembourssement+'</td>'; 
                    html += '<td class="text-center">';
                    html += '<div class="dropdown d-inline-block">';
                    html += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation();">';
                    html += '<i class="ri-more-fill align-middle"></i>';
                    html += '</button>';
                    html += '<ul class="dropdown-menu dropdown-menu-end">';
                    html += '<li><a class="btn-details-remboursement dropdown-item" href="javascript:void(0);" data-remboursement-id="' + remboursementId + '">';
                    html += '<i class="ri-eye-fill align-bottom me-2 text-muted"></i> Détails</a></li>';
                    html += '</ul>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';   
                });
            }else{
                html = "<tr><td colspan='6' class='text-muted text-center'>Aucune informations trouvé </td></tr> ";
            }

            $('#remboursementTableBody').html(html);
        }

        // Filter functionality
        $('#promoFilter, #table-filter').on('input change', function() {
            const promoFilterValue = $('#promoFilter').val().toLowerCase();
            const searchFilterValue = $('#table-filter').val().toLowerCase();
            
            const filteredData = allRemboursementsData.filter(item => {
                const matchesPromo = !promoFilterValue || item.promotion_session.toLowerCase().includes(promoFilterValue);
                const matchesSearch = !searchFilterValue || 
                    (item.nom && item.nom.toLowerCase().includes(searchFilterValue)) ||
                    (item.prenom && item.prenom.toLowerCase().includes(searchFilterValue)) ||
                    (item.promotion_session && item.promotion_session.toLowerCase().includes(searchFilterValue)) ||
                    (item.allowed_amount && item.allowed_amount.toString().includes(searchFilterValue)) ||
                    (item.mode_rembourssement && item.mode_rembourssement.toLowerCase().includes(searchFilterValue));
                
                return matchesPromo && matchesSearch;
            });
            
            displayRemboursements(filteredData);
        });

        // Modal functionality - handle both button and anchor tag clicks
        $(document).on('click', '.btn-details-remboursement', function(e) {
            e.preventDefault(); // Prevent default anchor behavior
            
            // Use attr instead of data for better compatibility
            var remboursementId = $(this).attr('data-remboursement-id');
            console.log('Details button clicked, ID from button:', remboursementId); // Debug logging
            
            // If attr doesn't work, look for the ID in the parent row
            if (!remboursementId) {
                var row = $(this).closest('tr.remboursement-row');
                remboursementId = row.attr('data-remboursement-id');
                console.log('Getting ID from parent row:', remboursementId); // Debug
            }
    
            
            const remboursement = allRemboursementsData.find(item => {
                var itemId = item.remboursement_id || item.id || item.pk || item._id;
                return itemId == remboursementId;
            });
            
            if (remboursement) {
                $('#prospectNameInModal').text(remboursement.nom + ' ' + remboursement.prenom);
                $('#detailNomPrenom').text(remboursement.nom + ' ' + remboursement.prenom);
                $('#detailEmail').text(remboursement.email || '-');
                $('#detailTelephone').text(remboursement.telphone || '-');
                $('#detailPromotion').text(remboursement.promotion_session + '-' + remboursement.promotion_start + '/' + remboursement.promotion_end);
                $('#detailSpecialite').text(remboursement.specialite || '-');
                $('#detailStatut').text(remboursement.statut || '-');
                $('#detailMontantPaye').text((remboursement.total_paye || 0) + ' DA');
                $('#detailMontantRembourse').text(remboursement.allowed_amount + ' DA');
                $('#detailDateRemboursement').text(remboursement.updated_at || '-');
                $('#detailMethodeRemboursement').text(remboursement.mode_rembourssement || '-');
                $('#detailMotifAnnulation').text(remboursement.motif_rembourssement || '-');
    
                

                var myModal = new bootstrap.Modal(document.getElementById('detailsRemboursementModal'));
                myModal.show();
            } else {
                console.error('Remboursement not found with ID:', remboursementId, 'Available IDs:', allRemboursementsData.map(item => item.remboursement_id || item.id || item.pk || item._id));
            }
        });

        // Also handle clicks on the row itself to open the modal
        $(document).on('click', '.remboursement-row', function() {
            // Use attr instead of data for better compatibility
            var remboursementId = $(this).attr('data-remboursement-id');
            console.log('Row clicked, ID from row attr():', remboursementId); // Debug logging
            
            // Fallback to data() if attr() doesn't work
            if (!remboursementId) {
                remboursementId = $(this).data('remboursement-id');
                console.log('Using data() method, ID:', remboursementId); // Debug
            }
            
            console.log('Final remboursementId for row:', remboursementId);
            console.log('allRemboursementsData length:', allRemboursementsData.length);
            
            const remboursement = allRemboursementsData.find(item => {
                var itemId = item.remboursement_id || item.id || item.pk || item._id;
                return itemId == remboursementId;
            });
            
            if (remboursement && remboursementId) {
                $('#prospectNameInModal').text(remboursement.nom + ' ' + remboursement.prenom);
                $('#detailNomPrenom').text(remboursement.nom + ' ' + remboursement.prenom);
                $('#detailEmail').text(remboursement.email || '-');
                $('#detailTelephone').text(remboursement.telephone || '-');
                $('#detailPromotion').text(remboursement.promotion_session + '-' + remboursement.promotion_start + '/' + remboursement.promotion_end);
                $('#detailSpecialite').text(remboursement.specialite || '-');
                $('#detailStatut').text(remboursement.statut || '-');
                $('#detailMontantPaye').text((remboursement.total_paye || 0) + ' DA');
                $('#detailMontantRembourse').text(remboursement.allowed_amount + ' DA');
                $('#detailDateRemboursement').text(remboursement.updated_at || '-');
                $('#detailMethodeRemboursement').text(remboursement.mode_rembourssement || '-');
                $('#detailMotifAnnulation').text(remboursement.motif_rembourssement || '-');
                
                var myModal = new bootstrap.Modal(document.getElementById('detailsRemboursementModal'));
                myModal.show();
            } else {
                console.error('Remboursement not found with ID from row:', remboursementId, 'Available IDs:', allRemboursementsData.map(item => item.remboursement_id || item.id || item.pk || item._id));
                console.log('Full allRemboursementsData:', allRemboursementsData);
            }
        });

        

        loadRemboursementsData();
    });
</script>
{% endblock content %}


