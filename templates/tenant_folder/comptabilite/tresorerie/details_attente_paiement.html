{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Trésorerie - Détails demande de paiement {% endblock title %}

{% block content %}
<style>
    :root {
        --primary-color: #3b7ddd;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --dark-text: #212529;
        --light-text: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        --transition: all 0.3s ease;
    }
    
    /* Ajout du dégradé primaire */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #3b7ddd 0%, #1a56b0 100%) !important;
    }
    
    ._inputDetails {
       background-color: transparent !important;
       border : none !important;
       outline : none;
       font-weight : 700 !important;
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .echeancier-special-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .percentage-input {
        width: 80px;
    }
    
    .montant-cell {
        font-weight: 600;
    }
    
    .total-row {
        background-color: #e9ecef;
        font-weight: 700;
    }
    
    .card-equal-height {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .card-equal-height .card-body {
        flex: 1 1 auto;
    }
    
    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }
    
    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }
    
    /* Nouveaux styles pour une disposition moderne */
    
    .section-card {
        transition: var(--transition);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        margin-bottom: 1.5rem;
        border: none;
    }
    
    .section-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    .section-card .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1rem 1.5rem;
    }
    
    .section-card .card-body {
        padding: 1.5rem;
    }
    
    .sticky-top-custom {
        position: sticky;
        top: 20px;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: var(--transition);
        border: none;
    }
    
    .btn-action i {
        margin-right: 0.5rem;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .btn-warning {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .info-card {
        border-left: 4px solid;
    }
    
    .info-card.demandeur {
        border-left-color: var(--primary-color);
    }
    
    .info-card.formation {
        border-left-color: var(--success-color);
    }
    
    .tab-content {
        min-height: 300px;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .notification-banner {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 1rem;
        border: none;
    }
    
    .avatar-lg {
        width: 4rem;
        height: 4rem;
    }
    
    .avatar-md {
        width: 3rem;
        height: 3rem;
    }
    
    .avatar-sm {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    .stats-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        background: white;
        box-shadow: var(--box-shadow);
    }
    
    .stats-card .number {
        font-size: 2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    
    .stats-card .label {
        font-size: 0.9rem;
        color: var(--light-text);
    }
    
    .payment-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--light-bg);
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .payment-summary .amount {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .payment-summary .status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    @media (max-width: 992px) {
        .sticky-top-custom {
            position: static;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
        }
    }
</style>
<script src="https://cdn.lordicon.com/lordicon.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">
                    
                    <!-- start page title -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="ri-money-dollar-circle-line text-info"></i>
                                    </div>
                                    <h4 class="mb-0 text-info">Détails demande de paiement</h4>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb m-0 bg-transparent">
                                            <li class="breadcrumb-item">
                                                <a href="javascript: void(0);">Trésorerie</a>
                                            </li>
                                            <li class="breadcrumb-item active">Détails demande de paiement</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end page title -->

                    <!-- Notifications -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <!-- Notification d'instructions d'utilisation -->
                            <div class="alert alert-primary d-flex align-items-center notification-banner" role="alert">
                                <i class="ri-information-line me-3 fs-4"></i>
                                <div class="flex-grow-1">
                                    <strong>Instructions d'utilisation des échéanciers :</strong>
                                    <p class="mb-0 text-muted small">1. Utilisez le bouton "Spécial" pour créer un échéancier personnalisé. 2. Cliquez sur "Confirmer" pour valider l'échéancier. 3. Ensuite, vous pourrez enregistrer des paiements.</p>
                                </div>
                            </div>

                            <!-- Notification d'échéancier spécial avec bouton Détails -->
                            <div style="display: none !important" class="alert alert-info d-flex align-items-center notification-banner" role="alert" id="echeancierSpecialNotification">
                                <i class="ri-star-line me-3 fs-4"></i>
                                <div class="flex-grow-1">
                                    <strong>Un échéancier spécial est disponible pour ce demandeur.</strong>
                                    <p class="mb-0 text-muted small">Cliquez sur détails pour voir les informations de l'échéancier.</p>
                                </div>
                                <div class="flex-shrink-0 ms-3">
                                    <button type="button" class="btn btn-primary btn-sm" id="showEcheancierSpecialDetails">
                                        <i class="ri-eye-line me-1"></i>Détails
                                    </button>
                                </div>
                            </div>

                            <!-- Notification d'échéancier en cours d'examen -->
                            <div style="display: none !important" class="alert alert-warning d-flex align-items-center notification-banner" role="alert" id="echeancierExamenNotification">
                                <i class="ri-time-line me-3 fs-4"></i>
                                <div class="flex-grow-1">
                                    <strong>L'échéancier demandé est actuellement en cours d'examen.</strong>
                                    <p class="mb-0 text-muted small">Veuillez patienter pendant que nous traitons votre demande.</p>
                                </div>
                                <div class="flex-shrink-0 ms-3">
                                    <button type="button" class="btn btn-warning btn-sm" id="showEcheancierExamenDetails">
                                        <i class="ri-eye-line me-1"></i>Détails
                                    </button>
                                </div>
                            </div>

                             <!-- Notification de réduction avec bouton Consulter -->
                            <div style="display: none !important;" class="alert alert-warning d-flex align-items-center notification-banner" role="alert" id="reductionNotification" >
                                <i class="ri-error-warning-line me-3 fs-4"></i>
                                <div class="flex-grow-1">
                                    <strong>Le demandeur bénéficie d'une réduction de prix.</strong>
                                    <p class="mb-0 text-muted small">Cliquez sur consulter pour voir les détails de la réduction.</p>
                                </div>
                                <div class="flex-shrink-0 ms-3">
                                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#reductionDetailsModal">
                                        <i class="ri-eye-line me-1"></i>Consulter
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Notification de succès pour la réduction appliquée -->
                            <div style="display: none !important;" class="alert alert-success d-flex align-items-center notification-banner" role="alert" id="reductionSuccessNotification">
                                <i class="ri-checkbox-circle-line me-3 fs-4"></i>
                                <div class="flex-grow-1">
                                    <strong>Réduction appliquée avec succès !</strong>
                                    <p class="mb-0 text-muted small">La réduction a été appliquée à la formation.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main content -->
                    <div class="row">
                        <!-- Left column - Informations -->
                        <div class="col-xl-4 col-lg-5">
                            <div class="sticky-top-custom">
                                <!-- Informations du demandeur -->
                                <div class="card section-card info-card demandeur mb-4">
                                    <div class="card-header bg-white">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                                                <i class="ri-user-line text-primary fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-primary mb-0">Informations du demandeur</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                                    <i class="ri-user-line text-primary fs-3"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <input type="hidden" id="clientIdInput" /> 
                                                <h5 class="mb-1" id="demandeur"></h5>
                                                <p class="text-muted mb-0 small">Nom complet</p>
                                            </div>
                                            <button class="btn btn-sm btn-link p-0" data-bs-toggle="modal" data-bs-target="#clientDetailsModal">
                                                <i class="ri-link"></i>
                                            </button>
                                        </div>
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                                    <i class="ri-calendar-line text-primary fs-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1" id="created_at"></h6>
                                                <p class="text-muted mb-0 small">Date de demande</p>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center">
                                                    <i class="ri-file-text-line text-primary fs-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1" id="motif"></h6>
                                                <p class="text-muted mb-0 small">Motif de la demande</p>
                                            </div>
                                        </div>
                                    </div> 
                                </div>
                                
                                <!-- Informations sur la formation -->
                                <div class="card section-card info-card formation mb-4">
                                    <div class="card-header bg-white">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-2 me-3">
                                                <i class="ri-book-line text-success fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-success mb-0">Informations sur la formation</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                                    <i class="ri-book-line text-success fs-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1" id="specialite"></h6>
                                                <p class="text-muted mb-0 small">Spécialité</p>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                                    <i class="ri-graduation-cap-line text-success fs-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1" id="promo"></h6>
                                                <p class="text-muted mb-0 small">Promo</p>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                                    <i class="ri-money-dollar-circle-line text-success fs-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1" id="prix_formation"></h6>
                                                <p class="text-muted mb-0 small">Prix de la formation</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment Summary -->
                                <div class="card section-card">
                                    <div class="card-header bg-white">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-2 me-3">
                                                <i class="ri-money-cny-circle-line text-info fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-info mb-0">Résumé des paiements</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="payment-summary">
                                            <div>
                                                <div class="text-muted small">Total dû</div>
                                                <div class="amount text-primary" id="totalDueAmount">0.00 DA</div>
                                            </div>
                                            <span class="status bg-warning bg-opacity-10 text-warning">En attente</span>
                                        </div>
                                        <div class="payment-summary">
                                            <div>
                                                <div class="text-muted small">Total payé</div>
                                                <div class="amount text-success" id="totalPaidAmount">0.00 DA</div>
                                            </div>
                                            <span class="status bg-success bg-opacity-10 text-success">Payé</span>
                                        </div>
                                        <div class="payment-summary mb-0">
                                            <div>
                                                <div class="text-muted small">Solde</div>
                                                <div class="amount text-danger" id="balanceAmount">0.00 DA</div>
                                            </div>
                                            <span class="status bg-danger bg-opacity-10 text-danger">Restant</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right column - Payment details -->
                        <div class="col-xl-8 col-lg-7">
                            <!-- Action buttons -->
                            <div class="card section-card mb-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                                        <h5 class="mb-3 mb-md-0">Actions disponibles</h5>
                                        <div class="action-buttons">
                                            <button id="btnNewPaiement" class="btn btn-primary btn-action">
                                                <i class="ri-add-line"></i> Nouveau paiement
                                            </button>
                                            <button id="btnPrintEngagement" class="btn btn-success btn-action">
                                                <i class="ri-printer-line"></i> Imprimer Engagement
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment sections -->
                            <div class="row">
                                <!-- Échéancier de paiement -->
                                <div class="col-12 mb-4">
                                    <div class="card section-card h-100">
                                        <div class="card-header bg-white">
                                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                                <div class="d-flex align-items-center">
                                                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-2 me-3">
                                                        <i class="ri-calendar-line text-success fs-4"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="card-title fw-semibold text-success mb-0">Échéancier de paiement</h5>
                                                        <p class="text-muted small mb-0">Détails des tranches de paiement</p>
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2 mt-2 mt-md-0">
                                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#aideEcheancierModal">
                                                        <i class="ri-question-line me-1"></i>Aide
                                                    </button>
                                                    <button id="idBtnConfirmeEcheancierModal" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#confirmEcheancierModal">
                                                        <i class="ri-check-line me-1"></i>Confirmer
                                                    </button>
                                                    <button id="specialBoutonConf" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#specialEcheancierModal">
                                                        <i class="ri-star-line me-1"></i>Spécial
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle table-nowrap mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Libellé</th>
                                                            <th>Date d'échéance</th>
                                                            <th>Montant</th>
                                                            <th id="prixFinalHeader" style="display: none;">Prix final</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="echeancierTable">
                                                        <!-- Échéanciers seront chargés ici -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Paiements -->
                                <div class="col-12">
                                    <div class="card section-card h-100">
                                        <div class="card-header bg-white">
                                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                                <div class="d-flex align-items-center">
                                                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-2 me-3">
                                                        <i class="ri-money-cny-circle-line text-info fs-4"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="card-title fw-semibold text-info mb-0">Paiements</h5>
                                                        <p class="text-muted small mb-0">Suivi des paiements effectués</p>
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2 mt-2 mt-md-0">
                                                    <button id="btnNewPaiementModal" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nouveauPaiementModal">
                                                        <i class="ri-add-line me-1"></i>Nouveau paiement
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            
                                            <!-- Nav tabs -->
                                            <ul class="nav nav-tabs nav-tabs-custom nav-primary mb-4" role="tablist">
                                                <li class="nav-item">
                                                    <a class="nav-link active" data-bs-toggle="tab" href="#nav-border-top-paiement_dus" role="tab" aria-selected="false">
                                                        <i class="ri-money-dollar-circle-line me-1 align-middle"></i> Dus 
                                                        <span class="badge bg-warning rounded-circle ms-1" id="NbrPaiementDue">0</span>
                                                    </a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-bs-toggle="tab" href="#nav-border-top-paiements_done" role="tab" aria-selected="false">
                                                        <i class="ri-check-double-line me-1 align-middle"></i> Effectués
                                                        <span class="badge bg-success rounded-circle ms-1" id="NbrPaiementDone">0</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <div class="tab-content text-muted">
                                                <div class="tab-pane active" id="nav-border-top-paiement_dus" role="tabpanel">
                                                    <div class="table-responsive">
                                                        <table class="table table-hover align-middle table-nowrap mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th scope="col">Label</th>
                                                                    <th scope="col">Date d'echeance</th>
                                                                    <th scope="col">Montant</th>
                                                                    <th scope="col">Restant</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="ListePaiementRequestLine">
                                                                
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="tab-pane" id="nav-border-top-paiements_done" role="tabpanel">
                                                    <div class="table-responsive">
                                                         <table class="table table-hover align-middle table-nowrap mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th scope="col">N° Bon</th>
                                                                    <th scope="col">Label</th>
                                                                    <th scope="col">Montant</th>
                                                                    <th scope="col">Date</th>
                                                                    <th scope="col">Etat</th>
                                                                    <th scope="col">Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="ListePaiementRequestLineDone">
                                                                <!-- Liste des paiements effectuer -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
        </div>

<!-- Modal Confirmation Échéancier -->
<div class="modal fade" id="confirmEcheancierModal" tabindex="-1" aria-labelledby="confirmEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmEcheancierModalLabel">Confirmation de l'échéancier</h5>
                        <p class="text-muted small mb-0">Veuillez confirmer l'échéancier de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                            <i class="ri-check-double-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Confirmer l'échéancier de paiement</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir confirmer cet échéancier ?</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        En confirmant cet échéancier, vous acceptez les termes et conditions associés. Cette action est irréversible.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmEcheancierBtn">
                    <i class="ri-check-line me-2"></i>Confirmer l'échéancier
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de Confirmation -->
<div class="modal fade" id="confirmationDetailsModal" tabindex="-1" aria-labelledby="confirmationDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-text-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="confirmationDetailsModalLabel">Détails de confirmation</h5>
                        <p class="text-muted small mb-0">Récapitulatif de l'échéancier de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Informations de la formation</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Spécialité:</span>
                                    <span class="fw-medium" id="modalSpecialite"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="modalPromo"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Prix de la formation:</span>
                                    <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                </div>
                                <div class="d-flex justify-content-between" id="modalPrixFinalRow" style="display: none;">
                                    <span class="text-muted">Prix final (avec réduction):</span>
                                    <span class="fw-bold text-success" id="modalPrixFinal"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Échéancier de paiement</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Libellé</th>
                                                <th>Date d'échéance</th>
                                                <th>Montant</th>
                                                <th id="modalPrixFinalHeader" style="display: none;">Prix final</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalEcheancesTable">
                                            <!-- Échéances seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En confirmant ces informations, l'échéancier sera définitivement enregistré dans le système.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="finalConfirmBtn">
                    <i class="ri-check-double-line me-2"></i>Confirmer définitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Échéancier Spécial -->
<div class="modal fade" id="specialEcheancierModal" tabindex="-1" aria-labelledby="specialEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-star-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="specialEcheancierModalLabel">Échéancier spécial</h5>
                        <p class="text-muted small mb-0">Générez un échéancier personnalisé</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card border border-primary card-equal-height">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0 text-primary">Informations de la formation</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Spécialité:</span>
                                    <span class="fw-medium" id="modalSpecialite"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="modalPromo"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Prix de la formation:</span>
                                    <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card border border-warning card-equal-height">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h6 class="mb-0 text-warning">Configuration de l'échéancier</h6>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="mb-3">
                                    <label for="nombreTranches" class="form-label fw-medium">Nombre de tranches</label>
                                    <input type="number" class="form-control border-0 bg-light py-2" id="nombreTranches" min="1" value="3">
                                </div>
                                <div class="mt-auto">
                                    <button class="btn btn-warning w-100" id="genererTranchesBtn">
                                        <i class="ri-refresh-line me-1"></i>Générer les tranches
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Échéancier généré</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0 echeancier-special-table">
                                        <thead>
                                            <tr>
                                                <th>Tranche</th>
                                                <th>Pourcentage</th>
                                                <th>Montant</th>
                                                <th>Date d'échéance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="specialEcheancierTable">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-4">
                                                    <i class="ri-information-line me-2"></i>
                                                    Veuillez générer les tranches en cliquant sur le bouton ci-dessus
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot id="specialEcheancierFooter">
                                            <tr class="total-row">
                                                <td><strong>Total</strong></td>
                                                <td id="totalPercentage">0%</td>
                                                <td id="totalAmount">0 DA</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div id="percentageWarning" class="alert alert-info mt-3" role="alert">
                                    <i class="ri-information-line me-2"></i>
                                    <span>Modifiez les pourcentages manuellement. La somme totale peut dépasser ou être inférieure à 100%.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="saveSpecialEcheancierBtn" disabled>
                    <i class="ri-save-line me-2"></i>Enregistrer l'échéancier
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Enregistrement Échéancier Spécial -->
<div class="modal fade" id="confirmSaveEcheancierModal" tabindex="-1" aria-labelledby="confirmSaveEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-alert-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="confirmSaveEcheancierModalLabel">Confirmation d'enregistrement</h5>
                        <p class="text-muted small mb-0">Échéancier spécial</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-warning bg-opacity-10 text-warning display-5 rounded-circle">
                            <i class="ri-file-warning-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Enregistrer l'échéancier spécial</h5>
                    <p class="text-muted">Vous êtes sur le point d'enregistrer cet échéancier.</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        Cet échéancier sera soumis à validation par un responsable avant d'être définitivement appliqué.
                    </div>
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="confirmValidationCheck">
                    <label class="form-check-label" for="confirmValidationCheck">
                        Je comprends que cet échéancier nécessite une validation
                    </label>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning px-4 py-2" id="confirmSaveEcheancierBtn" disabled>
                    <i class="ri-checkbox-circle-line me-2"></i>Confirmer l'enregistrement
                </button>
            </div>
        </div>
    </div>
</div>

<div id="paiementsModal" class="modal fade" tabindex="-1" aria-labelledby="paiementsModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-money-dollar-circle-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="paiementsModalLabel">Enregistrement de paiement</h5>
                        <p class="text-muted small mb-0">Saisissez les détails du paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
               
                <div class="row">
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="due_paiements">Veuillez sélectionner le paiement dû :</label>
                        <select  required class="form-control border-0 bg-light py-2" id="due_paiements" >

                        </select>
                    </div>
                     <div class="col-lg-4">
                        <label class="form-label fw-medium" for="date_paiement">Date de paiement :</label>
                        <input type="date" required class="form-control border-0 bg-light py-2" id="date_paiement" />
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="received_amount">Montant reçu :</label>
                        <input type="text" required class="form-control border-0 bg-light py-2" id="received_amount" />
                    </div>
                </div> 
                <div class="row mt-2">
                    <div class="col-lg-6">
                        <label class="form-label fw-medium" for="paiement_mode">Mode de paiement:</label>
                        <select class="form-control border-0 bg-light py-2" id="paiement_mode">
                            <option value="esp">Espèce</option>
                            <option value="che">Chèque</option>
                            <option value="vir">Virement</option>
                        </select>
                    </div>
                     <div class="col-lg-6">
                        <label for="paiement_ref" class="form-label fw-medium">Référence de paiement </label>
                        <input type="text" class="form-control border-0 bg-light py-2" id="paiement_ref" />
                    </div>
                    
                </div>
                <div class="row mt-2 ">
                    <div class="col-lg-12">
                        <label for="observation" class="form-label fw-medium">Observations</label>
                        <textarea class="form-control border-0 bg-light py-2" id="observation"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="StorePaimentBnt">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
       
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="paiementsModalDetails" class="modal fade" tabindex="-1" aria-labelledby="paiementsModalDetailsLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-list-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="paiementsModalDetailsLabel">Détails du paiement</h5>
                        <p class="text-muted small mb-0">Informations détaillées sur le paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
               
                <div class="row">
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="due_paiements">Veuillez sélectionner le paiement dû :</label>
                        <select  required class="form-control border-0 bg-light py-2" id="due_paiements" >

                        </select>
                    </div>
                     <div class="col-lg-4">
                        <label class="form-label fw-medium" for="date_paiement">Date de paiement :</label>
                        <input type="date" required class="form-control border-0 bg-light py-2" id="date_paiement" />
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="received_amount">Montant reçu :</label>
                        <input type="text" required class="form-control border-0 bg-light py-2" id="received_amount" />
                    </div>
                </div> 
                <div class="row mt-2">
                    <div class="col-lg-6">
                        <label class="form-label fw-medium" for="paiement_mode">Mode de paiement:</label>
                        <select class="form-control border-0 bg-light py-2" id="paiement_mode">
                            <option value="esp">Espèce</option>
                            <option value="che">Chèque</option>
                            <option value="vir">Virement</option>
                        </select>
                    </div>
                     <div class="col-lg-6">
                        <label for="paiement_ref" class="form-label fw-medium">Référence de paiement </label>
                        <input type="text" class="form-control border-0 bg-light py-2" id="paiement_ref" />
                    </div>
                    
                </div>
                <div class="row mt-2 ">
                    <div class="col-lg-12">
                        <label for="observation" class="form-label fw-medium">Observations</label>
                        <textarea class="form-control border-0 bg-light py-2" id="observation"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="StorePaimentBnt">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
       
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-body text-center p-5">
                        <div class="avatar-lg mx-auto mb-4">
                            <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                                <i class="ri-close-circle-line"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="mb-3">Vous étes sur le point de supprimer le paiement</h4>
                            <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                            <div class="hstack gap-2 justify-content-center">
                                
                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade refundModal" tabindex="-1" role="dialog" aria-labelledby="refundModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-body text-center p-5">
                        <div class="avatar-lg mx-auto mb-4">
                            <div class="avatar-title bg-warning bg-opacity-10 text-warning display-5 rounded-circle">
                                <i class="ri-refund-line"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="mb-3">Vous étes sur le point de faire une demande de rembourssement</h4>
                            <p class="text-muted mb-4">La demande de remboussement doit être valider par un compe de niveau supérieur. </p>
                            <div class="hstack gap-2 justify-content-center">
                                
                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal Détails du Client -->
<div class="modal fade" id="clientDetailsModal" tabindex="-1" aria-labelledby="clientDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-2 p-2 me-2">
                        <i class="ri-user-line text-primary fs-5"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-0" id="clientDetailsModalLabel">Détails du client</h5>
                        <p class="text-muted small mb-0 fs-6">Informations sur le demandeur</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="text-center">
                            <div class="avatar-md mx-auto mb-3">
                                <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle">
                                    <i class="ri-user-line"></i>
                                </div>
                            </div>
                            <h6 class="mb-0" id="clientFullName"></h6>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card border border-primary">
                            <div class="card-header bg-primary bg-opacity-10 py-1 px-2">
                                <h6 class="mb-0 text-primary fs-6">Informations personnelles</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0 small">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Email</td>
                                                <td id="clientEmail"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Téléphone</td>
                                                <td id="clientPhone"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Adresse</td>
                                                <td id="clientAddress"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Date de naissance</td>
                                                <td id="clientBirthDate"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Lieu de naissance</td>
                                                <td id="clientBirthPlace"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-3 py-2">
                <button type="button" class="btn btn-sm btn-light px-3 py-1" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de la Réduction -->
<div class="modal fade" id="reductionDetailsModal" tabindex="-1" aria-labelledby="reductionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-coupon-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="reductionDetailsModalLabel">Détails de la réduction</h5>
                        <p class="text-muted small mb-0">Informations sur la réduction applicable</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="card border border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h6 class="mb-0 text-warning">Réduction disponible</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted">Type de réduction</td>
                                        <td id="reductionType">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Montant de la réduction</td>
                                        <td id="reductionAmount">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Prix initial</td>
                                        <td id="initialPrice">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Prix après réduction</td>
                                        <td id="finalPrice">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <span>En appliquant cette réduction, le prix de la formation sera mis à jour automatiquement.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="applyReductionBtn">
                    <i class="ri-check-line me-2"></i>Appliquer la réduction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails Échéancier Spécial -->
<div class="modal fade" id="echeancierSpecialDetailsModal" tabindex="-1" aria-labelledby="echeancierSpecialDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-2 p-2 me-2">
                        <i class="ri-star-line text-primary fs-5"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-0" id="echeancierSpecialDetailsModalLabel">Détails de l'échéancier spécial</h5>
                        <p class="text-muted small mb-0 fs-6">Informations sur l'échéancier personnalisé</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10 py-1 px-2">
                                <h6 class="mb-0 text-success fs-6">Détail des tranches</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0 small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tranche</th>
                                                <th>Pourcentage</th>
                                                <th>Montant</th>
                                                <th>Date d'échéance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="echeancierSpecialLinesTable">
                                            <!-- Les lignes seront chargées dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3 py-2 px-2" role="alert">
                    <i class="ri-information-line me-1"></i>
                    <span class="small">Cet échéancier spécial a été créé pour répondre aux besoins spécifiques du client. Vous pouvez l'appliquer à cette demande de paiement.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-3 py-2">
                <button type="button" class="btn btn-sm btn-light px-3 py-1" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
                <button type="button" class="btn btn-sm btn-success px-3 py-1" id="applyEcheancierSpecialBtn">
                    <i class="ri-check-line me-1"></i>Appliquer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails Échéancier Spécial en Examen (sans bouton Appliquer) -->
<div class="modal fade" id="echeancierExamenDetailsModal" tabindex="-1" aria-labelledby="echeancierExamenDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-2 p-2 me-2">
                        <i class="ri-time-line text-warning fs-5"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-0" id="echeancierExamenDetailsModalLabel">Échéancier en cours d'examen</h5>
                        <p class="text-muted small mb-0 fs-6">Détails de l'échéancier en attente de validation</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2">
                <div class="row mb-2">
                    <div class="col-12">
                        <div class="card border border-warning">
                            <div class="card-header bg-warning bg-opacity-10 py-1 px-2">
                                <h6 class="mb-0 text-warning fs-6">Informations générales</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0 smaller">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Client</td>
                                                <td id="echeancierExamenClientName">-</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Formation</td>
                                                <td id="echeancierExamenFormation">-</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Nombre de tranches</td>
                                                <td id="echeancierExamenNombreTranches">-</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Date de création</td>
                                                <td id="echeancierExamenDateCreation">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10 py-1 px-2">
                                <h6 class="mb-0 text-success fs-6">Détail des tranches</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle table-nowrap mb-0 smaller">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tranche</th>
                                                <th>Pourcentage</th>
                                                <th>Montant</th>
                                                <th>Date d'échéance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="echeancierExamenLinesTable">
                                            <!-- Les lignes seront chargées dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-2 py-2 px-2" role="alert">
                    <i class="ri-time-line me-1"></i>
                    <span class="small">Cet échéancier spécial est actuellement en cours d'examen et en attente de validation. Vous ne pouvez pas l'appliquer tant qu'il n'a pas été approuvé.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-2 py-1">
                <button type="button" class="btn btn-sm btn-light px-2 py-1" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Application Échéancier Spécial -->
<div class="modal fade" id="confirmApplyEcheancierSpecialModal" tabindex="-1" aria-labelledby="confirmApplyEcheancierSpecialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="confirmApplyEcheancierSpecialModalLabel">Confirmation d'application</h5>
                        <p class="text-muted small mb-0">Échéancier spécial</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                            <i class="ri-star-line"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <h5>Appliquer l'échéancier spécial</h5>
                    <p class="text-muted">Êtes-vous sûr de vouloir appliquer cet échéancier spécial à la demande de paiement ?</p>
                </div>
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <div>
                        En confirmant, cet échéancier spécial remplacera l'échéancier standard actuel.
                    </div>
                </div>
               
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmApplyEcheancierSpecialBtn">
                    <i class="ri-check-line me-2"></i>Appliquer l'échéancier
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aide Échéancier -->
<div class="modal fade" id="aideEcheancierModal" tabindex="-1" aria-labelledby="aideEcheancierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-question-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="aideEcheancierModalLabel">Aide - Échéancier de paiement</h5>
                        <p class="text-muted small mb-0">Explication des fonctionnalités</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Fonctionnalités des boutons</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center">
                                            <i class="ri-check-line text-success"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-success">Bouton "Confirmer"</h6>
                                        <p class="mb-0">Valide l'échéancier standard actuel et le marque comme confirmé dans le système.</p>
                                    </div>
                                </div>
                                
                                <div class="d-flex">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm bg-warning bg-opacity-10 rounded icon-center">
                                            <i class="ri-star-line text-warning"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold text-warning">Bouton "Spécial"</h6>
                                        <p class="mb-0">Permet de créer un échéancier personnalisé avec des tranches modifiables selon les besoins spécifiques.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <span>Un échéancier doit être confirmé avant de pouvoir enregistrer des paiements.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-info px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Paiement -->
<div class="modal fade" id="nouveauPaiementModal" tabindex="-1" aria-labelledby="nouveauPaiementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary px-4 py-3" style="background: linear-gradient(135deg, #3b7ddd 0%, #1a56b0 100%) !important;">
                <div class="d-flex align-items-center">
                    <div class="modal-icon rounded-3 p-3 me-3" style="background-color: rgba(255, 255, 255, 0.2) !important;">
                        <i class="ri-money-dollar-circle-line text-white fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-white mb-1" id="nouveauPaiementModalLabel">Enregistrement de paiement</h5>
                        <p class="text-white text-opacity-75 small mb-0">Saisissez les détails du nouveau paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="card border" style="border-color: rgba(59, 125, 221, 0.2) !important; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;">
                            <div class="card-header py-2" style="background-color: rgba(59, 125, 221, 0.1) !important;">
                                <h6 class="mb-0 fw-semibold" style="color: #3b7ddd !important;">Détails du paiement</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-medium" for="echeancierSelection">Échéance à payer <span class="text-danger">*</span></label>
                                    <select class="form-select border-0 py-2" id="echeancierSelection" required style="background-color: #f8f9fa !important;">
                                        <option value="">Sélectionnez une échéance</option>
                                        <!-- Les options seront remplies dynamiquement -->
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="datePaiement">Date de paiement <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control border-0 py-2" id="datePaiement" required style="background-color: #f8f9fa !important;" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="montantPaiement">Montant <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="number" class="form-control border-0 py-2" id="montantPaiement" step="0.01" min="0" required style="background-color: #f8f9fa !important;" />
                                            <span class="input-group-text border-0" style="background-color: rgba(59, 125, 221, 0.1) !important;">DA</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="modePaiement">Mode de paiement <span class="text-danger">*</span></label>
                                        <select class="form-select border-0 py-2" id="modePaiement" required style="background-color: #f8f9fa !important;">
                                            <option value="">Sélectionnez un mode</option>
                                            <option value="esp">Espèce</option>
                                            <option value="che">Chèque</option>
                                            <option value="vir">Virement</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-medium" for="referencePaiement">Référence de paiement</label>
                                        <input type="text" class="form-control border-0 py-2" id="referencePaiement" placeholder="N° chèque, virement, etc." style="background-color: #f8f9fa !important;" />
                                    </div>
                                </div>
                                
                                <div class="mb-0">
                                    <label class="form-label fw-medium" for="observationPaiement">Observations</label>
                                    <textarea class="form-control border-0 py-2" id="observationPaiement" rows="2" placeholder="Informations supplémentaires..." style="background-color: #f8f9fa !important;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-5">
                        <div class="card border h-100" style="border-color: rgba(40, 167, 69, 0.2) !important; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;">
                            <div class="card-header py-2" style="background-color: rgba(40, 167, 69, 0.1) !important;">
                                <h6 class="mb-0 fw-semibold" style="color: #28a745 !important;">Résumé de la transaction</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Échéance sélectionnée:</span>
                                    <span class="fw-medium" id="resumeEcheance">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Date de paiement:</span>
                                    <span class="fw-medium" id="resumeDate">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Montant:</span>
                                    <span class="fw-bold fs-5" style="color: #3b7ddd !important;" id="resumeMontant">0.00 DA</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Mode de paiement:</span>
                                    <span class="fw-medium" id="resumeMode">-</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Référence:</span>
                                    <span class="fw-medium" id="resumeReference">-</span>
                                </div>
                                
                                <div class="alert" role="alert" style="background-color: rgba(23, 162, 184, 0.1) !important; border-color: rgba(23, 162, 184, 0.2) !important;">
                                    <i class="ri-information-line me-2" style="color: #17a2b8 !important;"></i>
                                    <span class="small" style="color: #17a2b8 !important;">Vérifiez attentivement les informations avant d'enregistrer le paiement.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2 rounded-pill" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary px-4 py-2 rounded-pill" id="enregistrerPaiementBtn">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Engagement -->
<div class="modal fade" id="engagementModal" tabindex="-1" aria-labelledby="engagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="engagementModalLabel">Engagement de l'étudiant</h5>
                        <p class="text-muted small mb-0">Confirmation de prise de connaissance des échéances de paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">Informations de l'étudiant</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Nom de l'étudiant:</span>
                                    <span class="fw-medium" id="engagementStudentName"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Formation:</span>
                                    <span class="fw-medium" id="engagementFormation"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Promo:</span>
                                    <span class="fw-medium" id="engagementPromo"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card border border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0 text-info">Échéances de paiement</h6>
                            </div>
                            <div class="card-body">
                                <p>Je soussigné(e), <strong id="engagementStudentName2"></strong>, déclare avoir pris connaissance des échéances de paiement ci-dessous et m'engage à les respecter:</p>
                                
                                <ul class="list-group list-group-flush" id="engagementPaymentsList">
                                    <!-- Les paiements seront chargés ici dynamiquement -->
                                </ul>
                                
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="engagementConfirmationCheck">
                                    <label class="form-check-label" for="engagementConfirmationCheck">
                                        Je confirme avoir lu et compris les conditions de paiement
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" role="alert">
                    <i class="ri-alert-line me-2"></i>
                    <span>En cochant la case de confirmation, vous acceptez les termes et conditions associés aux échéances de paiement. Cette action est irréversible.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmEngagementBtn" disabled>
                    <i class="ri-check-line me-2"></i>Confirmer l'engagement
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    
    
    $(document).ready(function(){
        
        var id_demande = "{{pk}}";
        var prixFormation = 0.00;
        var prixFormationReduction = 0.00;
        let hasReduction =  false;
        let reductionApprouved = false;
        var clientId = null; // Variable to store client ID
        let has_special_echeancier = false;
        let specialEcheancierState = false;
        
       
        function HideReducNotif(){
           
            let notif = document.getElementById("reductionNotification");
            let appliedRedu = document.getElementById('reductionSuccessNotification');
            
            if (reductionApprouved){
                appliedRedu.style.display = "flex";

            }else if (hasReduction && !reductionApprouved) {
                 notif.style.display = "flex";  
            }else {
                notif.style.display = "none";
            }

           
        }

        function HideSpecialEcheancierNotif(){
            let special_notif = document.getElementById('echeancierSpecialNotification');
            let exam_special_notif = document.getElementById('echeancierExamenNotification');
            let btn = document.getElementById("specialBoutonConf");

            console.log(typeof specialEcheancierState, specialEcheancierState); 

             if (has_special_echeancier && specialEcheancierState === false ){
                    special_notif.style.setProperty("display", "none", "important"); 
                    exam_special_notif.style.setProperty("display", "flex", "important");
                    btn.disabled = true;
                    
                } else {
                    special_notif.style.setProperty("display", "flex", "important");
                    exam_special_notif.style.setProperty("display", "none", "important");
                    btn.disabled = true;
                    btn.title = ""; // enlever le message

                }   
        }
    
        // Add a global variable to store payment data
        var paymentData = {};
        
        // Function to calculate and update payment summary
        function updatePaymentSummary() {
            // Calculate total due
            var totalDue = 0;
            $('#echeancierTable tr').each(function() {
                var montantText = $(this).find('td:eq(2) span.fw-bold').text();
                if (montantText) {
                    var montant = parseFloat(montantText.replace(' DA', '').replace(/\s/g, '')) || 0;
                    totalDue += montant;
                }
            });

            // Calculate total paid
            var totalPaid = 0;
            $('#ListePaiementRequestLineDone tr').each(function() {
                var montantText = $(this).find('td:eq(2)').text();
                if (montantText) {
                    var montant = parseFloat(montantText.replace(' DA', '').replace(/\s/g, '')) || 0;
                    totalPaid += montant;
                }
            });

            // Calculate balance
            var balance = totalDue - totalPaid;

            // Update the summary display
            $('#totalDueAmount').text(totalDue.toFixed(2) + ' DA');
            $('#totalPaidAmount').text(totalPaid.toFixed(2) + ' DA');
            $('#balanceAmount').text(balance.toFixed(2) + ' DA');
        }
        
        // Update payment summary whenever tables are modified
        $(document).on('DOMSubtreeModified', '#echeancierTable, #ListePaiementRequestLineDone', function() {
            setTimeout(updatePaymentSummary, 100); // Small delay to ensure DOM is updated
        });
        
        function loadDatas(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiGetDetailsDemandePaiement' %}",
                dataType: 'JSON',
                type : 'GET',
                data : {'id_demande' : id_demande},
                success : function(data){
                    // Informations du demandeur
                    $('#demandeur').text(data.user_data.demandeur_nom+" "+data.user_data.demandeur_prenom);
                    $('#created_at').text(data.user_data.created_at.split('T')[0]);
                    $('#motif').text(data.user_data.motif);

                    const createdAt = new Date(data.user_data.created_at);
                    const date_frais_inscription = createdAt.toISOString().split('T')[0];
                    
                    // Store client ID
                    clientId = data.user_data.client_id;
                    $('#clientIdInput').val(clientId);

                    // Informations du client pour la modale
                    $('#clientFullName').text(data.user_data.demandeur_nom+" "+data.user_data.demandeur_prenom);
                    $('#clientEmail').text(data.user_data.email || 'Non spécifié');
                    $('#clientPhone').text(data.user_data.telephone || 'Non spécifié');
                    $('#clientAddress').text(data.user_data.adresse || 'Non spécifié');
                    $('#clientBirthDate').text(data.user_data.date_naissance || 'Non spécifié');
                    $('#clientBirthPlace').text(data.user_data.lieu_naissance || 'Non spécifié');
                    
                    // Informations sur la formation
                    $('#specialite').text(data.voeux.specialite_label);
                    $('#promo').text(data.voeux.promo);
                    $('#prix_formation').text(data.voeux.prix_formation + " DA");
                    
                    // Stocker le prix de la formation pour le modal spécial
                    prixFormation = data.voeux.prix_formation;
                    
                    // Charger les échéanciers
                    var echeancierHtml = "";
                    
                    // Ajouter les frais d'inscription comme première ligne si > 0
                    if (data.voeux.frais_inscription > 0) {
                        echeancierHtml += '<tr>';
                        echeancierHtml += '<td><span class="badge bg-info">Frais d\'inscription</span></td>';
                        echeancierHtml += '<td>'+date_frais_inscription+'</td>';
                        echeancierHtml += '<td><span class="fw-bold">' + parseFloat(data.voeux.frais_inscription).toFixed(2) + ' DA</span></td>';
                        
                        echeancierHtml += '</tr>';
                    }
                    
                    if(data.remise){
                       
                        $('#applyReductionBtn').data('id', data.remise.id_applied_reduction);
                       
                        hasReduction = true;
                        

                        prixFormationReduction = parseFloat(prixFormation-(prixFormation*(data.remise.valeur/100)));

                        $('#reductionType').text(data.remise.type_remise);
                        $('#reductionAmount').text(data.remise.valeur+" %");
                        $('#initialPrice').text(prixFormation);
                        $('#finalPrice').text(parseFloat(prixFormationReduction));
                        
                        if (data.remise.remise_approuver){
                            reductionApprouved = true;
                            
                            $('#prixFinalHeader').show();
                            $('[id^=prixFinal]').show();
                        }else{
                            reductionApprouved = false;
                        }          
                        
                        HideReducNotif();

                       
                    }

                    if(data.has_special_echeancier){
                        has_special_echeancier = true;
                        specialEcheancierState = data.echeancier_special_state_approuvel;
                       

                        HideSpecialEcheancierNotif();
                        var rowSpecial = "";
                        $.each(data.special_echeancier_line, function(index, item){
                            rowSpecial += "<tr>";
                            rowSpecial += "<td>"+item.value+"</td>";
                            rowSpecial += "<td>"+item.taux+"%</td>";
                            rowSpecial += "<td>"+item.montant_tranche+" DZD</td>";
                            rowSpecial += "<td>"+item.date_echeancier+"</td>";
                            rowSpecial += "</tr>";
                        });
                        $('#echeancierSpecialLinesTable').html(rowSpecial);
                    }

                    if(data.has_due_paiement){
                        document.getElementById('idBtnConfirmeEcheancierModal').disabled = true;
                        
                        
                        // Afficher les paiements dus
                        var duePaiementHtml = "";
                        var duePaiementCount = 0;
                        
                        $.each(data.due_paiement_data, function(index, item){
                            duePaiementCount++;
                            duePaiementHtml += '<tr>';
                            duePaiementHtml += '<td hidden>' + item.id_due_paiement + '</td>';
                            duePaiementHtml += '<td>' + item.label + '</td>';
                            duePaiementHtml += '<td>' + item.date_echeance + '</td>';
                            duePaiementHtml += '<td>' + parseFloat(item.montant_due).toFixed(2) + ' DA</td>';
                            duePaiementHtml += '<td>' + parseFloat(item.montant_due).toFixed(2) + ' DA</td>';
                            duePaiementHtml += '</tr>';
                        });
                        
                        $('#ListePaiementRequestLine').html(duePaiementHtml);
                        $('#NbrPaiementDue').text(duePaiementCount);
                    } else {
                        // Masquer le bouton d'engagement s'il n'y a pas de paiements dus
                       
                        $('#ListePaiementRequestLine').html('<tr><td colspan="4" class="text-center">Aucun paiement dû</td></tr>');
                        $('#NbrPaiementDue').text('0');
                    }
                    
                    // Ajouter les autres échéances
                    $.each(data.echeancier, function(index, echeance){
                        var label = "Tranche " + (index + 1);
                        
                        echeancierHtml += '<tr>';
                        echeancierHtml += '<td><span class="badge bg-primary">' + label + '</span></td>';
                        echeancierHtml += '<td>' + (echeance.date_echeancier ? echeance.date_echeancier : '') + '</td>';
                        echeancierHtml += '<td><span class="fw-bold">' + echeance.montant_tranche + ' DA</span></td>';
                        if(hasReduction && reductionApprouved) {
                            var montantReduction = parseFloat(echeance.montant_tranche - (echeance.montant_tranche * (data.remise.valeur/100)));
                            echeancierHtml += '<td id="prixFinalTranche' + index + '" style="display: table-cell;"><span class="fw-bold text-success">' + montantReduction.toFixed(2) + ' DA</span></td>';
                        }
                        echeancierHtml += '</tr>';
                    });


                    if(data.has_paiement){
                        var row = "";
                        var count = data.paiements_done_data.length;
                        
                        // Store payment data for later use
                        paymentData = {};
                        $.each(data.paiements_done_data, function(index, item){
                            // Store payment data with payment number as key
                            paymentData[item.num] = {
                                num: item.num,
                                montant_paye: item.montant_paye,
                                date_paiement: item.date_paiement,
                                mode_paiement: item.mode_paiement || 'Non spécifié',
                                reference: item.reference || 'Non spécifié'
                            };
                            
                            row += "<tr>";
                            row += "<td>"+item.num+"</td>";
                            row += "<td></td>";
                            row += "<td>"+item.montant_paye+"</td>";
                            row += "<td>"+item.date_paiement+"</td>";
                            row += "<td></td>"; // État column
                            row += "<td>";
                            row += "<button class='btn btn-sm btn-primary me-1 print-quittance-btn' data-id='"+item.num+"'>";
                            row += "<i class='ri-file-text-line'></i> Quittance";
                            row += "</button>";
                            row += "<button class='btn btn-sm btn-success print-facture-btn' data-id='"+item.num+"'>";
                            row += "<i class='ri-printer-line'></i> Facture";
                            row += "</button>";
                            row += "</td>";
                            row += "</tr>";
                        });
                        $('#NbrPaiementDone').text(count);
                        $('#ListePaiementRequestLineDone').html(row);
                    }
                    
                    $('#echeancierTable').html(echeancierHtml);
                 

                },
            });
        }

        loadDatas();
        

        // Gestion du bouton de changement de modèle d'échéancier
        $(document).on('click', '#changeEcheancierModel', function(){
            alert("Fonctionnalité de changement de modèle d'échéancier - à implémenter");
        });
        
        
        $(document).on('click', '#confirmEcheancierBtn', function(){
            // Remplir la modale avec les informations actuelles
            $('#modalSpecialite').text($('#specialite').text());
            $('#modalPromo').text($('#promo').text());
            $('#modalPrixFormation').text($('#prix_formation').text());
            
            // Vérifier s'il y a une réduction et mettre à jour l'affichage
            if (hasReduction && reductionApprouved) {
                $('#modalPrixFormation').text($('#initialPrice').text() + ' DA');
                $('#modalPrixFinalRow').show();
                $('#modalPrixFinal').text($('#finalPrice').text() + ' DA');
                // Afficher la colonne Prix final dans le tableau
                $('#modalPrixFinalHeader').show();
            } else {
                $('#modalPrixFinalRow').hide();
                // Masquer la colonne Prix final dans le tableau
                $('#modalPrixFinalHeader').hide();
            }
            
            // Remplir le tableau des échéances dans la modale
            var echeancesHtml = '';
            $('#echeancierTable tr').each(function(index) {
                var libelle = $(this).find('td:eq(0)').text();
                var date = $(this).find('td:eq(1)').text();
                var montant = $(this).find('td:eq(2)').text();
                
                echeancesHtml += '<tr>';
                echeancesHtml += '<td>' + libelle + '</td>';
                echeancesHtml += '<td>' + date + '</td>';
                echeancesHtml += '<td>' + montant + '</td>';
                
                // Ajouter le prix final si une réduction est appliquée
                if (hasReduction && reductionApprouved) {
                    var prixReduitElement = $(this).find('td:eq(3)');
                    if (prixReduitElement.length > 0) {
                        var prixReduit = prixReduitElement.text();
                        echeancesHtml += '<td>' + prixReduit + '</td>';
                    }
                }
                
                echeancesHtml += '</tr>';
            });
            $('#modalEcheancesTable').html(echeancesHtml);
            
            // Afficher la modale
            $('#confirmEcheancierModal').modal('hide');
            $('#confirmationDetailsModal').modal('show');
        });
        
        // Pré-remplir les informations dans le modal spécial
        $('#specialEcheancierModal').on('show.bs.modal', function () {
            $('#modalSpecialite').text($('#specialite').text());
            $('#modalPromo').text($('#promo').text());
            $('#modalPrixFormation').text($('#prix_formation').text());
        });
        
        // Générer les tranches
        $(document).on('click', '#genererTranchesBtn', function(){
            var nombreTranches = parseInt($('#nombreTranches').val());
            var prix = parseFloat(prixFormation);
            
            if (isNaN(nombreTranches) || nombreTranches <= 0) {
                alert("Veuillez entrer un nombre de tranches valide");
                return;
            }
            
            if (isNaN(prix) || prix <= 0) {
                alert("Prix de formation invalide");
                return;
            }
            
            var html = '';
            var pourcentageParTranche = (100 / nombreTranches).toFixed(2);
            
            // Initialiser le tableau des pourcentages précédents
            previousPercentages = [];
            
            for (var i = 1; i <= nombreTranches; i++) {
                var montant = (prix * (pourcentageParTranche / 100)).toFixed(2);
                previousPercentages.push(parseFloat(pourcentageParTranche));
                html += '<tr>';
                html += '<td class="tranche-cell-special"><span class="badge bg-warning">Tranche ' + i + '</span></td>';
                html += '<td><div class="d-flex align-items-center"><input type="number" class="form-control border-0 bg-light py-1 percentage-input" value="' + pourcentageParTranche + '" data-index="' + (i-1) + '" step="0.01" min="0" style="width: 80px;"><span class="ms-1">%</span></div></td>';
                html += '<td class="montant-cell">' + montant + ' DA</td>';
                html += '<td><input type="date" class="form-control border-0 bg-light py-1" style="width: 150px;"></td>';
                html += '</tr>';
            }
            
            $('#specialEcheancierTable').html(html);
            $('#saveSpecialEcheancierBtn').prop('disabled', false);
            
            // Calculer les totaux initiaux
            calculateTotals();
        });
        
        // Mise à jour manuelle des pourcentages sans recalcul des autres
        $(document).on('input', '.percentage-input', function(){
            var $this = $(this);
            var newPercentage = parseFloat($this.val()) || 0;
            var prix = parseFloat(prixFormation) || 0;
            
            // Mettre à jour le montant pour l'élément modifié
            updateMontant($this, newPercentage, prix);
            
            // Recalculer les totaux
            calculateTotals();
        });
        
        // Fonction pour mettre à jour le montant
        function updateMontant($input, percentage, prix) {
            var montant = (prix * (percentage / 100)).toFixed(2);
            $input.closest('tr').find('.montant-cell').text(montant + ' DA');
        }
        
        // Fonction pour calculer les totaux
        function calculateTotals() {
            var totalPercentage = 0;
            var totalAmount = 0;
            var prix = parseFloat(prixFormation) || 0;
            
            // Calculer les totaux
            $('.percentage-input').each(function(){
                var percentage = parseFloat($(this).val()) || 0;
                totalPercentage += percentage;
                totalAmount += (prix * (percentage / 100));
            });
            
            // Mettre à jour les totaux dans le footer
            $('#totalPercentage').text(totalPercentage.toFixed(2) + '%');
            $('#totalAmount').text(totalAmount.toFixed(2) + ' DA');
            
            // Activer/désactiver le bouton d'enregistrement (toujours activé maintenant)
            $('#saveSpecialEcheancierBtn').prop('disabled', false);
        }
        
        // Ouvrir la modale de confirmation lors du clic sur "Enregistrer l'échéancier"
        $(document).on('click', '#saveSpecialEcheancierBtn', function(){
            $('#confirmSaveEcheancierModal').modal('show');
        });
        
        // Gérer la case à cocher de confirmation
        $(document).on('change', '#confirmValidationCheck', function(){
            if ($(this).is(':checked')) {
                $('#confirmSaveEcheancierBtn').prop('disabled', false);
            } else {
                $('#confirmSaveEcheancierBtn').prop('disabled', true);
            }
        });
        
        // Confirmer l'enregistrement de l'échéancier
        $(document).on('click', '#confirmSaveEcheancierBtn', function(){
            // Collect data from the special echeancier table
            var echeancierLines = [];
            var isValid = true;
            
            $('#specialEcheancierTable tr').each(function() {
                var $row = $(this);
                var taux = $row.find('.percentage-input').val();
                var nom_tranche = $row.find('.tranche-cell-special').text();
                var montant = $row.find('.montant-cell').text().replace(' DA', '');
                var date = $row.find('input[type="date"]').val();
                
                // Validate required fields
                if (!taux || !montant || !date) {
                    isValid = false;
                    return false; // Break the loop
                }
                
                echeancierLines.push({
                    taux: taux,
                    value: nom_tranche, // We don't have this value in the UI, so leave it empty
                    montant_tranche: montant,
                    date_echeancier: date
                });
            });
            
            if (!isValid) {
                alert("Veuillez remplir tous les champs pour chaque tranche.");
                return;
            }
            
            // Get other required data
            var prospectId = clientId; // Use the stored client ID
            var nombreTranches = $('#nombreTranches').val();
            
            // Prepare data for API call
            var data = {
                prospect_id: prospectId,
                nombre_tranches: nombreTranches,
                echeancier_lines: echeancierLines
            };
            
            // Get CSRF token
            var csrftoken = $('input[name=csrfmiddlewaretoken]').val();
            
            // Call API to save echeancier
            $.ajax({
                url: "{% url 't_tresorerie:ApiStoreEcheancierSpecial' %}",
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.status === 'success') {
                        alert("Échéancier spécial enregistré avec succès !");
                        $('#confirmSaveEcheancierModal').modal('hide');
                        $('#specialEcheancierModal').modal('hide');
                        loadDatas();
                    } else {
                        alert("Erreur: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erreur lors de l'enregistrement:", error);
                    alert("Erreur lors de l'enregistrement de l'échéancier spécial.");
                }
            });
        });
        
        // Confirmation définitive de l'échéancier
        $(document).on('click', '#finalConfirmBtn', function(){
            // Récupérer les données nécessaires
            var id_demande = "{{pk}}";
            
            // Collecter les données de l'échéancier configuré
            var echeancierData = [];
            $('#echeancierTable tr').each(function() {
                var libelle = $(this).find('td:eq(0)').text().trim();
                var date = $(this).find('td:eq(1)').text().trim();
                var montant = $(this).find('td:eq(2)').text().trim().replace(' DA', '');
                
                var montantFinal = montant; 
                if (hasReduction && $(this).find('td:eq(3)').length > 0) {
                    montantFinal = $(this).find('td:eq(3)').text().trim().replace(' DA', '');
                }
                
                // Ne pas ajouter les lignes vides
                if (libelle && montant) {
                    echeancierData.push({
                        'libelle': libelle,
                        'date_echeance': date,
                        'montant': montant,
                        'montant_final': montantFinal
                    });
                }
            });
            
            // Appeler l'API pour récupérer les détails du paiement
            $.ajax({
                url: "{% url 't_tresorerie:ApiGetPaiementRequestDetails' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'id_client': clientId,
                    'has_reduction': hasReduction,
                    'reduction': hasReduction ? $('#reductionAmount').text().replace('%', '') : '0',
                    'echeancier_data': JSON.stringify(echeancierData)
                },
                success: function(response) {
                    if(response.status === "success"){
                        alertify.success("Les paiements ont été générer avec succès")
                        $('#confirmationDetailsModal').modal('hide');
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");
                    }
                   
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors de la récupération des détails du paiement:', error);
                    alert('Erreur lors de la récupération des détails du paiement.');
                }
            });
        });

        $(document).on('click','#showEcheancierSpecialDetails', function(){
            $('#echeancierSpecialDetailsModal').modal('show');
        });
        
        $(document).on('click','#showEcheancierExamenDetails', function(){
            // Copier les données du modal d'échéancier spécial vers le modal d'examen
            $('#echeancierExamenClientName').text($('#echeancierClientName').text());
            $('#echeancierExamenFormation').text($('#echeancierFormation').text());
            $('#echeancierExamenNombreTranches').text($('#echeancierNombreTranches').text());
            $('#echeancierExamenDateCreation').text($('#echeancierDateCreation').text());
            
            // Copier les lignes du tableau
            $('#echeancierExamenLinesTable').html($('#echeancierSpecialLinesTable').html());
            
            // Afficher le modal d'examen
            $('#echeancierExamenDetailsModal').modal('show');
        });

        //validation de l'echeancier spécial
        $(document).on('click', '#applyEcheancierSpecialBtn', function(){
            $('#confirmApplyEcheancierSpecialModal').modal('show');
        });
        
        
         // Gestionnaires d'événements pour les boutons d'engagement et d'impression
        $(document).on('click', '#btnEngagement', function(){
            // Vérifier si jsPDF est chargé
            if (typeof window.jspdf === 'undefined') {
                console.error("jsPDF n'est pas chargé");
                alert("Erreur: La bibliothèque PDF n'est pas chargée correctement.");
                return;
            }
            
            // Remplir la modale avec les informations de l'étudiant et les paiements
            var studentName = $('#demandeur').text();
            var formation = $('#specialite').text();
            var promo = $('#promo').text();
            
            // Construire la liste des paiements
            var paymentsList = '';
            $('#ListePaiementRequestLine tr').each(function() {
                var label = $(this).find('td:eq(0)').text();
                var date_echeance = $(this).find('td:eq(1)').text();
                var amount = $(this).find('td:eq(2)').text();
                // Vérifier que la ligne n'est pas vide
                if (label && amount) {
                    paymentsList += '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                                    '<span>' + label + '</span>' +
                                    '<span class="text-muted">' + date_echeance + '</span>' +
                                    '<span class="badge bg-primary rounded-pill">' + amount + '</span>' +
                                    '</li>';
                }
            });
            
            // Mettre à jour le contenu de la modale
            $('#engagementStudentName').text(studentName);
            $('#engagementStudentName2').text(studentName);
            $('#engagementFormation').text(formation);
            $('#engagementPromo').text(promo);
            $('#engagementPaymentsList').html(paymentsList);
            
            // Afficher la modale
            $('#engagementModal').modal('show');
        });
        
        $(document).on('click', '.print-bon-btn', function(){
            var id = $(this).data('id');
            alert("Fonctionnalité d'impression de bon - à implémenter pour le paiement ID: " + id);
        });
             
        
        // Gérer la case à cocher de confirmation d'engagement
        $(document).on('change', '#engagementConfirmationCheck', function(){
            if ($(this).is(':checked')) {
                $('#confirmEngagementBtn').prop('disabled', false);
            } else {
                $('#confirmEngagementBtn').prop('disabled', true);
            }
        });
       

        // Imprimer l'engagement
        $(document).on('click', '#btnPrintEngagement', function(){
            // Récupérer les données de l'étudiant
            var studentName = $('#demandeur').text();
            var formation = $('#specialite').text();
            var promo = $('#promo').text();
            var currentDate = new Date().toLocaleDateString('fr-FR');
            
            // Vérifier qu'on a les données de l'étudiant
            if (!studentName || !formation || !promo) {
                alert("Les informations de l'étudiant ne sont pas complètes.");
                return;
            }
            
            // Récupérer les paiements dus
            var paymentsData = [];
            var hasPayments = false;
            
            $('#ListePaiementRequestLine tr').each(function() {
                var label = $(this).find('td:eq(1)').text().trim();
                var date_echeance = $(this).find('td:eq(2)').text().trim();
                var amount = $(this).find('td:eq(3)').text().trim();
                
                // Vérifier que la ligne n'est pas vide
                if (label && amount && date_echeance) {
                    paymentsData.push({
                        label: label,
                        amount: amount,
                        date_echeance: date_echeance
                    });
                    hasPayments = true;
                }
            });
            
            // Vérifier qu'il y a des paiements
            if (!hasPayments) {
                alertify.error("Veuillez valider l'echéancier de paiement avec de pouvoir proceder a l'impression de l'engagement.");
                return;
            }
            
            // Fonction pour charger jsPDF dynamiquement si nécessaire
            function loadJsPDFLibraries(callback) {
                // Vérifier si jsPDF est déjà disponible
                if (typeof jsPDF !== 'undefined') {
                    callback();
                    return;
                }
                
                // Charger jsPDF
                var script1 = document.createElement('script');
                script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script1.onload = function() {
                    // Charger autoTable
                    var script2 = document.createElement('script');
                    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js';
                    script2.onload = callback;
                    script2.onerror = function() {
                        console.error('Erreur lors du chargement de jsPDF AutoTable');
                        alert("Erreur lors du chargement de la bibliothèque PDF (AutoTable).");
                        callback();
                    };
                    document.head.appendChild(script2);
                };
                script1.onerror = function() {
                    console.error('Erreur lors du chargement de jsPDF');
                    // Si le chargement échoue, utiliser la solution de secours
                    generateTextDocument();
                };
                document.head.appendChild(script1);
            }
            
            
            // Fonction pour générer le PDF
            function generateEngagementPDF() {
                // Vérifier si jsPDF est disponible de différentes manières
                var jsPDFInstance = null;
                
                // Méthode 1: jsPDF direct
                if (typeof jsPDF !== 'undefined') {
                    jsPDFInstance = jsPDF;
                }
                // Méthode 2: window.jspdf.jsPDF
                else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                    jsPDFInstance = window.jspdf.jsPDF;
                }
                // Méthode 3: jspdf.jsPDF
                else if (typeof jspdf !== 'undefined' && typeof jspdf.jsPDF !== 'undefined') {
                    jsPDFInstance = jspdf.jsPDF;
                }
                
                // Si jsPDF est disponible, générer le PDF
                if (jsPDFInstance) {
                    try {
                        // Créer le PDF
                        const doc = new jsPDFInstance();
                        
                        // Ajouter le titre
                        doc.setFontSize(18);
                        doc.text("Engagement de l'étudiant", 105, 20, null, null, 'center');
                        
                        // Ajouter les informations de l'étudiant
                        doc.setFontSize(12);
                        doc.text("Nom de l'étudiant: " + studentName, 20, 40);
                        doc.text("Formation: " + formation, 20, 50);
                        doc.text("Promo: " + promo, 20, 60);
                        doc.text("Date: " + currentDate, 20, 70);
                        
                        // Ajouter le texte d'engagement
                        doc.setFontSize(12);
                        var engagementText = "Je soussigné(e), " + studentName + ", déclare avoir pris connaissance des échéances de paiement ci-dessous et m'engage à les respecter:";
                        doc.text(engagementText, 20, 90, { maxWidth: 170 });
                        
                        // Préparer les données pour le tableau
                        var columns = ["Libellé", "Montant", "Date echeance"];
                        var rows = [];
                        paymentsData.forEach(function(payment) {
                            rows.push([payment.label, payment.amount, payment.date_echeance]);
                        });
                        
                        // Ajouter le tableau des paiements
                        if (typeof doc.autoTable === 'function') {
                            doc.autoTable({
                                head: [columns],
                                body: rows,
                                startY: 100,
                                theme: 'grid'
                            });
                            
                            // Ajouter la signature
                            var finalY = doc.lastAutoTable.finalY || 150;
                            doc.text("Signature de l'étudiant: _______________________", 20, finalY + 20);
                            doc.text("Signature de l'administrateur: ___________________", 20, finalY + 40);
                        } else {
                            // Si autoTable n'est pas disponible, ajouter les paiements manuellement
                            var yPosition = 100;
                            doc.text("Paiements dus:", 20, yPosition);
                            yPosition += 10;
                            
                            rows.forEach(function(row) {
                                doc.text(row[0] + " - Montant: " + row[1] + " - Restant: " + row[2], 20, yPosition);
                                yPosition += 10;
                            });
                            
                            // Ajouter la signature
                            doc.text("Signature de l'étudiant: _______________________", 20, yPosition + 20);
                            doc.text("Signature de l'administrateur: ___________________", 20, yPosition + 40);
                        }
                        
                        // Télécharger le PDF
                        doc.save("engagement_etudiant_" + studentName.replace(/\s+/g, '_') + ".pdf");
                        alertify.success("Document d'engagement généré avec succès !");
                        
                    } catch (error) {
                        console.error("Erreur lors de la génération du PDF:", error);
                        // En cas d'erreur, utiliser la solution de secours
                        if (confirm("Erreur lors de la génération du PDF. Voulez-vous générer un document texte à la place ?")) {
                            generateTextDocument();
                        } else {
                            alert("Erreur lors de la génération du document. Détails: " + error.message);
                        }
                    }
                }
            }
            
            // Générer le document (PDF ou texte)
            generateEngagementPDF();
        }); 


        $(document).on('click', "#applyReductionBtn", function(){
            var remiseId = $(this).data('id');
                      
           
            
            // Faire un appel AJAX pour appliquer la réduction
            $.ajax({
                url: "{% url 't_tresorerie:ApiApplyRemiseToPaiement' %}",
                type: 'POST',
                dataType : "JSON",
                data : {
                    'remiseId' : remiseId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success("La remise a été appliquer avec succès");
                        $('#reductionDetailsModal').modal('hide');
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete.");
                    }
                },
            });
        });
        
        // Gestion de la modale de nouveau paiement
        $('#nouveauPaiementModal').on('show.bs.modal', function () {
            // Charger les échéances dans le dropdown
            var echeancesOptions = '<option value="">Sélectionnez une échéance</option>';
            
            // Parcourir les lignes du tableau des échéances dues
            $('#ListePaiementRequestLine tr').each(function() {
                var id_due_paiement = $(this).find('td:eq(0)').text().trim();
                var label = $(this).find('td:eq(1)').text().trim();
                var date = $(this).find('td:eq(2)').text().trim();
                var montant = $(this).find('td:eq(3)').text().trim();
                var restant = $(this).find('td:eq(4)').text().trim();
                
                // Vérifier que la ligne n'est pas vide
                if (label && montant) {
                    var optionText = label + " - " + montant;
                    if (date) {
                        optionText += " - Échéance: " + date;
                    }
                    echeancesOptions += '<option data-id_due_paiement = "'+ id_due_paiement +'" value="' + label + '" data-montant="' + montant.replace(" DA", "") + '">' + optionText + '</option>';
                }
            });
            
            $('#echeancierSelection').html(echeancesOptions);
            
            // Réinitialiser le résumé
            $('#resumeEcheance').text('-');
            $('#resumeDate').text('-');
            $('#resumeMontant').text('0.00 DA');
            $('#resumeMode').text('-');
            $('#resumeReference').text('-');
        });
        
        // Mettre à jour le montant quand une échéance est sélectionnée
        $(document).on('change', '#echeancierSelection', function(){
            var selectedOption = $(this).find('option:selected');
            var montant = selectedOption.data('montant');
            var id_due_paiement = selectedOption.data('id_due_paiement');
            var label = selectedOption.text();
            
            $('#enregistrerPaiementBtn').data('id',id_due_paiement );
            if (montant) {
                $('#montantPaiement').val(montant);
                // Mettre à jour le résumé
                $('#resumeEcheance').text(label.split(" - Échéance:")[0]);
            }
        });
        
        // Mettre à jour le résumé en temps réel
        $(document).on('change keyup', '#datePaiement', function(){
            var date = $(this).val();
            if (date) {
                var formattedDate = new Date(date).toLocaleDateString('fr-FR');
                $('#resumeDate').text(formattedDate);
            } else {
                $('#resumeDate').text('-');
            }
        });
        
        $(document).on('change keyup', '#montantPaiement', function(){
            var montant = $(this).val();
            if (montant) {
                $('#resumeMontant').text(parseFloat(montant).toFixed(2) + ' DA');
            } else {
                $('#resumeMontant').text('0.00 DA');
            }
        });
        
        $(document).on('change', '#modePaiement', function(){
            var mode = $(this).find('option:selected').text();
            if (mode && mode !== 'Sélectionnez un mode') {
                $('#resumeMode').text(mode);
            } else {
                $('#resumeMode').text('-');
            }
        });
        
        $(document).on('keyup', '#referencePaiement', function(){
            var reference = $(this).val();
            if (reference) {
                $('#resumeReference').text(reference);
            } else {
                $('#resumeReference').text('-');
            }
        });
        
        // Enregistrer le paiement
        $(document).on('click', '#enregistrerPaiementBtn', function(){
            var id_due_paiement = $(this).data('id');
            var echeance = $('#echeancierSelection').val();
            var datePaiement = $('#datePaiement').val();
            var montant = $('#montantPaiement').val();
            var modePaiement = $('#modePaiement').val();
            var reference = $('#referencePaiement').val();
            var observation = $('#observationPaiement').val();
            var clientIdPaiement = $('#clientIdInput').val();
            
            // Validation simple
            if (!echeance || !datePaiement || !montant || !modePaiement) {
                alertify.error("Veuillez remplir tous les champs obligatoires.");
                return;
            }

            $.ajax({
                url : "{% url 't_tresorerie:ApiStoreClientPaiement' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'id_due_paiement' : id_due_paiement,
                    'echeance' : echeance,
                    'datePaiement' : datePaiement,
                    'montant' : montant,
                    'modePaiement' : modePaiement,
                    'reference' : reference,
                    'observation' : observation,
                    'clientId' : clientIdPaiement,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },

                success : function(response){
                    if(response.status === "success"){
                        alertify.success("Le paiement à été enregistrer avec succès");
                        loadDatas();
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete");
                        
                    }
                }
            })
            
                // Fermer la modale
                $('#nouveauPaiementModal').modal('hide');
            
           
            // Réinitialiser le formulaire
            $('#echeancierSelection').val('');
            $('#datePaiement').val('');
            $('#montantPaiement').val('');
            $('#modePaiement').val('');
            $('#referencePaiement').val('');
            $('#observationPaiement').val('');
            
            // Réinitialiser le résumé
            $('#resumeEcheance').text('-');
            $('#resumeDate').text('-');
            $('#resumeMontant').text('0.00 DA');
            $('#resumeMode').text('-');
            $('#resumeReference').text('-');
        });
        
        // Imprimer la quittance
        $(document).on('click', '.print-quittance-btn', function(){
            var id = $(this).data('id');
            
            // Get payment data
            var payment = paymentData[id];
            if (!payment) {
                alert("Données de paiement non trouvées pour l'ID: " + id);
                return;
            }
            
            // Get student information
            var studentName = $('#demandeur').text();
            var formation = $('#specialite').text();
            var promo = $('#promo').text();
            var currentDate = new Date().toLocaleDateString('fr-FR');
            
            // Generate PDF
            generateQuittancePDF(payment, studentName, formation, promo, currentDate);
        });
        
        // Fonction pour générer le PDF de la quittance
        function generateQuittancePDF(payment, studentName, formation, promo, currentDate) {
            // Vérifier si jsPDF est disponible
            var jsPDFInstance = null;
            
            // Méthode 1: jsPDF direct
            if (typeof jsPDF !== 'undefined') {
                jsPDFInstance = jsPDF;
            }
            // Méthode 2: window.jspdf.jsPDF
            else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                jsPDFInstance = window.jspdf.jsPDF;
            }
            // Méthode 3: jspdf.jsPDF
            else if (typeof jspdf !== 'undefined' && typeof jspdf.jsPDF !== 'undefined') {
                jsPDFInstance = jspdf.jsPDF;
            }
            
            if (jsPDFInstance) {
                // jsPDF est déjà disponible
                createQuittancePDF(payment, studentName, formation, promo, currentDate, jsPDFInstance);
            } else {
                // Charger jsPDF dynamiquement
                var script1 = document.createElement('script');
                script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script1.onload = function() {
                    // Charger autoTable
                    var script2 = document.createElement('script');
                    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js';
                    script2.onload = function() {
                        // Réessayer de générer le PDF
                        var loadedJsPDF = null;
                        if (typeof jsPDF !== 'undefined') {
                            loadedJsPDF = jsPDF;
                        } else if (typeof window !== 'undefined' && typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                            loadedJsPDF = window.jspdf.jsPDF;
                        }
                        if (loadedJsPDF) {
                            createQuittancePDF(payment, studentName, formation, promo, currentDate, loadedJsPDF);
                        } else {
                            alert("Erreur lors du chargement de la bibliothèque PDF.");
                        }
                    };
                    script2.onerror = function() {
                        alert("Erreur lors du chargement de la bibliothèque PDF (AutoTable).");
                    };
                    document.head.appendChild(script2);
                };
                script1.onerror = function() {
                    alert("Erreur lors du chargement de la bibliothèque PDF.");
                };
                document.head.appendChild(script1);
            }
        }
        
        // Fonction pour créer le PDF de la quittance
        function createQuittancePDF(payment, studentName, formation, promo, currentDate, jsPDFInstance) {
            try {
                // Créer le PDF
                var doc = new jsPDFInstance();
                
                // Définir la police et la taille
                doc.setFont("helvetica");
                
                // Ajouter le titre
                doc.setFontSize(18);
                doc.setTextColor(40, 40, 40);
                doc.text("QUITTANCE DE PAIEMENT", 105, 20, null, null, 'center');
                
                // Ajouter une ligne de séparation
                doc.setDrawColor(59, 125, 221); // Couleur bleue
                doc.setLineWidth(0.5);
                doc.line(20, 25, 190, 25);
                
                // Informations de l'établissement (simulées)
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text("Établissement de formation", 20, 35);
                doc.text("Adresse de l'établissement", 20, 40);
                doc.text("Tél: +213 XX XX XX XX", 20, 45);
                
                // Date et numéro de quittance
                doc.setTextColor(40, 40, 40);
                doc.text("Date: " + currentDate, 150, 35);
                doc.text("N° Quittance: " + payment.num, 150, 40);
                
                // Informations de l'étudiant
                doc.setFontSize(12);
                doc.setTextColor(40, 40, 40);
                doc.text("Reçu de:", 20, 60);
                doc.setFontSize(11);
                doc.text(studentName, 45, 60);
                
                doc.setFontSize(12);
                doc.text("Formation:", 20, 68);
                doc.setFontSize(11);
                doc.text(formation, 45, 68);
                
                doc.setFontSize(12);
                doc.text("Promo:", 20, 76);
                doc.setFontSize(11);
                doc.text(promo, 45, 76);
                
                // Détails du paiement
                doc.setFontSize(14);
                doc.setTextColor(59, 125, 221);
                doc.text("DÉTAILS DU PAIEMENT", 20, 95);
                
                doc.setFontSize(12);
                doc.setTextColor(40, 40, 40);
                doc.text("Montant payé:", 20, 105);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(payment.montant_paye + " DA", 60, 105);
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);
                doc.text("Date de paiement:", 20, 115);
                doc.text(payment.date_paiement, 60, 115);
                
                doc.text("Mode de paiement:", 20, 125);
                doc.text(payment.mode_paiement, 60, 125);
                
                doc.text("Référence:", 20, 135);
                doc.text(payment.reference, 60, 135);
                
                // Message de remerciement
                doc.setFontSize(12);
                doc.setTextColor(40, 167, 69); // Vert
                doc.text("Merci pour votre paiement.", 20, 155);
                
                // Signature
                doc.setFontSize(11);
                doc.setTextColor(80, 80, 80);
                doc.text("Signature de l'agent:", 20, 180);
                doc.line(20, 185, 80, 185); // Ligne pour la signature
                
                doc.text("Signature du responsable:", 120, 180);
                doc.line(120, 185, 180, 185); // Ligne pour la signature
                
                // Pied de page
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text("Document généré le " + currentDate, 105, 200, null, null, 'center');
                doc.text("Page 1 sur 1", 105, 205, null, null, 'center');
                
                // Télécharger le PDF
                doc.save("quittance_" + payment.num + "_" + studentName.replace(/\s+/g, '_') + ".pdf");
                
                alertify.success("Quittance générée avec succès !");
                
            } catch (error) {
                console.error("Erreur lors de la génération du PDF:", error);
                alert("Erreur lors de la génération de la quittance. Détails: " + error.message);
            }
        }
        
        // Imprimer la facture
        $(document).on('click', '.print-facture-btn', function(){
            var id = $(this).data('id');
            alert("Fonctionnalité d'impression de facture - à implémenter pour le paiement ID: " + id);
            // À implémenter : Logique d'impression de la facture
        });
        
    });

     
</script>

{% endblock content %}