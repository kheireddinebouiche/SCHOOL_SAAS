{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Trésorerie - Détails demande de paiement {% endblock title %}

{% block content %}
<style>
    ._inputDetails {
       background-color: transparent !important;
       border : none !important;
       outline : none;
       font-weight : 700 !important;
    }
    
    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .echeancier-special-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .percentage-input {
        width: 80px;
    }
    
    .montant-cell {
        font-weight: 600;
    }
    
    .total-row {
        background-color: #e9ecef;
        font-weight: 700;
    }
    
    .card-equal-height {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .card-equal-height .card-body {
        flex: 1 1 auto;
    }
</style>
<script src="https://cdn.lordicon.com/lordicon.js"></script>
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">
                    
                    <!-- start page title -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="ri-money-dollar-circle-line text-primary"></i>
                                    </div>
                                    <h4 class="mb-0 text-primary">Détails demande de paiement</h4>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb m-0 bg-transparent">
                                            <li class="breadcrumb-item">
                                                <a href="javascript: void(0);">Trésorerie</a>
                                            </li>
                                            <li class="breadcrumb-item active">Détails demande de paiement</li>
                                        </ol>
                                    </nav>
                                    <button id="btnNewPaiement" class="btn btn-primary px-4 py-2">
                                        <i class="ri-add-line me-2"></i>Nouveau paiement
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end page title -->

                    <div class="alert-content mb-4">
                        
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card border-0 shadow-sm rounded-4">
                                <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="ri-file-text-line text-primary fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-primary mb-1">Demande de paiement</h5>
                                                <p class="text-muted small mb-0">Informations détaillées sur la demande</p>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button id="btnNewRefund" class="btn btn-warning px-4 py-2">
                                                <i class='mdi mdi-account-cash me-2'></i> Demande de remboursement
                                            </button>
                                            <button id="changeEcheancierModel" class="btn btn-success px-4 py-2">
                                                <i class="ri-refresh-line me-2"></i>Changer le modèle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-4">
                                        <div class="col-lg-6">
                                            <div class="card border border-primary h-100">
                                                <div class="card-header bg-primary bg-opacity-10">
                                                    <h6 class="mb-0 text-primary">Informations du demandeur</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="flex-shrink-0">
                                                            <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center" style="width: 40px; height: 40px;">
                                                                <i class="ri-user-line text-primary fs-4"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3 d-flex align-items-center">
                                                            <h6 class="mb-0" id="demandeur"></h6>
                                                            <button class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#clientDetailsModal">
                                                                <i class="ri-link"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="flex-shrink-0">
                                                            <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center" style="width: 40px; height: 40px;">
                                                                <i class="ri-calendar-line text-primary fs-4"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h6 class="mb-1" id="created_at"></h6>
                                                            <p class="text-muted mb-0">Date de demande</p>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <div class="avatar-sm bg-primary bg-opacity-10 rounded icon-center" style="width: 40px; height: 40px;">
                                                                <i class="ri-file-text-line text-primary fs-4"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h6 class="mb-1" id="motif"></h6>
                                                            <p class="text-muted mb-0">Motif de la demande</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Notification de réduction avec bouton Consulter -->
                                                <div  style="display:none !important;" class="alert alert-warning d-flex align-items-center mt-3" role="alert" id="reductionNotification" >
                                                    <i class="ri-error-warning-line me-2 fs-4"></i>
                                                    <div class="flex-grow-1">
                                                        <strong>Le demandeur bénéficie d'une réduction de prix.</strong>
                                                        <p class="mb-0 text-muted small">Cliquez sur consulter pour voir les détails de la réduction.</p>
                                                    </div>
                                                    <div class="flex-shrink-0 ms-2">
                                                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#reductionDetailsModal">
                                                            <i class="ri-eye-line me-1"></i>Consulter
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                      
                                        <div class="col-lg-6">
                                            <div class="card border border-success h-100">
                                                <div class="card-header bg-success bg-opacity-10">
                                                    <h6 class="mb-0 text-success">Informations sur la formation</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="flex-shrink-0">
                                                            <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center" style="width: 40px; height: 40px;">
                                                                <i class="ri-book-line text-success fs-4"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h6 class="mb-1" id="specialite"></h6>
                                                            <p class="text-muted mb-0">Spécialité</p>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="flex-shrink-0">
                                                            <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center" style="width: 40px; height: 40px;">
                                                                <i class="ri-graduation-cap-line text-success fs-4"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h6 class="mb-1" id="promo"></h6>
                                                            <p class="text-muted mb-0">Promo</p>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <div class="avatar-sm bg-success bg-opacity-10 rounded icon-center" style="width: 40px; height: 40px;">
                                                                <i class="ri-money-dollar-circle-line text-success fs-4"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h6 class="mb-1" id="prix_formation"></h6>
                                                            <p class="text-muted mb-0">Prix de la formation</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <!-- Échéancier de paiement - gauche -->
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm rounded-4 h-100">
                                <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="ri-calendar-line text-success fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-success mb-1">Échéancier de paiement</h5>
                                                <p class="text-muted small mb-0">Détails des tranches de paiement</p>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#confirmEcheancierModal">
                                                <i class="ri-check-line me-1"></i>Confirmer
                                            </button>
                                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#specialEcheancierModal">
                                                <i class="ri-star-line me-1"></i>Spécial
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle table-nowrap mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Libellé</th>
                                                    <th>Date d'échéance</th>
                                                    <th>Montant</th>
                                                    <th id="prixFinalHeader" style="display: none;">Prix final</th>
                                                </tr>
                                            </thead>
                                            <tbody id="echeancierTable">
                                                <!-- Échéanciers seront chargés ici -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paiements - droite -->
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm rounded-4 h-100">
                                <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="ri-money-cny-circle-line text-info fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-info mb-1">Paiements</h5>
                                                <p class="text-muted small mb-0">Suivi des paiements effectués</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs nav-tabs-custom nav-primary mb-3" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-bs-toggle="tab" href="#nav-border-top-paiement_dus" role="tab" aria-selected="false">
                                                <i class="ri-money-dollar-circle-line me-1 align-middle"></i> Dus 
                                                <span class="badge bg-warning rounded-circle ms-1" id="NbrPaiementDue">0</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#nav-border-top-paiements_done" role="tab" aria-selected="false">
                                                <i class="ri-check-double-line me-1 align-middle"></i> Effectués
                                                <span class="badge bg-success rounded-circle ms-1" id="NbrPaiementDone">0</span>
                                            </a>
                                        </li>
                                    </ul>
                                    <div class="tab-content text-muted">
                                        <div class="tab-pane active" id="nav-border-top-paiement_dus" role="tabpanel">
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle table-nowrap mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th scope="col">Label</th>
                                                            <th scope="col">Montant</th>
                                                            <th scope="col">Restant</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="ListePaiementRequestLine">
                                                        
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="nav-border-top-paiements_done" role="tabpanel">
                                            <div class="table-responsive">
                                                 <table class="table table-hover align-middle table-nowrap mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th scope="col">Label</th>
                                                            <th scope="col">Montant</th>
                                                            <th scope="col">Date</th>
                                                            <th scope="col">Etat</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="ListePaiementRequestLineDone">
                                                        
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
        </div>

        <!-- Modal Confirmation Échéancier -->
        <div class="modal fade" id="confirmEcheancierModal" tabindex="-1" aria-labelledby="confirmEcheancierModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                <i class="ri-check-line text-success fs-4"></i>
                            </div>
                            <div>
                                <h5 class="modal-title fw-semibold text-success mb-1" id="confirmEcheancierModalLabel">Confirmation de l'échéancier</h5>
                                <p class="text-muted small mb-0">Veuillez confirmer l'échéancier de paiement</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center mb-4">
                            <div class="avatar-lg mx-auto mb-4">
                                <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                                    <i class="ri-check-double-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mb-4">
                            <h5>Confirmer l'échéancier de paiement</h5>
                            <p class="text-muted">Êtes-vous sûr de vouloir confirmer cet échéancier ?</p>
                        </div>
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="ri-alert-line me-2"></i>
                            <div>
                                En confirmant cet échéancier, vous acceptez les termes et conditions associés. Cette action est irréversible.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-light px-4 py-3">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                            <i class="ri-close-line me-2"></i>Annuler
                        </button>
                        <button type="button" class="btn btn-success px-4 py-2" id="confirmEcheancierBtn">
                            <i class="ri-check-line me-2"></i>Confirmer l'échéancier
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Détails de Confirmation -->
        <div class="modal fade" id="confirmationDetailsModal" tabindex="-1" aria-labelledby="confirmationDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                <i class="ri-file-text-line text-primary fs-4"></i>
                            </div>
                            <div>
                                <h5 class="modal-title fw-semibold text-primary mb-1" id="confirmationDetailsModalLabel">Détails de confirmation</h5>
                                <p class="text-muted small mb-0">Récapitulatif de l'échéancier de paiement</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row mb-4">
                            <div class="col-lg-12">
                                <div class="card border border-success">
                                    <div class="card-header bg-success bg-opacity-10">
                                        <h6 class="mb-0 text-success">Informations de la formation</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">Spécialité:</span>
                                            <span class="fw-medium" id="modalSpecialite"></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">Promo:</span>
                                            <span class="fw-medium" id="modalPromo"></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">Prix de la formation:</span>
                                            <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                        </div>
                                        <div class="d-flex justify-content-between" id="modalPrixFinalRow" style="display: none;">
                                            <span class="text-muted">Prix final (avec réduction):</span>
                                            <span class="fw-bold text-success" id="modalPrixFinal"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card border border-info">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <h6 class="mb-0 text-info">Échéancier de paiement</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle table-nowrap mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Libellé</th>
                                                        <th>Date d'échéance</th>
                                                        <th>Montant</th>
                                                        <th id="modalPrixFinalHeader" style="display: none;">Prix final</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="modalEcheancesTable">
                                                    <!-- Échéances seront chargées ici -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-4" role="alert">
                            <i class="ri-alert-line me-2"></i>
                            <span>En confirmant ces informations, l'échéancier sera définitivement enregistré dans le système.</span>
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-light px-4 py-3">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                            <i class="ri-close-line me-2"></i>Annuler
                        </button>
                        <button type="button" class="btn btn-success px-4 py-2" id="finalConfirmBtn">
                            <i class="ri-check-double-line me-2"></i>Confirmer définitivement
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Échéancier Spécial -->
        <div class="modal fade" id="specialEcheancierModal" tabindex="-1" aria-labelledby="specialEcheancierModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                <i class="ri-star-line text-warning fs-4"></i>
                            </div>
                            <div>
                                <h5 class="modal-title fw-semibold text-warning mb-1" id="specialEcheancierModalLabel">Échéancier spécial</h5>
                                <p class="text-muted small mb-0">Générez un échéancier personnalisé</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card border border-primary card-equal-height">
                                    <div class="card-header bg-primary bg-opacity-10">
                                        <h6 class="mb-0 text-primary">Informations de la formation</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">Spécialité:</span>
                                            <span class="fw-medium" id="modalSpecialite"></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">Promo:</span>
                                            <span class="fw-medium" id="modalPromo"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Prix de la formation:</span>
                                            <span class="fw-bold text-primary" id="modalPrixFormation"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card border border-warning card-equal-height">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h6 class="mb-0 text-warning">Configuration de l'échéancier</h6>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <div class="mb-3">
                                            <label for="nombreTranches" class="form-label fw-medium">Nombre de tranches</label>
                                            <input type="number" class="form-control border-0 bg-light py-2" id="nombreTranches" min="1" value="3">
                                        </div>
                                        <div class="mt-auto">
                                            <button class="btn btn-warning w-100" id="genererTranchesBtn">
                                                <i class="ri-refresh-line me-1"></i>Générer les tranches
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card border border-success">
                                    <div class="card-header bg-success bg-opacity-10">
                                        <h6 class="mb-0 text-success">Échéancier généré</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle table-nowrap mb-0 echeancier-special-table">
                                                <thead>
                                                    <tr>
                                                        <th>Tranche</th>
                                                        <th>Pourcentage</th>
                                                        <th>Montant</th>
                                                        <th>Date d'échéance</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="specialEcheancierTable">
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted py-4">
                                                            <i class="ri-information-line me-2"></i>
                                                            Veuillez générer les tranches en cliquant sur le bouton ci-dessus
                                                        </td>
                                                    </tr>
                                                </tbody>
                                                <tfoot id="specialEcheancierFooter">
                                                    <tr class="total-row">
                                                        <td><strong>Total</strong></td>
                                                        <td id="totalPercentage">0%</td>
                                                        <td id="totalAmount">0 DA</td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        <div id="percentageWarning" class="alert alert-info mt-3" role="alert">
                                            <i class="ri-information-line me-2"></i>
                                            <span>Modifiez les pourcentages manuellement. La somme totale peut dépasser ou être inférieure à 100%.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-light px-4 py-3">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                            <i class="ri-close-line me-2"></i>Annuler
                        </button>
                        <button type="button" class="btn btn-warning px-4 py-2" id="saveSpecialEcheancierBtn" disabled>
                            <i class="ri-save-line me-2"></i>Enregistrer l'échéancier
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Confirmation Enregistrement Échéancier Spécial -->
        <div class="modal fade" id="confirmSaveEcheancierModal" tabindex="-1" aria-labelledby="confirmSaveEcheancierModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                <i class="ri-alert-line text-warning fs-4"></i>
                            </div>
                            <div>
                                <h5 class="modal-title fw-semibold text-warning mb-1" id="confirmSaveEcheancierModalLabel">Confirmation d'enregistrement</h5>
                                <p class="text-muted small mb-0">Échéancier spécial</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center mb-4">
                            <div class="avatar-lg mx-auto mb-4">
                                <div class="avatar-title bg-warning bg-opacity-10 text-warning display-5 rounded-circle">
                                    <i class="ri-file-warning-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mb-4">
                            <h5>Enregistrer l'échéancier spécial</h5>
                            <p class="text-muted">Vous êtes sur le point d'enregistrer cet échéancier.</p>
                        </div>
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="ri-alert-line me-2"></i>
                            <div>
                                Cet échéancier sera soumis à validation par un responsable avant d'être définitivement appliqué.
                            </div>
                        </div>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="confirmValidationCheck">
                            <label class="form-check-label" for="confirmValidationCheck">
                                Je comprends que cet échéancier nécessite une validation
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-light px-4 py-3">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                            <i class="ri-close-line me-2"></i>Annuler
                        </button>
                        <button type="button" class="btn btn-warning px-4 py-2" id="confirmSaveEcheancierBtn" disabled>
                            <i class="ri-checkbox-circle-line me-2"></i>Confirmer l'enregistrement
                        </button>
                    </div>
                </div>
            </div>
        </div>

<div id="paiementsModal" class="modal fade" tabindex="-1" aria-labelledby="paiementsModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-money-dollar-circle-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="paiementsModalLabel">Enregistrement de paiement</h5>
                        <p class="text-muted small mb-0">Saisissez les détails du paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
               
                <div class="row">
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="due_paiements">Veuillez sélectionner le paiement dû :</label>
                        <select  required class="form-control border-0 bg-light py-2" id="due_paiements" >

                        </select>
                    </div>
                     <div class="col-lg-4">
                        <label class="form-label fw-medium" for="date_paiement">Date de paiement :</label>
                        <input type="date" required class="form-control border-0 bg-light py-2" id="date_paiement" />
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="received_amount">Montant reçu :</label>
                        <input type="text" required class="form-control border-0 bg-light py-2" id="received_amount" />
                    </div>
                </div> 
                <div class="row mt-2">
                    <div class="col-lg-6">
                        <label class="form-label fw-medium" for="paiement_mode">Mode de paiement:</label>
                        <select class="form-control border-0 bg-light py-2" id="paiement_mode">
                            <option value="esp">Espèce</option>
                            <option value="che">Chèque</option>
                            <option value="vir">Virement</option>
                        </select>
                    </div>
                     <div class="col-lg-6">
                        <label for="paiement_ref" class="form-label fw-medium">Référence de paiement </label>
                        <input type="text" class="form-control border-0 bg-light py-2" id="paiement_ref" />
                    </div>
                    
                </div>
                <div class="row mt-2 ">
                    <div class="col-lg-12">
                        <label for="observation" class="form-label fw-medium">Observations</label>
                        <textarea class="form-control border-0 bg-light py-2" id="observation"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="StorePaimentBnt">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
       
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="paiementsModalDetails" class="modal fade" tabindex="-1" aria-labelledby="paiementsModalDetailsLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-file-list-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="paiementsModalDetailsLabel">Détails du paiement</h5>
                        <p class="text-muted small mb-0">Informations détaillées sur le paiement</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
               
                <div class="row">
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="due_paiements">Veuillez sélectionner le paiement dû :</label>
                        <select  required class="form-control border-0 bg-light py-2" id="due_paiements" >

                        </select>
                    </div>
                     <div class="col-lg-4">
                        <label class="form-label fw-medium" for="date_paiement">Date de paiement :</label>
                        <input type="date" required class="form-control border-0 bg-light py-2" id="date_paiement" />
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-medium" for="received_amount">Montant reçu :</label>
                        <input type="text" required class="form-control border-0 bg-light py-2" id="received_amount" />
                    </div>
                </div> 
                <div class="row mt-2">
                    <div class="col-lg-6">
                        <label class="form-label fw-medium" for="paiement_mode">Mode de paiement:</label>
                        <select class="form-control border-0 bg-light py-2" id="paiement_mode">
                            <option value="esp">Espèce</option>
                            <option value="che">Chèque</option>
                            <option value="vir">Virement</option>
                        </select>
                    </div>
                     <div class="col-lg-6">
                        <label for="paiement_ref" class="form-label fw-medium">Référence de paiement </label>
                        <input type="text" class="form-control border-0 bg-light py-2" id="paiement_ref" />
                    </div>
                    
                </div>
                <div class="row mt-2 ">
                    <div class="col-lg-12">
                        <label for="observation" class="form-label fw-medium">Observations</label>
                        <textarea class="form-control border-0 bg-light py-2" id="observation"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="StorePaimentBnt">
                    <i class="ri-save-line me-2"></i>Enregistrer le paiement
                </button>
            </div>
       
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-body text-center p-5">
                        <div class="avatar-lg mx-auto mb-4">
                            <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                                <i class="ri-close-circle-line"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="mb-3">Vous étes sur le point de supprimer le paiement</h4>
                            <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                            <div class="hstack gap-2 justify-content-center">
                                
                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade refundModal" tabindex="-1" role="dialog" aria-labelledby="refundModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-body text-center p-5">
                        <div class="avatar-lg mx-auto mb-4">
                            <div class="avatar-title bg-warning bg-opacity-10 text-warning display-5 rounded-circle">
                                <i class="ri-refund-line"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="mb-3">Vous étes sur le point de faire une demande de rembourssement</h4>
                            <p class="text-muted mb-4">La demande de remboussement doit être valider par un compe de niveau supérieur. </p>
                            <div class="hstack gap-2 justify-content-center">
                                
                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal Détails du Client -->
<div class="modal fade" id="clientDetailsModal" tabindex="-1" aria-labelledby="clientDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-user-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="clientDetailsModalLabel">Détails du client</h5>
                        <p class="text-muted small mb-0">Informations complètes sur le demandeur</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="text-center">
                            <div class="avatar-lg mx-auto mb-4">
                                <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                                    <i class="ri-user-line"></i>
                                </div>
                            </div>
                            <h5 class="mb-1" id="clientFullName"></h5>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card border border-primary">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0 text-primary">Informations personnelles</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Email</td>
                                                <td id="clientEmail"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Téléphone</td>
                                                <td id="clientPhone"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Adresse</td>
                                                <td id="clientAddress"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Date de naissance</td>
                                                <td id="clientBirthDate"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Lieu de naissance</td>
                                                <td id="clientBirthPlace"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails de la Réduction -->
<div class="modal fade" id="reductionDetailsModal" tabindex="-1" aria-labelledby="reductionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-coupon-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="reductionDetailsModalLabel">Détails de la réduction</h5>
                        <p class="text-muted small mb-0">Informations sur la réduction applicable</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="card border border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h6 class="mb-0 text-warning">Réduction disponible</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted">Type de réduction</td>
                                        <td id="reductionType">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Montant de la réduction</td>
                                        <td id="reductionAmount">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Prix initial</td>
                                        <td id="initialPrice">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Prix après réduction</td>
                                        <td id="finalPrice">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3" role="alert">
                    <i class="ri-information-line me-2"></i>
                    <span>En appliquant cette réduction, le prix de la formation sera mis à jour automatiquement.</span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="applyReductionBtn">
                    <i class="ri-check-line me-2"></i>Appliquer la réduction
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        var id_demande = "{{pk}}";
        var prixFormation = 0.00;
        var prixFormationReduction = 0.00;
        let hasReduction =  false;

        function HideReducNotif(){
           
            let notif = document.getElementById("reductionNotification");

            if (hasReduction === true) {
                notif.style.display = "flex";  
            } else {
                notif.style.display = "none";
            }
        }
    
        function loadDatas(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiGetDetailsDemandePaiement' %}",
                dataType: 'JSON',
                type : 'GET',
                data : {'id_demande' : id_demande},
                success : function(data){
                    // Informations du demandeur
                    $('#demandeur').text(data.user_data.demandeur_nom+" "+data.user_data.demandeur_prenom);
                    $('#created_at').text(data.user_data.created_at.split('T')[0]);
                    $('#motif').text(data.user_data.motif);
                    
                    // Informations du client pour la modale
                    $('#clientFullName').text(data.user_data.demandeur_nom+" "+data.user_data.demandeur_prenom);
                    $('#clientEmail').text(data.user_data.email || 'Non spécifié');
                    $('#clientPhone').text(data.user_data.telephone || 'Non spécifié');
                    $('#clientAddress').text(data.user_data.adresse || 'Non spécifié');
                    $('#clientBirthDate').text(data.user_data.date_naissance || 'Non spécifié');
                    $('#clientBirthPlace').text(data.user_data.lieu_naissance || 'Non spécifié');
                    
                    // Informations sur la formation
                    $('#specialite').text(data.voeux.specialite_label);
                    $('#promo').text(data.voeux.promo);
                    $('#prix_formation').text(data.voeux.prix_formation + " DA");
                    
                    // Stocker le prix de la formation pour le modal spécial
                    prixFormation = data.voeux.prix_formation;
                    
                    // Charger les échéanciers
                    var echeancierHtml = "";
                    
                    // Ajouter les frais d'inscription comme première ligne si > 0
                    if (data.voeux.frais_inscription > 0) {
                        echeancierHtml += '<tr>';
                        echeancierHtml += '<td><span class="badge bg-info">Frais d\'inscription</span></td>';
                        echeancierHtml += '<td>À définir</td>';
                        echeancierHtml += '<td><span class="fw-bold">' + data.voeux.frais_inscription + ' DA</span></td>';
                        if(hasReduction) {
                            var fraisInscriptionReduction = parseFloat(data.voeux.frais_inscription - (data.voeux.frais_inscription * (data.remise.valeur/100)));
                            echeancierHtml += '<td id="prixFinalFraisInscription" style="display: table-cell;"><span class="fw-bold text-success">' + fraisInscriptionReduction.toFixed(2) + ' DA</span></td>';
                        }
                        echeancierHtml += '</tr>';
                    }
                    
                    if(data.remise){
                        hasReduction = true;
                        HideReducNotif();

                        prixFormationReduction = parseFloat(prixFormation-(prixFormation*(data.remise.valeur/100)));

                        $('#reductionType').text(data.remise.type_remise);
                        $('#reductionAmount').text(data.remise.valeur+" %");
                        $('#initialPrice').text(prixFormation);
                        $('#finalPrice').text(parseFloat(prixFormationReduction));

                        // Afficher la colonne Prix final
                        $('#prixFinalHeader').show();
                        $('[id^=prixFinal]').show();
                    }
                    
                    // Ajouter les autres échéances
                    $.each(data.echeancier, function(index, echeance){
                        var label = "Tranche " + (index + 1);
                        
                        echeancierHtml += '<tr>';
                        echeancierHtml += '<td><span class="badge bg-primary">' + label + '</span></td>';
                        echeancierHtml += '<td>' + (echeance.date_echeancier ? echeance.date_echeancier : 'À définir') + '</td>';
                        echeancierHtml += '<td><span class="fw-bold">' + echeance.montant_tranche + ' DA</span></td>';
                        if(hasReduction) {
                            var montantReduction = parseFloat(echeance.montant_tranche - (echeance.montant_tranche * (data.remise.valeur/100)));
                            echeancierHtml += '<td id="prixFinalTranche' + index + '" style="display: table-cell;"><span class="fw-bold text-success">' + montantReduction.toFixed(2) + ' DA</span></td>';
                        }
                        echeancierHtml += '</tr>';
                    });
                    
                    $('#echeancierTable').html(echeancierHtml);

                    

                },
            });
        }

        loadDatas();

        // Gestion du bouton de changement de modèle d'échéancier
        $(document).on('click', '#changeEcheancierModel', function(){
            alert("Fonctionnalité de changement de modèle d'échéancier - à implémenter");
        });
        
        
        $(document).on('click', '#confirmEcheancierBtn', function(){
            // Remplir la modale avec les informations actuelles
            $('#modalSpecialite').text($('#specialite').text());
            $('#modalPromo').text($('#promo').text());
            $('#modalPrixFormation').text($('#prix_formation').text());
            
            // Vérifier s'il y a une réduction et mettre à jour l'affichage
            if (hasReduction) {
                $('#modalPrixFormation').text($('#initialPrice').text() + ' DA');
                $('#modalPrixFinalRow').show();
                $('#modalPrixFinal').text($('#finalPrice').text() + ' DA');
                // Afficher la colonne Prix final dans le tableau
                $('#modalPrixFinalHeader').show();
            } else {
                $('#modalPrixFinalRow').hide();
                // Masquer la colonne Prix final dans le tableau
                $('#modalPrixFinalHeader').hide();
            }
            
            // Remplir le tableau des échéances dans la modale
            var echeancesHtml = '';
            $('#echeancierTable tr').each(function(index) {
                var libelle = $(this).find('td:eq(0)').text();
                var date = $(this).find('td:eq(1)').text();
                var montant = $(this).find('td:eq(2)').text();
                
                echeancesHtml += '<tr>';
                echeancesHtml += '<td>' + libelle + '</td>';
                echeancesHtml += '<td>' + date + '</td>';
                echeancesHtml += '<td>' + montant + '</td>';
                
                // Ajouter le prix final si une réduction est appliquée
                if (hasReduction) {
                    var prixReduitElement = $(this).find('td:eq(3)');
                    if (prixReduitElement.length > 0) {
                        var prixReduit = prixReduitElement.text();
                        echeancesHtml += '<td>' + prixReduit + '</td>';
                    }
                }
                
                echeancesHtml += '</tr>';
            });
            $('#modalEcheancesTable').html(echeancesHtml);
            
            // Afficher la modale
            $('#confirmEcheancierModal').modal('hide');
            $('#confirmationDetailsModal').modal('show');
        });
        
        // Pré-remplir les informations dans le modal spécial
        $('#specialEcheancierModal').on('show.bs.modal', function () {
            $('#modalSpecialite').text($('#specialite').text());
            $('#modalPromo').text($('#promo').text());
            $('#modalPrixFormation').text($('#prix_formation').text());
        });
        
        // Générer les tranches
        $(document).on('click', '#genererTranchesBtn', function(){
            var nombreTranches = parseInt($('#nombreTranches').val());
            var prix = parseFloat(prixFormation);
            
            if (isNaN(nombreTranches) || nombreTranches <= 0) {
                alert("Veuillez entrer un nombre de tranches valide");
                return;
            }
            
            if (isNaN(prix) || prix <= 0) {
                alert("Prix de formation invalide");
                return;
            }
            
            var html = '';
            var pourcentageParTranche = (100 / nombreTranches).toFixed(2);
            
            // Initialiser le tableau des pourcentages précédents
            previousPercentages = [];
            
            for (var i = 1; i <= nombreTranches; i++) {
                var montant = (prix * (pourcentageParTranche / 100)).toFixed(2);
                previousPercentages.push(parseFloat(pourcentageParTranche));
                html += '<tr>';
                html += '<td><span class="badge bg-warning">Tranche ' + i + '</span></td>';
                html += '<td><div class="d-flex align-items-center"><input type="number" class="form-control border-0 bg-light py-1 percentage-input" value="' + pourcentageParTranche + '" data-index="' + (i-1) + '" step="0.01" min="0" style="width: 80px;"><span class="ms-1">%</span></div></td>';
                html += '<td class="montant-cell">' + montant + ' DA</td>';
                html += '<td><input type="date" class="form-control border-0 bg-light py-1" style="width: 150px;"></td>';
                html += '</tr>';
            }
            
            $('#specialEcheancierTable').html(html);
            $('#saveSpecialEcheancierBtn').prop('disabled', false);
            
            // Calculer les totaux initiaux
            calculateTotals();
        });
        
        // Mise à jour manuelle des pourcentages sans recalcul des autres
        $(document).on('input', '.percentage-input', function(){
            var $this = $(this);
            var newPercentage = parseFloat($this.val()) || 0;
            var prix = parseFloat(prixFormation) || 0;
            
            // Mettre à jour le montant pour l'élément modifié
            updateMontant($this, newPercentage, prix);
            
            // Recalculer les totaux
            calculateTotals();
        });
        
        // Fonction pour mettre à jour le montant
        function updateMontant($input, percentage, prix) {
            var montant = (prix * (percentage / 100)).toFixed(2);
            $input.closest('tr').find('.montant-cell').text(montant + ' DA');
        }
        
        // Fonction pour calculer les totaux
        function calculateTotals() {
            var totalPercentage = 0;
            var totalAmount = 0;
            var prix = parseFloat(prixFormation) || 0;
            
            // Calculer les totaux
            $('.percentage-input').each(function(){
                var percentage = parseFloat($(this).val()) || 0;
                totalPercentage += percentage;
                totalAmount += (prix * (percentage / 100));
            });
            
            // Mettre à jour les totaux dans le footer
            $('#totalPercentage').text(totalPercentage.toFixed(2) + '%');
            $('#totalAmount').text(totalAmount.toFixed(2) + ' DA');
            
            // Activer/désactiver le bouton d'enregistrement (toujours activé maintenant)
            $('#saveSpecialEcheancierBtn').prop('disabled', false);
        }
        
        // Ouvrir la modale de confirmation lors du clic sur "Enregistrer l'échéancier"
        $(document).on('click', '#saveSpecialEcheancierBtn', function(){
            $('#confirmSaveEcheancierModal').modal('show');
        });
        
        // Gérer la case à cocher de confirmation
        $(document).on('change', '#confirmValidationCheck', function(){
            if ($(this).is(':checked')) {
                $('#confirmSaveEcheancierBtn').prop('disabled', false);
            } else {
                $('#confirmSaveEcheancierBtn').prop('disabled', true);
            }
        });
        
        // Confirmer l'enregistrement de l'échéancier
        $(document).on('click', '#confirmSaveEcheancierBtn', function(){
            alert("Fonctionnalité d'enregistrement de l'échéancier spécial - à implémenter");
            $('#confirmSaveEcheancierModal').modal('hide');
            $('#specialEcheancierModal').modal('hide');
        });
        
        // Confirmation définitive de l'échéancier
        $(document).on('click', '#finalConfirmBtn', function(){
            // Récupérer les données nécessaires
            var id_demande = "{{pk}}";
            
            // Collecter les données de l'échéancier configuré
            var echeancierData = [];
            $('#echeancierTable tr').each(function() {
                var libelle = $(this).find('td:eq(0)').text().trim();
                var date = $(this).find('td:eq(1)').text().trim();
                var montant = $(this).find('td:eq(2)').text().trim().replace(' DA', '');
                
                var montantFinal = montant; 
                if (hasReduction && $(this).find('td:eq(3)').length > 0) {
                    montantFinal = $(this).find('td:eq(3)').text().trim().replace(' DA', '');
                }
                
                // Ne pas ajouter les lignes vides
                if (libelle && montant) {
                    echeancierData.push({
                        'libelle': libelle,
                        'date_echeance': date,
                        'montant': montant,
                        'montant_final': montantFinal
                    });
                }
            });
            
            // Appeler l'API pour récupérer les détails du paiement
            $.ajax({
                url: "{% url 't_tresorerie:ApiGetPaiementRequestDetails' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    'id_client': id_demande,
                    'has_reduction': hasReduction,
                    'reduction': hasReduction ? $('#reductionAmount').text().replace('%', '') : '0',
                    'echeancier_data': JSON.stringify(echeancierData)
                },
                success: function(data) {
                    console.log('Détails du paiement récupérés:', data);
                    // Ici, vous pouvez traiter les données comme nécessaire
                    // Par exemple, les afficher dans une autre modale ou les envoyer à un autre service
                    alert('Détails du paiement récupérés avec succès. Vérifiez la console pour les détails.');
                    $('#confirmationDetailsModal').modal('hide');
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors de la récupération des détails du paiement:', error);
                    alert('Erreur lors de la récupération des détails du paiement.');
                }
            });
        });
        

    }); 
    
    // Modal Détails de la Réduction
</script>



{% endblock content %}