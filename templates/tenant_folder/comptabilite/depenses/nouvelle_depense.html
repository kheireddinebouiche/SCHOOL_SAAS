{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité - Nouvelle dépense {% endblock title %}

{% block content %}
<style>
    .form-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
</style>

<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-money-euro-circle-line text-danger"></i>
                            </div>
                            <h4 class="mb-0 text-danger">Nouvelle dépense</h4>
                        </div>
                        <div class="page-title-right">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);" class="text-muted">
                                            <i class="ri-home-line me-1"></i>Comptabilité
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="{% url 't_tresorerie:PageDepenses' %}" class="text-muted">
                                            Dépenses
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active text-danger">Nouvelle dépense</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-gradient-danger text-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0">
                                    <i class="ri-money-euro-circle-line me-2"></i>Formulaire d'ajout d'une dépense
                                </h4>
                                <span class="badge bg-white text-danger px-3 py-2">Dépense</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                                <!-- Informations générales -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-file-text-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Informations générales</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-6">
                                            <label class="form-label">Désignation *</label>
                                            <input type="text" class="form-control" id="label" name="designation" required>
                                            <div class="invalid-feedback">Veuillez entrer la désignation de la dépense</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Fournisseur *</label>
                                            <select id="fournisseur" class="form-select" required>
                                            </select>
                                            <div class="invalid-feedback">Veuillez entrer le nom du fournisseur</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Détails de la dépense -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-money-dollar-circle-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Détails de la dépense</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-4">
                                            <label class="form-label">Catégorie *</label>
                                            <select class="form-select" id="typeSelect" name="type" required>
                                            </select>
                                            <div class="invalid-feedback">Veuillez sélectionner le type de la dépense</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Sous catégorie *</label>
                                            <select class="form-select" id="typeSelectSousCategorie" name="type" required>
                                                <option value='0' >Veuillez selectionner une sous catégorie</option>
                                            </select>
                                            <div class="invalid-feedback">Veuillez sélectionner le type de la dépense</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="date_depense" name="date_depense" required>
                                            <div class="invalid-feedback">Veuillez sélectionner la date de la dépense</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Montant HT *</label>
                                            <input type="number" step="0.01" class="form-control text-end" id="montant_ht" name="montant_ht" required>
                                            <div class="invalid-feedback">Veuillez entrer le montant HT</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">TVA (%)</label>
                                            <input type="number" class="form-control text-end" name="tva" id="tva" value="0" min="0" max="100" step="0.1">
                                            <div class="invalid-feedback">Veuillez entrer un pourcentage valide pour la TVA</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Montant TTC *</label>
                                            <input type="number" step="0.01" class="form-control text-end" id="montant_ttc" name="montant_ttc" required readonly>
                                            <div class="invalid-feedback">Le montant TTC est requis</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Pièce justificative</label>
                                            <input id="piece" type="file" class="form-control" name="piece_justificative">
                                        </div>
                                    </div>
                                </div>

                                <!-- Mode et référence de paiement -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-money-dollar-circle-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Mode et référence de paiement</h5>
                                    </div>
                                  
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Mode de paiement</label>
                                            <select class="form-control" id="mode_paiement">
                                                <option value="0">Veuillez sélectionner le mode de paiement</option>
                                                <option value="che">Chéque</option>
                                                <option value="esp">Espece</option>
                                                <option value="vir">Virement</option>
                                            </select> 
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Référence du paiement</label>
                                            <input type="text" class="form-control text-center" name="reference_paiement" id="reference_paiement" >
                                            <div class="invalid-feedback">Veuillez entrer une référence valide pour le paiement</div>
                                        </div>
                                    </div>
                                    
                                </div>

                                <!-- Commentaires -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-file-text-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Commentaires</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Description</label>
                                            <textarea id="description" class="form-control" name="description" rows="3" placeholder="Entrez les détails complémentaires sur la dépense..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit button -->
                                <div class="text-end mt-3">
                                    <button type="button" class="btn btn-light px-4 py-2 me-2" onclick="window.history.back()">
                                        <i class="ri-close-line me-2"></i>Annuler
                                    </button>
                                    <button id='btnSaveDepense' type="submit" class="btn btn-danger px-4 py-2">
                                        <i class="ri-save-line me-2"></i>Enregistrer
                                    </button>
                                </div>
                        </div>
                    </div>
                </div>
                <!--end col-->
            </div>
            <!--end row-->
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>
    $(document).ready(function(){


        function loadCategories(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiGetCategorie' %}",
                dataType : "JSON",
                type:"GET",
                success : function(data){
                    var option="<option value='0'>Veuillez selectionner une catégorie</option>";
                    $.each(data, function(index, p){
                        option += "<option value="+p.id+">"+p.label+"</option>";
                    });
                    $('#typeSelect').html(option);
                }
            });
            
        }

        loadCategories();

        $(document).on('change', '#typeSelect', function(){
            var option = $(this).val();

            $.ajax({
                url : "{% url 't_tresorerie:ApiFilterSousCategrorie' %}",
                dataType: "JSON",
                type : "GET",
                data:{
                    'option' : option,
                },
                success : function(data){
                    var option = "<option value='0'>Veuillez selectionner une sous catégorie</option>";
                    $.each(data, function(index, t){
                        option += "<option value="+t.id+">"+t.label+"</option>";
                    });
                    $('#typeSelectSousCategorie').html(option);
                }

            });

        });

        // Calculation for TTC amount
        function calculateTTC() {
            var montantHT = parseFloat($('input[name="montant_ht"]').val()) || 0;
            var tva = parseFloat($('input[name="tva"]').val()) || 0;
            var ttc = montantHT + (montantHT * tva / 100);
            $('input[name="montant_ttc"]').val(ttc.toFixed(2));
        }
        
        // Calculate TTC when montant HT or TVA changes
        $('input[name="montant_ht"], input[name="tva"]').on('input', function() {
            calculateTTC();
        });
        
        // Form validation
        $('.needs-validation').on('submit', function(event) {
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            $(this).addClass('was-validated');
        });
        
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        $('input[name="date_depense"]').val(today);

        function loadFournisseur(){
            $.ajax({
                url :"{% url 't_tresorerie:ApiLoadFournisseur' %}",
                dataType : "JSON",
                type : "GET",
                success: function(data){
                    var option = "<option value='0'>Veuillez sélectionner un fournisseur</option>";
                    $.each(data, function(index, p){
                        option += "<option value="+p.id+">"+p.designation+"</option>";
                    });
                    $('#fournisseur').html(option);
                }
            })
        }
        
        loadFournisseur();

        $(document).on('click','#btnSaveDepense', function(){
            var btn = $(this); // référence du bouton
            btn.prop('disabled', true); // désactive le bouton

            // Optionnel : afficher un spinner pour indiquer le chargement
            var originalText = btn.html();
            btn.html(`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Envoi en cours...
            `);

             // Récupération des valeurs
            var formData = new FormData();
            formData.append('label', $('#label').val());
            formData.append('fournisseur', $('#fournisseur').val());
            formData.append('typeSelect', $('#typeSelect').val());
            formData.append('typeSelectSousCategorie', $('#typeSelectSousCategorie').val());
            formData.append('date_depense', $('#date_depense').val());
            formData.append('montant_ht', $('#montant_ht').val());
            formData.append('tva', $('#tva').val());
            formData.append('montant_ttc', $('#montant_ttc').val());
            formData.append('description', $('#description').val());
            formData.append('mode_paiement', $('#mode_paiement').val());
            formData.append('reference_paiement', $('#reference_paiement').val());
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // FICHIER
            var piece = $('#piece')[0].files[0];
            if (piece) {
                formData.append('piece', piece);
            }

            $.ajax({
                url : "{% url 't_tresorerie:ApiStoreDepense' %}",
                type: "POST",
                dataType : "JSON",
                data : formData,
                processData: false,
                contentType: false,
                success: function(response){
                    if (response.status === "success"){
                        let spinner = document.createElement("div");
                        spinner.innerHTML = `
                            <div id="loadingSpinner" style="
                                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                z-index: 9999;
                                backdrop-filter: blur(3px);">
                                <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #3b7ddd;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                                <div class="success-message" style="
                                    font-family: Arial, sans-serif;
                                    font-size: 18px;
                                    color: #3b7ddd;
                                    font-weight: 500;
                                    text-align: center;
                                    margin-bottom: 10px;">
                                    <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                                </div>
                                
                            </div>
                            <style>
                                @keyframes spin {
                                    0% { transform: rotate(0deg); }
                                    100% { transform: rotate(360deg); }
                                }
                                .modern-spinner {
                                    width: 60px;
                                    height: 60px;
                                    border: 5px solid #e0e0e0;
                                    border-top: 5px solid #3b7ddd;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                }
                            </style>
                        `;
                        document.body.appendChild(spinner);
                        setTimeout(function() {
                            window.location.href= "{% url 't_tresorerie:PageDepenses' %}";
                        }, 1000);
                    }else{
                        alertify.error("Une erreur c'est produite lors du traitement de la requete.")
                    }
                },
                complete: function() {
                    // Réactiver le bouton et restaurer son texte après la requête
                    btn.prop('disabled', false);
                    btn.html(originalText);
                }

            })
        });
    });
</script>
{% endblock content %}