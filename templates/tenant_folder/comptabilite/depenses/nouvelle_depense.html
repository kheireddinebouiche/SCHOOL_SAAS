{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité - Nouvelle dépense {% endblock title %}

{% block content %}
<style>
    .form-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
</style>

<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-money-euro-circle-line text-danger"></i>
                            </div>
                            <h4 class="mb-0 text-danger">Nouvelle dépense</h4>
                        </div>
                        <div class="page-title-right">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);" class="text-muted">
                                            <i class="ri-home-line me-1"></i>Comptabilité
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="{% url 't_tresorerie:PageDepenses' %}" class="text-muted">
                                            Dépenses
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active text-danger">Nouvelle dépense</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-gradient-danger text-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0">
                                    <i class="ri-money-euro-circle-line me-2"></i>Formulaire d'ajout d'une dépense
                                </h4>
                                <span class="badge bg-white text-danger px-3 py-2">Dépense</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <form method="POST" class="needs-validation" novalidate>
                                {% csrf_token %}
                                
                                <!-- Informations générales -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-file-text-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Informations générales</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-6">
                                            <label class="form-label">Désignation *</label>
                                            <input type="text" class="form-control" name="designation" required>
                                            <div class="invalid-feedback">Veuillez entrer la désignation de la dépense</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Fournisseur *</label>
                                            <input type="text" class="form-control" name="fournisseur" required>
                                            <div class="invalid-feedback">Veuillez entrer le nom du fournisseur</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Détails de la dépense -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-money-dollar-circle-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Détails de la dépense</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-4">
                                            <label class="form-label">Type *</label>
                                            <select class="form-select" name="type" required>
                                                <option value="" disabled selected>Sélectionnez le type</option>
                                                <option value="fourniture">Fournitures</option>
                                                <option value="service">Services</option>
                                                <option value="locaux">Locaux</option>
                                                <option value="salaire">Salaires</option>
                                                <option value="autre">Autres</option>
                                            </select>
                                            <div class="invalid-feedback">Veuillez sélectionner le type de la dépense</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Date *</label>
                                            <input type="date" class="form-control" name="date_depense" required>
                                            <div class="invalid-feedback">Veuillez sélectionner la date de la dépense</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Statut</label>
                                            <select class="form-select" name="statut">
                                                <option value="en_attente">En attente</option>
                                                <option value="valide">Validé</option>
                                                <option value="rejete">Rejeté</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Montant HT *</label>
                                            <input type="number" step="0.01" class="form-control text-end" name="montant_ht" required>
                                            <div class="invalid-feedback">Veuillez entrer le montant HT</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">TVA (%)</label>
                                            <input type="number" class="form-control text-end" name="tva" value="0" min="0" max="100" step="0.1">
                                            <div class="invalid-feedback">Veuillez entrer un pourcentage valide pour la TVA</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Montant TTC *</label>
                                            <input type="number" step="0.01" class="form-control text-end" name="montant_ttc" required readonly>
                                            <div class="invalid-feedback">Le montant TTC est requis</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Pièce justificative</label>
                                            <input type="file" class="form-control" name="piece_justificative">
                                        </div>
                                    </div>
                                </div>

                                <!-- Commentaires -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-file-text-line text-danger me-2"></i>
                                        <h5 class="text-danger mb-0">Commentaires</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" name="description" rows="3" placeholder="Entrez les détails complémentaires sur la dépense..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit button -->
                                <div class="text-end mt-3">
                                    <button type="button" class="btn btn-light px-4 py-2 me-2" onclick="window.history.back()">
                                        <i class="ri-close-line me-2"></i>Annuler
                                    </button>
                                    <button type="submit" class="btn btn-danger px-4 py-2">
                                        <i class="ri-save-line me-2"></i>Enregistrer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!--end col-->
            </div>
            <!--end row-->
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>
    $(document).ready(function(){
        // Calculation for TTC amount
        function calculateTTC() {
            var montantHT = parseFloat($('input[name="montant_ht"]').val()) || 0;
            var tva = parseFloat($('input[name="tva"]').val()) || 0;
            var ttc = montantHT + (montantHT * tva / 100);
            $('input[name="montant_ttc"]').val(ttc.toFixed(2));
        }
        
        // Calculate TTC when montant HT or TVA changes
        $('input[name="montant_ht"], input[name="tva"]').on('input', function() {
            calculateTTC();
        });
        
        // Form validation
        $('.needs-validation').on('submit', function(event) {
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            $(this).addClass('was-validated');
        });
        
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        $('input[name="date_depense"]').val(today);
    });
</script>
{% endblock content %}