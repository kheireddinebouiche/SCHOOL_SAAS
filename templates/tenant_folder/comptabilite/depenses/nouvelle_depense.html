{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité - Nouvelle dépense {% endblock title %}

{% block content %}
<style>
    :root {
        --primary-color: #f06548; /* Red/Orange for Expenses */
        --primary-soft: #fef0ee;
        --secondary-color: #405189;
        --text-muted: #878a99;
        --border-color: #e9ebec;
        --card-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }

    .page-content {
        background-color: #f3f6f9;
        min-height: 100vh;
    }

    .card-premium {
        border: none;
        box-shadow: var(--card-shadow);
        border-radius: 16px;
        background: #fff;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .card-header-premium {
        background: linear-gradient(135deg, #f06548 0%, #d64024 100%);
        padding: 24px 32px;
        border-bottom: none;
    }

    .section-title {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 24px;
        position: relative;
        padding-left: 15px;
        border-left: 3px solid var(--primary-color);
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .form-control, .form-select {
        border: 1px solid var(--border-color);
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .input-group-text {
        background-color: #fcfcfc;
        border-color: var(--border-color);
    }

    .btn-action {
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(240, 101, 72, 0.2);
    }

    .breadcrumb-item.active {
        color: var(--primary-color);
        font-weight: 500;
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- Breadcrumb -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-0 fw-bold text-dark">Nouvelle Dépense</h4>
                            <p class="text-muted mb-0 fs-13 mt-1">Enregistrement d'une nouvelle dépense ou achat</p>
                        </div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);" class="text-muted">Comptabilité</a></li>
                                <li class="breadcrumb-item"><a href="{% url 't_tresorerie:PageDepenses' %}" class="text-muted">Dépenses</a></li>
                                <li class="breadcrumb-item active">Nouvelle</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-xl-9 col-lg-10">
                    <div class="card card-premium">
                        <!-- Header -->
                        <div class="card-header-premium">
                            <div class="d-flex justify-content-between align-items-center text-white">
                                <div>
                                    <h5 class="card-title mb-1 text-white opacity-100 fs-16">Formulaire de Dépense</h5>
                                    <p class="mb-0 opacity-75 fs-12">Saisissez les détails de la dépense ci-dessous</p>
                                </div>
                                <div class="avatar-sm bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="ri-money-euro-circle-line fs-20 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-4 p-md-5">
                            <form class="needs-validation" novalidate id="expenseForm">
                                <!-- Informations générales -->
                                <div class="mb-5">
                                    <h6 class="section-title">Informations Générales</h6>
                                    <div class="row g-4">
                                        <div class="col-lg-6">
                                            <label class="form-label">Désignation <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="label" name="designation" placeholder="Ex: Achat fournitures bureau" required>
                                            <div class="invalid-feedback">Veuillez entrer la désignation de la dépense</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Fournisseur <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="ri-store-2-line text-muted"></i></span>
                                                <select id="fournisseur" class="form-select" required>
                                                    <!-- Loaded via JS -->
                                                </select>
                                            </div>
                                            <div class="invalid-feedback">Veuillez entrer le nom du fournisseur</div>
                                        </div>
                                    </div>
                                    <div class="row g-4 mt-1">
                                         <div class="col-lg-4">
                                            <label class="form-label">Date <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="ri-calendar-event-line text-muted"></i></span>
                                                <input type="date" class="form-control" id="date_depense" name="date_depense" required>
                                            </div>
                                            <div class="invalid-feedback">Veuillez sélectionner la date</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Catégorie <span class="text-danger">*</span></label>
                                            <select class="form-select" id="typeSelect" name="type" required>
                                                <!-- Loaded via JS -->
                                            </select>
                                            <div class="invalid-feedback">Veuillez sélectionner le type</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <label class="form-label">Sous-catégorie <span class="text-danger">*</span></label>
                                            <select class="form-select" id="typeSelectSousCategorie" name="type" required>
                                                <option value='0'>Veuillez selectionner une sous catégorie</option>
                                            </select>
                                            <div class="invalid-feedback">Veuillez sélectionner la sous-catégorie</div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="border-dashed my-4">

                                <!-- Détails Financiers -->
                                <div class="mb-5">
                                    <h6 class="section-title">Détails Financiers</h6>
                                    <div class="row g-4">
                                        <div class="col-md-4">
                                            <label class="form-label">Montant HT <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">DZD</span>
                                                <input type="number" step="0.01" class="form-control text-end" id="montant_ht" name="montant_ht" placeholder="0.00" required>
                                            </div>
                                            <div class="invalid-feedback">Veuillez entrer le montant HT</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">TVA (%)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control text-end" name="tva" id="tva" value="0" min="0" max="100" step="0.1">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Montant TTC</label>
                                            <div class="input-group">
                                                <span class="input-group-text fw-bold text-danger">DZD</span>
                                                <input type="number" step="0.01" class="form-control fs-16 fw-bold text-end bg-light" id="montant_ttc" name="montant_ttc" required readonly>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12 mt-3">
                                            <label class="form-label">Pièce justificative</label>
                                            <input id="piece" type="file" class="form-control" name="piece_justificative">
                                            <div class="form-text">Formats acceptés: PDF, JPG, PNG</div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="border-dashed my-4">

                                <!-- Paiement & Autre -->
                                <div class="mb-4">
                                    <h6 class="section-title">Paiement & Détails</h6>
                                    <div class="row g-4">
                                        <div class="col-lg-6">
                                            <label class="form-label">Mode de paiement</label>
                                            <select class="form-select" id="mode_paiement">
                                                <option value="0">Sélectionner...</option>
                                                <option value="che">Chèque</option>
                                                <option value="esp">Espèce</option>
                                                <option value="vir">Virement Bancaire</option>
                                            </select> 
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Référence du paiement</label>
                                            <input type="text" class="form-control" name="reference_paiement" id="reference_paiement" placeholder="N° Chèque, Virement...">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Description / Commentaires</label>
                                            <textarea id="description" class="form-control" name="description" rows="3" placeholder="Entrez les détails complémentaires..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="d-flex justify-content-end gap-2 mt-5">
                                    <button type="button" class="btn btn-light btn-action" onclick="window.history.back()">
                                        <i class="ri-arrow-left-line me-1 align-middle"></i> Annuler
                                    </button>
                                    <button id='btnSaveDepense' type="submit" class="btn btn-danger btn-action shadow-lg">
                                        <i class="ri-save-line me-1 align-middle"></i> Enregistrer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){


        function loadCategories(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiGetCategorie' %}",
                dataType : "JSON",
                type:"GET",
                success : function(data){
                    var option="<option value='0'>Veuillez selectionner une catégorie</option>";
                    $.each(data, function(index, p){
                        option += "<option value="+p.id+">"+p.label+"</option>";
                    });
                    $('#typeSelect').html(option);
                }
            });
            
        }

        loadCategories();

        $(document).on('change', '#typeSelect', function(){
            var option = $(this).val();

            $.ajax({
                url : "{% url 't_tresorerie:ApiFilterSousCategrorie' %}",
                dataType: "JSON",
                type : "GET",
                data:{
                    'option' : option,
                },
                success : function(data){
                    var option = "<option value='0'>Veuillez selectionner une sous catégorie</option>";
                    $.each(data, function(index, t){
                        option += "<option value="+t.id+">"+t.label+"</option>";
                    });
                    $('#typeSelectSousCategorie').html(option);
                }

            });

        });

        // Calculation for TTC amount
        function calculateTTC() {
            var montantHT = parseFloat($('input[name="montant_ht"]').val()) || 0;
            var tva = parseFloat($('input[name="tva"]').val()) || 0;
            var ttc = montantHT + (montantHT * tva / 100);
            $('input[name="montant_ttc"]').val(ttc.toFixed(2));
        }
        
        // Calculate TTC when montant HT or TVA changes
        $('input[name="montant_ht"], input[name="tva"]').on('input', function() {
            calculateTTC();
        });
        
        // Form validation
        $('.needs-validation').on('submit', function(event) {
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            $(this).addClass('was-validated');
        });
        
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        $('input[name="date_depense"]').val(today);

        function loadFournisseur(){
            $.ajax({
                url :"{% url 't_tresorerie:ApiLoadFournisseur' %}",
                dataType : "JSON",
                type : "GET",
                success: function(data){
                    var option = "<option value='0'>Veuillez sélectionner un fournisseur</option>";
                    $.each(data, function(index, p){
                        option += "<option value="+p.id+">"+p.designation+"</option>";
                    });
                    $('#fournisseur').html(option);
                }
            })
        }
        
        loadFournisseur();

        $(document).on('click','#btnSaveDepense', function(e){
            // Prevent default form submission if validity check passes, handled by ajax below
            // But we need to check validity first
            var form = $('#expenseForm')[0];
            if (!form.checkValidity()) {
                 form.reportValidity();
                 return;
            }
            e.preventDefault();

            var btn = $(this); // référence du bouton
            btn.prop('disabled', true); // désactive le bouton

            // Optionnel : afficher un spinner pour indiquer le chargement
            var originalText = btn.html();
            btn.html(`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Envoi en cours...
            `);

             // Récupération des valeurs
            var formData = new FormData();
            formData.append('label', $('#label').val());
            formData.append('fournisseur', $('#fournisseur').val());
            formData.append('typeSelect', $('#typeSelect').val());
            formData.append('typeSelectSousCategorie', $('#typeSelectSousCategorie').val());
            formData.append('date_depense', $('#date_depense').val());
            formData.append('montant_ht', $('#montant_ht').val());
            formData.append('tva', $('#tva').val());
            formData.append('montant_ttc', $('#montant_ttc').val());
            formData.append('description', $('#description').val());
            formData.append('mode_paiement', $('#mode_paiement').val());
            formData.append('reference_paiement', $('#reference_paiement').val());
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // FICHIER
            var piece = $('#piece')[0].files[0];
            if (piece) {
                formData.append('piece', piece);
            }

            $.ajax({
                url : "{% url 't_tresorerie:ApiStoreDepense' %}",
                type: "POST",
                dataType : "JSON",
                data : formData,
                processData: false,
                contentType: false,
                success: function(response){
                    if (response.status === "success"){
                        let spinner = document.createElement("div");
                        spinner.innerHTML = `
                            <div id="loadingSpinner" style="
                                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                z-index: 9999;
                                backdrop-filter: blur(3px);">
                                <div class="modern-spinner" style="width: 60px;height: 60px;border: 5px solid #e0e0e0;border-top: 5px solid #f06548;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 20px;"></div>
                                <div class="success-message" style="
                                    font-family: Arial, sans-serif;
                                    font-size: 18px;
                                    color: #f06548;
                                    font-weight: 500;
                                    text-align: center;
                                    margin-bottom: 10px;">
                                    <i class="ri-check-line" style="font-size: 24px; margin-right: 8px;"></i>Enregistrement en cours ...
                                </div>
                                
                            </div>
                            <style>
                                @keyframes spin {
                                    0% { transform: rotate(0deg); }
                                    100% { transform: rotate(360deg); }
                                }
                                .modern-spinner {
                                    width: 60px;
                                    height: 60px;
                                    border: 5px solid #e0e0e0;
                                    border-top: 5px solid #f06548;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                }
                            </style>
                        `;
                        document.body.appendChild(spinner);
                        setTimeout(function() {
                            window.location.href= "{% url 't_tresorerie:PageDepenses' %}";
                        }, 1000);
                    }else{
                        // Fallback if alertify is not defined
                        if(typeof alertify !== 'undefined'){
                             alertify.error("Une erreur c'est produite lors du traitement de la requete.");
                        } else {
                             alert("Une erreur c'est produite lors du traitement de la requete.");
                        }
                    }
                },
                complete: function() {
                    // Réactiver le bouton et restaurer son texte après la requête
                    btn.prop('disabled', false);
                    btn.html(originalText);
                }

            })
        });
    });
</script>
{% endblock content %}