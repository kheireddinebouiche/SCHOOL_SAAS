{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité/Dépenses - Types de dépenses {% endblock title %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .icon-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    /* Update badge styles with low opacity but visible text */
    .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.2) !important;
        color: #28a745 !important;
        font-weight: 500 !important;
    }

    .badge.bg-warning {
        background-color: rgba(255, 193, 7, 0.2) !important;
        color: #ffc107 !important;
        font-weight: 500 !important;
    }

    .badge.bg-primary {
        background-color: rgba(59, 125, 221, 0.2) !important;
        color: #3b7ddd !important;
        font-weight: 500 !important;
    }

    .badge.bg-danger {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
        font-weight: 500 !important;
    }

    .badge.bg-info {
        background-color: rgba(23, 162, 184, 0.2) !important;
        color: #17a2b8 !important;
        font-weight: 500 !important;
    }

    /* Add search box styling */
    .search-box {
        position: relative;
    }

    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none; /* Make sure icon doesn't block input */
    }

    /* Ensure search input is accessible */
    #table-filter {
        padding-right: 40px; /* Space for search icon */
        z-index: 1; /* Ensure input is above icon */
    }

    /* Table styling */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }

    .table td {
        vertical-align: middle;
    }

    /* Rounded elements */
    .rounded-pill {
        border-radius: 50rem !important;
    }

    /* Avatar styling */
    .avatar-sm {
        height: 3rem;
        width: 3rem;
    }

    .avatar-title {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
    }
    
    /* Additional styles for harmonized design */
    .modal-content {
        border-radius: 0.75rem !important; /* 12px rounded corners like the presence modal */
    }
    
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
    
    .btn {
        border-radius: 0.5rem !important; /* More consistent rounded buttons */
    }
</style>

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">

    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-money-euro-circle-line text-danger"></i>
                            </div>
                            <h4 class="mb-0 text-danger">Types de dépenses</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Comptabilité</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Dépenses</a>
                                    </li>
                                    <li class="breadcrumb-item active">Types</li>
                                </ol>
                            </nav>
                            <button class="btn btn-danger rounded-pill" id="refreshTypeDepenses">
                                <i class="ri-refresh-line me-1"></i>Actualiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Statistics Section - Not applicable for types but kept for consistent layout -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-list-check-2 text-primary fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalTypes">0</h5>
                                    <p class="mb-0 text-muted small">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-checkbox-circle-line text-success fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="activeTypes">0</h5>
                                    <p class="mb-0 text-muted small">Actifs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-time-line text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="inactiveTypes">0</h5>
                                    <p class="mb-0 text-muted small">Inactifs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-3 bg-info bg-opacity-10 stat-card">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-info bg-opacity-10 rounded-circle icon-center me-3">
                                    <i class="ri-money-cny-circle-line text-info fs-5"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold" id="totalMontantTypes">0 DA</h5>
                                    <p class="mb-0 text-muted small">Total Montant</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-header border-0 bg-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-filter text-info me-2"></i>
                                    <h5 class="card-title mb-0 text-info">Filtres</h5>
                                </div>

                                <div class="d-flex align-items-center gap-3">
                                    <div class="search-box position-relative">
                                        <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px; z-index: 1;">
                                        <i class="fas fa-search text-muted search-icon" style="pointer-events: none;"></i>
                                    </div>

                                    <div class="d-flex align-items-center">
                                        <label for="typeStatusFilter" class="me-2 mb-0">Statut:</label>
                                        <select id="typeStatusFilter" class="form-select form-select-sm rounded-pill" style="width: 180px;">
                                            <option value="">Tous les statuts</option>
                                            <option value="active">Actif</option>
                                            <option value="inactive">Inactif</option>
                                        </select>
                                    </div>

                                    <div>
                                        <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addTypeModal">
                                            <i class="fas fa-plus me-1"></i>Nouveau
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-3">
                            <div class="table-responsive">
                                <table id="example" class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Nom de la Catégorie</th>
                                            <th class="border-0">Date de Création</th>
                                            <th class="border-0 rounded-end text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listeTypes">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- "Streamlined Focus" Expense Type Modal -->
<div class="modal fade" id="addTypeModal" tabindex="-1" aria-labelledby="addTypeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-body p-4 p-sm-5">
        
        <div class="text-center mb-4">
           <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-10 text-danger rounded-circle mb-3" style="width: 64px; height: 64px;">
              <i class="ri-price-tag-3-line fs-2"></i>
           </div>
           <h4 class="modal-title fw-bold" id="addTypeModalLabel">Nouveau Type</h4>
           <p class="text-muted small">Configurez les classifications de vos dépenses</p>
        </div>

        <form id="typeForm">
          <input type="hidden" id="typeId">
          
          <div class="form-floating mb-3">
            <input type="text" class="form-control rounded-3" id="typeName" placeholder="Nom du type" required>
            <label for="typeName">Nom du type</label>
          </div>

          <div class="form-floating mb-4">
            <select class="form-select rounded-3" id="typeCategory" aria-label="Catégorie parente">
              <option value="">Aucune (Principal)</option>
              <!-- Options loaded via AJAX -->
            </select>
            <label for="typeCategory">Catégorie Parente (Optionnel)</label>
          </div>

          <div class="d-grid gap-2">
             <button type="button" class="btn btn-primary btn-lg rounded-pill shadow-sm" id="saveTypeBtn">
               <i class="ri-check-line me-1"></i> Enregistrer
             </button>
             <button type="button" class="btn btn-light btn-lg rounded-pill" data-bs-dismiss="modal">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal for confirming deletion -->
<div class="modal fade deleteModal" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <lord-icon src="https://cdn.lordicon.com/hwjcdycb.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:120px;height:120px">
                </lord-icon>
                <div class="mt-4">
                    <h4 class="mb-3">Vous êtes sur le point de supprimer le type de dépense</h4>
                    <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                    <div class="hstack gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill me-2" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-danger rounded-pill" id="confirmDeleteBtn">Supprimer</button>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<script>
    $(document).ready(function(){

        // Load categories for the dropdown
        function loadCategories(excludeId = null){
            $.ajax({
                url : "{% url 't_tresorerie:ApiLoadDepensesCategories' %}",
                dataType : "JSON",
                type : "GET",
                success : function(data){
                    var options = '<option value="">Aucune (Catégorie Racine)</option>';
                    if(data.length > 0){
                        $.each(data, function(index, cat){
                            // Prevent selecting itself as parent
                            if(!excludeId || cat.id != excludeId) {
                                var displayName = (cat.parent_name ? cat.parent_name + " > " : "") + cat.name;
                                options += '<option value="'+cat.id+'">'+displayName+'</option>';
                            }
                        });
                    }
                    $('#typeCategory').html(options);
                    $('#totalTypes').text(data.length); 
                    
                    // Simple stats calculation
                    var activeCount = data.length; // All considered active for now
                    $('#activeTypes').text(activeCount);
                    $('#inactiveTypes').text(0);
                },
                error: function(){
                    console.log("Error loading categories");
                }
            });
        }

        function loadItems(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiLoadDepensesCategories' %}",
                dataType : "JSON",
                type : "GET",
                success : function(data){
                    // Organize data into a tree
                    const tree = {};
                    const roots = [];
                    
                    data.forEach(item => {
                        tree[item.id] = { ...item, children: [] };
                    });

                    data.forEach(item => {
                        if (item.parent_id) {
                            if (tree[item.parent_id]) {
                                tree[item.parent_id].children.push(tree[item.id]);
                            }
                        } else {
                            roots.push(tree[item.id]);
                        }
                    });

                    // Recursive render
                    function renderTree(nodes, level = 0) {
                        let html = '';
                        nodes.forEach(node => {
                            const padding = level * 30;
                            const icon = level > 0 ? '<i class="ri-corner-down-right-line text-muted me-2"></i>' : '<i class="ri-folder-line text-primary me-2"></i>';
                            
                            html += '<tr>';
                                html += '<td style="padding-left: ' + (padding + 10) + 'px;">';
                                    html += '<div class="d-flex align-items-center">';
                                        html += icon;
                                        html += '<span class="fw-medium">' + node.name + '</span>';
                                    html += '</div>';
                                html += '</td>';
                                html += '<td>' + (node.created_at || '-') + '</td>';
                                html += '<td class="text-center">';
                                    html += '<div class="dropdown">';
                                        html += '<button class="btn btn-soft-secondary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                                            html += '<i class="ri-more-fill align-middle"></i>';
                                        html += '</button>';
                                        html += '<ul class="dropdown-menu dropdown-menu-end">';
                                            html += '<li><a class="dropdown-item edit-item-btn" href="#" data-id="' + node.id + '" data-name="'+node.name+'" data-parent="'+(node.parent_id || '')+'"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</a></li>';
                                            html += '<li><a class="dropdown-item remove-item-btn" href="#" data-id="' + node.id + '"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer</a></li>';
                                        html += '</ul>';
                                    html += '</div>';
                                html += '</td>';
                            html += '</tr>';
                            
                            if (node.children.length > 0) {
                                html += renderTree(node.children, level + 1);
                            }
                        });
                        return html;
                    }

                    if (roots.length > 0) {
                        $('#listeTypes').html(renderTree(roots));
                    } else {
                         $('#listeTypes').html(`
                            <tr>
                                <td colspan="3">
                                    <div class="text-center py-5">
                                        <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                            <i class="ri-folder-add-line text-primary" style="font-size: 32px;"></i>
                                        </div>
                                        <h5 class="mb-2">Aucun type de dépense défini</h5>
                                        <p class="text-muted mb-4">Commencez par ajouter votre premier type de dépense pour classer vos sorties.</p>
                                        <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addTypeModal">
                                            <i class="ri-add-line me-1"></i> Créer un type
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                    $('#totalTypes').text(data.length);
                },
            });
        }

        // Load initial data
        loadItems();
        loadCategories();

        // Refresh button
        $('#refreshTypeDepenses').click(function(){
            loadItems();
            loadCategories();
        });

        // Add edit functionality
        $(document).on('click', '.edit-item-btn', function() {
            const id = $(this).data('id');
            const name = $(this).data('name');
            const parent = $(this).data('parent');
            
            $('#typeId').val(id);
            $('#typeName').val(name);
            
            // Reload categories excluding self to prevent cycle
            loadCategories(id);
            
            // Wait for load to finish or just set it
            setTimeout(function(){
                 $('#typeCategory').val(parent);
            }, 500);

            $('#addTypeModalLabel').text('Modifier le Type');
            $('#addTypeModal .text-muted.small').text('Modifiez les informations de ce type de dépense');
            $('#saveTypeBtn').html('<i class="ri-check-line me-1"></i> Mettre à jour');
            $('#addTypeModal').modal('show');
        });

        // Save functionality
        $(document).on('click','#saveTypeBtn', function(){
            var typeName = $('#typeName').val();
            var parentId = $('#typeCategory').val();
            var typeId = $('#typeId').val(); // If empty, create. If set, update.
            var btn = $(this);
            
            if (!typeName){
                return alertify.error("Le nom est obligatoire");
            }

            btn.prop('disabled', true);
            var originalText = btn.html();
            btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Envoi...');

            var url = typeId ? "{% url 't_tresorerie:ApiUpdateDepenseCategory' %}" : "{% url 't_tresorerie:ApiStoreDepenseCategory' %}";
            
            $.ajax({
                url : url,
                dataType: "JSON",
                type : "POST",
                data: {
                    'id': typeId,
                    'name' : typeName,
                    'parent_id' : parentId, 
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status === "success"){
                        alertify.success(response.message);
                        loadItems();
                        loadCategories(); 
                        $('#addTypeModal').modal('hide');
                    }else{
                        alertify.error(response.message);
                    }
                },
                error: function() {
                     alertify.error("Erreur serveur");
                },
                 complete: function() {
                    btn.prop('disabled', false);
                    btn.html(originalText);
                }

            });
        });

        // Delete functionality
        $(document).on('click', '.remove-item-btn', function() {
            const id = $(this).data('id');
            $('#confirmDeleteBtn').data('id', id);
            // bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteModal')).show();
            // Note: HTML has class 'deleteModal' but ID logic was missing in snippet for modal selection? 
            // The HTML snippet showed: <div class="modal fade deleteModal" ...> NO ID.
            // I should fix the modal selector. It effectively selects by class in previous code?
            // Previous code: $('.deleteModal').modal('show'); OR $('#deleteModal').modal('show');
            // The HTML snippet in Step 111 line 374: class="modal fade deleteModal".
            // It does NOT have id="deleteModal". I should fix that selector.
            $('.deleteModal').modal('show');
        });

        // Confirm deletion
        $('#confirmDeleteBtn').click(function() {
            const id = $(this).data('id');
            
            $.ajax({
                url: "{% url 't_tresorerie:ApiDeleteDepenseCategory' %}",
                type: "GET",
                data: {'id': id},
                success: function(response) {
                    if(response.status === "success") {
                         $('.deleteModal').modal('hide');
                         alertify.success(response.message);
                         loadItems();
                         loadCategories();
                    } else {
                        alertify.error(response.message);
                    }
                },
                error: function() {
                    alertify.error("Erreur lors de la suppression");
                }
            });
        });

        // Clear form when modal is closed
        $('#addTypeModal').on('hidden.bs.modal', function() {
            $('#typeName').val('');
            $('#typeCategory').val('');
            $('#typeId').val('');
            loadCategories(); // Reset options (remove exclusions)
            $('#addTypeModalLabel').text('Nouveau Type');
            $('#addTypeModal .text-muted.small').text('Configurez les classifications de vos dépenses');
            $('#saveTypeBtn').html('<i class="ri-check-line me-1"></i> Enregistrer');
        });
    });
</script>


{% endblock content %}