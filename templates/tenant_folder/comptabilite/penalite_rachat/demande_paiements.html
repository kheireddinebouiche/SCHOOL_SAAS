{% extends 'tenant_folder/base.html' %}
{% load static %}

{% block title %}Demandes de Paiement{% endblock title %}

{% block content %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      
      <!-- Page Title -->
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0 text-uppercase">Demandes de Paiement</h4>
             <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">Comptabilité</a></li>
                    <li class="breadcrumb-item active">Pénalités & Rachat</li>
                </ol>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header align-items-center d-flex">
              <h4 class="card-title mb-0 flex-grow-1">Liste des paiements dus (Dettes, Rachats, Autres)</h4>
              <div class="flex-shrink-0">
                  <button type="button" class="btn btn-soft-primary btn-sm" onclick="loadDuePaiements()">
                      <i class="ri-refresh-line align-middle me-1"></i> Actualiser
                  </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle table-nowrap mb-0" id="duePaiementsTable">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Client</th>
                      <th scope="col">Libellé</th>
                      <th scope="col">Type</th>
                      <th scope="col">Date due</th>
                      <th scope="col">Date Paiement</th>
                      <th scope="col">Montant Dû</th>
                      <th scope="col" class="text-center">Statut</th>
                      <th scope="col" class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="duePaiementsList">
                    <tr>
                      <td colspan="6" class="text-center py-5">
                          <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Chargement...</span>
                          </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% csrf_token %}

      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-danger bg-opacity-10 border-0 px-4 py-3">
              <div class="d-flex align-items-center">
                <div class="avatar-sm rounded-circle bg-danger bg-opacity-10 text-danger d-flex align-items-center justify-content-center me-3">
                  <i class="ri-delete-bin-line fs-5"></i>
                </div>
                <div>
                  <h5 class="modal-title fw-semibold text-dark">Confirmer la suppression</h5>
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-4 text-center">
              <div class="avatar-lg mx-auto mb-3">
                <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                  <i class="ri-delete-bin-line"></i>
                </div>
              </div>
              
              <h5 class="mb-3">Êtes-vous sûr ?</h5>
              <p class="text-muted mb-4">Êtes-vous sûr de vouloir supprimer ce paiement dû ? Cette action est irréversible.</p>

              <div class="d-flex gap-2 justify-content-center mt-4">
                <button type="button" class="btn btn-light w-sm" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger w-sm" id="confirmDeleteBtn">Oui, supprimer !</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Confirmation Modal -->
      <div class="modal fade" id="paymentConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-success bg-opacity-10 border-0 px-4 py-3">
              <div class="d-flex align-items-center">
                <div class="avatar-sm rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center me-3">
                  <i class="ri-money-dollar-circle-line fs-5"></i>
                </div>
                <div>
                  <h5 class="modal-title fw-semibold text-dark">Confirmer le paiement</h5>
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-4 text-center">
              <div class="avatar-lg mx-auto mb-3">
                <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                  <i class="ri-wallet-3-line"></i>
                </div>
              </div>
              
              <h5 class="mb-3">Effectuer le paiement</h5>
              <p class="text-muted mb-4">Voulez-vous confirmer le paiement de la somme de :</p>
              
              <h2 class="text-success fw-bold mb-4"><span id="paymentAmountDisplay">0.00</span> DZD</h2>

              <div class="d-flex gap-2 justify-content-center mt-4">
                <button type="button" class="btn btn-light w-sm" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success w-sm" id="confirmPayBtn">Oui, confirmer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Receipt Preview Modal -->
      <div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0 px-4 py-3 bg-light">
              <h5 class="modal-title fw-semibold text-dark">Aperçu du Reçu</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="receiptFrame" style="width: 100%; height: 500px; border: none;"></iframe>
            </div>
            <div class="modal-footer border-0 px-4 py-3 bg-light">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="printReceiptFrame()">
                    <i class="ri-printer-line me-1"></i> Imprimer
                </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    loadDuePaiements();
    
    // Handle delete confirmation
    var deleteId = null;
    var payId = null;
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    window.deleteDuePaiement = function(id) {
        deleteId = id;
        var myModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        myModal.show();
    };

    window.payDuePaiement = function(id, amount) {
        payId = id;
        document.getElementById('paymentAmountDisplay').innerText = parseFloat(amount).toFixed(2);
        var myModal = new bootstrap.Modal(document.getElementById('paymentConfirmationModal'));
        myModal.show();
    };

    window.openReceiptModal = function(url) {
        var frame = document.getElementById('receiptFrame');
        frame.src = url;
        var myModal = new bootstrap.Modal(document.getElementById('receiptModal'));
        myModal.show();
    };

    window.printReceiptFrame = function() {
        var frame = document.getElementById('receiptFrame');
        frame.contentWindow.print();
    };

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if(!deleteId) return;
        
        var btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Suppression...';

        var formData = new FormData();
        formData.append('id', deleteId);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch("{% url 't_tresorerie:ApiDeleteDuePenalite' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(res => {
            if (res.status === 'success') {
                alertify.success(res.message);
                var modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
                modal.hide();
                loadDuePaiements();
            } else {
                alertify.error(res.message || 'Une erreur est survenue.');
            }
        })
        .catch(err => {
            console.error(err);
            alertify.error('Erreur lors de la suppression.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Oui, supprimer !';
            deleteId = null;
        });
    });

    document.getElementById('confirmPayBtn').addEventListener('click', function() {
        if(!payId) return;
        
        var btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Traitement...';

        var formData = new FormData();
        formData.append('id', payId);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch("{% url 't_tresorerie:ApiPayDuePenalite' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(res => {
            if (res.status === 'success') {
                alertify.success(res.message);
                var modal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmationModal'));
                modal.hide();
                
                // If payment creation returned an ID, we could auto-print here or just reload
                loadDuePaiements();
            } else if (res.status === 'info') {
                alertify.message(res.message);
                var modal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmationModal'));
                modal.hide();
                loadDuePaiements(); 
            } else {
                alertify.error(res.message || 'Une erreur est survenue.');
            }
        })
        .catch(err => {
            console.error(err);
            alertify.error('Erreur lors du paiement.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Oui, confirmer';
            payId = null;
        });
    });
  });

  function loadDuePaiements() {
    // Show loader
    var loaderHtml = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div></td></tr>';
    document.getElementById('duePaiementsList').innerHTML = loaderHtml;

    fetch("{% url 't_tresorerie:ApiListeDuePenalite' %}")
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur réseau');
        }
        return response.json();
      })
      .then(data => {
        var rows = '';
        if (data.length === 0) {
          rows = `
            <tr>
              <td colspan="8" class="text-center py-5">
                <div class="avatar-lg mx-auto mb-3">
                  <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                    <i class="ri-inbox-archive-line"></i>
                  </div>
                </div>
                <h5 class="mb-2">Aucun paiement trouvé</h5>
                <p class="text-muted mb-0">Aucun paiement dû de type dette, rachat ou autre à afficher pour le moment.</p>
              </td>
            </tr>
          `;
        } else {
          data.forEach(item => {
            var statusBadge = item.is_done 
              ? '<span class="badge bg-success-subtle text-success">Payé</span>' 
              : '<span class="badge bg-warning-subtle text-warning">En attente</span>';
            
            var typeBadgeClass = 'bg-info-subtle text-info';
            if (item.type === 'Rachât de crédit') typeBadgeClass = 'bg-danger-subtle text-danger';
            else if (item.type === 'Module en dette') typeBadgeClass = 'bg-secondary-subtle text-secondary';
            
            var actionButtons = '';
            if(!item.is_done){
                actionButtons = `
                    <button class="btn btn-sm btn-soft-success me-1" onclick="payDuePaiement(${item.id}, '${item.montant_due}')">
                        <i class="ri-money-dollar-circle-line"></i>
                    </button>
                    <button class="btn btn-sm btn-soft-danger" onclick="deleteDuePaiement(${item.id})">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                `;
            } else {
                 var printUrl = "{% url 't_tresorerie:PrintReceipt' 0 %}".replace('0', item.paiement_id || 0); // Handle null case temporarily
                 
                actionButtons = `
                     <button class="btn btn-sm btn-soft-secondary me-1" disabled>
                        <i class="ri-check-double-line"></i>
                    </button>
                    <button class="btn btn-sm btn-soft-primary me-1" onclick="openReceiptModal('${printUrl}')" title="Imprimer le reçu">
                        <i class="ri-printer-line"></i>
                    </button>
                    <button class="btn btn-sm btn-soft-danger" onclick="deleteDuePaiement(${item.id})">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                `;
            }

            rows += `
              <tr>
                <td class="fw-medium">${item.client}</td>
                <td>${item.label || '-'}</td>
                <td><span class="badge ${typeBadgeClass}">${item.type || '-'}</span></td>
                <td>${item.date_echeance || '-'}</td>
                <td>${item.date_paiement || '-'}</td>
                <td>${parseFloat(item.montant_due).toFixed(2)} DZD</td>
                <td class="text-center">${statusBadge}</td>
                <td class="text-center">
                    ${actionButtons}
                </td>
              </tr>
            `;
          });
        }
        document.getElementById('duePaiementsList').innerHTML = rows;
      })
      .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('duePaiementsList').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Erreur lors du chargement des données.</td></tr>';
      });
  }
</script>
{% endblock %}