{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Comptabilité - Liste des factures{% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* Empêche l'icône de capturer les événements souris */
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }

  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }

  .table td.text-end {
    position: relative;
    overflow: visible;
  }

  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }

  .dropdown {
    z-index: 10;
  }

  .name-dropdown {
    vertical-align: middle;
  }

  .name-dropdown .btn {
    border: none;
    padding: 0.25rem;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="fas fa-file-invoice text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Liste des factures</h4>
            </div>
            <div class="d-flex align-items-center gap-2">

              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Comptabilité</a>
                  </li>
                  <li class="breadcrumb-item active">Facturation</li>
                  <li class="breadcrumb-item active">Liste des factures</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->
      <div class="row">
        <!-- KPIs Section -->
        <div class="col-12 mb-4">
          <div class="row g-3">
            <!-- Total Factures -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-file-list-line text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Total Factures</h5>
                      <h3 class="mb-0 fw-bold" id="totalFactures">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Factures Brouillon -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-file-edit-line text-warning fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Brouillon</h5>
                      <h3 class="mb-0 fw-bold" id="brouillonCount">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Factures Validées -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-checkbox-circle-line text-info fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Validées</h5>
                      <h3 class="mb-0 fw-bold" id="valideCount">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Factures Payées -->
            <div class="col-md-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-circle p-3 me-3">
                      <i class="ri-check-double-line text-success fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 text-muted">Payées</h5>
                      <h3 class="mb-0 fw-bold" id="payeCount">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>

                  <select id="filter-state" class="form-select rounded-pill" style="width: 220px;">
                    <option value="0">Filtrer par état</option>
                    <option value="brouillon">Brouillon</option>
                    <option value="valide">Validée</option>
                    <option value="paye">Payée</option>
                  </select>

                  <select id="date_filter" class="form-select rounded-pill" style="width: 220px;">
                    <option value="0">Filtrer par date</option>
                    <option value="-created_at">Date (récent)</option>
                    <option value="created_at">Date (ancien)</option>
                  </select>

                  <button type="button" class="btn btn-primary rounded-pill">
                    <i class="ri-add-line me-1"></i> Nouvelle facture
                  </button>
                </div>
              </div>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <!-- Table View -->
              <div class="table-responsive bg-white rounded" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Numéro</th>
                      <th class="border-0">Client</th>
                      <th class="border-0">Date</th>
                      <th class="border-0">Échéance</th>
                      <th class="border-0">Montant</th>
                      <th class="border-0">État</th>
                      <th class="border-0">Créée le</th>
                      <th class="border-0 rounded-end text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeItem" class="border-top-0"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!--Modal-->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer cette facture. Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100"></div>
      </div>
    </div>
  </div>
</div>
<!-- /.modal -->

<script>
// JavaScript pour la gestion des factures
document.addEventListener('DOMContentLoaded', function() {
  // Fonction pour charger les données des factures
  function loadFactures() {
    // Ici, on pourrait charger les données via une API ou via des données préchargées
    // Pour l'exemple, on utilisera des données fictives
    const factures = [
      {
        id: 1,
        numero: 'FAC-2024-001',
        client: 'Entreprise ABC',
        date: '2024-01-15',
        echeance: '2024-02-15',
        montant: 2500.00,
        etat: 'brouillon'
      },
      {
        id: 2,
        numero: 'FAC-2024-002',
        client: 'M. Jean Dupont',
        date: '2024-01-20',
        echeance: '2024-02-20',
        montant: 1200.50,
        etat: 'valide'
      },
      {
        id: 3,
        numero: 'FAC-2024-003',
        client: 'Société XYZ',
        date: '2024-01-10',
        echeance: '2024-02-10',
        montant: 4800.75,
        etat: 'paye'
      }
    ];

    // Mettre à jour les statistiques
    updateStats(factures);

    // Afficher les factures dans le tableau
    displayFacturesInTable(factures);
  }
  
  // Fonction pour mettre à jour les statistiques
  function updateStats(factures) {
    document.getElementById('totalFactures').textContent = factures.length;
    
    const brouillon = factures.filter(f => f.etat === 'brouillon').length;
    const valide = factures.filter(f => f.etat === 'valide').length;
    const paye = factures.filter(f => f.etat === 'paye').length;
    
    document.getElementById('brouillonCount').textContent = brouillon;
    document.getElementById('valideCount').textContent = valide;
    document.getElementById('payeCount').textContent = paye;
  }
  
  // Fonction pour afficher les factures dans le tableau
  function displayFacturesInTable(factures) {
    const tbody = document.getElementById('listeItem');
    tbody.innerHTML = '';
    
    factures.forEach(facture => {
      const row = document.createElement('tr');
      
      // Déterminer la classe pour l'état de la facture
      let etatClass = '';
      let etatText = '';
      switch(facture.etat) {
        case 'brouillon':
          etatClass = 'badge bg-warning bg-opacity-25 text-warning border border-warning border-opacity-25 prospect-state-badge en_attente';
          etatText = 'Brouillon';
          break;
        case 'valide':
          etatClass = 'badge bg-info bg-opacity-25 text-info border border-info border-opacity-25 prospect-state-badge';
          etatText = 'Validée';
          break;
        case 'paye':
          etatClass = 'badge bg-success bg-opacity-25 text-success border border-success border-opacity-25 prospect-state-badge confirme';
          etatText = 'Payée';
          break;
        default:
          etatClass = 'badge bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25';
          etatText = 'Inconnu';
      }
      
      row.innerHTML = `
        <td>${facture.numero}</td>
        <td>${facture.client}</td>
        <td>${facture.date}</td>
        <td>${facture.echeance}</td>
        <td>${facture.montant.toFixed(2)} €</td>
        <td><span class="${etatClass}">${etatText}</span></td>
        <td>${facture.date}</td>
        <td class="text-center">
          <div class="dropdown">
            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-eye me-2"></i> Voir</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i> Modifier</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-download me-2"></i> Télécharger</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger delete-btn" href="#" data-facture-id="${facture.id}"><i class="fas fa-trash me-2"></i> Supprimer</a></li>
            </ul>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
    });
    
    // Ajouter les écouteurs d'événements pour la suppression
    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', function() {
        const factureId = this.getAttribute('data-facture-id');
        // Ouvrir la modal de confirmation de suppression
        const deleteModal = new bootstrap.Modal(document.querySelector('.deleteModal'));
        deleteModal.show();
        
        // Ajouter la fonctionnalité de suppression à la modal
        document.querySelector('.deleteModal .hstack').innerHTML = `
          <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-danger rounded-pill" onclick="confirmDelete(${factureId})">Supprimer</button>
        `;
      });
    });
  }
  
  // Fonction pour confirmer la suppression
  function confirmDelete(factureId) {
    console.log('Suppression de la facture:', factureId);
    // Ici, on ferait l'appel API pour supprimer la facture
    // Pour l'exemple, on recharge juste la liste
    loadFactures();
    const deleteModal = bootstrap.Modal.getInstance(document.querySelector('.deleteModal'));
    deleteModal.hide();
  }
  
  // Charger les données initiales
  loadFactures();
  
  // Écouteur pour le changement de filtre par état
  document.getElementById('filter-state').addEventListener('change', function() {
    // Ici, on pourrait filtrer les données selon l'état sélectionné
    // Pour l'exemple, on recharge la liste complète
    loadFactures();
  });
});
</script>

{% endblock content %}