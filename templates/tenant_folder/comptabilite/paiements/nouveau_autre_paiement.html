{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité - Nouveau paiement autre {% endblock title %}

{% block content %}
<style>
    .form-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
</style>

<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-money-euro-circle-line text-success"></i>
                            </div>
                            <h4 class="mb-0 text-success">Nouveau paiement autre</h4>
                        </div>
                        <div class="page-title-right">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);" class="text-muted">
                                            <i class="ri-home-line me-1"></i>Comptabilité
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="{% url 't_tresorerie:pageautrespaiement' %}" class="text-muted">
                                            Paiements autres
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active text-success">Nouveau paiement autre</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow border-0 rounded-3">
                        <div class="card-header bg-gradient-success text-white p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0">
                                    <i class="ri-money-euro-circle-line me-2"></i>Formulaire d'ajout d'un paiement autre
                                </h4>
                                <span class="badge bg-white text-success px-3 py-2">Paiement</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                                <!-- Informations générales -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-file-text-line text-success me-2"></i>
                                        <h5 class="text-success mb-0">Informations générales</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-6">
                                            <label class="form-label">Client</label>
                                            <select class="form-select" id="client" name="client">
                                                <option value="">Veuillez sélectionner un client</option>
                                            </select>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Libellé *</label>
                                            <input type="text" class="form-control" id="label" name="label" required>
                                            <div class="invalid-feedback">Veuillez entrer le libellé du paiement</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Date d'opération *</label>
                                            <input type="date" class="form-control" id="date_operation" name="date_operation" required>
                                            <div class="invalid-feedback">Veuillez sélectionner la date d'opération</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Détails du paiement -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-money-dollar-circle-line text-success me-2"></i>
                                        <h5 class="text-success mb-0">Détails du paiement</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-lg-6">
                                            <label class="form-label">Montant *</label>
                                            <input type="number" step="0.01" class="form-control text-end" id="montant_paiement" name="montant_paiement" required>
                                            <div class="invalid-feedback">Veuillez entrer le montant du paiement</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Date de paiement *</label>
                                            <input type="date" class="form-control" id="date_paiement" name="date_paiement" required>
                                            <div class="invalid-feedback">Veuillez sélectionner la date de paiement</div>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-lg-6">
                                            <label class="form-label">Mode de paiement *</label>
                                            <select class="form-select" id="mode_paiement" name="mode_paiement" required>
                                                <option value="">Veuillez sélectionner le mode de paiement</option>
                                                <option value="chq">Chèque</option>
                                                <option value="vir">Virement</option>
                                                <option value="cach">Cash</option>
                                            </select>
                                            <div class="invalid-feedback">Veuillez sélectionner le mode de paiement</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="form-label">Référence</label>
                                            <input type="text" class="form-control" name="reference" id="reference">
                                            <div class="invalid-feedback">Veuillez entrer une référence valide</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Compte -->
                                <div class="bg-light p-3 rounded-3 mb-3 border">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="ri-account-circle-line text-success me-2"></i>
                                        <h5 class="text-success mb-0">Compte</h5>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Catégorie de paiement</label>
                                            <select class="form-select" id="compte" name="compte">
                                                <option value="">Veuillez sélectionner une catégorie</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit button -->
                                <div class="text-end mt-3">
                                    <button type="button" class="btn btn-light px-4 py-2 me-2" onclick="window.history.back()">
                                        <i class="ri-close-line me-2"></i>Annuler
                                    </button>
                                    <button id='btnSaveAutrePaiement' type="submit" class="btn btn-success px-4 py-2">
                                        <i class="ri-save-line me-2"></i>Enregistrer
                                    </button>
                                </div>
                        </div>
                    </div>
                </div>
                <!--end col-->
            </div>
            <!--end row-->
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>
    $(document).ready(function(){

        // Load clients
        function loadClients(){
            $.ajax({
                url: "{% url 't_tresorerie:api_liste_clients' %}", // Replace with your actual API endpoint
                type: "GET",
                success: function(response) {
                    var select = $('#client');
                    select.empty();
                    select.append('<option value="">Veuillez sélectionner un client</option>');

                    response.forEach(function(client) {
                        select.append('<option value="'+client.id+'">'+client.nom+'</option>');
                    });
                },
                error: function(xhr, status, error) {
                    console.log("Erreur lors du chargement des clients: " + error);
                }
            });
        }

        // Load payment categories
        function loadPaymentCategories(){
            $.ajax({
                url: "{% url 't_tresorerie:ApiListeCategoriesProduits' %}",
                type: "GET",
                success: function(response) {
                    var select = $('#compte');
                    select.empty();
                    select.append('<option value="">Veuillez sélectionner une catégorie</option>');

                    response.data.forEach(function(category) {
                        // Add parent categories
                        if(category.is_parent) {
                            select.append('<option value="'+category.id+'">'+category.name+'</option>');

                            // Add child categories
                            category.children.forEach(function(child) {
                                select.append('<option value="'+child.id+'">-- '+child.name+'</option>');
                            });
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.log("Erreur lors du chargement des catégories: " + error);
                }
            });
        }

        // Load clients and categories on page load
        loadClients();
        loadPaymentCategories();

        // Set today's date as default for date_operation and date_paiement
        var today = new Date().toISOString().split('T')[0];
        $('#date_operation').val(today);
        $('#date_paiement').val(today);

        // Save other payment
        $('#btnSaveAutrePaiement').click(function(){
            var label = $('#label').val();
            var montant_paiement = $('#montant_paiement').val();
            var mode_paiement = $('#mode_paiement').val();
            var date_operation = $('#date_operation').val();
            var reference = $('#reference').val();
            var date_paiement = $('#date_paiement').val();
            var compte = $('#compte').val();
            var client = $('#client').val();

            if(!label || !montant_paiement || !mode_paiement || !date_operation || !date_paiement) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            $.ajax({
                url: "{% url 't_tresorerie:ApiStoreAutrePaiement' %}",
                type: "POST",
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                data: {
                    label: label,
                    montant_paiement: montant_paiement,
                    mode_paiement: mode_paiement,
                    date_operation: date_operation,
                    reference: reference,
                    date_paiement: date_paiement,
                    compte: compte,
                    client: client
                },
                success: function(response) {
                    if(response.success) {
                        alert('Paiement enregistré avec succès');
                        window.location.href = "{% url 't_tresorerie:pageautrespaiement' %}";
                    } else {
                        alert('Erreur lors de l\'enregistrement: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Erreur lors de l\'enregistrement: ' + error);
                }
            });
        });
    });
</script>
{% endblock content %}