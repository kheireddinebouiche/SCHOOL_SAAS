{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Comptabilité/Paiements - Liste des autres paiements {% endblock title %}

{% block content %}
<style>
  .stat-card {
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }

  .icon-center {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
  }

  /* Badge styles consistent with brouillard_caisse */
  .badge.bg-success {
      background-color: rgba(40, 167, 69, 0.2) !important;
      color: #28a745 !important;
      font-weight: 500 !important;
  }

  .badge.bg-warning {
      background-color: rgba(255, 193, 7, 0.2) !important;
      color: #ffc107 !important;
      font-weight: 500 !important;
  }

  .badge.bg-primary {
      background-color: rgba(59, 125, 221, 0.2) !important;
      color: #3b7ddd !important;
      font-weight: 500 !important;
  }

  .badge.bg-danger {
      background-color: rgba(220, 53, 69, 0.2) !important;
      color: #dc3545 !important;
      font-weight: 500 !important;
  }

  .badge.bg-info {
      background-color: rgba(23, 162, 184, 0.2) !important;
      color: #17a2b8 !important;
      font-weight: 500 !important;
  }

  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
    border-bottom: 2px solid #edf2f7;
    text-transform: uppercase;
    font-size: 0.75rem;
  }
  .table td {
    vertical-align: middle;
  }
</style>

<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">

            <!-- Title & Breadcrumb Card -->
            <div class="row mb-3">
                <div class="col-12">
                  <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                    <div class="d-flex align-items-center">
                      <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                        <i class="ri-file-list-3-line text-primary"></i>
                      </div>
                      <h4 class="mb-0 text-primary">Liste des autres paiements</h4>
                    </div>
                    <div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb m-0 bg-transparent">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Comptabilité</a></li>
                                <li class="breadcrumb-item">Paiements</li>
                                <li class="breadcrumb-item active" aria-current="page">Autres paiements</li>
                            </ol>
                        </nav>
                    </div>
                  </div>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6">
                  <div class="card border-0 shadow-sm rounded-3 bg-primary bg-opacity-10 stat-card">
                    <div class="card-body p-3">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle icon-center me-3">
                          <i class="ri-list-check-2 text-primary fs-5"></i>
                        </div>
                        <div>
                          <h5 class="mb-0 fw-bold" id="totalPaiements">0</h5>
                          <p class="mb-0 text-muted small">Total Paiements</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
        
                <div class="col-md-3 col-sm-6">
                  <div class="card border-0 shadow-sm rounded-3 bg-success bg-opacity-10 stat-card">
                    <div class="card-body p-3">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-success bg-opacity-10 rounded-circle icon-center me-3">
                          <i class="ri-checkbox-circle-line text-success fs-5"></i>
                        </div>
                        <div>
                          <h5 class="mb-0 fw-bold" id="paidPaiements">0</h5>
                          <p class="mb-0 text-muted small">Paiements Payés</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
        
                <div class="col-md-3 col-sm-6">
                  <div class="card border-0 shadow-sm rounded-3 bg-warning bg-opacity-10 stat-card">
                    <div class="card-body p-3">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle icon-center me-3">
                          <i class="ri-time-line text-warning fs-5"></i>
                        </div>
                        <div>
                          <h5 class="mb-0 fw-bold" id="partiallyPaidPaiements">0</h5>
                          <p class="mb-0 text-muted small">Partiels</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
        
                <div class="col-md-3 col-sm-6">
                  <div class="card border-0 shadow-sm rounded-3 bg-info bg-opacity-10 stat-card">
                    <div class="card-body p-3">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-info bg-opacity-10 rounded-circle icon-center me-3">
                          <i class="ri-money-dollar-circle-line text-info fs-5"></i>
                        </div>
                        <div>
                          <h5 class="mb-0 fw-bold" id="totalMontant">0 DA</h5>
                          <p class="mb-0 text-muted small">Montant Total</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>

            <!-- Entity Tabs -->
            <ul class="nav nav-pills nav-custom nav-custom-light mb-3" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#all" role="tab" data-id="">
                        Toutes les entités
                    </a>
                </li>
                {% for entite in entites %}
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#entite-{{ entite.id }}" role="tab" data-id="{{ entite.id }}">
                        {{ entite.designation }}
                    </a>
                </li>
                {% endfor %}
            </ul>

            <!-- Filters & Data Table -->
            <div class="row">
                <div class="col-lg-12">
                  <div class="card shadow border-0 rounded-3">
                    <div class="card-header bg-white p-3">
                      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center">
                          <i class="ri-filter-line text-primary me-2"></i>
                          <h5 class="card-title mb-0 text-primary">Liste des opérations</h5>
                        </div>
        
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                          
                          <div class="search-box position-relative">
                            <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill" style="width: 220px; padding-right: 40px;">
                            <i class="ri-search-line text-muted search-icon"></i>
                          </div>

                          <select id="paymentType" class="form-select rounded-pill" style="width: auto;">
                              <option value="">Tous les types</option>
                              <option value="frais_f">Frais de formation</option>
                              <option value="autre">Autres</option>
                              <option value="dette">Module en dette</option>
                              <option value="facture">Paiement facture</option>
                          </select>
        
                          <div class="d-flex align-items-center gap-1">
                            <input type="date" id="dateFrom" class="form-control form-control-sm rounded-pill" style="width: 130px;" placeholder="Du">
                            <span class="text-muted">-</span>
                            <input type="date" id="dateTo" class="form-control form-control-sm rounded-pill" style="width: 130px;" placeholder="Au">
                          </div>

                          <button id="filterByDate" class="btn btn-primary btn-sm rounded-pill">
                            <i class="ri-filter-line me-1"></i>Filtrer
                          </button>
                          <button id="clearDateFilter" class="btn btn-light btn-sm rounded-pill" title="Effacer">
                            <i class="ri-refresh-line"></i>
                          </button>
                          
                          <div class="vr mx-1"></div>

                          <button class="btn btn-soft-success btn-sm rounded-pill" id="refreshPaiements" title="Actualiser">
                              <i class="ri-refresh-line"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-0">
                        <div>
                            <table id="example" class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="border-0 rounded-start ps-4">Client</th>
                                        <th class="border-0">Description</th>
                                        <th class="border-0">Référence</th>
                                        <th class="border-0">Montant</th>
                                        <th class="border-0">Type</th>
                                        <th class="border-0">Mode</th>
                                        <th class="border-0">Date Création</th>
                                        <th class="border-0">Date Effective</th>
                                        <th class="border-0 rounded-end text-center pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="listeItem">
                                    <!-- JS loaded content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                  </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal Supprimer -->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <lord-icon src="https://cdn.lordicon.com/hwjcdycb.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:120px;height:120px">
                </lord-icon>
                <div class="mt-4">
                    <h4 class="mb-3">Vous étes sur le point de supprimer le paiement</h4>
                    <p class="text-muted mb-4">Êtes-vous sûr(e) de vouloir supprimer cet élément ? Cette action est irréversible. </p>
                    <div class="hstack gap-2 justify-content-center">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Détails du Paiement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-muted">Description</label>
                    <p id="detailLabel" class="fw-medium"></p>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Montant</label>
                        <p id="detailMontant" class="fw-bold text-primary"></p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Mode de paiement</label>
                        <p id="detailMode"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Référence</label>
                        <p id="detailRef"></p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Date Opération</label>
                        <p id="detailDateOp"></p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Date Paiement</label>
                    <p id="detailDatePaiement"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

<script>
    $(document).ready(function(){

        function formatMoney(amount) {
            if (typeof amount === 'string') {
                amount = parseFloat(amount);
            }
            if (isNaN(amount)) return '0.00';
            return amount.toLocaleString('fr-FR', {
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2
            }).replace(/\./g, ' '); 
        }

        function loadItems(){
            $.ajax({
                url : "{% url 't_tresorerie:ApiListeAutresPaiements' %}", 
                dataType : 'JSON',
                type : 'GET',
                success : function(data){
                    renderTable(data);
                    // Update statistics
                    updateStatistics(data);
                }
            });
        }

        function renderTable(data) {
            if (data.length > 0){
                var row = "";
                $.each(data, function(index, p){
                    
                    var modeBadge = '<span class="badge bg-secondary">' + (p.mode_paiement || '-') + '</span>';
                    if (p.mode_paiement === 'Espèce') modeBadge = '<span class="badge bg-success">Espèce</span>';
                    else if (p.mode_paiement === 'Chèque') modeBadge = '<span class="badge bg-info">Chèque</span>';
                    else if (p.mode_paiement === 'Virement Bancaire') modeBadge = '<span class="badge bg-primary">Virement</span>';

                    row += "<tr data-contextkey='"+p.context_key+"'>";
                    row += "<td class='ps-4'><div class='fw-medium'>"+p.prospect_nom+' '+p.prospect_prenom+"</div></td>";
                    row += "<td>"+p.description+"</td>";
                    row += "<td><span class='badge bg-light text-dark'>#"+p.num+"</span></td>";
                    row += "<td><span class='fw-bold text-primary'>"+formatMoney(p.montant_paye)+" DA</span></td>";
                    row += "<td data-contextkey='"+p.context_key+"'><span class='badge bg-soft-info text-info'>"+p.context+"</span></td>";
                    row += "<td>"+modeBadge+"</td>";
                    row += "<td><span class='text-muted small'>"+p.date_operation+"</span></td>";
                    row += "<td><strong>"+p.date_paiement+"</strong></td>";
                    row += "<td class='text-center pe-4'>";
                    row += "<div class='dropdown d-inline-block'>";
                    row += "<button class='btn btn-soft-secondary btn-sm dropdown shadow-none' type='button' data-bs-toggle='dropdown' data-bs-boundary='viewport' aria-expanded='false'>";
                    row += "<i class='ri-more-2-fill'></i>";
                    row += "</button>";
                    row += "<ul class='dropdown-menu dropdown-menu-end border-0 shadow-sm'>";
                    row += "<li><a class='dropdown-item details-item-btn d-flex align-items-center' href='#' data-id='"+p.id+"'><i class='ri-eye-line text-primary me-2'></i> Détails</a></li>";
                    row += "<li><a class='dropdown-item edit-item-btn d-flex align-items-center' href='#' data-id='"+p.id+"'><i class='ri-pencil-line text-warning me-2'></i> Modifier</a></li>";
                    row += "<li><a class='dropdown-item remove-item-btn d-flex align-items-center text-danger' href='#' data-id='"+p.id+"'><i class='ri-delete-bin-line me-2'></i> Supprimer</a></li>";
                    row += "</ul>";
                    row += "</div>";
                    row += "</td>";
                    row += "</tr>"

                });
                $('#listeItem').html(row);
            } else {
                var emptyState = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <div class="py-4">
                                <div class="avatar-lg mx-auto mb-4 bg-light rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="ri-folder-open-line display-4 text-muted"></i>
                                </div>
                                <h5 class="text-muted pb-1">Aucun résultat trouvé</h5>
                                <p class="text-muted mb-0">Nous n'avons trouvé aucun paiement correspondant à votre recherche.</p>
                            </div>
                        </td>
                    </tr>
                `;
                $('#listeItem').html(emptyState);
            }
        }

        loadItems();

        $('#refreshPaiements').click(function(){
            loadItems();
        });

        // Filter functionality
        function filterItems() {
            var searchTerm = $('#table-filter').val().toLowerCase();
            var dateFrom = $('#dateFrom').val();
            var dateTo = $('#dateTo').val();
            var paymentType = $('#paymentType').val();
            var entiteId = $('.nav-pills .nav-link.active').data('id');

            // Re-fetch items with filters
            $.ajax({
                url: "{% url 't_tresorerie:ApiListeAutresPaiements' %}",
                dataType: 'JSON',
                type: 'GET',
                data: {
                    entite_id: entiteId
                },
                success: function(data){
                    if (data.length > 0){
                        var filteredData = data;

                        // Apply search filter
                        if (searchTerm) {
                            filteredData = filteredData.filter(function(item) {
                                return (item.prospect_nom && item.prospect_nom.toLowerCase().includes(searchTerm)) ||
                                       (item.prospect_prenom && item.prospect_prenom.toLowerCase().includes(searchTerm)) ||
                                       (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                                       (item.num && item.num.toLowerCase().includes(searchTerm)) ||
                                       (item.montant_paye && item.montant_paye.toString().includes(searchTerm)) ||
                                       (item.context && item.context.toLowerCase().includes(searchTerm)) ||
                                       (item.date_paiement && item.date_paiement.toLowerCase().includes(searchTerm));
                            });
                        }

                        // Apply payment type filter
                        if (paymentType) {
                            filteredData = filteredData.filter(function(item) {
                                return item.context_key && item.context_key.toLowerCase().includes(paymentType.toLowerCase());
                            });
                        }

                        // Apply date filters
                        if (dateFrom || dateTo) {
                            filteredData = filteredData.filter(function(item) {
                                var itemDate = new Date(item.date_paiement);
                                var from = dateFrom ? new Date(dateFrom) : null;
                                var to = dateTo ? new Date(dateTo) : null;

                                if (from && to) {
                                    return itemDate >= from && itemDate <= to;
                                } else if (from) {
                                    return itemDate >= from;
                                } else if (to) {
                                    return itemDate <= to;
                                }
                                return true;
                            });
                        }

                        renderTable(filteredData);
                        updateStatistics(filteredData);
                    }else{
                        var emptyState = `
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <div class="py-4">
                                        <div class="avatar-lg mx-auto mb-4 bg-light rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="ri-folder-open-line display-4 text-muted"></i>
                                        </div>
                                        <h5 class="text-muted pb-1">Aucun résultat trouvé</h5>
                                        <p class="text-muted mb-0">Nous n'avons trouvé aucun paiement correspondant à votre recherche.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        renderTable([]); // Still call renderTable to clear, but manually override or rely on renderTable logic
                        // Actually, renderTable handles the display, so filtering SHOULD just call renderTable([]) 
                        // But wait, renderTable logic ALREADY has the empty state handling now (step 135).
                        // So I just need to make sure filter success calls renderTable([]) when empty.
                        // The existing code: 
                        // }else{
                        //    renderTable([]);
                        //    updateStatistics([]);
                        // }
                        // renderTable([]) will trigger the logic updated in step 135.
                        // So I actually DON'T need to duplicate the HTML here if renderTable handles it.
                        // Let's verify renderTable logic for empty array.
                        
                        // Step 135 updated renderTable: 
                        // if (data.length > 0){ ... } else { var emptyState = ... $('#listeItem').html(emptyState); }
                        
                        // So calling renderTable([]) is sufficient! 
                        // I will double check the filterItems function to see if it calls renderTable([]).
                        
                        renderTable([]);
                        updateStatistics([]);
                    }
                }
            });
        }

        // Search input event
        $('#table-filter').on('input', function() {
            filterItems();
        });

        // Apply filters button click event (also applies payment type filter)
        $('#filterByDate').click(function() {
            filterItems();
        });

        // Clear all filters button click event
        $('#clearDateFilter').click(function() {
            $('#dateFrom').val('');
            $('#dateTo').val('');
            $('#paymentType').val('');  // Reset payment type filter
            filterItems();
        });

        // Payment type filter change event
        $('#paymentType').change(function() {
            filterItems();
        });

        // Tab change event
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            filterItems();
        });


        // Function to update statistics based on filtered data
        function updateStatistics(data) {
            var totalPaiements = data.length;
            var paidPaiements = 0;
            var partiallyPaidPaiements = 0;
            var totalMontant = 0;

            $.each(data, function(index, p) {
                totalMontant += parseFloat(p.montant_paye) || 0;
                // Add logic based on payment status if available in your data
                // Assuming here that context might indicate payment status
                if (p.context && p.context.toLowerCase().includes('payé')) {
                    paidPaiements++;
                } else if (p.context && p.context.toLowerCase().includes('partiel')) {
                    partiallyPaidPaiements++;
                }
            });

            $('#totalPaiements').text(totalPaiements);
            $('#paidPaiements').text(paidPaiements);
            $('#partiallyPaidPaiements').text(partiallyPaidPaiements);
            $('#totalMontant').text(formatMoney(totalMontant) + ' DA');
        }


        // Handle Details Button Click
        $(document).on('click', '.details-item-btn', function(e) {
            e.preventDefault();
            var id = $(this).data('id');
            // Assuming the URL pattern needs to be constructed. 
            // Since we can't easily use DTL inside JS string for ID replacement if not pre-rendered, 
            // we will use a dummy ID like 0 and replace it.
            var url = "{% url 't_tresorerie:ApiGetAutrePaiement' 0 %}".replace('0', id);

            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if(data.error) {
                        alert(data.error);
                    } else {
                        $('#detailLabel').text(data.label);
                        $('#detailMontant').text(formatMoney(data.montant_paiement) + ' DA');
                        
                        var modeLabel = data.mode_paiement;
                        // Mapping mode codes to labels if needed, or backend sends display name?
                        // Backend 'ApiGetAutrePaiement' returns raw 'Espèce', 'Chèque' etc? 
                        // Looking at 'ApiListeAutresPaiements' it uses 'get_mode_paiement_display()'.
                        // But 'ApiGetAutrePaiement' returns 'paiement.mode_paiement' which might be the key ('esp', 'che').
                        // Let's add mapping just in case, or trust the data.
                        // The user code in 'ApiGetAutrePaiement' returns 'mode_paiement': paiement.mode_paiement.
                        // Ideally we should handle the display.
                        
                        if(data.mode_paiement === 'esp') modeLabel = 'Espèce';
                        else if(data.mode_paiement === 'che') modeLabel = 'Chèque';
                        else if(data.mode_paiement === 'vir') modeLabel = 'Virement';
                        // If it's none of these, it might be the full string or another code.
                        
                        $('#detailMode').text(modeLabel);

                        $('#detailRef').text(data.reference || '-');
                        $('#detailDateOp').text(data.date_operation);
                        $('#detailDatePaiement').text(data.date_paiement);

                        $('#detailsModal').modal('show');
                    }
                },
                error: function() {
                    alert("Erreur lors de la récupération des détails.");
                }
            });
        });

    });
</script>
{% endblock content %}