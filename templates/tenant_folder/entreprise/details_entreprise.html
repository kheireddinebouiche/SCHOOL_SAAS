{% extends "tenant_folder/base.html" %}

{% load static %}

{% block title %}Détails de l'entreprise{% endblock title %}

{% block content %}

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">                                                    

            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-building-line text-primary"></i>
                            </div>
                            <h4 class="mb-0 text-primary">Détails de l'entreprise</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">Entreprise</a>
                                    </li>
                                    <li class="breadcrumb-item active">Détails de l'entreprise</li>
                                </ol>
                            </nav>
                            <div class="btn-group">
                              
                                <button type="button" class="btn btn-primary px-4 py-2" id="updateEntrepriseDetailsBtn">
                                    <i class="ri-edit-line me-2"></i>Modifier
                                </button>
                                <a href="/entreprise/liste-des-entreprises/" class="btn btn-light px-4 py-2">
                                    <i class="ri-arrow-left-line me-2"></i>Retour à la liste
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->



            <!-- Première rangée : Informations de l'entreprise -->
            <div class="row mb-4">
                <!-- Informations principales -->
                <div class="col-lg-12">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-building-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-primary mb-1">Informations de l'entreprise</h5>
                                    <p class="text-muted small mb-0">Détails de l'entreprise</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-building-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Désignation</small>
                                    <span class="fw-semibold" id="designation_entreprise">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-map-pin-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Adresse</small>
                                    <span class="fw-semibold" id="adresse_entreprise">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-mail-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Email</small>
                                    <span class="fw-semibold" id="email_entreprise">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-phone-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Téléphone</small>
                                    <span class="fw-semibold" id="telephone_entreprise">-</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-global-line text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Site web</small>
                                    <span class="fw-semibold" id="site_web_entreprise">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Troisième rangée : Logos de l'entreprise -->
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-image-line text-info fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-info mb-1">Logos de l'entreprise</h5>
                                    <p class="text-muted small mb-0">Gestion des logos (logo principal, logo en-tête, logo pied de page)</p>
                                </div>
                                <div class="ms-auto">
                                    <button type="button" class="btn btn-info btn-sm" id="updateLogosBtn">
                                        <i class="ri-upload-2-line me-1"></i>Modifier les logos
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <!-- Logo principal -->
                                <div class="col-md-4 text-center">
                                    <div class="border rounded-3 p-3 bg-light h-100 d-flex flex-column align-items-center justify-content-center">
                                        <h6 class="text-info mb-3">Logo principal</h6>
                                        <div class="logo-container mb-3 position-relative" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; border: 1px solid #dee2e6;">
                                            <img id="logo_img" src="" alt="Logo principal" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                                            <div id="logo_placeholder_icon" class="text-center" style="font-size: 3rem; color: #adb5bd;">
                                                <i class="ri-image-line"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted">Logo utilisé dans les documents principaux</small>
                                    </div>
                                </div>
                                
                                <!-- Logo en-tête -->
                                <div class="col-md-4 text-center">
                                    <div class="border rounded-3 p-3 bg-light h-100 d-flex flex-column align-items-center justify-content-center">
                                        <h6 class="text-info mb-3">Logo en-tête</h6>
                                        <div class="logo-container mb-3 position-relative" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; border: 1px solid #dee2e6;">
                                            <img id="entete_logo_img" src="" alt="Logo en-tête" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                                            <div id="entete_logo_placeholder_icon" class="text-center" style="font-size: 3rem; color: #adb5bd;">
                                                <i class="ri-image-line"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted">Logo utilisé dans les en-têtes de documents</small>
                                    </div>
                                </div>
                                
                                <!-- Logo pied de page -->
                                <div class="col-md-4 text-center">
                                    <div class="border rounded-3 p-3 bg-light h-100 d-flex flex-column align-items-center justify-content-center">
                                        <h6 class="text-info mb-3">Logo pied de page</h6>
                                        <div class="logo-container mb-3 position-relative" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; border: 1px solid #dee2e6;">
                                            <img id="pied_page_logo_img" src="" alt="Logo pied de page" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                                            <div id="pied_page_logo_placeholder_icon" class="text-center" style="font-size: 3rem; color: #adb5bd;">
                                                <i class="ri-image-line"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted">Logo utilisé dans les pieds de page</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin Troisième rangée : Logos de l'entreprise -->

            <!-- Deuxième rangée : Informations de facturation et Comptes bancaires -->
            <div class="row mb-4">
                <!-- Informations de facturation -->
              <div class="col-lg-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-file-text-line text-info fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-info mb-1">Informations de facturation</h5>
                                        <p class="text-muted small mb-0">Détails fiscaux</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-file-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Registre de commerce</small>
                                    <span class="fw-semibold" id="rc_entreprise">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-file-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Article</small>
                                    <span class="fw-semibold" id="art_entreprise">-</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-file-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">NIF</small>
                                    <span class="fw-semibold" id="nif_entreprise">-</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-file-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">NIS</small>
                                    <span class="fw-semibold" id="nis_entreprise">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comptes bancaires -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-bank-line text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-warning mb-1">Comptes bancaires</h5>
                                        <p class="text-muted small mb-0">Gestion des comptes bancaires</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-warning btn-sm" id="addBankAccountBtn">
                                    <i class="ri-add-line me-1"></i>Ajouter
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Banque</th>
                                            <th class="border-0">IBAN</th>
                                            <th class="border-0">Devise</th>
                                            <th class="border-0 rounded-end text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bankAccountsList">
                                        <!-- Comptes bancaires seront chargés ici -->
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            

            <!-- Quatrième rangée : Historique des interactions -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4 w-100">
                        <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-history-line text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-success mb-1">Historique des interactions</h5>
                                        <p class="text-muted small mb-0">Suivi des communications</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-success px-4 py-2" id="addInteractionBtn">
                                    <i class="ri-add-line me-2"></i>Nouvelle interaction
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Date</th>
                                            <th class="border-0">Type</th>
                                            <th class="border-0">Sujet</th>
                                            <th class="border-0">Responsable</th>
                                            <th class="border-0 rounded-end text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historiqueInteractions">
                                        <!-- Historique des interactions -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de modification des logos -->
            <div class="modal fade" id="updateLogosModal" tabindex="-1" aria-labelledby="updateLogosModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-image-line text-info fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-info mb-1" id="updateLogosModalLabel">
                                        Modifier les logos
                                    </h5>
                                    <p class="text-muted small mb-0">Sélectionnez les nouveaux logos pour l'entreprise</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div class="avatar-lg mx-auto mb-3">
                                    <div class="avatar-title bg-info bg-opacity-10 text-info display-5 rounded-circle">
                                        <i class="ri-image-line"></i>
                                    </div>
                                </div>
                                <h4 class="text-info mb-3">Mise à jour des logos</h4>
                                <p class="text-muted mb-4">
                                    Téléchargez les nouveaux logos pour votre entreprise. Les formats acceptés sont JPG, PNG et GIF.
                                </p>
                            </div>
                            <form id="logosUploadForm" enctype="multipart/form-data">
                                <div class="row g-4">
                                    <div class="col-md-4 text-center">
                                        <div class="border rounded-3 p-3 bg-light h-100 d-flex flex-column align-items-center justify-content-center">
                                            <h6 class="text-info mb-3">Logo principal</h6>
                                            <div class="logo-preview mb-3 position-relative" style="width: 100px; height: 100px; overflow: hidden; border-radius: 8px; border: 1px solid #dee2e6;">
                                                <img id="preview_logo" src="" alt="Prévisualisation logo" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                                                <div id="preview_logo_placeholder_icon" class="d-flex align-items-center justify-content-center" style="font-size: 2rem; color: #adb5bd; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                                    <i class="ri-image-line"></i>
                                                </div>
                                            </div>
                                            <label class="btn btn-outline-info btn-sm position-relative overflow-hidden" style="width: 100%;">
                                                <i class="ri-upload-2-line me-1"></i>Choisir un fichier
                                                <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer" name="logo" id="logo_file" accept="image/*">
                                            </label>
                                            <small class="text-muted mt-2">Logo principal de l'entreprise</small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4 text-center">
                                        <div class="border rounded-3 p-3 bg-light h-100 d-flex flex-column align-items-center justify-content-center">
                                            <h6 class="text-info mb-3">Logo en-tête</h6>
                                            <div class="logo-preview mb-3 position-relative" style="width: 100px; height: 100px; overflow: hidden; border-radius: 8px; border: 1px solid #dee2e6;">
                                                <img id="preview_entete_logo" src="" alt="Prévisualisation logo en-tête" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                                                <div id="preview_entete_logo_placeholder_icon" class="d-flex align-items-center justify-content-center" style="font-size: 2rem; color: #adb5bd; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                                    <i class="ri-image-line"></i>
                                                </div>
                                            </div>
                                            <label class="btn btn-outline-info btn-sm position-relative overflow-hidden" style="width: 100%;">
                                                <i class="ri-upload-2-line me-1"></i>Choisir un fichier
                                                <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer" name="entete_logo" id="entete_logo_file" accept="image/*">
                                            </label>
                                            <small class="text-muted mt-2">Logo pour les en-têtes</small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4 text-center">
                                        <div class="border rounded-3 p-3 bg-light h-100 d-flex flex-column align-items-center justify-content-center">
                                            <h6 class="text-info mb-3">Logo pied de page</h6>
                                            <div class="logo-preview mb-3 position-relative" style="width: 100px; height: 100px; overflow: hidden; border-radius: 8px; border: 1px solid #dee2e6;">
                                                <img id="preview_pied_page_logo" src="" alt="Prévisualisation logo pied de page" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                                                <div id="preview_pied_page_logo_placeholder_icon" class="d-flex align-items-center justify-content-center" style="font-size: 2rem; color: #adb5bd; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                                    <i class="ri-image-line"></i>
                                                </div>
                                            </div>
                                            <label class="btn btn-outline-info btn-sm position-relative overflow-hidden" style="width: 100%;">
                                                <i class="ri-upload-2-line me-1"></i>Choisir un fichier
                                                <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer" name="pied_page_logo" id="pied_page_logo_file" accept="image/*">
                                            </label>
                                            <small class="text-muted mt-2">Logo pour les pieds de page</small>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-info px-4 py-2" id="saveLogosBtn">
                                <i class="ri-save-line me-2"></i>Enregistrer les logos
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Ajout de compte bancaire -->
            <div class="modal fade" id="addBankAccountModal" tabindex="-1" aria-labelledby="addBankAccountModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-bank-line text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-warning mb-1" id="addBankAccountModalLabel">
                                        Nouveau compte bancaire
                                    </h5>
                                    <p class="text-muted small mb-0">Ajouter un compte bancaire</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Nom de la banque</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="bank_name" placeholder="Nom de la banque">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">IBAN</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="bank_iban" placeholder="Numéro IBAN">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Devise</label>
                                    <select class="form-select border-0 bg-light py-2" id="bank_currency">
                                        <option value="EUR">Euro (€)</option>
                                        <option value="USD">Dollar ($)</option>
                                        <option value="DZD">Dinar algérien (DA)</option>
                                        <!-- Ajouter d'autres devises selon les besoins -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Observations</label>
                                    <textarea class="form-control border-0 bg-light" id="bank_observations" rows="3" placeholder="Informations supplémentaires..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-warning px-4 py-2" id="saveBankAccountBtn">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Édition de compte bancaire -->
            <div class="modal fade" id="editBankAccountModal" tabindex="-1" aria-labelledby="editBankAccountModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-bank-line text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-warning mb-1" id="editBankAccountModalLabel">
                                        Éditer le compte bancaire
                                    </h5>
                                    <p class="text-muted small mb-0">Modifier un compte bancaire</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <input type="hidden" id="edit_bank_account_id">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Nom de la banque</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="edit_bank_name" placeholder="Nom de la banque">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">IBAN</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" id="edit_bank_iban" placeholder="Numéro IBAN">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Devise</label>
                                    <select class="form-select border-0 bg-light py-2" id="edit_bank_currency">
                                        <option value="eur">Euro (€)</option>
                                        <option value="usd">Dollar ($)</option>
                                        <option value="dzd">Dinar algérien (DA)</option>
                                        <!-- Ajouter d'autres devises selon les besoins -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Observations</label>
                                    <textarea class="form-control border-0 bg-light" id="edit_bank_observations" rows="3" placeholder="Informations supplémentaires..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-warning px-4 py-2" id="updateBankAccountBtn">
                                <i class="ri-save-line me-2"></i>Mettre à jour
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de validation de l'entreprise -->
            <div class="modal fade" id="validateEntrepriseModal" tabindex="-1" aria-labelledby="validateEntrepriseModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-check-double-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-success mb-1" id="validateEntrepriseModalLabel">
                                        Validation de l'entreprise
                                    </h5>
                                    <p class="text-muted small mb-0">Confirmation de la validation de l'entreprise</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div class="avatar-lg mx-auto mb-3">
                                    <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
                                        <i class="ri-building-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-3">Êtes-vous sûr de vouloir valider cette entreprise ?</h5>
                                <p class="text-muted mb-0">
                                    La validation de l'entreprise permettra de commencer le processus de collaboration.
                                </p>
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Commentaire de validation (optionnel)</label>
                                    <textarea class="form-control border-0 bg-light" rows="3" placeholder="Ajoutez un commentaire..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" id="confirmeValidationBtn" class="btn btn-success px-4 py-2">
                                <i class="ri-check-line me-2"></i>Valider l'entreprise
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de modification de l'entreprise -->
            <div class="modal fade" id="editEntrepriseModal" tabindex="-1" aria-labelledby="editEntrepriseModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-edit-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-primary mb-1" id="editEntrepriseModalLabel">
                                        Modifier les informations
                                    </h5>
                                    <p class="text-muted small mb-0">Modification des informations de l'entreprise</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div class="avatar-lg mx-auto mb-3">
                                    <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                                        <i class="ri-building-line"></i>
                                    </div>
                                </div>
                                <h4 class="text-primary mb-3">Modification de l'entreprise</h4>
                                <p class="text-muted mb-4">
                                    Veuillez remplir les informations ci-dessous pour mettre à jour les détails de l'entreprise.
                                </p>
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <h5 class="text-primary mb-3">Informations générales</h5>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Désignation</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-building-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_designation" placeholder="Dénomination de l'entreprise">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Adresse</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-map-pin-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_adresse" placeholder="Adresse complète">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Ville</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-map-pin-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_ville" placeholder="Ville">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Wilaya</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-map-pin-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_wilaya" placeholder="Wilaya">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Pays</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-global-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_pays" placeholder="Pays">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Code Postal</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-mail-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_code_postal" placeholder="Code postal">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Email</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-mail-line text-muted"></i>
                                            </span>
                                            <input type="email" class="form-control border-0 bg-light py-2" id="edit_email" placeholder="Email">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Téléphone</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-phone-line text-muted"></i>
                                            </span>
                                            <input type="tel" class="form-control border-0 bg-light py-2" id="edit_telephone" placeholder="Téléphone">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Site web</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-global-line text-muted"></i>
                                            </span>
                                            <input type="url" class="form-control border-0 bg-light py-2" id="edit_site_web" placeholder="Site web">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <h5 class="text-info mb-3">Informations de facturation</h5>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">RC</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-file-text-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_rc" placeholder="Registre de commerce">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">Article</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-file-text-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_art" placeholder="Article">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">NIF</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-file-text-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_nif" placeholder="Numéro d'identification fiscal">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label fw-medium">NIS</label>
                                        <div class="input-group">
                                            <span class="input-group-text border-0 bg-light">
                                                <i class="ri-file-text-line text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-0 bg-light py-2" id="edit_nis" placeholder="Numéro d'identification statistique">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <div class="hstack gap-2 justify-content-center w-100">
                                <button type="button" class="btn btn-light px-4 py-2 w-100" data-bs-dismiss="modal">
                                    <i class="ri-close-line me-2"></i>Annuler
                                </button>
                                <button type="button" id="validateUpdateEntrepriseDetailsBtn" class="btn btn-primary px-4 py-2 w-100">
                                    <i class="ri-save-line me-2"></i>Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Ajout de contact -->
            <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-user-add-line text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-warning mb-1" id="addContactModalLabel">
                                        Nouveau contact
                                    </h5>
                                    <p class="text-muted small mb-0">Ajouter un contact principal</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Nom</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" placeholder="Nom du contact">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Prénom</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" placeholder="Prénom du contact">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Fonction</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" placeholder="Fonction du contact">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Email</label>
                                    <input type="email" class="form-control border-0 bg-light py-2" placeholder="Email du contact">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Téléphone</label>
                                    <input type="tel" class="form-control border-0 bg-light py-2" placeholder="Téléphone du contact">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-warning px-4 py-2" id="saveContactBtn">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Ajout d'interaction -->
            <div class="modal fade" id="addInteractionModal" tabindex="-1" aria-labelledby="addInteractionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow-lg border-0">
                        <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-chat-new-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title fw-semibold text-success mb-1" id="addInteractionModalLabel">
                                        Nouvelle interaction
                                    </h5>
                                    <p class="text-muted small mb-0">Enregistrer une interaction</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Type d'interaction</label>
                                    <select class="form-select border-0 bg-light py-2">
                                        <option value="appel">Appel téléphonique</option>
                                        <option value="email">Email</option>
                                        <option value="rendez_vous">Rendez-vous</option>
                                        <option value="visite">Visite sur site</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Sujet</label>
                                    <input type="text" class="form-control border-0 bg-light py-2" placeholder="Sujet de l'interaction">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Date</label>
                                    <input type="date" class="form-control border-0 bg-light py-2">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Heure</label>
                                    <input type="time" class="form-control border-0 bg-light py-2">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Description</label>
                                    <textarea class="form-control border-0 bg-light" rows="3" placeholder="Description de l'interaction..."></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Responsable</label>
                                    <select class="form-select border-0 bg-light py-2">
                                        <option value="">Sélectionner un responsable</option>
                                        <!-- Options à charger dynamiquement -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 bg-light px-4 py-3">
                            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                                <i class="ri-close-line me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-success px-4 py-2" id="saveInteractionBtn">
                                <i class="ri-save-line me-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<script>
    $(document).ready(function(){
        let id  = "{{ pk }}";
        

        function loadEntrepriseData(){
            $.ajax({
                url : "{% url 'institut_app:ApiLoadEntrepriseData' %}",
                dataType: "JSON",
                type : 'GET',
                data:{'id_entreprise' : id},
                success: function(data){
                    // Mise à jour des champs avec les données de l'entreprise
                    $('#designation_entreprise').text(data.designation || '-');
                    $('#adresse_entreprise').text(data.adresse || '-');
                    $('#email_entreprise').text(data.email || '-');
                    $('#telephone_entreprise').text(data.telephone || '-');
                    $('#site_web_entreprise').text(data.site_web || '-');
                    $('#rc_entreprise').text(data.rc || '-');
                    $('#art_entreprise').text(data.art || '-');
                    $('#nif_entreprise').text(data.nif || '-');
                    $('#nis_entreprise').text(data.nis || '-');
                    $('#nb_etudiants').text(data.nb_etudiants || '0');
                    $('#nb_employes').text(data.nb_employes || '0');
                    $('#nb_departements').text(data.nb_departements || '0');
                    $('#ca_annuel').text('€' + (data.ca_annuel || '0'));
                    $('#nb_contrats').text(data.nb_contrats || '0');
                    $('#date_creation').text(data.date_creation || '-');
                    
                    // Mise à jour des champs du formulaire d'édition
                    $('#edit_designation').val(data.designation || '');
                    $('#edit_adresse').val(data.adresse || '');
                    $('#edit_ville').val(data.ville || '');
                    $('#edit_wilaya').val(data.wilaya || '');
                    $('#edit_pays').val(data.pays || '');
                    $('#edit_code_postal').val(data.code_postal || '');
                    $('#edit_email').val(data.email || '');
                    $('#edit_telephone').val(data.telephone || '');
                    $('#edit_site_web').val(data.site_web || '');
                    $('#edit_rc').val(data.rc || '');
                    $('#edit_art').val(data.art || '');
                    $('#edit_nif').val(data.nif || '');
                    $('#edit_nis').val(data.nis || '');
                    $('#edit_banque').val(data.banque || '');
                    $('#edit_iban').val(data.iban || '');
                    $('#edit_observations').val(data.observations || '');
                }
            });
        }

        // Chargement des contacts
        function loadContacts(){
            $.ajax({
                url : "#",
                dataType: "JSON",
                type : 'GET',
                data:{'id_entreprise' : id},
                success: function(data){
                    var html = "";
                    if (data.length > 0){
                        $.each(data, function(index, item){
                            html += '<tr>';
                            html += '<td>'+item.nom+' '+item.prenom+'</td>';
                            html += '<td>'+item.fonction+'</td>';
                            html += '<td class="text-end">';
                            html += '<div class="d-flex justify-content-end gap-2">';
                            html += '<button class="btn btn-soft-primary btn-sm" title="Modifier">';
                            html += '<i class="ri-edit-line"></i>';
                            html += '</button>';
                            html += '<button class="btn btn-soft-danger btn-sm" title="Supprimer">';
                            html += '<i class="ri-delete-bin-line"></i>';
                            html += '</button>';
                            html += '</div>';
                            html += '</td>';
                            html += '</tr>';
                        });
                    }else{
                        html += '<tr><td colspan="3" class="text-center text-muted">Aucun contact enregistré</td></tr>';
                    }
                    $('#listeDesContacts').html(html);
                }
            });
        }

        // Chargement des comptes bancaires
        function loadBankAccounts(){
            $.ajax({
                url : "{% url 'institut_app:ApiListeBanckAccountEntreprise' %}",
                dataType: "JSON",
                type : 'GET',
                data:{'id_entreprise' : id},
                success: function(data){
                    var html = "";
                    if(data.length > 0){
                        $.each(data, function(index, item){
                            html += '<tr>';
                            html += '<td>'+item.bank_name+'</td>';
                            html += '<td>'+item.bank_iban+'</td>';
                            html += '<td>'+item.bank_currency+'</td>';
                            html += '<td class="text-end">';
                            html += '<div class="d-flex justify-content-end gap-2">';
                            html += '<button class="btn btn-soft-primary btn-sm edit-bank-account" data-id="'+item.id+'" title="Modifier">';
                            html += '<i class="ri-edit-line"></i>';
                            html += '</button>';
                            html += '<button class="btn btn-soft-danger btn-sm delete-bank-account" data-id="'+item.id+'" title="Supprimer">';
                            html += '<i class="ri-delete-bin-line"></i>';
                            html += '</button>';
                            html += '</div>';
                            html += '</td>';
                            html += '</tr>';
                        });
                    }else{
                            html += '<tr>';
                                html += '<td colspan="4" class="text-center text-muted py-3">';
                                    html += '<i class="ri-bank-line fs-3 d-block mb-2"></i>';
                                    html += 'Aucun compte bancaire enregistré';
                                html += '</td>';
                            html += '</tr>';
                    }
                    $('#bankAccountsList').html(html);
                }
            });
        }

        function loadBankAccountDetails(account_id){
            $.ajax({
                url : "{% url 'institut_app:ApiLoadBankAccountDetails' %}",
                dataType : "JSON",
                type : "GET",
                data: {
                    'account_id' : account_id,
                },
                success : function(response){
                    $('#edit_bank_name').val(response.data.bank_name)
                    $('#edit_bank_iban').val(response.data.bank_iban)
                    $('#edit_bank_currency').val(response.data.bank_currency)
                    $('#edit_bank_observations').val(response.data.bank_observations)
                },
            })
        }


        // Initialisation des données
        loadEntrepriseData();
        loadBankAccounts();
        loadEntrepriseLogos();
       
        // Gestionnaires d'événements
        $(document).on('click', '#validateEntrepriseBtn', function(){
            $('#validateEntrepriseModal').modal('show');
        });

        $(document).on('click', '#updateEntrepriseDetailsBtn', function(){
            $('#editEntrepriseModal').modal('show');
        });

        $(document).on('click', '#addContactBtn', function(){
            $('#addContactModal').modal('show');
        });

        $(document).on('click', '#addInteractionBtn', function(){
            $('#addInteractionModal').modal('show');
        });

        $(document).on('click', '#saveContactBtn', function(){
            // Logique d'enregistrement du contact
            $('#addContactModal').modal('hide');
            alertify.success('Contact enregistré avec succès');
        });

        $(document).on('click', '#saveInteractionBtn', function(){
            // Logique d'enregistrement de l'interaction
            $('#addInteractionModal').modal('hide');
            alertify.success('Interaction enregistrée avec succès');
        });

        $(document).on('click', '#validateUpdateEntrepriseDetailsBtn', function(){
            // Récupération des valeurs des champs
            var designation = $('#edit_designation').val();
            var adresse = $('#edit_adresse').val();
            var wilaya = $('#edit_wilaya').val();
            var pays = $('#edit_pays').val();
            var code_postal = $('#edit_code_postal').val();
            var ville = $('#edit_ville').val();
            var email = $('#edit_email').val();
            var telephone = $('#edit_telephone').val();
            var site_web = $('#edit_site_web').val();
            var rc = $('#edit_rc').val();
            var art = $('#edit_art').val();
            var nif = $('#edit_nif').val();
            var nis = $('#edit_nis').val();
            var banque = $('#edit_banque').val();
            var iban = $('#edit_iban').val();
            var observations = $('#edit_observations').val();
            
            // Envoi des données via AJAX
            $.ajax({
                url : "{% url 'institut_app:ApiUpdateEntrepriseData' %}",
                dataType: "JSON",
                type : 'POST',
                data:{
                    'id_entreprise' : id,
                    'designation': designation,
                    'adresse': adresse,
                    'wilaya': wilaya,
                    'pays': pays,
                    'code_postal': code_postal,
                    'email': email,
                    'telephone': telephone,
                    'site_web': site_web,
                    'rc': rc,
                    'art': art,
                    'nif': nif,
                    'nis': nis,
                    'banque': banque,
                    'iban': iban,
                    'observations': observations,
                    'ville' : ville,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data){
                    if (data.status === 'success'){
                        $('#editEntrepriseModal').modal('hide');
                        loadEntrepriseData();
                        alertify.success(data.message);
                    }else{
                        alertify.error(data.message);
                    }
                }
            });
        });

        // Gestion des comptes bancaires
        $(document).on('click', '#addBankAccountBtn', function(){
            $('#addBankAccountModal').modal('show');
        });

        $(document).on('click', '#saveBankAccountBtn', function(){
            // Récupération des valeurs des champs
            var bank_name = $('#bank_name').val();
            var bank_iban = $('#bank_iban').val();
            var bank_currency = $('#bank_currency').val();
            var bank_observations = $('#bank_observations').val();
            
            // Validation simple
            if (!bank_name || !bank_iban) {
                alertify.error('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Envoi des données via AJAX
            $.ajax({
                url : "{% url 'institut_app:ApiSaveBankAccount' %}", // URL à définir pour l'API d'ajout de compte bancaire
                dataType: "JSON",
                type : 'POST',
                data:{
                    'id_entreprise' : id,
                    'bank_name': bank_name,
                    'bank_iban': bank_iban,
                    'bank_currency': bank_currency,
                    'bank_observations': bank_observations,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data){
                    if (data.status === 'success'){
                        $('#addBankAccountModal').modal('hide');
                        // Réinitialisation du formulaire
                        $('#bank_name').val('');
                        $('#bank_iban').val('');
                        $('#bank_currency').val('EUR');
                        $('#bank_observations').val('');
                        loadBankAccounts();
                        alertify.success(data.message);
                    }else{
                        alertify.error(data.message);
                    }
                }
            });
        });

        $(document).on('click', '.edit-bank-account', function(){
            var accountId = $(this).data('id');
            // Charger les données du compte bancaire et les afficher dans le modal d'édition
            loadBankAccountDetails(accountId);
            $('#edit_bank_account_id').val(accountId);
            $('#editBankAccountModal').modal('show');
            // TODO: Charger les données réelles du compte bancaire via AJAX
        });

        $(document).on('click', '.delete-bank-account', function(){
            var accountId = $(this).data('id');
            alertify.confirm('Suppression', 'Êtes-vous sûr de vouloir supprimer ce compte bancaire ?', 
                function(){
                    // Envoi de la requête de suppression via AJAX
                    $.ajax({
                        url : "{% url 'institut_app:ApiArchiveBankAccount' %}", // URL à définir pour l'API de suppression de compte bancaire
                        dataType: "JSON",
                        type : 'POST',
                        data:{
                            'account_id': accountId,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(data){
                            if (data.status === 'success'){
                                loadBankAccounts();
                                alertify.success(data.message);
                            }else{
                                alertify.error(data.message);
                            }
                        }
                    });
                },
                function(){
                    // Annulation
                }
            );
        });

        $(document).on('click', '#updateBankAccountBtn', function(){
            // Récupération des valeurs des champs
            var account_id = $('#edit_bank_account_id').val();
            var bank_name = $('#edit_bank_name').val();
            var bank_iban = $('#edit_bank_iban').val();
            var bank_currency = $('#edit_bank_currency').val();
            var bank_observations = $('#edit_bank_observations').val();
            
            // Validation simple
            if (!bank_name || !bank_iban) {
                alertify.error('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Envoi des données via AJAX
            $.ajax({
                url : "#", // URL à définir pour l'API de mise à jour de compte bancaire
                dataType: "JSON",
                type : 'POST',
                data:{
                    'account_id': account_id,
                    'bank_name': bank_name,
                    'bank_iban': bank_iban,
                    'bank_currency': bank_currency,
                    'bank_observations': bank_observations,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data){
                    if (data.status === 'success'){
                        $('#editBankAccountModal').modal('hide');
                        loadBankAccounts();
                        alertify.success(data.message);
                    }else{
                        alertify.error(data.message);
                    }
                }
            });
        });
        
        // Fonction pour charger les logos de l'entreprise
        function loadEntrepriseLogos(){
            $.ajax({
                url : "{% url 'institut_app:ApiLoadEntrepriseLogos' %}",
                dataType: "JSON",
                type : 'GET',
                data:{'id_entreprise' : id},
                success: function(data){
                    // Mettre à jour les images des logos
                    // Pour le logo principal
                    if(data.logo_url) {
                        $('#logo_img').attr('src', data.logo_url);
                        $('#preview_logo').attr('src', data.logo_url);
                        $('#logo_img').show();
                        $('#logo_placeholder_icon').hide();
                        $('#preview_logo').show();
                        $('#preview_logo_placeholder_icon').hide();
                    } else {
                        $('#logo_img').hide();
                        $('#logo_placeholder_icon').show();
                        $('#preview_logo').hide();
                        $('#preview_logo_placeholder_icon').show();
                    }
                    
                    // Pour le logo en-tête
                    if(data.entete_logo_url) {
                        $('#entete_logo_img').attr('src', data.entete_logo_url);
                        $('#preview_entete_logo').attr('src', data.entete_logo_url);
                        $('#entete_logo_img').show();
                        $('#entete_logo_placeholder_icon').hide();
                        $('#preview_entete_logo').show();
                        $('#preview_entete_logo_placeholder_icon').hide();
                    } else {
                        $('#entete_logo_img').hide();
                        $('#entete_logo_placeholder_icon').show();
                        $('#preview_entete_logo').hide();
                        $('#preview_entete_logo_placeholder_icon').show();
                    }
                    
                    // Pour le logo pied de page
                    if(data.pied_page_logo_url) {
                        $('#pied_page_logo_img').attr('src', data.pied_page_logo_url);
                        $('#preview_pied_page_logo').attr('src', data.pied_page_logo_url);
                        $('#pied_page_logo_img').show();
                        $('#pied_page_logo_placeholder_icon').hide();
                        $('#preview_pied_page_logo').show();
                        $('#preview_pied_page_logo_placeholder_icon').hide();
                    } else {
                        $('#pied_page_logo_img').hide();
                        $('#pied_page_logo_placeholder_icon').show();
                        $('#preview_pied_page_logo').hide();
                        $('#preview_pied_page_logo_placeholder_icon').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erreur lors du chargement des logos:", error);
                    // Afficher les icônes par défaut en cas d'erreur
                    $('#logo_img').hide();
                    $('#logo_placeholder_icon').show();
                    $('#entete_logo_img').hide();
                    $('#entete_logo_placeholder_icon').show();
                    $('#pied_page_logo_img').hide();
                    $('#pied_page_logo_placeholder_icon').show();
                }
            });
        }

        // Gestionnaire pour ouvrir le modal de modification des logos
        $(document).on('click', '#updateLogosBtn', function(){
            $('#updateLogosModal').modal('show');
            // Charger les logos actuels dans les prévisualisations
            loadEntrepriseLogos();
            // Reset file inputs to ensure placeholders are shown correctly
            $('#logo_file').val('');
            $('#entete_logo_file').val('');
            $('#pied_page_logo_file').val('');
        });

        // Gestionnaire pour la prévisualisation des logos sélectionnés
        $('#logo_file').on('change', function(){
            if(this.files && this.files[0]){
                var reader = new FileReader();
                reader.onload = function(e){
                    $('#preview_logo').attr('src', e.target.result);
                    $('#preview_logo').show();
                    $('#preview_logo_placeholder_icon').hide();
                }
                reader.readAsDataURL(this.files[0]);
            } else {
                // If no file is selected, show the placeholder icon
                $('#preview_logo').hide();
                $('#preview_logo_placeholder_icon').show();
            }
        });

        $('#entete_logo_file').on('change', function(){
            if(this.files && this.files[0]){
                var reader = new FileReader();
                reader.onload = function(e){
                    $('#preview_entete_logo').attr('src', e.target.result);
                    $('#preview_entete_logo').show();
                    $('#preview_entete_logo_placeholder_icon').hide();
                }
                reader.readAsDataURL(this.files[0]);
            } else {
                // If no file is selected, show the placeholder icon
                $('#preview_entete_logo').hide();
                $('#preview_entete_logo_placeholder_icon').show();
            }
        });

        $('#pied_page_logo_file').on('change', function(){
            if(this.files && this.files[0]){
                var reader = new FileReader();
                reader.onload = function(e){
                    $('#preview_pied_page_logo').attr('src', e.target.result);
                    $('#preview_pied_page_logo').show();
                    $('#preview_pied_page_logo_placeholder_icon').hide();
                }
                reader.readAsDataURL(this.files[0]);
            } else {
                // If no file is selected, show the placeholder icon
                $('#preview_pied_page_logo').hide();
                $('#preview_pied_page_logo_placeholder_icon').show();
            }
        });

        // Gestionnaire pour sauvegarder les logos
        $(document).on('click', '#saveLogosBtn', function(){
            var formData = new FormData();
            formData.append('id_entreprise', id);
            if($('#logo_file')[0].files[0]) {
                formData.append('logo', $('#logo_file')[0].files[0]);
            }
            if($('#entete_logo_file')[0].files[0]) {
                formData.append('entete_logo', $('#entete_logo_file')[0].files[0]);
            }
            if($('#pied_page_logo_file')[0].files[0]) {
                formData.append('pied_page_logo', $('#pied_page_logo_file')[0].files[0]);
            }
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // Envoi des données via AJAX
            $.ajax({
                url : "{% url 'institut_app:ApiUpdateEntrepriseLogos' %}",
                type : 'POST',
                data: formData,
                processData: false,  // Important pour l'envoi de fichiers
                contentType: false,  // Important pour l'envoi de fichiers
                success: function(data){
                    if (data.status === 'success'){
                        $('#updateLogosModal').modal('hide');
                        loadEntrepriseLogos(); // Recharger les logos avec les nouvelles valeurs
                        alertify.success(data.message);
                    }else{
                        alertify.error(data.message);
                    }
                },
                error: function(xhr, status, error){
                    alertify.error('Une erreur est survenue lors de la mise à jour des logos.');
                }
            });
        });
    });
</script>

{% endblock content %}