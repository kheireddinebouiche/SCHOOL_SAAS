{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} RH - Détails de l'employé(e) {% endblock title %}

{% block content %}
<style>
    label{
        font-weight : 600;
    }
    .search-box {
        position: relative;
    }
    .search-box .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
    }
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    .table td {
        vertical-align: middle;
    }
    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
    .dropdown-item i {
        width: 1.2rem;
    }
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    .modal-header .btn-close:focus {
        box-shadow: none;
    }
</style>

<div class="main-content">
    <div class="page-content bg-light">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="ri-user-line text-info"></i>
                            </div>
                            <h4 class="mb-0 text-info">{{employe.get_civilite_display}} {{employe.nom}} {{employe.prenom}}</h4>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 bg-transparent">
                                    <li class="breadcrumb-item">
                                        <a href="javascript: void(0);">RH</a>
                                    </li>
                                    <li class="breadcrumb-item active">Détails de l'employé</li>
                                </ol>
                            </nav>
                            <div class="btn-group">
                                {% if not employe.has_contract %}
                                <button id="addBtn" type="button" class="btn btn-success px-4 py-2">
                                    <i class="ri-add-line me-2"></i>Créer un contrat
                                </button>
                                {% endif %}
                                <a href="#" class="btn btn-primary px-4 py-2">
                                    <i class="ri-edit-line me-2"></i>Modifier
                                </a>
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle px-4 py-2" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="ri-printer-line me-2"></i>Impression
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        {% if employe.has_contract %}
                                            <li><a class="dropdown-item" href="{% url 't_rh:view_contrat' pk=employe.id %}" target="_blank"><i class="ri-file-text-line me-2"></i>Contrat de travail</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-file-text-line me-2"></i>Attestation de travail</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-id-card-line me-2"></i>Badge</a></li>
                                        {% else %}
                                        <li><a class="dropdown-item" href="#"><i class="ri-alert-line me-2"></i>Aucun état d'impression disponible ! veuillez créer un contrat</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <a href="#" class="btn btn-light px-4 py-2">
                                    <i class="ri-arrow-left-line me-2"></i>Retour à la liste
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Première rangée : Informations personnelles -->
            <div class="row mb-4">
                <!-- Informations personnelles -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-user-line text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-primary mb-1">Informations personnelles</h5>
                                    <p class="text-muted small mb-0">Détails de l'employé</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-user-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Civilité</small>
                                    <span class="fw-semibold" id="civilite">{{employe.get_civilite_display}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-flag-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Sexe</small>
                                    <span class="fw-semibold" id="sexe">{{employe.get_sexe_display}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-mail-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Email</small>
                                    <span class="fw-semibold" id="email">{{employe.email}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-phone-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Téléphone</small>
                                    <span class="fw-semibold" id="telephone">{{employe.telephone}}</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-calendar-line text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Date de naissance</small>
                                    <span class="fw-semibold" id="date_naissance">{{employe.date_naissance}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations d'identité -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-info bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-id-card-line text-info fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-info mb-1">Informations d'identité</h5>
                                    <p class="text-muted small mb-0">Données d'identification</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-id-card-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Carte d'identité</small>
                                    <span class="fw-semibold" id="cin">{{employe.cin}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-passport-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">N° Identification National</small>
                                    <span class="fw-semibold" id="nin">{{employe.nin}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-shield-user-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">N° Sécurité Sociale</small>
                                    <span class="fw-semibold" id="secu">{{employe.secu}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-blood-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Groupe sanguin</small>
                                    <span class="fw-semibold" id="groupe_sanguin">{{employe.get_groupe_sanguin_display}}</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-map-pin-line text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Lieu de naissance</small>
                                    <span class="fw-semibold" id="lieu_naissance">{{employe.lieu_naissance}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations complémentaires -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="ri-user-2-line text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title fw-semibold text-success mb-1">Informations complémentaires</h5>
                                    <p class="text-muted small mb-0">Données supplémentaires</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-family-line text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Situation familiale</small>
                                    <span class="fw-semibold" id="situation_familiale">{{employe.get_situation_familiale_display}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-map-pin-line text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Adresse</small>
                                    <span class="fw-semibold" id="adresse">{{employe.adresse}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-bank-card-line text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">N° Compte bancaire</small>
                                    <span class="fw-semibold" id="bank">{{employe.bank}}</span>
                                </div>
                            </div>
                            <div class="mb-4 d-flex align-items-start">
                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-user-star-line text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">État</small>
                                    <span class="fw-semibold" id="etat">{{employe.get_etat_display|default:"Non défini"}}</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="icon-circle bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="ri-calendar-line text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block mb-1">Créé le</small>
                                    <span class="fw-semibold" id="created_at">{{employe.created_at|date:"d M Y"}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Historique des contrats -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <!-- Header -->
                        <div class="card-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                        <i class="ri-briefcase-line text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title fw-semibold text-warning mb-1">Historique des contrats</h5>
                                        <p class="text-muted small mb-0">Contrats de travail de l'employé</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="card-body p-4">
                            <!-- Tableau des contrats -->
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0 rounded-start">Date d'embauche</th>
                                            <th class="border-0">Type de contrat</th>
                                            <th class="border-0">Poste</th>
                                            <th class="border-0">Durée du contrat</th>
                                            <th class="border-0">Créé le</th>
                                            <th class="border-0 rounded-end text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listItem">
                                        <!-- Contenu chargé dynamiquement -->
                                    </tbody>
                                </table>
                            </div>

                            <div id="noContratMessage" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center justify-content-center">
                                    <div class="avatar-sm mb-4">
                                        <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                            <i class="ri-briefcase-line"></i>
                                        </div>
                                    </div>
                                    <h5 class="mb-2">Aucun contrat trouvé</h5>
                                    <p class="text-muted mb-0">Cet employé n'a pas encore de contrat enregistré</p>
                                    {% if not employe.has_contract %}
                                    <button id="addBtn" class="btn btn-success mt-3">
                                        <i class="ri-add-line me-1"></i>Créer un contrat
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        <div id="newContratModal" class="modal fade" tabindex="-1" aria-labelledby="newContratModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-xl">
                <div class="modal-content rounded-4 shadow-lg border-0">
                    <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                <i class="ri-briefcase-line text-success fs-4"></i>
                            </div>
                            <div>
                                <h5 class="modal-title fw-semibold text-success mb-1" id="newContratModalLabel">
                                    Création d'un nouveau contrat
                                </h5>
                                <p class="text-muted small mb-0">Créer un nouveau contrat de travail</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">

                        <div class="row">
                            <div class="col-lg-3 mb-3">
                                <label for="entite_legal" class="form-label fw-medium"><strong>Employeur :</strong></label>
                                <select id="entite_legal" name="entite_legal" class='form-select border-0 bg-light py-2'>

                                </select>
                            </div>

                            <div class="col-lg-3 mb-3">
                                <label for="categorie_contrat" class="form-label fw-medium"><strong>Catégorie de contrat :</strong></label>
                                <select id="categorie_contrat" name="categorie_contrat" class='form-select border-0 bg-light py-2'>

                                </select>
                            </div>

                            <div class="col-lg-3 mb-3">
                                <label for="type_contrat" class="form-label fw-medium"><strong>Type de contrat :</strong></label>
                                <select id="type_contrat" name="type_contrat" class='form-select border-0 bg-light py-2'>

                                </select>
                            </div>

                            <div class="col-lg-3">
                                <label for="duree_contrat" class="form-label fw-medium"> Durée (Durée du contrat): </label>
                                <input required type="text" id="duree_contrat" class="form-control border-0 bg-light py-2" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label for="services" class="form-label fw-medium">Service : </label>
                                <select id='services' name="services" class="form-select border-0 bg-light py-2" >

                                </select>
                            </div>
                            <div class="col-lg-6">
                                <label for="posts" class="form-label fw-medium">Poste : </label>
                                <select id='posts' name="posts" class="form-select border-0 bg-light py-2" >

                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-4">
                                <label for="data_embauche" class="form-label fw-medium"> Date de recrutement : </label>
                                <input type="date" id="date_embauche" class="form-control border-0 bg-light py-2" />
                            </div>
                            <div class="col-lg-4">
                                <label for="periode_essaie" class="form-label fw-medium"> Période d'essai ? : </label>
                                <select id="periode_essaie" class="form-select border-0 bg-light py-2" >
                                    <option value="0" > Non </option>
                                    <option value="1" > Oui </option>
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <label for="duree_essaie" class="form-label fw-medium"> Durée (Durée de la période d'essai): </label>
                                <input type="text" id="duree_essaie" class="form-control border-0 bg-light py-2" />
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <label for="contenu" class="form-label fw-medium"><strong>Contenu : </strong></label>
                            <textarea class="form-control border-0 bg-light" rows="10" name="contenu" id="contenu"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-light px-4 py-3">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                            <i class="ri-close-line me-2"></i>Annuler
                        </button>
                        <button id="confirmBtn" class="btn btn-success px-4 py-2">
                            <i class="ri-check-line me-2"></i>Confirmer</button>
                    </div>

                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

<script>
    $(document).ready(function(){
        var id_employe = document.getElementById('id_employe').value;
        document.getElementById('duree_essaie').disabled = true;
        $('#periode_essaie').val('0');

        $('#periode_essaie').change(function(){
            var periode_essaie = $(this).val();
            if (periode_essaie === "1"){
                document.getElementById('duree_essaie').disabled = false;
            }else{
                $('#duree_essaie').val("");
                document.getElementById('duree_essaie').disabled = true;
            }
        })

        $(document).on('click', '#addBtn', function(){
            $.ajax({
                url :"{% url 't_rh:ApiGetDefaultValueForContrat' %}",
                dataType: "JSON",
                type : "GET",
                success: function(data){
                    var entrepriseOptions = "<option value='0'> ----------------- </option>";
                    var serviceOptions = "<option value='0'> ----------------- </option>";
                    var postsOptions = "<option value='0'> ----------------- </option>";

                    // Remplir la liste des entreprises
                    $.each(data.entreprises, function(index, entreprise){
                        entrepriseOptions += "<option value='"+entreprise.id+"'>"+entreprise.designation+"</option>";
                    });

                    // Remplir la liste des services
                    $.each(data.services, function(index, service){
                        serviceOptions += "<option value='"+service.id+"'>"+service.label+"</option>";
                    });

                    // Remplir la liste des services
                    $.each(data.postes, function(index, poste){
                        postsOptions += "<option value='"+poste.id+"'>"+poste.label+"</option>";
                    });

                    // Affecter les options aux <select>
                    $('#entite_legal').html(entrepriseOptions);
                    $('#services').html(serviceOptions);
                    $('#posts').html(postsOptions);

                            $('#entite_legal').html(row);
                        }
                    });
            $('#newContratModal').modal('show');
        });

        $('#entite_legal').change(function(){
            var id_entite = $(this).val();
            if(id_entite){
                $.ajax({
                    url : "{% url 't_rh:ApiGetCategorieContrat' %}",
                    dataType : "JSON",
                    type: 'GET',
                    data : {'id_entite' : id_entite},
                    success : function(data){
                        var categorie_contrat = $('#categorie_contrat');
                        categorie_contrat.empty();
                        categorie_contrat.append('<option value="">Sélectionner une categorie de contrat</option>');
                        $.each(data, function(index, item) {
                            categorie_contrat.append('<option value="' + item.id + '">' + item.label + '</option>');
                        });
                    }
                });
            }else{
                $('#categorie_contrat').empty();
                $('#categorie_contrat').append('<option value="">Sélectionner une categorie de contrat</option>');
            }

        });

        $('#categorie_contrat').change(function(){
            var id_categorie = $(this).val();
            if(id_categorie){
                $.ajax({
                    url : "{% url 't_rh:ApiGetTypeContrat' %}",
                    dataType : "JSON",
                    type: 'GET',
                    data : {'id_categorie' : id_categorie},
                    success : function(data){
                        var type_contrat = $('#type_contrat');
                        type_contrat.empty();
                        type_contrat.append('<option value="">Sélectionner une categorie de contrat</option>');
                        $.each(data, function(index, item) {
                            type_contrat.append('<option value="' + item.id + '">' + item.label + '</option>');
                        });
                    }
                });
            }else{
                $('#type_contrat').empty();
                $('#type_contrat').append('<option value="">Sélectionner une categorie de contrat</option>');
            }

        });

        $(document).on('click', '#confirmBtn', function(){
            var type_contrat = document.getElementById('type_contrat').value;
            var service = document.getElementById('services').value;
            var posts = document.getElementById('posts').value;
            var date_embauche = document.getElementById('date_embauche').value;
            var periode_essaie = document.getElementById('periode_essaie').value;
            var duree_essaie = document.getElementById('duree_essaie').value;
            var duree_contrat = document.getElementById('duree_contrat').value;

            if (type_contrat && date_embauche && service && posts && duree_contrat){
                if (periode_essaie == "1" && duree_essaie == ""){
                    alertify.error("La période d'essaie est activé, veuillez remplir le champs durée période d'essai");
                }else{
                    $.ajax({
                        url :"{% url 't_rh:ApiCreateContrat' %}",
                        dataType: "JSON",
                        type : "POST",
                        data : {
                            'id_employe' : id_employe,
                            'service' : service,
                            'posts' : posts,
                            'date_embauche' : date_embauche,
                            'periode_essaie' : periode_essaie,
                            'duree_essaie' : duree_essaie,
                            'duree_contrat' : duree_contrat,
                            'type_contrat' : type_contrat,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },

                        success : function(response){
                            if (response.status == "success"){
                                alertify.success(response.message);
                                var url = "{% url 't_rh:detailsEmploye' pk=0 %}"
                                window.location.href= url.replace('0', id_employe);
                            }else{
                                alertify.error(response.message);
                            }
                        }
                    });
                }
            }else{
                alertify.error("Veuillez saisir tous les champs requis")
            }

        });

        function loadContrats(){
            $.ajax({
                url :"{% url 't_rh:ApiGetListContratForEmploye' %}",
                dataType: 'JSON',
                type : 'GET',
                data: {
                    'id_employe' : id_employe,
                },
                success : function(data){
                    var row = "";
                    if (data.length > 0){
                        $.each(data, function(index, p){
                            row += "<tr>";
                            row += "<td>"+p.date_embauche+"</td>";
                            row += "<td>"+p.type_contrat__label+"</td>";
                            row += "<td>"+p.poste__label+"</td>";
                            row += "<td>"+p.duree+"</td>";
                            row += "<td>"+p.created_at.split('T')[0]+"</td>";
                            row += '<td>';
                                row += '<div class="dropdown d-inline-block">';
                                    row += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                                        row += '<i class="ri-more-fill align-middle"></i>';
                                    row += '</button>';
                                    row += '<ul class="dropdown-menu dropdown-menu-end">';
                                        row += '<li><button id="detailsContratBtn" data-id='+p.id+' class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i>Détails</button></li>';
                                        row += '<li><a class="dropdown-item" href="#"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i>Modifier</a></li>';
                                        row += '<li><hr class="dropdown-divider"></li>';
                                        row += '<li><a class="dropdown-item text-danger" href="#"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>Supprimer</a></li>';
                                    '</ul>';
                                '</div>';
                            '</td>';
                            "</tr>";
                        });
                        $('#listItem').html(row);
                        $('#noContratMessage').hide();
                    }else{
                        $('#listItem').html("");
                        $('#noContratMessage').show();
                    }
                }
            });
        }

        loadContrats();

        $(document).on('click', '#detailsContratBtn', function(){
            var id_contrat = $(this).data('id');
            $.ajax({
                url :"#",
                dataType: 'JSON',
                type : 'GET',
                data: {
                    'id_contrat' : id_contrat,
                },
                success : function(data){
                    $('#d_entite_legal').val(data.entite_legal__designation);
                    $('#d_categorie_contrat').val(data.type_contrat__categorie__label);
                    $('#d_type_contrat').val(data.type_contrat__label);
                    $('#d_duree_contrat').val(data.duree);
                    $('#d_services').val(data.service__label);
                    $('#d_posts').val(data.poste__label);
                    $('#d_date_embauche').val(data.date_embauche);

                }
            });
            $('#detailsContratModal').modal('show');
        });

    });
</script>


<script>
    $(document).ready(function(){
        var id_employe = document.getElementById('id_employe').value;
        document.getElementById('duree_essaie').disabled = true;
        $('#periode_essaie').val('0');

        $('#periode_essaie').change(function(){
            var periode_essaie = $(this).val();
            if (periode_essaie === "1"){
                document.getElementById('duree_essaie').disabled = false;
            }else{
                $('#duree_essaie').val("");
                document.getElementById('duree_essaie').disabled = true;
            }
        })

        $(document).on('click', '#addBtn', function(){
            $.ajax({
                url :"{% url 't_rh:ApiGetDefaultValueForContrat' %}",
                dataType: "JSON",
                type : "GET",
                success: function(data){
                    var entrepriseOptions = "<option value='0'> ----------------- </option>";
                    var serviceOptions = "<option value='0'> ----------------- </option>";
                    var postsOptions = "<option value='0'> ----------------- </option>";

                    // Remplir la liste des entreprises
                    $.each(data.entreprises, function(index, entreprise){
                        entrepriseOptions += "<option value='"+entreprise.id+"'>"+entreprise.designation+"</option>";
                    });

                    // Remplir la liste des services
                    $.each(data.services, function(index, service){
                        serviceOptions += "<option value='"+service.id+"'>"+service.label+"</option>";
                    });

                    // Remplir la liste des services
                    $.each(data.postes, function(index, poste){
                        postsOptions += "<option value='"+poste.id+"'>"+poste.label+"</option>";
                    });

                    // Affecter les options aux <select>
                    $('#entite_legal').html(entrepriseOptions);
                    $('#services').html(serviceOptions);
                    $('#posts').html(postsOptions);

                            $('#entite_legal').html(row);
                        }
                    });
            $('#newContratModal').modal('show');
        });

        $('#entite_legal').change(function(){
            var id_entite = $(this).val();
            if(id_entite){
                $.ajax({
                    url : "{% url 't_rh:ApiGetCategorieContrat' %}",
                    dataType : "JSON",
                    type: 'GET',
                    data : {'id_entite' : id_entite},
                    success : function(data){
                        var categorie_contrat = $('#categorie_contrat');
                        categorie_contrat.empty();
                        categorie_contrat.append('<option value="">Sélectionner une categorie de contrat</option>');
                        $.each(data, function(index, item) {
                            categorie_contrat.append('<option value="' + item.id + '">' + item.label + '</option>');
                        });
                    }
                });
            }else{
                $('#categorie_contrat').empty();
                $('#categorie_contrat').append('<option value="">Sélectionner une categorie de contrat</option>');
            }
            
        });

        $('#categorie_contrat').change(function(){
            var id_categorie = $(this).val();
            if(id_categorie){
                $.ajax({
                    url : "{% url 't_rh:ApiGetTypeContrat' %}",
                    dataType : "JSON",
                    type: 'GET',
                    data : {'id_categorie' : id_categorie},
                    success : function(data){
                        var type_contrat = $('#type_contrat');
                        type_contrat.empty();
                        type_contrat.append('<option value="">Sélectionner une categorie de contrat</option>');
                        $.each(data, function(index, item) {
                            type_contrat.append('<option value="' + item.id + '">' + item.label + '</option>');
                        });
                    }
                });
            }else{
                $('#type_contrat').empty();
                $('#type_contrat').append('<option value="">Sélectionner une categorie de contrat</option>');
            }
            
        });

        $(document).on('click', '#confirmBtn', function(){
            var type_contrat = document.getElementById('type_contrat').value;
            var service = document.getElementById('services').value;
            var posts = document.getElementById('posts').value;
            var date_embauche = document.getElementById('date_embauche').value;
            var periode_essaie = document.getElementById('periode_essaie').value;
            var duree_essaie = document.getElementById('duree_essaie').value;
            var duree_contrat = document.getElementById('duree_contrat').value;

            if (type_contrat && date_embauche && service && posts && duree_contrat){
                if (periode_essaie == "1" && duree_essaie == ""){
                    alertify.error("La période d'essaie est activé, veuillez remplir le champs durée période d'essai");
                }else{
                    $.ajax({
                        url :"{% url 't_rh:ApiCreateContrat' %}",
                        dataType: "JSON",
                        type : "POST",
                        data : {
                            'id_employe' : id_employe,
                            'service' : service,
                            'posts' : posts,
                            'date_embauche' : date_embauche,
                            'periode_essaie' : periode_essaie,
                            'duree_essaie' : duree_essaie,
                            'duree_contrat' : duree_contrat,
                            'type_contrat' : type_contrat,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },

                        success : function(response){
                            if (response.status == "success"){
                                alertify.success(response.message);
                                var url = "{% url 't_rh:detailsEmploye' pk=0 %}"
                                window.location.href= url.replace('0', id_employe);
                            }else{
                                alertify.error(response.message);
                            }
                        }
                    });
                }
            }else{
                alertify.error("Veuillez saisir tous les champs requis")
            }

        });

        function loadContrats(){
            $.ajax({
                url :"{% url 't_rh:ApiGetListContratForEmploye' %}",
                dataType: 'JSON',
                type : 'GET',
                data: {
                    'id_employe' : id_employe,
                },
                success : function(data){
                    var row = "";
                    if (data.length > 0){
                        $.each(data, function(index, p){
                            row += "<tr>";
                            row += "<td>"+p.date_embauche+"</td>";
                            row += "<td>"+p.type_contrat__label+"</td>";
                            row += "<td>"+p.poste__label+"</td>";
                            row += "<td>"+p.duree+"</td>";
                            row += "<td>"+p.created_at.split('T')[0]+"</td>";
                            row += '<td>';
                                row += '<div class="dropdown d-inline-block">';
                                    row += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                                        row += '<i class="ri-more-fill align-middle"></i>';
                                    row += '</button>';
                                    row += '<ul class="dropdown-menu dropdown-menu-end">';
                                        row += '<li><button id="detailsContratBtn" data-id='+p.id+' class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i>Détails</button></li>';
                                        row += '<li><button id="updateBtn" data-id='+p.id+' data-titre="'+p.label+'" data-contenu="'+p.description+'" class="dropdown-item edit-item-btn"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</button></li>';
                                        row += '<li>';
                                            row += '<button id="deleteBtn" data-id='+p.id+' class="dropdown-item remove-item-btn">';
                                                row += '<i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer';
                                            row += '</button>';
                                        row += '</li>';
                                    row += '</ul>';
                               row += ' </div>';
                            row += '</td>';
                            row += "</tr>";
                        });
                    }else{
                        row += "<tr><td colpspan='5' class='text-center text-muted'>Aucune données disponible ! </td></tr>";
                    }

                    $('#listItem').html(row);
                }

            });
        }

        loadContrats();

        $(document).on('click', '#detailsContratBtn', function(){

            var id_contrat = $(this).data('id');

            $.ajax({
                url : '{% url "t_rh:ApiGetDetailsOfContract" %}',
                dataType : 'JSON',
                type : 'GET',
                data : {'id' : id_contrat},
                success : function(data){
                    $('#d_entite_legal').val(data.employeur);
                    $('#d_categorie_contrat').val(data.categorie_contrat);
                    $('#d_type_contrat').val(data.type_contrat);
                    $('#d_duree_contrat').val(data.duree);
                    $('#d_services').val(data.service);
                    $('#d_posts').val(data.poste);
                    $('#d_date_embauche').val(data.date_embauche);
                    $('#detailsContratModal').modal('show');
                    
                }
            });

            
        }); 
    });
</script>
{% endblock content %}
           



    