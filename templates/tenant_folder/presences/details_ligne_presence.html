{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Présences - Détails Ligne Présence {% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* Prevents the icon from interfering with clicks */
  }
  .search-box input {
    padding-left: 40px; /* Make sure text doesn't overlap with icon */
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }
  
  .table td.text-end {
    position: relative;
    overflow: visible;
  }
  
  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }
  
  .attendance-status-present {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
  }
  
  .attendance-status-absent {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
  }
  
  .attendance-status-late {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
  }
  
  .attendance-status-justified {
    background-color: rgba(0, 123, 255, 0.1);
    color: #007bff;
  }
  
  /* Attendance modal specific styles */
  .attendance-checkbox-cell {
    width: 30px;
    text-align: center;
  }
  
  .attendance-checkbox-cell input[type="checkbox"] {
    margin: 0;
  }
  
  .attendance-present {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
  }
  
  .attendance-absent {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
  }
  
  .attendance-late {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
  }
  
  .attendance-justified {
    background-color: rgba(0, 123, 255, 0.1);
    color: #007bff;
  }
  
  .attendance-student-avatar {
    width: 36px;
    height: 36px;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="ri-user-line text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Détails Présences Étudiants</h4>
            </div>
            <div class="page-title-right">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                <li class="breadcrumb-item">
                  <a href="javascript: void(0);">Présences</a>
                </li>
                <li class="breadcrumb-item active">Détails Ligne Présence</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Total Étudiants</p>
                  <h4 class="mb-0" id="totalStudents">{{ etudiants|length|default:0 }}</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-user-line text-primary fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Présents</p>
                  <h4 class="mb-0" id="presentCount">0</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-check-line text-success fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Absents</p>
                  <h4 class="mb-0" id="absentCount">0</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-danger bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-close-line text-danger fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Taux Moyen</p>
                  <h4 class="mb-0" id="averageAttendanceRate">0%</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-percentage-line text-info fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Module Information Section -->
      <div class="row mb-4">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-book text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Informations du Module</h5>
                </div>
                <button class="btn btn-info btn-sm px-3">
                  <i class="ri-settings-3-line me-1"></i> Modifier
                </button>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label text-muted">Nom du Module</label>
                    <h6 class="mb-0">Mathématiques Avancées</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Code du Module</label>
                    <h6 class="mb-0">MAT-201</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Type de Cours</label>
                    <h6 class="mb-0">
                      <span class="badge bg-primary bg-opacity-10 text-primary px-2 py-1">Cours</span>
                    </h6>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label text-muted">Enseignant</label>
                    <h6 class="mb-0">Prof. Martin Dubois</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Groupe</label>
                    <h6 class="mb-0">Groupe A - L3 Informatique</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Crédits</label>
                    <h6 class="mb-0">6 ECTS</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-lg-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0 text-info">Liste des Étudiants</h4>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-secondary px-4" id="exportExcelBtn">
                <i class="ri-file-excel-line me-1"></i> Exporter Excel
              </button>
              <button class="btn btn-info px-4" id="createAttendanceBtn">
                <i class="ri-add-line me-1"></i> Nouvelle Présence
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill ps-4" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  
                  <select id="filter-group" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Filtrer par groupe</option>
                    {% for groupe in groupes %}
                      <option value="{{ groupe.id }}">{{ groupe.nom }}</option>
                    {% endfor %}
                  </select>

                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <div class="table-responsive" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Étudiant</th>
                      <th class="border-0">Matricule</th>
                      <th class="border-0">Taux de Présence</th>
                      <th class="border-0">Nombre d'Absences</th>
                      <th class="border-0 rounded-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeItem" class="border-top-0">
                    {% if etudiants %}
                      {% for etudiant in etudiants %}
                        <tr>
                          <td class="d-flex align-items-center">
                            <div class="avatar-xs rounded-circle bg-light border me-2">
                              <span class="avatar-title rounded-circle text-muted fs-5">
                                {% if etudiant.student.nom %}
                                  {{ etudiant.student.nom.0|upper }}
                                {% else %}
                                  {{ etudiant.student.nom.0|upper }}
                                {% endif %}
                              </span>
                            </div>
                            <div>
                              <h6 class="mb-0">{{ etudiant.student.nom}} {{etudiant.student.prenom}}</h6>
                              <small class="text-muted">{{ etudiant.specialite.nom|default:"Non spécifié" }}</small>
                            </div>
                          </td>
                          <td>{{ etudiant.student.matricule_interne|default:"N/A" }}</td>
                         
                          <td>
                            <span class="badge bg-success bg-opacity-10 text-success px-2 py-1">
                              {{ etudiant.taux_presence|default:"0%" }}
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-danger bg-opacity-10 text-danger px-2 py-1">
                              {{ etudiant.nombre_absences|default:0 }}
                            </span>
                          </td>
                          <td class="text-end">
                            <button id='displayPresenceBtn' class="btn btn-info btn-sm" 
                                    data-student-id="{{etudiant.student.id}}" 
                                    data-student-name="{{ etudiant.student.nom}}"
                                    data-student-absences="0">
                              <i class="ri-eye-line align-bottom me-1"></i> Présences
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                        <tr>
                          <td colspan="6">
                             <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                <div class="avatar-sm mb-4">
                                    <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                        <i class="ri-user-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-2">Aucun étudiant trouvé</h5>
                                <p class="text-muted mb-0">Il n'y a aucun étudiant enregistré pour le moment</p>
                            </div>
                          </td>
                        </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal for student presence details -->
<div class="modal fade" id="presenceModal" tabindex="-1" aria-labelledby="presenceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-user-line text-info fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-info mb-1" id="modalStudentName">
              Présences de l'Étudiant
            </h5>
            <p class="text-muted small mb-0" id="modalStudentAbsences">Nombre d'absences: <span class="badge bg-danger">0</span></p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row mb-4">
          <div class="col-lg-4">
            <div class="card border shadow-sm">
              <div class="card-body text-center">
                <div class="avatar-lg mx-auto mb-3">
                  <div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle h2 mb-0">
                    <i class="ri-user-line"></i>
                  </div>
                </div>
                <h5 class="mb-1" id="modalStudentFullName">Nom de l'Étudiant</h5>
                <p class="text-muted mb-0" id="modalStudentMatricule">Matricule: -</p>
              </div>
            </div>
          </div>
          
          <div class="col-lg-8">
            <div class="row">
              <div class="col-md-4">
                <div class="card border text-center">
                  <div class="card-body">
                    <h5 class="card-title text-info">Présences</h5>
                    <h3 class="mb-1" id="modalPresentCount">0</h3>
                    <p class="text-muted mb-0">Séances</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card border text-center">
                  <div class="card-body">
                    <h5 class="card-title text-danger">Absences</h5>
                    <h3 class="mb-1" id="modalAbsentCount">0</h3>
                    <p class="text-muted mb-0">Séances</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card border text-center">
                  <div class="card-body">
                    <h5 class="card-title text-success">Taux</h5>
                    <h3 class="mb-1" id="modalAttendanceRate">0%</h3>
                    <p class="text-muted mb-0">Moyen</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-lg-12">
            <div class="card shadow border-0">
              <div class="card-header bg-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0 text-info">
                    <i class="fas fa-calendar-check me-2"></i>
                    Historique des Présences
                  </h5>
                </div>
              </div>
              <div class="card-body p-3">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th class="border-0 rounded-start">Date</th>
                        <th class="border-0">Module</th>
                        <th class="border-0">Enseignant</th>
                        <th class="border-0">Statut</th>
                        <th class="border-0">Heure</th>
                        <th class="border-0 rounded-end">Observation</th>
                      </tr>
                    </thead>
                    <tbody id="modalPresenceTableBody">
                      <!-- Presence records will be dynamically loaded here -->
                      <tr>
                        <td colspan="6" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center">
                            <div class="avatar-sm mb-3">
                              <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                <i class="ri-calendar-line"></i>
                              </div>
                            </div>
                            <h5 class="mb-1">Aucune donnée de présence</h5>
                            <p class="text-muted mb-0">Les présences seront affichées après chargement</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-between w-100">
          <div>
            <button class="btn btn-light px-4" id="exportStudentPresenceBtn">
              <i class="ri-file-pdf-line me-1"></i> Exporter PDF
            </button>
          </div>
          <div class="hstack gap-2">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
              <i class="ri-close-line me-1"></i> Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for taking attendance -->
<div class="modal fade" id="takeAttendanceModal" tabindex="-1" aria-labelledby="takeAttendanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-user-check-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="takeAttendanceModalLabel">
              Prise de Présence
            </h5>
            <p class="text-muted small mb-0">Groupe: <span id="attendanceSessionGroup">-</span></p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row mb-4">
          <div class="col-lg-12">
            <div class="mb-3">
              <label for="attendanceDateInput" class="form-label">Date de la Séance</label>
              <input type="date" class="form-control" id="attendanceDateInput" value="{{ now|date:"Y-m-d" }}">
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <div class="alert alert-info" role="alert">
              <i class="ri-information-line me-2"></i>
              <strong>Mode Absence:</strong> Cochez uniquement les étudiants absents. Les étudiants non cochés seront considérés comme présents.
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-lg-12">
            <div class="card shadow border-0">
              <div class="card-header bg-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0 text-success">
                    <i class="ri-user-line me-2"></i>
                    Liste des Étudiants
                  </h5>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="selectAllAbsent">
                      <i class="ri-check-line me-1"></i> Tous Absents
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="clearAllAbsent">
                      <i class="ri-close-line me-1"></i> Aucun Absent
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body p-3">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th class="border-0 rounded-start" style="width: 30px;">
                          <input type="checkbox" class="form-check-input" id="selectAllStudents">
                        </th>
                        <th class="border-0">Étudiant</th>
                        <th class="border-0">Matricule</th>
                        <th class="border-0 rounded-end">Statut</th>
                      </tr>
                    </thead>
                    <tbody id="attendanceStudentsTableBody">
                      <!-- Student rows will be dynamically loaded here -->
                      <tr>
                        <td colspan="4" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center">
                            <div class="avatar-sm mb-3">
                              <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                <i class="ri-user-line"></i>
                              </div>
                            </div>
                            <h5 class="mb-1">Aucun étudiant à afficher</h5>
                            <p class="text-muted mb-0">Les étudiants seront chargés après sélection du groupe</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-between w-100">
          <div>
            <button class="btn btn-light px-4" id="exportAttendanceBtn">
              <i class="ri-file-excel-line me-1"></i> Exporter Excel
            </button>
          </div>
          <div class="hstack gap-2">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
              <i class="ri-close-line me-1"></i> Annuler
            </button>
            <button type="button" class="btn btn-success px-4" id="saveAttendanceBtnModal">
              <i class="ri-save-line me-1"></i> Enregistrer Présences
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Update statistics based on data in the table
    function updateStatistics() {
      const totalStudents = $('#totalStudents').text();
      let presentCount = 0;
      let absentCount = 0;
      let totalRate = 0;
      let validRecords = 0;
      
      $('#listeItem tr').each(function() {
        const $row = $(this);
        const cells = $row.find('td');
        if (cells.length > 0) {
          const rateCell = cells.eq(3).find('span');
          const absencesCell = cells.eq(4).find('span');
          
          if (rateCell.length > 0 && absencesCell.length > 0) {
            const rateText = rateCell.text().trim();
            const absencesText = absencesCell.text().trim();
            
            if (rateText && rateText !== '0%') {
              const rateValue = parseInt(rateText.replace('%', ''));
              if (!isNaN(rateValue)) {
                totalRate += rateValue;
                validRecords++;
              }
            }
            
            if (absencesText && absencesText !== '0') {
              const absencesValue = parseInt(absencesText);
              if (!isNaN(absencesValue)) {
                absentCount += absencesValue;
              }
            }
          }
        }
      });
      
      const averageRate = validRecords > 0 ? Math.round(totalRate / validRecords) : 0;
      
      $('#presentCount').text(totalStudents - absentCount);
      $('#absentCount').text(absentCount);
      $('#averageAttendanceRate').text(averageRate + '%');
    }
    
    // Initialize statistics
    updateStatistics();
    
    // Handle modal opening
    $(document).on('click', '.btn[data-bs-toggle="modal"][data-student-id]', function() {
      const studentId = $(this).data('student-id');
      const studentName = $(this).data('student-name');
      const studentAbsences = $(this).data('student-absences');
      
      // Update modal header
      $('#modalStudentName').text('Présences de ' + studentName);
      $('#modalStudentAbsences').html('Nombre d\'absences: <span class="badge bg-danger">' + studentAbsences + '</span>');
      $('#modalStudentFullName').text(studentName);
      $('#modalStudentMatricule').text('Matricule: ETU' + studentId);
      
      
      //loadStudentAttendanceData(studentId);
      loadStudentHistory(studentId);
    });

    $(document).on('click', '#displayPresenceBtn', function(){
        const studentId = $(this).data('student-id');
    })

    function loadStudentHistory(studentId) {
        $.ajax({
            url: '/scolarite/etudiants/ApiGetHistoriqueEtudiant/'${studentId}'/',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
            if (response.status === 'success') {
                displayStudentHistory(response.historique);
            } else {
                alert("Erreur : " + response.message);
            }
            },
            error: function() {
            alert("Erreur lors du chargement de l'historique.");
            }
        });
    }

    function displayStudentHistory(historique) {
        const container = $('#modalPresenceTableBody');
        container.empty();

        if (!historique || historique.length === 0) {
            container.html('<p>Aucun historique trouvé.</p>');
            return;
        }

        historique.forEach(entry => {
            const dateTitle = `<h5 class="mt-3 text-primary">${entry.date}</h5>`;
            let modulesTable = '<table class="table table-bordered"><thead><tr><th>Module</th><th>Heure</th><th>État</th></tr></thead><tbody>';

            entry.data.forEach(item => {
            modulesTable += `
                <tr>
                <td>${item.module}</td>
                <td>${item.heure}h</td>
                <td>${item.etat === 'P' ? 'Présent' : item.etat === 'A' ? 'Absent' : item.etat}</td>
                </tr>`;
            });

            modulesTable += '</tbody></table>';
            container.append(dateTitle + modulesTable);
        });
    }
    
    // Function to load student attendance data
    function loadStudentAttendanceData(studentId) {
      // Simulate loading data
      // In real application, this would be an AJAX call to fetch attendance records
      $('#modalPresenceTableBody').html(`
        <tr>
          <td>15 Oct 2024</td>
          <td>Mathématiques</td>
          <td>Prof. Martin</td>
          <td><span class="badge attendance-status-present">Présent</span></td>
          <td>09:00 - 11:00</td>
          <td>-</td>
        </tr>
       
        
      `);
      
      // Update statistics in modal
      $('#modalPresentCount').text(3);
      $('#modalAbsentCount').text(1);
      $('#modalAttendanceRate').text('75%');
    }
    
    // Handle edit reason button click
    $(document).on('click', '.edit-reason-btn', function() {
      const attendanceId = $(this).data('id');
      const date = $(this).data('date');
      const module = $(this).data('module');
      const currentReason = $(this).data('reason');
      
      // Create and show modal for editing reason
      showEditReasonModal(attendanceId, date, module, currentReason);
    });
    
    // Function to show edit reason modal
    function showEditReasonModal(attendanceId, date, module, currentReason) {
      // Create modal HTML dynamically
      const modalHtml = `
        <div class="modal fade" id="editReasonModal" tabindex="-1" aria-labelledby="editReasonModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editReasonModalLabel">Modifier le Motif d'Absence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Date</label>
                  <p class="mb-0">${date}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label">Module</label>
                  <p class="mb-0">${module}</p>
                </div>
                <div class="mb-3">
                  <label for="editReasonInput" class="form-label">Motif d'Absence</label>
                  <textarea class="form-control" id="editReasonInput" rows="3">${currentReason}</textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="saveReasonBtn" data-id="${attendanceId}">Enregistrer</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to body
      $('body').append(modalHtml);
      
      // Show modal
      $('#editReasonModal').modal('show');
      
      // Handle save button click
      $(document).off('click', '#saveReasonBtn').on('click', '#saveReasonBtn', function() {
        const newReason = $('#editReasonInput').val();
        if (newReason.trim()) {
          // In a real application, you would save this to the server
          console.log('Updating reason:', {
            id: attendanceId,
            reason: newReason
          });
          
          // Update the reason in the table
          $(`.edit-reason-btn[data-id="${attendanceId}"]`).siblings('span').text(newReason);
          $(`.edit-reason-btn[data-id="${attendanceId}"]`).data('reason', newReason);
          
          // Show success message
          alert('Motif d\'absence mis à jour avec succès!');
        } else {
          alert('Veuillez entrer un motif d\'absence');
          return;
        }
        
        // Close and remove modal
        $('#editReasonModal').modal('hide');
        $('#editReasonModal').remove();
      });
      
      // Remove modal from DOM when closed
      $('#editReasonModal').on('hidden.bs.modal', function() {
        $(this).remove();
      });
    }
    
    // Client-side search functionality
    $(document).on('input', '#table-filter', function() {
      var searchTerm = $(this).val().trim().toLowerCase();
      
      if (searchTerm === '') {
        // Show all rows
        $('#listeItem tr').show();
      } else {
        // Hide all rows first
        $('#listeItem tr').hide();
        
        // Show rows that match the search term
        $('#listeItem tr').each(function() {
          var $row = $(this);
          var rowText = $row.text().toLowerCase();
          
          if (rowText.includes(searchTerm)) {
            $row.show();
          }
        });
      }
    });
    
    // Filter by group
    $(document).on('change', '#filter-group', function() {
      var filterValue = $(this).val();
      
      if (filterValue === '') {
        // Show all rows
        $('#listeItem tr').show();
      } else {
        // Hide all rows first
        $('#listeItem tr').hide();
        
        // Show rows that match the selected group
        $('#listeItem tr').each(function() {
          var $row = $(this);
          var groupCell = $row.find('td').eq(2).text().trim();
          
          if (groupCell.includes(filterValue)) {
            $row.show();
          }
        });
      }
    });
    
    // Export to Excel functionality
    $(document).on('click', '#exportExcelBtn', function() {
      alert('Fonctionnalité d\'export Excel bientôt disponible');
    });
    
    // Export student presence to PDF
    $(document).on('click', '#exportStudentPresenceBtn', function() {
      alert('Export PDF des présences de l\'étudiant bientôt disponible');
    });
    
    // Create new attendance button
    $(document).on('click', '#createAttendanceBtn', function() {
      // Show the attendance modal when this button is clicked
      $('#takeAttendanceModal').modal('show');
      // Initialize the attendance taking session
      initializeAttendanceSession();
    });
    
    // Initialize the attendance session when modal is shown
    $('#takeAttendanceModal').on('shown.bs.modal', function() {
      initializeAttendanceSession();
    });
    
    // Initialize attendance session
    function initializeAttendanceSession() {
      // Set session info
      const today = new Date();
      const options = { day: 'numeric', month: 'short', year: 'numeric' };
      const dateStr = today.toLocaleDateString('fr-FR', options);
      $('#attendanceSessionDate').text(dateStr);
      $('#attendanceSessionGroup').text('Groupe A');
      $('#attendanceSessionName').text('Séance du ' + dateStr);
      
      // Set default date in the input field
      const todayStr = today.toISOString().split('T')[0];
      $('#attendanceDateInput').val(todayStr);
      
      // Load students for attendance
      loadStudentsForAttendance();
    }
    
    // Load students for attendance taking
    function loadStudentsForAttendance() {
      // Simulate loading students
      $('#attendanceStudentsTableBody').html(`
        {% for etudiant in etudiants %}
            <tr>
            <td class="attendance-checkbox-cell"><input type="checkbox" class="form-check-input student-absent" data-student-id-take="{{etudiant.student.id}}"></td>
            <td class="d-flex align-items-center">
                <div>
                    <h6 class="mb-0">{{etudiant.student.nom}} {{etudiant.student.prenom}}</h6>
                </div>
            </td>
            <td>{{etudiant.student.matricule_interne}}</td>
            <td class="text-center"><span class="badge attendance-present">Présent</span></td>
            </tr>
        {% endfor %}
      
      `);
      
      updateAttendanceCounts();
    }
    
    // Update attendance counts
    function updateAttendanceCounts() {
      const absentCount = $('.student-absent:checked').length;
      const totalCount = $('.student-absent').length;
      const presentCount = totalCount - absentCount;
      
      $('#absentCount').text(absentCount);
      $('#presentCount').text(presentCount);
      
      // Update status badges
      $('.student-absent').each(function() {
        const studentId = $(this).data('student-id');
        const row = $(this).closest('tr');
        const statusCell = row.find('td:last-child');
        
        if ($(this).is(':checked')) {
          statusCell.html('<span class="badge attendance-absent">Absent</span>');
        } else {
          statusCell.html('<span class="badge attendance-present">Présent</span>');
        }
      });
    }
    
    // Handle student absent checkbox changes
    $(document).on('change', '.student-absent', function() {
      updateAttendanceCounts();
    });
    
    // Select all students checkbox
    $(document).on('change', '#selectAllStudents', function() {
      const isChecked = $(this).is(':checked');
      $('.student-absent').prop('checked', isChecked);
      updateAttendanceCounts();
    });
    
    // Select all absent button
    $(document).on('click', '#selectAllAbsent', function() {
      $('.student-absent').prop('checked', true);
      updateAttendanceCounts();
    });
    
    // Clear all absent button
    $(document).on('click', '#clearAllAbsent', function() {
      $('.student-absent').prop('checked', false);
      updateAttendanceCounts();
    });
    

    //fonction qui permet de renseigner les absences
    $(document).on('click', '#saveAttendanceBtnModal', function() {
        const sessionDate = $('#attendanceDateInput').val();
        const lignePresenceId = "{{pk}}"; // un input caché avec l'id de LigneRegistrePresence

        if (!sessionDate) {
            alert('Veuillez sélectionner une date pour la séance');
            return;
        }

        const attendanceRecords = [];
        $('.student-absent').each(function() {
            const studentId = $(this).data('student-id-take');
            const isAbsent = $(this).is(':checked');

            attendanceRecords.push({
            student_id: studentId,
            status: isAbsent ? 'A' : 'P' // A = absent, P = présent
            });
        });

        const attendanceSession = {
            ligne_presence: lignePresenceId,
            date: sessionDate,
            records: attendanceRecords
        };

        // Envoi AJAX
        $.ajax({
            url: "{% url 't_etudiants:ApiAjouterHistoriqueAbsence' %}", // à définir dans urls.py
            method: "POST",
            data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            data: JSON.stringify(attendanceSession)
            },
            success: function(response) {
            if (response.status === "success") {
                alertify.success(response.message);
                $('#takeAttendanceModal').modal('hide');
            } else {
                alertify.error(response.message);
            }
            },
            error: function() {
            alertify.error("Erreur de communication avec le serveur");
            }
        });
        });

    
    // Export attendance button
   
    $(document).on('click', '#exportAttendanceBtn', function() {
      alert('Export Excel des présences bientôt disponible');
    });
  });
</script>

{% endblock content %}