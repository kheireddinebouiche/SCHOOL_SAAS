{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Présences - Détails Ligne Présence {% endblock title %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* Prevents the icon from interfering with clicks */
  }
  .search-box input {
    padding-left: 40px; /* Make sure text doesn't overlap with icon */
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  
  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }
  
  .table td.text-end {
    position: relative;
    overflow: visible;
  }
  
  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }
  
  .attendance-status-present {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
  }
  
  .attendance-status-absent {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
  }
  
  .attendance-status-late {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
  }
  
  .attendance-status-justified {
    background-color: rgba(0, 123, 255, 0.1);
    color: #007bff;
  }
  
  /* Attendance modal specific styles */
  .attendance-checkbox-cell {
    width: 30px;
    text-align: center;
  }
  
  .attendance-checkbox-cell input[type="checkbox"] {
    margin: 0;
  }
  
  .attendance-present {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
  }
  
  .attendance-absent {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
  }
  
  .attendance-late {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
  }
  
  .attendance-justified {
    background-color: rgba(0, 123, 255, 0.1);
    color: #007bff;
  }
  
  .attendance-student-avatar {
    width: 36px;
    height: 36px;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="ri-user-line text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Détails Présences Étudiants</h4>
            </div>
            <div class="page-title-right">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                <li class="breadcrumb-item">
                  <a href="javascript: void(0);">Présences</a>
                </li>
                <li class="breadcrumb-item active">Détails Ligne Présence</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Total Étudiants</p>
                  <h4 class="mb-0" id="totalStudents">{{ etudiants|length|default:0 }}</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-user-line text-primary fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Présents</p>
                  <h4 class="mb-0" id="presentCount">0</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-check-line text-success fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Absents</p>
                  <h4 class="mb-0" id="absentCount">0</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-danger bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-close-line text-danger fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <p class="text-muted mb-1">Taux Moyen</p>
                  <h4 class="mb-0" id="averageAttendanceRate">0%</h4>
                </div>
                <div class="flex-shrink-0">
                  <div class="avatar-sm rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center">
                    <i class="ri-percentage-line text-info fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Module Information Section -->
      <div class="row mb-4">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-book text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Informations du Module</h5>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label text-muted">Nom du Module</label>
                    <h6 class="mb-0">{{ligne_presence.module.label}}</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Code du Module</label>
                    <h6 class="mb-0">{{ligne_presence.module.code}}</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Type de Cours</label>
                    <h6 class="mb-0">
                      <span class="badge bg-primary bg-opacity-10 text-primary px-2 py-1">Cours</span>
                    </h6>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label text-muted">Enseignant</label>
                    <h6 class="mb-0">Prof. Martin Dubois</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Groupe</label>
                    <h6 class="mb-0">Groupe A - L3 Informatique</h6>
                  </div>
                  <div class="mb-3">
                    <label class="form-label text-muted">Crédits</label>
                    <h6 class="mb-0">6 ECTS</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-lg-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0 text-info">Liste des Étudiants</h4>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-secondary px-4" id="exportExcelBtn">
                <i class="ri-file-excel-line me-1"></i> Exporter Excel
              </button>
              <button class="btn btn-info px-4" id="createAttendanceBtn">
                <i class="ri-add-line me-1"></i> Nouvelle Présence
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="table-filter" class="form-control rounded-pill ps-4" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>
                  
                  <select id="filter-group" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Filtrer par groupe</option>
                    {% for groupe in groupes %}
                      <option value="{{ groupe.id }}">{{ groupe.nom }}</option>
                    {% endfor %}
                  </select>

                </div>
              </div>
            </div>
            <div class="card-body p-3" id="cardContentBody">
              <div class="table-responsive" style="overflow-x: visible;">
                <table id="example" class="table table-hover align-middle mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 rounded-start">Étudiant</th>
                      <th class="border-0">Matricule</th>
                      <th class="border-0 rounded-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="listeItem" class="border-top-0">
                    {% if etudiants %}
                      {% for etudiant in etudiants %}
                        <tr>
                          <td class="d-flex align-items-center">
                            <div class="avatar-xs rounded-circle bg-light border me-2">
                              <span class="avatar-title rounded-circle text-white">
                                {% if etudiant.student.nom %}
                                  {{ etudiant.student.prenom.0|upper }}
                                   {{ etudiant.student.nom.0|upper }}
                                {% else %}
                                  {{ etudiant.student.nom.0|upper }}
                                {% endif %}
                              </span>
                            </div>
                            <div>
                              <h6 class="mb-0">{{ etudiant.student.nom}} {{etudiant.student.prenom}}</h6>
                            </div>
                          </td>
                          <td>{{ etudiant.student.matricule_interne|default:"N/A" }}</td>
                          <td class="text-end">
                            <button id='displayPresenceBtn' class="btn btn-info btn-sm" 
                                    data-student-id="{{etudiant.student.id}}" 
                                    data-student-name="{{ etudiant.student.nom}} {{etudiant.student.prenom}}"
                                    data-student-matricule="{{etudiant.student.matricule_interne|default:'N/A'}}"
                                    data-student-absences="0">
                              <i class="ri-eye-line align-bottom me-1"></i> Présences
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                        <tr>
                          <td colspan="3">
                             <div class="d-flex flex-column align-items-center justify-content-center py-5">
                                <div class="avatar-sm mb-4">
                                    <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                        <i class="ri-user-line"></i>
                                    </div>
                                </div>
                                <h5 class="mb-2">Aucun étudiant trouvé</h5>
                                <p class="text-muted mb-0">Il n'y a aucun étudiant enregistré pour le moment</p>
                            </div>
                          </td>
                        </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal for student presence details -->
<div class="modal fade" id="presenceModal" tabindex="-1" aria-labelledby="presenceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-user-line text-info fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-info mb-1" id="modalStudentName">
              Présences de l'Étudiant
            </h5>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row mb-4">
          <div class="col-lg-4">
            <div class="card border shadow-sm">
              <div class="card-body text-center">
                <div class="avatar-lg mx-auto mb-3">
                  <div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle h2 mb-0">
                    <i class="ri-user-line"></i>
                  </div>
                </div>
                <h5 class="mb-1" id="modalStudentFullName">Nom de l'Étudiant</h5>
                <p class="text-muted mb-0" id="modalStudentMatricule">Matricule: -</p>
              </div>
            </div>
          </div>
          
          <div class="col-lg-8">
            <div class="row">
              <div class="col-md-4">
                <div class="card border text-center">
                  <div class="card-body">
                    <h5 class="card-title text-info">Présences</h5>
                    <h3 class="mb-1" id="modalPresentCount">0</h3>
                    <p class="text-muted mb-0">Séances</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card border text-center">
                  <div class="card-body">
                    <h5 class="card-title text-danger">Absences</h5>
                    <h3 class="mb-1" id="modalAbsentCount">0</h3>
                    <p class="text-muted mb-0">Séances</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card border text-center">
                  <div class="card-body">
                    <h5 class="card-title text-danger">Taux</h5>
                    <h3 class="mb-1" id="modalAttendanceRate">0%</h3>
                    <p class="text-muted mb-0">Moyen</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-lg-12">
            <div class="card shadow border-0">
              <div class="card-header bg-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0 text-info">
                    <i class="fas fa-calendar-check me-2"></i>
                    Historique des Présences
                  </h5>
                </div>
              </div>
              <div class="card-body p-3">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th class="border-0 rounded-start">Date</th>
                        <th class="border-0">Module</th>
                        <th class="border-0">Statut</th>
                        <th class="border-0">Heure</th>
                        <th class="border-0">Raison</th>
                        <th class="border-0 rounded-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="modalPresenceTableBody">
                      <!-- Presence records will be dynamically loaded here -->
                      <tr>
                        <td colspan="6" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center">
                            <div class="avatar-sm mb-3">
                              <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                <i class="ri-calendar-line"></i>
                              </div>
                            </div>
                            <h5 class="mb-1">Aucune donnée de présence</h5>
                            <p class="text-muted mb-0">Les présences seront affichées après chargement</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-between w-100">
          <div>
            <button class="btn btn-light px-4" id="exportStudentPresenceBtn">
              <i class="ri-file-pdf-line me-1"></i> Exporter PDF
            </button>
          </div>
          <div class="hstack gap-2">
            <button class="btn btn-warning px-4" id="printWarningBtn">
              <i class="ri-printer-line me-1"></i> Imprimer un avertissement
            </button>
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
              <i class="ri-close-line me-1"></i> Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for taking attendance -->
<div class="modal fade" id="takeAttendanceModal" tabindex="-1" aria-labelledby="takeAttendanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-user-check-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="takeAttendanceModalLabel">
              Prise de Présence
            </h5>
            <p class="text-muted small mb-0">Groupe: <span id="attendanceSessionGroup">-</span></p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row mb-4">
          <div class="col-lg-12">
            <div class="mb-3">
              <label for="attendanceDateInput" class="form-label">Date de la Séance</label>
              <input type="date" class="form-control" id="attendanceDateInput" value="{{ now|date:"Y-m-d" }}">
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <div class="alert alert-info" role="alert">
              <i class="ri-information-line me-2"></i>
              <strong>Mode Absence:</strong> Cochez uniquement les étudiants absents. Les étudiants non cochés seront considérés comme présents.
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-lg-12">
            <div class="card shadow border-0">
              <div class="card-header bg-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0 text-success">
                    <i class="ri-user-line me-2"></i>
                    Liste des Étudiants
                  </h5>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="selectAllAbsent">
                      <i class="ri-check-line me-1"></i> Tous Absents
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="clearAllAbsent">
                      <i class="ri-close-line me-1"></i> Aucun Absent
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body p-3">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th class="border-0 rounded-start" style="width: 30px;">
                          <input type="checkbox" class="form-check-input" id="selectAllStudents">
                        </th>
                        <th class="border-0">Étudiant</th>
                        <th class="border-0">Matricule</th>
                        <th class="border-0 rounded-end">Statut</th>
                      </tr>
                    </thead>
                    <tbody id="attendanceStudentsTableBody">
                      <!-- Student rows will be dynamically loaded here -->
                      <tr>
                        <td colspan="4" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center">
                            <div class="avatar-sm mb-3">
                              <div class="avatar-title bg-light text-muted rounded-circle fs-1">
                                <i class="ri-user-line"></i>
                              </div>
                            </div>
                            <h5 class="mb-1">Aucun étudiant à afficher</h5>
                            <p class="text-muted mb-0">Les étudiants seront chargés après sélection du groupe</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-between w-100">
          <div>
            <button class="btn btn-light px-4" id="exportAttendanceBtn">
              <i class="ri-file-excel-line me-1"></i> Exporter Excel
            </button>
          </div>
          <div class="hstack gap-2">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
              <i class="ri-close-line me-1"></i> Annuler
            </button>
            <button type="button" class="btn btn-success px-4" id="saveAttendanceBtnModal">
              <i class="ri-save-line me-1"></i> Enregistrer Présences
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Update statistics based on data in the table
    function updateStatistics() {
      const totalStudents = $('#totalStudents').text();
      let presentCount = 0;
      let absentCount = 0;
      let totalRate = 0;
      let validRecords = 0;
      
      $('#listeItem tr').each(function() {
        const $row = $(this);
        const cells = $row.find('td');
        if (cells.length > 0) {
          const rateCell = cells.eq(3).find('span');
          const absencesCell = cells.eq(4).find('span');
          
          if (rateCell.length > 0 && absencesCell.length > 0) {
            const rateText = rateCell.text().trim();
            const absencesText = absencesCell.text().trim();
            
            if (rateText && rateText !== '0%') {
              const rateValue = parseInt(rateText.replace('%', ''));
              if (!isNaN(rateValue)) {
                totalRate += rateValue;
                validRecords++;
              }
            }
            
            if (absencesText && absencesText !== '0') {
              const absencesValue = parseInt(absencesText);
              if (!isNaN(absencesValue)) {
                absentCount += absencesValue;
              }
            }
          }
        }
      });
      
      const averageRate = validRecords > 0 ? Math.round(totalRate / validRecords) : 0;
      
      $('#presentCount').text(totalStudents - absentCount);
      $('#absentCount').text(absentCount);
      $('#averageAttendanceRate').text(averageRate + '%');
    }
    
    // Initialize statistics
    updateStatistics();
    
    

    $(document).on('click', '#displayPresenceBtn', function(){
        const studentId = $(this).data('student-id');
        const studentName = $(this).data('student-name');
        const studentMatricule = $(this).data('student-matricule');
        loadStudentHistory(studentId, studentName, studentMatricule);
    })

    function loadStudentHistory(studentId, studentName, studentMatricule) {
        $.ajax({
            url: `/scolarite/etudiants/ApiGetHistoriqueEtudiant/${studentId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
              if (response.status === 'success') {
                  displayStudentHistory(response.historique);
                  
                  // Set the student ID as a data attribute on the modal for the print button
                  $('#presenceModal').data('student-id', studentId);
                  $('#presenceModal').data('student-name', studentName);
                  $('#presenceModal').data('student-matricule', studentMatricule);
                  
                  // Set student name and matricule in the modal
                  $('#modalStudentFullName').text(studentName);
                  $('#modalStudentMatricule').text('Matricule: ' + (studentMatricule || '-'));
                  
                  $('#presenceModal').modal('show');
              } else {
                  alertify.error("Erreur : " + response.message);
              }
            },
            error: function() {
            alertify.error("Erreur lors du chargement de l'historique.");
            }
        });
    }

    function displayStudentHistory(historique) {
        const container = $('#modalPresenceTableBody');
        container.empty();

        if (!historique || historique.length === 0) {
            container.html('<p>Aucun historique trouvé.</p>');
            return;
        }

        let nb_absence = 0;
        let nb_present = 0;

        historique.forEach(entry => {
          var modulesTable = "";
          entry.data.forEach(item => {
          // Determine the reason field - using a default 'N/A' if not provided
          const reason = item.reason || item.motif || 'N/A';
          
          modulesTable += `
              <tr>
              <td>${entry.date}</td>
              <td>${item.module}</td>
              <td>${item.etat === 'P' ? '<span class="badge bg-success" >Présent</span>' : item.etat === 'A' ? '<span class="badge bg-danger" >Absent</span>' : item.etat}</td>
              <td>${item.heure}h</td>
              <td>
                <span class="reason-text">${reason}</span>
              </td>
              <td>
                ${item.etat === 'A' ? `<button class="btn btn-outline-primary btn-sm edit-reason-btn" data-date="${entry.date}" data-module="${item.module}" data-reason="${reason}">
                  <i class="ri-edit-line"></i>
                </button>` : '<span class="text-muted">N/A</span>'}
              </td>
              </tr>`;

              if (item.etat === 'P') {
                nb_present++;
              } else if (item.etat === 'A') {
                  nb_absence++;
              }
              
          }); 
                  
          container.append( modulesTable);
        });
        $("#modalPresentCount").html(nb_present);
        $('#modalAbsentCount').html(nb_absence);

        const total = nb_present + nb_absence;
        const taux_absence = total > 0 ? ((nb_absence / total) * 100).toFixed(1) : 0;
        const taux_presence = total > 0 ? ((nb_present / total) * 100).toFixed(1) : 0;

        $('#modalAttendanceRate').html(taux_presence);
    }
    
    // Handle edit reason button click
    $(document).on('click', '.edit-reason-btn', function() {
      const date = $(this).data('date');
      const module = $(this).data('module');
      const currentReason = $(this).data('reason');
      
      // Create and show modal for editing reason
      showEditReasonModal(date, module, currentReason, $(this));
    });
    
    // Function to show edit reason modal
    function showEditReasonModal(date, module, currentReason, $button) {
      // Create modal HTML dynamically
      const modalHtml = `
        <div class="modal fade" id="editReasonModal" tabindex="-1" aria-labelledby="editReasonModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
              <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                  <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                    <i class="ri-edit-line text-primary fs-5"></i>
                  </div>
                  <div>
                    <h5 class="modal-title fw-semibold text-primary mb-1" id="editReasonModalLabel">
                      Modifier le Motif d'Absence
                    </h5>
                  </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-4">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label text-muted">Date</label>
                    <div class="p-2 bg-light rounded">${date}</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label text-muted">Module</label>
                    <div class="p-2 bg-light rounded">${module}</div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="editReasonInput" class="form-label">Motif d'Absence</label>
                  <textarea class="form-control" id="editReasonInput" rows="4">${currentReason}</textarea>
                </div>
              </div>
              <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-end w-100">
                  <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i> Annuler
                  </button>
                  <button type="button" class="btn btn-success px-4" id="saveReasonBtn">
                    <i class="ri-save-line me-1"></i> Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to body
      $('body').append(modalHtml);
      
      // Show modal
      $('#editReasonModal').modal('show');
      
      // Handle save button click
      $(document).off('click', '#saveReasonBtn').on('click', '#saveReasonBtn', function() {
        const newReason = $('#editReasonInput').val();
        if (newReason.trim()) {
          // In a real application, you would save this to the server
          console.log('Updating reason:', {
            date: date,
            module: module,
            reason: newReason
          });
          
          // Update the reason in the table
          $button.closest('tr').find('.reason-text').text(newReason);
          $button.data('reason', newReason);
          
          // Show success message
          alert('Motif d\'absence mis à jour avec succès!');
        } else {
          alert('Veuillez entrer un motif d\'absence');
          return;
        }
        
        // Close and remove modal
        $('#editReasonModal').modal('hide');
        $('#editReasonModal').remove();
      });
      
      // Remove modal from DOM when closed
      $('#editReasonModal').on('hidden.bs.modal', function() {
        $(this).remove();
      });
    }
    
    // Client-side search functionality
    $(document).on('input', '#table-filter', function() {
      var searchTerm = $(this).val().trim().toLowerCase();
      
      if (searchTerm === '') {
        // Show all rows
        $('#listeItem tr').show();
      } else {
        // Hide all rows first
        $('#listeItem tr').hide();
        
        // Show rows that match the search term
        $('#listeItem tr').each(function() {
          var $row = $(this);
          var rowText = $row.text().toLowerCase();
          
          if (rowText.includes(searchTerm)) {
            $row.show();
          }
        });
      }
    });
    
    // Filter by group
    $(document).on('change', '#filter-group', function() {
      var filterValue = $(this).val();
      
      if (filterValue === '') {
        // Show all rows
        $('#listeItem tr').show();
      } else {
        // Hide all rows first
        $('#listeItem tr').hide();
        
        // Show rows that match the selected group
        $('#listeItem tr').each(function() {
          var $row = $(this);
          var groupCell = $row.find('td').eq(2).text().trim();
          
          if (groupCell.includes(filterValue)) {
            $row.show();
          }
        });
      }
    });
    
    // Export to Excel functionality
    $(document).on('click', '#exportExcelBtn', function() {
      alert('Fonctionnalité d\'export Excel bientôt disponible');
    });
    
    // Export student presence to PDF
    $(document).on('click', '#exportStudentPresenceBtn', function() {
      alert('Export PDF des présences de l\'étudiant bientôt disponible');
    });
    
    // Print warning functionality
    $(document).on('click', '#printWarningBtn', function() {
      // Get the student data from the modal's data attributes
      const studentId = $('#presenceModal').data('student-id');
      const studentName = $('#presenceModal').data('student-name');
      const studentMatricule = $('#presenceModal').data('student-matricule');
      
      if (!studentId) {
        alert('Impossible de récupérer l\'ID de l\'étudiant');
        return;
      }
      
      // Calculate attendance statistics based on the data in the modal
      const totalSessions = parseInt($('#modalPresentCount').text()) + parseInt($('#modalAbsentCount').text());
      const totalAbsences = parseInt($('#modalAbsentCount').text());
      const attendanceRate = parseFloat($('#modalAttendanceRate').text().replace('%', ''));
      
      // Generate the warning PDF
      generateWarningPDF(studentName, studentMatricule, totalAbsences, totalSessions, attendanceRate);
    });
    
    // Function to generate warning PDF using jsPDF
    function generateWarningPDF(studentName, studentMatricule, totalAbsences, totalSessions, attendanceRate) {
      // Check if jsPDF is loaded
      if (typeof window.jspdf === 'undefined') {
        console.error("jsPDF n'est pas chargé");
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      
      // Set up document properties
      doc.setProperties({
        title: 'Avertissement de régularisation',
        subject: 'Avertissement pour absences injustifiées',
        author: 'Système de gestion scolaire'
      });
      
      // Define text styles
      const addText = (text, x, y, fontSize = 12, style = 'normal', maxWidth = 180) => {
        doc.setFontSize(fontSize);
        if (style === 'bold') {
          doc.setFont(undefined, 'bold');
        } else {
          doc.setFont(undefined, 'normal');
        }
        
        // Split text into lines to avoid going beyond page width
        const textLines = doc.splitTextToSize(text, maxWidth);
        doc.text(textLines, x, y);
        
        // Return the number of lines added
        return textLines.length;
      };
      
      // Define text styles and layout
      let currentY = 20;
      const pageWidth = doc.internal.pageSize.width;
      const marginLeft = 15;
      const marginRight = 15;
      const maxWidth = pageWidth - marginLeft - marginRight;
      
      // Institution header - Centered
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("INSTITUTION D'ENSEIGNEMENT SUPÉRIEUR", pageWidth / 2, currentY, { align: 'center' });
      currentY += 8;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text("Adresse: 123 Avenue de l'Université, 75000 Paris", pageWidth / 2, currentY, { align: 'center' });
      currentY += 6;
      doc.text("Téléphone: +33 1 23 45 67 89", pageWidth / 2, currentY, { align: 'center' });
      currentY += 6;
      doc.text("Email: contact@universite.com", pageWidth / 2, currentY, { align: 'center' });
      currentY += 15;
      
      // Title - Centered
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text("AVERTISSEMENT DE RÉGULARISATION", pageWidth / 2, currentY, { align: 'center' });
      currentY += 15;
      
      // Date
      const now = new Date();
      const dateStr = now.toLocaleDateString('fr-FR');
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text(`Date: ${dateStr}`, marginLeft, currentY);
      currentY += 12;
      
      // Student information
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      currentY += addText("Étudiant(e): " + studentName, marginLeft, currentY, 12, 'bold') * 6;
      currentY += 4;
      currentY += addText("Matricule: " + (studentMatricule || 'N/A'), marginLeft, currentY, 12, 'normal') * 6;
      currentY += 12;
      
      // Warning subject
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      currentY += addText("Objet: Avertissement de régularisation pour absences injustifiées", marginLeft, currentY) * 6;
      currentY += 10;
      
      // Warning content with better paragraph structure
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      
      // Paragraph 1
      const parag1 = `À la suite de l'analyse de votre présence, il a été constaté que vous avez accumulé ${totalAbsences} absence(s) sur un total de ${totalSessions} séances.`;
      currentY += addText(parag1, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 6;
      
      // Paragraph 2
      const parag2 = `Votre taux de présence est de ${attendanceRate.toFixed(2)}%, ce qui est inférieur au taux minimum requis de 80%.`;
      currentY += addText(parag2, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 8;
      
      // Paragraph 3
      const parag3 = "Cet avertissement vous est adressé conformément au règlement intérieur de l'établissement, et vise à vous sensibiliser à l'importance de votre assiduité dans le cadre de votre parcours académique.";
      currentY += addText(parag3, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 8;
      
      // Paragraph 4
      const parag4 = "En conséquence, nous vous prions de bien vouloir justifier vos absences dans les plus brefs délais auprès de la direction des études, et de vous conformer strictement au calendrier académique pour la suite de votre formation.";
      currentY += addText(parag4, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 8;
      
      // Paragraph 5
      const parag5 = "Tout défaut de régularisation pourrait entraîner des sanctions plus sévères conformément au règlement intérieur de l'établissement.";
      currentY += addText(parag5, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 12;
      
      // Closing
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text("Cordialement,", marginLeft, currentY);
      currentY += 10;
      
      // Signature block
      doc.text("La Direction des Études", marginLeft, currentY);
      currentY += 20;
      
      // Add information about two copies
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text("Cet avertissement est établi en deux exemplaires:", marginLeft, currentY);
      currentY += 6;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text("1. Un pour l'étudiant", marginLeft, currentY);
      currentY += 5;
      doc.text("2. Un pour le dossier physique de l'étudiant", marginLeft, currentY);
      currentY += 15;
      
      // Add separator line between copies
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(marginLeft, currentY, pageWidth - marginRight, currentY);
      currentY += 15;
      
      // Add second copy title - Centered
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text("COPIE - AVERTISSEMENT DE RÉGULARISATION", pageWidth / 2, currentY, { align: 'center' });
      currentY += 15;
      
      // Add the same information again for the second copy
      // Date for second copy
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text(`Date: ${dateStr}`, marginLeft, currentY);
      currentY += 12;
      
      // Student information for second copy
      currentY += addText("Étudiant(e): " + studentName, marginLeft, currentY, 12, 'bold') * 6;
      currentY += 4;
      currentY += addText("Matricule: " + (studentMatricule || 'N/A'), marginLeft, currentY, 12, 'normal') * 6;
      currentY += 12;
      
      // Warning subject for second copy
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      currentY += addText("Objet: Avertissement de régularisation pour absences injustifiées", marginLeft, currentY) * 6;
      currentY += 10;
      
      // Warning content for second copy - with better paragraph structure
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      
      // Paragraph 1 for second copy
      currentY += addText(parag1, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 6;
      
      // Paragraph 2 for second copy
      currentY += addText(parag2, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 8;
      
      // Paragraph 3 for second copy
      currentY += addText(parag3, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 8;
      
      // Paragraph 4 for second copy
      currentY += addText(parag4, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 8;
      
      // Paragraph 5 for second copy
      currentY += addText(parag5, marginLeft, currentY, 12, 'normal', maxWidth - 10) * 7;
      currentY += 12;
      
      // Closing for second copy
      doc.text("Cordialement,", marginLeft, currentY);
      currentY += 10;
      
      doc.text("La Direction des Études", marginLeft, currentY);
      currentY += 15;
      
      // Add information about two copies for second copy
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text("Cet avertissement est établi en deux exemplaires:", marginLeft, currentY);
      currentY += 6;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text("1. Un pour l'étudiant", marginLeft, currentY);
      currentY += 5;
      doc.text("2. Un pour le dossier physique de l'étudiant", marginLeft, currentY);
      
      // Add signature area for both copies
      currentY += 20;
      
      // Line for signature
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(pageWidth / 2 - 30, currentY, pageWidth / 2 + 30, currentY);
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text("Signature et cachet", pageWidth / 2, currentY + 5, { align: 'center' });
      
      // Save the PDF
      const fileName = `avertissement_${studentName.replace(/\s+/g, '_')}_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.pdf`;
      doc.save(fileName);
    }
    
    // Create new attendance button
    $(document).on('click', '#createAttendanceBtn', function() {
      // Show the attendance modal when this button is clicked
      $('#takeAttendanceModal').modal('show');
      // Initialize the attendance taking session
      initializeAttendanceSession();
    });
    
    // Initialize the attendance session when modal is shown
    $('#takeAttendanceModal').on('shown.bs.modal', function() {
      initializeAttendanceSession();
    });
    
    // Initialize attendance session
    function initializeAttendanceSession() {
      // Set session info
      const today = new Date();
      const options = { day: 'numeric', month: 'short', year: 'numeric' };
      const dateStr = today.toLocaleDateString('fr-FR', options);
      $('#attendanceSessionDate').text(dateStr);
      $('#attendanceSessionGroup').text('Groupe A');
      $('#attendanceSessionName').text('Séance du ' + dateStr);
      
      // Set default date in the input field
      const todayStr = today.toISOString().split('T')[0];
      $('#attendanceDateInput').val(todayStr);
      
      // Load students for attendance
      loadStudentsForAttendance();
    }
    
    // Load students for attendance taking
    function loadStudentsForAttendance() {
      // Simulate loading students
      $('#attendanceStudentsTableBody').html(`
        {% for etudiant in etudiants %}
            <tr>
            <td class="attendance-checkbox-cell"><input type="checkbox" class="form-check-input student-absent" data-student-id-take="{{etudiant.student.id}}"></td>
            <td class="d-flex align-items-center">
                <div>
                    <h6 class="mb-0">{{etudiant.student.nom}} {{etudiant.student.prenom}}</h6>
                </div>
            </td>
            <td>{{etudiant.student.matricule_interne}}</td>
            <td class="text-center"><span class="badge attendance-present">Présent</span></td>
            </tr>
        {% endfor %}
      
      `);
      
      updateAttendanceCounts();
    }
    
    // Update attendance counts
    function updateAttendanceCounts() {
      const absentCount = $('.student-absent:checked').length;
      const totalCount = $('.student-absent').length;
      const presentCount = totalCount - absentCount;
      
      $('#absentCount').text(absentCount);
      $('#presentCount').text(presentCount);
      
      // Update status badges
      $('.student-absent').each(function() {
        const studentId = $(this).data('student-id');
        const row = $(this).closest('tr');
        const statusCell = row.find('td:last-child');
        
        if ($(this).is(':checked')) {
          statusCell.html('<span class="badge attendance-absent">Absent</span>');
        } else {
          statusCell.html('<span class="badge attendance-present">Présent</span>');
        }
      });
    }
    
    // Handle student absent checkbox changes
    $(document).on('change', '.student-absent', function() {
      updateAttendanceCounts();
    });
    
    // Select all students checkbox
    $(document).on('change', '#selectAllStudents', function() {
      const isChecked = $(this).is(':checked');
      $('.student-absent').prop('checked', isChecked);
      updateAttendanceCounts();
    });
    
    // Select all absent button
    $(document).on('click', '#selectAllAbsent', function() {
      $('.student-absent').prop('checked', true);
      updateAttendanceCounts();
    });
    
    // Clear all absent button
    $(document).on('click', '#clearAllAbsent', function() {
      $('.student-absent').prop('checked', false);
      updateAttendanceCounts();
    });
    

    //fonction qui permet de renseigner les absences
    $(document).on('click', '#saveAttendanceBtnModal', function() {
        const sessionDate = $('#attendanceDateInput').val();
        const lignePresenceId = "{{pk}}"; // un input caché avec l'id de LigneRegistrePresence

        if (!sessionDate) {
            alert('Veuillez sélectionner une date pour la séance');
            return;
        }

        const attendanceRecords = [];
        $('.student-absent').each(function() {
            const studentId = $(this).data('student-id-take');
            const isAbsent = $(this).is(':checked');

            attendanceRecords.push({
            student_id: studentId,
            status: isAbsent ? 'A' : 'P' // A = absent, P = présent
            });
        });

        const attendanceSession = {
            ligne_presence: lignePresenceId,
            date: sessionDate,
            records: attendanceRecords
        };

        // Envoi AJAX
        $.ajax({
            url: "{% url 't_etudiants:ApiAjouterHistoriqueAbsence' %}", // à définir dans urls.py
            method: "POST",
            data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            data: JSON.stringify(attendanceSession)
            },
            success: function(response) {
            if (response.status === "success") {
                alertify.success(response.message);
                $('#takeAttendanceModal').modal('hide');
            } else {
                alertify.error(response.message);
            }
            },
            error: function() {
            alertify.error("Erreur de communication avec le serveur");
            }
        });
        });

    
    // Export attendance button
   
    $(document).on('click', '#exportAttendanceBtn', function() {
      alert('Export Excel des présences bientôt disponible');
    });
  });
</script>

{% endblock content %}