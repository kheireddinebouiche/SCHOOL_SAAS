{% extends 'tenant_folder/base.html' %}
{% load static %}

{% block title %} Mes Messages {% endblock title %}

{% block content %}
<style>
    /* Scoped Messaging Theme */
    .chat-app-container {
        --chat-primary: #0ab39c;
        --chat-primary-light: #e6f7f5;
        --chat-bg: #f3f6f9;
        --chat-card-bg: #ffffff;
        --chat-border: #eff2f7;
        --chat-text-primary: #495057;
        --chat-text-secondary: #878a99;
        
        height: calc(100vh - 160px); /* Adjust based on header + footer + padding */
        min-height: 500px;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        overflow: hidden;
        background-color: var(--chat-card-bg);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid var(--chat-border);
    }

    /* Layout & Cards */
    .chat-wrapper {
        display: flex;
        overflow: hidden;
        flex: 1;
        height: 100%;
    }

    .chat-sidebar {
        width: 300px;
        background: #fff;
        border-right: 1px solid var(--chat-border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        z-index: 2;
    }

    .chat-main {
        flex: 1;
        background: #fbfbfc;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    /* Sidebar Components */
    .sidebar-header {
        padding: 1.25rem;
        border-bottom: 1px solid transparent;
    }

    .search-box__input {
        background-color: var(--chat-bg);
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 0.6rem 1rem 0.6rem 2.6rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .search-box__input:focus {
        background-color: #fff;
        border-color: var(--chat-primary);
        box-shadow: 0 0 0 2px var(--chat-primary-light);
    }

    .search-icon {
        position: absolute;
        left: 0.9rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--chat-text-secondary);
        font-size: 1rem;
    }

    .contacts-list {
        overflow-y: auto;
        padding: 0 0.5rem;
        flex: 1;
    }

    .contact-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        margin-bottom: 0.15rem;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .contact-item:hover {
        background-color: var(--chat-bg);
    }

    .contact-item.active {
        background-color: var(--chat-primary-light);
        border-color: transparent;
    }

    .contact-avatar {
        position: relative;
        margin-right: 0.8rem;
    }

    .avatar-char {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: var(--chat-primary-light);
        color: var(--chat-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
    }

    .contact-item.active .avatar-char {
        background: var(--chat-primary);
        color: #fff;
        box-shadow: 0 4px 8px rgba(10, 179, 156, 0.25);
    }

    .online-indicator {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 10px;
        height: 10px;
        background: #22c55e;
        border: 2px solid #fff;
        border-radius: 50%;
    }

    .contact-info {
        flex: 1;
        min-width: 0;
    }

    .contact-name {
        font-weight: 600;
        color: var(--chat-text-primary);
        margin-bottom: 0.1rem;
        font-size: 0.9rem;
    }

    .contact-last-msg {
        font-size: 0.75rem;
        color: var(--chat-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Chat Area */
    .empty-chat-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--chat-text-secondary);
        text-align: center;
        padding: 2rem;
    }

    .empty-state-icon {
        width: 70px;
        height: 70px;
        background: var(--chat-primary-light);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
        color: var(--chat-primary);
        font-size: 2rem;
        transform: rotate(-10deg);
    }

    /* Message Bubbles - Used in partial, defined here for global styles */
    .chat-bubble {
        padding: 10px 16px;
        border-radius: 16px;
        font-size: 0.9rem;
        line-height: 1.5;
        position: relative;
        max-width: 85%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }

    .chat-bubble-sent {
        background: var(--chat-primary);
        color: #fff;
        border-bottom-right-radius: 4px;
    }

    .chat-bubble-received {
        background: #fff;
        color: var(--chat-text-primary);
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(0,0,0,0.05);
    }

    /* Scrollbar */
    .custom-scroll::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: #e0e0e0;
        border-radius: 20px;
    }
    .custom-scroll:hover::-webkit-scrollbar-thumb {
        background-color: #d0d0d0;
    }
    
    /* Nav Tabs Custom */
    .nav-tabs-custom .nav-link {
        color: var(--chat-text-secondary);
        background: transparent;
        border: none;
    }
    .nav-tabs-custom .nav-link.active {
        color: var(--chat-primary);
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Responsive */
    @media (max-width: 991px) {
        .chat-app-container {
            height: calc(100vh - 120px);
            border-right: none;
            border-left: none;
            border-radius: 0;
        }
        .chat-sidebar {
            width: 70px;
            padding: 1rem 0;
            align-items: center;
        }
        .sidebar-header, .contact-info, .contact-last-msg, .new-chat-text, .search-box__input, #pills-tab {
            display: none !important;
        }
        .contacts-list {
            padding: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .contact-item {
            padding: 0.75rem;
            justify-content: center;
        }
        .contact-avatar {
            margin-right: 0;
        }
    }
</style>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            
            <div class="chat-app-container">
                <div class="chat-wrapper">
                    <!-- Sidebar -->
                    <div class="chat-sidebar">
                        <div class="sidebar-header">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <h5 class="mb-0 fw-bold">Messagerie</h5>
                                <button class="btn btn-soft-success btn-sm btn-icon rounded-circle" data-bs-toggle="dropdown" aria-expanded="false" title="Nouvelle conversation">
                                    <i class="ri-add-line fs-5"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg">
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#newChatModal"><i class="ri-user-add-line me-2 text-muted"></i> Nouveau Chat Privé</a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#newGroupModal"><i class="ri-group-line me-2 text-muted"></i> Nouveau Groupe</a></li>
                                </ul>
                            </div>
                            <div class="position-relative mb-3">
                                <input type="text" class="form-control search-box__input" placeholder="Rechercher...">
                                <i class="ri-search-line search-icon"></i>
                            </div>
                            
                            <!-- Tabs for Contacts / Groups -->
                            <ul class="nav nav-pills nav-fill nav-tabs-custom rounded-3 bg-light p-1 mb-0" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active rounded-3 py-1 fs-12 fw-semibold" id="pills-contacts-tab" data-bs-toggle="pill" data-bs-target="#pills-contacts" type="button" role="tab" aria-selected="true" onclick="filterContacts('user')">Contacts</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link rounded-3 py-1 fs-12 fw-semibold" id="pills-groups-tab" data-bs-toggle="pill" data-bs-target="#pills-groups" type="button" role="tab" aria-selected="false" onclick="filterContacts('group')">Groupes</button>
                                </li>
                            </ul>
                        </div>

                        <div class="tab-content contacts-list custom-scroll pt-2" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-contacts" role="tabpanel">
                                {% for contact in contacts %}
                                <div class="contact-item" data-type="user" data-id="{{ contact.id }}">
                                    <div class="contact-avatar">
                                        <div class="avatar-char">
                                            {{ contact.username|slice:":1"|upper }}
                                        </div>
                                        <div class="online-indicator"></div>
                                    </div>
                                    <div class="contact-info">
                                        <h6 class="contact-name">{{ contact.username }}</h6>
                                        <p class="contact-last-msg">Cliquez pour voir la conversation</p>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center p-4">
                                    <p class="text-muted small">Aucune conversation récente.</p>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="tab-pane fade" id="pills-groups" role="tabpanel">
                                {% for group in groups %}
                                <div class="contact-item" data-type="group" data-id="{{ group.id }}">
                                    <div class="contact-avatar">
                                        <div class="avatar-char bg-soft-warning text-warning">
                                            {{ group.name|slice:":1"|upper }}
                                        </div>
                                    </div>
                                    <div class="contact-info">
                                        <h6 class="contact-name">{{ group.name }}</h6>
                                        <p class="contact-last-msg">{{ group.members.count }} membres</p>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center p-4">
                                    <p class="text-muted small">Aucun groupe.</p>
                                    <button class="btn btn-sm btn-link text-primary" data-bs-toggle="modal" data-bs-target="#newGroupModal">Créer un groupe</button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Chat Main Area -->
                    <div class="chat-main" id="chatArea">
                        <div class="empty-chat-state">
                            <div class="empty-state-icon">
                                <i class="ri-chat-voice-line"></i>
                            </div>
                            <h4 class="mb-2 fw-bold text-dark">Vos échanges commencent ici</h4>
                            <p class="mb-4" style="max-width: 300px;">Sélectionnez une personne ou un groupe pour commencer à discuter.</p>
                            <div class="d-flex gap-2">
                                 <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newChatModal">
                                    <i class="ri-user-add-line me-2"></i>Nouveau Chat
                                </button>
                                 <button class="btn btn-soft-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newGroupModal">
                                    <i class="ri-group-line me-2"></i>Nouveau Groupe
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Nouvelle Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="position-relative mb-4">
                    <input type="text" class="form-control bg-light border-0 rounded-3 py-2 ps-5" placeholder="Rechercher un collègue...">
                    <i class="ri-search-line position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                </div>
                
                <h6 class="text-uppercase text-muted fs-11 fw-bold mb-3">Contacts suggérés</h6>
                
                <div class="list-group list-group-flush border-0" style="max-height: 300px; overflow-y: auto;">
                    {% for user in all_users %}
                    <button class="list-group-item list-group-item-action border-0 px-2 py-2 d-flex align-items-center rounded-3 mb-1 new-contact-item" data-type="user" data-id="{{ user.id }}">
                        <div class="avatar-sm me-3 ">
                            <div class="avatar-title rounded-circle bg-light text-primary fw-bold">
                                {{ user.username|slice:":1"|upper }}
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-semibold text-dark">{{ user.username }}</h6>
                            <small class="text-muted">{{ user.email }}</small>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Group Modal -->
<div class="modal fade" id="newGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Créer un nouveau groupe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">Nom du groupe</label>
                    <input type="text" class="form-control bg-light border-0" id="groupNameInput" placeholder="Ex: Projet X">
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">Ajouter des membres</label>
                    <div class="border rounded-3 p-2 bg-light custom-scroll" style="max-height: 200px; overflow-y: auto;">
                        {% for user in all_users %}
                        <div class="form-check mb-2">
                            <input class="form-check-input group-member-check" type="checkbox" value="{{ user.id }}" id="userCheck{{ user.id }}">
                            <label class="form-check-label d-flex align-items-center cursor-pointer" for="userCheck{{ user.id }}">
                                <span class="avatar-xs me-2">
                                    <span class="avatar-title rounded-circle bg-white text-primary fw-bold fs-10 border">
                                        {{ user.username|slice:":1"|upper }}
                                    </span>
                                </span>
                                {{ user.username }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <button class="btn btn-primary w-100 py-2 rounded-3" id="createGroupBtn">
                    Créer le groupe
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function loadConversation(type, id) {
        const chatArea = document.getElementById('chatArea');
        chatArea.innerHTML = `
            <div class="h-100 d-flex flex-column align-items-center justify-content-center">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 2rem; height: 2rem;"></div>
                <p class="text-muted small">Chargement...</p>
            </div>
        `;
        
        // Ensure URLs are correct
        let url = type === 'group' ? `/communication/messages/group/${id}/` : `/communication/messages/${id}/`;
        
        fetch(url)
            .then(res => res.text())
            .then(html => {
                chatArea.innerHTML = html;
                scrollToBottom();
                setupChatActions();
                initTooltips();
            });
    }

    document.querySelectorAll('.contact-item, .new-contact-item').forEach(item => {
        item.addEventListener('click', function() {
            var type = this.dataset.type;
            var id = this.dataset.id;
            
            document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
            // Find sidebar item equivalent in the ACTIVE pane
            const sidebarItem = document.querySelector(`.tab-pane.active .contact-item[data-type="${type}"][data-id="${id}"]`);
            if (sidebarItem) sidebarItem.classList.add('active');

            if (this.classList.contains('new-contact-item')) {
                const modalEl = document.getElementById('newChatModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                // If it's a new contact not yet in list, we might need to reload or handle it. 
                // For now, simpler to just load conversation.
            }
            
            loadConversation(type, id);
        });
    });

    // Group Creation Logic
    const createGroupBtn = document.getElementById('createGroupBtn');
    if (createGroupBtn) {
        createGroupBtn.addEventListener('click', function() {
            const name = document.getElementById('groupNameInput').value;
            const checks = document.querySelectorAll('.group-member-check:checked');
            const members = Array.from(checks).map(c => c.value);
            
            if (!name) return alert("Le nom du groupe est requis");
            
            fetch('/communication/api/groups/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ name: name, members: members })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload(); // Simple reload to show new group
                } else {
                    alert('Erreur: ' + data.message);
                }
            });
        });
    }

    function setupChatActions() {
        var sendBtn = document.getElementById('sendMsgBtn');
        var input = document.getElementById('msgInput');
        var attachBtn = document.getElementById('attachBtn');
        var fileInput = document.getElementById('fileInput');

        if (sendBtn && input) {
            sendBtn.onclick = sendMessage;
            input.onkeypress = function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { // Allow shift+enter for new lines if using textarea
                    e.preventDefault(); 
                    sendMessage();
                }
            };
        }
        
        if (attachBtn && fileInput) {
            attachBtn.onclick = function() {
                fileInput.click();
            };
            
            fileInput.onchange = function() {
                if (this.files.length > 0) {
                    attachBtn.classList.replace('text-muted', 'text-primary');
                    input.focus();
                    const fileName = this.files[0].name;
                    input.placeholder = `Fichier joint : ${fileName}`;
                }
            };
        }
    }

    function sendMessage() {
        var input = document.getElementById('msgInput');
        var fileInput = document.getElementById('fileInput');
        var content = input.value.trim();
        var receiverId = document.getElementById('receiverId') ? document.getElementById('receiverId').value : null;
        var groupId = document.getElementById('groupId') ? document.getElementById('groupId').value : null;
        var file = fileInput ? fileInput.files[0] : null;
        
        if (!content && !file) return;

        var formData = new FormData();
        if (groupId) formData.append('group_id', groupId);
        else formData.append('receiver_id', receiverId);
        
        if (content) formData.append('content', content);
        if (file) formData.append('file', file);

        fetch('/communication/api/messages/send/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                var container = document.getElementById('messagesContainer');
                
                var fileHtml = '';
                if (data.file_url) {
                    var isImage = data.file_url.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                     if (isImage) {
                         fileHtml = `<div class="mb-2"><a href="${data.file_url}" target="_blank"><img src="${data.file_url}" alt="Attachment" class="img-fluid rounded-3 mb-1" style="max-height: 200px; border-radius: 12px;"></a></div>`;
                    } else {
                         fileHtml = `<div class="mb-2"><a href="${data.file_url}" target="_blank" class="d-flex align-items-center p-3 bg-white bg-opacity-25 rounded-3 text-white border border-white border-opacity-25"><i class="ri-file-text-line fs-3 me-2"></i><div class="text-truncate fw-medium" style="max-width: 150px;">${data.file_name}</div></a></div>`;
                    }
                }
                
                var html = `
                    <div class="d-flex justify-content-end mb-4 slide-in-bottom">
                         <div class="flex-grow-1 me-3 text-end">
                            <div class="chat-bubble chat-bubble-sent d-inline-block text-start shadow-sm">
                                ${fileHtml}
                                ${content}
                            </div>
                            <div class="d-flex align-items-center justify-content-end mt-1">
                                <span class="small text-muted me-1">${data.timestamp}</span>
                                <i class="ri-check-double-line text-success fs-12"></i>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
                input.value = '';
                input.placeholder = 'Écrivez votre message...';
                if (fileInput) {
                    fileInput.value = '';
                    var attachBtn = document.getElementById('attachBtn');
                    attachBtn.classList.replace('text-primary', 'text-muted');
                }
                scrollToBottom();
            }
        });
    }

    function scrollToBottom() {
        var container = document.getElementById('messagesContainer');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    
    function initTooltips() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    }
});
</script>
{% endblock content %}
