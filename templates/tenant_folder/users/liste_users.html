{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Utilisateurs - Liste des utilisateurs{% endblock title %}

{% block content %}
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0">Liste des utilisateurs</h4>

                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="javascript: void(0);">Utilisateurs</a></li>
                                        <li class="breadcrumb-item active">Liste des utilisateurs</li>
                                    </ol>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- end page title -->
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Liste des utilisateurs</h5>
                                </div>
                                <div class="card-body">
                                    <table id="example" class="table table-bordered dt-responsive nowrap table-striped align-middle" style="width:100%">
                                        <thead>
                                            <tr>
                                                
                                                <th>Nom d'utilisateurs</th>
                                                <th>Email</th>
                                                <th>Membre du staff</th>
                                                <th>Etat</th>
                                                <td>Crée le </th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listItem">

                                            
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
        </div>

<div class="modal fade demandeCreateProfile" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <lord-icon src="https://cdn.lordicon.com/hwjcdycb.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:120px;height:120px">
                </lord-icon>
                <div class="mt-4">
                    <h4 class="mb-3">Aucun profile trouvé pour l'utilisateur !</h4>
                    <p class="text-muted mb-4">Voulez vous en créer un maintenant ?</p>
                    <div class="hstack gap-2 justify-content-center">
                        
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="createProfileModal" class="modal fade" tabindex="-1" aria-labelledby="createProfileModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProfileModalLabel">Modification des informations de l'entreprise</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5 class="fs-15">
                    Overflowing text to show scroll behavior
                </h5>
                <p class="text-muted">One morning, when Gregor Samsa woke from troubled dreams, he found himself transformed in his bed into a horrible vermin. He lay on his armour-like back, and if he lifted his head a little he could see his brown belly, slightly domed and divided by arches into stiff sections.</p>
                <p class="text-muted">The bedding was hardly able to cover it and seemed ready to slide off any moment. His many legs, pitifully thin compared with the size of the rest of him, waved about helplessly as he looked. "What's happened to me?" he thought.</p>
                <p class="text-muted">It wasn't a dream. His room, a proper human room although a little too small, lay peacefully between its four familiar walls.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                   '<button id="confirmDeleteBtn"  class="btn btn-danger">Confirmer</a>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<script>
    $(document).ready(function(){
        function loadItems(){
            $.ajax({
                url : "{% url 'institut_app:ApiListeUsers' %}",
                type: 'GET',
                dataType: 'JSON',
                success : function(data){
                    var html ="";
                    if (data.length > 0){
                        $.each(data, function(index, p){
                            html += '<tr>';
                                html += '<td><strong>'+p.username+'</strong></td>';
                                html += '<td><strong>'+p.email+'</strong></td>';
                                html += '<td><strong>'+(p.is_staff ? 'Administrateur' : '-' )+'</strong></td>';
                                html += '<td><strong>'+p.is_active+'</strong></td>';
                              
                                html += '<td>'+ p.date_joined.split('T')[0]+'</td>';
                               
                                html += '<td>';
                                html += '<div class="dropdown d-inline-block">';
                                html += '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                                html += '<i class="ri-more-fill align-middle"></i>';
                                html += '</button>';
                                html += '<ul class="dropdown-menu dropdown-menu-end">';
                                html += '<li><button data-id='+p.id+' id="detailsBtn" class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i> Détails</button></li>';
                                html += '<li><button '+(p.etat == 'rejete' ? 'hidden' : '')+' id="updateBtn" data-id='+ p.id +' class="dropdown-item edit-item-btn"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</button></li>';
                                html += '<li>';
                                html += '<button id="deleteConfirmation" data-id="'+p.id+'" class="dropdown-item remove-item-btn">';
                                html += '<i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer';
                                html += '</button>';
                                html += '</li>';
                                html += '</ul>';
                                html += '</div>';
                                html += '</td>';
                                html += '</tr>';
                        });
                    }else{
                                html = "<tr><td colspan=6 class='text-muted text-center'>Aucune données disponible</td><tr>";
                    }

                    $('#listItem').html(html);
                }
            });
        }

        loadItems();

        $(document).on('click','#detailsBtn', function(){
            var id = $(this).data('id');
            $.ajax({
                url : "{% url 'institut_app:ApiGetDetailsProfile' %}",
                dataType: "JSON",
                type : "GET",
                data : {
                    'id' : id,
                },
                success : function(data){
                    if (Array.isArray(data)) {

                        // On suppose que le profil est toujours en première position
                        var profil = data[0];
                       

                    } else if (data.status === 'error') {
                       alertify.error(data.message)
                       var row = '<button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>'+
                                 '<button id="confirmeCreateProfile" data-id='+id+' class="btn btn-warning">Créer le profile maintenant</a>';
    
                        $('.hstack').html(row);
                       $('.demandeCreateProfile').modal('show');
                    }
                }
            });

            $(document).on('click','#confirmeCreateProfile', function(){
                $('.demandeCreateProfile').modal('hide');
                $('#createProfileModal').modal('show');
            });
        });


    });
</script>
{% endblock content %}
           



    