{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Examens - Liste des séssions {% endblock title %}

{% block content %}
<style>
    ._inputDetails {
       background-color: transparent !important;
       border : none !important;
       outline : none;
       font-weight : 700 !important;
    }

    .is-valid {
        border-color: #28a745 !important;
    }

    .valid-feedback {
        color: #28a745;
        display: block;
    }

    .invalid-feedback {
        color: #dc3545;
        display: block;
    }

    /* Harmonized styling with CRM design */
    .page-header {
        background: white;
        color: #495057;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 1.5rem;
        box-shadow: none;
        border: none;
    }

    .session-card {
        border: none;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0.75rem 6rem rgba(56,65,74,.03);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .session-card:hover {
        transform: translateY(0);
        box-shadow: 0 0.75rem 6rem rgba(56,65,74,.03);
    }

    .session-card .card-header {
        background: #f8f9fa;
        color: #495057;
        border: none;
        padding: 1.25rem 1.5rem;
    }

    .session-card .card-body {
        padding: 1.5rem;
    }

    .session-card .card-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }

    .group-card {
        border: none;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0.75rem 6rem rgba(56,65,74,.03);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .group-card:hover {
        transform: translateY(0);
        box-shadow: 0 0.75rem 6rem rgba(56,65,74,.03);
    }

    .group-card .card-header {
        background: #f8f9fa;
        color: #495057;
        border: none;
        padding: 1rem 1.5rem;
    }

    .table-modern {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }

    .table-modern thead th {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
        padding: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .table-modern tbody tr {
        transition: background-color 0.2s ease;
    }

    .table-modern tbody tr:hover {
        background-color: #f8f9fa;
    }

    .table-modern tbody td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .form-control-modern {
        border-radius: 8px;
        border: 1px solid #e1e5e9;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control-modern:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .input-group-modern {
        position: relative;
        margin-bottom: 1.25rem;
    }

    .input-group-modern label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #495057;
    }

    .input-group-modern .form-control {
        border-radius: 8px;
        border: 1px solid #e1e5e9;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .input-group-modern .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .action-dropdown .btn {
        border-radius: 8px;
        padding: 0.25rem 0.5rem;
    }

    .action-dropdown .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 0.5rem 1rem rgba(56,65,74,.15);
        border: none;
        padding: 0.5rem 0;
    }

    .action-dropdown .dropdown-item {
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }

    .action-dropdown .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #2d3748;
    }

    .card-title {
        font-weight: 600;
        color: #495057;
    }

    li.divider {
        height: 1px;
        background-color: #e0e0e0;
    }

    .btn.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    <!-- start page title -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="ri-calendar-schedule-line text-primary"></i>
                                    </div>
                                    <h4 class="mb-0 text-primary">Détails de la session</h4>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb m-0 bg-transparent">
                                            <li class="breadcrumb-item">
                                                <a href="javascript: void(0);">Examens</a>
                                            </li>
                                            <li class="breadcrumb-item active">Détails de la session</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row align-items-stretch mb-4">
                        <div class="col-lg-12 d-flex">
                            <div class="card border-0 shadow-sm rounded-4 w-100">
                                <div class="card-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="ri-calendar-line text-primary fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-primary mb-1">Détails de la session</h5>
                                                <p class="text-muted small mb-0">Informations générales de la session</p>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button id="btnConfigureGroupes" class="btn btn-primary px-4 py-2 btn-sm d-flex align-items-center" data-url="#">
                                                <i class='bx bx-plus me-1'></i>Configurer les groupes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-4">
                                        <div class="col-lg-4">
                                            <div class="mb-4 d-flex align-items-start">
                                                <div class="icon-circle bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                                    <i class="ri-hash text-primary"></i>
                                                </div>
                                                <div>
                                                    <small class="text-muted d-block mb-1">Code</small>
                                                    <span class="fw-semibold">
                                                        <input type="text" disabled class="form-control border-0 bg-light py-2 _inputDetails" id="code_session"  />
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-4 d-flex align-items-start">
                                                <div class="icon-circle bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                                    <i class="ri-calendar-line text-info"></i>
                                                </div>
                                                <div>
                                                    <small class="text-muted d-block mb-1">Date de début</small>
                                                    <span class="fw-semibold">
                                                        <input type="text" disabled class="form-control border-0 bg-light py-2 _inputDetails" id="date_debut" />
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="d-flex align-items-start">
                                                <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                                    <i class="ri-calendar-check-line text-success"></i>
                                                </div>
                                                <div>
                                                    <small class="text-muted d-block mb-1">Date de fin</small>
                                                    <span class="fw-semibold">
                                                        <input type="text" disabled class="form-control border-0 bg-light py-2 _inputDetails" id="date_fin" />
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light bg-opacity-50 border-0 px-4 py-3">
                                    <div class="d-flex justify-content-end">
                                        <div class="d-flex gap-2">
                                            <button id="updateSessionBtn" class="btn btn-primary px-4 py-2"><i class="mdi mdi-pencil me-1"></i> Modifier</button>
                                            <a href="#" class="btn btn-danger px-4 py-2"><i class="mdi mdi-trash-can me-1"></i> Supprimer</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <div class="alert alert-info mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="ri-information-line ri-xl me-3 text-info"></i>
                                    <div>
                                        <h6 class="alert-heading mb-1">Information Importante</h6>
                                        <p class="mb-0">
                                            Pour avoir accès aux PVs de délibération dans la section <strong>Résultats</strong>,
                                            vous devez <strong>clôturer</strong> les groupes en cliquant sur le bouton d'action
                                            <strong>"Clôturer"</strong> dans le menu déroulant de chaque groupe.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card border-0 shadow-sm rounded-4 w-100">
                                <div class="card-header border-0 bg-success bg-opacity-10 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="ri-group-line text-success fs-4"></i>
                                            </div>
                                            <div>
                                                <h5 class="card-title fw-semibold text-success mb-1">Liste des groupes</h5>
                                                <p class="text-muted small mb-0">Groupes associés à cette session</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row" id="SessionLineItem">
                                        <!-- Group cards will be inserted here by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
        </div>


<!-- Modernized Modal for adding new module -->
<div id="addModule" class="modal fade" tabindex="-1" aria-labelledby="addModuleLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-add-box-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="addModuleLabel">
                            Ajout d'un nouveau module
                        </h5>
                        <p class="text-muted small mb-0">Remplissez les informations du module</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="_label" class="form-label fw-medium">Nom du module :</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-user-line text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="_label" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="_code_module" class="form-label fw-medium">Code Module :</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-hash text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="_code_module" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="_coef" class="form-label fw-medium">Coéfficiant du module :</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-percent-line text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="_coef" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="_duree" class="form-label fw-medium">Volume Horraire :</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-time-line text-muted"></i>
                                </span>
                                <input type="number" class="form-control border-0 bg-light py-2" id="_duree" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="addBtn">
                    <i class="ri-check-line me-2"></i>Ajouter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for updating session -->
<div id="updateSessionModal" class="modal fade" tabindex="-1" aria-labelledby="updateSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-edit-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="updateSessionModalLabel">
                            Modifier les informations
                        </h5>
                        <p class="text-muted small mb-0">Modification des informations de la session</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                            <i class="ri-calendar-schedule-line"></i>
                        </div>
                    </div>
                    <h4 class="text-primary mb-3">Modification de la session</h4>
                    <p class="text-muted mb-4">
                        Veuillez remplir les informations ci-dessous pour mettre à jour les détails de la session.
                    </p>
                </div>
                <input type="hidden" id="_id_module" disabled />
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="u_label" class="form-label fw-medium">Label</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-tag-line text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="u_label" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="u_code" class="form-label fw-medium">Code session</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-hash text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="u_code" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="u_date_debut" class="form-label fw-medium">Date de début</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-line text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="u_date_debut" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="u_date_fin" class="form-label fw-medium">Date de fin</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-check-line text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0 bg-light py-2" id="u_date_fin" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-center w-100">
                    <button type="button" class="btn btn-light px-4 py-2 w-100" data-bs-dismiss="modal">
                        <i class="ri-close-line me-2"></i>Annuler
                    </button>
                    <button class="btn btn-primary px-4 py-2 w-100" id="ConfirmUpdateBtn">
                        <i class="ri-save-line me-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for exam planning -->
<div id="plannificationDesExamens" class="modal fade" tabindex="-1" aria-labelledby="plannificationDesExamensLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-schedule-line text-info fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-info mb-1" id="plannificationDesExamensLabel">
                            Plannification des modules d'examens
                        </h5>
                        <p class="text-muted small mb-0">Planifiez les examens pour cette session</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex  align-items-center mb-4">
                    <button type="button" class="btn btn-info px-4 py-2 d-flex align-items-center" id="btnPlanifier">
                        <i class="ri-add-line me-1"></i>Planifier
                    </button>
                </div>

                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="border-0 rounded-start">Module</th>
                                        <th class="border-0">Date examen</th>
                                        <th class="border-0">H. Debut/ H. Fin</th>
                                        <th class="border-0">Type examen</th>
                                        <th class="border-0">Salle</th>
                                        <th class="border-0 rounded-end text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="examPlanTableBody">
                                    <!-- Les lignes seront ajoutées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-danger px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for adding new exam plan -->
<div id="addExamPlanModal" class="modal fade" tabindex="-1" aria-labelledby="addExamPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-calendar-add-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="addExamPlanModalLabel">
                            Planifier un nouvel examen
                        </h5>
                        <p class="text-muted small mb-0">Remplissez les informations de l'examen</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4 mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="moduleSelect" class="form-label fw-medium">Module *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-book-2-line text-muted"></i>
                                </span>
                                <select class="form-select border-0 bg-light py-2" id="moduleSelect" name="module" required>
                                    <option value="">Sélectionnez un module</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="typeExamenSelect" class="form-label fw-medium">Type examen *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-file-text-line text-muted"></i>
                                </span>
                                <select class="form-select border-0 bg-light py-2" id="typeExamenSelect" name="type_examen" required>
                                    <option value="">Sélectionnez un type</option>
                                    <option value="normal">Ordinaire</option>
                                    <option value="rachat">Rachat de crédit</option>
                                    <option value="rattrage">Rattrapage</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="modeExamenSelect" class="form-label fw-medium">Mode d'examen *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-settings-line text-muted"></i>
                                </span>
                                <select class="form-select border-0 bg-light py-2" id="modeExamenSelect" name="mode_examen" required>
                                    <option value="">Sélectionnez un mode</option>
                                    <option value="exam">Examen</option>
                                    <option value="tr">Travail à remettre</option>
                                    <option value="ligne">Examen en ligne</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="dateExamen" class="form-label fw-medium">Date *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-line text-muted"></i>
                                </span>
                                <input type="date" class="form-control border-0 bg-light py-2" id="dateExamen" name="date" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="salleSelect" class="form-label fw-medium">Salle *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-home-line text-muted"></i>
                                </span>
                                <select class="form-select border-0 bg-light py-2" id="salleSelect" name="salle" required>
                                    <option value="">Sélectionnez une salle</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="heureDebut" class="form-label fw-medium">Heure de début *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-time-line text-muted"></i>
                                </span>
                                <input type="time" class="form-control border-0 bg-light py-2" id="heureDebut" name="heure_debut" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="heureFin" class="form-label fw-medium">Heure de fin *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-time-line text-muted"></i>
                                </span>
                                <input type="time" class="form-control border-0 bg-light py-2" id="heureFin" name="heure_fin" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" id="examPlanForm" class="btn btn-success px-4 py-2">
                    <i class="ri-check-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for group planning -->
<div id="plannificationDesGroupeModal" class="modal fade" tabindex="-1" aria-labelledby="plannificationDesGroupeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-group-line text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-warning mb-1" id="plannificationDesGroupeModalLabel">
                            Plannification des groupes
                        </h5>
                        <p class="text-muted small mb-0">Planifiez les groupes pour cette session</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="p_groupes" class="form-label fw-medium">Nom du groupe</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-group-line text-muted"></i>
                                </span>
                                <select id='p_groupes' class='form-select border-0 bg-light py-2'>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="p_semestre" class="form-label fw-medium">Semestre</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-stack-line text-muted"></i>
                                </span>
                                <select id='p_semestre' class='form-select border-0 bg-light py-2'>
                                    <option value='1'>1</option>
                                    <option value='2'>2</option>
                                    <option value='3'>3</option>
                                    <option value='4'>4</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="p_date_debut" class="form-label fw-medium">Date de début</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-line text-muted"></i>
                                </span>
                                <input type="date" class="form-control border-0 bg-light py-2" id="p_date_debut" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="p_date_fin" class="form-label fw-medium">Date de fin</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-check-line text-muted"></i>
                                </span>
                                <input type="date" class="form-control border-0 bg-light py-2" id="p_date_fin" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button class="btn btn-primary px-4 py-2" id="confirmPlanNewEXam">
                    <i class="ri-check-line me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Delete Confirmation Modal -->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-delete-bin-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteModalLabel">
                            Supprimer le groupe
                        </h5>
                        <p class="text-muted small mb-0">Suppression du groupe sélectionné</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                            <i class="ri-error-warning-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer ce groupe ?</h5>
                    <p class="text-muted">
                        La suppression de ce groupe est définitive et ne pourra pas être annulée.
                    </p>
                    <input type="hidden" id="delete-group-id" value="">
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger px-4 py-2 delete-confirm-btn">
                    <i class="ri-delete-bin-line me-2"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for updating group session line -->
<div class="modal fade updateGroupModal" tabindex="-1" role="dialog" aria-labelledby="updateGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-edit-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="updateGroupModalLabel">
                            Modifier le groupe de la session
                        </h5>
                        <p class="text-muted small mb-0">Modification des informations du groupe de session</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                            <i class="ri-edit-line"></i>
                        </div>
                    </div>
                    <h4 class="text-primary mb-3">Modification du groupe de session</h4>
                    <p class="text-muted mb-4">
                        Veuillez remplir les informations ci-dessous pour modifier les détails du groupe de session.
                    </p>
                </div>
                <input type="hidden" id="update-group-id" value="">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="update_semestre" class="form-label fw-medium">Semestre *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-stack-line text-muted"></i>
                                </span>
                                <select id="update_semestre" class="form-select border-0 bg-light py-2" required>
                                    <option value="">Sélectionnez un semestre</option>
                                    <option value='1'>1</option>
                                    <option value='2'>2</option>
                                    <option value='3'>3</option>
                                    <option value='4'>4</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="update_date_debut" class="form-label fw-medium">Date de début *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-line text-muted"></i>
                                </span>
                                <input type="date" class="form-control border-0 bg-light py-2" id="update_date_debut" required />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="update_date_fin" class="form-label fw-medium">Date de fin *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-check-line text-muted"></i>
                                </span>
                                <input type="date" class="form-control border-0 bg-light py-2" id="update_date_fin" required />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-center w-100">
                    <button type="button" class="btn btn-light px-4 py-2 w-100" data-bs-dismiss="modal">
                        <i class="ri-close-line me-2"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-primary px-4 py-2 w-100 update-group-confirm-btn">
                        <i class="ri-check-line me-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Delete Confirmation Modal for Exam Planifications -->
<div class="modal fade deleteExamPlanModal" tabindex="-1" role="dialog" aria-labelledby="deleteExamPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-delete-bin-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteExamPlanModalLabel">
                            Supprimer la planification d'examen
                        </h5>
                        <p class="text-muted small mb-0">Suppression de la planification d'examen sélectionnée</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                            <i class="ri-error-warning-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer cette planification d'examen ?</h5>
                    <p class="text-muted">
                        Cette action supprimera la planification d'examen et tous les résultats associés.<br>
                        Cette suppression est définitive et ne pourra pas être annulée.
                    </p>
                    <input type="hidden" id="delete-exam-plan-id" value="">
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger px-4 py-2 delete-exam-plan-confirm-btn">
                    <i class="ri-delete-bin-line me-2"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for updating exam planification -->
<div id="updateExamPlanModal" class="modal fade" tabindex="-1" aria-labelledby="updateExamPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-edit-line text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-primary mb-1" id="updateExamPlanModalLabel">
                            Modifier la planification d'examen
                        </h5>
                        <p class="text-muted small mb-0">Modification des informations de l'examen</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-primary bg-opacity-10 text-primary display-5 rounded-circle">
                            <i class="ri-edit-line"></i>
                        </div>
                    </div>
                    <h4 class="text-primary mb-3">Modification de la planification d'examen</h4>
                    <div class="mb-3">
                        <h5 class="text-info mb-2">Module: <span id="update_module_display" class="fw-semibold"></span> | Type: <span id="update_type_examen_display" class="fw-semibold"></span></h5>
                    </div>
                    <p class="text-muted mb-4">
                        Veuillez remplir les informations ci-dessous pour modifier les détails de l'examen.
                    </p>
                </div>
                <input type="hidden" id="update_exam_plan_id" />
                <input type="hidden" id="update_module" />
                <div class="row g-5">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label for="update_mode_examen" class="form-label fw-medium">Mode d'examen *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-settings-line text-muted"></i>
                                </span>
                                <select class="form-select border-0 bg-light py-2" id="update_mode_examen" name="mode_examen" required>
                                    <option value="">Sélectionnez un mode</option>
                                    <option value="exam">Examen</option>
                                    <option value="tr">Travail à remettre</option>
                                    <option value="ligne">Examen en ligne</option>
                                    <option value="oral">Examen Oral</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label for="update_date_examen" class="form-label fw-medium">Date *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-calendar-line text-muted"></i>
                                </span>
                                <input type="date" class="form-control border-0 bg-light py-2" id="update_date_examen" name="date" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-5 mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label for="update_salle" class="form-label fw-medium">Salle *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-home-line text-muted"></i>
                                </span>
                                <select class="form-select border-0 bg-light py-2" id="update_salle" name="salle" required>
                                    <option value="">Sélectionnez une salle</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label for="update_heure_debut" class="form-label fw-medium">Heure de début *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-time-line text-muted"></i>
                                </span>
                                <input type="time" class="form-control border-0 bg-light py-2" id="update_heure_debut" name="heure_debut" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-5">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label for="update_heure_fin" class="form-label fw-medium">Heure de fin *</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light">
                                    <i class="ri-time-line text-muted"></i>
                                </span>
                                <input type="time" class="form-control border-0 bg-light py-2" id="update_heure_fin" name="heure_fin" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <div class="hstack gap-2 justify-content-center w-100">
                    <button type="button" class="btn btn-light px-4 py-2 w-100" data-bs-dismiss="modal">
                        <i class="ri-close-line me-2"></i>Annuler
                    </button>
                    <button type="button" id="confirmUpdateExamPlanBtn" class="btn btn-primary px-4 py-2 w-100">
                        <i class="ri-check-line me-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modernized Modal for exam validation confirmation -->
<div id="validateExamModal" class="modal fade" tabindex="-1" aria-labelledby="validateExamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-check-line text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-success mb-1" id="validateExamModalLabel">
                            Valider l'examen
                        </h5>
                        <p class="text-muted small mb-0">Confirmer l'exécution de l'examen</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-medium">Statut</label>
                        <select id="validate_statut_exam" class="form-select border-0 bg-light py-2">
                            <option value="">Selectionnez une option</option>
                            <option value="termine">Terminer</option>
                            <option value="nabouti">Non abouti</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-medium">Observations</label>
                        <textarea id="observation_exam" class="form-control border-0 bg-light" rows="4" placeholder="Entrez vos observations..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success px-4 py-2" id="confirmValidateExamBtn">
                    <i class="ri-check-line me-2"></i>Valider
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for closing exam session for a group -->
<div class="modal fade" id="closeSessionModal" tabindex="-1" aria-labelledby="closeSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                        <i class="ri-close-circle-line text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold text-danger mb-1" id="closeSessionModalLabel">
                            Clôturer la session d'examen
                        </h5>
                        <p class="text-muted small mb-0">Confirmer la clôture de la session</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="avatar-lg mx-auto mb-3">
                        <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
                            <i class="ri-close-circle-line"></i>
                        </div>
                    </div>
                    <h5 class="mb-3">Êtes-vous sûr de clôturer cette session ?</h5>
                    <p class="text-muted mb-4">
                        Cette action clôturera la session d'examen pour ce groupe.
                        Les PVs de délibération seront disponibles dans la section <strong>Résultats</strong>.
                    </p>
                    <div class="alert alert-warning mb-0">
                        <i class="ri-error-warning-line me-2"></i>
                        <strong>Attention :</strong> Cette action est irréversible.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light px-4 py-3">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
                    <i class="ri-close-line me-2"></i>Annuler
                </button>
                <button id="confirmCloseSessionBtn" class="btn btn-danger px-4 py-2">
                    <i class="ri-check-line me-2"></i>Confirmer la clôture
                </button>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function(){
        const id = "{{pk}}";
        
        function loadData() {
            $.ajax({
                url: "{% url 't_exam:ApiGetSessionDetails' %}",
                dataType: 'json',
                type: 'GET',
                data: { 'id': id }, // Assure-toi que la variable `id` est définie globalement ou passée en paramètre
                success: function(data) {
                    var row = "";

                    $.each(data.session, function(index, p){
                        $('#card-header-title').html(p.label);
                        $('#code_session').val(p.code);
                        $('#date_debut').val(p.date_debut.split('T')[0]);
                        $('#date_fin').val(p.date_fin.split('T')[0]);
                    });
        
                    if (data.session_lines.length > 0) {
                        $.each(data.session_lines, function(index, item) {
                            row += '<div class="col-lg-4 col-md-6 col-sm-12 mb-4">';
                            row += '    <div class="card border-0 shadow-sm h-100">';
                            row += '        <div class="card-body p-4">';
                            row += '            <div class="d-flex justify-content-between align-items-start mb-3">';
                            row += '                <div class="d-flex align-items-center">';
                            row += '                    <div class="avatar-sm me-3">';
                            row += '                        <div class="avatar-title bg-success bg-opacity-10 text-success rounded-circle fs-4">';
                            row += '                            <i class="ri-group-line"></i>';
                            row += '                        </div>';
                            row += '                    </div>';
                            row += '                    <div>';
                            row += '                        <h6 class="mb-1 fw-semibold">' + item.groupe__nom + '</h6>';
                            row += '                        <p class="text-muted mb-0 small">Groupe</p>';
                            row += '                    </div>';
                            row += '                </div>';
                            row += '                <div class="dropdown">';
                            row += '                    <button class="btn btn-soft-primary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">';
                            row += '                        <i class="ri-more-fill align-middle"></i>';
                            row += '                    </button>';
                            row += '                    <ul class="dropdown-menu dropdown-menu-end">';
                            row += '                        <li><button data-id='+item.id+' data-groupe-id='+item.groupe__id+' data-date-d='+item.date_debut+' data-date-f='+item.date_fin+' id="btnDetails" class="dropdown-item edit-item-btn"><i class="ri-eye-fill align-bottom me-2 text-muted"></i>Détails</button></li>';
                            row += '                        <li><button data-id='+item.id+' id="btnUpdate" class="dropdown-item edit-item-btn"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</button></li>';
                            row += '                        <li><button data-id='+item.id+' id="btnDelete" class="dropdown-item edit-item-btn"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer</button></li>';
                            row += '                        <li class="divider"></li>';
                            row += '                        <li><button data-id='+item.id+' id="btnClose" class="dropdown-item"><i class="ri-close-circle-line align-bottom me-2 text-muted"></i> Clôturé </button></li>';
                            row += '                    </ul>';
                            row += '                </div>';
                            row += '            </div>';
                            row += '            <div class="vstack gap-2">';
                            row += '                <div class="d-flex align-items-center">';
                            row += '                    <div class="flex-shrink-0 me-2 text-muted">';
                            row += '                        <i class="ri-calendar-line"></i>';
                            row += '                    </div>';
                            row += '                    <div class="flex-grow-1">';
                            row += '                        <p class="mb-0"><small>Date de début: <strong>' + item.date_debut + '</strong></small></p>';
                            row += '                    </div>';
                            row += '                </div>';
                            row += '                <div class="d-flex align-items-center">';
                            row += '                    <div class="flex-shrink-0 me-2 text-muted">';
                            row += '                        <i class="ri-calendar-check-line"></i>';
                            row += '                    </div>';
                            row += '                    <div class="flex-grow-1">';
                            row += '                        <p class="mb-0"><small>Date de fin: <strong>' + item.date_fin + '</strong></small></p>';
                            row += '                    </div>';
                            row += '                </div>';
                            row += '                <div class="d-flex align-items-center">';
                            row += '                    <div class="flex-shrink-0 me-2 text-muted">';
                            row += '                        <i class="ri-stack-line"></i>';
                            row += '                    </div>';
                            row += '                    <div class="flex-grow-1">';
                            row += '                        <p class="mb-0"><small>Semestre: <strong>' + item.semestre + '</strong></small></p>';
                            row += '                    </div>';
                            row += '                </div>';
                            row += '            </div>';
                            row += '            <div class="mt-3 pt-3 border-top">';
                            row += '                <div class="d-flex justify-content-between align-items-center">';
                            row += '                    <span class="text-muted small">Statut:</span>';
                            row += '                    <span class="badge ';

                            // Determine badge class and status display
                            var badgeClass = '';
                            var statusDisplay = '';
                            if (item.status === 'att') {
                                badgeClass = 'bg-warning';
                                statusDisplay = 'En attente';
                            } else if (item.status === 'clo') {
                                badgeClass = 'bg-success';
                                statusDisplay = 'Clôturé';
                            } else {
                                badgeClass = 'bg-secondary';
                                statusDisplay = item.status || 'N/A';
                            }

                            row += badgeClass + '">' + statusDisplay + '</span>';
                            row += '                </div>';
                            row += '            </div>';
                            row += '        </div>';
                            row += '    </div>';
                            row += '</div>';
                        });
                    } else {
                        row = '<div class="col-12"><div class="text-center py-5"><i class="ri-group-line display-4 text-muted"></i><h5 class="mt-3 text-muted">Aucun groupe disponible</h5><p class="text-muted">Aucune information de groupe disponible pour le moment</p></div></div>';
                    }

                    $('#SessionLineItem').html(row);
                },
                
            });
        }
        
        loadData();

       $(document).on('click', '#btnConfigureGroupes', function(){

            $.ajax({
                url : "{% url 't_groupe:ApiGetGroupeList' %}",
                dataType: "JSON",
                type: 'GET',
                success : function(data){
                    var options = "";
                    if (data.length > 0){

                        $.each(data, function(index, d){
                            options += "<option value="+d.id+">"+d.nom+"</option>";
                        });

                    }else{
                        options = "<option value='0'>Aucun groupe n'est disponible pour le moement</option> ";
                        $('#confirmPlanNewEXam').prop('disabled', true);
                    }   

                    $('#p_groupes').html(options);
                }
            })
        $('#plannificationDesGroupeModal').modal('show');
       });

       $(document).on('click', '#updateSessionBtn', function(){
          var u_label = $('#card-header-title').html();
          var u_code = $('#code_session').val();
          var u_date_debut = $('#date_debut').val();
          var u_date_fin   = $('#date_fin').val();

          $('#u_label').val(u_label);
          $('#u_code').val(u_code);
          $('#u_date_debut').val(u_date_debut);
          $('#u_date_fin').val(u_date_fin);

          $('#updateSessionModal').modal('show');
          
       });

       $(document).on('click', "#ConfirmUpdateBtn", function(){

        var updated_label = $('#u_label').val();
        var updated_code = $('#u_code').val();
        var updated_date_debut = $('#u_date_debut').val();
        var updated_date_fin = $('#u_date_fin').val();

        $.ajax({
            url : "{% url 't_exam:ApiUpdateSession' %}",
            dataType: 'JSON',
            type : 'POST',
            data : {
                'id' : id,
                'label' : updated_label,
                'code' : updated_code,
                'date_debut' : updated_date_debut,
                'date_fin' : updated_date_fin,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },

            success : function(response){
                if (response.status == "success"){
                    alertify.success(response.message);
                    loadData();
                    $('#updateSessionModal').modal('hide');
                }else{
                    alertify.error(response.message);
                }
            }
        });
       });

       const labelField = document.getElementById('u_label');
       $(document).on('input', "#u_label", function(){
            let currentLabel = $('#card-header-title').html();
            let newLabel = $(this).val();

            if (currentLabel !== newLabel) {
                $.ajax({
                    url: "{% url 't_exam:ApiCheckLabelDisponibility' %}",
                    dataType: 'JSON',
                    type: 'GET',
                    data: {
                        'newLabel': newLabel,
                    },
                    success: function (response) {
                        // Supprimer tout ancien message
                        let errorMsg = document.getElementById("error-msg");
                        if (errorMsg) errorMsg.remove();
        
                        if (response.status === "success") {
                            // Nom d'utilisateur déjà pris
                            labelField.classList.remove("is-valid");
                            labelField.classList.add("is-invalid");
        
                            let msg = document.createElement("div");
                            msg.id = "error-msg";
                            msg.className = "invalid-feedback";
                            msg.innerText = "Label de la session d'examen déjà présent dans la base de données. Veuillez en choisir un autre.";
                            labelField.parentNode.appendChild(msg);
                        } else {
                           

                            labelField.classList.remove("is-invalid");
                            labelField.classList.add("is-valid");
        
                            let msg = document.createElement("div");
                            msg.id = "error-msg";
                            msg.className = "valid-feedback";
                            msg.innerText = "Label disponible";
                            labelField.parentNode.appendChild(msg);
                        }
                    }
                });
            } else {
                // Réinitialiser les styles si égal à l'actuel
                labelField.classList.remove("is-invalid", "is-valid");
                let errorMsg = document.getElementById("error-msg");
                if (errorMsg) errorMsg.remove();
            }
       });

       $(document).on('click','#confirmPlanNewEXam',function(){
            var p_groupes = $('#p_groupes').val();
            var p_semestre = $('#p_semestre').val();
            var p_date_debut = $('#p_date_debut').val();
            var p_date_fin = $('#p_date_fin').val();

            $.ajax({
                url : "{% url 't_exam:ApiPlaneExam' %}",
                dataType: "JSON",
                type : 'POST',
                data : {
                    'groupe' : p_groupes,
                    'session' : id,
                    'semestre' : p_semestre,
                    'date_debut':p_date_debut ,
                    'date_fin' : p_date_fin,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success : function(response){
                    if(response.status == 'success'){
                        alertify.success(response.message);
                        loadData();
                    }else{
                        alertify.error(response.message);
                    }
                }
            });

       });

       $(document).on('click', '#btnDetails', function(){
           var id = $(this).data('id');
           const date_d_session = $(this).data('date-d');
           const date_f_session = $(this).data('date-f');

           var groupeId = $(this).data('groupe-id');

           $('#btnPlanifier').data('id_groupe',groupeId);
           $('#btnPlanifier').data('session_line_id',id);

           LoadExamPlannification(id);

           $('#plannificationDesExamens').data('id_session', id);
           $("#plannificationDesExamens").modal('show');
       });

       function LoadExamPlannification(id){
        $.ajax({
                url : "{% url 't_exam:ApiLoadDatasForPlanExam' %}",
                type : "GET",
                dataType : "JSON",
                data : {
                    'id' : id,
                },
                success: function(data){
                    var modulesRow = "";
                    var classRow = "";
                    $.each(data.modules, function(index, item){
                        modulesRow += "<option value="+item.id+">"+item.label+"</option>";
                    });
                    $.each(data.salles, function(index, item){
                        classRow += "<option value="+item.id+">"+item.nom+"</option>";
                    });
                    $.ajax({
                        url: "{% url 't_exam:get_exam_plans' %}",
                        type: "GET",
                        dataType: "JSON",
                        data: { 'id': id },
                        success: function (response) {
                            const tbody = $("#examPlanTableBody");
                            tbody.empty(); // Vider d'abord le tableau

                            if (response.status === "success" && response.planifications.length > 0) {
                              // Regrouper les planifications par type d'examen
                              const planificationsByType = {};
                              $.each(response.planifications, function (index, item) {
                                if (!planificationsByType[item.type_examen]) {
                                  planificationsByType[item.type_examen] = [];
                                }
                                planificationsByType[item.type_examen].push(item);
                              });

                              // Créer une section pour chaque type d'examen
                              $.each(planificationsByType, function (type_examen, items) {
                                // Ajouter un en-tête pour le type d'examen
                                tbody.append(`
                                  <tr class="table-info">
                                    <td colspan="6" class="fw-bold text-info">
                                      <i class="ri-file-text-line me-2"></i>${type_examen}
                                    </td>
                                  </tr>
                                `);

                                // Ajouter les lignes pour chaque planification de ce type
                                $.each(items, function (index, item) {
                                  // Determine button state based on validation status
                                  let validateButton;
                                  if (item.passed) { // Assuming the API returns a 'passed' field
                                    validateButton = `<button type="button" class="btn btn-info btn-sm result-btn" data-id="${item.id}" title="Résultats">
                                                        <i class="ri-file-text-line"></i>
                                                      </button>`;
                                  } else {
                                    validateButton = `<button type="button" class="btn btn-success btn-sm validate-exam-btn" data-id="${item.id}">
                                                        <i class="ri-checkbox-circle-line"></i>
                                                      </button>`;
                                  }

                                  if (item.statut === "termine" && item.passed == true) {
                                      deleteBTn = `<button disabled style='display: none !important;' type="button" class="btn btn-danger-modern btn-sm delete-exam-btn" data-id="${item.id}">
                                                      <i class="ri-delete-bin-line"></i>
                                                  </button>`;
                                  }else{
                                      deleteBTn = `<button type="button" class="btn btn-danger-modern btn-sm delete-exam-btn" data-id="${item.id}">
                                                      <i class="ri-delete-bin-line"></i>
                                                  </button>`;
                                  }

                                  // Check if exam date is empty and disable buttons accordingly
                                  const hasExamDate = item.date && item.date.trim() !== '';

                                  // Check if exam is validated (passed)
                                  const isExamPassed = item.passed === true;

                                  // Determine button states based on validation status
                                  const editBtnDisabled = isExamPassed ? 'disabled' : '';
                                  const printBtnDisabledFinal = !hasExamDate || isExamPassed ? 'disabled' : '';

                                  // Handle validate button (when not passed) or result button (when passed)
                                  let processedValidateButton = validateButton;
                                  if (!hasExamDate) {
                                    if (item.passed) {
                                      // For result button when no date
                                      processedValidateButton = processedValidateButton.replace('result-btn', 'result-btn" disabled');
                                    } else {
                                      // For validate button when no date
                                      processedValidateButton = processedValidateButton.replace('validate-exam-btn', 'validate-exam-btn" disabled');
                                    }
                                  }

                                  tbody.append(`
                                    <tr>
                                      <td><i class="ri-bookmark-3-line me-2"></i>${item.module_nom}</td>
                                      <td><i class="ri-calendar-schedule-line me-2"></i>${item.date || 'Non spécifiée'}</td>
                                      <td><i class="ri-timer-line me-2"></i>${item.heure_debut} - ${item.heure_fin}</td>
                                      <td>${item.type_examen}</td>
                                      <td><i class="ri-home-3-line me-2"></i>${item.salle_nom}</td>
                                      <td>
                                        <div class="d-flex gap-2">
                                          <button type="button" class="btn btn-primary-modern btn-sm edit-exam-btn" data-id="${item.id}" title="Modifier" ${editBtnDisabled}>
                                            <i class="ri-pencil-line"></i>
                                          </button>
                                          ${deleteBTn}
                                          <button type="button" class="btn btn-info-modern btn-sm print-exam-btn" data-id="${item.id}" ${printBtnDisabledFinal} title="Imprimer">
                                            <i class="ri-printer-line"></i>
                                          </button>
                                          <button type="button" class="btn btn-warning-modern btn-sm details-exam-btn" data-id="${item.id}" title="Détails">
                                            <i class="ri-information-line"></i>
                                          </button>
                                          ${processedValidateButton}
                                        </div>
                                      </td>
                                    </tr>
                                  `);
                                });
                              });

                            } else {
                              tbody.append(`
                                <tr>
                                  <td colspan="6" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center justify-content-center">
                                      <i class="ri-calendar-schedule-line display-4 text-muted mb-3"></i>
                                      <h5 class="text-muted mb-2">Aucune planification d'examen</h5>
                                      <p class="text-muted mb-0">Aucune planification d'examen disponible pour le moment</p>
                                    </div>
                                  </td>
                                </tr>
                              `);
                            }
                        }
                      });

                      // Update button states after table is populated
                      setTimeout(updateButtonStates, 50);
                }
           });
       }

       $(document).on('click', '#btnDelete', function(){
         var id = $(this).data('id');
         $('#delete-group-id').val(id);
         $('.deleteModal').modal('show');
       });

       // Event handler for confirm delete group button in modal
       $(document).on('click', '.delete-confirm-btn', function(){
           var groupId = $('#delete-group-id').val();

           $.ajax({
              url :"{% url 't_exam:ApiDeleteGroupeSessionLine' %}",
              type : 'GET',
              dataType: 'JSON',
              data : {'id' : groupId},
              success : function(response){
                  if (response.status == 'success'){
                      alertify.success(response.message);
                      loadData();
                      $('.deleteModal').modal('hide');
                  }
              },
              error: function(xhr, status, error){
                  alertify.error("Une erreur est survenue lors de la suppression du groupe.");
                  console.error(error);
                  $('.deleteModal').modal('hide');
              }
           });
       });

       // Event handler for btnUpdate - opens update modal
       $(document).on('click', '#btnUpdate', function(){
           var id = $(this).data('id');

           // Get the current data for this session line to populate the form
           $.ajax({
               url: "{% url 't_exam:ApiGetSessionLineDetails' %}",
               type: "GET",
               dataType: "JSON",
               data: {'id': id},
               success: function(response) {
                   if (response.status === "success") {
                       var data = response.data;
                       $('#update-group-id').val(data.id);
                       $('#update_semestre').val(data.semestre);
                       $('#update_date_debut').val(data.date_debut);
                       $('#update_date_fin').val(data.date_fin);

                       $('.updateGroupModal').modal('show');
                   } else {
                       alertify.error(response.message);
                   }
               },
               error: function(xhr, status, error) {
                   alertify.error("Une erreur est survenue lors de la récupération des données.");
                   console.error(error);
               }
           });
       });

       // Event handler for confirm update group button in modal
       $(document).on('click', '.update-group-confirm-btn', function(){
           var groupId = $('#update-group-id').val();
           var semestre = $('#update_semestre').val();
           var date_debut = $('#update_date_debut').val();
           var date_fin = $('#update_date_fin').val();

           $.ajax({
              url :"{% url 't_exam:ApiUpdateGroupeSessionLine' %}",
              type : 'POST',
              dataType: 'JSON',
              data : {
                  'id' : groupId,
                  'semestre': semestre,
                  'date_debut': date_debut,
                  'date_fin': date_fin,
                  'csrfmiddlewaretoken': '{{ csrf_token }}'
              },
              success : function(response){
                  if (response.status == 'success'){
                      alertify.success(response.message);
                      loadData();
                      $('.updateGroupModal').modal('hide');
                  } else {
                      alertify.error(response.message);
                  }
              },
              error: function(xhr, status, error){
                  alertify.error("Une erreur est survenue lors de la mise à jour du groupe.");
                  console.error(error);
                  $('.updateGroupModal').modal('hide');
              }
           });
       });

       $(document).on('submit', '#plan-exam-form', function(e){
            e.preventDefault(); // Empêche le rechargement de la page


            var form = $(this);
            var formData = form.serializeArray(); // array of objects {name, value}
            var data = {};
            formData.forEach(item => data[item.name] = item.value);
            data['session_id'] = "{{pk}}";
            data['csrfmiddlewaretoken'] = '{{ csrf_token }}';


            $.ajax({
                url: "{% url 't_exam:save_exam_plan' %}",
                type: "POST",
                data: data,
                success: function(response){
                    if(response.status === "success"){
                        
                        alertify.success("Planification enregistrée avec succès !");
                        
                    } else {
                        alertify.error("Erreur : " + response.message);
                    }
                },
                error: function(xhr, status, error){
                    alertify.error("Une erreur est survenue lors de l'enregistrement.");
                    console.error(error);
                }
            });
        });

       
        // Event handler for the Planifier button
        $(document).on('click', '#btnPlanifier', function(){
            // Load modules and rooms data for the form
            var session_line_id = $(this).data('session_line_id');
            var groupeId = $(this).data('id_groupe');

            $('#examPlanForm').data("session_line_id",session_line_id);

            
            LoadModules(groupeId);
            

            // Show the modal
            $('#addExamPlanModal').modal('show');
                
        
        });

        $(document).on('click', '#examPlanForm', function(){

            var session_line_id = $(this).data('session_line_id');
            var moduleSelect = $('#moduleSelect').val();
            var typeExamenSelect = $('#typeExamenSelect').val();
            var modeExamenSelect = $('#modeExamenSelect').val();
            var dateExamen = $('#dateExamen').val();
            var salleSelect = $('#salleSelect').val();
            var heureDebut = $('#heureDebut').val();
            var heureFin = $('#heureFin').val();


            $.ajax({
                url : "{% url 't_exam:ApiPlanExam' %}",
                dataType : "JSON",
                type : "POST",
                data : {
                    'moduleSelect' : moduleSelect,
                    'typeExamenSelect' : typeExamenSelect,
                    'modeExamenSelect' : modeExamenSelect,
                    'dateExamen' : dateExamen,
                    'salleSelect' : salleSelect,
                    'heureDebut' : heureDebut,
                    'heureFin' : heureFin,
                    'session_line_id' : session_line_id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success : function(response){
                    if (response.status === "success"){
                        alertify.success("Plannification effectuer avec succès");
                        LoadExamPlannification(session_line_id);
                    }else{
                        alertify.error(response.message);
                    }
                }
            });
        });


        // Function to handle mode examination changes
        function handleModeExamenChange() {
            var selectedMode = $('#modeExamenSelect').val();

            // Disable/enable fields based on mode
            if (selectedMode === 'tr' || selectedMode === 'ligne') {
                // Disable salle, heure_debut, and heure_fin for 'tr' and 'ligne' modes
                $('#salleSelect').prop('disabled', true);
                $('#heureDebut').prop('disabled', true);
                $('#heureFin').prop('disabled', true);

                // Clear values when disabled
                $('#salleSelect').val('');
                $('#heureDebut').val('');
                $('#heureFin').val('');
            } else {
                // Enable salle, heure_debut, and heure_fin for 'exam' mode
                $('#salleSelect').prop('disabled', false);
                $('#heureDebut').prop('disabled', false);
                $('#heureFin').prop('disabled', false);
            }
        }

        // Event listener for mode examination changes
        $(document).on('change', '#modeExamenSelect', function() {
            handleModeExamenChange();
        });

        function LoadModules(groupeId){
            $.ajax({
                url : "{% url 't_exam:ApiLoadDataToPlan' %}",
                dataType : "JSON",
                type : "GET",
                data : {
                    'id_groupe' : groupeId,
                },
                success : function(data){
                    var option="<option value=''>Veuillez sélectionner un module</option>";
                    $.each(data.modules, function(index, p){
                        option += "<option value="+p.id+">"+p.label+"</option>";
                    });
                    $('#moduleSelect').html(option);

                    var option1="<option value=''>Veuillez sélectionner une salle</option>";
                    $.each(data.salles, function(index, p){
                        option1 += "<option value="+p.code+">"+p.nom+"</option>";
                    });
                    $('#salleSelect').html(option1);
                }
            });
        }

        // Validation for time inputs
        $(document).on('change', '#heureDebut, #heureFin', function(){
            var heureDebut = $('#heureDebut').val();
            var heureFin = $('#heureFin').val();

            if(heureDebut && heureFin) {
                if(heureFin <= heureDebut) {
                    alertify.error("L'heure de fin doit être supérieure à l'heure de début.");
                    $('#heureFin').val(''); // Clear the end time field
                }
            }
        });

        $(document).on('click','.print-exam-btn', function(){
            var id = $(this).data('id');

            // Remove any existing modal content to prevent duplicates
            $('#showPvModal').remove();

            // Load the modal content via AJAX
            $.get("{% url 't_exam:ShowPvModal' pk=0 %}".replace('0', id), function(data) {
                // Add the new modal content to the body
                $('body').append(data);

                // Show the modal
                $('#showPvModal').modal('show');

                // Initialize any necessary JavaScript after modal is loaded
                // The JavaScript is included in the modal template itself
            }).fail(function() {
                alertify.error("Erreur lors du chargement du PV d'examen.");
            });
        });

        // Event handler for validate exam button - opens confirmation modal
        $(document).on('click', '.validate-exam-btn', function(){
            var examPlanId = $(this).data('id');
            $('#confirmValidateExamBtn').data('examPlanId',examPlanId);
            $('#validateExamModal').modal('show');
        });

        // Event handler for confirm validation button in modal
        $(document).on('click', '#confirmValidateExamBtn', function(){
            var examPlanId = $(this).data('examPlanId');
            var decision = $('#validate_statut_exam').val();
            var comment = $('#observation_exam').val();
            var id_session = $('#plannificationDesExamens').data('id_session');
            var validateButton = $(`.validate-exam-btn[data-id="${examPlanId}"]`);

            $.ajax({
                url: "{% url 't_exam:validate_exam' %}",
                type: "POST",
                data: {
                    'exam_plan_id': examPlanId,
                    'decision' : decision,
                    'comment' : comment,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response){
                    if(response.status === "success"){
                        alertify.success(response.message);
                        $('#validateExamModal').modal('hide');

                        LoadExamPlannification(id_session);

                    } else {
                        alertify.error(response.message);
                        $('#validateExamModal').modal('hide');
                    }
                },
                error: function(xhr, status, error){
                    alertify.error("Une erreur est survenue lors de la validation de l'examen.");
                    console.error(error);
                    $('#validateExamModal').modal('hide');
                }
            });
        });

        // Event handler for result button - opens modal for notes filling
        $(document).on('click', '.result-btn', function(){
            var examPlanId = $(this).data('id');

            // Remove any existing modal content to prevent duplicates
            $('#previewExamPvModal').remove();

            // Load the modal content via AJAX
            $.get("{% url 't_exam:GeneratePvModal' pk=0 %}".replace('0', examPlanId), function(data) {
                // Add the new modal content to the body
                $('body').append(data);

                // Show the modal
                $('#previewExamPvModal').modal('show');

                // Initialize any necessary JavaScript after modal is loaded
                // The JavaScript is included in the modal template itself
            }).fail(function() {
                alertify.error("Erreur lors du chargement du formulaire de résultats.");
            });
        });

        // Event handler for delete exam button - opens confirmation modal
        $(document).on('click', '.delete-exam-btn', function(){
            var examPlanId = $(this).data('id');
            $('#delete-exam-plan-id').val(examPlanId);
            $('.deleteExamPlanModal').modal('show');
        });

        // Event handler for edit exam button - opens update modal
        $(document).on('click', '.edit-exam-btn', function(){
            var examPlanId = $(this).data('id');

            // Get the current exam plan data to populate the form
            $.ajax({
                url: "{% url 't_exam:ApiGetExamPlanificationDetails' %}",
                type: "GET",
                data: {'id': examPlanId},
                dataType: "JSON",
                success: function(response) {
                    if(response.status === "success") {
                        var data = response.data;
                        $('#update_exam_plan_id').val(data.id);
                        $('#update_module').val(data.module_id);
                        $('#update_module_display').text(data.module_nom);
                        $('#update_type_examen_display').text(data.type_examen_label || data.type_examen);
                        $('#update_mode_examen').val(data.mode_examination);
                        $('#update_date_examen').val(data.date);
                        $('#update_salle').val(data.salle_id);
                        $('#update_heure_debut').val(data.heure_debut);
                        $('#update_heure_fin').val(data.heure_fin);

                        // Load rooms for the form (modules are not editable)
                        var groupeId = $('#btnPlanifier').data('id_groupe');
                        LoadRoomsForUpdate(groupeId);

                        $('#updateExamPlanModal').modal('show');
                    } else {
                        alertify.error(response.message);
                    }
                },
                error: function(xhr, status, error){
                    alertify.error("Une erreur est survenue lors de la récupération des données de la planification.");
                    console.error(error);
                }
            });
        });

        // Function to load rooms for update form (modules are not editable)
        function LoadRoomsForUpdate(groupeId){
            $.ajax({
                url : "{% url 't_exam:ApiLoadDataToPlan' %}",
                dataType : "JSON",
                type : "GET",
                data : {
                    'id_groupe' : groupeId,
                },
                success : function(data){
                    var option1="<option value=''>Veuillez sélectionner une salle</option>";
                    $.each(data.salles, function(index, p){
                        var selected = $('#update_salle').val() == p.id ? 'selected' : '';
                        option1 += "<option value="+p.id+" "+selected+">"+p.nom+"</option>";
                    });
                    $('#update_salle').html(option1);
                }
            });
        }

        // Function to handle mode examination changes in update modal
        function handleUpdateModeExamenChange() {
            var selectedMode = $('#update_mode_examen').val();

            // Disable/enable fields based on mode
            if (selectedMode === 'tr' || selectedMode === 'ligne') {
                // Disable salle, heure_debut, and heure_fin for 'tr' and 'ligne' modes
                $('#update_salle').prop('disabled', true);
                $('#update_heure_debut').prop('disabled', true);
                $('#update_heure_fin').prop('disabled', true);

                // Clear values when disabled
                $('#update_salle').val('');
                $('#update_heure_debut').val('');
                $('#update_heure_fin').val('');
            } else {
                // Enable salle, heure_debut, and heure_fin for 'exam' and other modes
                $('#update_salle').prop('disabled', false);
                $('#update_heure_debut').prop('disabled', false);
                $('#update_heure_fin').prop('disabled', false);
            }
        }

        // Event listener for mode examination changes in update modal
        $(document).on('change', '#update_mode_examen', function() {
            handleUpdateModeExamenChange();
        });

        // Initialize the field states when the update modal is shown
        $(document).on('shown.bs.modal', '#updateExamPlanModal', function() {
            handleUpdateModeExamenChange();
        });

        // Event handler for confirm update exam plan button in modal
        $(document).on('click', '#confirmUpdateExamPlanBtn', function(){
            var examPlanId = $('#update_exam_plan_id').val();
            var modeExamen = $('#update_mode_examen').val();
            var dateExamen = $('#update_date_examen').val();
            var salle = $('#update_salle').val();
            var heureDebut = $('#update_heure_debut').val();
            var heureFin = $('#update_heure_fin').val();

            $.ajax({
                url: "{% url 't_exam:ApiUpdateExamPlanification' %}",
                type: "POST",
                data: {
                    'exam_planification_id': examPlanId,
                    'mode_examen': modeExamen,
                    'date': dateExamen,
                    'salle': salle,
                    'heure_debut': heureDebut,
                    'heure_fin': heureFin,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === "success") {
                        alertify.success(response.message);
                        $('#updateExamPlanModal').modal('hide');

                        // Reload the exam planification table
                        var session_line_id = $('#btnPlanifier').data('session_line_id');
                        if(session_line_id) {
                            LoadExamPlannification(session_line_id);
                        }
                    } else {
                        alertify.error(response.message);
                    }
                },
                error: function(xhr, status, error){
                    alertify.error("Une erreur est survenue lors de la mise à jour de la planification.");
                    console.error(error);
                }
            });
        });

        // Event handler for confirm delete exam button in modal
        $(document).on('click', '.delete-exam-plan-confirm-btn', function(){
            var examPlanId = $('#delete-exam-plan-id').val();

            $.ajax({
                url: "{% url 't_exam:ApiDeleteExamPlanification' %}",
                type: "POST",
                data: {
                    'exam_planification_id': examPlanId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response){
                    if(response.status === "success"){
                        alertify.success(response.message);
                        $('.deleteExamPlanModal').modal('hide');

                        // Reload the exam planification table
                        var session_line_id = $('#btnPlanifier').data('session_line_id');
                        if(session_line_id) {
                            LoadExamPlannification(session_line_id);
                        }
                    } else {
                        alertify.error(response.message);
                        $('.deleteExamPlanModal').modal('hide');
                    }
                },
                error: function(xhr, status, error){
                    alertify.error("Une erreur est survenue lors de la suppression de la planification.");
                    console.error(error);
                    $('.deleteExamPlanModal').modal('hide');
                }
            });
        });

        // Function to update button states based on exam date
        function updateButtonStates() {
            $('#examPlanTableBody tr').each(function() {
                const $row = $(this);
                const dateCell = $row.find('td:eq(1)').text(); // Date is in the second column
                const hasDate = dateCell.trim() !== '' && dateCell.trim() !== 'Non spécifiée';

                const $printBtn = $row.find('.print-exam-btn');
                const $validateBtn = $row.find('.validate-exam-btn');
                const $resultBtn = $row.find('.result-btn');

                if (hasDate) {
                    $printBtn.prop('disabled', false);
                    $validateBtn.prop('disabled', false);
                    $resultBtn.prop('disabled', false);
                } else {
                    $printBtn.prop('disabled', true);
                    $validateBtn.prop('disabled', true);
                    $resultBtn.prop('disabled', true);
                }
            });
        }

        // Call updateButtonStates after loading exam planification data
        $(document).on('shown.bs.modal', '#plannificationDesExamens', function() {
            // Small delay to ensure the table is fully loaded
            setTimeout(updateButtonStates, 100);
        });

        // Also update button states after updating an exam plan
        $(document).on('click', '#confirmUpdateExamPlanBtn', function() {
            setTimeout(updateButtonStates, 100);
        });


        // Event handler for details exam button
        $(document).on('click', '.details-exam-btn', function(){
            var examPlanId = $(this).data('id');

            // Get the current exam plan data to show details
            $.ajax({
                url: "{% url 't_exam:ApiGetExamPlanificationDetails' %}",
                type: "GET",
                data: {'id': examPlanId},
                dataType: "JSON",
                success: function(response) {
                    if(response.status === "success") {
                        var data = response.data;

                        // Show details in an alert or modal
                        var detailsHtml = `
                            <div class="text-start">
                                <h6>Détails de l'examen</h6>
                                <p><strong>Module:</strong> ${data.module_nom}</p>
                                <p><strong>Type d'examen:</strong> ${data.type_examen_label || data.type_examen}</p>
                                <p><strong>Date:</strong> ${data.date || 'Non spécifiée'}</p>
                                <p><strong>Heure:</strong> ${data.heure_debut} - ${data.heure_fin}</p>
                                <p><strong>Salle:</strong> ${data.salle_nom}</p>
                                <p><strong>Mode:</strong> ${data.mode_examination}</p>
                            </div>
                        `;

                        // Show in a temporary modal or alert
                        alertify.alert("Détails de l'examen", detailsHtml);
                    } else {
                        alertify.error(response.message);
                    }
                },
                error: function(xhr, status, error){
                    alertify.error("Une erreur est survenue lors de la récupération des détails.");
                    console.error(error);
                }
            });
        });

    });

    // Handle the btnClose click event to show the close session modal
    $(document).on('click', '#btnClose', function() {
        const session_exam_line = $(this).data('id');
        $('#closeSessionModal').data('group-id', session_exam_line);
        $('#closeSessionModal').modal('show');
    });

    // Handle the confirm close session button
    $('#confirmCloseSessionBtn').on('click', function() {
        const session_exam_line = $('#closeSessionModal').data('group-id');
        
        $('#closeSessionModal').modal('hide');

        $.ajax({
            url : "{% url 't_exam:close_session_line' %}",
            dataType: "JSON",
            type : "GET",
            data : {
                "session_line" : session_exam_line,
            },
            success : function(response){
                if (response.status === "success"){
                    alertify.success(response.message);
                    $('#closeSessionModal').modal('show');
                    loadData();
                }else{
                    alertify.error(response.message);
                }
            }
        })
    });

</script>



{% endblock content %}
           



    