{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Examens - Résultats de délibération {% endblock title %}

{% block content %}
<style>
  .stats-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .session-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e9ecef;
  }
  .session-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  .status-badge {
    padding: 0.5em 1em;
    font-weight: 500;
    border-radius: 50px;
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  .dropdown-menu {
    z-index: 1060 !important;
  }
  
  .form-control:focus,
  .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
    border-color: #86b7fe !important;
  }
  
  .form-control, .form-select {
    transition: all 0.3s ease;
  }
  
  .form-control:hover,
  .form-select:hover {
    box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.1) !important;
  }
</style>

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card bg-gradient-to-r from-primary to-info border-0 rounded-3 shadow">
            <div class="card-body p-4">
              <div class="d-flex flex-column flex-md-row align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                    <i class="ri-file-list-line ri-2x text-primary"></i>
                  </div>
                  <div class="text-white">
                    <h4 class="mb-1">Résultats de délibération</h4>
                    <p class="mb-0 opacity-75 text-muted">Consultation des résultats par groupe</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <!-- Session Info Card -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm rounded-3">
            <div class="card-body p-4">
              <div class="row" id="sessionInfo">
                <div class="col-12">
                  <div class="d-flex flex-column align-items-center justify-content-center py-3">
                    <i class="bx bx-loader bx-spin bx-lg text-primary mb-2"></i>
                    <p class="text-muted mb-0">Chargement des informations de la session...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card border-0 shadow-sm rounded-3">
            <div class="card-header bg-gradient-to-r from-light to-white p-4 border-0 rounded-top-3">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <div class="d-flex align-items-center">
                  <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                    <i class="ri-filter-3-line text-primary fs-5"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-0 text-dark fw-semibold">Filtres avancés</h5>
                    <p class="text-muted mb-0 small">Affinez votre recherche</p>
                  </div>
                </div>

                <div class="ms-auto">
                  <div class="d-flex flex-wrap align-items-center gap-3">
                    <div class="position-relative">
                      <i class="ri-search-line position-absolute text-muted" style="left: 1rem; top: 50%; transform: translateY(-50%); z-index: 5;"></i>
                      <input type="text" class="form-control ps-5 rounded-2 border-0 shadow-sm bg-white" placeholder="Rechercher un groupe..." id="searchInput" style="min-width: 240px; padding-top: 0.75rem; padding-bottom: 0.75rem;">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body p-4">
              <div class="row" id="listItem">
                <div class="col-12">
                  <div class="d-flex flex-column align-items-center justify-content-center py-5">
                    <i class="bx bx-loader bx-spin bx-lg text-primary mb-3"></i>
                    <p class="text-muted mb-0">Chargement des résultats...</p>
                  </div>
                </div>
              </div>

              <!-- Pagination -->
              <nav aria-label="Résultats pagination" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- Pagination will be populated by JavaScript -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal for group deliberation results -->
<div class="modal fade" id="groupeDetailsModal" tabindex="-1" aria-labelledby="groupeDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="groupeDetailsModalLabel">Résultats de délibération</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center align-items-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary">Imprimer</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    let sessionExamLinesData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    
    // Get session ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = '{{pk}}';

    if (!sessionId) {
      $('#listItem').html("<div class='col-12'><div class='text-center py-5 text-danger'><i class='ri-error-warning-line me-2 ri-xl'></i><p>Session ID manquant</p></div></div>");
      return;
    }

    function renderSessionInfo(sessionData) {
      if (sessionData && sessionData.length > 0) {
        // Use the first item's session data since all items in the list belong to the same session
        const session = sessionData[0];
        let sessionInfoHtml = '';

        sessionInfoHtml += '<div class="d-flex flex-wrap justify-content-between align-items-center">';
        sessionInfoHtml += '  <div class="d-flex align-items-center mb-3 mb-md-0">';
        sessionInfoHtml += '    <div class="avatar-sm me-3">';
        sessionInfoHtml += '      <div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle fs-4">';
        sessionInfoHtml += '        <i class="ri-calendar-2-line"></i>';
        sessionInfoHtml += '      </div>';
        sessionInfoHtml += '    </div>';
        sessionInfoHtml += '    <div>';
        sessionInfoHtml += '      <h5 class="mb-1 fw-semibold">'+session.session_label+'</h5>';
        sessionInfoHtml += '      <p class="text-muted mb-0 small">'+session.session_code+'</p>';
        sessionInfoHtml += '    </div>';
        sessionInfoHtml += '  </div>';
        sessionInfoHtml += '  <div class="d-flex flex-wrap gap-3">';
        sessionInfoHtml += '    <div class="d-flex align-items-center">';
        sessionInfoHtml += '      <i class="ri-file-text-line text-muted me-2"></i>';
        sessionInfoHtml += '      <span class="text-muted small">Type: <strong>'+session.session_type+'</strong></span>';
        sessionInfoHtml += '    </div>';
        sessionInfoHtml += '    <div class="d-flex align-items-center">';
        sessionInfoHtml += '      <i class="ri-calendar-line text-muted me-2"></i>';
        sessionInfoHtml += '      <span class="text-muted small">Du <strong>'+(session.session_date_debut || 'N/A')+'</strong></span>';
        sessionInfoHtml += '    </div>';
        sessionInfoHtml += '    <div class="d-flex align-items-center">';
        sessionInfoHtml += '      <i class="ri-calendar-check-line text-muted me-2"></i>';
        sessionInfoHtml += '      <span class="text-muted small">Au <strong>'+(session.session_date_fin || 'N/A')+'</strong></span>';
        sessionInfoHtml += '    </div>';
        sessionInfoHtml += '    <div class="d-flex align-items-center">';
        sessionInfoHtml += '      <i class="ri-checkbox-circle-line text-muted me-2"></i>';
        sessionInfoHtml += '      <span class="text-muted small">Statut: <strong>'+session.session_status+'</strong></span>';
        sessionInfoHtml += '    </div>';
        sessionInfoHtml += '  </div>';
        sessionInfoHtml += '</div>';

        $('#sessionInfo').html(sessionInfoHtml);
      } else {
        $('#sessionInfo').html('<div class="text-center py-3"><i class="ri-error-warning-line text-danger ri-xl"></i><p class="text-muted">Aucune information de session disponible</p></div>');
      }
    }

    function renderTable(data) {
      let row = "";
      if (data.length > 0) {
        
        $.each(data, function(index, i) {
            var display="";
            if (!i.groupe_code){
                display = "hidden";
            }
          row += '<div class="col-xl-4 col-lg-6 col-md-12 mb-4">';
          row += '    <div class="card session-card h-100 border-0 shadow-sm">';
          row += '        <div class="card-body p-4">';
          row += '            <div class="d-flex justify-content-between align-items-start mb-3">';
          row += '                <div class="d-flex align-items-center">';
          row += '                    <div class="avatar-sm me-3">';
          row += '                        <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle fs-4">';
          row += '                            <i class="ri-group-line"></i>';
          row += '                        </div>';
          row += '                    </div>';
          row += '                    <div>';
          row += '                        <h6 class="mb-1 fw-semibold"><a href="javascript:void(0)" class="text-dark">'+i.groupe_label+'</a></h6>';
          row += '                        <p '+display+' class="text-muted mb-0 small">'+i.groupe_code+'</p>';
          row += '                    </div>';
          row += '                </div>';
          row += '                <div class="dropdown">';
          row += '                    <button class="btn btn-soft-primary btn-sm shadow-none" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">';
          row += '                        <i class="ri-more-2-fill"></i>';
          row += '                    </button>';
          row += '                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-3 p-2" style="min-width: 200px;">';
          row += '                        <li><a href="javascript:void(0)" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2"><i class="ri-eye-line text-info me-2"></i>Consulter</a></li>';
          row += '                        <li><a href="javascript:void(0)" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2"><i class="ri-printer-line text-warning me-2"></i>Imprimer</a></li>';
          row += '                    </ul>';
          row += '                </div>';
          row += '            </div>';
          row += '            <div class="vstack gap-2 mb-3">';
          row += '                <div class="d-flex align-items-center">';
          row += '                    <div class="flex-shrink-0 me-2 text-muted">';
          row += '                        <i class="ri-calendar-check-line"></i>';
          row += '                    </div>';
          row += '                    <div class="flex-grow-1">';
          row += '                        <p class="mb-0"><small>Date: <strong> du '+i.session_date_debut+' au '+i.session_date_fin+'</strong></small></p>';
          row += '                    </div>';
          row += '                </div>';
          row += '                <div class="d-flex align-items-center">';
          row += '                    <div class="flex-shrink-0 me-2 text-muted">';
          row += '                        <i class="ri-user-line"></i>';
          row += '                    </div>';
          row += '                    <div class="flex-grow-1">';
          row += '                        <p class="mb-0"><small>Type: <strong>'+i.groupe_type+'</strong></small></p>';
          row += '                    </div>';
          row += '                </div>';
          row += '                <div class="d-flex align-items-center">';
          row += '                    <div class="flex-shrink-0 me-2 text-muted">';
          row += '                        <i class="ri-calendar-line"></i>';
          row += '                    </div>';
          row += '                    <div class="flex-grow-1">';
          row += '                        <p class="mb-0"><small>Créé le: <strong>'+(i.date_creation ? formatDate(i.date_creation.split('T')[0]) : 'N/A')+'</strong></small></p>';
          row += '                    </div>';
          row += '                </div>';
          row += '            </div>';
          row += '            <div class="d-flex justify-content-between align-items-center">';
          row += '                <span class="status-badge bg-success-subtle text-success border border-success-subtle"><i class="ri-checkbox-circle-fill me-1"></i>Actif</span>';
          row += '                <a href="javascript:void(0)" class="btn btn-outline-primary btn-sm view-details" data-groupe-id="'+i.id+'">Voir détails</a>';
          row += '            </div>';
          row += '        </div>';
          row += '    </div>';
          row += '</div>';
        });
      } else {
        row = '<div class="col-12"><div class="text-center py-5"><i class="ri-group-line display-4 text-muted"></i><h5 class="mt-3 text-muted">Aucun résultat disponible</h5><p class="text-muted">Aucun groupe trouvé pour cette session</p></div></div>';
      }

      $('#listItem').html(row);
    }

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('fr-FR', options);
    }

    function loadSessionExamLines() {
      $.ajax({
        url : "{% url 't_exam:ApiLoadSessionExamLines' %}",
        type : 'GET',
        data: { session_id: sessionId },
        dataType : 'JSON',
        success : function(response) {
          if (response.status === 'success') {
            sessionExamLinesData = response.data;
            renderSessionInfo(response.data);
            renderTable(response.data);
            renderPagination();
          } else {
            $('#listItem').html("<div class='col-12'><div class='text-center py-5 text-danger'><i class='ri-error-warning-line me-2 ri-xl'></i><p>"+response.message+"</p></div></div>");
          }
        },
        error: function() {
          $('#listItem').html("<div class='col-12'><div class='text-center py-5 text-danger'><i class='ri-error-warning-line me-2 ri-xl'></i><p>Erreur de chargement des données</p></div></div>");
        }
      });
    }

    function renderPagination() {
      const totalPages = Math.ceil(sessionExamLinesData.length / itemsPerPage);
      let paginationHtml = '';

      if (totalPages <= 1) {
        $('#pagination').html('');
        return;
      }

      // Previous button
      paginationHtml += '<li class="page-item '+(currentPage === 1 ? 'disabled' : '')+'">';
      paginationHtml += '<a class="page-link" href="#" data-page="'+(currentPage-1)+'" aria-label="Previous">';
      paginationHtml += '<i class="ri-arrow-left-s-line"></i>';
      paginationHtml += '</a></li>';

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHtml += '<li class="page-item '+(i === currentPage ? 'active' : '')+'">';
        paginationHtml += '<a class="page-link" href="#" data-page="'+i+'">'+i+'</a>';
        paginationHtml += '</li>';
      }

      // Next button
      paginationHtml += '<li class="page-item '+(currentPage === totalPages ? 'disabled' : '')+'">';
      paginationHtml += '<a class="page-link" href="#" data-page="'+(currentPage+1)+'" aria-label="Next">';
      paginationHtml += '<i class="ri-arrow-right-s-line"></i>';
      paginationHtml += '</a></li>';

      $('#pagination').html(paginationHtml);
    }

    function filterSessionExamLines() {
      var searchTerm = $('#searchInput').val().toLowerCase();

      var filteredData = sessionExamLinesData.filter(item => {
        // Check search term
        var matchesSearch = searchTerm === '' ||
          item.groupe_code.toLowerCase().includes(searchTerm) ||
          item.groupe_label.toLowerCase().includes(searchTerm) ||
          item.groupe_type.toLowerCase().includes(searchTerm);

        return matchesSearch;
      });

      renderTable(filteredData);
    }

    // Load initial data
    loadSessionExamLines();

    // Search functionality
    $('#searchInput').on('input', function() {
      filterSessionExamLines();
    });

    // Pagination
    $(document).on('click', '#pagination .page-link', function(e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      if (!isNaN(page)) {
        currentPage = page;
        renderPagination();
      }
    });

    // Event listener for "Voir détails" buttons
    $(document).on('click', '.view-details', function() {
      const groupeId = $(this).data('groupe-id');

      // Show loading spinner in modal
      $('#groupeDetailsModal .modal-body').html(`
        <div class="d-flex justify-content-center align-items-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `);

      // Show the modal
      $('#groupeDetailsModal').modal('show');

      // Load the group results data via AJAX
      $.ajax({
        url: "{% url 't_exam:groupe_deliberation_results_view' pk=0 %}".replace('0', sessionId),
        type: 'GET',
        success: function(data) {
          // Replace modal body content with the loaded data
          $('#groupeDetailsModal .modal-body').html(data);
        },
        error: function(xhr, status, error) {
          console.error("Error loading group results:", error);
          $('#groupeDetailsModal .modal-body').html(`
            <div class="alert alert-danger text-center p-4">
              <i class="ri-error-warning-line ri-2x mb-3"></i>
              <h6>Erreur de chargement</h6>
              <p>Impossible de charger les résultats du groupe</p>
            </div>
          `);
        }
      });
    });

  });
</script>

{% endblock content %}