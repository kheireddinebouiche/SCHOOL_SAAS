{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Examens - Liste des groupes{% endblock title %}

{% block content %}
<style>
  .stats-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .groupe-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e9ecef;
  }
  .groupe-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  .status-badge {
    padding: 0.5em 1em;
    font-weight: 500;
    border-radius: 50px;
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  .dropdown-menu {
    z-index: 1060 !important;
  }

  /* Loader */
  .loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-gradient-to-r from-primary to-info rounded-3 shadow p-4 text-white">
            <div class="d-flex align-items-center">
              <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                <i class="ri-group-2-line"></i>
              </div>
              <div>
                <h4 class="mb-1">Liste des groupes</h4>
                <p class="mb-0 text-muted">Gestion des groupes d'examen</p>
              </div>
            </div>
            
          </div>
        </div>
      </div>
      <!-- end page title -->

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-primary-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Total groupes</p>
                  <h4 class="mb-0"><span id="totalGroups">0</span></h4>
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-primary rounded-circle text-white fs-4">
                    <i class="ri-team-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-success-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Actifs</p>
                  <h4 class="mb-0"><span id="activeGroups">0</span></h4>
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-success rounded-circle text-white fs-4">
                    <i class="ri-checkbox-circle-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-warning-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Inactifs</p>
                  <h4 class="mb-0"><span id="inactiveGroups">0</span></h4>
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-warning rounded-circle text-white fs-4">
                    <i class="ri-time-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-info-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Étudiants</p>
                  <h4 class="mb-0"><span id="totalStudents">0</span></h4>
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-info rounded-circle text-white fs-4">
                    <i class="ri-user-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card border-0 shadow-sm rounded-3">
            <div class="card-header bg-white p-4 border-bottom">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <div class="d-flex align-items-center">
                  <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                    <i class="ri-filter-line text-info"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-0 text-info">Filtres avancés</h5>
                    <p class="text-muted mb-0 small">Affinez votre recherche</p>
                  </div>
                </div>

                <div class="ms-auto">
                  <div class="d-flex flex-wrap align-items-center gap-3">
                    <div class="d-flex gap-2">
                      <select id="promoFilter" class="form-select rounded-pill" style="min-width: 180px;">
                        <option value="">Toutes les années scolaires</option>
                        <!-- Les options seront ajoutées dynamiquement -->
                      </select>

                      <select id="statusFilter" class="form-select rounded-pill" style="min-width: 160px;">
                        <option value="">Tous les statuts</option>
                        <option value="active">Actifs</option>
                        <option value="inactive">Inactifs</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body p-0">
              <div id="loadingSpinner" class="loader"></div>

              <div id="groupsContainer" style="display: none;">
                <div class="row g-4 p-4" id="groupsGrid">
                  <!-- Les cartes de groupes seront ajoutées dynamiquement ici -->
                </div>

                <!-- Message when no results after filtering -->
                <div id="noResultsMessage" class="text-center py-5" style="display: none;">
                  <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                    <i class="ri-search-off-line text-muted fs-1"></i>
                  </div>
                  <h5 class="mb-2">Aucun groupe trouvé</h5>
                  <p class="text-muted mb-4">Aucun groupe ne correspond aux filtres sélectionnés</p>
                  <button class="btn btn-outline-primary reset-filters-btn">
                    <i class="ri-refresh-line me-1"></i> Réinitialiser les filtres
                  </button>
                </div>
              </div>

              <div id="noDataMessage" class="text-center py-5" style="display: none;">
                <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                  <i class="ri-team-line text-muted fs-1"></i>
                </div>
                <h5 class="mb-2">Aucun groupe trouvé</h5>
                <p class="text-muted mb-4">Il n'y a aucun groupe enregistré pour le moment</p>
                <a href="#" class="btn btn-primary">
                  <i class="ri-add-line me-1"></i> Créer un groupe
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>




<script>
  $(document).ready(function(){
    // Charger les données depuis l'API
    loadGroupsData();

    // Fonction pour charger les données depuis l'API
    function loadGroupsData() {
      $.ajax({
        url: '{% url "t_exam:ApiListeDesGroupes" %}', // Assurez-vous que cette URL est correcte
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          displayGroupsData(data);
        },
        error: function(xhr, status, error) {
          console.error('Erreur lors du chargement des données:', error);
          $('#loadingSpinner').hide();
          $('#noDataMessage').show();
        }
      });
    }

    // Fonction pour afficher les données des groupes
    function displayGroupsData(data) {
      // Vérifier si les données sont un tableau (comme indiqué dans l'exemple)
      if (!Array.isArray(data)) {
        console.error('Les données reçues ne sont pas un tableau:', data);
        $('#loadingSpinner').hide();
        $('#noDataMessage').show();
        return;
      }

      // Renommer la variable pour correspondre à la structure réelle
      const groups = data;

      // Mettre à jour les statistiques
      $('#totalGroups').text(groups.length);

      // Pour l'instant, tous les groupes sont considérés comme actifs
      // (puisque la structure de données ne contient pas d'information sur le statut)
      $('#activeGroups').text(groups.length);
      $('#inactiveGroups').text(0);

      // Pour l'instant, on ne peut pas calculer le nombre total d'étudiants
      // car cette information n'est pas présente dans la structure de données
      

      // Remplir le filtre de promotion
      const promoSelect = $('#promoFilter');
      promoSelect.empty();
      promoSelect.append('<option value="">Toutes les promotions</option>');

      // Extraire les années scolaires uniques
      const anneesScolaires = {};
      groups.forEach(group => {
        if (group.anness_scolaire) {
          anneesScolaires[group.anness_scolaire] = group.anness_scolaire;
        }
      });

      // Ajouter les options d'année scolaire
      Object.keys(anneesScolaires).forEach(annee => {
        promoSelect.append(`<option value="${anneesScolaires[annee]}">${anneesScolaires[annee]}</option>`);
      });

      // Afficher les cartes de groupes
      const groupsGrid = $('#groupsGrid');
      groupsGrid.empty();

      if (groups.length > 0) {
        groups.forEach((group, index) => {
          // Utiliser l'index comme ID temporaire puisque l'API ne fournit pas d'ID
          const groupId = index + 1;
          const groupName = group.nom || 'Nom non disponible';
          const groupCode = group.code || 'N/A';
          const createdAt = group.created_at || '';
          const anneeScolaire = group.anness_scolaire || 'N/A';
          const nombreEtudiant = group.nb_etudiants || 'N/A';
          const groupeId = group.id;

          const cardHtml = `
            <div class="col-xl-6 col-md-12 groupe-card-container" data-annee-scolaire="${anneeScolaire}" data-status="active">
              <div class="card groupe-card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                      <h5 class="card-title mb-1 text-truncate" title="${groupName}">
                        <a href="#" class="text-decoration-none text-dark">
                          ${groupName}
                        </a>
                      </h5>
                      <p class="text-muted mb-0">
                        <small>Code: ${groupCode}</small>
                      </p>
                    </div>

                    
                  </div>

                  <div class="row g-2 mb-3">
                    <div class="col-md-6">
                      <div class="d-flex align-items-center">
                        <i class="ri-graduation-cap-line text-info me-2"></i>
                        <span class="text-muted">
                          <span class="fw-semibold">${anneeScolaire}</span>
                        </span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="d-flex align-items-center">
                        <i class="ri-calendar-line text-info me-2"></i>
                        <span class="text-muted">
                          ${createdAt ? formatDate(createdAt) : '--'}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="row g-2 mb-3">
                    <div class="col-sm-4">
                      <div class="d-flex align-items-center">
                        <i class="ri-user-line text-primary me-2"></i>
                        <span class="text-muted">${nombreEtudiant}</span>
                      </div>
                    </div>
                    <div class="col-sm-4">
                      <div class="d-flex align-items-center">
                        <i class="ri-file-text-line text-success me-2"></i>
                        <span class="text-muted">N/A bulletins</span>
                      </div>
                    </div>
                    <div class="col-sm-4">
                      <div class="d-flex align-items-center">
                        <i class="ri-team-line text-warning me-2"></i>
                        <span class="text-muted">${groupCode}</span>
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <span class="status-badge bg-success-subtle text-success border border-success-subtle">
                        <i class="ri-checkbox-circle-fill me-1"></i> Actif
                      </span>
                    </div>

                    <a href="#" id='detailsBtn' data-id=${groupeId} class="btn btn-outline-primary btn-sm">
                      <i class="ri-eye-line me-1"></i> Détails
                    </a>
                  </div>
                </div>
              </div>
            </div>
          `;

          groupsGrid.append(cardHtml);
        });

        $('#loadingSpinner').hide();
        $('#groupsContainer').show();
      } else {
        $('#loadingSpinner').hide();
        $('#noDataMessage').show();
      }

      // Réinitialiser les filtres
      applyFilters();
    }

    // Fonction pour formater la date
    function formatDate(dateString) {
      const options = { day: '2-digit', month: 'short', year: 'numeric' };
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', options);
    }

    // Fonction pour filtrer les cartes de groupes
    function applyFilters() {
      var anneeScolaireFilter = $('#promoFilter').val();
      var statusFilter = $('#statusFilter').val();

      var visibleCount = 0;

      $('.groupe-card-container').each(function() {
        var $container = $(this);
        var containerAnneeScolaire = $container.data('annee-scolaire');
        var containerStatus = $container.data('status');

        var matchesAnneeScolaire = anneeScolaireFilter === '' || containerAnneeScolaire === anneeScolaireFilter;
        var matchesStatus = statusFilter === '' || containerStatus === statusFilter;

        if (matchesAnneeScolaire && matchesStatus) {
          $container.show();
          visibleCount++;
        } else {
          $container.hide();
        }
      });

      // Show/hide the "no results" message
      if (visibleCount === 0 && ($('.groupe-card-container').length > 0)) {
        $('#noResultsMessage').show();
      } else {
        $('#noResultsMessage').hide();
      }
    }

    // Écouter les changements dans les filtres
    $('#promoFilter, #statusFilter').on('change', function() {
      applyFilters();
    });

    // Bouton pour réinitialiser les filtres
    $('.reset-filters-btn').on('click', function() {
      $('#promoFilter').val('');
      $('#statusFilter').val('');
      applyFilters();
    });

    // Gestion des boutons d'activation
    $(document).on('click', '.activate-groupe-btn', function() {
      var groupeId = $(this).data('groupe-id');
      $('#groupeToActivate').val(groupeId);
      $('#activateGroupeModal').modal('show');
    });

    // Confirmer l'activation
    $('#confirmActivateGroupeBtn').on('click', function() {
      var groupeId = $('#groupeToActivate').val();
      // Ici, vous pouvez ajouter la logique pour activer le groupe via AJAX
      // Pour l'instant, on ferme simplement le modal
      $('#activateGroupeModal').modal('hide');
      // Rafraîchir la page ou mettre à jour l'affichage
      location.reload();
    });

    // Gestion des boutons de suppression
    $(document).on('click', '.delete-groupe-btn', function() {
      var groupeId = $(this).data('groupe-id');
      var groupeLabel = $(this).data('groupe-label');
      $('#groupeToDelete').val(groupeId);
      $('#groupeToDeleteLabel').text(groupeLabel);
      $('#deleteGroupeModal').modal('show');
    });

    // Confirmer la suppression
    $('#confirmDeleteGroupeBtn').on('click', function() {
      var groupeId = $('#groupeToDelete').val();
      // Ici, vous pouvez ajouter la logique pour supprimer le groupe via AJAX
      // Pour l'instant, on ferme simplement le modal
      $('#deleteGroupeModal').modal('hide');
      // Rafraîchir la page ou mettre à jour l'affichage
      location.reload();
    });
  
    $(document).on('click','#detailsBtn', function(){
      var groupId = $(this).data('id');

      // Get the group name from the card to update the modal title
      var card = $(this).closest('.groupe-card');
      var groupName = card.find('.card-title a').text().trim();

      // Update the modal title with the group name
      $('#detailsModalLabel').text('Sessions d\'examens - ' + groupName);

      // Clear previous session data
      $('#sessionTableBody').html('<tr><td colspan="5" class="text-center text-muted py-3">Chargement des sessions...</td></tr>');

      // Fetch session data for this group
      $.ajax({
        url: '{% url "t_exam:ApiListeGroupeSession" %}',
        type: 'GET',
        data: {
          'id': groupId
        },
        dataType: 'json',
        success: function(response) {
          if (response.status === 'error') {
            $('#sessionTableBody').html('<tr><td colspan="5" class="text-center text-danger py-3">' + response.message + '</td></tr>');
          } else if (response.length === 0) {
            $('#sessionTableBody').html('<tr><td colspan="5" class="text-center text-muted py-3">Aucune session d\'examen trouvée pour ce groupe</td></tr>');
          } else {
            var sessionRows = '';
            response.forEach(function(session) {
              var startDate = session.date_debut ? formatDate(session.date_debut) : 'N/A';
              var endDate = session.date_fin ? formatDate(session.date_fin) : 'N/A';
              var createdAt = session.created_at ? formatDate(session.created_at) : 'N/A';

              sessionRows += '<tr>' +
                               '<td>' + (session.semestre || 'N/A') + '</td>' +
                               '<td>' + startDate + '</td>' +
                               '<td>' + endDate + '</td>' +
                               '<td>' + createdAt + '</td>' +
                               '<td><a href="/examens/builltins/resultats/etudiants/' + session.id + '/" target="_blank" class="btn btn-outline-primary btn-sm"><i class="ri-eye-line me-1"></i>Détails</a></td>' +
                             '</tr>';
            });
            $('#sessionTableBody').html(sessionRows);
          }
        },
        error: function(xhr, status, error) {
          console.error('Erreur lors du chargement des sessions:', error);
          $('#sessionTableBody').html('<tr><td colspan="5" class="text-center text-danger py-3">Erreur lors du chargement des sessions</td></tr>');
        }
      });

      // Show the modal
      $('#detailsModal').modal('show');
    });



  });
</script>

<!-- Modal for displaying group details -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
        <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
          <i class="ri-table-line text-info fs-4"></i>
        </div>
        <div>
          <h5 class="modal-title fw-semibold text-info mb-1" id="detailsModalLabel">Sessions d'examens</h5>
          <small class="text-muted">Liste des sessions pour ce groupe</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row">
          <div class="col-md-12">
            <div class="table-responsive">
              <table class="table table-hover table-nowrap align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Semestre</th>
                    <th scope="col">Date de début</th>
                    <th scope="col">Date de fin</th>
                    <th scope="col">Date de création</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody id="sessionTableBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted py-3">Aucune session d'examen trouvée</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3 justify-content-between">
        <div>
          <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
            Fermer
          </button>
        </div>
        <div>
          <button type="button" class="btn btn-outline-primary px-4 py-2 me-2">
            <i class="ri-edit-line me-1"></i>Modifier
          </button>
          <button type="button" class="btn btn-primary px-4 py-2">
            <i class="ri-download-line me-1"></i>Exporter
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}