{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Examens - Liste des étudiants{% endblock title %}

{% block content %}
<style>
  :root {
    --primary-soft: #eef2f7;
    --primary-text: #3b82f6; 
  }
  .page-content { padding-top: 1.5rem; }
  
  /* Modern Card Styles */
  .stat-card {
    transition: all 0.2s ease;
    border: 1px solid #f1f5f9;
    background: #fff;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); /* Soft shadow */
    border-color: #e2e8f0;
  }
  .stat-icon-box {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    font-size: 1.25rem;
  }
  
  /* Table Styles */
  .custom-table-card {
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
  }
  .table thead th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    color: #64748b;
    background-color: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    padding-top: 1rem;
    padding-bottom: 1rem;
  }
  .table tbody td {
    padding-top: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
  }
  .student-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    color: white;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2);
  }
  
  /* Search Input */
  .search-box .form-control {
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    padding-left: 2.5rem;
    transition: all 0.2s;
  }
  .search-box .form-control:focus {
    background-color: #fff;
    border-color: #818cf8;
    box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
  }
  .search-box i {
    color: #94a3b8;
  }
  
  /* Buttons */
  .btn-action-soft {
    background-color: #f1f5f9;
    color: #475569;
    border: none;
    transition: all 0.2s;
  }
  .btn-action-soft:hover {
    background-color: #e2e8f0;
    color: #1e293b;
  }
</style>

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      
      <!-- Minimalist Header -->
      <div class="row mb-4 align-items-center">
        <div class="col-12 col-md-6">
            <h4 class="mb-1 text-dark fw-bold">Liste des étudiants</h4>
            <div class="d-flex align-items-center text-muted small">
                <span><i class="ri-home-4-line me-1"></i> Examens</span>
                <i class="ri-arrow-right-s-line mx-2"></i>
                <span class="text-dark fw-medium">{{ groupe.nom }}</span>
            </div>
        </div>
        <div class="col-12 col-md-6 text-md-end mt-3 mt-md-0">
             <span class="badge bg-white text-muted border px-3 py-2 rounded-pill shadow-sm">
                <i class="ri-calendar-event-line me-1 text-primary"></i> {{ session_exam_line.session.label }}
             </span>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="row g-3 mb-4">
        <!-- Card 1: Total Students -->
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card h-100 border-0 rounded-4">
            <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="stat-icon-box bg-primary bg-opacity-10 text-primary me-3">
                        <i class="ri-user-line"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-0">Total Inscrits</h6>
                        <h3 class="mb-0 fw-bold text-dark">{{ student_data|length }}</h3>
                    </div>
                </div>
                <div class="text-end">
                    <span class="badge bg-success-subtle text-success rounded-pill px-2 py-1">
                        <i class="ri-check-line me-1"></i>Confirmés
                    </span>
                </div>
            </div>
          </div>
        </div>

        <!-- Card 2: Groupe Info -->
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card h-100 border-0 rounded-4">
             <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="stat-icon-box bg-info bg-opacity-10 text-info me-3">
                        <i class="ri-team-line"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-0">Groupe</h6>
                        <h4 class="mb-0 fw-bold text-dark text-truncate">{{ groupe.nom }}</h4>
                    </div>
                </div>
                <div class="text-end">
                    <span class="badge bg-info-subtle text-info rounded-pill px-2 py-1">Code: {{ groupe.code|default:'N/A' }}</span>
                </div>
            </div>
          </div>
        </div>

        <!-- Card 3: Session Info -->
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card h-100 border-0 rounded-4">
             <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="stat-icon-box bg-warning bg-opacity-10 text-warning me-3">
                        <i class="ri-bookmark-3-line"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-0">Semestre</h6>
                        <h4 class="mb-0 fw-bold text-dark">{{ session_exam_line.semestre }}<span class="fs-6 text-muted">ème</span></h4>
                    </div>
                </div>
                 <div class="text-end">
                    <span class="text-muted small">Année scolaire en cours</span>
                </div>
            </div>
          </div>
        </div>

        <!-- Card 4: Date Info -->
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card h-100 border-0 rounded-4">
             <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="stat-icon-box bg-secondary bg-opacity-10 text-secondary me-3">
                        <i class="ri-calendar-check-line"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-0">Période</h6>
                        <h5 class="mb-0 fw-bold text-dark">{{ session_exam_line.date_debut|date:"d M" }} - {{ session_exam_line.date_fin|date:"d M" }}</h5>
                    </div>
                </div>
                 <div class="text-end">
                    <span class="badge bg-secondary-subtle text-secondary rounded-pill px-2 py-1">{{ session_exam_line.date_debut|date:"Y" }}</span>
                </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Students List Card -->
      <div class="card custom-table-card border-0 rounded-4 overflow-hidden bg-white">
        <!-- Card Header -->
        <div class="card-header bg-white border-bottom p-4">
            <div class="row align-items-center g-3">
                <div class="col-md-4">
                    <h5 class="card-title mb-0 fw-bold">Annuaire des Étudiants</h5>
                    <p class="text-muted small mb-0 mt-1">Gérez et consultez les bulletins scolaires.</p>
                </div>
                <!-- Search & Actions -->
                <div class="col-md-8">
                    <div class="d-flex align-items-center justify-content-md-end gap-3 flex-wrap">
                        <div class="search-box position-relative flex-grow-1" style="max-width: 320px;">
                            <input type="text" id="studentSearch" class="form-control rounded-pill ps-5" placeholder="Rechercher nom, matricule...">
                            <i class="ri-search-line position-absolute top-50 start-0 translate-middle-y ms-3 fs-5"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-white border shadow-sm dropdown-toggle rounded-pill px-3" type="button" id="exportMenu" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="ri-download-cloud-2-line me-1 text-primary"></i> Exporter
                            </button>
                            <ul class="dropdown-menu border-0 shadow-lg dropdown-menu-end" aria-labelledby="exportMenu">
                                <li><a class="dropdown-item py-2" href="#"><i class="ri-file-pdf-fill me-2 text-danger"></i> Format PDF</a></li>
                                <li><a class="dropdown-item py-2" href="#"><i class="ri-file-excel-fill me-2 text-success"></i> Format Excel</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Body (Table) -->
        <div class="card-body p-0">
            {% if student_data %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col" class="ps-4">Étudiant</th>
                            <th scope="col">Contact</th>
                            <th scope="col">Détails</th>
                            <th scope="col">Inscription</th>
                            <th scope="col" class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        {% for item in student_data %}
                        {% with student=item.student %}
                        <tr>
                            <!-- Student Name & Avatar -->
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="student-avatar me-3">
                                        {{ student.nom.0|upper }}
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold text-dark">{{ student.nom }} {{ student.prenom }}</h6>
                                        <span class="small text-muted">Matricule: <span class="font-monospace text-dark">{{ student.matricule_interne|default:"-" }}</span></span>
                                    </div>
                                </div>
                            </td>
                            <!-- Contact -->
                            <td>
                                <div class="d-flex flex-column">
                                    {% if student.email %}
                                        <span class="mb-1 text-truncate" style="max-width: 200px;"><i class="ri-mail-line me-1 text-muted"></i> {{ student.email }}</span>
                                    {% endif %}
                                    <span class="text-muted small"><i class="ri-phone-line me-1"></i> {{ student.telephone|default:"-" }}</span>
                                </div>
                            </td>
                             <!-- Other Details -->
                            <td>
                                <!-- Placeholder for other relevant data, keeping consistent layout -->
                                <span class="badge bg-light text-dark border">Étudiant Régulier</span>
                            </td>
                            <!-- Inscription Date -->
                            <td>
                                <span class="text-muted small fw-medium">{{ item.date_inscription|date:"d M, Y" }}</span>
                            </td>
                            <!-- Actions -->
                            <td class="text-end pe-4">
                                <button type="button" class="btn btn-action-soft btn-sm rounded-pill px-3 view-bulletin-btn" 
                                    data-url="{% url 't_exam:student_bulletin' session_exam_line.id student.id %}" 
                                    data-bs-toggle="tooltip" title="Voir le bulletin">
                                    <i class="ri-file-list-3-line me-1"></i> Bulletin
                                </button>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="mb-3">
                    <div class="avatar-lg bg-light rounded-circle mx-auto d-flex align-items-center justify-content-center">
                        <i class="ri-user-search-line display-5 text-muted opacity-50"></i>
                    </div>
                </div>
                <h5 class="fw-bold text-dark">Aucun résultat</h5>
                <p class="text-muted">Aucun étudiant n'est inscrit dans ce groupe pour cette session.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Pagination (Optional - static for now based on previous code) -->
        {% if student_data %}
        <div class="card-footer bg-white border-top p-3">
            <div class="d-flex justify-content-between align-items-center">
                <p class="text-muted small mb-0">
                    Affichage de <strong>{{ student_data|length }}</strong> étudiants
                </p>
                <!-- Retaining simple nav structure, can be enhanced with backend pagination -->
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled"><a class="page-link border-0 bg-transparent" href="#"><i class="ri-arrow-left-s-line"></i></a></li>
                        <li class="page-item active"><a class="page-link border rounded-circle bg-primary text-white mx-1" href="#" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">1</a></li>
                        <li class="page-item disabled"><a class="page-link border-0 bg-transparent" href="#"><i class="ri-arrow-right-s-line"></i></a></li>
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<script>
  // Bulletin Modal functionality
  $(document).ready(function() {
    $('.view-bulletin-btn').on('click', function() {
      var url = $(this).data('url');
      var modal = $('#bulletinModal');
      var modalBody = modal.find('.modal-body');
      
      // Show loading state
      modalBody.html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div><p class="mt-2 text-muted">Chargement du bulletin...</p></div>');
      
      // Show modal
      modal.modal('show');
      
      // Fetch content
      $.ajax({
        url: url,
        type: 'GET',
        success: function(response) {
          // Replace the entire modal content
          modal.find('.modal-content').html(response);
          // Re-initialize modal events/styles if necessary
        },
        error: function() {
          modalBody.html('<div class="alert alert-danger"><i class="ri-error-warning-line me-2"></i>Erreur lors du chargement du bulletin.</div>');
        }
      });
    });
  });

  // Search functionality
  document.getElementById('studentSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#studentTableBody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
</script>

<!-- Bulletin Modal -->
<div class="modal fade" id="bulletinModal" tabindex="-1" aria-labelledby="bulletinModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header border-0 bg-light py-3">
        <h5 class="modal-title d-flex align-items-center" id="bulletinModalLabel">
          <i class="ri-file-list-3-line text-primary me-2"></i>Aperçu du bulletin
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 bg-light">
        <!-- Content will be loaded here -->
      </div>
      <div class="modal-footer border-top-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary" onclick="window.print()">
          <i class="ri-printer-line me-1"></i>Imprimer
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}