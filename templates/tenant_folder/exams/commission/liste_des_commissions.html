{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %}Examens - Liste des commissions{% endblock title %}

{% block content %}
<style>
  .stats-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .commission-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e9ecef;
  }
  .commission-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  .status-badge {
    padding: 0.5em 1em;
    font-weight: 500;
    border-radius: 50px;
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }
  .dropdown-menu {
    z-index: 1060 !important;
  }
</style>

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-gradient-to-r from-primary to-info rounded-3 shadow p-4 text-white">
            <div class="d-flex align-items-center">
              <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                <i class="ri-group-line ri-2x"></i>
              </div>
              <div>
                <h4 class="mb-1">Liste des commissions</h4>
                <p class="mb-0 opacity-75">Gestion des commissions d'examen</p>
              </div>
            </div>
            <div class="page-title-right">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 text-white">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);" class="text-white text-opacity-75">
                      <i class="ri-home-4-line me-1"></i>Examens
                    </a>
                  </li>
                  <li class="breadcrumb-item active">Liste des commissions</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-primary-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Total commissions</p>
                  <h4 class="mb-0">{{ commissions|length }}</h4>
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-primary rounded-circle text-white fs-4">
                    <i class="ri-group-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-success-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Validées</p>
                  <h4 class="mb-0">{{ commissions|length|add:0 }}</h4> <!-- Placeholder - actual count would require filtering -->
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-success rounded-circle text-white fs-4">
                    <i class="ri-checkbox-circle-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-warning-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">En attente</p>
                  <h4 class="mb-0">{{ commissions|length|add:0 }}</h4> <!-- Placeholder - actual count would require filtering -->
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-warning rounded-circle text-white fs-4">
                    <i class="ri-time-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card stats-card bg-info-subtle border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-muted mb-1">Participants</p>
                  <h4 class="mb-0">{{ total_participants|default:0 }}</h4> <!-- Placeholder -->
                </div>
                <div class="avatar-sm align-self-center">
                  <div class="avatar-title bg-info rounded-circle text-white fs-4">
                    <i class="ri-user-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card border-0 shadow-sm rounded-3">
            <div class="card-header bg-white p-4 border-bottom">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <div class="d-flex align-items-center">
                  <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                    <i class="ri-filter-line text-info"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-0 text-info">Filtres avancés</h5>
                    <p class="text-muted mb-0 small">Affinez votre recherche</p>
                  </div>
                </div>

                <div class="ms-auto">
                  <div class="d-flex flex-wrap align-items-center gap-3">
                    <a href="{% url 't_exam:NouvelleCommission' %}" class="btn btn-primary d-flex align-items-center">
                      <i class="ri-add-line me-1"></i> Nouvelle commission
                    </a>

                    <div class="d-flex gap-2">
                      <select id="promoFilter" class="form-select rounded-pill" style="min-width: 180px;">
                        <option value="">Toutes les promotions</option>
                        {% for promo in all_promotions %}
                        <option value="{{ promo.id }}">{{ promo.label }}</option>
                        {% endfor %}
                      </select>

                      <select id="statusFilter" class="form-select rounded-pill" style="min-width: 160px;">
                        <option value="">Tous les statuts</option>
                        <option value="validated">Validées</option>
                        <option value="pending">En attente</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body p-0">
              {% if commissions %}
                <div class="row g-4 p-4">
                  {% for commission in commissions %}
                    <div class="col-xl-6 col-md-12">
                      <div class="card commission-card h-100 border-0 shadow-sm">
                        <div class="card-body p-4">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                              <h5 class="card-title mb-1 text-truncate" title="{{ commission.label }}">
                                <a href="{% url 't_exam:DetailsCommission' pk=commission.id %}" class="text-decoration-none text-dark">
                                  {{ commission.label }}
                                </a>
                              </h5>
                              <p class="text-muted mb-0">
                                <small>ID: #{{ commission.id }}</small>
                              </p>
                            </div>

                            <div class="dropdown d-inline-block">
                              <button class="btn btn-soft-primary btn-sm dropdown-toggle shadow-none" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                                <i class="ri-more-2-fill"></i>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-3 p-2" style="min-width: 200px;">
                                <li>
                                  <a href="{% url 't_exam:DetailsCommission' pk=commission.id %}" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2">
                                    <i class="ri-eye-line text-info me-2"></i>Consulter
                                  </a>
                                </li>
                                {% if not commission.is_validated %}
                                <li>
                                  <a href="{% url 't_exam:UpdateCommission' pk=commission.id %}" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2">
                                    <i class="ri-edit-line text-primary me-2"></i>Modifier
                                  </a>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2 text-success validate-commission-btn" data-commission-id="{{ commission.id }}">
                                    <i class="ri-checkbox-circle-line me-2"></i>Valider
                                  </button>
                                </li>
                                {% else %}
                                <li>
                                  <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2 text-muted" style="pointer-events: none; opacity: 0.5;">
                                    <i class="ri-edit-line text-muted me-2"></i>Modifier
                                  </a>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider my-1"></li>
                                {% if not commission.is_validated %}
                                <li>
                                  <button class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2 text-danger delete-commission-btn" data-commission-id="{{ commission.id }}" data-commission-label="{{ commission.label }}">
                                    <i class="ri-delete-bin-line me-2"></i>Supprimer
                                  </button>
                                </li>
                                {% else %}
                                <li>
                                  <a href="#" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2 text-muted" style="pointer-events: none; opacity: 0.5;">
                                    <i class="ri-delete-bin-line text-muted me-2"></i>Supprimer
                                  </a>
                                </li>
                                {% endif %}
                              </ul>
                            </div>
                          </div>

                          <div class="row g-2 mb-3">
                            <div class="col-md-6">
                              <div class="d-flex align-items-center">
                                <i class="ri-graduation-cap-line text-info me-2"></i>
                                <span class="text-muted">
                                  {% if commission.promo %}
                                    <span class="fw-semibold">{{ commission.promo.label }}</span>
                                  {% else %}
                                    <span class="text-muted">--</span>
                                  {% endif %}
                                </span>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="d-flex align-items-center">
                                <i class="ri-calendar-line text-info me-2"></i>
                                <span class="text-muted">
                                  {% if commission.date_commission %}
                                    {{ commission.date_commission|date:"d M Y" }}
                                  {% else %}
                                    --
                                  {% endif %}
                                </span>
                              </div>
                            </div>
                          </div>

                          <div class="row g-2 mb-3">
                            <div class="col-sm-4">
                              <div class="d-flex align-items-center">
                                <i class="ri-user-line text-primary me-2"></i>
                                <span class="text-muted">{{ commission.participant.count }} participants</span>
                              </div>
                            </div>
                            <div class="col-sm-4">
                              <div class="d-flex align-items-center">
                                <i class="ri-graduation-cap-line text-success me-2"></i>
                                <span class="text-muted">{{ commission.formateurs.count }} formateurs</span>
                              </div>
                            </div>
                            <div class="col-sm-4">
                              <div class="d-flex align-items-center">
                                <i class="ri-team-line text-warning me-2"></i>
                                <span class="text-muted">{{ commission.groupes.count }} groupes</span>
                              </div>
                            </div>
                          </div>

                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              {% if commission.is_validated %}
                                <span class="status-badge bg-success-subtle text-success border border-success-subtle">
                                  <i class="ri-checkbox-circle-fill me-1"></i> Validée
                                </span>
                              {% else %}
                                <span class="status-badge bg-warning-subtle text-warning border border-warning-subtle">
                                  <i class="ri-time-line me-1"></i> En attente
                                </span>
                              {% endif %}
                            </div>

                            <a href="{% url 't_exam:DetailsCommission' pk=commission.id %}" class="btn btn-outline-primary btn-sm">
                              <i class="ri-eye-line me-1"></i> Détails
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <!-- Message when no results after filtering -->
                <div id="noResultsMessage" class="text-center py-5" style="display: none;">
                  <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                    <i class="ri-search-off-line text-muted fs-1"></i>
                  </div>
                  <h5 class="mb-2">Aucune commission trouvée</h5>
                  <p class="text-muted mb-4">Aucune commission ne correspond aux filtres sélectionnés</p>
                  <button class="btn btn-outline-primary reset-filters-btn">
                    <i class="ri-refresh-line me-1"></i> Réinitialiser les filtres
                  </button>
                </div>
              {% else %}
                <div class="text-center py-5">
                  <div class="avatar-lg mx-auto mb-4 bg-light-subtle rounded-circle d-flex align-items-center justify-content-center">
                    <i class="ri-group-line text-muted fs-1"></i>
                  </div>
                  <h5 class="mb-2">Aucune commission trouvée</h5>
                  <p class="text-muted mb-4">Il n'y a aucune commission enregistrée pour le moment</p>
                  <a href="{% url 't_exam:NouvelleCommission' %}" class="btn btn-primary">
                    <i class="ri-add-line me-1"></i> Créer une commission
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<!-- Modal de validation de commission -->
<div class="modal fade" id="validateCommissionModal" tabindex="-1" aria-labelledby="validateCommissionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-checkbox-circle-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="validateCommissionModalLabel">
              Validation de la commission
            </h5>
            <p class="text-muted small mb-0">Confirmer la validation de la commission</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="avatar-lg mx-auto mb-3">
            <div class="avatar-title bg-success bg-opacity-10 text-success display-5 rounded-circle">
              <i class="ri-checkbox-circle-line"></i>
            </div>
          </div>
          <h5 class="mb-3">Êtes-vous sûr de vouloir valider cette commission ?</h5>
          <p class="text-muted mb-4">
            La validation de la commission permettra de finaliser les attributions et de procéder aux actions liées.
          </p>
          <div class="alert alert-warning">
            <i class="ri-alert-line fs-4 me-2"></i>
            <strong>Attention :</strong> Une fois la commission validée, certaines modifications ne seront plus possibles.
          </div>
        </div>
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-medium">Commentaire de validation (optionnel)</label>
            <textarea id="validationComment" class="form-control border-0 bg-light" rows="3" placeholder="Ajoutez un commentaire..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <input type="hidden" id="commissionToValidate" value="">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" id="confirmValidateCommissionBtn" class="btn btn-success px-4 py-2">
          <i class="ri-check-line me-2"></i>Valider la commission
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de suppression de commission -->
<div class="modal fade" id="deleteCommissionModal" tabindex="-1" aria-labelledby="deleteCommissionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteCommissionModalLabel">
              Suppression de la commission
            </h5>
            <p class="text-muted small mb-0">Confirmer la suppression de la commission</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="avatar-lg mx-auto mb-3">
            <div class="avatar-title bg-danger bg-opacity-10 text-danger display-5 rounded-circle">
              <i class="ri-delete-bin-line"></i>
            </div>
          </div>
          <h5 class="mb-3">Êtes-vous sûr de vouloir supprimer cette commission ?</h5>
          <p class="text-muted mb-4">
            <strong id="commissionToDeleteLabel"></strong>
          </p>
          <div class="alert alert-danger">
            <i class="ri-alert-line fs-4 me-2"></i>
            <strong>Attention :</strong> Cette action est irréversible et supprimera définitivement la commission et toutes ses données associées.
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <input type="hidden" id="commissionToDelete" value="">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="button" id="confirmDeleteCommissionBtn" class="btn btn-danger px-4 py-2">
          <i class="ri-delete-bin-line me-2"></i>Supprimer la commission
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    // Fonction pour filtrer les cartes de commissions (sans recherche textuelle)
    function filterCommissions() {
      var promoFilter = $('#promoFilter').val();
      var statusFilter = $('#statusFilter').val();

      var visibleCount = 0;

      $('.commission-card').each(function() {
        var $card = $(this);
        var promoId = $card.find('.promo-id').text();
        var status = $card.find('.status-badge').hasClass('bg-success-subtle') ? 'validated' : 'pending';

        var matchesPromo = promoFilter === '' || promoId === promoFilter;
        var matchesStatus = statusFilter === '' || status === statusFilter;

        if (matchesPromo && matchesStatus) {
          $card.closest('.col-xl-6').show();
          visibleCount++;
        } else {
          $card.closest('.col-xl-6').hide();
        }
      });

      // Show/hide the "no results" message
      if (visibleCount === 0 && ($('.commission-card').length > 0)) {
        $('#noResultsMessage').show();
      } else {
        $('#noResultsMessage').hide();
      }
    }

    // Écouter les changements sur les filtres
    $('#promoFilter, #statusFilter').on('change', filterCommissions);

    // Réinitialiser les filtres
    $('.reset-filters-btn').on('click', function() {
      $('#promoFilter').val('');
      $('#statusFilter').val('');
      filterCommissions();
    });

    // Gestion du bouton Valider dans le dropdown
    $('.validate-commission-btn').on('click', function(){
      var commissionId = $(this).data('commission-id');
      $('#commissionToValidate').val(commissionId);
      $('#validateCommissionModal').modal('show');
    });

    // Gestion de la validation de la commission
    $('#confirmValidateCommissionBtn').on('click', function(){
      var commissionId = $('#commissionToValidate').val();
      var comment = $('#validationComment').val();

      // Disable the button during request to prevent duplicate submissions
      $(this).prop('disabled', true).text('Validation...');

      if(commissionId) {
        $.ajax({
          url: '{% url "t_exam:validate_commission" pk=0 %}'.replace('0', commissionId),
          type: 'POST',
          data: {
            'comment': comment,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(response) {
            if(response.status === 'success') {
              $('#validateCommissionModal').modal('hide');
              // Show success message and reload page to update the UI
              alert(response.message);
              location.reload();
            } else {
              alert(response.message || 'Une erreur est survenue lors de la validation.');
            }
          },
          error: function() {
            alert('Une erreur est survenue lors de la validation.');
          },
          complete: function() {
            // Re-enable the button after request completes
            $('#confirmValidateCommissionBtn').prop('disabled', false).html('<i class="ri-check-line me-2"></i>Valider la commission');
          }
        });
      }
    });

    // Gestion du bouton Supprimer dans le dropdown
    $('.delete-commission-btn').on('click', function(){
      var commissionId = $(this).data('commission-id');
      var commissionLabel = $(this).data('commission-label');
      $('#commissionToDelete').val(commissionId);
      $('#commissionToDeleteLabel').text(commissionLabel);
      $('#deleteCommissionModal').modal('show');
    });

    // Gestion de la suppression de la commission
    $('#confirmDeleteCommissionBtn').on('click', function(){
      var commissionId = $('#commissionToDelete').val();

      // Disable the button during request to prevent duplicate submissions
      $(this).prop('disabled', true).text('Suppression...');

      if(commissionId) {
        $.ajax({
          url: '{% url "t_exam:delete_commission" pk=0 %}'.replace('0', commissionId),
          type: 'POST',
          data: {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(response) {
            if(response.status === 'success') {
              $('#deleteCommissionModal').modal('hide');
              // Show success message and reload page to update the UI
              location.reload();
            } else {
              alert(response.message || 'Une erreur est survenue lors de la suppression.');
            }
          },
          error: function() {
            alert('Une erreur est survenue lors de la suppression.');
          },
          complete: function() {
            // Re-enable the button after request completes
            $('#confirmDeleteCommissionBtn').prop('disabled', false).html('<i class="ri-delete-bin-line me-2"></i>Supprimer la commission');
          }
        });
      }
    });
  });
</script>

{% endblock content %}