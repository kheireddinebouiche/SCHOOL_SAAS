<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="header-title mb-0">PV de Délibération - {{ groupe.label }}</h4>
            </div>
            <p class="text-muted font-14 mb-4">
                Résultats des examens pour le groupe {{ groupe.label }} - Session: {{ session_line.session.label }}
            </p>

            <div class="table-responsive">
                {% for pv_item in pv_data %}
                    <h5 class="mt-4">Module: {{ pv_item.pv.exam_planification.module.libelle }}</h5>
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th rowspan="2">Étudiant</th>
                                {% for type_note in pv_item.exam_types_notes %}
                                    {% if type_note.has_sous_notes %}
                                        <th colspan="{{ type_note.nb_sous_notes|add:1 }}" class="text-center">{{ type_note.libelle }}</th>
                                    {% else %}
                                        <th>{{ type_note.libelle }}</th>
                                    {% endif %}
                                {% endfor %}
                                <th rowspan="2">Décision</th>
                            </tr>
                            <tr>
                                {% for type_note in pv_item.exam_types_notes %}
                                    {% if type_note.has_sous_notes %}
                                        {% for i in "x"|rjust:type_note.nb_sous_notes %}
                                            <th>S{{ forloop.counter }}</th>
                                        {% endfor %}
                                        <th>{{ type_note.libelle }}</th>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for etudiant in etudiants %}
                                <tr>
                                    <td>{{ etudiant.nom }} {{ etudiant.prenom }}</td>
                                    {% for type_note in pv_item.exam_types_notes %}
                                        {% if type_note.has_sous_notes %}
                                            {% for i in "x"|rjust:type_note.nb_sous_notes %}
                                                {% with current_loop_index=forloop.counter0 %}
                                                    {% for note in pv_item.notes %}
                                                        {% if note.etudiant.id == etudiant.id and note.type_note.id == type_note.id %}
                                                            {% for sous_note in note.sous_notes.all %}
                                                                {% if forloop.counter0 == current_loop_index %}
                                                                    <td>{{ sous_note.valeur|default:'-' }}</td>
                                                                {% endif %}
                                                            {% endfor %}
                                                            {% if note.sous_notes.all|length <= current_loop_index %}
                                                                <td>-</td>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endwith %}
                                            {% endfor %}
                                        {% endif %}
                                        {% for note in pv_item.notes %}
                                            {% if note.etudiant.id == etudiant.id and note.type_note.id == type_note.id %}
                                                <td class="font-weight-bold">{{ note.valeur|default:'-' }}</td>
                                            {% endif %}
                                        {% endfor %}
                                        {% comment %} If no note found for this student and type, show a placeholder {% endcomment %}
                                        {% with note_found=False %}
                                            {% for note in pv_item.notes %}
                                                {% if note.etudiant.id == etudiant.id and note.type_note.id == type_note.id %}
                                                    {% with note_found=True %}{% endwith %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if not note_found %}
                                                <td class="font-weight-bold">-</td>
                                            {% endif %}
                                        {% endwith %}
                                    {% endfor %}
                                    {% comment %} Decision for this student {% endcomment %}
                                    {% with decision_displayed=False %}
                                        {% for decision in pv_item.decisions %}
                                            {% if decision.etudiant.id == etudiant.id %}
                                                <td>
                                                    {% if decision.statut == 'valide' %}
                                                        <span class="badge badge-success">Admis</span>
                                                    {% elif decision.statut == 'rattrapage' %}
                                                        <span class="badge badge-warning">Rattrapage</span>
                                                    {% elif decision.statut == 'rach' %}
                                                        <span class="badge badge-info">Rachat</span>
                                                    {% elif decision.statut == 'ajou' %}
                                                        <span class="badge badge-danger">Ajourné</span>
                                                    {% endif %}
                                                </td>
                                                {% with decision_displayed=True %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if not decision_displayed %}
                                            <td>-</td>
                                        {% endif %}
                                    {% endwith %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% empty %}
                    <div class="alert alert-info">
                        <h5>Aucun PV de délibération disponible pour ce groupe.</h5>
                        <p>Il n'y a pas encore de procès-verbal d'examen pour ce groupe.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>