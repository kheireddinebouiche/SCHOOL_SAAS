{% load custom_filters %}
<style>
    .deliberation-table {
        font-size: 0.7rem;
        width: 100%;
        table-layout: auto;
    }
    .deliberation-table thead th {
        padding: 0.25rem 0.2rem;
        font-size: 0.65rem;
        vertical-align: middle;
        white-space: nowrap;
        border: 1px solid #dee2e6;
    }
    .deliberation-table tbody td {
        padding: 0.25rem 0.3rem;
        vertical-align: middle;
        font-size: 0.65rem;
        border: 1px solid #dee2e6;
    }
    .deliberation-table .module-header {
        font-size: 0.7rem;
        padding: 0.3rem 0.2rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .deliberation-table .type-note-header {
        font-size: 0.6rem;
        background-color: #f8f9fa;
        font-weight: 500;
    }
    .deliberation-table .student-name {
        font-weight: 600;
        background-color: #f8f9fa;
        position: sticky;
        left: 0;
        z-index: 10;
        min-width: 120px;
    }
    .deliberation-table .moyenne-cell {
        background-color: #fff3cd;
        font-weight: 700;
        color: #856404;
    }
    .deliberation-table .decision-cell {
        background-color: #e7f3ff;
        position: sticky;
        right: 0;
        z-index: 10;
    }
    .deliberation-table tbody tr:hover {
        background-color: #f1f3f5;
    }
    .deliberation-table select.form-control-sm {
        font-size: 0.65rem;
        padding: 0.2rem 0.3rem;
        height: auto;
        border-radius: 0.2rem;
    }
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .deliberation-container {
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    @media (max-width: 1400px) {
        .deliberation-table {
            font-size: 0.6rem;
        }
        .deliberation-table thead th {
            font-size: 0.55rem;
            padding: 0.2rem 0.15rem;
        }
        .deliberation-table tbody td {
            font-size: 0.55rem;
            padding: 0.2rem 0.2rem;
        }
    }
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="header-title mb-0">PV de Délibération - {{ groupe.nom }}</h4>
            </div>
            <p class="text-muted font-14 mb-4">
                Résultats des examens pour le groupe {{ groupe.label }} - Session: {{ session_line.session.label }}
            </p>

            <div class="table-responsive deliberation-container">
                {% if pv_data %}
                    <table class="table table-bordered deliberation-table mb-0">
                        <thead>
                            <tr>
                                <th rowspan="3" class="student-name">Étudiant</th>
                                {% for pv_item in pv_data %}
                                    {% comment %} Calculate total columns for this module (types_notes + moyenne) {% endcomment %}
                                    <th colspan="{{ pv_item.exam_types_notes|length|add:1 }}" class="text-center module-header">
                                        <strong>{{ pv_item.module.label }}</strong>
                                    </th>
                                {% endfor %}
                                <th rowspan="3" class="decision-cell">Décision Jury</th>
                                <th rowspan="3" class="decision-cell">Observation</th>
                            </tr>
                            <tr>
                                {% for pv_item in pv_data %}
                                    {% for type_note in pv_item.exam_types_notes %}
                                        {% if type_note.has_sous_notes %}
                                            <th colspan="{{ type_note.nb_sous_notes|add:1 }}" class="text-center type-note-header">{{ type_note.libelle }}</th>
                                        {% else %}
                                            <th rowspan="2" class="type-note-header">{{ type_note.libelle }}</th>
                                        {% endif %}
                                    {% endfor %}
                                    <th rowspan="2" class="bg-warning text-dark type-note-header"><strong>Moyenne (UV)</strong></th>
                                {% endfor %}
                            </tr>
                            <tr>
                                {% for pv_item in pv_data %}
                                    {% for type_note in pv_item.exam_types_notes %}
                                        {% if type_note.has_sous_notes %}
                                            {% for i in "x"|rjust:type_note.nb_sous_notes %}
                                                <th class="type-note-header">S{{ forloop.counter }}</th>
                                            {% endfor %}
                                            <th class="type-note-header">{{ type_note.libelle }}</th>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for etudiant in etudiants %}
                                <tr>
                                    <td class="student-name">{{ etudiant.nom }} {{ etudiant.prenom }}</td>
                                    {% for pv_item in pv_data %}
                                        {% for type_note in pv_item.exam_types_notes %}
                                            {% with student_notes=pv_item.notes_by_student|get_item:etudiant.id %}
                                                {% if student_notes %}
                                                    {% with notes_list=student_notes|get_item:type_note.code %}
                                                        {% comment %} Display sous-notes if type has them {% endcomment %}
                                                        {% if type_note.has_sous_notes %}
                                                            {% for i in "x"|rjust:type_note.nb_sous_notes %}
                                                                {% with current_loop_index=forloop.counter0 %}
                                                                    <td>
                                                                        {% if notes_list %}
                                                                            {% for note in notes_list %}
                                                                                {% for sous_note in note.sous_notes.all %}
                                                                                    {% if forloop.counter0 == current_loop_index %}
                                                                                        {{ sous_note.valeur|default:"-" }}{% if not forloop.last %} / {% endif %}
                                                                                    {% endif %}
                                                                                {% endfor %}
                                                                            {% endfor %}
                                                                        {% else %}
                                                                            -
                                                                        {% endif %}
                                                                    </td>
                                                                {% endwith %}
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% comment %} Display main note value {% endcomment %}
                                                        <td class="font-weight-bold">
                                                            {% if notes_list %}
                                                                {% for note in notes_list %}
                                                                    {{ note.valeur|default:"-" }}{% if not forloop.last %} / {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </td>
                                                    {% endwith %}
                                                {% else %}
                                                    {% comment %} No notes for this student {% endcomment %}
                                                    {% if type_note.has_sous_notes %}
                                                        {% for i in "x"|rjust:type_note.nb_sous_notes %}
                                                            <td>-</td>
                                                        {% endfor %}
                                                    {% endif %}
                                                    <td class="font-weight-bold">-</td>
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                        {% comment %} Display moyenne for this module {% endcomment %}
                                        <td class="moyenne-cell text-center">
                                            {% with decision=pv_item.decisions_by_student|get_item:etudiant.id %}
                                                {% if decision and decision.moyenne %}
                                                    {{ decision.moyenne|floatformat:2 }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    {% endfor %}
                                    {% comment %} Décision Jury column {% endcomment %}
                                    <td class="text-center decision-cell">
                                        <select class="form-control form-control-sm" name="decision_jury_{{ etudiant.id }}">
                                            <option value="">-</option>
                                            <option value="valide">Semestre validé</option>
                                            <option value="valide_dette">Semestre validé avec dette</option>
                                            <option value="non_valide">Semestre non validé</option>
                                        </select>
                                    </td>
                                    {% comment %} Observation column {% endcomment %}
                                    <td class="text-center decision-cell">
                                        <select class="form-control form-control-sm" name="observation_{{ etudiant.id }}">
                                            <option value="">-</option>
                                            <option value="admis">Admis(e)</option>
                                            <option value="ajourne">Ajourné(e)</option>
                                            <option value="radie">Radié(e)</option>
                                        </select>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="alert alert-info">
                        <h5>Aucun PV de délibération disponible pour ce groupe.</h5>
                        <p>Il n'y a pas encore de procès-verbal d'examen pour ce groupe.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>