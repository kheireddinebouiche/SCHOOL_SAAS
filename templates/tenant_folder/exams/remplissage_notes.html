{% load exam_custom_filters %}
<!-- Modal for filling exam notes -->
<div class="modal fade" id="fillNotesModal" tabindex="-1" aria-labelledby="fillNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title text-dark" id="fillNotesModalLabel">
                    Remplissage des notes - {{ module }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <style>
                .calculated-field {
                    background-color: #e9ecef !important; /* Grey background for calculated fields */
                    color: #6c757d !important; /* Grey text for calculated fields */
                }

                tr.rachat-student,
                .rachat-student {
                    background-color: #fff9c4 !important; /* Yellow background for rachat students */
                    opacity: 1 !important; /* Ensure full opacity for rachat students */
                }
            </style>

            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-dark">Groupe: <strong>{{ groupe.groupe.nom }}</strong></h6>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-dark">Session: <strong>{{ session }}</strong></h6>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-dark">Module: <strong>{{ module }}</strong></h6>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-dark">Note éliminatoire: <strong>{{ note_eliminatoire }}</strong></h6>
                        </div>
                    </div>

                    <div id="status-message" class="status-message alert" style="display: none;"></div>

                    <!-- Commission Statistics for Normal Exam -->
                    {% if exam_planification.type_examen == 'normal' and commission_stats %}
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="card bg-light border-0">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-dark mb-2">Statistiques de la commission</h6>
                                    <div class="d-flex flex-wrap gap-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                                <i class="ri-user-line text-primary"></i>
                                            </div>
                                            <div>
                                                <p class="text-muted mb-0 small">Total étudiants</p>
                                                <h6 class="mb-0 text-dark">{{ commission_stats.total }}</h6>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success bg-opacity-10 rounded-circle p-2 me-2">
                                                <i class="ri-exchange-dollar-line text-success"></i>
                                            </div>
                                            <div>
                                                <p class="text-muted mb-0 small">Rachat de crédit</p>
                                                <h6 class="mb-0 text-dark">{{ commission_stats.rach }}</h6>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-2">
                                                <i class="ri-close-line text-danger"></i>
                                            </div>
                                            <div>
                                                <p class="text-muted mb-0 small">Ajournés</p>
                                                <h6 class="mb-0 text-dark">{{ commission_stats.ajou }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- List of Students Concerned by Makeup Exam (Rachat) for Normal Exam -->
                    {% if exam_planification.type_examen == 'normal' and rachat_students_details %}
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="card border-warning border-2">
                                <div class="card-header bg-warning bg-opacity-10 py-2 px-3">
                                    <h6 class="card-title text-dark mb-0">
                                        <i class="ri-user-2-line me-2"></i>
                                        Étudiants concernés par l'examen de rachat pour ce module
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-borderless mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="text-dark">N°</th>
                                                    <th class="text-dark">Nom et Prénom</th>
                                                    <th class="text-dark">Matricule</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for student in rachat_students_details %}
                                                <tr>
                                                    <td class="text-dark">{{ forloop.counter }}</td>
                                                    <td class="text-dark">{{ student.nom }} {{ student.prenom }}</td>
                                                    <td class="text-dark">{{ student.matricule }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="text-muted mt-2 mb-0 small">
                                        <i class="ri-information-line me-1"></i>
                                        Ces étudiants sont en situation de rachat de crédit pour ce module et apparaîtront avec un fond jaune dans la grille ci-dessous.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <form id="exam-results-form" data-exam-type="{{ exam_planification.type_examen }}">
                        {% csrf_token %}
                        <input type="hidden" name="exam_plan_id" value="{{ pk }}">

                        <!-- Table showing students and note types -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="align-middle text-dark">N°</th>
                                        <th class="align-middle text-dark">Nom et Prénom</th>
                                        <th class="align-middle text-dark">Matricule</th>
                                        {% for type_note in filtered_types_notes %}
                                            {% if type_note.has_sous_notes and type_note.nb_sous_notes > 0 %}
                                                <th colspan="{{ type_note.nb_sous_notes|add:1 }}" class="text-center text-dark">{{ type_note.libelle }} (Max: {{ type_note.max_note }})</th>
                                            {% else %}
                                                <th class="text-center text-dark">{{ type_note.libelle }} (Max: {{ type_note.max_note }})</th>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th class="align-middle text-dark"></th>
                                        <th class="align-middle text-dark"></th>
                                        <th class="align-middle text-dark"></th>
                                        {% for type_note in filtered_types_notes %}
                                            {% if type_note.has_sous_notes and type_note.nb_sous_notes > 0 %}
                                                {% for builtin_type in modele.types_notes.all %}
                                                    {% if builtin_type.code == type_note.code %}
                                                        {% for sous_note in builtin_type.sous_notes.all %}
                                                            <th class="text-center small text-dark">{{ sous_note.label }} (Max: {{ sous_note.max_note }})</th>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                                <th class="text-center small text-dark">
                                                    {% if type_note.is_calculee %}
                                                        {{ type_note.libelle }} ({{ type_note.type_calcul }})
                                                    {% else %}
                                                        Total
                                                    {% endif %}
                                                </th>
                                            {% else %}
                                                <th class="text-center small text-dark">
                                                    {% if type_note.is_calculee %}
                                                        {{ type_note.libelle }} ({{ type_note.type_calcul }})
                                                    {% else %}
                                                        {{ type_note.libelle }}
                                                    {% endif %}
                                                </th>
                                            {% endif %}
                                        {% endfor %}
                                        <th class="text-center text-dark">Moyenne UV</th>
                                        <th class="text-center text-dark">Observation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student_line in students %}
                                        <tr class="student-row {% if exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}rachat-student{% elif student_line.student.id|stringformat:"s" in rach_ajou_students %}table-secondary{% endif %}"
                                            {% if student_line.student.id|stringformat:"s" in rach_ajou_students and exam_planification.type_examen != 'normal' %}style="opacity: 0.7;"{% endif %}
                                            data-student-id="{{ student_line.student.id }}"
                                            data-exam-type="{{ exam_planification.type_examen }}"
                                            {% if student_line.student.id|stringformat:"s" in rachat_only_students %}data-is-rachat="true"{% endif %}>
                                            <td class="text-dark">{{ forloop.counter }}</td>
                                            <td class="student-name text-dark">
                                                {{ student_line.student.nom }} {{ student_line.student.prenom }}
                                                {% if exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}<span class="badge bg-warning text-dark ms-2">RACHAT</span>{% elif student_line.student.id|stringformat:"s" in rach_ajou_students %}<span class="badge bg-secondary text-light ms-2">RACHAT/AJOURNÉ</span>{% endif %}
                                            </td>
                                            <td class="text-dark">{{ student_line.student.matricule }}</td>
                                            {% for type_note in filtered_types_notes %}
                                                {% for builtin_type in modele.types_notes.all %}
                                                    {% if builtin_type.code == type_note.code %}
                                                        {% if type_note.has_sous_notes and type_note.nb_sous_notes > 0 %}
                                                            {% for sous_note in builtin_type.sous_notes.all %}
                                                                {% with sous_note_index=forloop.counter0 %}
                                                                <td class="text-center">
                                                                    <input type="number"
                                                                           step="0.01"
                                                                           min="0"
                                                                           max="{{ sous_note.max_note }}"
                                                                           class="form-control form-control-sm sous-note-input"
                                                                           name="sous_note_{{ student_line.student.id }}_{{ builtin_type.id }}_{{ sous_note_index }}"
                                                                           value="{% if student_notes_data %}{% with student_data=student_notes_data|exam_get_item:student_line.student.id %}{% if student_data %}{% with builtin_id=exam_to_builtin_mapping|exam_get_item:type_note.id %}{% if builtin_id %}{% with note_data=student_data|exam_get_item:builtin_id %}{% if note_data and note_data.sous_notes and sous_note_index < note_data.sous_notes|length %}{% with sous_note_item=note_data.sous_notes|exam_get_list_item:sous_note_index %}{% if sous_note_item %}{{ sous_note_item.valeur|format_number_for_input }}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}"
                                                                           {% if pv_examen and pv_examen.est_valide or type_note.is_calculee or student_line.student.id|stringformat:"s" in rach_ajou_students %}disabled{% elif exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}disabled{% endif %}>
                                                                </td>
                                                                {% endwith %}
                                                            {% endfor %}
                                                            <!-- Total field for sub-notes -->
                                                            <td class="text-center">
                                                                <input type="number"
                                                                       step="0.01"
                                                                       min="0"
                                                                       max="{{ type_note.max_note }}"
                                                                       class="form-control form-control-sm final-note-input {% if type_note.is_calculee or type_note.has_sous_notes %}calculated-field{% endif %}"
                                                                       name="note_{{ student_line.student.id }}_{{ builtin_type.id }}"
                                                                       value="{% if student_notes_data %}{% with student_data=student_notes_data|exam_get_item:student_line.student.id %}{% if student_data %}{% with builtin_id=exam_to_builtin_mapping|exam_get_item:type_note.id %}{% if builtin_id %}{% with note_data=student_data|exam_get_item:builtin_id %}{% if note_data %}{{ note_data.value|format_number_for_input }}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}"
                                                                       {% if pv_examen and pv_examen.est_valide or type_note.is_calculee or type_note.has_sous_notes or student_line.student.id|stringformat:"s" in rach_ajou_students %}readonly{% elif exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}readonly{% endif %}>
                                                            </td>
                                                        {% else %}
                                                            <td class="text-center">
                                                                <input type="number"
                                                                       step="0.01"
                                                                       min="0"
                                                                       max="{{ type_note.max_note }}"
                                                                       class="form-control form-control-sm {% if type_note.is_calculee %}calculated-field{% endif %}"
                                                                       name="note_{{ student_line.student.id }}_{{ builtin_type.id }}"
                                                                       value="{% if student_notes_data %}{% with student_data=student_notes_data|exam_get_item:student_line.student.id %}{% if student_data %}{% with builtin_id=exam_to_builtin_mapping|exam_get_item:type_note.id %}{% if builtin_id %}{% with note_data=student_data|exam_get_item:builtin_id %}{% if note_data %}{{ note_data.value|format_number_for_input }}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}{% endwith %}{% endif %}"
                                                                       {% if pv_examen and pv_examen.est_valide or type_note.is_calculee or student_line.student.id|stringformat:"s" in rach_ajou_students %}readonly{% elif exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}readonly{% endif %}>
                                                            </td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            <!-- Moyenne column -->
                                            <td class="text-center">
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       id="moyenne_{{ student_line.student.id }}"
                                                       readonly
                                                       style="background-color: #e9ecef !important; color: #6c757d !important;"
                                                       value="{% if existing_decisions %}{{ existing_decisions|exam_get_item:student_line.student.id|exam_get_item:'moyenne' }}{% endif %}">
                                            </td>
                                            <!-- Observation column -->
                                            <td class="text-center">
                                                <select class="form-select form-select-sm"
                                                        name="observation_{{ student_line.student.id }}"
                                                        {% if student_line.student.id|stringformat:"s" in rach_ajou_students %}disabled{% elif exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}disabled{% endif %}>
                                                    <option value="">Sélectionnez...</option>
                                                    <option value="valide" {% if existing_decisions and existing_decisions|exam_get_item:student_line.student.id|exam_get_item:'statut' == 'valide' %}selected{% endif %}>Admis</option>
                                                    <option value="rattrapage" {% if existing_decisions and existing_decisions|exam_get_item:student_line.student.id|exam_get_item:'statut' == 'rattrapage' %}selected{% endif %}>Rattrapage</option>
                                                    <option value="rach" {% if existing_decisions and existing_decisions|exam_get_item:student_line.student.id|exam_get_item:'statut' == 'rach' or student_line.student.id|stringformat:"s" in rach_ajou_students %}selected{% elif exam_planification.type_examen == 'normal' and student_line.student.id|stringformat:"s" in rachat_only_students %}selected{% endif %}>Rachat de crédit</option>
                                                    <option value="ajou" {% if existing_decisions and existing_decisions|exam_get_item:student_line.student.id|exam_get_item:'statut' == 'ajou' %}selected{% endif %}>Ajourné</option>
                                                </select>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                {% if not pv_examen or not pv_examen.est_valide %}
                    <button type="button" class="btn btn-warning" id="save-notes-btn">Sauvegarder</button>
                    <button type="button" class="btn btn-success" id="validate-exam-btn">Valider l'examen</button>
                {% else %}
                    <span class="text-success fw-bold">PV Validé</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Exam Validation -->
<div class="modal fade" id="confirmValidateModal" tabindex="-1" aria-labelledby="confirmValidateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark" id="confirmValidateModalLabel">Confirmation de validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                Êtes-vous sûr de vouloir valider cet examen ? Cette action est irréversible.
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirm-validate-btn">Valider</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Saving with Invalid Notes -->
<div class="modal fade" id="confirmSaveInvalidModal" tabindex="-1" aria-labelledby="confirmSaveInvalidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark" id="confirmSaveInvalidModalLabel">Notes invalides détectées</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                Certaines notes dépassent la note maximale. Voulez-vous quand même sauvegarder ?
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="confirm-save-invalid-btn">Sauvegarder quand même</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Validating with Invalid Notes -->
<div class="modal fade" id="confirmValidateInvalidModal" tabindex="-1" aria-labelledby="confirmValidateInvalidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark" id="confirmValidateInvalidModalLabel">Notes invalides détectées</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                Certaines notes dépassent la note maximale. Voulez-vous quand même valider ?
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirm-validate-invalid-btn">Valider quand même</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap and jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

     // Add event listeners when the modal is shown
    $(document).ready(function() { 
        
    // Define URLs using Django template tags
    if (typeof SAVE_EXAM_RESULTS_URL === 'undefined') {
        var SAVE_EXAM_RESULTS_URL = "{% url 't_exam:save_exam_results' pk %}";
    }
    if (typeof VALIDATE_EXAM_URL === 'undefined') {
        var VALIDATE_EXAM_URL = "{% url 't_exam:validate_pv_exam' %}";
    }

    // Define dependencies data from Django template context
    var dependenciesData = {};
    {% if dependencies_data and dependencies_data != 'null' and dependencies_data != '{}' %}
    try {
        dependenciesData = JSON.parse('{{ dependencies_data|escapejs }}');
    } catch (e) {
        console.error('Error parsing dependencies data:', e);
        console.log('Raw dependencies data:', '{{ dependencies_data|escapejs }}');
        dependenciesData = {};
    }
    {% endif %}

    function showStatus(message, isSuccess) {
        const statusDiv = document.getElementById('status-message');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message alert ' + (isSuccess ? 'alert-success' : 'alert-danger');
        statusDiv.style.display = 'block';

        setTimeout(function() {
            statusDiv.style.display = 'none';
        }, 5000);
    }

    function validateNoteInput(inputElement) {
        const value = parseFloat(inputElement.value);
        const maxNote = parseFloat(inputElement.max);

        if (!isNaN(value) && !isNaN(maxNote) && value > maxNote) {
            inputElement.style.backgroundColor = '#ffe6e6';
            return false;
        } else if (!isNaN(value) && !isNaN(maxNote) && value <= maxNote) {
            inputElement.style.backgroundColor = '#e6ffe6';
            return true;
        } else {
            inputElement.style.backgroundColor = '';
            return true;
        }
    }

    function validateAllNotes() {
        let allValid = true;
        const noteInputs = document.querySelectorAll('input[type="number"]');

        noteInputs.forEach(function(input) {
            if (!validateNoteInput(input)) {
                allValid = false;
            }
        });

        return allValid;
    }

    function saveExamResults() {
        const form = document.getElementById('exam-results-form');
        const formData = new FormData(form);

        // Debug: log form data
        console.log('Form data being sent:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }

        // Add average and observation values to form data
        const studentRows = document.querySelectorAll('tbody tr');
        studentRows.forEach(function(row) {
            const studentCell = row.querySelector('td:nth-child(1)'); // First cell has student number
            if (studentCell) {
                // Get student ID from the row (we'll use the data from the first cell's sibling)
                const studentNameCell = row.querySelector('td:nth-child(2)');
                const studentFirstNameCell = row.querySelector('td:nth-child(3)');

                // Find the student ID by looking at the inputs in the row
                const noteInputs = row.querySelectorAll('input[name^="note_"]');
                if (noteInputs.length > 0) {
                    // Extract student ID from first input name (format: note_studentId_typeId)
                    const firstInputName = noteInputs[0].name;
                    const match = firstInputName.match(/note_(\d+)_(\d+)/);
                    if (match) {
                        const studentId = match[1];

                        // Add average value
                        const avgInput = document.getElementById(`moyenne_${studentId}`);
                        if (avgInput && avgInput.value !== '') {
                            formData.append(`average_${studentId}`, avgInput.value);
                        }

                        // Add observation value
                        const obsSelect = row.querySelector(`select[name="observation_${studentId}"]`);
                        if (obsSelect && obsSelect.value !== '') {
                            formData.append(`observation_${studentId}`, obsSelect.value);
                        }
                    }
                }
            }
        });

        $.ajax({
            url: typeof SAVE_EXAM_RESULTS_URL !== 'undefined' ? SAVE_EXAM_RESULTS_URL : "{% url 't_exam:save_exam_results' pk %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function(data) {
                if (data.status === 'success') {
                    showStatus(data.message, true);
                } else {
                    showStatus(data.message, false);
                }
            },
            error: function(xhr, status, error) {
                console.error('Save error:', error);
                console.error('XHR status:', xhr.status);
                console.error('XHR responseText:', xhr.responseText);
                showStatus('Erreur de sauvegarde: ' + error, false);
            }
        });
    }

    function validateExam() {
        // Show the confirmation modal
        if (typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
            var modalElement = document.getElementById('confirmValidateModal');
            // Check if modal is already open to avoid recursion
            if (!modalElement.classList.contains('show')) {
                var modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                modal.show();
            }
        } else {
            // Fallback to confirm if bootstrap is not loaded
            if (confirm('Êtes-vous sûr de vouloir valider cet examen ? Cette action est irréversible.')) {
                performValidateExam();
            }
        }
    }

    // Handle the confirmation for exam validation
    function performValidateExam() {
        const examPlanId = "{{pk}}";

        // Using fetch API instead of jQuery.ajax for vanilla JS
        fetch(typeof VALIDATE_EXAM_URL !== 'undefined' ? VALIDATE_EXAM_URL : "{% url 't_exam:validate_pv_exam' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'planId=' + encodeURIComponent(examPlanId) +
                  '&examStatus=termine' +
                  '&csrfmiddlewaretoken=' + encodeURIComponent(document.querySelector('[name=csrfmiddlewaretoken]').value)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showStatus(data.message, true);
                // Disable all input elements
                document.querySelectorAll('input').forEach(input => {
                    input.disabled = true;
                });
                // Disable all select elements (including observation columns)
                document.querySelectorAll('select').forEach(select => {
                    select.disabled = true;
                    // Gray out the select elements to make them visually appear disabled
                    select.style.backgroundColor = '#e9ecef';
                    select.style.color = '#6c757d';
                    select.style.cursor = 'not-allowed';
                });
                // Disable save button
                const saveBtn = document.getElementById('save-notes-btn');
                if (saveBtn) saveBtn.disabled = true;
                // Hide validate button
                const validateBtn = document.getElementById('validate-exam-btn');
                if (validateBtn) validateBtn.style.display = 'none';
                // Add validation text
                const modalFooter = document.querySelector('.modal-footer');
                if (modalFooter) {
                    const validatedSpan = document.createElement('span');
                    validatedSpan.className = 'text-success fw-bold ms-2';
                    validatedSpan.textContent = 'PV Validé';
                    modalFooter.appendChild(validatedSpan);
                }
            } else {
                showStatus(data.message, false);
            }
        })
        .catch(error => {
            showStatus('Erreur de connexion: ' + error, false);
        });
    }

    // Calculate total from sub-notes
    function calculateTotalFromSubNotes(studentId, typeId, nbSubNotes) {
        let total = 0;
        let isValid = true;

        for (let i = 0; i < nbSubNotes; i++) {
            const subNoteInput = document.querySelector(`input[name="sous_note_${studentId}_${typeId}_${i}"]`);
            if (subNoteInput && subNoteInput.value !== '') {
                const value = parseFloat(subNoteInput.value);
                if (!isNaN(value)) {
                    total += value;
                } else {
                    isValid = false;
                }
            }
        }

        if (isValid) {
            const totalInput = document.querySelector(`input[name="note_${studentId}_${typeId}"]`);
            if (totalInput) {
                // Only update if this note is not calculated from dependencies
                const noteData = dependenciesData[typeId];
                if (!noteData || !noteData.is_calculee || noteData.type_calcul === 'NONE') {
                    totalInput.value = total.toFixed(2);
                    validateNoteInput(totalInput);
                }
            }
        }
    }

    // Calculate value based on dependencies (SUM or AVG)
    function calculateFromDependencies(studentId, builtinId) {
        const noteData = dependenciesData[builtinId];
        if (!noteData || !noteData.is_calculee || noteData.type_calcul === 'NONE') {
            return;
        }

        // Check if this note has dependencies (calculated from other notes) or is just a total of sub-notes
        const dependencies = noteData.dependencies;
        if (!dependencies || dependencies.length === 0) {
            // This might be a total of sub-notes that is also marked as calculated
            // In this case, we don't calculate it from dependencies, it should be calculated from sub-notes
            return;
        }

        let total = 0;
        let count = 0;
        let allValid = true;

        // Calculate based on dependencies
        for (const dep of dependencies) {
            const depInput = document.querySelector(`input[name="note_${studentId}_${dep.builtin_id}"]`);
            if (depInput && depInput.value !== '') {
                const value = parseFloat(depInput.value);
                if (!isNaN(value)) {
                    total += value;
                    count++;
                } else {
                    allValid = false;
                }
            } else {
                allValid = false;
            }
        }

        if (allValid && count > 0) {
            let result;
            if (noteData.type_calcul === 'SUM') {
                result = total;
            } else if (noteData.type_calcul === 'AVG') {
                result = total / count;
            }

            // Ensure result doesn't exceed max note
            const maxNote = noteData.max_note;
            if (result > maxNote) {
                result = maxNote;
            }

            const targetInput = document.querySelector(`input[name="note_${studentId}_${builtinId}"]`);
            if (targetInput) {
                targetInput.value = result.toFixed(2);
                validateNoteInput(targetInput);
            }
        }
    }

    // Trigger calculations for all calculated notes that depend on this note
    function triggerDependentCalculations(studentId, changedBuiltinId) {
        // Loop through all dependencies to find notes that depend on the changed note
        for (const builtinId in dependenciesData) {
            const noteData = dependenciesData[builtinId];
            if (noteData.is_calculee && noteData.type_calcul !== 'NONE') {
                // Check if this note depends on the changed note
                const dependsOnChanged = noteData.dependencies.some(dep => dep.builtin_id == changedBuiltinId);

                if (dependsOnChanged) {
                    // This note depends on the changed note, so recalculate it
                    calculateFromDependencies(studentId, builtinId);

                    // Recursively trigger calculations for notes that depend on this one
                    triggerDependentCalculations(studentId, builtinId);
                }
            }
        }

        // After all calculations, recalculate the average
        calculateAverage(studentId);
    }

    // Calculate average for a student based on notes that intervene in the average with weighting
    function calculateAverage(studentId) {
        // Get all note inputs for this student
        const noteInputs = document.querySelectorAll(`input[name^="note_${studentId}_"]`);
        let weightedSum = 0;
        let totalCoefficients = 0;

        // Iterate through each note input
        noteInputs.forEach(function(input) {
            // Extract the type note ID from the input name (format: note_studentId_typeNoteId)
            const nameParts = input.name.split('_');
            if (nameParts.length >= 3) {
                const extractedStudentId = nameParts[1];
                const extractedTypeId = nameParts[2];

                // Only process if this belongs to the current student
                if (extractedStudentId == studentId) {
                    // Check if this type note intervenes in the average
                    const noteValue = parseFloat(input.value);
                    if (!isNaN(noteValue) && input.value.trim() !== '') {
                        // We need to determine if this note type should be included in average
                        // This requires checking the backend data
                        const noteData = dependenciesData[extractedTypeId];
                        if (noteData && noteData.in_moyenne) {
                            // Calculate coefficient based on max_note (weight)
                            const maxNote = noteData.max_note || 20; // Default to 20 if no max_note

                            // Calculate the weighted value: (note_value / max_note) * 20 * coefficient
                            // For a weighted average, we use: (value/max) * coefficient
                            const normalizedValue = (noteValue / maxNote) * 20; // Normalize to 20 scale
                            const coefficient = maxNote / 20; // Use max_note as coefficient (adjust as needed)

                            weightedSum += normalizedValue * coefficient;
                            totalCoefficients += coefficient;
                        }
                    }
                }
            }
        });

        // Calculate and display the weighted average on 20 scale
        const avgElement = document.getElementById(`moyenne_${studentId}`);
        if (avgElement) {
            if (totalCoefficients > 0) {
                const weightedAverage = weightedSum / totalCoefficients;
                avgElement.value = weightedAverage.toFixed(2);
            } else {
                avgElement.value = '';
            }
        }
    }

   
        // If PV is already validated when page loads, disable all inputs and selects
        {% if pv_examen and pv_examen.est_valide %}
            // Disable all input elements
            document.querySelectorAll('input').forEach(input => {
                input.disabled = true;
            });
            // Disable all select elements (including observation columns)
            document.querySelectorAll('select').forEach(select => {
                select.disabled = true;
                // Gray out the select elements to make them visually appear disabled
                select.style.backgroundColor = '#e9ecef';
                select.style.color = '#6c757d';
                select.style.cursor = 'not-allowed';
            });
            // Disable save button if it exists
            const saveBtn = document.getElementById('save-notes-btn');
            if (saveBtn) saveBtn.disabled = true;
            // Hide validate button if it exists
            const validateBtn = document.getElementById('validate-exam-btn');
            if (validateBtn) validateBtn.style.display = 'none';
        {% endif %}

        // Save notes button - only add event listener if button exists
        const saveNotesBtn = document.getElementById('save-notes-btn');
        if (saveNotesBtn) {
            saveNotesBtn.addEventListener('click', function() {
                console.log('Save button clicked');
                if (!validateAllNotes()) {
                    // Show the confirmation modal for invalid notes
                    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                        var modalElement = document.getElementById('confirmSaveInvalidModal');
                        // Check if modal is already open to avoid recursion
                        if (!modalElement.classList.contains('show')) {
                            var modal = bootstrap.Modal.getInstance(modalElement);
                            if (!modal) {
                                modal = new bootstrap.Modal(modalElement);
                            }
                            modal.show();
                        }
                    } else {
                        // Fallback to confirm if bootstrap is not loaded
                        if (confirm('Certaines notes dépassent la note maximale. Voulez-vous quand même sauvegarder ?')) {
                            saveExamResults();
                        }
                    }
                } else {
                    console.log('Calling saveExamResults');
                    saveExamResults();
                }
            });
        }

        // Handle the confirmation for saving with invalid notes
        document.getElementById('confirm-save-invalid-btn').addEventListener('click', function() {
            // Hide the modal using vanilla JS
            var modalEl = document.getElementById('confirmSaveInvalidModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            console.log('Calling saveExamResults');
            saveExamResults();
        });

        // Also handle closing the modal via backdrop or close button
        document.getElementById('confirmSaveInvalidModal').addEventListener('hidden.bs.modal', function () {
            // Ensure the modal is properly closed
        });

        // Validate exam button - only add event listener if button exists
        const validateExamBtn = document.getElementById('validate-exam-btn');
        if (validateExamBtn) {
            validateExamBtn.addEventListener('click', function() {
                if (!validateAllNotes()) {
                    // Show the confirmation modal for invalid notes during validation
                    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                        var modalElement = document.getElementById('confirmValidateInvalidModal');
                        // Check if modal is already open to avoid recursion
                        if (!modalElement.classList.contains('show')) {
                            var modal = bootstrap.Modal.getInstance(modalElement);
                            if (!modal) {
                                modal = new bootstrap.Modal(modalElement);
                            }
                            modal.show();
                        }
                    } else {
                        // Fallback to confirm if bootstrap is not loaded
                        if (confirm('Certaines notes dépassent la note maximale. Voulez-vous quand même valider ?')) {
                            validateExam();
                        }
                    }
                } else {
                    // Directly call validateExam which will show the validation modal
                    validateExam();
                }
            });
        }

        // Handle the confirmation for validating with invalid notes
        document.getElementById('confirm-validate-invalid-btn').addEventListener('click', function() {
            // Hide the modal using vanilla JS
            var modalEl = document.getElementById('confirmValidateInvalidModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            validateExam();
        });

        // Handle the confirmation for exam validation
        document.getElementById('confirm-validate-btn').addEventListener('click', function() {
            // Hide the modal using vanilla JS
            var modalEl = document.getElementById('confirmValidateModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            performValidateExam();
        });

        // Also handle closing the modal via backdrop or close button
        document.getElementById('confirmValidateInvalidModal').addEventListener('hidden.bs.modal', function () {
            // Ensure the modal is properly closed
        });

        // Also handle closing the first modal via backdrop or close button
        document.getElementById('confirmValidateModal').addEventListener('hidden.bs.modal', function () {
            // Ensure the modal is properly closed
        });

        // Add validation to all note inputs
        const noteInputs = document.querySelectorAll('input[type="number"]');
        noteInputs.forEach(function(input) {
            input.addEventListener('blur', function() {
                validateNoteInput(this);
            });
        });

        // Add event listeners for sub-notes
        document.querySelectorAll('.sous-note-input').forEach(function(input) {
            input.addEventListener('input', function() {
                const name = input.name;
                const match = name.match(/sous_note_(\d+)_(\d+)_(\d+)/);
                if (match) {
                    const studentId = match[1];
                    const typeId = match[2];
                    const subNoteIndex = match[3];

                    // Count total sub-notes for this type by checking how many sub-note inputs exist for this student and type
                    const nbSubNotes = document.querySelectorAll(`input[name^="sous_note_${studentId}_${typeId}_"]`).length;

                    calculateTotalFromSubNotes(studentId, typeId, nbSubNotes);
                    validateNoteInput(input);

                    // Trigger dependent calculations since this total note has changed
                    triggerDependentCalculations(studentId, typeId);

                    // Recalculate average for this student
                    calculateAverage(studentId);
                }
            });
        });

        // Add event listeners for regular note inputs (not calculated and not based on sub-notes)
        document.querySelectorAll('input[name^="note_"]:not(.calculated-field):not(.final-note-input)').forEach(function(input) {
            input.addEventListener('input', function() {
                const name = input.name;
                const match = name.match(/note_(\d+)_(\d+)/);
                if (match) {
                    const studentId = match[1];
                    const builtinId = match[2];

                    validateNoteInput(input);

                    // Trigger dependent calculations since this note has changed
                    triggerDependentCalculations(studentId, builtinId);

                    // Recalculate average for this student
                    calculateAverage(studentId);
                }
            });
        });

        // Add event listeners for calculated fields (based on dependencies) to prevent user input
        document.querySelectorAll('input.calculated-field').forEach(function(input) {
            input.addEventListener('input', function() {
                // For calculated fields, recalculate based on dependencies
                const name = input.name;
                const match = name.match(/note_(\d+)_(\d+)/);
                if (match) {
                    const studentId = match[1];
                    const builtinId = match[2];

                    // Recalculate the value based on dependencies
                    calculateFromDependencies(studentId, builtinId);

                    // Recalculate average for this student
                    calculateAverage(studentId);
                }
            });
        });

        // Function to initialize students with rachat or ajourné status
        function initializeRachAjourneStudents() {
            // Get the list of students with rachat or ajourné status from the server-side data
            // This would be passed from the server as a data attribute or similar
            // For now, we'll rely on the server-side rendering, but we can enhance this if needed

            // If the server has already marked these students in the template,
            // we can look for rows with the specific styling
            const rachAjourneRows = document.querySelectorAll('tr[style*="background-color: #f8f9fa"]');

            rachAjourneRows.forEach(row => {
                // Find all note inputs in this row and set them to 0 and disable them
                const noteInputs = row.querySelectorAll('input[name^="note_"]');
                noteInputs.forEach(input => {
                    input.value = '0';
                    input.readOnly = true;
                    input.style.backgroundColor = '#f8f9fa'; // Light gray background
                    input.style.color = '#6c757d'; // Gray text
                    input.style.cursor = 'not-allowed';
                });

                // Find all sub-note inputs in this row and set them to 0
                const subNoteInputs = row.querySelectorAll('input[name^="sous_note_"]');
                subNoteInputs.forEach(input => {
                    input.value = '0';
                    input.disabled = true;
                    input.style.backgroundColor = '#f8f9fa'; // Light gray background
                    input.style.color = '#6c757d'; // Gray text
                    input.style.cursor = 'not-allowed';
                });

                // Find the average input in this row and set it to 0
                const avgInput = row.querySelector('input[id^="moyenne_"]');
                if (avgInput) {
                    avgInput.value = '0';
                    avgInput.readOnly = true;
                    avgInput.style.backgroundColor = '#f8f9fa'; // Light gray background
                    avgInput.style.color = '#6c757d'; // Gray text
                    avgInput.style.cursor = 'not-allowed';
                }

                // Find the observation select in this row and freeze it to 'rach'
                const obsSelect = row.querySelector('select[name^="observation_"]');
                if (obsSelect) {
                    obsSelect.value = 'rach';
                    obsSelect.disabled = true;
                    obsSelect.style.backgroundColor = '#f8f9fa'; // Light gray background
                    obsSelect.style.color = '#6c757d'; // Gray text
                    obsSelect.style.cursor = 'not-allowed';
                }
            });
        }

        // Call the initialization function when the modal is shown
        initializeRachAjourneStudents();
    });

    // Create JavaScript array from Django template data
    var rachatStudentIds = [];
    {% for student in rachat_students_details %}
        rachatStudentIds.push({{ student.id }});
    {% endfor %}

    // Apply yellow background and disable fields for rachat students during normal exams
    $(document).ready(function() {
        // Small delay to ensure all elements are rendered
        setTimeout(function() {
            const form = document.getElementById('exam-results-form');
            if (form) {
                const examType = form.getAttribute('data-exam-type');

                if (examType === 'normal' && rachatStudentIds.length > 0) {
                    // Loop through each rachat student ID
                    rachatStudentIds.forEach(function(studentId) {
                        // Find the row for this specific student
                        const studentRow = document.querySelector(`tr[data-student-id="${studentId}"]`);

                        if (studentRow) {
                            // Add yellow background class
                            studentRow.classList.add('rachat-student');

                            // Disable all input fields in this row and set values to 0
                            const inputs = studentRow.querySelectorAll('input, select');
                            inputs.forEach(function(input) {
                                // Set value to 0 for input fields
                                if (input.type === 'number' || input.name.startsWith('sous_note_') || input.name.startsWith('note_')) {
                                    input.value = '0';
                                    input.disabled = true;
                                    input.readOnly = true;

                                    // Add visual indication that field is disabled
                                    input.style.backgroundColor = '#fff9c4';
                                    input.style.opacity = '0.7';
                                } else if (input.tagName.toLowerCase() === 'select' && input.name.startsWith('observation_')) {
                                    // For observation select, set to 'rach' and disable
                                    input.value = 'rach';
                                    input.disabled = true;

                                    // Add visual indication that field is disabled
                                    input.style.backgroundColor = '#fff9c4';
                                    input.style.opacity = '0.7';
                                } else if (input.id && input.id.startsWith('moyenne_')) {
                                    // For average input (moyenne), set to 0 and disable
                                    input.value = '0';
                                    input.disabled = true;
                                    input.readOnly = true;

                                    // Add visual indication that field is disabled
                                    input.style.backgroundColor = '#fff9c4';
                                    input.style.opacity = '0.7';
                                } else {
                                    // For other inputs, just disable
                                    input.disabled = true;
                                    input.readOnly = true;

                                    // Add visual indication that field is disabled
                                    input.style.backgroundColor = '#fff9c4';
                                    input.style.opacity = '0.7';
                                }
                            });
                        }
                    });
                }
            }
        }, 200); // Slightly longer delay to ensure everything is loaded
    });
</script>
