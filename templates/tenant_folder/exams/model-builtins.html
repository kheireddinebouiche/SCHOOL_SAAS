{% extends 'tenant_folder/base.html' %}
{% load static %}
{% block title %} Examens - Modèles de bulletins {% endblock title %}

{% block content %}
<style>
  .search-box {
    position: relative;
  }
  .search-box .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* Empêche l'icône de capturer les événements souris */
  }
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  .table td {
    vertical-align: middle;
  }
  .badge {
    padding: 0.5em 1em;
    font-weight: 500;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .dropdown-item i {
    width: 1.2rem;
  }
  .btn-group .btn {
    padding: 0.375rem 0.75rem;
  }
  .btn-outline-info .ri-link-line {
    color: #0d6efd; /* info color */
  }
  .btn-outline-info:hover .ri-link-line {
    color: #fff; /* white when hovered */
  }
  .modal-header .btn-close:focus {
    box-shadow: none;
  }

  /* Prospect type cards */
  .prospect-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .prospect-type-card:hover {
    transform: translateY(-5px);
    border-color: #0d6efd;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  .prospect-type-card[data-type="entreprise"]:hover {
    border-color: #dc3545;
  }

  /* Fix dropdown z-index issue */
  .table-responsive {
    overflow-x: visible;
  }

  .table td.text-end {
    position: relative;
    overflow: visible;
  }

  .table .dropdown-menu {
    z-index: 1050;
    position: absolute;
  }

  /* Card View Styles */
  .cards-container {
    display: none; /* Initially hidden */
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem;
    padding: 0.75rem 0;
  }

  .prospect-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    height: 100%;
    background: #ffffff;
    overflow: hidden;
    position: relative;
  }

  .prospect-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  .card-header-prospect {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
    padding: 1rem 1rem 0.75rem;
    position: relative;
  }

  .card-body-prospect {
    padding: 1rem 1rem 1rem 1rem;
    padding-top: 2.5rem; /* Adjusted padding to account for the dropdown */
    position: relative;
  }

  .prospect-name {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
    color: #2d3748;
    display: flex;
    align-items: center;
  }

  .prospect-name::before {
    content: "";
    display: inline-block;
    width: 3px;
    height: 16px;
    background: linear-gradient(to bottom, #3498db, #8e44ad);
    border-radius: 2px;
    margin-right: 8px;
  }

  .prospect-company {
    font-weight: 500;
    color: #4a90e2;
    margin-bottom: 0.6rem;
    font-size: 0.85rem;
  }

  .prospect-info {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
    color: #4a5568;
  }

  .prospect-info i {
    width: 1.2rem;
    height: 1.2rem;
    margin-right: 0.6rem;
    color: #718096;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f7fafc;
    border-radius: 4px;
    padding: 0.25rem;
  }

  .prospect-type-badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .prospect-type-badge.particulier {
    background-color: #e6f7ff;
    color: #1890ff;
    border: 1px solid #91d5ff;
  }

  .prospect-type-badge.entreprise {
    background-color: #fff2e8;
    color: #fa8c16;
    border: 1px solid #ffd591;
  }

  .prospect-state-badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
  }

  .prospect-state-badge.en_attente {
    background-color: #fffbe6;
    color: #d4b106;
    border: 1px solid #ffe58f;
  }

  .prospect-state-badge.confirme {
    background-color: #f6ffed;
    color: #52c41a;
    border: 1px solid #b7eb8f;
  }

  .dropdown {
    z-index: 10;
  }

  .name-dropdown {
    vertical-align: middle;
  }

  .name-dropdown .btn {
    border: none;
    padding: 0.25rem;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }

  .view-toggle-btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  /* Show appropriate view */
  #tableView {
    display: block;
  }

  #cardView {
    display: none;
  }

  #tableView.table-view-hidden {
    display: none;
  }

  #cardView.card-view-shown {
    display: block;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .cards-container {
      grid-template-columns: 1fr;
    }
  }

  /* Additional styles for exam models page */
  .stats-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .model-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e9ecef;
  }
  .model-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  .status-badge {
    padding: 0.5em 1em;
    font-weight: 500;
    border-radius: 50px;
  }
  .dropdown-menu {
    z-index: 1060 !important;
  }
  .type-note-item {
    border-left: 3px solid #0d6efd;
    margin-bottom: 10px;
    padding-left: 15px;
  }
  .sous-note-item {
    border-left: 2px solid #6c757d;
    margin-left: 20px;
    margin-bottom: 5px;
    padding-left: 10px;
  }
  .nested-list {
    margin-left: 20px;
  }
  .sortable-item {
    cursor: move;
    user-select: none;
  }
  .sortable-item:hover {
    background-color: #f8f9fa;
  }
</style>

<div class="main-content">
  <div class="page-content bg-light">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-sm-flex align-items-center justify-content-between bg-white rounded-lg shadow-sm p-3">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                <i class="ri-file-text-line text-info"></i>
              </div>
              <h4 class="mb-0 text-info">Modèles de bulletins</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 bg-transparent">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Examens</a>
                  </li>
                  <li class="breadcrumb-item active">Modèles de bulletins</li>
                </ol>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <!-- KPIs Section -->
      <div class="col-12 mb-4">
        <div class="row g-3">
          <!-- Total Models -->
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="ri-file-text-line text-primary fs-4"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-muted">Total modèles</h5>
                    <h3 class="mb-0 fw-bold" id="totalModels">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Default Models -->
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="ri-checkbox-circle-line text-success fs-4"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-muted">Par défaut</h5>
                    <h3 class="mb-0 fw-bold" id="defaultModels">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- With Formations -->
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="ri-graduation-cap-line text-info fs-4"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-muted">Avec formations</h5>
                    <h3 class="mb-0 fw-bold" id="modelsWithFormations">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Types of Notes -->
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="ri-list-check-2 text-warning fs-4"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-muted">Types de notes</h5>
                    <h3 class="mb-0 fw-bold" id="totalTypeNotes">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-white p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-filter text-info me-2"></i>
                  <h5 class="card-title mb-0 text-info">Filtres</h5>
                </div>

                <div class="d-flex align-items-center gap-3">
                  <div class="search-box">
                    <input type="text" placeholder="Rechercher..." id="searchInput" class="form-control rounded-pill" style="width: 220px;"/>
                    <i class="fas fa-search text-muted search-icon"></i>
                  </div>

                  <select id="formationFilter" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Filtrer par formation</option>
                    {% for formation in formations %}
                    <option value="{{ formation.id }}">{{ formation.nom }}</option>
                    {% endfor %}
                  </select>

                  <select id="defaultFilter" class="form-select rounded-pill" style="width: 220px;">
                    <option value="">Filtrer par défaut</option>
                    <option value="true">Par défaut</option>
                    <option value="false">Non par défaut</option>
                  </select>

                  <button id="addNewModel" class="btn btn-primary rounded-pill" data-url="{% url 't_exam:NewModelBuilltin' %}">
                    <i class="ri-add-line me-1"></i> Nouveau modèle
                  </button>
                </div>
              </div>
            </div>

            <div class="card-body p-3" id="cardContentBody">
              <!-- Table View -->
              <div id="tableView">
                <div class="table-responsive" style="overflow-x: visible;">
                  <table id="modelsTable" class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th class="border-0 rounded-start">Libellé</th>
                        <th class="border-0">Formation</th>
                        <th class="border-0">Par défaut</th>
                        <th class="border-0">Types de notes</th>
                        <th class="border-0 rounded-end text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="listItem">
                      <tr>
                        <td colspan="5" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center">
                            <i class="bx bx-loader bx-spin bx-lg text-primary mb-3"></i>
                            <p class="text-muted mb-0">Chargement des modèles...</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Pagination -->
              <nav aria-label="Models pagination" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- Pagination will be populated by JavaScript -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Model Modal -->
<div id="createModelModal" class="modal fade" tabindex="-1" aria-labelledby="createModelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-file-add-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="createModelModalLabel">
              <span id="modalTitle">Création d'un nouveau modèle de bulletin</span>
            </h5>
            <p class="text-muted small mb-0">Remplissez les informations du modèle</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="modelForm">
          {% csrf_token %}
          <input type="hidden" id="modelId" name="id">

          <div class="row">
            <div class="col-md-12">
              <div class="mb-4">
                <label for="label" class="form-label">Libellé *</label>
                <input type="text" class="form-control" id="label" name="label" required>
                <div class="invalid-feedback">Veuillez entrer un libellé</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-4">
                <label for="formation" class="form-label">Formation</label>
                <select class="form-select" id="formation" name="formation">
                  <option value="">Toutes les formations</option>
                  {% for formation in formations %}
                  <option value="{{ formation.id }}">{{ formation.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-4">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="is_default" name="is_default">
                  <label class="form-check-label" for="is_default">
                    Définir comme modèle par défaut
                  </label>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="submit" form="modelForm" class="btn btn-primary px-4 py-2">
          <i class="ri-check-line me-2"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Model Details Modal -->
<div id="modelDetailsModal" class="modal fade" tabindex="-1" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-file-info-line text-info fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-info mb-1" id="modelDetailsModalLabel">
              Détails du modèle de bulletin
            </h5>
            <p class="text-muted small mb-0" id="modelDetailsTitle">Informations et configuration</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Informations du modèle -->
        <div class="card border-0 shadow-sm mb-4 overflow-hidden">
          <div class="card-header border-0 bg-white pt-3">
            <div class="d-flex align-items-center">
              <span class="icon-circle bg-primary bg-opacity-10 rounded me-2">
                <i class="ri-file-info-line text-primary"></i>
              </span>
              <h6 class="card-title mb-0 text-primary">Informations du modèle</h6>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-6">
                <label class="form-label fw-medium">Libellé</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                  <input type="text" class="form-control border-0 bg-light py-2" id="detailLabel" readonly>
                </div>
              </div>
              <div class="col-lg-6">
                <label class="form-label fw-medium">Formation</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-graduation-cap-line text-muted"></i></span>
                  <input type="text" class="form-control border-0 bg-light py-2" id="detailFormation" readonly>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Types de notes</h5>
              <button type="button" class="btn btn-success btn-sm" id="addTypeNoteBtn">
                <i class="ri-add-line me-1"></i> Ajouter un type de note
              </button>
            </div>

            <div class="card">
              <div class="card-body">
                <div id="typesNotesList">
                  <!-- Types of notes will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Type Note Modal -->
<div id="typeNoteModal" class="modal fade" tabindex="-1" aria-labelledby="typeNoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-gradient bg-success bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-list-check-2-line text-success fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-success mb-1" id="typeNoteModalLabel">
              <span id="typeNoteModalTitle">Ajouter un type de note</span>
            </h5>
            <p class="text-muted small mb-0">Configuration du type de note</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="typeNoteForm">
          {% csrf_token %}
          <input type="hidden" id="typeNoteId" name="type_note_id">
          <input type="hidden" id="modelIdForTypeNote" name="model_id">

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="mb-3">
                <label class="form-label fw-medium" for="code">Code *</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-barcode-line text-muted"></i></span>
                  <input type="text" class="form-control border-0 bg-light py-2 rounded-2" id="code" name="code" required>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="mb-3">
                <label class="form-label fw-medium" for="libelle">Libellé *</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                  <input type="text" class="form-control border-0 bg-light py-2 rounded-2" id="libelle" name="libelle" required>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-10">
              <div class="mb-3">
                <label class="form-label fw-medium" for="bloc_id">Bloc de notes</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-stack-line text-muted"></i></span>
                  <select class="form-select border-0 bg-white py-2 rounded-2" id="bloc_id" name="bloc_id">
                    <option value="">Aucun bloc</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-lg-2">
              <div class="mb-3">
                <label class="form-label fw-medium">&nbsp;</label>
                <div class="d-grid">
                  <button type="button" class="btn btn-outline-primary py-2 rounded-2" id="addNewBlocBtn" title="Créer un nouveau bloc">
                    <i class="ri-add-line"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="mb-3">
                <label class="form-label fw-medium" for="max_note">Note maximale *</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-number-1 text-muted"></i></span>
                  <input type="number" class="form-control border-0 bg-light py-2 rounded-2" id="max_note" name="max_note" step="0.01" min="0" required>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="mb-3">
                <label class="form-label fw-medium" for="ordre">Ordre</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"><i class="ri-sort-asc text-muted"></i></span>
                  <input type="number" class="form-control border-0 bg-light py-2 rounded-2" id="ordre" name="ordre" min="0">
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="mb-3">
                <div class="form-check form-switch form-switch-success">
                  <input class="form-check-input" type="checkbox" id="has_sous_notes" name="has_sous_notes">
                  <label class="form-check-label" for="has_sous_notes">
                    A des sous-notes
                  </label>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="mb-3">
                <div class="form-check form-switch form-switch-success">
                  <input class="form-check-input" type="checkbox" id="is_calculee" name="is_calculee">
                  <label class="form-check-label" for="is_calculee">
                    Calculée
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="mb-3">
                <div class="form-check form-switch form-switch-success">
                  <input class="form-check-input" type="checkbox" id="is_rattrapage" name="is_rattrapage">
                  <label class="form-check-label" for="is_rattrapage">
                    Rattrapage
                  </label>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="mb-3">
                <div class="form-check form-switch form-switch-success">
                  <input class="form-check-input" type="checkbox" id="is_rachat" name="is_rachat">
                  <label class="form-check-label" for="is_rachat">
                    Rachat de crédit
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div id="calculee_options" class="mt-3 p-3 bg-light rounded-2" style="display: none;">
            <div class="mb-3">
              <label for="type_calcul" class="form-label">Type de calcul</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-function-line text-muted"></i></span>
                <select class="form-select border-0 bg-white py-2 rounded-2" id="type_calcul" name="type_calcul">
                  <option value="NONE">Note saisie</option>
                  <option value="SUM">Somme</option>
                  <option value="AVG">Moyenne</option>
                </select>
              </div>
            </div>
          </div>

          <div id="nb_sous_notes_container" class="mt-3 p-3 bg-light rounded-2" style="display: none;">
            <div class="mb-3">
              <label for="nb_sous_notes" class="form-label">Nombre de sous-notes</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-list-ordered text-muted"></i></span>
                <input type="number" class="form-control border-0 bg-white py-2 rounded-2" id="nb_sous_notes" name="nb_sous_notes" min="0">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-outline-secondary px-4 py-2 rounded-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="submit" form="typeNoteForm" class="btn btn-success px-4 py-2 rounded-2">
          <i class="ri-check-line me-2"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Bloc Modal -->
<div id="blocModal" class="modal fade" tabindex="-1" aria-labelledby="blocModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-primary bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-stack-line text-primary fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-primary mb-1" id="blocModalLabel">
              <span id="blocModalTitle">Créer un nouveau bloc de notes</span>
            </h5>
            <p class="text-muted small mb-0">Configuration du bloc de notes</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="blocForm">
          {% csrf_token %}
          <input type="hidden" id="blocId" name="bloc_id">

          <div class="row g-3">
            <div class="col-lg-12">
              <label class="form-label fw-medium" for="blocLabel">Libellé *</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="blocLabel" name="label" required>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-lg-12">
              <label class="form-label fw-medium" for="blocCode">Code *</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-barcode-line text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="blocCode" name="code" required>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-lg-12">
              <label class="form-label fw-medium" for="blocOrdre">Ordre</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-sort-asc text-muted"></i></span>
                <input type="number" class="form-control border-0 bg-light py-2" id="blocOrdre" name="ordre" min="0" value="0">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="submit" form="blocForm" class="btn btn-primary px-4 py-2">
          <i class="ri-check-line me-2"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Sous-Note Modal -->
<div id="sousNoteModal" class="modal fade" tabindex="-1" aria-labelledby="sousNoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-warning bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-subtract-line text-warning fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-warning mb-1" id="sousNoteModalLabel">
              <span id="sousNoteModalTitle">Ajouter une sous-note</span>
            </h5>
            <p class="text-muted small mb-0">Configuration de la sous-note</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="sousNoteForm">
          {% csrf_token %}
          <input type="hidden" id="sousNoteId" name="sous_note_id">
          <input type="hidden" id="typeNoteIdForSousNote" name="type_note_id">

          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="sousNoteLabel">Libellé *</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-file-text-line text-muted"></i></span>
                <input type="text" class="form-control border-0 bg-light py-2" id="sousNoteLabel" name="label" required>
              </div>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="sousNoteMaxNote">Note maximale</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-number-1 text-muted"></i></span>
                <input type="number" class="form-control border-0 bg-light py-2" id="sousNoteMaxNote" name="max_note" min="0" step="0.01">
              </div>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-lg-6">
              <label class="form-label fw-medium" for="sousNoteOrdre">Ordre</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="ri-sort-asc text-muted"></i></span>
                <input type="number" class="form-control border-0 bg-light py-2" id="sousNoteOrdre" name="ordre" min="0">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Annuler
        </button>
        <button type="submit" form="sousNoteForm" class="btn btn-warning px-4 py-2">
          <i class="ri-check-line me-2"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-danger bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-danger bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-delete-bin-line text-danger fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-danger mb-1" id="deleteModalLabel">
              Confirmation de suppression
            </h5>
            <p class="text-muted small mb-0">Cette action ne peut pas être annulée</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <div class="mb-4">
            <i class="ri-delete-bin-line text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Êtes-vous sûr(e) ?</h4>
          <p class="text-muted mb-0">
            Vous êtes sur le point de supprimer ce modèle. Cette action est irréversible et toutes les données associées seront définitivement supprimées.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <div class="hstack gap-2 justify-content-center w-100">
          <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
            <i class="ri-close-line me-2"></i>Annuler
          </button>
          <button id="confirmDeleteBtn" class="btn btn-danger px-4 py-2">
            <i class="ri-delete-bin-line me-2"></i>Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Manage Dependencies Modal -->
<div id="dependenciesModal" class="modal fade" tabindex="-1" aria-labelledby="dependenciesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 bg-info bg-opacity-10 px-4 py-3">
        <div class="d-flex align-items-center">
          <div class="modal-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
            <i class="ri-link-line text-info fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title fw-semibold text-info mb-1" id="dependenciesModalLabel">
              Gestion des dépendances
            </h5>
            <p class="text-muted small mb-0" id="dependenciesModalSubtitle">Ajouter ou supprimer des dépendances pour ce type de note</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="currentParentId" value="">

        <div class="row mb-4">
          <div class="col-md-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light py-3">
                <h6 class="card-title mb-0 text-primary">Dépendances actuelles</h6>
              </div>
              <div class="card-body">
                <div id="currentDependenciesList">
                  <p class="text-muted">Aucune dépendance configurée</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light py-3">
                <h6 class="card-title mb-0 text-primary">Ajouter une nouvelle dépendance</h6>
              </div>
              <div class="card-body">
                <form id="addDependencyForm">
                  {% csrf_token %}
                  <input type="hidden" id="dependencyParentId" name="parent_id">

                  <div class="row g-3">
                    <div class="col-lg-8">
                      <label class="form-label fw-medium" for="dependencyChild">Type de note à ajouter</label>
                      <select class="form-select" id="dependencyChild" name="child_id" required>
                        <option value="">Sélectionnez un type de note</option>
                      </select>
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label fw-medium">&nbsp;</label>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="ri-add-line me-1"></i> Ajouter
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light px-4 py-3">
        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">
          <i class="ri-close-line me-2"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    let modelsData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentModelId = null;
    let currentTypeNoteId = null;
    let currentSousNoteId = null;

    // Update stats
    function updateStats() {
      const defaultCount = modelsData.filter(model => model.is_default === 'Oui').length;
      const withFormationCount = modelsData.filter(model => model.formation !== 'Toutes les formations').length;
      
      $('#totalModels').text(modelsData.length);
      $('#defaultModels').text(defaultCount);
      $('#modelsWithFormations').text(withFormationCount);
      
      // Calculate total type notes
      let totalTypeNotes = 0;
      modelsData.forEach(model => {
        if(model.types_notes) {
          totalTypeNotes += model.types_notes.length;
        }
      });
      $('#totalTypeNotes').text(totalTypeNotes);
    }

    // Render table
    function renderTable(data) {
      let row = "";
      if (data.length > 0) {
        $.each(data, function(index, item) {
          row += '<tr>';
          row += '<td>'+item.label+'</td>';
          row += '<td>'+item.formation+'</td>';
          row += '<td>'+item.is_default+'</td>';
          row += '<td>'+(item.types_notes ? item.types_notes.length : 0)+'</td>';
          row += '<td>';
          row += '<div class="dropdown d-inline-block">';
          row += '<button class="btn btn-soft-primary btn-sm dropdown-toggle shadow-none" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">';
          row += '<i class="ri-more-2-fill"></i>';
          row += '</button>';
          row += '<ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-3 p-2" style="min-width: 200px;">';
          row += '<li><button data-id="'+item.id+'" id="btnViewDetails" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2"><i class="ri-eye-line text-info me-2"></i>Voir détails</button></li>';
          row += '<li><button data-id="'+item.id+'" id="btnUpdate" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2"><i class="ri-edit-line text-primary me-2"></i>Modifier</button></li>';
          row += '<li><hr class="dropdown-divider my-1"></li>';
          row += '<li><button data-id="'+item.id+'" id="btnDelete" class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2 text-danger"><i class="ri-delete-bin-line me-2"></i>Supprimer</button></li>';
          row += '</ul>';
          row += '</div>';
          row += '</td>';
          row += '</tr>';
        });
      } else {
        row = "<tr><td colspan='5' class='text-center py-5 text-muted'><i class='ri-search-off-line me-2'></i>Aucun modèle trouvé</td></tr>";
      }

      $('#listItem').html(row);
    }

    // Load blocs for selection
    function loadBlocs() {
      $.ajax({
        url: "{% url 't_exam:ApiGetAllBlocs' %}",
        type: 'GET',
        dataType: 'JSON',
        success: function(data) {
          let options = '<option value="">Aucun bloc</option>';
          if(data.length > 0) {
            $.each(data, function(index, bloc) {
              options += '<option value="' + bloc.id + '">' + bloc.label + '</option>';
            });
          }
          $('#bloc_id').html(options);
        },
        error: function() {
          console.error("Erreur lors du chargement des blocs");
        }
      });
    }

    // Add new bloc
    function addNewBloc(label, code, ordre) {
      $.ajax({
        url: "{% url 't_exam:ApiAddBloc' %}",
        type: 'POST',
        data: {
          'label': label,
          'code': code,
          'ordre': ordre,
          'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        dataType: 'json',
        success: function(response) {
          if(response.status === 'success') {
            alertify.success(response.message);
            // Reload blocs to include the new one
            loadBlocs();
            // Set the newly created bloc as selected
            $('#bloc_id').val(response.id);
            // Close the modal
            $('#blocModal').modal('hide');
          } else {
            alertify.error(response.message);
          }
        },
        error: function() {
          alertify.error("Erreur lors de l'ajout du bloc.");
        }
      });
    }

    // Format date
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('fr-FR', options);
    }

    // Load models
    function loadModels() {
      $.ajax({
        url : "{% url 't_exam:ApiListModeleBuilltins' %}",
        type : 'GET',
        dataType : 'JSON',
        success : function(data) {
          modelsData = data;
          updateStats();
          renderTable(data);
          renderPagination();
        },
        error: function() {
          $('#listItem').html("<tr><td colspan='5' class='text-center py-5 text-danger'><i class='ri-error-warning-line me-2'></i>Erreur de chargement des données</td></tr>");
        }
      });
    }

    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(modelsData.length / itemsPerPage);
      let paginationHtml = '';

      if (totalPages <= 1) {
        $('#pagination').html('');
        return;
      }

      // Previous button
      paginationHtml += '<li class="page-item '+(currentPage === 1 ? 'disabled' : '')+'">';
      paginationHtml += '<a class="page-link" href="#" data-page="'+(currentPage-1)+'" aria-label="Previous">';
      paginationHtml += '<i class="ri-arrow-left-s-line"></i>';
      paginationHtml += '</a></li>';

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHtml += '<li class="page-item '+(i === currentPage ? 'active' : '')+'">';
        paginationHtml += '<a class="page-link" href="#" data-page="'+i+'">'+i+'</a>';
        paginationHtml += '</li>';
      }

      // Next button
      paginationHtml += '<li class="page-item '+(currentPage === totalPages ? 'disabled' : '')+'">';
      paginationHtml += '<a class="page-link" href="#" data-page="'+(currentPage+1)+'" aria-label="Next">';
      paginationHtml += '<i class="ri-arrow-right-s-line"></i>';
      paginationHtml += '</a></li>';

      $('#pagination').html(paginationHtml);
    }

    // Filter models
    function filterModels() {
      var formationFilter = $('#formationFilter').val();
      var defaultFilter = $('#defaultFilter').val();
      var searchTerm = $('#searchInput').val().toLowerCase();

      var filteredData = modelsData.filter(model => {
        // Check formation filter
        var matchesFormation = formationFilter === '';
        if (formationFilter !== '') {
          matchesFormation = model.formation_id == formationFilter;
        }

        // Check default filter
        var matchesDefault = defaultFilter === '';
        if (defaultFilter === 'true') {
          matchesDefault = model.is_default === 'Oui';
        } else if (defaultFilter === 'false') {
          matchesDefault = model.is_default === 'Non';
        }

        // Check search term
        var matchesSearch = searchTerm === '' ||
          model.label.toLowerCase().includes(searchTerm) ||
          model.formation.toLowerCase().includes(searchTerm);

        return matchesFormation && matchesDefault && matchesSearch;
      });

      renderTable(filteredData);
    }

    // Load initial data
    loadModels();
    loadBlocs(); // Load blocs

    // Search functionality
    $('#searchInput').on('input', function() {
      filterModels();
    });

    // Formation filter
    $('#formationFilter').on('change', function() {
      filterModels();
    });

    // Default filter
    $('#defaultFilter').on('change', function() {
      filterModels();
    });

    // Pagination
    $(document).on('click', '#pagination .page-link', function(e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      if (!isNaN(page)) {
        currentPage = page;
        renderPagination();
      }
    });

    // Add new model
    $(document).on('click','#addNewModel', function(){
      $('#modelForm')[0].reset();
      $('#modelId').val('');
      $('#modalTitle').text('Création d\'un nouveau modèle de bulletin');
      $('#createModelModal').modal('show');
    });

    // Handle model form submission
    $(document).on('submit', '#modelForm', function(e){
      e.preventDefault();
      const formData = $(this).serialize();
      const modelId = $('#modelId').val();
      
      let url = "{% url 't_exam:NewModelBuilltin' %}";
      if(modelId) {
        url = "{% url 't_exam:ApiUpdateModelBuilltin' %}";
      }
      
      $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        dataType: 'json',
        success: function(response){
          if(response.status == "success" || response.statut == "success"){
            $('#createModelModal').modal('hide');
            alertify.success(response.message || "Modèle enregistré avec succès !");
            loadModels();
          } else {
            alertify.error(response.message || "Erreur lors de l'enregistrement.");
          }
        },
        error: function(xhr, status, error){
          alertify.error("Erreur lors de l'enregistrement.");
        }
      });
    });

    // View model details
    $(document).on('click','#btnViewDetails', function(){
      const id = $(this).data('id');
      currentModelId = id;
      
      $.ajax({
        url: "{% url 't_exam:ApiGetModelBuilltinDetails' %}",
        type: 'GET',
        data: { id: id },
        dataType: 'json',
        success: function(response) {
          $('#detailLabel').text(response.label);
          $('#detailFormation').text(response.formation_nom);
          $('#detailIsDefault').text(response.is_default ? 'Oui' : 'Non');
          $('#modelDetailsTitle').text('Modèle: ' + response.label);
          
          // Render types of notes
          let typesNotesHtml = '';
          if(response.types_notes && response.types_notes.length > 0) {
            $.each(response.types_notes, function(index, typeNote) {
              typesNotesHtml += '<div class="type-note-item mb-3">';
              typesNotesHtml += '<div class="d-flex justify-content-between align-items-center">';
              typesNotesHtml += '<div>';
              typesNotesHtml += '<h6 class="mb-1"><strong>' + typeNote.code + '</strong> - ' + typeNote.libelle + '</h6>';
              typesNotesHtml += '<small class="text-muted">Note max: ' + typeNote.max_note + ', Ordre: ' + typeNote.ordre + '</small>';
              if(typeNote.bloc_label) {
                typesNotesHtml += '<br><small class="text-primary">Bloc: ' + typeNote.bloc_label + '</small>';
              }
              if(typeNote.has_sous_notes) {
                typesNotesHtml += '<br><small class="text-success">Avec ' + typeNote.nb_sous_notes + ' sous-note(s)</small>';
              }
              if(typeNote.is_rattrapage) {
                typesNotesHtml += '<br><small class="text-warning">Rattrapage</small>';
              }
              if(typeNote.is_rachat) {
                typesNotesHtml += '<br><small class="text-info">Rachat de crédit</small>';
              }
              if(typeNote.is_calculee) {
                typesNotesHtml += '<br><small class="text-info">Calculée (' + typeNote.type_calcul + ')</small>';
              }
              typesNotesHtml += '</div>';
              typesNotesHtml += '<div class="btn-group" role="group">';
              typesNotesHtml += '<button type="button" class="btn btn-outline-primary btn-sm edit-type-note" data-id="' + typeNote.id + '"><i class="ri-edit-line"></i></button>';
              typesNotesHtml += '<button type="button" class="btn btn-outline-success btn-sm add-sous-note" data-id="' + typeNote.id + '"><i class="ri-add-line"></i></button>';
              typesNotesHtml += '<button type="button" class="btn btn-outline-info btn-sm manage-dependencies" data-id="' + typeNote.id + '"><i class="ri-link-line"></i></button>';
              typesNotesHtml += '<button type="button" class="btn btn-outline-danger btn-sm delete-type-note" data-id="' + typeNote.id + '"><i class="ri-delete-bin-line"></i></button>';
              typesNotesHtml += '</div>';
              typesNotesHtml += '</div>';

              // Display dependencies if they exist
              if(typeNote.dependencies && typeNote.dependencies.length > 0) {
                typesNotesHtml += '<div class="mt-2">';
                typesNotesHtml += '<small class="text-muted">Dépendances: </small>';
                $.each(typeNote.dependencies, function(idx, dependency) {
                  typesNotesHtml += '<span class="badge bg-light text-dark me-1">' + dependency.child_code + ' - ' + dependency.child_libelle + '</span>';
                });
                typesNotesHtml += '</div>';
              }
              
              // Render sous-notes if they exist
              if(typeNote.sous_notes && typeNote.sous_notes.length > 0) {
                typesNotesHtml += '<div class="nested-list mt-2">';
                $.each(typeNote.sous_notes, function(idx, sousNote) {
                  typesNotesHtml += '<div class="sous-note-item d-flex justify-content-between align-items-center">';
                  typesNotesHtml += '<div>';
                  let maxNoteDisplay = sousNote.max_note !== null ? ' - Max: ' + sousNote.max_note : '';
                  typesNotesHtml += '<span>' + sousNote.label + ' (Ordre: ' + sousNote.ordre + maxNoteDisplay + ')</span>';
                  typesNotesHtml += '</div>';
                  typesNotesHtml += '<div class="btn-group" role="group">';
                  typesNotesHtml += '<button type="button" class="btn btn-outline-warning btn-sm edit-sous-note" data-id="' + sousNote.id + '" data-type-note-id="' + typeNote.id + '"><i class="ri-edit-line"></i></button>';
                  typesNotesHtml += '<button type="button" class="btn btn-outline-danger btn-sm delete-sous-note" data-id="' + sousNote.id + '"><i class="ri-delete-bin-line"></i></button>';
                  typesNotesHtml += '</div>';
                  typesNotesHtml += '</div>';
                });
                typesNotesHtml += '</div>';
              }
              
              typesNotesHtml += '</div>';
            });
          } else {
            typesNotesHtml = `
              <div class="text-center py-5">
                <div class="mb-4">
                  <i class="ri-list-check-2-line text-muted" style="font-size: 3rem;"></i>
                </div>
                <h5 class="text-muted mb-2">Aucun type de note défini</h5>
                <p class="text-muted mb-4">Ce modèle de bulletin ne contient aucun type de note pour le moment.</p>
                <button type="button" class="btn btn-success px-4 py-2 rounded-2" id="addTypeNoteBtnFromEmpty">
                  <i class="ri-add-line me-2"></i> Ajouter un premier type de note
                </button>
              </div>
            `;
          }

          $('#typesNotesList').html(typesNotesHtml);
          $('#modelDetailsModal').modal('show');
        },
        error: function() {
          alertify.error("Erreur lors du chargement des détails du modèle.");
        }
      });
    });

    // Edit model
    $(document).on('click','#btnUpdate', function(){
      const id = $(this).data('id');
      
      $.ajax({
        url: "{% url 't_exam:ApiGetModelBuilltinDetails' %}",
        type: 'GET',
        data: { id: id },
        dataType: 'json',
        success: function(response) {
          $('#modelId').val(response.id);
          $('#label').val(response.label);
          $('#formation').val(response.formation_id);
          $('#is_default').prop('checked', response.is_default);
          $('#modalTitle').text('Modification du modèle de bulletin');
          $('#createModelModal').modal('show');
        },
        error: function() {
          alertify.error("Erreur lors du chargement des détails du modèle.");
        }
      });
    });

    // Delete model
    $(document).on('click','#btnDelete', function(){
      const id = $(this).data('id');
      currentModelId = id;
      $('#deleteConfirmationText').text('Souhaitez-vous supprimer ce modèle de bulletin ?');
      $('.deleteModal').modal('show');

      $(document).on('click', '#confirmDeleteBtn', function(){
        $.ajax({
          url : "{% url 't_exam:ApiDeleteModelBuitltin' %}",
          dataType: 'JSON',
          type : 'GET',
          data : {'id': id},
          success : function(response){
            if (response.status === 'success'){
              alertify.success(response.message);
              loadModels();
              $('.deleteModal').modal('hide');
            }else{
              alertify.error(response.message);
            }
          },
          error: function() {
            alertify.error("Erreur lors de la suppression.");
          }
        });
      });
    });

    // Toggle sous-notes container visibility
    $('#has_sous_notes').on('change', function() {
      if(this.checked) {
        $('#nb_sous_notes_container').show();
      } else {
        $('#nb_sous_notes_container').hide();
      }
    });

    // Toggle calculated note options visibility
    $('#is_calculee').on('change', function() {
      if(this.checked) {
        $('#calculee_options').show();
      } else {
        $('#calculee_options').hide();
      }
    });

    // Add type note button
    $(document).on('click', '#addTypeNoteBtn', function() {
      $('#typeNoteForm')[0].reset();
      $('#typeNoteId').val('');
      $('#modelIdForTypeNote').val(currentModelId);
      $('#is_rattrapage').prop('checked', false);
      $('#is_rachat').prop('checked', false);
      $('#is_calculee').prop('checked', false);
      $('#calculee_options').hide();
      $('#typeNoteModalTitle').text('Ajouter un type de note');
      $('#typeNoteModal').modal('show');
    });

    // Add type note button from empty state
    $(document).on('click', '#addTypeNoteBtnFromEmpty', function() {
      $('#typeNoteForm')[0].reset();
      $('#typeNoteId').val('');
      $('#modelIdForTypeNote').val(currentModelId);
      $('#is_rattrapage').prop('checked', false);
      $('#is_rachat').prop('checked', false);
      $('#is_calculee').prop('checked', false);
      $('#calculee_options').hide();
      $('#typeNoteModalTitle').text('Ajouter un type de note');
      $('#typeNoteModal').modal('show');
    });

    // Edit type note
    $(document).on('click', '.edit-type-note', function() {
      const id = $(this).data('id');
      currentTypeNoteId = id;
      
      $.ajax({
        url: "{% url 't_exam:ApiGetTypeNotes' %}",
        type: 'GET',
        data: { model_id: currentModelId },
        dataType: 'json',
        success: function(response) {
          const typeNote = response.find(tn => tn.id == id);
          if(typeNote) {
            $('#typeNoteId').val(typeNote.id);
            $('#code').val(typeNote.code);
            $('#libelle').val(typeNote.libelle);
            $('#max_note').val(typeNote.max_note);
            $('#ordre').val(typeNote.ordre);
            $('#has_sous_notes').prop('checked', typeNote.has_sous_notes);
            $('#is_rattrapage').prop('checked', typeNote.is_rattrapage);
            $('#is_rachat').prop('checked', typeNote.is_rachat);
            $('#is_calculee').prop('checked', typeNote.is_calculee);
            $('#type_calcul').val(typeNote.type_calcul);
            $('#nb_sous_notes').val(typeNote.nb_sous_notes);

            // Set the bloc selection
            if(typeNote.bloc_id) {
              $('#bloc_id').val(typeNote.bloc_id);
            } else {
              $('#bloc_id').val('');
            }

            if(typeNote.has_sous_notes) {
              $('#nb_sous_notes_container').show();
            } else {
              $('#nb_sous_notes_container').hide();
            }

            if(typeNote.is_calculee) {
              $('#calculee_options').show();
            } else {
              $('#calculee_options').hide();
            }

            $('#modelIdForTypeNote').val(currentModelId);
            $('#typeNoteModalTitle').text('Modifier le type de note');
            $('#typeNoteModal').modal('show');
          }
        },
        error: function() {
          alertify.error("Erreur lors du chargement des détails du type de note.");
        }
      });
    });

    // Add sous-note
    $(document).on('click', '.add-sous-note', function() {
      const typeNoteId = $(this).data('id');
      $('#sousNoteId').val('');
      $('#typeNoteIdForSousNote').val(typeNoteId);
      $('#sousNoteModalTitle').text('Ajouter une sous-note');
      $('#sousNoteForm')[0].reset();
      $('#sousNoteModal').modal('show');
    });

    // Edit sous-note
    $(document).on('click', '.edit-sous-note', function() {
      const id = $(this).data('id');
      const typeNoteId = $(this).data('type-note-id');
      currentSousNoteId = id;

      $.ajax({
        url: "{% url 't_exam:ApiGetSousNotesForType' %}",
        type: 'GET',
        data: { type_note_id: typeNoteId },
        dataType: 'json',
        success: function(response) {
          const sousNote = response.find(sn => sn.id == id);
          if(sousNote) {
            $('#sousNoteId').val(sousNote.id);
            $('#sousNoteLabel').val(sousNote.label);
            $('#sousNoteMaxNote').val(sousNote.max_note);
            $('#sousNoteOrdre').val(sousNote.ordre);
            $('#typeNoteIdForSousNote').val(typeNoteId);
            $('#sousNoteModalTitle').text('Modifier la sous-note');
            $('#sousNoteModal').modal('show');
          }
        },
        error: function() {
          alertify.error("Erreur lors du chargement des détails de la sous-note.");
        }
      });
    });

    // Delete type note
    $(document).on('click', '.delete-type-note', function() {
      const id = $(this).data('id');
      currentTypeNoteId = id;
      $('#deleteConfirmationText').text('Souhaitez-vous supprimer ce type de note ?');
      $('.deleteModal').modal('show');

      $(document).on('click', '#confirmDeleteBtn', function() {
        $.ajax({
          url: "{% url 't_exam:ApiDeleteTypeNote' %}",
          type: 'GET',
          data: { id: id },
          dataType: 'json',
          success: function(response) {
            if(response.status === 'success') {
              alertify.success(response.message);
              $('.deleteModal').modal('hide');
              // Refresh the model details
              $('#btnViewDetails[data-id="' + currentModelId + '"]').click();
            } else {
              alertify.error(response.message);
            }
          },
          error: function() {
            alertify.error("Erreur lors de la suppression.");
          }
        });
      });
    });

    // Delete sous-note
    $(document).on('click', '.delete-sous-note', function() {
      const id = $(this).data('id');
      currentSousNoteId = id;
      $('#deleteConfirmationText').text('Souhaitez-vous supprimer cette sous-note ?');
      $('.deleteModal').modal('show');

      $(document).on('click', '#confirmDeleteBtn', function() {
        $.ajax({
          url: "{% url 't_exam:ApiDeleteSousNote' %}",
          type: 'GET',
          data: { id: id },
          dataType: 'json',
          success: function(response) {
            if(response.status === 'success') {
              alertify.success(response.message);
              $('.deleteModal').modal('hide');
              // Refresh the model details
              $('#btnViewDetails[data-id="' + currentModelId + '"]').click();
            } else {
              alertify.error(response.message);
            }
          },
          error: function() {
            alertify.error("Erreur lors de la suppression.");
          }
        });
      });
    });

    // Handle type note form submission
    $(document).on('submit', '#typeNoteForm', function(e) {
      e.preventDefault();
      const formData = $(this).serialize();
      const typeNoteId = $('#typeNoteId').val();
      
      let url = "{% url 't_exam:ApiAddTypeNote' %}";
      if(typeNoteId) {
        url = "{% url 't_exam:ApiUpdateTypeNote' %}";
      }
      
      $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        dataType: 'json',
        success: function(response) {
          if(response.status === 'success') {
            $('#typeNoteModal').modal('hide');
            alertify.success(response.message);
            // Refresh the model details
            $('#btnViewDetails[data-id="' + currentModelId + '"]').click();
          } else {
            alertify.error(response.message);
          }
        },
        error: function() {
          alertify.error("Erreur lors de l'enregistrement.");
        }
      });
    });

    // Handle sous-note form submission
    $(document).on('submit', '#sousNoteForm', function(e) {
      e.preventDefault();
      const formData = $(this).serialize();
      const sousNoteId = $('#sousNoteId').val();

      let url = "{% url 't_exam:ApiAddSousNote' %}";
      if(sousNoteId) {
        url = "{% url 't_exam:ApiUpdateSousNote' %}";
      }

      $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        dataType: 'json',
        success: function(response) {
          if(response.status === 'success') {
            $('#sousNoteModal').modal('hide');
            alertify.success(response.message);
            // Refresh the model details
            $('#btnViewDetails[data-id="' + currentModelId + '"]').click();
          } else {
            alertify.error(response.message);
          }
        },
        error: function() {
          alertify.error("Erreur lors de l'enregistrement.");
        }
      });
    });

    // Manage dependencies button click
    $(document).on('click', '.manage-dependencies', function() {
      const parentId = $(this).data('id');
      currentTypeNoteId = parentId;

      // Set the parent ID in the modal
      $('#currentParentId').val(parentId);
      $('#dependencyParentId').val(parentId);

      // Load current dependencies
      loadCurrentDependencies(parentId);

      // Load available dependencies
      loadAvailableDependencies(currentModelId, parentId);

      // Set modal title
      $.ajax({
        url: "{% url 't_exam:ApiGetTypeNotes' %}",
        type: 'GET',
        data: { model_id: currentModelId },
        dataType: 'json',
        success: function(response) {
          const typeNote = response.find(tn => tn.id == parentId);
          if(typeNote) {
            $('#dependenciesModalSubtitle').text('Gestion des dépendances pour: ' + typeNote.code + ' - ' + typeNote.libelle);
          }
        }
      });

      $('#dependenciesModal').modal('show');
    });

    // Load current dependencies
    function loadCurrentDependencies(parentId) {
      $.ajax({
        url: "{% url 't_exam:ApiGetTypeNoteDependencies' %}",
        type: 'GET',
        data: { parent_id: parentId },
        dataType: 'json',
        success: function(response) {
          let html = '';
          if(response.length > 0) {
            $.each(response, function(index, dependency) {
              html += '<div class="d-flex justify-content-between align-items-center mb-2">';
              html += '<span>' + dependency.child_code + ' - ' + dependency.child_libelle + '</span>';
              html += '<button type="button" class="btn btn-sm btn-outline-danger delete-dependency" data-id="' + dependency.id + '">';
              html += '<i class="ri-delete-bin-line"></i>';
              html += '</button>';
              html += '</div>';
            });
          } else {
            html = '<p class="text-muted">Aucune dépendance configurée</p>';
          }
          $('#currentDependenciesList').html(html);
        },
        error: function() {
          $('#currentDependenciesList').html('<p class="text-danger">Erreur lors du chargement des dépendances</p>');
        }
      });
    }

    // Load available dependencies
    function loadAvailableDependencies(modelId, parentId) {
      $.ajax({
        url: "{% url 't_exam:ApiGetTypeNoteAvailableDependencies' %}",
        type: 'GET',
        data: { model_id: modelId, parent_id: parentId },
        dataType: 'json',
        success: function(response) {
          let options = '<option value="">Sélectionnez un type de note</option>';
          if(response.length > 0) {
            $.each(response, function(index, typeNote) {
              options += '<option value="' + typeNote.id + '">' + typeNote.code + ' - ' + typeNote.libelle + '</option>';
            });
          }
          $('#dependencyChild').html(options);
        },
        error: function() {
          $('#dependencyChild').html('<option value="">Erreur de chargement</option>');
        }
      });
    }

    // Add dependency form submission
    $(document).on('submit', '#addDependencyForm', function(e) {
      e.preventDefault();
      const formData = $(this).serialize();

      $.ajax({
        url: "{% url 't_exam:ApiAddTypeNoteDependency' %}",
        type: 'POST',
        data: formData,
        dataType: 'json',
        success: function(response) {
          if(response.status === 'success') {
            alertify.success(response.message);
            // Reload dependencies
            loadCurrentDependencies($('#dependencyParentId').val());
            // Reload available dependencies
            loadAvailableDependencies(currentModelId, currentTypeNoteId);
            // Reset form
            $('#addDependencyForm')[0].reset();
            $('#dependencyParentId').val(currentTypeNoteId);
          } else {
            alertify.error(response.message);
          }
        },
        error: function() {
          alertify.error("Erreur lors de l'ajout de la dépendance.");
        }
      });
    });

    // Add new bloc button click
    $(document).on('click', '#addNewBlocBtn', function() {
      $('#blocForm')[0].reset();
      $('#blocId').val('');
      $('#blocModalTitle').text('Créer un nouveau bloc de notes');
      $('#blocModal').modal('show');
    });

    // Handle bloc form submission
    $(document).on('submit', '#blocForm', function(e) {
      e.preventDefault();
      const label = $('#blocLabel').val();
      const code = $('#blocCode').val();
      const ordre = $('#blocOrdre').val();

      addNewBloc(label, code, ordre);
    });

    // Delete dependency
    $(document).on('click', '.delete-dependency', function() {
      const dependencyId = $(this).data('id');

      if(confirm('Êtes-vous sûr de vouloir supprimer cette dépendance ?')) {
        $.ajax({
          url: "{% url 't_exam:ApiDeleteTypeNoteDependency' %}",
          type: 'GET',
          data: { id: dependencyId },
          dataType: 'json',
          success: function(response) {
            if(response.status === 'success') {
              alertify.success(response.message);
              // Reload dependencies
              loadCurrentDependencies(currentTypeNoteId);
              // Reload available dependencies
              loadAvailableDependencies(currentModelId, currentTypeNoteId);
            } else {
              alertify.error(response.message);
            }
          },
          error: function() {
            alertify.error("Erreur lors de la suppression de la dépendance.");
          }
        });
      }
    });
  });
</script>
{% endblock content %}