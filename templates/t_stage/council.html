{% extends 'tenant_folder/base.html' %}
{% load static %}

{% block title %} Conseil de Validation {% endblock title %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            
            <!-- Header -->
            <div class="row mb-3 pb-1">
                <div class="col-12">
                    <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                        <div class="flex-grow-1">
                            <h4 class="fs-16 mb-1">Conseils de Validation</h4>
                            <p class="text-muted mb-0">Gestion des jurys et admissibilité aux soutenances.</p>
                        </div>
                        <div class="mt-3 mt-lg-0">
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCouncilModal">
                                    <i class="ri-add-line align-bottom me-1"></i> Nouveau Conseil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats/Info Alert -->
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-secondary border-0 d-flex align-items-center mb-4" role="alert">
                        <i class="ri-information-line me-2 fs-20 text-info"></i>
                        <div class="text-muted">
                            Le <strong>Conseil de Validation</strong> statue sur l'admissibilité des étudiants en fin de parcours (Mois 5), en se basant sur les trois étapes de validation (P1, P2, P3).
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Left: Recent Councils List -->
                <div class="col-xl-4">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex border-bottom-dashed">
                            <h4 class="card-title mb-0 flex-grow-1">Historique des Conseils</h4>
                        </div>
                        <div class="card-body">
                            {% if conseils %}
                                <div class="vstack gap-3">
                                    {% for conseil in conseils %}
                                    <div class="card border border-dashed shadow-none mb-0">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm flex-shrink-0">
                                                    <div class="avatar-title bg-light text-primary rounded-circle fs-20">
                                                        <i class="ri-calendar-event-line"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <h6 class="fs-14 mb-1">{{ conseil.date_conseil|date:"d F Y" }}</h6>
                                                    <p class="text-muted fs-12 mb-0">
                                                        <i class="ri-file-list-3-line align-middle me-1"></i> {{ conseil.decisions.count }} décisions
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <a href="{% url 't_stage:council_detail' conseil.id %}" class="btn btn-sm btn-ghost-secondary">
                                                        <i class="ri-arrow-right-line fs-16"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <div class="avatar-lg mx-auto mb-3">
                                        <div class="avatar-title bg-light rounded-circle text-muted fs-24">
                                            <i class="ri-inbox-archive-line"></i>
                                        </div>
                                    </div>
                                    <h5 class="fs-14">Aucun conseil</h5>
                                    <p class="text-muted">Créez votre premier conseil pour commencer.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Right: Pending Stages -->
                <div class="col-xl-8">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex border-bottom-dashed">
                            <h4 class="card-title mb-0 flex-grow-1">Stages en Attente (M5)</h4>
                            <div class="flex-shrink-0">
                                <span class="badge bg-warning-subtle text-warning">{{ t_stage_list|length }} en attente</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table class="table table-borderless table-nowrap align-middle mb-0">
                                    <thead class="text-muted table-light">
                                        <tr>
                                            <th scope="col">Étudiant</th>
                                            <th scope="col">Sujet</th>
                                            <th scope="col" style="width: 20%;">Avancement</th>
                                            <th scope="col" class="text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for stage in t_stage_list %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-xs flex-shrink-0 me-2">
                                                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                                            {{ stage.etudiant1.nom|slice:":1" }}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h6 class="fs-14 mb-0">{{ stage.etudiant1 }}</h6>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="d-block text-truncate" style="max-width: 250px;">{{ stage.sujet }}</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress progress-sm flex-grow-1 animated-progress">
                                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ stage.taux_avancement }}%" aria-valuenow="{{ stage.taux_avancement }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <span class="ms-2 fs-12 fw-medium">{{ stage.taux_avancement }}%</span>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                               <!-- Note: The actual "Decide" action usually happens inside a Council Detail view. 
                                                    Ideally, we would link to the latest open council or prompt to create one. 
                                                    For now, linking to dashboard or a specific 'manage' view is fine. -->
                                               <button class="btn btn-sm btn-subtle-primary" onclick="openDecisionModal('{{ stage.id }}', '{{ stage.sujet|escapejs }}')">
                                                    Décider
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center py-5">
                                                <div class="text-muted">
                                                    <i class="ri-check-double-line fs-24 mb-3 text-success"></i>
                                                    <h5 class="fs-14">Tout est à jour !</h5>
                                                    <p class="mb-0">Aucun stage ne nécessite de validation pour le moment.</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Nouveau Conseil -->
<div class="modal fade" id="newCouncilModal" tabindex="-1" aria-labelledby="newCouncilModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newCouncilModalLabel">Ouvrir un nouveau Conseil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="date_conseil" class="form-label">Date du Conseil</label>
                        <input type="date" class="form-control" id="date_conseil" name="date_conseil" required value="{% now 'Y-m-d' %}">
                    </div>
                    <div class="mb-3">
                        <label for="obs" class="form-label">Observations / Ordre du jour</label>
                        <textarea class="form-control" id="obs" name="observations" rows="3" placeholder="Ex: Validation de la session de Juin..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Créer le Conseil</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal: Decision Rapide -->
<div class="modal fade" id="decisionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Saisir une Décision</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 't_stage:quick_decision' %}">
                {% csrf_token %}
                <input type="hidden" name="stage_id" id="decisionStageId">
                <div class="modal-body">
                    <div class="alert alert-light border mb-3">
                        <strong>Sujet :</strong> <span id="decisionStageSubject"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Conseil de rattachement</label>
                        <select class="form-select" name="council_id" required>
                            {% for c in conseils %}
                            <option value="{{ c.id }}">{{ c.date_conseil|date:"d F Y" }}</option>
                            {% empty %}
                            <option value="" disabled selected>Aucun conseil ouvert</option>
                            {% endfor %}
                        </select>
                         <div class="form-text">La décision sera enregistrée dans ce PV.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Décision du Jury</label>
                        <div class="d-flex gap-2">
                             <input type="radio" class="btn-check" name="decision" id="decSoutenable" value="soutenable" checked>
                            <label class="btn btn-outline-success flex-grow-1" for="decSoutenable">
                                <i class="ri-check-line align-bottom me-1"></i> Soutenable
                            </label>

                            <input type="radio" class="btn-check" name="decision" id="decAjourne" value="ajourne">
                            <label class="btn btn-outline-warning flex-grow-1" for="decAjourne">
                                <i class="ri-close-line align-bottom me-1"></i> Ajourné
                            </label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Note / Taux Final (%)</label>
                                <input type="number" class="form-control" name="taux_final" min="0" max="100" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Commentaire</label>
                        <textarea class="form-control" name="commentaire" rows="2" placeholder="Motif ou remarque..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openDecisionModal(id, subject) {
        document.getElementById('decisionStageId').value = id;
        document.getElementById('decisionStageSubject').innerText = subject;
        var myModal = new bootstrap.Modal(document.getElementById('decisionModal'));
        myModal.show();
    }
</script>
{% endblock content %}
