{% extends 'tenant_folder/base.html' %}
{% load static %}

{% block title %} Détail du Conseil {% endblock title %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Conseil de Validation</h4>
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="{% url 't_stage:stage_dashboard' %}">Stages</a></li>
                                <li class="breadcrumb-item"><a href="{% url 't_stage:validation_council' %}">Conseils</a></li>
                                <li class="breadcrumb-item active">Détail</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats KPI Cards -->
            <div class="row">
                <div class="col-xxl-3 col-sm-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="fw-medium text-muted mb-0">Total Décisions</p>
                                    <h2 class="mt-4 ff-secondary fw-semibold">
                                        {{ conseil.decisions.count }}
                                    </h2>
                                </div>
                                <div>
                                    <div class="avatar-sm flex-shrink-0">
                                        <span class="avatar-title bg-soft-info text-info rounded-circle fs-4">
                                            <i class="ri-gavel-line"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Soutenable KPI -->
                <div class="col-xxl-3 col-sm-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="fw-medium text-muted mb-0">Admis (Soutenables)</p>
                                    <h2 class="mt-4 ff-secondary fw-semibold text-success">
                                        <!-- Need a filter or simplified count here, using placeholder logic or template tag if available. 
                                             For pure template, we might need to rely on the backend passing specific counts or loop.
                                             Let's iterate to count for now if list is small, or just show placeholders. 
                                             Actually, let's keep it simple for now as backend update wasn't requested. -->
                                         <span class="fs-14 text-muted fst-italic">--</span>
                                    </h2>
                                </div>
                                <div>
                                    <div class="avatar-sm flex-shrink-0">
                                        <span class="avatar-title bg-soft-success text-success rounded-circle fs-4">
                                            <i class="ri-checkbox-circle-line"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Ajourné KPI -->
                <div class="col-xxl-3 col-sm-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="fw-medium text-muted mb-0">Ajournés</p>
                                    <h2 class="mt-4 ff-secondary fw-semibold text-warning">
                                         <span class="fs-14 text-muted fst-italic">--</span>
                                    </h2>
                                </div>
                                <div>
                                    <div class="avatar-sm flex-shrink-0">
                                        <span class="avatar-title bg-soft-warning text-warning rounded-circle fs-4">
                                            <i class="ri-error-warning-line"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Date Card -->
                <div class="col-xxl-3 col-sm-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="fw-medium text-muted mb-0">Date du Conseil</p>
                                    <h4 class="mt-4 ff-secondary fw-semibold">
                                        {{ conseil.date_conseil|date:"d M, Y" }}
                                    </h4>
                                </div>
                                <div>
                                    <div class="avatar-sm flex-shrink-0">
                                        <span class="avatar-title bg-soft-primary text-primary rounded-circle fs-4">
                                            <i class="ri-calendar-event-line"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Observations -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header border-0">
                            <h5 class="card-title mb-0">Observations Générales</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-light border-0 mb-0" role="alert">
                                {{ conseil.observations_generales|default:"Aucune observation enregistrée pour ce conseil."|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Decisions Breakdown -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header border-0 d-flex align-items-center">
                            <h5 class="card-title mb-0 flex-grow-1">Liste des Décisions</h5>
                            <button class="btn btn-soft-primary btn-sm">
                                <i class="ri-printer-line align-bottom me-1"></i> Imprimer PV
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table class="table align-middle table-nowrap mb-0 table-hover">
                                    <thead class="text-muted table-light">
                                        <tr>
                                            <th scope="col">Étudiant</th>
                                            <th scope="col">Sujet du Stage</th>
                                            <th scope="col">Décision</th>
                                            <th scope="col">Note Finale</th>
                                            <th scope="col">Commentaires</th>
                                            <th scope="col" style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for decision in conseil.decisions.all %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-xs flex-shrink-0 me-2">
                                                        <span class="avatar-title rounded-circle bg-primary-subtle text-primary">
                                                            {{ decision.stage.etudiant1.nom|slice:":1" }}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <h6 class="fs-14 mb-0">{{ decision.stage.etudiant1 }}</h6>
                                                        <small class="text-muted">{{ decision.stage.etudiant1.matricule }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="d-inline-block text-truncate" style="max-width: 200px;" data-bs-toggle="tooltip" title="{{ decision.stage.sujet }}">
                                                    {{ decision.stage.sujet }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if decision.decision == 'soutenable' %}
                                                <span class="badge bg-success-subtle text-success fs-11"><i class="ri-check-line align-bottom me-1"></i> SOUTENABLE</span>
                                                {% else %}
                                                <span class="badge bg-warning-subtle text-warning fs-11"><i class="ri-close-line align-bottom me-1"></i> AJOURNÉ</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <h6 class="mb-0">{{ decision.taux_final }}%</h6>
                                            </td>
                                            <td>
                                                <span class="text-muted">{{ decision.commentaire|default:"-"|truncatechars:30 }}</span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-ghost-secondary btn-icon" data-bs-toggle="tooltip" title="Éditer la décision">
                                                    <i class="ri-pencil-fill"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center py-5">
                                                <div class="text-muted">
                                                    <i class="ri-folder-info-line fs-24 mb-3"></i>
                                                    <h5>Aucune décision</h5>
                                                    <p class="mb-0">Les décisions pour ce conseil n'ont pas encore été saisies.</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock content %}
