{% extends 'public_folder/base.html' %} 

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Title Section -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-white rounded shadow-sm p-3 mb-4">
                        <h4 class="mb-sm-0 text-primary fw-bold"><i class="bx bx-list-ul me-2"></i>Postes Budgétaires</h4>
                        <div class="page-title-right d-flex gap-2">
                            <button type="button" class="btn btn-danger btn-label waves-effect waves-light shadow-sm" data-bs-toggle="modal" data-bs-target="#posteModal" onclick="openCreateModal('depense')">
                                <i class="ri-indeterminate-circle-line label-icon align-middle fs-16 me-2"></i> Ajouter Dépense
                            </button>
                            <button type="button" class="btn btn-success btn-label waves-effect waves-light shadow-sm" data-bs-toggle="modal" data-bs-target="#posteModal" onclick="openCreateModal('recette')">
                                <i class="ri-add-circle-line label-icon align-middle fs-16 me-2"></i> Ajouter Recette
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="row">
                <div class="col-12">
                     <div class="card border-0 shadow-sm rounded-3">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-nowrap align-middle mb-0" id="posteTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" style="width: 40px;">#</th>
                                            <th scope="col">Libellé</th>
                                            <th scope="col">Type</th>
                                            <th scope="col">Description</th>
                                            <th scope="col">Parent</th>
                                            <th scope="col">Catégories Dépenses</th>
                                            <th scope="col">Catégories Paiement</th>
                                            <th scope="col" class="text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for poste in postes %}
                                        <tr id="row-{{ poste.id }}">
                                            <td>{{ forloop.counter }}</td>
                                            <td class="fw-semibold text-dark">{{ poste.label }}</td>
                                            <td>
                                                {% if poste.type == 'depense' %}
                                                    <span class="badge bg-soft-danger text-danger">Dépense</span>
                                                {% elif poste.type == 'recette' %}
                                                    <span class="badge bg-soft-success text-success">Recette</span>
                                                {% else %}
                                                    <span class="badge bg-soft-warning text-warning">Mixte</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ poste.description|default:"-"|truncatechars:30 }}</td>
                                            <td>
                                                {% if poste.parent %}
                                                <span class="badge badge-soft-primary fs-12">{{ poste.parent.label }}</span>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% for cat in poste.depense_categories.all %}
                                                    <span class="badge bg-soft-info text-info">{{ cat.name }}</span>
                                                {% empty %}
                                                    <span class="text-muted">-</span>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for cat in poste.payment_categories.all %}
                                                    <span class="badge bg-soft-success text-success">{{ cat.name }}</span>
                                                {% empty %}
                                                    <span class="text-muted">-</span>
                                                {% endfor %}
                                            </td>
                                            <td class="text-end">
                                                <div class="dropdown">
                                                    <button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="ri-more-fill align-middle"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                                        <li><a class="dropdown-item edit-item-btn" href="javascript:void(0);" onclick="openEditModal({{ poste.id }})"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</a></li>
                                                        <li><a class="dropdown-item remove-item-btn" href="javascript:void(0);" onclick="deletePoste({{ poste.id }})"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer</a></li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr id="emptyRow">
                                            <td colspan="7" class="text-center py-5 text-muted">
                                                <i class="ri-folder-open-line fs-1 display-5 d-block mb-3"></i>
                                                Aucun poste budgétaire trouvé.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modern Modal Styles */
    .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .modal-header {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .form-control, .form-select {
        border-radius: 10px;
        padding: 0.7rem 1rem;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        background-color: #fff;
    }

    .form-label {
        color: #475569;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .modal-footer {
        background-color: #f8fafc;
        border-top: 1px solid #e2e8f0;
        padding: 1.25rem;
    }
    
    /* Select2 Customization */
    .select2-container--default .select2-selection--multiple {
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        padding: 0.4rem;
        min-height: 45px;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        background-color: #fff;
    }

    /* Animation */
    .bounceIn {
        animation: bounceIn 0.5s;
    }

    @keyframes bounceIn {
        0% { transform: scale(0.8); opacity: 0; }
        60% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); }
    }
</style>

<!-- Poste Modal -->
<div class="modal fade bounceIn" id="posteModal" tabindex="-1" aria-labelledby="posteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="posteModalLabel"><i class="ri-edit-2-line me-2"></i>Nouveau Poste Budgétaire</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
            </div>
            <form id="posteForm" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <input type="hidden" id="posteId" name="id">
                    <div class="row">
                        <div class="col-md-7 mb-3">
                            <label for="{{ form.label.id_for_label }}" class="form-label fw-bold">Libellé</label>
                            {{ form.label }}
                            <div class="invalid-feedback" id="error-label"></div>
                        </div>
                        <div class="col-md-5 mb-3">
                            <label for="{{ form.parent.id_for_label }}" class="form-label fw-bold">Parent</label>
                            {{ form.parent }}
                        </div>
                        <div class="d-none">
                             {{ form.type }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3" id="div-depense">
                            <label for="{{ form.depense_categories.id_for_label }}" class="form-label fw-bold">Catégories Dépenses</label>
                            {{ form.depense_categories }}
                             <small class="text-muted">Maintenez Ctrl pour sélectionner plusieurs</small>
                        </div>
                        <div class="col-12 mb-3" id="div-payment">
                            <label for="{{ form.payment_categories.id_for_label }}" class="form-label fw-bold">Catégories Paiement (Recettes)</label>
                            {{ form.payment_categories }}
                            <small class="text-muted">Maintenez Ctrl pour sélectionner plusieurs</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">Description</label>
                        {{ form.description }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light shadow-sm" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm" id="saveBtn"><i class="ri-save-3-line me-1"></i> Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let posteModal;
    let form;
    let saveBtn;

    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('posteModal');
        if (modalElement) posteModal = new bootstrap.Modal(modalElement);
        form = document.getElementById('posteForm');
        saveBtn = document.getElementById('saveBtn');

        // Initialize Select2 if available
        if($('.select2').length > 0) {
            $('.select2').select2({
                dropdownParent: $('#posteModal'),
                width: '100%'
            });
        }

        // Handle Type Change
        $('#poste_type').on('change', function() {
            toggleCategories($(this).val());
        });

        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

                $.ajax({
                    url: form.action,
                    type: 'POST',
                    data: $(form).serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.status === 'success') {
                            alertify.success(response.message);
                            location.reload();
                        } else {
                            alertify.error('Veuillez vérifier les erreurs.');
                            console.log(response.errors);
                        }
                    },
                    error: function(xhr, status, error) {
                         alertify.error('Une erreur est survenue: ' + error);
                    },
                    complete: function() {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Enregistrer';
                    }
                });
            };
        }
    });

    function openCreateModal(type) {
        if (!form) form = document.getElementById('posteForm');
        form.reset();
        // Reset Select2
        if($('.select2').length > 0) $('.select2').val(null).trigger('change');
        
        // Set Type
        $('#poste_type').val(type).trigger('change');

        document.getElementById('posteId').value = '';
        
        // Update Title based on Type
        let title = 'Nouveau Poste Budgétaire';
        if(type === 'depense') title = 'Nouvelle Dépense';
        else if(type === 'recette') title = 'Nouvelle Recette';
        
        document.getElementById('posteModalLabel').innerText = title;
        form.action = "{% url 'postes_budgetaire_create' %}";
        if (posteModal) posteModal.show();
        else $('#posteModal').modal('show');
    }

    function openEditModal(id) {
        if (!form) form = document.getElementById('posteForm');
        form.reset();
        document.getElementById('posteId').value = id;
        document.getElementById('posteModalLabel').innerText = 'Modifier le Poste';
        form.action = "{% url 'postes_budgetaire_edit' 0 %}".replace('0', id);
        
        $.ajax({
            url: form.action,
            type: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(data) {
                document.getElementById('id_label').value = data.label;
                document.getElementById('id_description').value = data.description;
                document.getElementById('id_parent').value = data.parent;
                $('#poste_type').val(data.type).trigger('change'); // Trigger change for visibility
                
                // Update Title
                let title = 'Modifier le Poste';
                if(data.type === 'depense') title = 'Modifier la Dépense';
                else if(data.type === 'recette') title = 'Modifier la Recette';
                document.getElementById('posteModalLabel').innerText = title;
                
                // Set Select2 values
                if($('.select2').length > 0) {
                     $('#id_depense_categories').val(data.depense_categories).trigger('change');
                     $('#id_payment_categories').val(data.payment_categories).trigger('change');
                } else {
                    // Fallback for standard select multiple
                    // This is trickier with standard JS for multiple select, assume Select2 is used or handle manual selection loop
                     $('#id_depense_categories').val(data.depense_categories);
                     $('#id_payment_categories').val(data.payment_categories);
                }

                if (posteModal) posteModal.show();
                else $('#posteModal').modal('show');
            }
        });
    }

    function deletePoste(id) {
        alertify.confirm('Supprimer le poste', 'Êtes-vous sûr de vouloir supprimer ce poste ?', 
            function() {
                $.ajax({
                    url: "{% url 'postes_budgetaire_delete' 0 %}".replace('0', id),
                    type: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
                    success: function(response) {
                        if (response.status === 'success') {
                            alertify.success(response.message);
                            $(`#row-${id}`).fadeOut(300, function() { $(this).remove(); });
                        }
                    }
                });
            }, function() {}
        );
    }

    function toggleCategories(type) {
        const divDepense = $('#div-depense');
        const divPayment = $('#div-payment');

        if (type === 'depense') {
            divDepense.show();
            divPayment.hide();
        } else if (type === 'recette') {
            divDepense.hide();
            divPayment.show();
        } else {
            divDepense.show();
            divPayment.show();
        }
    }
</script>

{% endblock %}
