{% extends 'public_folder/base.html' %} 

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Title Section -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-white rounded shadow-sm p-3 mb-4">
                        <h4 class="mb-sm-0 text-primary fw-bold"><i class="bx bx-list-check me-2"></i>Catégories de Dépense (Global)</h4>
                        <div class="page-title-right d-flex gap-2">
                            <button type="button" id="syncBtn" class="btn btn-warning btn-label waves-effect waves-light shadow-sm">
                                <i class="ri-refresh-line label-icon align-middle fs-16 me-2"></i> Synchroniser
                            </button>
                            <button type="button" class="btn btn-primary btn-label waves-effect waves-light shadow-sm" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCreateModal()">
                                <i class="ri-add-line label-icon align-middle fs-16 me-2"></i> Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="row">
                <div class="col-12">
                     <div class="card border-0 shadow-sm rounded-3">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-nowrap align-middle mb-0" id="categoryTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" style="width: 40px;">#</th>
                                            <th scope="col">Nom</th>
                                            <th scope="col">Parent</th>
                                            <th scope="col">Catégorie Paiement</th>
                                            <th scope="col" class="text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in categories %}
                                        <tr id="row-{{ category.id }}">
                                            <td>{{ forloop.counter }}</td>
                                            <td class="fw-semibold text-dark">{{ category.name }}</td>
                                            <td>
                                                {% if category.parent %}
                                                <span class="badge badge-soft-primary fs-12">{{ category.parent.name }}</span>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if category.payment_category %}
                                                <span class="badge badge-soft-info fs-12">{{ category.payment_category.name }}</span>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                               <div class="dropdown">
                                                    <button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="ri-more-fill align-middle"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                                        <li><a class="dropdown-item edit-item-btn" href="javascript:void(0);" onclick="openEditModal({{ category.id }})"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Modifier</a></li>
                                                        <li><a class="dropdown-item remove-item-btn" href="javascript:void(0);" onclick="deleteCategory({{ category.id }})"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Supprimer</a></li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr id="emptyRow">
                                            <td colspan="5" class="text-center py-5 text-muted">
                                                <i class="ri-folder-open-line fs-1 display-5 d-block mb-3"></i>
                                                Aucune catégorie trouvée.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary p-3">
                <h5 class="modal-title text-white" id="categoryModalLabel">Nouvelle Catégorie</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
            </div>
            <form id="categoryForm" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <input type="hidden" id="categoryId" name="id">
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">Nom de la catégorie</label>
                        {{ form.name }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.parent.id_for_label }}" class="form-label fw-bold">Catégorie Parente</label>
                        {{ form.parent }}
                    </div>
                    <div class="mb-0">
                        <label for="{{ form.payment_category.id_for_label }}" class="form-label fw-bold">Associer à une Catégorie de Paiement</label>
                        {{ form.payment_category }}
                    </div>
                </div>
                <div class="modal-footer bg-light p-3">
                    <button type="button" class="btn btn-ghost-danger shadow-none" data-bs-dismiss="modal"><i class="ri-close-line align-bottom me-1"></i> Fermer</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let categoryModal;
    let form;
    let saveBtn;
    let syncBtn;

    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('categoryModal');
        if (modalElement) categoryModal = new bootstrap.Modal(modalElement);
        form = document.getElementById('categoryForm');
        saveBtn = document.getElementById('saveBtn');
        syncBtn = document.getElementById('syncBtn');

        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

                $.ajax({
                    url: form.action,
                    type: 'POST',
                    data: $(form).serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.status === 'success') {
                            alertify.success(response.message);
                            location.reload(); 
                        } else {
                            alertify.error('Veuillez vérifier les erreurs.');
                        }
                    },
                    complete: function() {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Enregistrer';
                    }
                });
            };
        }

        if (syncBtn) {
            syncBtn.onclick = function() {
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Synchronisation...';
                
                $.ajax({
                    url: "{% url 'sync_categories_view' %}",
                    type: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.status === 'success') {
                            alertify.success(response.message);
                        } else {
                            alertify.error(response.message);
                        }
                    },
                    error: function() {
                        alertify.error('Une erreur est survenue lors de la synchronisation.');
                    },
                    complete: function() {
                        syncBtn.disabled = false;
                        syncBtn.innerHTML = '<i class="ri-refresh-line label-icon align-middle fs-16 me-2"></i> Synchroniser';
                    }
                });
            }
        }
    });

    function openCreateModal() {
        if (!form) form = document.getElementById('categoryForm');
        form.reset();
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryModalLabel').innerText = 'Nouvelle Catégorie';
        form.action = "{% url 'global_depenses_category_create' %}";
        if (categoryModal) categoryModal.show();
        else $('#categoryModal').modal('show');
    }

    function openEditModal(id) {
        if (!form) form = document.getElementById('categoryForm');
        form.reset();
        document.getElementById('categoryId').value = id;
        document.getElementById('categoryModalLabel').innerText = 'Modifier la Catégorie';
        form.action = "{% url 'global_depenses_category_edit' 0 %}".replace('0', id);
        
        $.ajax({
            url: form.action,
            type: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(data) {
                document.getElementById('id_name').value = data.name;
                document.getElementById('id_parent').value = data.parent;
                document.getElementById('id_payment_category').value = data.payment_category;
                if (categoryModal) categoryModal.show();
                else $('#categoryModal').modal('show');
            }
        });
    }

    function deleteCategory(id) {
        alertify.confirm('Supprimer la catégorie', 'Êtes-vous sûr de vouloir supprimer cette catégorie ?', 
            function() {
                $.ajax({
                    url: "{% url 'global_depenses_category_delete' 0 %}".replace('0', id),
                    type: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
                    success: function(response) {
                        if (response.status === 'success') {
                            alertify.success(response.message);
                            $(`#row-${id}`).fadeOut(300, function() { $(this).remove(); });
                        }
                    }
                });
            }, function() {}
        );
    }
</script>

{% endblock %}
